<?xml version="1.0" encoding="UTF-8"?>
<Export generator="IRIS" version="26" zv="IRIS for UNIX (Red Hat Enterprise Linux 8 for x86-64) 2023.1.1 (Build 380U)" ts="2024-02-09 17:36:15">
<Class name="User.CavUnEpca">
<Description><![CDATA[
<pre>
 
18.01.24 tt; do indexu auk pridana indexace vdanych autorek - autorita/403
11.01.24 tt; na upozorneni Karla, nahrazeno data-target=""_blank"" za target=""_blank""
11.01.24 tt; check856: založena metoda
05.01.24 tt; zakomentovano indexovani indexu zodda a zoddc
18.12.23 tt; checkFulltextLicence: založena metoda
01.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno
             upraveno indexovani na ye na U95b
09.11.23 tt; odstraneni zaescapovanych znaku u exportu do csv.  Nelibi se to CAV cs123303
             uprava zobrazeni citace datovaho zaznamu
07.11.23 tt; u datovych zaznamu doplnen link na OpenAire - getOPENAIRElink
06.11.23 tt; provedeno upraveni tvaru DOI dx.doi.org na doi.org
01.11.23 tt; upravy zobrazovani datovych zaznamu
10.10.23 tt; pridana podminka na maximalni pocet autoru pro stahovani z wos
20.09.23 tt; zfDataVersionTab: pridan blok pro zobrazovani linku na vedecka data - tabulka verzi
             provedeny urpravy kvuli rozdeleni zf do tabu
14.09.23 tt; exportDataciteXmlHandle: zalozeno pro export xml do openaire - datacite 
09.06.23 tt; filterWosScopus: odmazana podminka na maximalni pocet autoru pri stahovani s wos
05.09.23 tt; provedeno ošetření závorky, pokud je místo stran u dokumentu číslo stránku - cs122844 
30.08.23 tt; exportDataciteXmlHandle: provedeny úpravy exportu datacite
23.08.23 tt; provedena změna citace datasetů
02.08.23 tt; versionDataFilter: provedeno osetreni filteru tak, aby se zapsal spravne rok vykazovani
01.08.23 tt; zfDataLinkTab: provedena uprava linku vyzadat - v zf
20.06.23 tt; exportDataciteXmlHandle: zalozena metoda
03.05.23 tt; zmena funkcnosti U10 - odstraneno vyuziti
             - pokud nebudou problemy - vymazat  
18.04.23 tt; pridana podpora indexace akademie ved podle C90
18.04.23 tt; upraveny pripominky cav
13.14.23 tt; checkAutorID: založena metoda - zalozena metoda pro kontrolu
31.03.23 tt; provedeno nahrazeni znaku .b. - osetreni zvyrazneni
30.03.23 tt; fixStrongUrl856: medota  - provedeny úpravy fixace řetězce v url .b.
23.03.23 tt; exportCSVSoupisData: zalazena specialni funkce pro DATA
21.03.23 tt; provedeno osetreni, aby se porad nemusel nastavovat rok sberu
16.03.23 tt; zmena roku zberu 2023->2024
14.03.23 tt; pridano indexovani duplicit
07.02.23 tt; upraveno indexovani zdv
03.02.23 tt; zobrazuje se informace o rozpracování jen přihlášenému uživateli
17.01.23 tt; TfVazbyDataset: přidána podmínka na existenci linku v reálných polích
04.01.22 tt; zakomentovano odmazani zdvojenych zavorek, problem napriklad u prikladu 0565183
04.12.22 tt; allowDeleteExX: pridana kontrola na odmazavani verzi
01.12.22 tt; pridana funcnost vytvoreni kopie datasetu 
23.11.22 tt; zmena linku pro RID https://www.researcherid.com/rid/H-2591-2014 - původní - https://www.webofscience.com/wos/author/record/H-2591-2014 nový
15.11.22 tt; getDisplayFormatShortC20: provedena úprava zobrazování C20 s a f pro A3
15.11.22 tt; zakomentovani uzivatel UEF-S 0000008 .... 
09.11.22 tt; opraveno generování kódu do 999e
31.10.22 tt; osetreni prebiraciho pole U98 pro prebrane zeznamy z wos
24.10.22 tt; pridano pridani uzivatele do zaznamu prebranych z wosu
17.10.22 tt; filterWosScopus: je treba upravovat jmena utorum z WOS
03.10.22 tt; filterWosScopus: provedeno osetreni cleanUp, aby nevznikali rozdily jako v allowSave - snad to pomuze 
19.09.22 tt; doplnena kontrola na vymazane zaznamy, aby se vzdy pregeneroval link - radeji 3* dozadu
             zalozeno: isRestored
22.08.22 tt; provedena změna zobrazování DOI a handle linku pro data
11.08.22 tt; zpracovani logiky pridani DOI pro datove zaznamy
06.07.22 tt; filterWosScopus: nepotrebuje upravovat jmeno u autora z wosu
22.04.22 tt; prekladPrefixuIpac: provedeny změny, aby se prefixy propisovali + doplnili
20.03.22 tt; zmena roku zberu 2022->2023
18.03.22 tt; provedena zmena, aby prebiraci formular zustal i pri editaci pres klienta
12.02.22 tt; doplneno rozliseni datumu u A3
08.03.22 tt; změny kvůli funčnosti a zobrazování A3
03.03.22 tt; pridana kontrola, aby mohl 017a menit jen admin
10.02.22 tt; getDisplayFormatShort: provedena zmena zobrazovani poctu autoru - pokud se pocet zapsanych autoru lisi od C46a
09.02.22 tt; provedena uprava pro stazene zaznamy z wos oznacene v kratkem zobrazovacim formatu
07.02.22 tt; pridana indexace pro chytry link - pro nabizeni nabidky wos-scopus - pro import zaznamu z wos
17.01.22 tt; provedena oprava filteru 
15.01.22 tt; allowSaveExFormN463: pokud seskladavame periodikum, ulozime eissn i issn do jednoho tagu 
14.01.22 tt; osetreni na nechani jen jednoho C99
30.12.21 tt; vyrazeni testu z prohledavani zaznamu a doplnovani pracoviste
29.12.21 tt; oprava chyby pri stahovani zaznamu z WOS - chyba v cisteni - neni vyplnena trida
19.12.21 tt; getOPENAIRElink: zalozeno
18.12.21 tt; provedeny upravy zobrazeni A3
09.12.21 tt; provedeno indexovani dokumentu A3
03.12.21 tt; pridana moznost mit tucne prefixy
03.12.21 tt; pridana indexace vyzkumne zpusobu zverejneni zzpz
02.12.21 tt; getDisplayFormatShort: pridany parametry do metody, aby se zobrazil link na parametr AutorLink 
29.11.21 tt; getDisplayFormatShort: pridan zpusob zverejneni
29.11.21 tt; fmtHANDLELink a getDisplayFormatShort (prekladPrefixuIpac): doplneni moznosti tucneho pisma
23.11.21 tt; provedena zmena doplnovani pracovist z WOS
19.11.21 tt; sendMailVkladatel: provedeny zmeny v emailu
17.11.21 tt; sendMailVkladatel: zalozena metoda pro rozeslani emailu pri vystaveni dataveho zaznamu
10.11.21 tt; pokud je 969f n, ulozime si ustav + souhlas k tomu, aby jsme jednoduse mohli nabidnout link v MyAsep
09.11.21 tt; odstranen rok pro zobrazeni dat
02.11.21 tt; pridana funkcnost na dotazeni pracoviste WOSu pri stahovani zaznamu
31.10.21 tt; pridana poznamka k zf dat 237a
20.10.21 tt; u druhu dokumentu BCA zajisteno indexovani ye ze clanku
19.10.21 tt; přidány symboliky pro hodnotící kritéria - vrátí nejnovější. Založena metoda get978Last
19.10.21 tt; oprava mozne vlozene mezery
18.10.21 tt; odstraneno indexovani md - dataset - neni spravne
26.07.21 tt; zmena linku wos
13.05.21 tt; getBibcitCAV: pridano dotazeni parametru do BibcitSzfAuthors - aby slo pouzit napriklad AutMaleP
19.03.21 tt; pridan uzivatel sykora do adminu cav 
15.03.21 tt; pridana promenna, aby se pokazde nemusel přepisovat v klientu rok vykazovani
15.03.21 tt; zmena roku zberu 2021->2022
10.03.21 tt; zfChangeHandleI3Form: pridano osetreni na spravny tvar C12 - a osetreno nacteni do struktur LN
10.03.21 tt; TfAutoriCav: doplnena volba u autoru na zobrazovani 70Xk - volba 70Xk
04.03.21 tt; zobrazeni linku v citacich - uprava na zadost cav
24.02.21 tt; pridano indexovani zprai + znav
22.02.21 tt; zmena url na riv
18.02.21 tt; getBibcitCAV: provedeny změny bibliografických citací
09.02.21 tt; preveden vyzkumny zamer na infrastruktury 
26.01.21 tt; pridana indexace vyzkumne infrastruktury
20.12.20 tt; pridano a otestovano zobrazeni vyzkumne infrastruktury (C90)
28.11.20 tt; upraveny citace
18.11.20 tt; provedeno osetreni bibliograficke citace - doi ...
28.10.20 tt; zfChangeHandleI3FormTxx: pridano osetreni, aby byl handle nacteny v pristupne stromove strukture - potre
09.10.20 tt; upraveno zobrazeni pro druh E
09.10.20 tt; pridane prijmeni jako velka pismena, jde to znastavenim zrusit - upraveno nastaveni
09.10.20 tt; upraveno zobrazeni pro P1
09.10.20 tt; pridano formatovani datumu pro P,P1, U - meni se fyzicky podpole
11.08.20 tt; pridano defaultni nastaveni bUserIsAdmin
16.07.20 tt; allowSaveExCheckFldModif: provedena zmena, aby se se C12 nedala editovat vubec - vyjimka zpusobovala 
             problemy, kdy zpracovatelky menily C12   
01.05.20 tt; pridan symbolik pro vypis typu spoluprace ve zkratce cs113936 
15.04.20 tt; pridany indexy pro duplicity zd
14.04.20 tt; zakomentovany validace oddeleni - zpusobovalo problemy - odblokuje v pristim tydnu
13.04.20 tt; allowSaveEx: doplnena metoda na nahtazeni _ a ; u oddeleni 7XXi podle oddeleni 7XXp - validace podle číselníku EPCA_ODDEL_...
08.04.20 tt; zalozena specialni metoda na kontrolu 70*w
08.04.20 tt; zmena roku zberu 2020->2021
01.04.20 tt; nove zeznamy namaji mit C64 - kopie zaznamu
25.03.20 tt; provedena zmena variantnich jmen pro @AUTDOMTYM, aby byly stejne jako u @AUTDOMVYPODD
20.03.20 tt; exportCSVSoupis: pridana url webu a exportu webu do RIVu do exportu csv z kosiku
18.03.20 tt; pridan zpusob publikovani do exportu csv z kosiku
09.03.20 tt; allowSaveExRZ: pridana kontrola na zmenu 700w + 701w + 702w 
04.03.20 tt; pridana indexace vydavatele - index "emb" 463/210c
27.02.20 tt; provedena uprava osetreni generovani autoru do V10 u tymu
26.02.20 tt; provedena zmena indexovani zhod - kvuli hodnoceni 2020
25.02.20 tt; pridana lupa do zf v epca formularich pro citaci/recenzi
27.01.20 tt; doplneno trideni - pro oddelneni
10.01.20 tt; VariantJmenaAuth: pridana varianta pro serazeni vsech variantnich jmen
07.01.19 tt; pridany preklad ustavu do zkraceneho zf
18.12.19 tt; doplnena funkcnost pro zmenu formulare
13.12.19 tt; doplneny oddeleni u generovani nove autority
02.12.19 tt; upravena funkcnost ups, aby se filtrovala hodnota 4 pro archiv
08.11.19 tt; pokud mame link na citovany zaznam, zobrazi se citace zaznamu
07.11.19 tt; upravena funkcnost zf pro bibliograficke citace, pridany parametry - odstraneni html
30.09.19 tt; pridana  InformaceOVyuziti - C11p 
24.09.19 tt; pridany symbolik pro vypis oddeleni
23.09.19 tt; predpracovan symbolik pro oddeleni AUTOR_ODD na varianty
23.09.19 tt; prepracovan symbolik na varianty C06 @AUTOR_A_C06
18.09.19 tt; provedena uprava indexovani a zobrazeni slovniku pro ustav
17.09.19 tt; pridana podminka na zobrazeni jen tech teminu, ktere jsou ve slovniku
14.09.19 tt; indexOddeleni: zalozena indexacni metoda kvuli velkemu poctu udaju oddeleni
13.09.19 tt; pridan vlastnik zaznamu AV
14.08.19 tt; kopie indexu grag
06.08.19 tt; pridano nahrazeno klicoveho ".u." za jine slovo ./emphasis.
31.07.19 tt; Změna roku sběru by měla být možná pro všechny záznamy aktuálního roku sběru a pro neoznačené záznamy do RIV 
             všech roků sběru a to na rok sběru vyšší a nazpět.
12.07.19 tt; pridany symbolik @AUTOR_ODD a @AUTOR_A_C06H
11.07.19 tt; nahrada v.v.i. za v. v. i.
01.07.19 tt; pridan index pro vyhledavani v ipacu se vsemy slovy zoddp -odvozeny z oddp + zgrag
26.06.29 tt; Vyhledávání podle oddělení autora v IPAC - podle pripominky indexovat vsechna slova,
             uzivatele neznaji presne nazev oddeleni   
26.06.19 tt; pridana podminka na pracoviste - pokud ma autor pracoviste, je domaci
23.06.19 tt; zmena url pro RivId
10.06.19 tt; zmdt - upraven index aby indexoval i navazane soubory
04.06.19 tt; vracena podminka
30.05.19 tt; allowSaveExRZ: provedena uprava podminky roku sberu
04.05.19 tt; allowSaveExRZ: pridano - neodeslani zaznamu:  - záznamy, které jsou odeslane do RIV (jiny nez aktualni rok sberu) 
             nesmi zpracovatel oznacit jako neodeslane. - pridano 969f
10.04.19 tt; pridana promenna pro indexaci poskytovatelu, kteri jsou pouziti ve opravach pro RIV C83 a indexace
25.03.19 tt; zmena roku zberu 2019->2020
25.03.19 tt; uprava logiky, aby neslo zmeni roky vykazovani, kdyz uz je vykazany do rivu
01.03.19 tt; pridan priznak pro smlouvu - specialni typ
09.02.19 tt; indexSmlouva: pridana indexace smlouvy
06.02.19 tt; exportCSVSoupis: pridana smlouva do csv do exportu z kosiku
06.02.19 tt; upravena podminka, aby se indexovaly projekty s delkou 3 a vice znaku - zprog
02.02.19 tt; ixIndexValuesEx: pridana indexace smluv
31.01.19 tt; tfLicence: zalozena metoda
08.01.19 tt; provedena uprava getRIVlink, getWOSlink, fmtSCOPUSLink o parametry a hodnoty parametru
             (params="class") kvuli ikonam v i3 aplikaci
05.01.19 tt; pridan index pro datasety do exp
04.01.19 tt; provedena uprava indexace oecd - terminy jak s kodem tak bez nej
02.01.19 tt; provedena uprava indexace oecd pro C26
15.12.18 tt; provedena zmena ZF 
14.12.18 tt; Provedena úprava zf podle dodatečných informací. 
06.12.18 tt; zapsana uspornejsi forma zobrazovani cisla a roku
05.12.18 tt; nahrazeni ; za , u vsech autoru
05.12.18 tt; odstraneno zobrazeni RIVID pro autory
04.12.18 tt; provadeny upravy zf - odkazy 856 v novem okne
                                 - pridano pro J a Ji zobrazeni 463/200d 
28.11.18 tt; odstraneno doplneni https pro datove zaznamy - cs33259
22.11.18 tt; provedena oprava podminky roku zberu
09.06.18 tt; exportCSVSoupis: pridano osetreni formatovacich znacek
06.06.18 tt; upraveny podminky pro vyhodnoceni openaire
21.03.18 tt; pridany hodnoty do csv pro OECD ciselniky
21.03.18 tt; ixIndexValuesEx: pridana indexace OECD ciselniku 
20.03.18 tt; zmena roku zberu 2018->2019
06.03.18 tt; BibcitSzfCheckLast:zmena stylu na html
05.03.18 tt; zmeny bibliografickeho stylu 
01.03.18 tt; pridano zobrazeni OECD
07.02.18 tt; provedena uprava a pridani ., pokud tam neni.
24.01.18 tt; allowSaveExRZ: pridana kontrola na datove zaznamy        
23.01.18 jk; presunuto do IctxUnTablesd
22.01.18 tt; TfAutoriCav: provedena uprava v autorech, aby pokud ma autor pracoviste, tak aby se nezobrazoval jazyk
22.01.18 tt; userIsAdmin: provedena dalsi uprava identifikace superuzivatele
19.01.18 tt; provedena oprava linku - pridan prefix http: pri www
19.01.18 tt; upravena podminka pro index, ktery si vyuziva pri filtrovani zaznamu pro formulare datovych zaznamu - nenabizet BCA a BXXS
12.01.18 tt; provedeny upravy linku, aby se spravne zobrazoval a fungoval i ve formularich
28.11.17 tt; HODKRIT: upraveny podminky pro dotahovani T16r
24.11.17 tt; VariantJmenaAuth: upraveno trideni v uzlech pro serazeni autorit
24.11.17 tt; pridana indexace eissn do indexu issn
23.11.17 tt; HODKRIT: upraven rok kriterii na T16r pro hodnotici kriteria
06.11.17 tt; zfLicence: pridana jazykova verze pro zobrazeni licence
06.11.17 tt; userIsAdmin: pridana uzivatelka janderova
25.10.17 tt; allowSaveEx: provedena uprava strany od do, pokud jsou jen ve v
18.10.17 tt; pridan symbolik - "@HODKRIT_" zalozen sloupec pro zobrazeni hodnoticich kriterii ze zdroje 
11.10.17 tt; zoprazeni programu pro granty
03.10.17 tt; ixIndexValuesEx: pridana indexace programu z autority projektu (230b)
11.09.17 tt; pridany vyjimky pro zobrazeni velkych dat
08.09.17 tt; checkFulltext: založena metoda
05.09.07 tt; upraven index z zdmt na zdms
01.09.17 tt; pridana indexaca navazanych zaznamu u datovych zaznamu
01.09.17 tt; doplnena reindexace navazanych zaznamu
01.09.17 tt; uprava indexace indexu "zmdl" pro navazadi zaznamu na datavy zaznam
29.08.17 tt; pridano generovani 000 pri automatickem zakladani DFLT_CAT_BXXS a DFLT_CAT_BCA
29.06.17 tt; upravena podminka pro zobrazovani handlu
19.05.17 tt; ixIndexValuesEx: pridan index pro opravy RIVu
17.05.17 tt; pridan index RIVOPR
16.05.17 tt; zablokovani editace roku 2017
10.05.17 tt; zfLicence: upraveno zobrazování - přidán link
06.04.17 tt; zmeny provadene kvuli zf velkych dat 
06.04.17 tt; zfLicence: pridan blok pro zobrazovani licence
21.03.17 tt; zmena roku zberu 2017->2018
13.03.17 tt; zapojena zmena stavu fulltextu na stav 4 - vystaven
13.03.17 tt; pridano rozliseni stavu u datovych zaznamu jestli uzivatel souhlasil s vystavnim, nebo ne
06.03.17 tt; presunuto ukladani na vraceni U70 jako vysledek a vysledne ulozeni posleze
28.02.17 tt; filterWosScopus: uprava editoru (pripominky pro wos)
24.02.17 tt; exportCSVSoupis: pridan sloupec AutořiRIV
19.02.17 tt; pridano @ROKVYDANI
07.02.17 tt; pridany symboliky pro trideni autoru v zaznamu - multivaluesort - 
             @AUTORT, @AUTOR_ID,@AUTOR_RID,@AUTOR_JMENO,@AUTOR_USTAV,@AUTORI
01.02.17 tt; pridan specialni druh dokumentu kvuli neodeslanym zaznamum
01.02.17 tt; zrusena podminka na indexovani auk na neodeslane zaznamy, kvuli problemum s vymazavanim
25.01.17 tt; dogenerovan link do U63 pri doplneni noveho - upravy cisteni autorit
24.01.17 tt; allowSaveExFormN: odstraneni autoru, pokud nejsou v tagu jine udaje nez role ////////////
20.01.17 tt; experimentalne naplnim data U63 a U70 - aby me cisteni nemenilo pod rukama 463 a zf 
             vznikaly tim rozdily mezi 463 a U70
11.01.17 tt; indexNeodeslane: indexace neodeslanych zaznamu zaznamu do ipacu pro specialni ucely
04.01.17 tt; zfDataLink856: pridan blok pro zobrazovani linku na vedecka data
03.01.16 tt; zfChangeHandleI3Form: provedena uprava doplneni txx do I3
03.06.16 tt; getPUBMEDlink: zalozeno
16.12.16 tt; createAuthLinks463genSZP: opraven druh zdrojoveho periodika na bca
14.12.16 tt; getDisplayFormatShortC20: upraveno cteni jen prvniho znaku pro druh dokumentu. Kvuli A
09.12.16 tt; userIsSpecZprac: Zalozena metoda
05.12.16 tt; allowSaveEx: opraveni 969 pokud je neco spatne
25.11.16 tt; upravy zobrazovaci hormatu zkraceny pro DATA
17.11.16 tt; pridane indexovani dataset bez souboru - datasetu
15.11.16 tt; pridano odmazani priznaku odmazavani - klicovych slov u prebirani zaznamu wos scopus a zmeny
11.11.16 tt; upravy kvuli prebirani zaznamu
04.11.16 tt; pridano zobrazovani cisla clanku
31.10.16 tt; pridana podpora odmazani spolupracujici instituce pri prebirani zaznamu
             v prebiracim zaznamu z wos a scopus      
             upravy scopus
24.10.16 tt; zfChangeHandleI3Form: pridan prenost U99 kvuli rozpoznani odkuz zf jde
22.10.16 tt; pridana indexace metadatoveho zaznamu a souvisejicich
20.10.16 tt; ixIndexValuesEx: pridano indexovani vedeckych dat
19.10.16 tt; ixIndexValuesEx: indexace metadatoveho souboru
15.10.16 tt; getRIVlink: uprava logiky skladani linku do RIVu na zaklade C12d
02.10.16 tt; reseni problemu s 970b pri prebirani zaznamu
22.09.16 tt; ixIndexValuesEx: pridana indexace bez diakritiky
22.09.16 tt; úprava zobrazování datumu
15.09.16 tt; allowSaveExFormN: pridana podpora odmazani klicovych slov pri prebirani zaznamu
             v prebiracim zaznamu z wos a scopus
15.09.16 tt; allowSaveEx: vymazani C52 u novych zaznamu
08.09.16 tt; upraven rok v podmince pro povoleni mazana dat jinemu uzivateli, nez administratorovi
29.08.16 tt; filterWosScopus: upravy dotahovani zaznamu
23.08.16 tt; getRIVlink: uprava linku za novy stav - novy server pro vysledky RIVu
22.08.16 tt; exportCSVSoupis: provedena uprava vice tecek v exportu u BiblCitZdrD
09.08.16 tt; odstranena kontrola kvuli nevyhledani BCA dokumentu
22.07.16 tt; oprava vkladani 999e u sborniku
18.07.16 tt; allowSaveExFormN470: upraveni auotri v 470 z 702 na 700 a 701
27.06.16 tt; pridane indexovani oddeleni autora pro slovnik
26.06.16 tt; pridana indexaci id pro slovnik zidcsl
23.06.16 tt; upravy podle  doplneni k ZF - edice - cs30872 
20.06.16 tt; pridana indexace zauasl
16.06.16 tt; pro ID scopusu indexuji i s prefixem
14.06.16 tt; getDisplayFormatSlovnik: zalozena metoda pro zobrazovani ze slovniku
14.06.16 tt; uprava indexovani pro slovnik
12.06.16 tt; upravy zobrazeni edice v zf dle cs30872
11.06.16 tt; docasne vypnuto odmazavani 70*y pokud je 70*p 
10.06.16 tt; upraveno zobrazovani cs30805 
06.06.16 tt; upraveno indexovani druhu dokumentu - rozsireni L,L3 a Z
06.06.16 tt; uprava indexu oddeleni, i bez prefixu
06.06.16 tt; pridan index zidc
03.06.16 tt; ixIndexValuesEx: pridan index zdoi
03.06.16 tt; getPUBMEDlink: zalozeno
02.06.16 tt; upravy na zadost cav cs30805
02.06.16 tt; ixIndexValuesEx: droba uprava indexace dki - vyuziva se i pro trideni
11.05.16 tt; userIsAdmin: pridana kontrola na superuzivatele userIsAdmin 
26.03.16 tt; ixIndexValuesEx: pridana promenna pro indexaci poskytovatelu, kteri jsou pouziti ve vymazavani 
             RIV C51 a indexace
20.03.16 tt; zmena roku zberu 2016->2017
19.02.16 tt; pokud nam prijde z formulare priznak zadani aktualniho roku vykazovani, pouzijeme jej
10.03.16 tt; pridano indexovani C34v v indexu zpdv pro odeslane zaznamy
03.03.16 tt; ixIndexValuesEx: pridan index zid
21.02.16 tt; ixIndexValuesEx: doplnena indexace 970x - zodr
09.02.16 tt; symCleanUp: odstranena aktualizace oddeleni
28.01.16 tt; osetreni odmazavani mezer u 4xx - podle podpole 1
27.01.16 tt; userIsAdmin: kvuli vystupum predelana funkcnost - pridan publicList s sUser
27.01.16 tt; upravena podminka opakovatelnosti,aby fungovala spravne pro C13
21.01.16 tt; symCleanUp: rozsirene kontroly jen pro zaznamy, ktere pujdou ulozit a maji validni ISSN
19.01.16 tt; upraveno filtrovani pro uxx a txx + upraveno dotahovani informaci do autoru
18.01.16 tt; pridana indexace pra pro desiderata
12.01.16 tt; allowSaveExCheckFldModif: pridana moznost needitovat C12d i u ostatnich projektu
06.01.06 tt; allowSaveExCheckFldModif: pridano osetreni na moznou modifikaci C12
21.12.15 tt; odstraneni prazdnych mezer za zacatku a konce subtagu 
21.12.15 tt; indexNenavazane: pridana indexace nenavazanych zaznamu a vlastnika (999e-f)
18.12.15 tt; oprava vkladani vlastnika kvuli starym formularum - zmena 999e na f BXXS,BXX,BCA
01.12.15 tt; zfChangeHandleI3Form a zfChangeHandleI3FormTxx:
             pridan blok pro zobrazovani handlu ve stavu po ulozeni
24.11.15 tt; createAuthLinks463genSZP: nahrazen formular DFLT_CAT_BXX za DFLT_CAT_BCA
24.11.15 tt; oprava, aby se nedotahovali Uxx pole do 4xx zaznamu
20.11.15 tt; zfDataLink: pridan blok pro zobrazovani linku na vedecka data
20.11.15 tt; allowSaveEx: melo by projit generovanim vzdy U poli vzdy, kvuli editaci moznych starsich zaznamu
19.11.15 tt; osetreni generovani 463 u ohlasu pro CavUnOhlCat
16.11.15 tt; createAuthLinks463genSZP: nahrazen formular DFLT_EPCA3 za DFLT_CAT_BXXS a DFLT_CAT_BXX
11.11.15 tt; u konverenci se nebude shlukovat datum do C20f
10.11.15 tt; zprehazene poradi v allowSaveEx
             - potencialne nebezpecna operace, ktera je ale nutna kvuli zaznamu z formularu
03.11.15 tt; zmena 999e na f - u DFLT_EPCA3
30.10.15 tt; createAuthLinks: do generovani zaznamu pridano doplneni autora 999e
27.10.15 tt; provedeny zmeny kvuli podpore E-ISSN
12.09.15 tt; zalozena metoda pro potreby novych formularu pro konverzi U70 na 470
11.09.15 tt; allowSaveExFormN463: zalozena metoda pro potreby novych formularu pro konverzi U63 na 463
09.09.15 tt; allowSaveExFormN: pridany upravy pri odevzdani do ipacu z novych formularu
             https://cosmo2/wiki/index.php/CAV:Formul%C3%A1%C5%99e_I3_dokumentace
08.09.15 tt; ixIndexValuesEx: upravena indexace zoai
04.09.15 tt; SzfGrant: do zobrazeni grantu peidano zobrazeni eu grant
04.09.15 tt; pridana indexace poskytovatele
03.09.15 tt; ixIndexValuesEx: pridana indexace ZOAIR
01.09.15 tt; pridana indexace zeissn
17.08.15 tt; pridana funkce na vypis neodeslan
16.08.15 tt; pridan fix kvuli MyAsep pro ds - pridana n pro 969f=d. Po prechodu na nove formulare, muze byt odstraneno
13.08.15 tt; pridano zobrazovani linku RIVu
08.08.15 tt; ixIndexValuesEx: pridano vyhodnoce pro to, jestli je zaznam zalozen v novych formularich a jestli to
             ovlivnuje indexovani (primy dopad na index exp kvuli logickym bazim)
15.04.15 tt; Tag700ByTym: pridana kontrola na vyplneni tymu. Pokud neni vyplnen, neni co srovnavat
03.04.15 tt; pridane do indexu zhod - Záznamy vybrané k hodnocení s recenzemi
03.04.15 tt; pridana jina forma indexovani
22.03.15 tt; zmena roku zberu 2015->2016
20.03.15 tt; upravy trideni tymu
20.03.15 tt; getBibcitCAV463: odstranena uprava 463/200v na male pismena z generovany txx tagu pro zobrazeni
             - na zadost pani Dolezelove - problem v OAI setu
18.03.15 tt; userIsAdmin: pridana uzivatelka podloucka
11.03.15 tt; pridana kontrola na pocet uzivatelu pro vytvareni txx tagu  
10.03.15 tt; pridany symboliky pro trideni tymu v zaznamu - multivaluesort - 
             @TYMT, @USTAV_T_ENG, @USTAV_T_CZ, @USTAV_T_ZK, @UTWOS, @TYM_T_OBOR, @TYM_T_PODOBOR, @TYM_T_CZ, @TYM_T_ENG, @TYM_T_PEERREV
04.03.15 tt; allowSaveExRZ: pridana kontrola na změnu C64 mimo ADMIN účtů
25.02.15 tt; allowDeleteExX: pridana kontrola na C64 
30.01.15 tt; ixIndexValuesEx: indexace tymu 70*w
24.01.15 tt; exportCSVSoupis: pridano doplneni pracoviste v cj a aj
                              upraven format ID WOS a SCOPUS 
13.01.15 jk; do ws commands se predava pEnvironment 
03.01.15 tt; getTFOhlasyLink: zalozena metoda 
17.12.14 tt; getBibcitCAV: pridana dalsi varianta, kvůli dotahování ohlasů.
06.12.14 tt; ixIndexValuesEx: pridan index hodnoceno pro tym - ztnu
06.12.14 tt; indexHodnoceniAV: pridana hodnota bnpft k indexu zhod
19.11.14 tt; getSymbX: pridano volani na ziskani variatnich jmen a oznaceni *
             VariantJmenaAuth: zalozena metoda
10.11.14 tt; upravena logika dle upresneni CAV pro index zhod
07.11.14 tt; ixIndexValuesEx: pridana indexace indexu zhod ve specialni metode
06.11.14 tt; indexHodnoceniAV: zalozena metoda 
01.11.14 tt; getSymbX: pridany symboliky pro vypis tymu v zaznamu (na zaklade ODDELV)
             @AUTDOMTYM a @TYMV
29.10.14 tt; getSymbX: pridany symboliky @HODOBOR a @HODPODOBOR
26.10.14 tt; pridany indexy zut, ztu, ztn
27.09.14 tt; exportCSVSoupis: pridano do exportu z kosiku csv rozliseni pro 014 - kod wos a scopus 
02.09.14 lo; odstraneny tridici indexy
18.08.14 tt; dalsi zmeny zf
16.08.14 tt; upravena podminka, aby se neprepraskavalo nastaveni z ipacu u zf, kde je
03.07.14 tt; exportRIS: pridan oddelovac na konec
02.07.14 tt; ixIndexValuesEx: pridano hodnoceni autoru - zha
30.06.14 tt; exportRIS: upravy RIS podle cs28864 
10.06.14 tt; upraven text o diakritiku (pro ASCII RIS formaty)
08.06.14 tt; TfAutoriCav: pridano zobrazeni korespondencniho autora 70Xz = K
04.06.14 tt; ixIndexValuesEx: vypustena indexace ups s hodnotou 4 pro stav archiv
31.05.14 tt; pridane do RIS prvek AN
14.05.14 tt; getSymbX: symbolik pro ziskani vsech opakovani RVO - @RVO  |
12.05.14 tt; getWOSlink: odstranena kontrola na pismena u WOS linku
07.05.14 tt; ixIndexValuesEx: generovani auk pro 971 a C71 presunuto do popredi, aby se generovalo i pro deziderata
29.04.14 tt; ixIndexValuesEx: pridany ohlasy do indexu auk - z databaze ohlasu
29.04.14 tt; getBibcitCAV: upravena funkcnost zf pro bibliograficke citace, pridany parametry - odstraneni html
28.04.14 tt; getSymbX: opraveno poradi pokud neni zadane pracoviste "@AUTDOMVYPODD"
27.04.14 tt; presunuto zobrazeni ohlasu do bloku getTFOhlasy
             + vytvoren tento blok
22.04.14 tt; getBibcitCAV463: uprava bibliograficke citace - zmeneno 200v na mala pismena
20.04.14 tt; vypusteni dvou mezer z indexu aupra
01.04.14 tt; Zalozen symbolik pro vystupy epca s C51g
01.04.14 tt; pradl: pridan index pro odmazavani zanamu z RIVu
16.03.14 tt; zmena roku zberu 2014->2015
15.03.14 tt; nastaveno zobrazovani 200h pro vsechny sbornikove zaznamy
14.03.14 tt; zmena ve tvoreni vyhledavaciho klice + 200h
13.03.14 tt; oprava zapomenuteho kodu, ktery zdvojoval informace
11.03.14 tt; ixIndexValuesEx: pridany do indexu zpz hodnoty pro vyzkumne zpravy
09.03.14 tt; getDisplayFormatShortOLD: pridano zobrazeni 200h do ruznych zf
27.02.14 tt; createAuthLinksC12: upraveno generovani projeku - aby se generovali projektu i pokud je projek mimo CEP
18.02.14 tt; allowSaveEx: pridana vyjimka, aby se nekontrolovaly duplicity u BXXS
12.02.14 tt; ixIndexValuesEx: pridana indexace vyzkumne zpravy - rozsireni pro index dk
06.02.14 jk; zruseny globalni promenne ictx a lang
06.02.14 jk; zrusena metoda writeLimits
04.02.14 tt; BibcitSzfAuthorsG: odstranen garant pri zobrazeni
06.01.14 tt; getSCOPUSlink a getWOSlink: pridana podpora malych pismen
13.12.13 tt; allowDeleteContent: pridano overeni a allowDelete, jestli dany zaznam nema nejak fulltexty
             + zapojeno do allowDeleteExX
29.11.13 tt; getDATAEx: pridan seznam fulltextu do tagu Tft
29.11.13 tt; getNameFT: zalozena metoda
18.11.13 tt; getSCOPUSlink a fmtSCOPUSLink: zalozeno
18.11.13 tt; getWOSlink: upraveno, aby se zobrazovali jen zaznamy s id WOS
12.11.13 tt; allowSaveEx: pridano odescapovani 856 pri uklozeni zaznamu - problem s escapovanim z ipac1
08.11.13 tt; getSymbX-@AUTDOMVYP: ziskame si variantni jmena autoru pro V2 (400) a vlozime do exportu
01.11.13 tt; ixIndexValuesEx: pridana spolupracujici instituce do indexu
27.10.13 tt; createAuthLinksC63: pridana definice promennych kvuli situaci, kdy nemusi byt definovane
24.10.13 tt; pridany index iskod (issn/isbn/ismn)
21.10.13 tt; ixIndexValuesEx: upraveno indexovani C63
17.10.13 tt; createAuthLinksC63: doplneno generovani spolupracujici insituce z tagu C63
28.07.13 tt; TfPuvPrace: zalozeno
10.07.13 tt; TfVydUdaje: zalozeno
10.07.13 tt; exportCSVSoupis: pridany dalsi sloupce pro zobrazovani
26.06.13 jk; v indexparams smazany modifikatory tridy
14.06.13 tt; TfAutoriCav: pridan parametr 10
12.06.13 tt; ixIndexValuesEx: pridana indexace do zaznamu ID autoru
12.06.13 tt; TfAutoriCav: pridan parametr 9 pro zobrazeni lupy
11.06.13 tt; fmtHANDLELink: pridany parametr 3
07.06.13 tt; TfAutoriCav: pridano zobrazeni ID na parametr 7
06.06.13 tt; ixIndexValuesEx: pridany jeste nazev instituce do indexu spi
05.06.13 tt; ixIndexValuesEx: pridany indexy C62 - C65
23.05.13 tt; getDOIlink: odstraneni fixupy kvuli spravnemu zobrazovani linku DOI
20.05.13 tt; fmtHANDLELink: moznost nastaveni prazdneho prefixu
18.05.13 tt; fmtHANDLELink: uprava pro tisk a upravy zf dle pozadavku
08.05.13 tt; TfRozsahStran: zalozeno
08.04.13 tt; allowSaveExRZ: zakazani modifikace starsich zaznamu, pridano C57
05.04.13 tt; ExportCSV: pridane exportni metoda - terminal
21.03.13 tt; zmena roku zberu 2013->2014
20.02.13 tt; specialni uprava pro tisk
13.02.13 tt; zmeny kvuly upgradu
06.02.12 tt; allowSaveEx: dalsi uprava logiky generovani handle linku
24.01.13 tt; ixIndexValuesEx: pridany index cau pro odkazy na autority
24.01.13 tt; ixIndexValuesEx: pridany index zpz (presne 970b + vyjimky)
18.01.13 tt; allowSaveEx: pridana funkcnost u kopirovanych zaznamu, aby se vytvoril handle
17.01.13 tt; getWOSlink: uprava linku podle https://www.lib.cas.cz/arl/publikace.php
17.01.13 tt; allowSaveEx: osetreni novych zaznamu proti zkopirovani handle linku
14.01.13 tt; getWOSlink: zalozeno
21.12.12 tt; fmtHANDLELink: zalozeno
07.12.12 jk; handle.net
             Dokumentace handle.net https://cosmo2/wiki/index.php/Cust:CAV/handle_net
02.11.12 tt; getBibcitCAV: drobna uprava logiky, pri osetreni autoru v 702 a zkracovani inicialu
27.10.12 tt; fmtRIVLink a fmtDOILink: pridano vysvetleni RIV a DOI
27.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
16.10.12 tt; getDisplayFormatShort: uprava zobrazeni vsech jazyku
16.10.12 tt; parametr, aby se vedelo, ze se spousti z ipac3, nezobrazovat linky
15.10.12 tt; getTFBezZahlNavCit: pridano klicove slovo, kterym lze nahradit ./u.
15.10.12 tt; getBibcitCAV: osetreni formatu bibl. citace s inicialami proti zkracovani jmena dle pripominek skype
15.10.12 tt; getDisplayFormatShort: zakomentovano zobrazovani jen prvniho autora na zadost pani
             Dolezelove po skypu
11.10.12 tt; pridan parametr pPar pro nahrazeni .u.
07.10.12 tt; ixIndexValuesEx: pridana indexace C52$c=nusl
26.09.12 tt; allowSaveEx: pridani zapsani zmeny stavu do statistik
20.09.12 tt; ixIndexValuesEx: zaindexovani nazvoveho indexu tie pro vyhledavani a naseptavat ipacu
14.09.12 tt; exportCSVSoupis: pridana uprava, aby se data exportovala podle zadaneho ustavu v parametrech
13.09.12 tt; exportCSVSpol a getSpolByHandle:zalozeni exportniho formatu csv na zaklade exportCSVSoupis, kde se
             zaznam podle spolupraci muze exportovat nekolikrat. 
29.08.12 tt; rozdeleni zobrazovani oddelovace podle druhu dokumentu
28.08.12 tt; ixIndexValuesEx: pridana podpora indexace akademie ved podle C57 (RVO)
16.08.12 tt; ixIndexValuesEx: pridana indexace C58a a 463/C58a
19.06.12 tt; oprava prekladu podle ciselniku, musi byt definovana hodnota 
18.06.12 tt; prepracovano zobrazovani C12
17.06.12 tt; getDisplayFormatShort: uprava vypisu zdroje financovani C12d
13.06.12 tt; getDisplayFormatShort: pridani vypisu RVO C57
12.06.12 tt; ixIndexValuesEx: pridana indexace C57 (rvo)
07.06.12 tt; getSymbX: pridan symbolik @AUTDOMVYPODD pro vypis domacich autoru podle oddeleni
             vyzaduje trideni @PRAC
05.06.12 tt; drobna uprava zf
04.06.12 tt; upraveno trideni a zobrazovaci format
02.06.12 tt; getDisplayFormatShort: upraven zf pro potreby getDisplayFormatShortCit. (volba "BZNC")
31.05.12 tt; ixIndexValuesEx: pridan index rdn pro sortovani podle roku, druhu a nazvu
27.04.12 tt; getDisplayFormatShort: upravy zobrazeni 
17.04.12 tt; symbolik pro pocet navazanych zaznamu clanku podle T04 pro BCA zaznamy @NAVZAZZJ
17.04.12 tt; symbolik pro impakt faktor podle daneho roku ze zaznamu BCA
12.04.12 tt; getDisplayFormatShort: oprava logiky
10.04.12 tt; getDisplayFormatShort: upraveno zobrazeni druhu
06.04.12 tt; zmena pri zobrazovani 463
05.04.12 tt; pridan symbolik pro vypis vyzkumneho zameru @VYZZAM
29.03.12 tt; ixIndexValuesEx: pridano indexovani C21d tzv
15.03.12 tt; zmena roku zberu 2012->2013
15.03.12 tt; getDOIlink: upraveny link pro ipac2, aby se neodfiltrovavali znaky napr .b. atd.
24.02.12 tt; getDisplayFormatShort: pridano a otestovano zobrazeni spoluprace C55 do kodu oboru
15.02.11 tt; allowSaveExRZ: pridana podminka, aby mohli zpracovatele zadat vetsi rok zberu
30.12.11 tt; ixIndexValuesEx: pridana indexace C52
20.12.11 tt; pridana moznost zkratit jmena autoru - pridany tag s nimi
23.11.11 tt; allowSaveEx: pridana zmena stavu souboru u content serveru pri vystaveni zaznamu v ipacu
             je potreba zmeni stav souboru - repozitar cav
08.11.11 mk; vytvaranie automatickeho spojenia C123 na autoritu projektu
17.10.11 tt; getRIVlink: zmenen link do RIV
12.10.11 tt; zalozeny index prad - pracoviste nezavisle na dezideratech
07.09.11 tt; TfAutoriCav: zalozeno
13.07.11 tt; allowSaveEx: uprava podminek pro generovani noveho zaznamu
12.07.11 tt; allowSaveEx: odmazeni pole C26$b, pokud byl zaznam odmazan z RIVu + dalsi podpurne zmeny
             pro tuto funkcnost  
13.05.11 tt; ixIndexValuesEx: presunuto odstraneni mezer do nahradni faze, aby se nejdrive
             vyhledavaly projekty tak, jak jsou zapsane v zaznamech
26.04.11 tt; userIsAdmin: pridany uzivatelky
14.04.11 tt; ixIndexValuesEx: uprava vytvareni indexu auk na autoritu projektu
11.04.11 tt; ixIndexValuesEx: upraveny podminky pro indexaci pras
08.04.11 tt; ixIndexValuesEx: pridany index pro zaznamy se spolupracujicimi zaznamy
29.03.11 tt; ixIndexValuesEx: zmena indexovani xd1 kvuli moznosti opakovatelnych isbn
25.03.11 tt; zmena indexovani issbn
25.03.11 tt; doplnena podpora ISBN u 4xx
25.03.11 tt; doplneni opakovatelnosti pro ISBN
15.03.11 tt; zmena roku zberu 2011->2012
04.03.11 tt; getDisplayFormatShort: pridan kod oboru RIV
18.02.11 tt; ixIndexValuesEx: pridany odkaz na do auk pro projekty
28.01.11 tt; BibcitSzfAuthorsG: uprava zvyrazneni a logiky garanta G
27.01.11 tt; BibcitSzfAuthorsG a BibcitSzfAuthors: zvyrazneni a potrzeni domacich autoru + pridani "G"
12.01.11 tt; getBibcitCAV a getDisplayFormatShortOLD: do zobrazovaciho formatu pridana verze 
12.11.10 tt; allowSaveExCheckFldModif: pridano osetreni prehodeni podpoli a metoda prepracovana
11.11.10 tt; createAuthLinks463 a createAuthLinks463genSZP:
             udelany upravy pro spravne vytvoreni SZP a pripadne predani hlasky
22.10.10 tt; upraven oddelovac nazvu souboru pro parsovani
21.10.10 jk; zmene oddelovac mezera za znak $c(10)
11.10.10 jk; na radku c.7 se predava zkratka ustavu prihlaseneho
05.10.10 jk; uprava v err code
29.09.10 kp; jako odělovač pro sOutput je použit znak |
29.09.10 ln; cmdFullTextUp: pridano ukladani a chronologie
22.09.10 jk; v nazvu soubour zamena hvezdicky v idx za pomlcku
15.09.10 jk; pridana metoda cmdFullTextUp()
16.07.10 tt; ixIndexValuesEx: zalozena nova hodnota indexu dk
22.06.10 tt; opravena podminka pro C06
15.06.10 tt; getSymbX: zmenen oddelovac oddeleni 
02.06.10 tt; ixIndexValuesEx: zalozen nova hodnota indexu dk, pridan index app
31.05.10 tt; createAuthLinks7xx: odstraneno doplneni hodnoty "XX" do pole autority C06y 
17.05.10 tt; getSymbX: pocitaji a vypisuji se vsechny oddeleni
05.05.10 tt; getSymbX: pridan symbolik pro vypis domacich autoru @AUTDOMVYP
03.05.10 tt; getSymbX: pridany symboliky pro vypis autoru AUTDOMPOC a AUTPOC
20.04.10 tt; getSymbX: pridany symboliky pro vypis oddeleni v zaznamu "@ODDEL", "@ODDELPOC", "@ODDELV"
19.03.10 pb; zmena roku zberu 2010->2011
27.01.10 tt; userIsAdmin: pridany uzivatelky
27.01.10 tt; ixIndexValuesEx: pridana hodnota vazby z autorit (variantni nazev) - aupra
26.01.10 tt; getSymbX - @PRACALL: Zalozen symbolik pro vystupy epca
07.12.09 tt; symSetPracAuth: zalozena metoda
20.11.09 pb; getRIVlink: uprava verzie: resultExerciseCode=U na resultExerciseCode= 
09.09.09 jk; zrusen url parametr &resultLanguage=all
27.07.09 jk; upgrade ARL1, metoda fmtCsBURL() presunuta do images.cls
25.06.09 pb; exportCSVSoupis: pocet opakovani 971 zistit cyklom, pri n-100 opakovaniach padalo
16.06.09 rs; zmena roku zberu 2009->2010 u kontroly na zmeny poli
             v zaznamoch pre export do RIV
10.06.09 pb; zmena roku zberu 2009->2010
13.03.09 rs; pre generovane autority s vyplnenym pracoviskom nastavit 969f=ACTV
17.02.09 rs; doplneny 2x odkaz na wiki (do komentarov)
13.01.08 rs; doplnenie initu este do getBibcitCAV()
13.01.09 jk; neplni se psOptions, metoda se vola i mimo IPAC2 (v IPAC1),
             kde neexistuje prostredi IPAC2
12.01.09 jk; inicializace a uklid options pro kratky ZF
15.08.08 pb; allowSaveExRZ: uprava pre rok zberu iny ako 2009
05.08.08 tt; ixIndexValuesEx:vyjimka indexu "grag" pro zaznamy, ktere nemaji C13
23.07.08 rs; upravy v indexoch tias*; doplnenie podvarianty indexu "x"
23.07.08 rs; upravy v indexoch tias*; zrusenie umeleho skratenia indexu tias2
10.06.08 rs; zmena roku sberu 2008->2009
21.05.08 tt; provedena zmena vyjimky vz pro index grag
02.04.08 rs; zapnuta kontrola ISSN (ale nie ISBN) pri zapise (modifikator: checkISBN-1)
13.03.08 rs; upresnena kontrola na prazdne ISSN (ak zacina na "n/N",
             berie sa ako neuvedene)
04.03.08 rs; prepracovanie sposobu generovania odkazu na DOI resolver
28.02.08 rs; odstranenie formatovania pre vybrane symboliky
22.02.08 rs; pridanych niekolko dalsich symbolikov
21.02.08 rs; symbolik @PRAC: prerobene na getSymbXMV()
13.02.08 rs; pridany symbolik @PRAC
13.02.08 rs; uprava programu do export do CSV (multivalues)
             symbolik @DKREP1
29.01.08 rs; uprava algoritmu pre index oddp - prefix pracoviska sa pridava vzdy
11.01.08 rs; prva verzia pokusneho univerzalneho exportu do CSV,XLS
11.01.08 rs; program na prenos oddelenia - prva prac.verzia
20.12.07 rs; CSV supiska: doplnenie pola ISBN_ISSN
20.12.07 rs; getRIVLink: uprava titulku URL (teraz obsahuje aj kod zaznamu v RIV - informativne)
13.12.07 rs; user admin: pridane chmelarova#munziova
13.12.07 rs; pridane specialne podmienky pre rok zberu 2007 pre allowSave
             modifikacia niektorych poli je pre RZ=2007 && RIV povolena len adminovi
             +blokacia vymazu zaznamu
...
--- </pre>

Publikacna cinnost CAV]]></Description>
<ClassType>persistent</ClassType>
<IncludeCode>Common,I2</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>User.DataTable</Super>
<TimeChanged>66879,34632.759735958</TimeChanged>
<TimeCreated>59575,83515.670797</TimeCreated>

<Parameter name="INDEXPARAMS">
<Description>
02.04.08 rs; zapnuta kontrola ISSN (ale nie ISBN) pri zapise (modifikator: checkISBN-1)
13.12.07 rs; pridanie allowDeleteExX 
21.03.07 rs; pridanie symCleanUp (extension pre cistenie autorit)
09.02.07 rs; odstranenie modifikatora Clean4xx200Cat
17.02.06 rs; postSaveEx metoda na delayes index update (hlavne) pre zdrojove dokumenty
---</Description>
<Default>C</Default>
</Parameter>

<Parameter name="cAktRokZberu">
<Description><![CDATA[
Parameter INDEXPARAMS = "C,allowSaveEx#allowDeleteExX#getDATAEx#ixIndexValuesEx#EPC_IF_CAV#postSaveEx#Zahr-CZ#symCleanUp#checkISBN-N-1";
tu je aktualny rok zberu pre nove zaznamy. Meni sa 1x rocne
system nepovoli zalozit zaznam s inym rokom zberu, ako je tu uvedeny

POZOR pri zmene preverit aj obsah metody allowSaveExRZ()
moze obsahovat dalsie podmienky na roky, ktore s touto konstantou mozu 
tieto podmienky sa obcas menia a nie vzdy v priamej suvislosti s
hodnotou cAktRokZberu
SUVISIET !!! (16.06.09 rs)
---

16.03.23 tt; zmena roku zberu 2023->2024
20.03.22 tt; zmena roku zberu 2022->2023
15.03.21 tt; zmena roku zberu 2021->2022
08.04.20 tt; zmena roku zberu 2020->2021
25.03.19 tt; zmena roku zberu 2019->2020
20.03.18 tt; zmena roku zberu 2018->2019
21.03.17 tt; zmena roku zberu 2017->2018
20.03.16 tt; zmena roku zberu 2016->2017
22.03.15 tt; zmena roku zberu 2015->2016
16.03.14 tt; zmena roku zberu 2014->2015
21.03.13 tt; zmena roku zberu 2013->2014
15.03.12 tt; zmena roku zberu 2012->2013
15.03.11 tt; zmena roku zberu 2011->2012
19.03.10 pb; zmena roku sberu 2010->2011
10.06.09 pb; zmena roku zberu 2009->2010
10.06.08 rs; zmena roku zberu 2008->2009
12.06.07 lp; zmena roku sberu 2007->2008
23.01.07 rs; zmena z define na parameter]]></Description>
<Default>2024</Default>
</Parameter>

<Method name="classNameX">
<Description>
return current class unlike %ClassName this is a class method</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[ quit "CavUnEpca"
]]></Implementation>
</Method>

<Method name="userIsAdmin">
<Description>
Meno aktualne prihlaseneho uzivatela. funguje v pripade, ze bezime v ramci
WS sluzby. V opackom pripade vrati ""

Toto je zasah do systemu security - nieco ako "na kolene" zbuchane
rozsirenie security. sice je to natvrdo ale je ale pomerne jednoduche 
a splnuje ucel. Z terminalu je mozne obist preskocenim allowSave

22.01.18 tt; provedena dalsi uprava identifikace superuzivatele
06.11.17 tt; pridana uzivatelka janderova
11.05.16 tt; pridana kontrola na superuzivatele userIsAdmin 
27.01.16 tt; kvuli vystupum predelana funkcnost - pridan publicList s sUser
18.03.15 tt; pridana uzivatelka podloucka
26.04.11 tt; pridany uzivatelky
27.01.10 tt; pridany uzivatelky
13.12.07 rs; oddlenie do funkcie pre pouzitie na viacerych miestach
07.06.06 rs
--</Description>
<ClassMethod>1</ClassMethod>
<PublicList>sUser</PublicList>
<Implementation><![CDATA[
  ; pozor v pripade ze uzivatela nejde zistit - treba vratit 0 
  ; teda pesimisticky pristup
  ; 11.08.20 tt; pridano defaultni nastaveni bUserIsAdmin
  s bUserIsAdmin=0
  
  s sUser1=##class(i2.ws).getUserName()
  if (sUser1="") 
  { ; 27.01.16 tt; kvuli vystupum predelana funkcnost - pridan publicList s sUser
    s:($g(sUser)'="") sUser1=sUser
  }
  
  ; 19.03.21 tt; pridan uzivatel sykora do adminu cav  
  ; 13.12.07 rs; pridane chmelarova#munziova
  s bUserIsAdmin=$f("#arl#dolezelova#chmelarova#bartkova#durecova#janderova#sykora#","#"_sUser1_"#")>0
  
  if ##class(i2.ws.auth).getLoginLoggedIn() 
  { ; 11.05.16 tt; pridana kontrola na superuzivatele userIsAdmin 
    s sUserCat=##class(i2.ws.auth).getLoginCateg()
    s:(sUserCat="2") bUserIsAdmin=1
    
    ; 22.01.18 tt; provedena dalsi uprava identifikace superuzivatele
    s user=##class(i2.access).getLoginId()       ; ziskame id uzivatele
    if (##class(MARC).readX(.handleU,"CavIsUser",user)) 
    { ; provedena dalsi uroven overeni uzivatele 
      s sU100=$$$getTagX(.handleU,"100")               ; pole 100
      s sU100k=$$$getSubTagStr(sU100,"k")              ; anonymni uzivatel
      s:(sU100k="2") bUserIsAdmin=1
    }  
  } 
  
  q bUserIsAdmin
]]></Implementation>
</Method>

<Method name="userIsSpecZprac">
<Description>
Metoda pro MyAsep a indexovani, aby se pridelovali specialnim zpracovatelum vytvorene zaznamy spravne do 
konta. Anonymvni uzivatele maji specialne urceno, komu a co indexovat.

15.11.22 tt; zakomentovani uzivatel UEF-S 0000008 .... 
09.12.16 tt; Zalozena metoda
--</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pUserID,pUstav</FormalSpec>
<Implementation><![CDATA[
  s bIsSpecZprac=0

  if ((pUstav="UJCA")||(pUstav="UJC-A")||
      //(pUserID="0000008")||(pUserID="0000209")||(pUserID="0000208")||
      (pUserID="0000054")||(pUserID="0000043")||
      (pUserID="0000022")||(pUserID="0000015")||(pUserID="0000007")||
      (pUserID="0000049")||(pUserID="0000149")|| (pUserID="0000212")||
      (pUserID="0000014")||(pUserID="0000114")||(pUserID="0000042")||
      (pUserID="0000026")||(pUserID="0000041")||(pUserID="0000141"))
   { ; 04.02.16 tt; vyjimka pro zpracovatele, kteri maji mit v MyAsep link jen na sve zaznamy za aktualni rok zberu
     s bIsSpecZprac=1
   }   
   
  q bIsSpecZprac
]]></Implementation>
</Method>

<Method name="allowSaveEx">
<Description><![CDATA[
<pre>Kontroly pred ulozenim zaznamu; ochrana zaznamu pred prepisanim v niektorych 
specialnych pripadoch.
Navrat:
 pri chybe "|ERR..." jinak prazdne nebo nejake info (INF, WARN, text)

13.04.20 tt; doplnena metoda na nahtazeni _ a ; u oddeleni 7XXi podle oddeleni 7XXp - validace podle číselníku EPCA_ODDEL_...
25.10.17 tt; provedena uprava strany od do, pokud jsou jen ve v
05.12.16 tt; opraveni 969 pokud je neco spatne
18.02.14 tt; pridana vyjimka, aby se nekontrolovaly duplicity u BXXS
06.02.12 tt; dalsi uprava logiky generovani handle linku
18.01.13 tt; pridana funkcnost u kopirovanych zaznamu, aby se vytvoril handle
17.01.13 tt; osetreni novych zaznamu proti zkopirovani handle linku
07.12.12 jk; handle.net
23.11.11 tt; pridana zmena stavu souboru u content serveru pri vystaveni zaznamu v ipacu
             je potreba zmeni stav souboru - repozitar cav
13.07.11 tt; uprava podminek pro generovani noveho zaznamu
12.07.11 tt; odmazeni pole C26$b, pokud byl zaznam odmazan z RIVu + dalsi podpurne zmeny
             pro tuto funkcnost  
13.12.07 rs; pridane volanie userIsAdmin()
04.12.07 rs; jednoducha poistka na obsah C13 - pripustne je len $a a nesmie byt opakovane
09.03.07 rs; zapojenie allowSave kontroly na duplicity zahlavia pre zborniky a casopisy
10.02.07 mk; pri allowsave kontrola 70*py ak je p vymaze sa y
07.06.06 rs; doplnenie kontroly na modifikaciu roku zberu; zmena je povolena
             len pre uzivatela "dolezelova" a "arl" - toto ciastocne supluje 
             chybajuci jemnejsi system pristupovych prav
10.03.06 lp; do 999b ulozit pracovni skupinu toho, kdo zaznam vytvoril
08.09.05 lp; metoda aktivovana kvuli automatickemu generovani autorit
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 s ret=""
  
 s sT001=$$$HandleT001(handle)       ; ziskani t001
 s sClass=$$$HandleClass(handle)     ; ziskani tridy
 
 s s970b=$$$getTagX(.handle,"970b")
 /* 11.12.17 tt; zakomentovano docasne if (s970b'="BXXS")
 { ; 18.02.14 tt; pridana vyjimka, aby se nekontrolovaly duplicity u BXXS tedy sborniku
   ; kontrola na duplicitu zahlavia (pre zborniky a casopisy); 09.03.07 rs;
   s sXD1=..getDupCheckKey(.handle)
   s:sXD1'="" ret=##class(SPIntegrit).allowSaveCheckDups(.handle,"xd1",sXD1)
   q:ret'="" ret
 }  */
 
 ; 05.12.16 tt; opraveni 969 pokud je neco spatne
 s s696=##class(MARC).getTagX(.handle,"969")
 if ((s696'="")&&($f(s696,"N")))
 {  d ##class(MARC).setTagX(.handle,"969    "_$c(31)_"fN")  }    
  
 ; 10.03.06 lp; do 999b ulozit pracovni skupinu toho, kdo zaznam vytvoril
 s sWGrp=$tr(##class(MARC).getTagX(.handle,"C26e"),"-")
 if (sWGrp'="")
 {
    s t999=##class(MARC).getTagX(.handle,"999")
    if t999="" s t999="999    "_$c(31)_"a1"
    s t999=##class(MARC).setSubTagStr(t999,$c(31)_"b"_sWGrp)
    d ##class(MARC).setTagX(.handle,t999)
 }
 
 ; 0/1 ci aktualne prihlaseny uzivatel je admin
 ; pozor funguje len pre niektore pripady viz description volanej metody
 ; 13.12.07 rs
 s bUserIsAdmin=..userIsAdmin() 
 
 if ##class(MARC).readX(.handlee,$$$HandleClass(handle),$$$HandleT001(handle))
 { ; 17.11.18 tt; kontrola na zmenu export do riv - u starsich zaznamu se aktualne zmeni rok zberu
   s bExportRIVX=+##class(MARC).getTagX(.handlee,"C26b")
   s sC26bX=+$$$getTagX(.handle,"C26b")
      
   if (('bExportRIVX)&&sC26bX)
   { ; pokud zaznam splni podminky, zmenit C26
     s sC26fullX=$$$getTagX(.handle,"C26")
     s sC26fullX=$$$setSubTagStr(sC26fullX,$c(31)_"d"_..#cAktRokZberu)
     d $$$setTagX(.handle,sC26fullX)
   }
   
   s sPomOldC99=$$$getTagX(.handlee,"C99")
   s sPomOldC99d=$$$getTagX(.handlee,"C99d")
   s sPomNewC99=$$$getTagX(.handle,"C99")

   if (sPomOldC99d="DFLTI_EPCA_CZ_WOSSCOPUS")&&(sPomNewC99="")
   { ; 18.03.22 tt; provedena zmena, aby prebiraci formular zustal i pri editaci pres klienta
     d $$$setTagX(.handle,sPomOldC99)
     
     if ##class(i2.ws.auth).getLoginLoggedIn() 
     { ; 24.10.22 tt; pridano pridani uzivatele do zaznamu prebranych z wosu
       s user=##class(i2.access).getLoginId()       ; ziskame id uzivatele      
     }  
   }
   if (sPomOldC99d="DFLTI_EPCA_CZ_WOSSCOPUS")
   { ; 24.10.22 tt; pridano pridani uzivatele do zaznamu prebranych z wosu
     s user=##class(i2.access).getLoginId()       ; ziskame id uzivatele
       
     s sT999=$$$getTagX(.handle,"999") 
     if ((sT999'="") && (user'=""))
     { ; 09.11.22 tt; opraveno generování kódu do 999e
       s sT999e=$$$getSubTagStr(sT999,"e")
       if (sT999e="")
       { ; pridame ziskaneho uzivatele
         d $$$setTagX(.handle,(sT999_$c(31)_"ecav_is_user*"_user))
       }
     }          
   }  
     
 }
 
 if ($$$getTagX(.handle,"C26d")="%ROK_VYKAZOVANI%")
 { ; 15.03.21 tt; pridana promenna, aby se pokazde nemusel přepisovat v klientu rok vykazovani
   s sC26fullX=$$$getTagX(.handle,"C26")
   s sC26fullX=$$$setSubTagStr(sC26fullX,$c(31)_"d"_..#cAktRokZberu)
   d $$$setTagX(.handle,sC26fullX)
 } 
  
 ; kontrolu na rok zberu volame len ak user neni admin
 ; 13.12.07 rs; mimo roku zberu sa testuju dalsie podmienky 
 s:'bUserIsAdmin ret=..allowSaveExRZ(.handle)
 q:ret'="" ret
  
 
 s s463=$$$getTagX(.handle,"463")
 if (s463'="")
 { ; 25.10.17 tt; provedena uprava strany od do, pokud jsou jen ve v
   if ##class(MARC).t4xx2handle(.handle4xx,s463) 
   {
     s t463200v=$zstrip(##class(MARC).getTagX(.handle4xx,"200v"),"<>W")
     if ((t463200v?.N1"-".N)&&($tr(t463200v,"-,","")'=""))
     {
       s s463=$$$strswap(s463,$c(31)_"v"_t463200v,$c(31)_"v"_"S. "_t463200v)   
       d:($l(s463)>10) ##class(User.MARC).setTagX(.handle,s463)             
     }      
   }
 }
 
  ; 23.11.11 tt; pridana zmena stavu souboru u content serveru pri vystaveni zaznamu v ipacu
  ;              je potreba zmeni stav souboru
  s sT969fo=""
  s sT969f=$$$getTagX(.handle,"969f")
  ; 15.11.16 tt; upravy
  s sTC99d=$$$getTagX(.handle,"C99d")
  if ((sTC99d="DFLTI_EPCA_CZ_WOSSCOPUS")&&(sT969f=""))
  {
    s ret="|ERRUSR_CAV03#969$$f. Přebírací formulář nelze odeslat do IPACu"
  }
  
  if ((sTC99d="DFLT_DATA")&&(sT969f="")&&($$$getTagX(.handlee,"969f")'=""))
  { /// 01.12.22 tt; pridana funcnost vytvoreni kopie datasetu 
   s sU03=$$$getTagX(.handle,"U03")
   if (sU03'="")
   {
     s U03a=""
     if ($$$getSubTagStr(sU03,"a")="")
     {
       s sLastRozpr=##class(User.CavUnEpca).versionDataGetLastVersion(.handle,1)            
       s sLast=##class(User.CavUnEpca).versionDataGetLastVersion(.handle)
       if $f(sLastRozpr,sT001)
       { ; jsme v rozpracovane verzi
         if (sLast="")
         { ; nemame zadnou rozpracovanou verzi, zacneme cislovat od 002
           s U03a="002"         
         }
         elseif ($p(sLast,"#",1)'="")
         {
           s U03a=$tr($j(($p(sLast,"#",1)+1),3)," ","0")
         }
         else
         { ; nedefinovany stav
           s ret="|ERRUSR_CAV04#U03$$a. Chyba při přidělování verze datasetu."
         }
       }
       else
       { ; mame zrejme rozpracovanou jeste nejakou jinou verzi
         s ret="|ERRUSR_CAV04#U03$$a. Chyba při přidělování verze datasetu (souběh rozpracovaných verzí)."
       }
       if (U03a'="")     
       {
         s sU03=$$$setSubTagStr(sU03,$c(31)_"a"_U03a)
         d $$$setTagX(.handle,sU03)
       }
     }
   }
  }
    
  q:ret'="" ret
  
  s sDataVkladatel999e=""
  if (sT001'="new")
  { ; odeslání záznamu - 969f - "D" - neodeslán/ "" nebo "A" odeslaný záznam zveřejněný v ipac2 
    if ##class(User.MARC).readX(.handleUS,sClass,sT001)
    { ; pokud se podari otevrit puvodni handle, muzeme zmenit stav
      s sT969fo=$$$getTagX(.handleUS,"969f")
      if ((($zcvt(sT969fo,"U")="D")||($zcvt(sT969fo,"U")="N"))&&($zcvt(sT969f,"U")'="D")&&($zcvt(sT969f,"U")'="N"))
      { 
        ; inicializace ictx, pokud je volano z ipac1
        s:'$d(%ipac2("ictx")) %ipac2("ictx")=$zcvt(##class(User.Util).getClassPrefixParam(sClass),"L")
        
        ; pokud mame zverejneny zaznam , zmenime stavy
        ; vyselektuji soubory, ktere maji status 1 (neodeslane v ipacu)        
        d ##class(content.api).selectRecStatus(.output,sClass,sT001,"1")
        s item=""        ; pomocna promenna                
        f { s item=$o(output(item)) q:item=""
          s repo=output(item,"repository")    ; repozitar 
          s key=output(item,"key")            ; klic souboru
          d ##class(content.api).getBatch(.array,repo,key)  ; ziskani metadat souboru
          s array("status")="2"                        ; prepsani statusu
          ; 26.09.12 tt; pridani zapsani zmeny stavu do statistik
          d ##class(content.stat).addStatus(.array,1)
      
          d ##class(content.api).update(.array)        ; ulozeni metadat zpet do content serveru   
        }      
      }
      
      ; 09.09.15 tt; pridany upravy pri odevzdani do ipacu z novych formularu
      ; https://cosmo2/wiki/index.php/CAV:Formul%C3%A1%C5%99e_I3_dokumentace
      ; 20.11.15 tt; melo by projit generovanim vzdy U poli vzdy, kvuli editaci moznych starsich zaznamu
      ;if (($zcvt(sT969fo,"U")="N")||($zcvt(sT969f,"U")="N"))
      ;{ ; nektere smeny provadime vzdy a nektere jen pri vystaveni do ipacu, ale to uvidime v metode
        d ..allowSaveExFormN(.handle,.handleUS, sT969f,sT969fo)
      ;}    
    }
  }
  else
  { 
    ; 15.09.16 tt; vymazani C52 u novych zaznamu
    d ##class(User.MARC).delTagX(.handle,"C52")
    ; 01.04.20 tt; nove zeznamy namaji mit C64 - kopie zaznamu
    d ##class(User.MARC).delTagX(.handle,"C64")
    
    ; 09.09.15 tt; pridany upravy pri odevzdani do ipacu z novych formularu
    ; https://cosmo2/wiki/index.php/CAV:Formul%C3%A1%C5%99e_I3_dokumentace
    ; 20.11.15 tt; melo by projit generovanim vzdy U poli vzdy, kvuli editaci moznych starsich zaznamu
    ;if (($zcvt(sT969fo,"U")="N")||($zcvt(sT969f,"U")="N"))
    ;{ ; nektere smeny provadime vzdy a nektere jen pri vystaveni do ipacu, ale to uvidime v metode
      d ..allowSaveExFormN(.handle,.sT969fo, sT969f,sT969fo)
    ;}
  }
  
  if ($$$getTagX(.handle,"U95a")="1")
  { ; 13.03.17 tt; zapojena zmena stavu fulltextu na stav 4 - vystaven
    d ##class(i2.cust.cav.service).approveAllFiles(.handle)    
  }
  
  s sRZA=##class(MARC).getTagX(.handle,"C26d")
  /// 11.11.16 tt; pridana volba u zobrazeni velkych dat
  ;  - negenerovat linku u autorit, pokud se jedna o zaznam v prebiracim formulari
  if (sTC99d="DFLTI_EPCA_CZ_WOSSCOPUS") 
  {
   s sRZA="2000"
   ; 14.01.22 tt; osetreni na nechani jen jednoho C99 - u prebiraciho formulare
   s sTC99=$$$getTagX(.handle,"C99") 
   if (sTC99'="") 
   {
     d ##class(User.MARC).delTagX(.handle,"C99")
     d $$$setTagX(.handle,sTC99)
   }
   
   s sTU98=$$$getTagX(.handle,"U98") 
   if (sTU98'="") 
   { ; 31.10.22 tt; osetreni prebiraciho pole U98 pro prebrane zeznamy z wos
     d ##class(User.MARC).delTagX(.handle,"U98")
     d $$$setTagX(.handle,sTU98)
   }
  }
  ; prejst vybrane polia, ktore maju obsahovat $3/pripadne 4xx/001 
  ; a doplnit linky pripadne dogenerovat autority/zdrojove dokumenty
  ; 
  ; 12.01.07 rs; generovanie linkov volat len pre zaznamy aktualneho zberu 
  ;              (presnejsie zaznamy, kde je vyplneny rok zberu - max 5-10% zaznamov
  ;              tymto sa usetri kopu operacii a potencionalnych problemov u starsich
  ;              zaznamov)
  ; 23.01.07 rs; generovat len ked je rok zberu aktualny - povodne podmienka defacto
  ;              nefungovala :(              
  s:sRZA=..#cAktRokZberu ret=..createAuthLinks(.handle) 
  if ret'="" {
    if $f(ret,1,4)'="|ERR" { s ret="|ERR999#"_ret }
    q ret
  }
  
  ;;;;;;;;;
  ; 08.11.11 mk vytvaranie automatickeho spojenia C123 na autoritu projektu
  s tC12all=##class(MARC).getTagX(.handle,"C12",-1) ; vsetky opakovania tagu 
  s pocetC12=$l(tC12all,$c(10))
  s tC12allnew=""
  f k=1:1:pocetC12
  {
    s tC12s=$p(tC12all,$c(10),k),ta1="",nProjAuthID=""
    s ta=$e(##class(MARC).getSubTagStr(tC12s,"a"),1,100)
    s t3=##class(MARC).getSubTagStr(tC12s,"3")
    if ((t3="") && (ta'="")) ; ak neexistuje link tak ho doplnit
    {
      s nProjAuthID=$o(^ooDataTableI("CavUnAuth","proj"," "_$zcvt(ta,"L"),""))  
      if nProjAuthID=""
      {
        s ta1=$e(ta,1,80) 
        s ta1=##class(User.Util).strswap(ta1," ","")
        s nProjAuthID=$o(^ooDataTableI("CavUnAuth","proj"," "_$zcvt(ta1,"L"),"")) 
      }
      
      if (nProjAuthID'="")
      { 
        s nProjAuthT001=##class(MARC).getT001(nProjAuthID)
        ; pridat do prislusneho opakovania tagu C12 podpole 3
        if nProjAuthT001'="" s tC12s=tC12s_$c(31)_"3cav_un_auth*"_nProjAuthT001
      }    
    }    
    if tC12allnew'="" s tC12allnew=tC12allnew_$c(10)_tC12s
    if tC12allnew="" s tC12allnew=tC12s
  }
  if (tC12all'=tC12allnew) && (tC12allnew'="") d ##class(MARC).setTagX(.handle,tC12allnew)
  
  ;;;;;;;;;;;;;;;;;;;;  
  ; 10.01.07 mk; kontrola 70*py nesmu sa vyskytnut oba subtagy ak je p tak sa y vymaze
  s t7xx="700,701,702"
  ; 12.07.11 tt; nastavena promenna pro spolupraci a poskytovatele
  s sPomSpol="",nPomSpol=0,sPomPoskyt="",nPomPoskyt=0
  f i=1:1:3  
  {
     s tag=$p(t7xx,",",i)
     s t7xxallnew=""
     s t7xxall=##class(MARC).getTagX(.handle,tag,-1) ; vsetky opakovania tagu 
     s pocet=$l(t7xxall,$c(10))
     f j=1:1:pocet
     {
       s t7xxs=$p(t7xxall,$c(10),j)  
       s ty=##class(MARC).getSubTagStr(t7xxs,"y")
       s tp=##class(MARC).getSubTagStr(t7xxs,"p")
       s ti=##class(MARC).getSubTagStr(t7xxs,"i")
       
       ; 12.07.11 tt; pridano nacitani vsech pracovist do seznamu
       if ('($f(","_sPomSpol_",",","_tp_","))) 
       { ; ukladame si ustavy
         s sPomSpol=sPomSpol_","_tp_","  ; ulozime si do seznamu
         s nPomSpol=nPomSpol+1           ; zvysime pocitadlo
       }
       // 11.06.16 tt; docasne vypnuto odmazavani 70*y pokud je 70*p 
       //if (tp'="") && (ty'="") s t7xxs=##class(User.Util).strswap(t7xxs,$c(31)_"y"_ty,"") 
       
       ; 13.04.20 tt; doplnena metoda na nahtazeni _ a ; u oddeleni 7XXi podle oddeleni 7XXp - validace podle číselníku EPCA_ODDEL_...
       if ((ti'="")&&(tp'=""))
       { ; vyplnene data mame 
         if ##class(User.MARC).readX(.handleXXO,"CavUnTablesd","EPCA_ODDEL_"_tp)
         { ; v ciselniku jsou data s oddelovaci, takze pro jistotu musime udelat nahrazeni
           /// 14.04.20 tt; zakomentovany validace oddeleni - zpusobovalo problemy - odblokuje v pristim tydnu
           /*s sbTest7XXi=##class(User.Util).sXlate("EPCA_ODDEL_"_tp,$tr(ti,", ",";_"),"N","Cav","b")
           if (sbTest7XXi="")
           { ; pokud nemame preklat v existujicim ciselniku, vypiseme chybu
             s ret=ret_"|ERR999#allowSaveEx - V záznamu CavUnEpca*"_$$$HandleT001(handle)_" neví vyplněno oddělení 70X$i podle pracoviště 70X$p! Číselník:"_"EPCA_ODDEL_"_tp_"."            
           }*/
         }
         s t7xxs=$$$setSubTagStr(t7xxs,$c(31)_"i"_$tr(ti,";_",", "))
       }   
       
       if t7xxallnew'="" s t7xxallnew=t7xxallnew_$c(10)_t7xxs
       if t7xxallnew="" s t7xxallnew=t7xxs
     }  
     if t7xxall'=t7xxallnew d ##class(MARC).setTagX(.handle,t7xxallnew)
  }
  
  ; EXPERIMENTALNE !! cistenie "autorit" na aktualnom zazname
  ; 24.01.07 rs
  ; 20.01.17 tt; experimentalne naplnim data U63 a U70 - aby me cisteni nemenilo pod rukama 463 a zf 
  ;              vznikaly tim rozdily mezi 463 a U70
  s s463predclean=$$$getTagX(.handle,"463")
  s s470predclean=$$$getTagX(.handle,"470")
  d ##class(SPCommon).symCatCleanUp(.handle)
  s s463=$$$getTagX(.handle,"463")
  s s470=$$$getTagX(.handle,"470")
  if (s463'="")
  { ; 24.11.15 tt; oprava, aby se nedotahovali Uxx pole do 4xx zaznamu
    if ##class(MARC).t4xx2handle(.handle4,s463) 
    {
      d ##class(User.MARC).delTagX(.handle4,"U**")
      s s463=##class(MARC).handle2t4xx(.handle4,$e(s463,1,3)_$e(s463,5,6)) 
      d:($l(s463)>10) ##class(User.MARC).setTagX(.handle,s463)
    }
     if (s463'=s463predclean) 
     {
       d ##class(User.MARC).delTagX(.handle,"U63")
       d ##class(User.MARC).delTagX(.handle,"U67")
       d ..allowSaveExFormNU63(.handle,s463)
     }
  }
  /*if (s470'="")
  { 470 nema linky, necisti se
    if (s470'=s470predclean) 
    {
      d ..allowSaveExFormNU70(.handle,s470)
    }
  }*/
  
  ///////////////////////////////////////
  /*
      d ..allowSaveExFormNU63(.handle,lsLine)
      } 
      if ((sTag="470")&&(pD("CH","470")||(pD("N","U70")="")||(pD("N","U77")="")))
      { ; a používa aj pri 470 (s pomocným poľom U70 a U77)
        d ..allowSaveExFormNU70(.handle,lsLine)    
  */
  /////////////////////////
  
  ; 04.12.07 rs; jednoducha poistka na obsah C13 - pripustne je len $a
  ;              a nesmie byt v ramci daneho opakovania tagu opakovane
  s sTC13=$$$getTagXC(.handle,"C13",-1)
  f i=1:1:$l(sTC13,$c(10))
  {
      s s1=$p(sTC13,$c(10),i)
      // s s1a=$$$getSubTagStr(.s1,"a")
      ; 27.01.16 tt; upravena podminka opakovatelnosti,aby fungovala spravne pro C13
      s s1a=$$$getSubTagStrC(.s1,"a",-1)
      if ($l(s1a,$c(10))>1) s ret="|ERR999#Neplatna struktura v C13 (pripustna podpole: $a neopakovatelne) - "_sT001
  }
  
  s c=0
  d { 
    s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
    continue:((sT014="")&&(c'=0))
    if (sT014'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      if (($$$getSubTagStr(sT014,"2")="")&&($$$getSubTagStr(sT014,"a")'=""))
      {
        s ret="|ERR999#Zaznam "_sT001_" nelze ulozit. Neni vyplnena hodnota tagu 014$2!"
      }
    }
   } while (c'=0)  
  
  ; 12.07.11 tt; pridana logika pro napocitavani poskytovatelu
  if (sTC13'="") 
  { ; pokud neni prazdna C13, dame poskytovatele AV
    s sPomPoskyt=",GA AV ČR,"   ; pridame poskytovatele av
    s nPomPoskyt=nPomPoskyt+1   ; zvysime pocitadlo spokytovatelu
  }
  s c=0
  d { ; cyklus pres vsechny poskytovatele
    s sTC12=$$$getTagXC(.handle,"C12",.c) ; vsetky citacie
    continue:((sTC12="")&&(c'=0))
    s sTC12b=$$$getSubTagStr(sTC12,"b")
    ; pokud jiz nemame ulozeneho poskytovatele, ulozime do seznamu
    ; potrebujeme je pro logiku odmazani C26$b
    if ('($f(","_sPomPoskyt_",",","_sTC12b_","))) 
    { ; pokud nemame poskytovatele v seznamu, ulozime
      s sPomPoskyt=sPomPoskyt_","_sTC12b_","   ; pridame do seznamu poskytovatele
      s nPomPoskyt=nPomPoskyt+1                ; zvyseme pocitadlo poskytovatelu
    }
  } while (c'=0)
  
  ; 12.07.11 tt; zalozena kontrola na C51$e, $f a zmeneno C26$b na prazdnou hodnotu
  s c=0,nOp=0,bVymaz=1 ; inicializace promenne
  d { ; cyklus pres vsechny opakovani C51
    q:(bVymaz=0)                          ; podminak pro vymaz nesplnena
    s sTC51=$$$getTagXC(.handle,"C51",.c) ; pres vsechny opakovani tagu C51
    continue:((sTC51="")&&(c'=0))         ; preskocim, pokud nemam data
    if (sTC51'="")
    {
      s nOp=nOp+1                           ; pocitame si opakovani
      ; kontrola odstraneni z RIVu - 1 - odstraneno
      s sTC51f=$zcvt($$$getSubTagStr(sTC51,"f"),"L")    
      ; ziskame priznak odstraneni - V - vymaz z RIVu
      s sTC51e=$zcvt($$$getSubTagStr(sTC51,"e"),"L") 
      if ('((sTC51f=1)&&(sTC51e="v")))
      { ; nastavime priznak vymazu na 0
        s bVymaz=0  
      }
    }
  } while (c'=0) 
  
  ; 13.07.11 tt; uprava podminek pro generovani noveho zaznamu
  ; 12.07.11 tt; odmazeni pole C26$b, pokud byl zaznam odmazan z RIVu + dalsi podpurne zmeny
  ;              pro tuto funkcnost
  ; - pokud je nejake C13, automaticky se doda do C12 AV CR jako poskytovatel
  ; - spocitaji se vsechny C12b a pocet spolupraci v 70xp - pokud pocet C51= pocet C12b krat€
  ;   pocet 70xp, se projdou vsechny C51 jestli maji vyplnene (C51f=1)a (C51e="v")
  ; - pokud ano a pokud jejich soucet je stejny jako pocet C12b * ustavu, odmaze se pole C26b
  if ((bVymaz=1)&&(nOp>=(nPomPoskyt*nPomSpol))&&(nOp>0))
  { ; pokud maji vsechny C51f=1 a C51e=v a je dost opakovani C51, automaticky
    ; se prenastavi hodnota C26b (odmaze se subtag), ktery udava, ze se exportuje 
    ; do RIVu
    s sTC26=$$$getTagXC(.handle,"C26",-1) ; nacteme si vsechny opakovani C26
    s sTC26New=""
    f i=1:1:$l(sTC26,$c(10))
    { ; posutpne prochazime a odmazavame b
      s sTC261=$p(sTC26,$c(10),i)
      continue:(sTC26="")
      s sTC261=$$$setSubTagStr(sTC261,$c(31)_"b")   ; vymaz subtagu
      if ($l(sTC261)>9)
      { ; pokud jsme nemeli jen b, ulozime si subtag zpet
        s:(sTC26New'="") sTC26New=sTC26New_$c(10)_sTC261
        s:(sTC26New="") sTC26New=sTC261   ; pri prvnim jen ulozime
      }
    }    
    ; ulozeni nove hodnoty do handlu
    d $$$setTagX(.handle,sTC26New)
  }
  
 
  ; 07.12.12 jk; handle.net
  ; metoda pro automaticke provazani se serverem handle.net (User.CavS)CreateHandleNet
  s sDruhDok=$zcvt($$$getTagX(.handle,"970b"),"U")
  s s969f=$$$getTagX(.handle,"969f")
  if (sT001="new")
  { ; 17.01.13 tt; osetreni novych zaznamu proti zkopirovani handle linku
    d ##class(User.MARC).delTagX(.handle,"C60")
  }
  ; 06.02.12 tt; dalsi uprava logiky generovani handle linku
  if ((sDruhDok'="BXX") && (sDruhDok'="BXXS") && (sDruhDok'="BCA") && (sT001'="new"))
  { ; nebudeme kontrolovat u novych zaznamu a u soubornych zaznamu periodik
    s sC60=$$$getTagX(.handle,"C60")
    if (($zcvt(s969f,"U")'="D") && ($zcvt(s969f,"U")'="N")&& (sC60="")) {
      d ##class(util.handleNet).addHandleNet(.handle,"11104",7,"create")
    }
    elseif (($zcvt(s969f,"U")'="D") && ($zcvt(s969f,"U")'="N")&& (sC60="") && (##class(User.CavUnEpca).isRestored(.handle)))
    { ; 19.09.22 tt; doplnena kontrola na vymazane zaznamy, aby se vzdy pregeneroval link - radeji 3* dozadu
      d ##class(util.handleNet).addHandleNet(.handle,"11104",7,"restored")
    }
  }
  
  ; 12.11.13 tt; pridano odescapovani 856 pri uklozeni zaznamu - problem s escapovanim z ipac1
  s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3)
    
    if (sTag="856")
    { 
      s lsLine=##class(util.ie.tools).htmlEntitUnescape(lsLine)
      d ##class(User.MARC).setLineX(.handle,i,lsLine) ; zapsani to radku
    }
  }
  
  if ((s970b="BXXS")||(s970b="BXX")||(s970b="BCA"))
  { ; 18.12.15 tt; oprava vkladani vlastnika kvuli starym formularum - zmena 999e na f BXXS,BXX,BCA
    s s999=##class(MARC).getTagX(.handle,"999")
    s s999e=$$$getSubTagStr(s999,"e") 
    s s999f=$$$getSubTagStr(s999,"f") 
    if ((s999f'="")&&(s999e'=""))
    { 
     s s999=$$$setSubTagStr(s999,$c(31)_"e") 
     d $$$setTagX(.handle,s999)
    }
    elseif ((s999f="")&&(s999e'=""))
    { 
      s s999=$$$setSubTagStr(s999,$c(31)_"e") 
      ; 22.07.16 tt; oprava vkladani 999e
      s s999=##class(MARC).setSubTagStr(s999,$c(31)_"f"_s999e,"999") 
      d $$$setTagX(.handle,s999)
    }
  }
  
  
  q ret
]]></Implementation>
</Method>

<Method name="isRestored">
<Description>
Medota na zjisteni, zda byl dany zaznam obnoven z chronologie
navratova hodnota je  0  - neni vracen
                 nebo 1  - je vracen z chronologie

https://cosmo2/wiki/index.php?title=Cust:CAV/handle_net#CavS.ModifyCavhandle
19.09.22 tt; zalozeno</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret=0,epcaID=""
  s sT001=$$$HandleT001(handle)     ; ziskani t001
  s sClass=$$$HandleClass(handle)   
  s s999d=$$$getTagX(.handle,"999d") 
  ; 19.09.22 tt; doplnena kontrola na vymazane zaznamy, aby se vzdy pregeneroval link - radeji 3* dozadu
  ; protoze obnoveny zaznam ma prazdou minichronologii, toto by melo pomoct jako podminka, aby se zaznam 
  ; neobnovoval stale dokola
  if ('$f(s999d,"#"))
  { ; pokud v zaznamy neni minichronologie a ma chronologii, je to adept na vraceneho
    for i=1:1:3
    { ; chyklus do chronologie, pro jednoduchost jen 3 kroky zpet
      s epcaID=$o(^ooDataTableI("CmChronology","src"," cav_un_epca*"_sT001,epcaID),-1)
      q:((epcaID="")||(ret=1))
    
      if ##class(User.MARC).getDATAX(.handlech,epcaID) 
      {  ; otevru si zaznam z chronologie a zjistim, zda ma priznak vymazaneho
         s:($$$getTagX(.handlech,"C97c")= "d") ret=1
      }
    }
  }    
  q ret
]]></Implementation>
</Method>

<Method name="allowSaveExFormN">
<Description><![CDATA[
<pre> Upravy handlu pri ulozeni zaznamu z I3 formularu

Dokumentace: https://cosmo2/wiki/index.php/CAV:Formul%C3%A1%C5%99e_I3_dokumentace/     

09.09.15 tt; pridany upravy pri odevzdani do ipacu z novych formularu
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&handleO,p969f="",p969fO=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s t970b=$$$getTagX(.handle,"970b")
  s sC99d=##class(MARC).getTagX(.handle,"C99d")
 
  ; 24.01.17 tt; odstraneni autoru, pokud nejsou v tagu jine udaje nez role ////////////
  s t7xx="700,701,702,U67,U77"
  f i=1:1:5  
  {
    s tag=$p(t7xx,",",i)
    s t7xxallnew=""
    s t7xxall=$$$getTagXC(.handle,tag,-1) ; vsetky opakovania tagu 
    s pocet=$l(t7xxall,$c(10))
    f j=1:1:pocet
    {
      s t7xxs=$p(t7xxall,$c(10),j)  
      s t7xxstest=t7xxs
      s:$f(t7xxstest,$c(31)_"4") t7xxstest=$$$setSubTagStr(t7xxstest,$c(31)_"4")
      continue:($l(t7xxstest)<9)
      if ((($zcvt(t970b,"U"))="BXXS")&&(tag="702")&&('$f(t7xxs,$c(31)_"4")))
      { ; pro BXXS vzdy to bude editor
        s t7xxs=$$$setSubTagStr(t7xxs,$c(31)_"4340")
      }      
      if ((..getTypZaznamuAkZbornik(.handle)'="")&&((tag="U67"))) 
      { ; vzdy sbrornik u techto dokumentu
        s:('$f(t7xxs,$c(31)_"4")) t7xxs=$$$setSubTagStr(t7xxs,$c(31)_"4340")
      }
      s:(t7xxallnew'="") t7xxallnew=t7xxallnew_$c(10)_t7xxs
      s:(t7xxallnew="") t7xxallnew=t7xxs
    }  
         
    if (t7xxall'=t7xxallnew)&&($l(t7xxallnew)>9) 
    {
      d ##class(MARC).setTagX(.handle,t7xxallnew)
    }
    elseif ($l(t7xxallnew)<9) 
    {
      d ##class(User.MARC).delTagX(.handle,tag) 
    }
  }
  
  /////////////////////////////////////////////////////////////////////////////////////
  /// zmeny pri kazdem ulozeni
  ; vlozime nove pole, ktere se mohou pravdepodobne pridat
  s sPT210="210    ",pD=""
  ; priznak, jestli je zaznam ulozen z formularu. Pole U99 je potreba vzdy odmazat. Ostatni Uxx pole je nutne nechat

  d ..allowSaveExFormNData(.handleO, .pD,"O")  ; nacteme si do pD nove data
  d ..allowSaveExFormNData(.handle, .pD,"N",1) ; nacteme si do pD stare data (predchozi ulozeni handlu)
   
  if (pD("N","U99a")=1)
  { ; pokud byl zaznam ulozen z I3 formulare, musime upravovat data :-(
    ; ale jen pri zmene :-)
    
    if ($$$getTagX(.handle,"U02")'="")
    { ; 18.12.19 tt; doplnena funkcnost pro zmenu formulare
      s sU02d=$$$getTagX(.handle,"U02d")
      s sU02Form=##class(User.Util).sXlate("EPCA_DRUH_DOKUMENTU",sU02d,"N","Cav","c")
      s sU02970b=##class(User.Util).sXlate("EPCA_DRUH_DOKUMENTU",sU02d,"N","Cav","d")
      if (sU02970b'="")
      { ; nastavime 970b, pokud mame hodnotu
        s sNew970=$$$getTagX(.handle,"970")                                  ; nacteme 970
        if (sNew970'="") { s sNew970=$$$setSubTagStr(sNew970,$c(31)_"b"_sU02970b) } ; vlozime novou hodnotu z ciselniku
        else { s sNew970="970    "_$c(31)_"b"_sU02970b } 
        d:(sNew970'="") ##class(User.MARC).setTagX(.handle,sNew970)          ; ulozime
      }  
      if (sU02Form'="")
      { ; nastavime 970b, pokud mame hodnotu
        s sNewC99=$$$getTagX(.handle,"C99")                                  ; nacteme C99
        if (sNewC99'="") { s sNewC99=$$$setSubTagStr(sNewC99,$c(31)_"d"_sU02Form) } ; vlozime novou hodnotu z ciselniku
        else { s sNewC99="C99    "_$c(31)_"d"_sU02Form } 
        d:(sNewC99'="") ##class(User.MARC).setTagX(.handle,sNewC99)          ; ulozime
      }      
    }
    
    if ($$$getTagX(.handle,"U98a")="0")
    { ; 15.09.16 tt; pridana podpora odmazani klicovych slov pri prebirani zaznamu
      ;              v prebiracim zaznamu z wos a scopus
      d ##class(User.MARC).delTagX(.handle,"610") 
    }
    if ($$$getTagX(.handle,"U98b")="0")
    { ; 31.10.16 tt; pridana podpora odmazani spolupracujici instituce pri prebirani zaznamu
      ;              v prebiracim zaznamu z wos a scopus
      d ##class(User.MARC).delTagX(.handle,"C63") 
    }
    ; 15.11.16 tt; pridano odmazani priznaku odmazavani
    d ##class(User.MARC).delTagX(.handle,"U98") 
    
    if ($$$getTagX(.handle,"970")="")
    { ; 02.10.16 tt; reseni problemu s 970b pri prebirani zaznamu
      s sPomC99d=$$$getTagX(.handle,"C99d")
      if (sPomC99d'="DFLTI_EPCA_CZ_WOSSCOPUS")
      {
        s sNew970b=""
        if ##class(User.MARC).readLX(.handleCM,"cav_un_tablesd*CMCONFIG_"_sPomC99d)
        { ; pokud najdema defaultni formular, otevreme z nej
          s sNew970b=$$$getTagX(.handleCM,"970b")
        }
        else
        { ; pokud ne, vlozime novou hodnotu
          s sNew970b=$p(sPomC99d,"_",$l(sPomC99d,"_"))
        }
        d:(sNew970b'="") ##class(User.MARC).setTagX(.handle,"970    "_$c(31)_"b"_sNew970b)
      }
    }
    
    ///////////////////////////////////////////////////////////////////////////
    s tc610=##class(User.MARC).getTagX(.handle,"610",-1)
    if tc610'=""
    { ; po oldove uprave smazat
      s nNtag=$l(tc610,$c(10))             ; pocet opakovani tagu
      s sVysl=""                          ; skladani vysledneho tagu
 
      f i=1:1:nNtag 
      { ; pres vsechny opakovani C99
        s tc6101=$p(tc610,$c(10),i)
        s tc6101=$$$setSubTagStr(tc6101,$c(31)_"0")
        s tc6101=$$$setSubTagStr(tc6101,$c(31)_"1")
        s tc6101=$$$setSubTagStr(tc6101,$c(31)_"2")
        if ($l(tc6101)>1)
        {
          s:(sVysl'="") sVysl=sVysl_$c(10)_tc6101
          s:(sVysl="") sVysl=tc6101
        }
      } 
      if (sVysl'="") { d ##class(User.MARC).setTagX(.handle,sVysl)}
      else {  d ##class(User.MARC).delTagX(.handle,"610") }
    }   
    ////////////////////////////////////////////////////////////////////////////
    
    s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
    f i=1:1:nC 
    { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
      s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
      s sTag=$e(lsLine,1,3), slsLineOld=lsLine
      
      ; 28.01.16 tt; osetreni odmazavani mezer u 4xx - podle podpole 1
      if ($f(lsLine,$c(31))&&(($e(sTag,1)'="1"))&&('$f(lsLine,($c(31)_"1"))))
      { ; 21.12.15 tt; odstraneni prazdnych mezer za zacatku a konce subtagu 
        for xx=2:1:$l(lsLine,$c(31))
        {
          s sSub=$p(lsLine,$c(31),xx)
          s sSub1=$zstrip($e(sSub,2,99999),"<>W")
          s $e(sSub,2,99999)=sSub1
          s $p(lsLine,$c(31),xx)=sSub
        }        
      }
      
      if (sTag="C26")
      { ; doplneni IP adresy, pokud to pujde
        s sTC26i=$$$getSubTagStr(lsLine,"i")
        if ((sTC26i="")||(sTC26i="%IP%"))
        { ; pokud je IP adresa prazdna
          s sIp=""
          s:$$$WeAreInCSPContext sIp=##class(i2.common).getIP()
          s:((sIp'="")||(sIp'="%IP%")) lsLine=$$$setSubTagStr(lsLine,$c(31)_"i"_sIp)
        }
        if ($$$getSubTagStr(lsLine,"e")="") 
        { ; pokud je ustav prazdny
          s sUstav=""
          s sT999e=$$$getTagX(.handle,"999e")                ; ziskam si autora zaznamu
          if (sT999e'="")
          {
            if ##class(User.MARC).readLX(.handleU,sT999e)
            { ; pokud se nam podarilo otevrit uzivatele, nacteme 600b
              s sUstav=$$$getTagX(.handleU,"600b")  
              s:(sUstav'="") lsLine=$$$setSubTagStr(lsLine,$c(31)_"e"_sUstav)
            }
          }
        }
        if ($$$getSubTagStr(lsLine,"d")="%ROK_VYKAZOVANI%") 
        { ; 19.02.16 tt; pokud nam prijde z formulare priznak zadani aktualniho roku vykazovani, pouzijeme jej
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"d"_..#cAktRokZberu)
        }
        
      }
      /// 03.05.23 tt; zmena funkcnosti U10
      if (sTag="U10")
      { ; 210 (vydavateľské údaje) - používať sa bude U10 (kvôli opakovaniu dvojíc $a + $c) - opakovania 
        ; dvojíc sa ukladajú do samostatného opakovania poľa, $d sa zapíše do jedného z opakovaní alebo 
        ; nového opakovania (podľa toho ako to vyrieši ON). Pri ukladaní sa údaje z U10 skopírujú do 210. 
        ; Pole 210 sa bude vždy celé prepisovať; U10 zostáva, kým záznam nie je odoslaný
        s sPT210=sPT210_$e(lsLine,8,999)
      }   
      
      if ((sTag="U63")&&(pD("CH","U63")||pD("CH","U67")))
      { ; 463 (zdrojový dokument) - používať sa bude U63 (s podpoliami), pri uložení sa skopírujú do správny 
        ; vložených polí 463 (463 sa vždy prepíše pri uložení, U63 zostáva, kým záznam nie je odoslaný)
        s s463=..allowSaveExFormN463(.handle,lsLine)
        d:($l(s463)>9) $$$setTagX(.handle,s463)  
      } 
      if ((sTag="U70")&&(pD("CH","U70")||(pD("CH","U77"))))
      { ; a používa aj pri 470 (s pomocným poľom U70 a U77)
        s s470=..allowSaveExFormN470(.handle,lsLine)
        d:($l(s470)>9) $$$setTagX(.handle,s470)  
      }
      
      if ((sTag="U12")&&(pD("CH","U12")))
      { ; 010 (ISBN) - opakovanie ISBN sa zapisuje do opakovania $a. Pri odoslaní záznamu sa opraví na opakovanie poľa. 
        s sST=$$$getSubTagStrC(lsLine,"a",-1)
        for ops=1:1:($l(sST,$c(10)))
        { ; pres vsechny opakovani subtagu
          s sST1=$p(sST,$c(10),ops)  ; ziskana hodnota jednoho opakovani       
          d:(sST1'="") ##class(User.MARC).appendLineX(.handle,"010    "_$c(31)_"a"_sST1)          
        }
      }
      
      if (((sTag="U34")||(sTag="U14")||(sTag="U24"))&&(pD("CH","U34")||pD("CH","U24")||pD("CH","U14")))
      { ; osetreni 014 - pokud neni vyplnen subtag a, pole se dobaze pomoci delEmpty
        if (pD("N","014")'="")
        { ; musime ulozit puvodni hodnoty - krome wos, scopus, pmed
          for l=1:1:$l(pD("N","014"),$c(10))
          { ; zaindexujeme vsechny isbn
            s s0141=$p(pD("N","014"),$c(10),l)               ; vybereme jedno opakovani
            continue:(s0141="")
            s sT0142=$$$getSubTagStr(s0141,"2")
            s sT014a=$$$getSubTagStr(s0141,"a")
            if ((sT0142'="WOS")&&(sT0142'="SCOPUS")&&(sT0142'="PUBMED")&&(sT014a'=""))
            { ; vratime ho do handlu
              d ##class(User.MARC).appendLineX(.handle,s0141) 
            }
          }
        }          
        if ($$$getSubTagStr(lsLine,"a")'="") 
        { ; pro U34,U14, U24 plati ze pokud je a, doplnim do zaznamu
          if ($$$getSubTagStr(lsLine,"2")="")
          {
            s:(sTag="U34") lsLine=lsLine_$c(31)_"2WOS"
            s:(sTag="U14") lsLine=lsLine_$c(31)_"2SCOPUS"
            s:(sTag="U24") lsLine=lsLine_$c(31)_"2PUBMED"
          }        
          ; U34    $$2WOS$$aisi
          ; U14    $$2SCOPUS$$ascopus
          ; U24    $$2PUBMED$$apubed1       
          s lsLine2=$$$getSubTagStr(lsLine,"2")
          s lsLine=$$$strswap(lsLine,$c(31)_"2"_lsLine2,"")
          s lsLine=lsLine_$c(31)_"2"_lsLine2
          d ##class(User.MARC).appendLineX(.handle,"014"_$e(lsLine,4,9999))   
        } 
        s s014=""  ; promazani promenne po prvnim zpracovani           
      }
      if (sTag="541")
      { ; osetreni 541 - pokud neni vyplnen subtag a, pole se dobaze pomoci delEmpty
        s sSTa=$$$getSubTagStr(lsLine,"a")
        s sSTz=$$$getSubTagStr(lsLine,"z")
        ; pokud neni a vyplnene, odmazene
        if (sSTa="") { s lsLine="541    " }
        ; pokud je, musi byt vyplnene i z, jinak doplnime
        elseif ((sSTa'="")&&(sSTz="")) { s lsLine=lsLine_$c(31)_"zeng" }
      }  
      
      if (sTag="017")
      { ; preklopeni ohlasu a recenzi ze I3 formulare OHLASY
        s:(($$$getSubTagStr(lsLine,"2")="")&&($$$getSubTagStr(lsLine,"a")'="")) lsLine=lsLine_$c(31)_"2DOI"
        s lsLine2=$$$getSubTagStr(lsLine,"2")
        s lsLine=$$$strswap(lsLine,$c(31)_"2"_lsLine2,"")
        s lsLine=lsLine_$c(31)_"2"_lsLine2
      }
      
      if (sTag="U91")
      { ; preklopeni ohlasu a recenzi ze I3 formulare OHLASY
        s $e(lsLine,1,3)="971"
      }
      if (sTag="U92")
      {
        s $e(lsLine,1,3)="C71"
      }
      
      if (sTag="U95")
      { ; pridano datum zverejneni
        s U95b=$$$getSubTagStr(lsLine,"b")
        s:((U95b="")&&($$$getTagX(.handle,"969f")="")) lsLine=lsLine_$c(31)_"b"_##class(User.MARC).genT005(0)
      }
      
      if (sTag="215")
      { ; pridani s. k 215a
        s sSTa=$$$getSubTagStr(lsLine,"a")
        if ((sSTa'="") && ('$f(sSTa,"s.")) && (sSTa?.N))
        { ; vyplnene data mame 
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"a"_sSTa_" s.")
        }
      }
      
      if ((sTag="C11")||(sTag="C34")||(sTag="210")||(sTag="463"))
      { ; 11.07.19 tt; nahrada v.v.i. za v. v. i.
         s lsLine=$$$strswap(lsLine,"v.v.i.","v. v. i.")
      }
          
      ; nebude se upravovat - udela se globalka
      /*if (sTag="C34")
      { ; osetreni 541 - pokud neni vyplnen subtag a, pole se dobaze pomoci delEmpty
        s sSTt=$$$getSubTagStr(lsLine,"t")
        if ('$f(sSTt,".")&&($l(sSTt)=8))
        { ; upravime formu datumu
          s sSTt=$e(sSTt,7,8)_"."_$e(sSTt,5,6)_"."_$e(sSTt,1,4)
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"t"_sSTt)
        }
      }   */  
      /* ; 11.11.15 tt; u konverenci se nebude shlukovat datum do C20f
      if ((sTag="C20")&&(pD("CH","C20")))
      { ; slozeni C20f a s
        s sSTf=$$$getSubTagStr(lsLine,"f")
        s sSTs=$$$getSubTagStr(lsLine,"s")
        if ((sSTs'="")&&(sSTf'=""))
        { ; vyplnene data mame 
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"f"_sSTf_"-"_sSTs)
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"s")
        }
        if ((sSTs'="")&&(sSTf=""))
        { ; nane vyplnene jen s
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"f"_sSTs)
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"s")
        }
      }   
      */
      d:(slsLineOld'=lsLine) ##class(User.MARC).setLineX(.handle,i,lsLine) ; zapsani to radku
    }
    ; vkladani novych poli - pripadne prepsani existujicich
    d:($l(sPT210)>8) $$$setTagX(.handle,sPT210)         
  }  ; konec zpracovani vlozeni z I3 - formularu////
  ///////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////// zpracovani z klienta - webadmina ....
  else
  {
    ; uprava tagu 010 na U12 
    if (pD("CH","010")||(pD("N","U12")=""))
    { ; 010 (ISBN) - opakovanie ISBN sa zapisuje do opakovania $a. Pri odoslaní záznamu sa opraví na opakovanie poľa. 
      s s010aA = $$$getTagXC(.handle,"010a",-1)
      if (s010aA'="")
      { ; 25.03.11 tt; zmena indexovani issbn
        s sU12="U12    "

        for l=1:1:$l(s010aA,$c(10))
        { ; zaindexujeme vsechny isbn
          s s010a=$p(s010aA,$c(10),l)  
          s:(s010a'="") sU12=sU12_$c(31)_"a"_s010a
        }
        d:($l(sU12)>9) $$$setTagX(.handle,sU12)  
      }  
    }
    
    ; U34    $$2WOS$$adsfsd     U14    $$2SCOPUS$$afsfd     U24    $$2PUBMED$$asdfsdf 
    ; do 014 
    if (pD("CH","014")||(pD("N","U34")="")||(pD("N","U14")="")||(pD("N","U24")=""))
    { ; osetreni 014 - pokud neni vyplnen subtag a, pole se dobaze pomoci delEmpty
      for l=1:1:$l(pD("N","014"),$c(10))
      { ; zaindexujeme vsechny isbn
        s s0141=$p(pD("N","014"),$c(10),l)               ; vybereme jedno opakovani
        continue:(s0141="")
        s sT0142=$$$getSubTagStr(s0141,"2")
        s sT014a=$$$getSubTagStr(s0141,"a")
        d:((sT0142="WOS")&&(sT014a'="")) $$$setTagX(.handle,"U34"_$e(s0141,4,999))
        d:((sT0142="SCOPUS")&&(sT014a'="")) $$$setTagX(.handle,"U14"_$e(s0141,4,999))
        d:((sT0142="PUBMED")&&(sT014a'="")) $$$setTagX(.handle,"U24"_$e(s0141,4,999))
      }
    }
      //     s t001=$$$HandleT001(handle)
        //   s:((t001="0466939")) ^DK("TT",$zh,"rec1")=handle("Rec",1)
    
    s nC=##class(User.MARC).recordLineCountX(.handle)   ; ziskani poctu radku v zaznamu 
          //     s:((t001="0466939")) ^DK("TT",$zh,"nC1")=$g(nC)
    
    s sNewU63="",sNewU70=""
    f ixx=1:1:nC 
    { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
      s lsLine=##class(User.MARC).getLineX(.handle,ixx) continue:lsLine="" 
      s sTag=$e(lsLine,1,3), slsLineOld=lsLine
     
            //     s:((t001="0466939")) ^DK("TT",$zh,"stream")=sTag
 
      if ((sTag="210")&&(pD("CH","210")||(pD("N","U10")="")))
      { ; 210 (vydavateľské údaje) - používať sa bude U10 (kvôli opakovaniu dvojíc $a + $c) - opakovania 
        ; dvojíc sa ukladajú do samostatného opakovania poľa, $d sa zapíše do jedného z opakovaní alebo 
        ; nového opakovania (podľa toho ako to vyrieši ON). Pri ukladaní sa údaje z U10 skopírujú do 210. 
        ; Pole 210 sa bude vždy celé prepisovať; U10 zostáva, kým záznam nie je odoslaný
        
        ; U10    $$dfgdfgfd
        ; U10    $$adfs$$cdfsfsd
        ; U10    $$adfsdf$$cfddsf
        
        s sSTa=$$$getSubTagStrC(lsLine,"a",-1)
        s sSTc=$$$getSubTagStrC(lsLine,"c",-1)
        s sSTd=$$$getSubTagStr(lsLine,"d")
        d:(sSTd'="") ##class(User.MARC).appendLineX(.handle,"U10    "_$c(31)_"d"_sSTd)   
            
        for ops=1:1:($l(sSTa,$c(10))+10)
        { ; pres vsechny opakovani subtagu
          s sSTa1=$p(sSTa,$c(10),ops)  ; ziskana hodnota jednoho opakovani
          s sSTc1=$p(sSTc,$c(10),ops)  
          continue:((sSTa1="")&&(sSTc1=""))
          s:(sSTa1'="") sSTa1=$c(31)_"a"_sSTa1
          s:(sSTc1'="") sSTc1=$c(31)_"c"_sSTc1
          d ##class(User.MARC).appendLineX(.handle,"U10    "_sSTa1_sSTc1) 
        }
      }   
       ///s:(sTag="470") ^DK("TT",$zh,"stream")="xxx"_(sTag="470")_" "_pD("CH","470")_" "_(pD("N","U70")="")_" "_(pD("N","U77")="")  
      if ((sTag="463")&&((pD("CH","463"))||(pD("N","U63")="")||(pD("N","U67")="")))
      { ; 463 (zdrojový dokument) - používať sa bude U63 (s podpoliami), pri uložení sa skopírujú do správny 
        ; vložených polí 463 (463 sa vždy prepíše pri uložení, U63 zostáva, kým záznam nie je odoslaný)
        s sNewU63=..allowSaveExFormNU63(.handle,lsLine,1)
      } 
      /*
      if ((sTag="470")&&(t001="0466939"))
      {
       s ^DK("TT",$zh,"stream")=(sTag="470")_" "_pD("CH","470")_" "_(pD("N","U70")="")_" "_(pD("N","U77")="")  
          
          }*/
      if ((sTag="470")&&((pD("CH","470"))||(pD("N","U70")="")||(pD("N","U77")="")))
      { ; a používa aj pri 470 (s pomocným poľom U70 a U77)
        s sNewU70=..allowSaveExFormNU70(.handle,lsLine,1)      
      }    
      if ((sTag="C11")||(sTag="C34")||(sTag="210")||(sTag="463"))
      { ; 11.07.19 tt; nahrada v.v.i. za v. v. i.
         s lsLine=$$$strswap(lsLine,"v.v.i.","v. v. i.")
      }

      d:(slsLineOld'=lsLine) ##class(User.MARC).setLineX(.handle,ixx,lsLine) ; zapsani to radku
    }  
    
    
    d:(sNewU63'="") $$$setTagX(.handle,sNewU63)  
    d:(sNewU70'="") $$$setTagX(.handle,sNewU70)  
  }
  
  
  s sT210=$$$getTagX(.handle,"210")
  if (sT210'="")
  {
    s sStd=$$$getSubTagStr(sT210,"d")  
    s sSta=$$$getSubTagStr(sT210,"a")  
    s sStc=$$$getSubTagStr(sT210,"c")
    if (sStd'="")&&((sSta'="")||(sStc'=""))
    {
      s sT210=##class(User.MARC).setSubTagStr(sT210,$c(31)_"d","210    ")
      s sT210=sT210_$c(31)_"d"_sStd
      d $$$setTagX(.handle,sT210)
    }
  }
  d ##class(User.MARC).recordDelEmptyST(.handle)    ; odmazani prazdnych subtagu
]]></Implementation>
</Method>

<Method name="allowSaveExFormNData">
<Description><![CDATA[
<pre> Metoda pro nacteni dat z handlu do pD pro kontrolu zmen a upravy
Parametry: handle   - aktualni zpracovavany handle
           pD       - prvek pro data
           pUzel    - nazev prvniho uzlu v datech. Nacitaji se tam 2 handly, jeden autualni a druhy pred zmenou
                      "N" - novy zaznam
                      "O" - stary zaznam
           pDel     - jestli 1 - odmaze z handlu prislusne tagy podle zmeny.Jde zavolat az po nacteni stareho i noveho 
                                 handlu, jinak padne na nedefinovane promenne 
                               - musi byt spusteno jen na aktualni handle   
                      take tato volba vytvori pD("CH") uzly

           pD - uzel pD("CH","014")= 1 znamena zmenu v 014 novem oproti staremnu zaznamu

19.09.15 tt; zalozena metoda pro potreby novych formularu pro konverzi U63 na 463
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&pD,pUzel,bDel=0]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  ; pokud by nebyl handle naplneny (neexistuje stare verze u new zaznamu), vlozime pro jistotu prezdne hodnoty
  s pD(pUzel,"014")="", pD(pUzel,"010")="",  pD(pUzel,"463")=""
  s pD(pUzel,"470")="", pD(pUzel,"U99a")="", pD(pUzel,"U34")=""
  s pD(pUzel,"U14")="", pD(pUzel,"U24")="",  pD(pUzel,"541")=""
  s pD(pUzel,"210")="", pD(pUzel,"U10")="",  pD(pUzel,"U63")=""
  s pD(pUzel,"U70")="", pD(pUzel,"U77")="",  pD(pUzel,"U12")=""
  s pD(pUzel,"C20")="", pD(pUzel,"U67")=""
  
  if ($g(handle("Rec",1))'="")  
  { ; priznak, ze existuje handle - ma data, nacteme je
    s pD(pUzel,"014")=$$$getTagXC(.handle,"014",-1) ; nacteme si tagy, ktere budeme potrebovat pro porovnani
    s pD(pUzel,"010")=$$$getTagXC(.handle,"010",-1)
    s pD(pUzel,"463")=$$$getTagX(.handle,"463")
    s pD(pUzel,"470")=$$$getTagX(.handle,"470")
    s pD(pUzel,"U99a")=$$$getTagX(.handle,"U99a")
    s pD(pUzel,"U12")=$$$getTagX(.handle,"U12")
    s pD(pUzel,"U14")=$$$getTagX(.handle,"U14")
    s pD(pUzel,"U24")=$$$getTagX(.handle,"U24")
    s pD(pUzel,"U34")=$$$getTagX(.handle,"U34")
    s pD(pUzel,"541")=$$$getTagX(.handle,"541")
    s pD(pUzel,"210")=$$$getTagX(.handle,"210")
    s pD(pUzel,"U10")=$$$getTagXC(.handle,"U10",-1)
    s pD(pUzel,"U63")=$$$getTagX(.handle,"U63")
    s pD(pUzel,"U67")=$$$getTagXC(.handle,"U67",-1)
    s pD(pUzel,"U70")=$$$getTagX(.handle,"U70")
    s pD(pUzel,"U77")=$$$getTagXC(.handle,"U77",-1)
    s pD(pUzel,"C20")=$$$getTagX(.handle,"C20")
  }
     
  if bDel  
  { ; pro novy handle, odmazou se tagy, ktere by prekazely (vyse jsou ulozene)
    ; provede se vyhodnoceni zmeny
    ; ulozeni moznych zmen - pri naslednem zpracovani se pouzije
    s pD("CH","014")=(pD("N","014")'=pD("O","014"))
    s pD("CH","010")=(pD("N","010")'=pD("O","010"))
    s pD("CH","463")=(pD("N","463")'=pD("O","463"))
    s pD("CH","470")=(pD("N","470")'=pD("O","470"))
    s pD("CH","U12")=(pD("N","U12")'=pD("O","U12"))
    s pD("CH","U14")=(pD("N","U14")'=pD("O","U14"))
    s pD("CH","U24")=(pD("N","U24")'=pD("O","U24"))
    s pD("CH","U34")=(pD("N","U34")'=pD("O","U34"))
    s pD("CH","541")=(pD("N","541")'=pD("O","541"))
    s pD("CH","210")=(pD("N","210")'=pD("O","210"))
    s pD("CH","U10")=(pD("N","U10")'=pD("O","U10"))
    s pD("CH","U63")=(pD("N","U63")'=pD("O","U63"))
    s pD("CH","U67")=(pD("N","U67")'=pD("O","U67"))
    s pD("CH","U70")=(pD("N","U70")'=pD("O","U70"))
    s pD("CH","U77")=(pD("N","U77")'=pD("O","U77")) 
    s pD("CH","C20")=(pD("N","C20")'=pD("O","C20")) 
   
    if (pD("N","U99a")=1)
    { ; pokud byl zaznam ulozen z I3 formulare, musime upravovat data :-(
      ; ale jen pri zmene :-)
      d:(pD("CH","U34")||pD("CH","U24")||pD("CH","U14")) ##class(User.MARC).delTagX(.handle,"014")
      d:(pD("CH","U12")) ##class(User.MARC).delTagX(.handle,"010")
      d:(pD("CH","U63")) ##class(User.MARC).delTagX(.handle,"463")
      d:(pD("CH","U70")) ##class(User.MARC).delTagX(.handle,"470")
      
      ; po zapracovani musime priznak odstranit, aby se pri dalsim zpracovani mohl pridat :-)
      d ##class(User.MARC).delTagX(.handle,"U99")
    } 
    else
    { ; pri spusteni z klienta, delame upravy
      d:(pD("CH","210")) ##class(User.MARC).delTagX(.handle,"U10")
      if (pD("CH","463"))
      {
        d ##class(User.MARC).delTagX(.handle,"U63")
        d ##class(User.MARC).delTagX(.handle,"U67")
      }
      if (pD("CH","470"))
      {
        d ##class(User.MARC).delTagX(.handle,"U70")
        d ##class(User.MARC).delTagX(.handle,"U77")
      }
    }
  }
  
  q ""
]]></Implementation>
</Method>

<Method name="allowSaveExFormNU63">
<Description><![CDATA[
<pre> Metoda pro vyskladani 463 - vrati vyslednou 463 ve spravnem tvaru z U63
Parametry: handle   - aktualni zpracovavany handle
           lsLine   - aktualni zpracovavana radka zaznamu
           pPar     - pokud hodnota 1, vrati hodnotu noveho tagu U63 jako string 

11.09.15 tt; zalozena metoda pro potreby novych formularu pro konverzi U63 na 463
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,lsLine="",pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 ; inicializace pomennych
 s sST3="",sSTa="",sSTi="",sSTh="",sSTb="",sSTs="",sSTv="",sSTw="",sSTu="",sSTt="",
   sSTz="",sSTp="",sSTm="",sSTn="",sSTo="",sSTr="",sSTe="",sSTf="",sSTg="",ret=""

 ; prevedeni na handle - mohlo se v podstate pouzit uz na zacatku, ale je to asi jedno
 d ##class(User.MARC).t4xx2handle(.h4xx, lsLine)

 ; ziskame link
 s sST3=##class(User.MARC).getTag4xx(lsLine,"001.")
 s:(sST3="") sST3=##class(User.MARC).getTag4xx(lsLine,"001")
 /*if (sST3="")
 {
   s class4=$$$HandleClass(h4xx)
   s t0014=$$$HandleT001(h4xx)
   s sST3=##class(User.Util).objectName2lname(class4)_"*"_t0014  
 }*/
 s:(sST3'="") sST3=$c(31)_"3"_sST3
 
 ; 200    $$ab$$bISBN zdrojového dokumentu (010a)$$cO$$d0$$g010a,1        
 s sSTb=##class(User.MARC).getTag4xx(lsLine,"010a")
 s:(sSTb'="") sSTb=$c(31)_"b"_sSTb

 ; 200    $$as$$bISSN zdrojového dokumentu (011a)$$cO$$d0$$g011a,1
 s sSTs=##class(User.MARC).getTag4xx(lsLine,"011a")
 s:(sSTs'="") sSTs=$c(31)_"s"_sSTs
 
 ; 200    $$as$$bE-ISSN (011e)$$cO$$d0$$g011a,1
 s sSTk=##class(User.MARC).getTag4xx(lsLine,"011e")
 s:(sSTk'="") sSTk=$c(31)_"k"_sSTk

 ; 200    $$aa$$bNázev zdrojového dokumentu (200a)$$cR$$d0$$g200a,1
 s sSTa=##class(User.MARC).getTag4xx(lsLine,"200a")
 s:(sSTa'="") sSTa=$c(31)_"a"_sSTa
 
 ; 200    $$ai$$bNázev části zdrojového dokumentu (200i)$$cO$$d0$$g200i,1
 s sSTi=##class(User.MARC).getTag4xx(lsLine,"200i")
 s:(sSTi'="") sSTi=$c(31)_"i"_sSTi
 
 ; 200    $$ah$$bOznačení části zdrojového dokumentu (200h)$$cO$$d0$$g200h,1
 s sSTh=##class(User.MARC).getTag4xx(lsLine,"200h")
 s:(sSTh'="") sSTh=$c(31)_"h"_sSTh
 
 s s200v=##class(User.MARC).getTag4xx(lsLine,"200v")
 d ##class(rep.epca.exportBase).parse463200v(s200v,.rocnik,.cislo,.datum,.od,.do)    
 ; 200    $$av$$bLokace v zdrojovém dokumentu - ročník, svazek (200v1)$$cO$$d0
 s:(rocnik'="") sSTv=$c(31)_"v"_rocnik
 ; 200    $$aw$$bLokace v zdrojovém dokumentu - číslo (200v2)$$cO$$d0
 s:(cislo'="") sSTw=$c(31)_"w"_cislo
 ; 200    $$au$$bLokace v zdrojovém dokumentu - rok vydání(200v3)$$cO$$d0
 s:(datum'="") sSTu=$c(31)_"u"_datum
 ; 200    $$at$$bLokace v zdrojovém dokumentu - strany od (200v4)$$cO$$d0
 s:(od'="") sSTt=$c(31)_"t"_od
 ; 200    $$az$$bLokace v zdrojovém dokumentu - strany do (200v5)$$cO$$d0
 s:(do'="") sSTz=$c(31)_"z"_do

 ; 200    $$ap$$bPreklad názvu zdrojového dokumentu (541a)$$cO$$d0$$g541a,1
 s sSTp=##class(User.MARC).getTag4xx(lsLine,"541a")
 s:(sSTp'="") sSTp=$c(31)_"p"_sSTp
   
 ; 200    $$am$$bMísto vydání zdrojového dokumentu (210a)$$cO$$d0$$g210a,1
 s sSTm=##class(User.MARC).getTag4xx(lsLine,"210a")
 s:(sSTm'="") sSTm=$c(31)_"m"_sSTm

 ; 200    $$an$$bNakladatel zdrojového dokumentu (210c)$$cO$$d0$$g210c,1
 s sSTn=##class(User.MARC).getTag4xx(lsLine,"210c")
 s:(sSTn'="") sSTn=$c(31)_"n"_sSTn

 ; 200    $$ao$$bRok vydání zdrojového dokumentu (210d)$$cO$$d0$$g210d,1
 s sSTo=##class(User.MARC).getTag4xx(lsLine,"210d")
 s:(sSTo'="") sSTo=$c(31)_"o"_sSTo

 ; 200    $$ar$$bOznačení vydání zdrojového dokumentu (205a)$$cO$$d0$$g205a,1
 s sSTr=##class(User.MARC).getTag4xx(lsLine,"205a")
 s:(sSTr'="") sSTr=$c(31)_"r"_sSTr

 ; 200    $$ae$$bEdice zdrojového dokumentu (225a)$$cO$$d0$$g225a,1
 s sSTe=##class(User.MARC).getTag4xx(lsLine,"225a")
 s:(sSTe'="") sSTe=$c(31)_"e"_sSTe

 ; 200    $$af$$bČíslo svazku edice zdrojového dokumentu (225v)$$cO$$d0$$g225v,1
 s sSTf=##class(User.MARC).getTag4xx(lsLine,"225v")
 s:(sSTf'="") sSTf=$c(31)_"f"_sSTf

 ; 200    $$ag$$bOznačení řady edice zdrojového dokumentu (225i)$$cO$$d0$$g225i,1
 s sSTg=##class(User.MARC).getTag4xx(lsLine,"225i")
 s:(sSTg'="") sSTg=$c(31)_"g"_sSTg

  
 s sU63="U63    "_sST3_sSTa_sSTi_sSTh_sSTb_sSTs_sSTk_sSTv_sSTw_sSTu_sSTt_sSTz_sSTp_sSTm_sSTn_sSTo_sSTr_sSTe_sSTf_sSTg
 if (pPar="1")
 { ; 06.03.17 tt; presunuto ukladani na vraceni U63 jako vysledek a vysledne ulozeni posleze
   s:($l(sU63)>9) ret=sU63
 }
 else
 { 
   d:($l(sU63)>9) $$$setTagX(.handle,sU63)  
 }
 
 ; . prochazeni zaznamu podle .c - vse do U67   
 s c=0
 d {
    s sT702=$$$getTagXC(.h4xx,"70*",.c) ; vsetky citacie
    continue:((sT702="")&&(c'=0))
    ; pridame vse do U67 - mame je na zacaktu odmazane
    d:(($l(sT702)>9)&&$f(sT702,$c(31))) ##class(User.MARC).appendLineX(.handle,"U67"_$e(sT702,4,9999))
  } while (c'=0)
  
  q ret
]]></Implementation>
</Method>

<Method name="allowSaveExFormNU70">
<Description><![CDATA[
<pre> Metoda pro vyskladani 470 - vrati vyslednou 470 ve spravnem tvaru z  U70 a U77
Parametry: handle   - aktualni zpracovavany handle
           lsLine   - aktualni zpracovavana radka zaznamu
           pPar     - pokud hodnota 1, vrati hodnotu noveho tagu U70 jako string 

12.09.15 tt; zalozena metoda pro potreby novych formularu pro konverzi U70 na 470
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,lsLine="",pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 s sSTa="", sST3="",sSTj="",ret=""
 ; ziskame link
 s sST3=##class(User.MARC).getTag4xx(lsLine,"001.")
 s:(sST3="") sST3=##class(User.MARC).getTag4xx(lsLine,"001")
 s:(sST3'="") sST3=$c(31)_"3"_sST3
 
 ; 200    $$aa$$bNázev citované práce (200a)$$cR$$d0$$g200a,1
 s sSTa=##class(User.MARC).getTag4xx(lsLine,"200a")
 s:(sSTa'="") sSTa=$c(31)_"a"_sSTa
 
 ; 200    $$aj$$bJazyk citované práce (101a)$$cO$$d0$$g101a,1
 s sSTj=##class(User.MARC).getTag4xx(lsLine,"101a")
 s:(sSTj'="") sSTj=$c(31)_"j"_sSTj
 
 s sU70="U70    "_sST3_sSTa_sSTj
 if (pPar="1")
 { ; 06.03.17 tt; presunuto ukladani na vraceni U70 jako vysledek a vysledne ulozeni posleze
   s:($l(sU70)>9) ret=sU70
 }
 else
 { 
   d:($l(sU70)>9) $$$setTagX(.handle,sU70)   
 }
 
 d ##class(User.MARC).t4xx2handle(.h4xx, lsLine) 
 ; . prochazeni zaznamu podle .c - vse do U77   
 s c=0
 d {
    s sT702=$$$getTagXC(.h4xx,"70*",.c) ; vsetky citacie
    continue:((sT702="")&&(c'=0))
    ; pridame vse do U67 - mame je na zacaktu odmazane
    d:(($l(sT702)>9)&&$f(sT702,$c(31))) ##class(User.MARC).appendLineX(.handle,"U77"_$e(sT702,4,9999))
  } while (c'=0)
  
  q ret
]]></Implementation>
</Method>

<Method name="allowSaveExFormN463">
<Description><![CDATA[
<pre> Metoda pro vyskladani 463 - vrati vyslednou 463 ve spravnem tvaru z U63
Parametry: handle   - aktualni zpracovavany handle
           lsLine   - aktualni zpracovavana radka zaznamu

15.01.22 tt; pokud seskladavame periodikum, ulozime eissn i issn do jednoho tagu 
11.09.15 tt; zalozena metoda pro potreby novych formularu pro konverzi U63 na 463
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,lsLine=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s s463="463  1 "
  s sSt3=$$$getSubTagStr(lsLine,"3")      
  s:(sSt3'="") s463=s463_$c(31)_"1001  "_sSt3
  s s010a=$zstrip($$$getSubTagStr(lsLine,"b"),"<>W")  ; 200    $$ab$$bISBN zdrojového dokumentu (010a)$$cO$$d0$$g010a,1        
  s:(s010a'="") s463=s463_$c(31)_"1010  "_$c(31)_"a"_s010a
  s s011a=$zstrip($$$getSubTagStr(lsLine,"s"),"<>W")  ; 200    $$as$$bISSN zdrojového dokumentu (011a)$$cO$$d0$$g011a,1
  s:(s011a'="") s463=s463_$c(31)_"1011  "_$c(31)_"a"_s011a
  s s011e=$zstrip($$$getSubTagStr(lsLine,"k"),"<>W")  ; 200    $$ak$$bE-ISSN zdrojového dokumentu (011e)$$cO$$d0$$g011e,1
  if (s011a'="")
  {  ; 15.01.22 tt; pokud seskladavame periodikum, ulozime eissn i issn do jednoho tagu 
     s:(s011e'="") s463=s463_$c(31)_"e"_s011e
  }
  else
  { ; pokud neni issn, jen seskladame
    s:(s011e'="") s463=s463_$c(31)_"1011  "_$c(31)_"e"_s011e 
  }
  s s200="2001 "
  s s200a=$zstrip($$$getSubTagStr(lsLine,"a"),"<>W")  ; 200    $$aa$$bNázev zdrojového dokumentu (200a)$$cR$$d0$$g200a,1
  s:(s200a'="") s200=s200_$c(31)_"a"_s200a 
  s s200i=$zstrip($$$getSubTagStr(lsLine,"i"),"<>W")  ; 200    $$ai$$bNázev části zdrojového dokumentu (200i)$$cO$$d0$$g200i,1
  s:(s200i'="") s200=s200_$c(31)_"i"_s200i
  s s200h=$zstrip($$$getSubTagStr(lsLine,"h"),"<>W")  ; 200    $$ah$$bOznačení části zdrojového dokumentu (200h)$$cO$$d0$$g200h,1
  s:(s200h'="") s200=s200_$c(31)_"h"_s200h
  s s200v1=$zstrip($$$getSubTagStr(lsLine,"v"),"<>W") ; 200    $$av$$bLokace v zdrojovém dokumentu - ročník, svazek (200v1)$$cO$$d0
  s s200v2=$zstrip($$$getSubTagStr(lsLine,"w"),"<>W") ; 200    $$aw$$bLokace v zdrojovém dokumentu - číslo (200v2)$$cO$$d0
  s s200v3=$zstrip($$$getSubTagStr(lsLine,"u"),"<>W") ; 200    $$au$$bLokace v zdrojovém dokumentu - rok vydání(200v3)$$cO$$d0
  s s200v4=$zstrip($$$getSubTagStr(lsLine,"t"),"<>W") ; 200    $$at$$bLokace v zdrojovém dokumentu - strany od (200v4)$$cO$$d0
  s s200v5=$zstrip($$$getSubTagStr(lsLine,"z"),"<>W") ; 200    $$az$$bLokace v zdrojovém dokumentu - strany do (200v5)$$cO$$d0
  s sPref="S. ",s200v=""
  s:((s200v1'="")||(s200v2'="")||(s200v3'="")) sPref="s. "
  
  ; pridame prefix, pokud tam uz neni (je to tedy cislo)
  s:(##class(Util).isNumber(s200v4)) s200v4=sPref_s200v4
  if (s200v5'="")
  {
    s:(s200v4'="") s200v4=s200v4_"-"
    s s200v4=s200v4_s200v5
  }
  ; uprava tvaru rocniku
  s:(##class(Util).isNumber(s200v1)) s200v1="Roč. "_s200v1
  if (##class(Util).isNumber(s200v2)) 
  { ; upravime tvar cisla
    s:(s200v1'="") s200v2="č. "_s200v2
    s:(s200v1="") s200v2="Č. "_s200v2     
  }
  s s200v=s200v1
  if (s200v2'="")
  { ; pridame cislo
    s:(s200v'="") s200v2=", "_s200v2
    s s200v=s200v_s200v2
  }
  if (s200v3'="")
  { ; pridame cislo
    s s200v=s200v_" ("_s200v3_")"
  }
  if (s200v4'="")
  { ; pridame cislo
    s:(s200v'="") s200v4=", "_s200v4
    s s200v=s200v_s200v4
  }
  s:(s200v'="") s200=s200_$c(31)_"v"_s200v
  s:($l(s200)>8) s463=s463_$c(31)_"1"_s200

  s s541a=$zstrip($$$getSubTagStr(lsLine,"p"),"<>W")  ; 200    $$ap$$bPreklad názvu zdrojového dokumentu (541a)$$cO$$d0$$g541a,1
  s:(s541a'="") s463=s463_$c(31)_"1541  "_$c(31)_"a"_s541a
    
  s s210="210  "
  s s210a=$zstrip($$$getSubTagStr(lsLine,"m"),"<>W")  ; 200    $$am$$bMísto vydání zdrojového dokumentu (210a)$$cO$$d0$$g210a,1
  s:(s210a'="") s210=s210_$c(31)_"a"_s210a
  s s210c=$zstrip($$$getSubTagStr(lsLine,"n"),"<>W")  ; 200    $$an$$bNakladatel zdrojového dokumentu (210c)$$cO$$d0$$g210c,1
  s:(s210c'="") s210=s210_$c(31)_"c"_s210c
  s s210d=$zstrip($$$getSubTagStr(lsLine,"o"),"<>W") ; 200    $$ao$$bRok vydání zdrojového dokumentu (210d)$$cO$$d0$$g210d,1
  s:(s210d'="") s210=s210_$c(31)_"d"_s210d
  s:($l(s210)>8) s463=s463_$c(31)_"1"_s210
    
  s s205a=$zstrip($$$getSubTagStr(lsLine,"r"),"<>W")  ; 200    $$ar$$bOznačení vydání zdrojového dokumentu (205a)$$cO$$d0$$g205a,1
  s:(s205a'="") s463=s463_$c(31)_"1205  "_$c(31)_"a"_s205a
   
  s s225="225  "
  s s225a=$zstrip($$$getSubTagStr(lsLine,"e"),"<>W")  ; 200    $$ae$$bEdice zdrojového dokumentu (225a)$$cO$$d0$$g225a,1
  s:(s225a'="") s225=s225_$c(31)_"a"_s225a
  s s225v=$zstrip($$$getSubTagStr(lsLine,"f"),"<>W")  ; 200    $$af$$bČíslo svazku edice zdrojového dokumentu (225v)$$cO$$d0$$g225v,1
  s:(s225v'="") s225=s225_$c(31)_"v"_s225v
  s s225i=$zstrip($$$getSubTagStr(lsLine,"g"),"<>W")  ; 200    $$ag$$bOznačení řady edice zdrojového dokumentu (225i)$$cO$$d0$$g225i,1
  s:(s225i'="") s225=s225_$c(31)_"i"_s225i
  s:($l(s225)>8) s463=s463_$c(31)_"1"_s225
  
  ; . prochazeni zaznamu podle .c   
  s c=0
  d { ; zmenen tag pro autory na U67
    s sT702=$$$getTagXC(.handle,"U67",.c) ; vsichni autori
    continue:((sT702="")&&(c'=0))
    if (sT702'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s:($e(sT702,6)'="1") $e(sT702,6)="1"
      s s463=s463_$c(31)_"1"_"702"_$e(sT702,5,6)_$e(sT702,8,999)
    }
  } while (c'=0)
  
  q s463
]]></Implementation>
</Method>

<Method name="allowSaveExFormN470">
<Description><![CDATA[
<pre> Metoda pro vyskladani 470 - vrati vyslednou 470 ve spravnem tvaru z  U70 a U77
Parametry: handle   - aktualni zpracovavany handle
           lsLine   - aktualni zpracovavana radka zaznamu

18.07.16 tt; upraveni auotri v 470 z 702 na 700 a 701
12.09.15 tt; zalozena metoda pro potreby novych formularu pro konverzi U70 na 470
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,lsLine=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s s470="470  1 "
  s sSt3=$$$getSubTagStr(lsLine,"3")      
  ; 200    $$a3$$bKód citovaného dokumentu (001.)$$cO$$d0$$ePB,UN_CAT^4$$g001.,1
 
  s:(sSt3'="") s470=s470_$c(31)_"1001  "_sSt3
  s s200a=$zstrip($$$getSubTagStr(lsLine,"a"),"<>W")   ; 200    $$aa$$bNázev citované práce (200a)$$cR$$d0$$g200a,1
  s:(s200a'="") s470=s470_$c(31)_"12001 "_$c(31)_"a"_s200a
  s s101a=$zstrip($$$getSubTagStr(lsLine,"j"),"<>W")   ; 200    $$aj$$bJazyk citované práce (101a)$$cO$$d0$$g101a,1
  s:(s101a'="") s470=s470_$c(31)_"1101  "_$c(31)_"a"_s101a
    
  ; . prochazeni zaznamu podle .c   
  s c=0,nCountA=1
  d {
    s sT702=$$$getTagXC(.handle,"U77",.c) ; vsetky citacie
    continue:((sT702="")&&(c'=0))
    if (sT702'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s:($e(sT702,6)'="1") $e(sT702,6)="1"
      ; 18.07.16 tt; upraveni auotri v 470 z 702 na 700 a 701
      if (nCountA=1) { s s470=s470_$c(31)_"1"_"700"_$e(sT702,5,6)_$e(sT702,8,999) }
      else           { s s470=s470_$c(31)_"1"_"701"_$e(sT702,5,6)_$e(sT702,8,999) }
      s nCountA=nCountA+1
    }
  } while (c'=0)
  
  q s470
]]></Implementation>
</Method>

<Method name="allowSaveExCheckFldModif">
<Description>
kontrola zoznamu poli na modifikaciu
    handle  - incoming record
    handlee - existing record
    sFldLst - zoznam poli (bug tag alebo tag+subtag)
    
    pozor akonahle je tag opakovatelny a chcelo by sa kontrolovat len jedno podpole
    toto nie je implementovane (pretoze berie len prve podpole z opakovania tagu)
    pokial sa zada len cislo tagu - preveruje tag ako celok

12.01.16 tt; pridana moznost needitovat C12d i u ostatnich projektu
06.01.06 tt; pridano osetreni na moznou modifikaci C12
12.11.10 tt; pridano osetreni prehodeni podpoli a metoda prepracovana   
13.12.07 rs;    
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&handlee,sFldLst]]></FormalSpec>
<Implementation><![CDATA[
  $$$HandleOK(handle) $$$HandleOK(handlee) ; preverit platnost handle
    s c=$l(sFldLst,","),sRet=""
    f i=1:1:c
    {
        s sTag=$$$trim($p(sFldLst,",",i))
        continue:(sTag="")
        s sVal1=$$$getTagXC(.handle, sTag,-1),sV1=sVal1
        s sVal2=$$$getTagXC(.handlee,sTag,-1),sV2=sVal2
        ; 16.07.20 tt; provedena zmena, aby se se C12 nedala editovat vubec - vyjimka zpusobovala 
        ;              problemy, kdy zpracovatelky menily C12   
         
        /*if (sTag="C12")
        { ; 06.01.06 tt; pridano osetreni na moznou modifikaci C12
          s sV1="",sV2=""
          for l=1:1:$l(sVal1,$c(10))
          { ; projdes vsechny V1 a dame tam jen s C12b
            s sVal11=$p(sVal1,$c(10),l)  
            s sVal11b=$$$getSubTagStr(sVal11,"b")
            s sVal11d=$$$getSubTagStr(sVal11,"d")
            if (sVal11b'="")
            {
              s:(sV1'="") sV1=sV1_$c(10)_sVal11
              s:(sV1="") sV1=sVal11
            }
            elseif (sVal11d'="")
            {
              s:(sV1'="") sV1=sV1_$c(10)_"C12    "_$c(31)_sVal11d
              s:(sV1="") sV1="C12    "_$c(31)_sVal11d   
            }
          }
          for l=1:1:$l(sVal2,$c(10))
          { ; projdes vsechny V1 a dame tam jen s C12b
            s sVal22=$p(sVal2,$c(10),l)  
            s sVal22b=$$$getSubTagStr(sVal22,"b")
            s sVal22d=$$$getSubTagStr(sVal22,"d")
            if (sVal22b'="")
            {
              s:(sV2'="") sV2=sV2_$c(10)_sVal22
              s:(sV2="") sV2=sVal22
            }
            elseif (sVal22d'="")
            {
              s:(sV2'="") sV2=sV2_$c(10)_"C12    "_$c(31)_sVal22d
              s:(sV2="") sV2="C12    "_$c(31)_sVal22d   
            }
          }
          s sVal1=sV1, sVal2=sV2      
        }  */
                
        continue:((sVal1="")&&(sVal2=""))   ; pokud jsou prazdne tagy, preskocim
        s sVal11=sVal1,sVal21=sVal2
        for j=2:1:$l(sVal1,$c(31))
        { ; 12.11.10 tt; pridano osetreni prehodeni podpoli
          s sPomRet=$p(sVal1,$c(31),j)      ; proste odmazeme podpole a vysledek ma byt stejny
          s sVal11=$$$strswap(sVal11,$c(31)_sPomRet,"")
          s sVal21=$$$strswap(sVal21,$c(31)_sPomRet,"")
        }               
        if (sVal11'=sVal21) 
        { ; vypis chyb
          s sRet="|ERRUSR_CAV03#"_sTag_"#nepovolená modifikace pole (nove: "_sV1_", stare: "_sV2_")."          
          q
        }
    }
    
    q sRet
]]></Implementation>
</Method>

<Method name="allowSaveExCheckFldModif7XXw">
<Description>
kontrola zoznamu poli na modifikaciu
    handle  - incoming record
    handlee - existing record
    sFldLst - zoznam poli (bug tag alebo tag+subtag)
    
    pozor akonahle je tag opakovatelny a chcelo by sa kontrolovat len jedno podpole
    toto nie je implementovane (pretoze berie len prve podpole z opakovania tagu)
    pokial sa zada len cislo tagu - preveruje tag ako celok

08.04.2020 tt; zalozeno
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&handlee]]></FormalSpec>
<Implementation><![CDATA[
  $$$HandleOK(handle) $$$HandleOK(handlee) ; preverit platnost handle
  s sRet="", t001=$$$HandleT001(handle)
  q:(t001'="0505863") ""
  
  s sVal1=$$$getTagXC(.handle,"70*",-1),sV1=sVal1
  
  s c=0
  d {
    s sT70x=$$$getTagXC(.handlee,"70*",.c) ; vsetky citacie
    continue:((sT70x="")&&(c'=0))
    if (sT70x'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sT70x3=$$$getSubTagStr(sT70x,"3")
      continue:(sT70x3="")
      s sT70xw=$$$getSubTagStr(sT70x,"w")
      for l=1:1:$l(sVal1,$c(10))
      { ; zaindexujeme vsechny isbn
        s sVal11=$p(sVal1,$c(10),l)  
        s sVal113=$$$getSubTagStr(sVal11,"3")
        if (sVal113=sT70x3)
        { ; pokud mame shodu kodu, muzeme kontrolovat dale
          s sVal11w=$$$getSubTagStr(sVal11,"w")
         
          if (sT70xw'=sVal11w) 
          {
           if ##class(User.MARC).readLX(.handleA,sT70x3)
           {
             if ($$$getTagX(.handleA,"C48x")'=sVal11w)
             {
               s sRet=sRet_"|ERRUSR_CAV05#"_$e(sT70x,1,3)_"#nepovolená modifikace týmu 70*w pro autoritu "_sT70x3_"(nove: "_sVal11w_", stare: "_sT70xw_"). Hodnota se neshoduje s hodnotou týmu autoritního záznamu."          
             }
           }
           else
           {
             s sRet=sRet_"|ERRUSR_CAV04#"_$e(sT70x,1,3)_"#nepodařilo se otevřít zdrojovou autoritu pro kontrolu změny podpole 70*$$w."          
           }
          }
        }
      }      
    }
  } while (c'=0)

  q sRet
]]></Implementation>
</Method>

<Method name="allowSaveExRZ">
<Description><![CDATA[
<pre>Preveri ci, je rok zberu OK
Navrat:
 pri chybe "|ERR..." jinak prazdne

Nove zaznamy je mozne vytvorit bud bez roku zberu (kvoli zdroj.dokumentom),
alebo s rokom zberu = aktualnemu roku zberu.
U existujucich zaznamov nie je povolena zmena obsahu pola.
Vynimku tvoria zaznamy "W", kde je povolene zmenit povodny rok zberu na aktualny.

04.03.15 tt; pridana kontrola na změnu C64 mimo ADMIN účtů
08.04.13 tt; zakazani modifikace starsich zaznamu, pridano C57
21.03.13 tt; zmena roku zberu 2013->2014
15.03.12 tt; zmena roku zberu 2012->2013 (vynechany z kontroly 2012 a 2013)
15.02.11 tt; pridana podminka, aby mohli zpracovatele zadat vetsi rok zberu
15.03.11 tt; zmena roku zberu 2011->2012
19.03.10 rs; uprava pre rok zberu iny ako sRZ=2011
16.06.09 rs; uprava pre rok zberu iny ako 2010
15.08.08 pb; uprava pre rok zberu iny ako 2009
13.12.07 rs; pridane specialne podmienky pre rok zberu 2007
28.06.07 rs; dorobena vynimka pre zaznamy W
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sRet=""
  ; rozk zberu z prichadzajuceho zaznamu
  s sRZAkt=$$$getTagX(.handle,"C26d")
  ; 19.03.16 tt; pridana vyjimka pro kontrolu - do zaznamu se v allowSave dale doplni spravna hodnota
  s:(sRZAkt="%ROK_VYKAZOVANI%") sRZAkt=..#cAktRokZberu
  
  s sC64NEW=$$$getTagXC(.handle,"C64",-1)
 
  s t001=$$$HandleT001(handle),class=$$$HandleClass(handle)
  ; precitame verziu zaznamu aktualne ulozenu v DB
  if ##class(MARC).readX(.handlee,class,t001)
  {
      ; 04.03.15 tt; pridana kontrola na změnu C64 mimo ADMIN účtů
      s sC64OLD=$$$getTagXC(.handlee,"C64",-1)
     /// s:(t001="0389050") ^DK("TT",$zh,"C64o")=sC64OLD 
     /// s:(t001="0389050") ^DK("TT",$zh,"C64n")=sC64NEW 
     // s:(t001="0389050") ^DK("TT",$zh,"handle")=handle("Rec",1)
      if ($tr(sC64OLD," ","")'=$tr(sC64NEW," ",""))
      {
        q "|ERRUSR_CAV64#nepovolená modifikace pole C64"
      }
      
      ; zaznam existuje - nie je povolena zmena pola C26d
      s sRZ=$$$getTagX(.handlee,"C26d")
      
      ; 25.03.19 tt; uprava logiky, aby neslo zmeni roky vykazovani, kdyz uz je vykazany do rivu
      ; 0/1 ci je zaznam nastaveny na export do RIV
      s bExportRIV=+##class(MARC).getTagX(.handlee,"C26b")
   
      if (sRZ'=sRZAkt)
      {
          ; pokus o zmenu roku zberu na iny ako je ulozeny
          ; vynimkou su zaznamy typu "W", kde je povolene zmenit rok zberu na aktualny
          ; 
          ; 970b berieme z ulozeneho zaznamu - pri operacii zmeny na "uplatneny"
          ; totiz zaznam meni druh dokumentu
          s sDK=$$$getTagX(.handlee,"970b")
          if sDK="W",sRZAkt=..#cAktRokZberu q ""
          
          ; 22.11.18 tt; provedena oprava podminky roku zberu
          ; 15.02.11 tt; pridana podminka, aby mohli zpracovatele zadat vetsi rok zberu
          ; 30.05.19 tt; provedena uprava podminky roku sberu
          ; 31.07.19 tt; Změna roku sběru by měla být možná pro všechny záznamy aktuálního roku sběru a pro neoznačené záznamy do RIV 
          ;              všech roků sběru a to na rok sběru vyšší a nazpět.
          q:(((sRZAkt>sRZ)&&(sRZAkt>=..#cAktRokZberu)&&('bExportRIV))||((sRZAkt>=..#cAktRokZberu)&&(sRZ>=..#cAktRokZberu))) ""

          q "|ERRUSR_CAV01#"_sRZ_"#"_sRZAkt_"#nepovolená modifikace roku sběru"
      }
      
      /// 21.03.23 tt; provedeno osetreni, aby se porad nemusel nastavovat rok sberu
      /// 16.03.23 tt; zmena roku zberu 2023->2024
      /// 16.03.23 tt; zmena roku zberu 2022->2023
      /// 20.03.22 tt; zmena roku zberu 2022->2023
      /// 15.03.21 tt; zmena roku zberu 2021->2022
      /// 08.04.20 tt; zmena roku zberu 2020->2021
      /// 25.03.19 tt; zmena roku zberu 2019->2020  
      /// 20.03.18 tt; zmena roku zberu 2018->2019
      /// 16.05.17 tt; zablokovani editace roku 2017
      /// 20.03.16 tt; zmena roku zberu 2016->2017
      /// 22.03.15 tt; zmena roku zberu 2015->2016
      /// 16.03.14 tt; zmena roku zberu 2014->2015
      /// 21.03.13 tt; zmena roku zberu 2013->2014
      ; 19.03.10 pb; uprava pre rok zberu iny ako 2011
      ; 16.06.09 rs; uprava pre rok zberu iny ako 2010
      ; 15.08.08 pb; uprava pre rok zberu iny ako 2009
      ;
      ; POZOR - rok v tejto podmienke NEMUSI by vzdy totozny s 
      ; #cAktRokZberu nutne vzdy individualne preverit, ako to chcu
      ; mat nastavene - niekedy mozu byt docasne povolene napr.
      ; 2 roky a podobne
      ;
      ; 08.04.13 tt; zakazani modifikace starsich zaznamu, pridano C57
      if ((bExportRIV)&&((sRZ'=..#cAktRokZberu)&&(sRZ'=(..#cAktRokZberu+1))))
      {
          ; 13.12.07 rs; specialne podmienky pre rok zberu 2007
          ; 
          ; pozor 4-pismenkova kombinacia sa zatial smie pouzit len pre neopak.tagy
          ; 
          ; 04.05.19 tt; pridano - neodeslani zaznamu:  - záznamy, které jsou odeslane do RIV (jiny nez aktualni rok sberu) 
          ;              nesmi zpracovatel oznacit jako neodeslane. - pridano 969f
          s sRet=sRet_..allowSaveExCheckFldModif(.handle,.handlee,"C26b,C26d,C12,C12a,C123,C13,970b,C57,969f,C90a")
          if sRet'="" q sRet
      }
      
      if (($$$getTagX(.handlee,"970b")="DATA")&&($$$getTagX(.handlee,"969")="")&&($$$getTagX(.handlee,"U95a")="1"))
      { ; 24.01.18 tt; pridana kontrola na datove zaznamy          
        /// 01.12.22 tt; pridana funcnost vytvoreni kopie datasetu 
        s sRet=sRet_..allowSaveExCheckFldModif(.handle,.handlee,"C81,C76,U95,U033")
        if sRet'="" q sRet
      }
      
      if (($$$getTagX(.handlee,"970b")="DATA"))
      { ; 03.03.22 tt; pridana kontrola, aby mohl 017a menit jen admin
        s sRet=sRet_..allowSaveExCheckFldModif(.handle,.handlee,"017a")
        if sRet'="" q sRet
      }
      
      ; 08.04.20 tt; zalozena specialni metoda na kontrolu 70*w
      s sRet=sRet_..allowSaveExCheckFldModif7XXw(.handle,.handlee)
      if sRet'="" q sRet
      /*
      ; 09.03.20 tt; pridana kontrola na zmenu 700w + 701w + 702w 
      s sRet=..allowSaveExCheckFldModif(.handle,.handlee,"700w,701w,702w")
      if sRet'="" q sRet*/
      
      q "" ;* OK
  }
  
  if (($$$getTagX(.handle,"970b")="DATA")&&($$$getTagX(.handle,"017a")'=""))
  { ; 03.03.22 tt; pridana kontrola, aby mohl 017a menit jen admin   
    q "|ERRUSR_CAV03#Nemáta práva na vyplnění DOI u datového záznamu"
  }
  
  ; novy zaznam - je povolene vytvorit len s aktualnym rokom zberu,
  ; alebo s prazdnym rokom zberu (napr. zbornik)
  if ($$$getTagX(.handle,"C99d")="DFLTI_EPCA_CZ_WOSSCOPUS")
  {
    if ((sRZAkt'="")&&(sRZAkt'=..#cAktRokZberu)&&(sRZAkt'=(..#cAktRokZberu+1))) 
    { 
     q "|ERRUSR_CAV02#"_sRZAkt_"-"_..#cAktRokZberu_"#nepovolený rok sběru"
     
    }
  }
  else
  {
    if sRZAkt'="",sRZAkt'=..#cAktRokZberu q "|ERRUSR_CAV02#"_..#cAktRokZberu_"#nepovolený rok sběru"
  }
  
  q "" ;* OK
]]></Implementation>
</Method>

<Method name="createAuthLinks463genSZP">
<Description><![CDATA[
<pre>Vygenerovat SZP zaznam zbornika alebo periodika z daneho handle
handle pochadza z 4xx tagu
v podstate ukladame 1:1 obsah 4xx - presne ako prisla odmazavam len 200$v
a pridavam par konstantnych tagov 
a je drobny rozdiel u periodik a zbornikov

29.08.17 tt; pridano generovani 000 pri automatickem zakladani DFLT_CAT_BXXS a DFLT_CAT_BCA
16.12.16 tt; opraven druh zdrojoveho periodika na bca
16.11.15 tt; nahrazen formular DFLT_EPCA3 za DFLT_CAT_BXXS a DFLT_CAT_BXX
11.11.10 tt; udelany upravy pro spravne vytvoreni SZP a pripadne predani hlasky
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,bZbornik,psWGrp,&pPomErr,pUser=""]]></FormalSpec>
<Implementation><![CDATA[
   d $$$setTagX(.handle,"100    "_$c(31)_"a"_##class(Util).date()_"aczey0103    ba")
   d $$$setTagX(.handle,"000    00240nx   22001213  450")
   d $$$setTagX(.handle,"110    "_$c(31)_"aa")
   d $$$setTagX(.handle,"801    "_$c(31)_"aCZ"_$c(31)_"b"_"CAV"_$c(31)_"c"_##class(Util).date())
   if (bZbornik)
   {
     ; zbornik
     d $$$setTagX(.handle,"970    "_$c(31)_"b"_"BXXS")
     d $$$setTagX(.handle,"C99    "_$c(31)_"dDFLT_CAT_BXXS")
   }
   else
   {
     ; zdrojove periodikum
     d $$$setTagX(.handle,"970    "_$c(31)_"b"_"BCA")
     d $$$setTagX(.handle,"969    "_$c(31)_"fA")
     d $$$setTagX(.handle,"C99    "_$c(31)_"dDFLT_CAT_BCA")
   }
   ; 03.11.15 tt; zmena 999e na f - u DFLT_EPCA3
   ; d $$$setTagX(.handle,"C99    "_$c(31)_"dDFLT_EPCA3")
   s:(pUser'="") pUser=$c(31)_"f"_pUser       
   d $$$setTagX(.handle,"999    "_$c(31)_"a1"_$c(31)_"b"_psWGrp_$c(31)_"d"_"sys-"_##class(Util).date()_pUser)
   
   ; odmazat 200$v
   s s=$$$getTagX(.handle,"200")
   s s=$$$setSubTagStr(s,$c(31)_"v")
   d $$$setTagX(.handle,s)
   d $$$setTagX(.handle,"005    "_##class(Util).date005())
   
   ; zoradit podla cisla tagu
   d ##class(User.MARC).sortLinesX(.handle)
   ; 11.11.10 tt; pradan nazev databaze pro pripad, ze by nebyl definovany
   d ##class(User.MARC).recordSetupClassX(.handle,"CavUnEpca")
   d ##class(User.MARC).recordSetupT001X(.handle,"new")
   s sc=##class(User.MARC).writeX(.handle)
   if $$$ISERR(sc) 
   {
     s pPomErr=##class(User.Util).status2str(sc) ; ulozime chybovou hlasku pro pridani
     q 0
   }
   
   q 1
]]></Implementation>
</Method>

<Method name="getTypZaznamuAkZbornik">
<Description><![CDATA[
<pre>V pripade ze zaznam je takeho typu, ze by mal obsahovat zbornik
tak vrati typ zaznamu
inak vrati ""

T.j. pokial je return value neprazdne a zaznam obsahuje 463 potom v nom by mal
byt odkaz na zbornik.
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
  ; OKI vyzera, ze zaznam este nie je previazany na zdrojovy dokument
  ; zistime ci je to zbornik (podla 4.casti defaultneho formulara - pokial je tam jeden
  ; z vymenovanych - je to zbornik - inak je to zdrojove preriodikum)
  s sSbornik=##class(MARC).getTagX(.handle,"C99d")
  if (sSbornik'="")
  {
    s sSbornik=$p(sSbornik,"_",4)
    if ((sSbornik'="A2") && (sSbornik'="C") && (sSbornik'="K") && (sSbornik'="M") && (sSbornik'="R2") && (sSbornik'="T2")) 
    {
        s sSbornik=""
    }
  }
  
  q sSbornik
]]></Implementation>
</Method>

<Method name="createAuthLinks463fix102a">
<Description>
Toto je specialny fixup - pre CAV - pokial mame vyplnene 463/001 a v zazname
clanku nie je 102a - dotiahneme 102a dovnutra clanku zo zaznamu SZP

pokial uz v nasom zazname 102a je alebo ak nie je v SZP nedeje sa nic

22.03.07 rs</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    s sTagKr="102",sTagSTKr=sTagKr_"a"
    ; krajina vydania - ak je vyplnena nerobime nic
    s sT102a=##class(MARC).getTagX(.handle,sTagSTKr) q:sT102a'=""
    ; odkaz na SZP - ak ho nemame opat nerobime nic
    s sSZPKey=##class(MARC).getTagX(.handle,"463/001") q:sSZPKey=""
    
    ; nacitame zaznam SZP
    if '##class(MARC).readLX(.handleSZP,sSZPKey) q
    ; a z neho krajinu - ak by nebola - opat nic
    s sT102=##class(MARC).getTagX(.handleSZP,sTagKr) q:sT102=""
    
    ; & nastavime ju do naseho zaznamu - preberieme obsah 102 1:1
    ; nielen 102a
    ; so situaciou ze by nahodou v nasom zazname boli ine podpolia v 102 ako
    ; v SZP zatial nepocitame - nemala by nastat
    d ##class(MARC).setTagX(.handle,sT102)
]]></Implementation>
</Method>

<Method name="createAuthLinks463">
<Description><![CDATA[
<pre>Generovanie autoritnych zaznamov - cast spracuvajuca tag 463
Generovanie je detailne popisane v https://cosmo2/wiki/index.php/Cust:CAV
Pri zmenach aktualizovat wiki clanok!!

11.11.10 tt; udelany upravy pro spravne vytvoreni SZP a pripadne predani hlasky
13.03.08 rs; upresnena kontrola na prazdne ISSN (ak zacina na "n/N" berie sa ako neuvedene)
22.03.07 rs; pridana kontrola na nazov="-" alebo "." to je fiktivny nazov dodany programom
             male upravy komentarov
23.01.07 rs; oddelenie od createAuthLinks
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s s463=##class(MARC).getTagX(.handle,"463"),sClass=$$$HandleClass(handle)
  ; 19.11.15 tt; osetreni generovani 463 u ohlasu pro CavUnOhlCat
  s:($$$HandleClass(handle)="CavUnOhlCat") sClass="CavUnEpca"
  
  if s463="" q ""
  if '##class(MARC).t4xx2handle(.handle4,s463) q "createAuthLinks463: error loading 463 to handle"
  
  ; mame uz link? ak ano nic nerobit
  s sSZPKey=$$$HandleT001(handle4)
  if sSZPKey'="" 
  {
      ; toto je specialny fixup - pre CAV - pokial mame vyplnene 463/001 a v zazname
      ; nie je 102a - dotiahneme 102a dovnutra zo SZP
      ; 
      ; 24.04.07 rs; v podsate to tu netreba robi sa v ramci cistenia autorit
      d ..createAuthLinks463fix102a(.handle)
      q ""
  }
  
  ; podtyp zaznamu A2,K,M,... ak zaznam obsahuje zbornik
  s sSbornik=..getTypZaznamuAkZbornik(.handle)
  
  s sIBSN=##class(MARC).getTagX(.handle4,"010a")
  s sISSN=##class(MARC).getTagX(.handle4,"011a")
  s:(sISSN="") sISSN=##class(MARC).getTagX(.handle4,"011e")
  s sNazev=##class(MARC).getTagX(.handle4,"200a")
  
  ; ak to 
  ;        A, nie je zbornik && nemame ISSN
  ; alebo  B, je prazdny nazov (alebo nazov = "-")
  ; 
  ; => nerob nic
  ; 22.03.07 rs; pridana kontrola na nazov="-" alebo "." to je fiktivny nazov dodany programom
  ; 13.03.08 rs; upresnena kontrola na prazdne ISSN (ak zacina na "n/N" berie sa ako neuvedene)
  ; 
  s bHaveNoTitle=(sNazev="")  || (sNazev="-") || (sNazev=".")
  s sISSN1Letter=$zcvt($e(sISSN),"U")
  s bHaveNoISSN=(sISSN="") || (sISSN1Letter="N")
  ; 
  if (bHaveNoISSN && (sSbornik="")) || (bHaveNoTitle) q ""
  
  
  s sLName=##class(Util).objectName2lname(sClass)
  if sLName="" q "ERR009#"_sClass
      
  ; OK zistime ci zaznam, ktory by sme tu mali vygenerovat existuje
  if (sSbornik="") 
  {
      ; je to periodikum
      if sISSN="" zt "X" ; poistka
      s issnT=" "_$zcvt(sISSN,"L")
      
      ; issns obsahuje 011a pre SZP zaznamy
      s id=$o(^$$$MarcIndexG(sClass,"issns",issnT,""))
  }
  else
  { 
      ; je to zbornik
      ; 08.03.07 rs; uprava na pouzitie funkcie getDupCheckKey()
      s sXD1=..getDupCheckKey(.handle4,"bxxs")
      s id=$o(^$$$MarcIndexG(sClass,"xd1"," "_sXD1,""))  
  }  
  
  ; 26.01.07 rs; TMP riesenie situacie kde zbornik nema ISSN/ISBN
  ;               a ma rovnaky nazov
  if id,sSbornik'="",sISSN="",sIBSN=""
  {
      ; zbornik uz existuje & prazdne ISSN/ISBN
      ; tak negenerovat 001-ku
      q ""
  }
  
  
  if (id) 
  {
      ; OK zbornik uz existuje - v handle4 je zapisany zbornik
      ; ale nie je v nom vyplnena 463/001-ka
      d ##class(MARC).recordSetupT001X(.handle4,##class(MARC).getT001(id))
      s sLName=##class(Util).objectName2lname(##class(MARC).getCLASS(id))
      ; 19.11.15 tt; osetreni generovani 463 u ohlasu pro CavUnOhlCat
      s:($$$HandleClass(handle)="CavUnOhlCat") sLName="cav_un_epca"
      if sLName="" q "ERR009#"_sClass
      d ##class(MARC).recordSetupClassX(.handle4,sLName)
  }
  else  
  {
      ; zbornik este neexistuje a su splnene podmienky na jeho vygenerovanie
      ; 
      ; 10.03.06 lp; do 999b ulozit pracovni skupinu toho, kdo zaznam vytvoril
      s sWGrp=$tr(##class(MARC).getTagX(.handle,"C26e"),"-")
          
      ; vygenerovat zaznam
      ; spravime si kopiu obsahu 4xx pretoze zapisova metoda bude handle modifikovat
      d ##class(MARC).mergeX(.handle4b,.handle4)

      ; zaznam sa nenasiel generujeme SZP
      s zemeSZP=##class(MARC).getTagX(.handle,"102")
      if zemeSZP'="" d ##class(MARC).setTagX(.handle4b,zemeSZP)
      ; 11.11.10 tt; udelany upravy pro spravne vytvoreni SZP a pripadne predani hlasky
      s sPomErr=""
      d ##class(MARC).recordSetupClassX(.handle4b,sClass)
      ; 30.10.15 tt; do generovani zaznamu pridano doplneni autora 999e
      s sUser=$$$getTagX(.handle,"999e")                ; ziskam si autora zaznamu
      if '..createAuthLinks463genSZP(.handle4b,sSbornik'="",sWGrp,.sPomErr,sUser) q "createAuthLinks463: error generating SZP record"_"#  "_sPomErr
            
      ; OK mame vygenerovany zaznam zbornika - v handle4b je zapisany zbornik
      ; a je v nom ak kod noveho zbornika
      ; tento potrebujeme pridat do 463 tagu
      d ##class(MARC).recordSetupT001X(.handle4,$$$HandleT001(handle4b))
      d ##class(MARC).recordSetupClassX(.handle4,sLName)
  }
  
  ; OK zlozime 463 naspat a zapiseme do povodneho zaznamu
  ; pozor pokial sa len doplnilo 463/001 - zatial sa nespravilo precistenie udajov 
  ; vo vnutri 463 - to sa spravi v ramci cistenia autorit v dalsom kroku
  ; 24.11.15 tt; oprava, aby se nedotahovali Uxx pole do 4xx zaznamu
  d ##class(User.MARC).delTagX(.handle4,"U**")
  s s463=##class(MARC).handle2t4xx(.handle4,$e(s463,1,3)_$e(s463,5,6)) 
  
  if s463="" zt "XX" ; poistka
  d ##class(MARC).setTagX(.handle,s463)
  
  s sU63=$$$getTagX(.handle,"U63") 
  if ((sU63'="")&&('$f(sU63,($c(31)_"3"))))
  { ; 25.01.17 tt; dogenerovan link do U63 pri doplneni noveho
    s sST3=##class(User.MARC).getTag4xx(s463,"001.")
    s:(sST3="") sST3=##class(User.MARC).getTag4xx(s463,"001")
    d:(($l(sU63)>9)&&(sST3'="")) $$$setTagX(.handle,sU63_$c(31)_"3"_sST3)  
  }
  
  ; fixup krajiny zo SZP - ak by nahodou v clanku nebola vyplnena
  ; 24.04.07 rs; v podsate to tu netreba robi sa v ramci cistenia autorit
  d ..createAuthLinks463fix102a(.handle)
  
  ; OK
  q ""
]]></Implementation>
</Method>

<Method name="createAuthLinks7xx">
<Description><![CDATA[
<pre>Generovanie autoritnych zaznamov - cast spracuvajuca tag 7xx

22.06.10 tt; opravena podminka pro C06
31.05.10 tt; odstraneno doplneni hodnoty "XX" do pole autority C06y 
13.03.09 rs; pre generovane autority s vyplnenym pracoviskom nastavit 969f=ACTV
24.01.07 rs; oddelenie od createAuthLinks
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sClass=##class(MARC).recordClassX(.handle),err=""
  s sAuthClass=##class(Util).getClassPrefixParam(sClass)_"UnAuth"
  s sAuthLName=##class(Util).objectName2lname(sAuthClass) zt:sAuthLName="" "X"

  ; projdeme vsechny tagy 70x a doplnime chybejici $3
  s sAu=##class(MARC).getTagX(.handle,"70*",-1)
  s c=$l(sAu,$c(10)), err=""
  s:sAu="" c=0
  f i=1:1:c 
  {
    s sAu1=$p(sAu,$c(10),i) 
    s l3=##class(MARC).getSubTagStr(sAu1,"3")
    ; pokud existuje $3, nemusim nic delat
    if l3'="" continue
    
    ; poskladat termin pro vyhledani v indexu "prau"
    s la=$$$trim(##class(MARC).getSubTagStr(sAu1,"a"))
    if la="" continue
    s lb=$$$getSubTagStr(sAu1,"b")
    s lo=$$$getSubTagStr(sAu1,"o")
    s lp=$$$getSubTagStr(sAu1,"p")
    s ly=$$$getSubTagStr(sAu1,"y")
    ; 13.12.19 tt; doplneny oddeleni
    s li=$$$getSubTagStr(sAu1,"i")
    s lj=$$$getSubTagStr(sAu1,"j")
    s lk=$$$getSubTagStr(sAu1,"k")
    s ll=$$$getSubTagStr(sAu1,"l")
    
    ; mel by tam byt bud kod pracoviste nebo zeme
    s lc=lp 
    if lc="" s lc=ly if lc="" s lc="xx"
    
    s sTerm=la
    if lb'="" s sTerm=$$$trim(sTerm_" "_lb)
    s sTerm=lc_" "_sTerm
    set sTerm=##class(SPIndex).ixAddTermFix(sTerm)
    set sTerm=##class(SPIndex).ixAddTermFixLength(sTerm)
    s sTerm=" "_$zcvt(sTerm,"L")
    
    ; vyhledat termin v autoritnim indexu "prau"
    if $d(^$$$MarcIndexG(sAuthClass,"prau",sTerm)) 
    {
      ; autorita existuje, staci jen doplnit link
      s idA=$o(^$$$MarcIndexG(sAuthClass,"prau",sTerm,""))
      s l3=sAuthLName_"*"_##class(MARC).getT001(idA)
      
      ; 12.09.06 lp; doplnene dotahovani oddeleni a zeme z autority do EPCA zaznamu
      if ##class(MARC).getDATAX(.ahandle,idA) 
      {
        s tc06=##class(MARC).getTagX(.ahandle,"C06")
        s lo=##class(MARC).getSubTagStr(tc06,"h")
        s sAu1=##class(MARC).setSubTagStr(sAu1,$c(31)_"o"_lo)
        s ly=##class(MARC).getSubTagStr(tc06,"y")
        s sAu1=##class(MARC).setSubTagStr(sAu1,$c(31)_"y"_ly)
      }
    }
    else 
    {
      ; autorita neexistuje, zalozit novou a doplnit link na ni
      s date=##class(Util).date()
      s t200="200  1 "_$c(31)_"a"_la
      s:lb'="" t200=t200_$c(31)_"b"_lb
      s tc06="C06    "
      ; 31.05.10 tt; odstraneno doplneni hodnoty "XX" do pole autority C06y 
      ;if lp="",ly="" s ly="XX"
      s:lp'="" tc06=tc06_$c(31)_"d"_lp
      ; 02.08.06 lp; doplnene oddeleni pro pracoviste autora
      s:lo'="" tc06=tc06_$c(31)_"h"_lo
      s:ly'="" tc06=tc06_$c(31)_"y"_ly
      ; 13.12.19 tt; doplneny oddeleni u generovani nove autority
      s:li'="" tc06=tc06_$c(31)_"i"_li
      s:lj'="" tc06=tc06_$c(31)_"j"_lj
      s:lk'="" tc06=tc06_$c(31)_"k"_lk
      s:ll'="" tc06=tc06_$c(31)_"l"_ll
      
      d ##class(MARC).newX(.ahandle,sAuthClass,"new")
      d ##class(MARC).setTagX(.ahandle,"000    00542nx   22001813  45")
      s t005=##class(MARC).genT005("1")
      d ##class(MARC).setTagX(.ahandle,t005)
      d ##class(MARC).setTagX(.ahandle,"100    "_$c(31)_"a"_date_"aczey0103    ba")
      d ##class(MARC).setTagX(.ahandle,"152    "_$c(31)_"aAACR2")
      d ##class(MARC).setTagX(.ahandle,t200)
      d ##class(MARC).setTagX(.ahandle,"801    "_$c(31)_"aCZ"_$c(31)_"bCAV"_$c(31)_"c"_date)
      
      ; 13.03.09 rs; pre generovane autority s vyplnenym pracoviskom nastavit 969f=ACTV
      s s969f="A"
      if lp'="" s s969f="ACTV" 
      
      d ##class(MARC).setTagX(.ahandle,"969    "_$c(31)_"f"_s969f)
      
      ; 30.10.15 tt; do generovani zaznamu pridano doplneni autora 999e
      s sTCat999e=$$$getTagX(.handle,"999e")                ; ziskam si autora zaznamu
      s:(sTCat999e'="") sTCat999e=$c(31)_"e"_sTCat999e       
      d ##class(MARC).setTagX(.ahandle,"999    "_$c(31)_"a1"_$c(31)_"bCAV"_$c(31)_"d"_"sys-"_date_sTCat999e)
      ; 22.06.10 tt; opravena podminka pro C06
      d:(tc06'="C06    ") ##class(MARC).setTagX(.ahandle,tc06)
      d ##class(MARC).setTagX(.ahandle,"C99    "_$c(31)_"dDFLT_UN_AUTH_200")
      s st=##class(MARC).writeX(.ahandle,1)
      if $$$ISERR(st) s err="ERRW001#"_sAuthClass_"/new#"_##class(Util).status2str(st) q

      s l3=sAuthLName_"*"_##class(MARC).recordT001X(.ahandle)
    }
    
    ; zapsat link zpatky do 7xx v EPCA zaznamu
    s sAu1=##class(MARC).setSubTagStr(sAu1,$c(31)_"3"_l3)
    s $p(sAu,$c(10),i)=sAu1
  }
  ; zapsat vsechno zpet do handle
  d:sAu'="" ##class(MARC).setTagX(.handle,sAu)
  
  q err
]]></Implementation>
</Method>

<Method name="createAuthLinksC20">
<Description><![CDATA[
<pre>Generovanie autoritnych zaznamov - cast spracuvajuca tag C20

24.01.07 rs; oddelenie od createAuthLinks
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sClass=##class(MARC).recordClassX(.handle),err=""
  s sAuthClass=##class(Util).getClassPrefixParam(sClass)_"UnAuth"
  s sAuthLName=##class(Util).objectName2lname(sAuthClass) zt:sAuthLName="" "X"
  
  ; projdeme vsechny tagy C20 a doplnime chybejici $3
  s sAu=##class(MARC).getTagX(.handle,"C20",-1)
  s c=$l(sAu,$c(10)), err=""
  s:sAu="" c=0
  f i=1:1:c 
  {
    s sAu1=$p(sAu,$c(10),i) 
    s l3=##class(MARC).getSubTagStr(sAu1,"3")
    ; pokud existuje $3, nemusim nic delat
    if l3'="" continue
    
    
    s la=$$$trim(##class(MARC).getSubTagStr(sAu1,"a"))
    if la="" continue
    s x210="210 12 "_$c(31)_"a"_la
    s x410=""  ; 21.11.05 mk
    s la=##class(MARC).getSubTagStr(sAu1,"c")
    s:la'="" x210=x210_$c(31)_"c"_la
    s la=##class(MARC).getSubTagStr(sAu1,"d")
    s:la'="" x210=x210_$c(31)_"d"_la
    s la=##class(MARC).getSubTagStr(sAu1,"e")
    s:la'="" x210=x210_$c(31)_"e"_la
    s la=##class(MARC).getSubTagStr(sAu1,"f")
    s:la'="" x210=x210_$c(31)_"f"_la
    s la=##class(MARC).getSubTagStr(sAu1,"s")
    s:la'="" x210=x210_$c(31)_"s"_la
    s la=##class(MARC).getSubTagStr(sAu1,"g")
    s:la'="" x210=x210_$c(31)_"9"_la
    ; 21.11.05 mk; doplnene dotahovanie prekladu r
    s la=##class(MARC).getSubTagStr(sAu1,"r")
    ; 06.12.05 lp; doplneny chybejici znak $c(31) pred "8eng"
    s:la'="" x410="410 12 "_$c(31)_"a"_la_$c(31)_"8eng"


    ; zalozit fiktivni handle
    d ##class(MARC).newX(.xdhandle,sAuthClass,"new")
    d ##class(MARC).setTagX(.xdhandle,x210)
    
    s sTerm=" "_$zcvt(##class(CavUnAuth).getDupChkKey(.xdhandle),"L")
    k xdhandle
    
    ; vyhledat termin v autoritnim indexu "xd1"
    if $d(^$$$MarcIndexG(sAuthClass,"xd1",sTerm)) 
    {
      ; autorita existuje, staci jen doplnit link
      s idA=$o(^$$$MarcIndexG(sAuthClass,"xd1",sTerm,""))
      s l3=sAuthLName_"*"_##class(MARC).getT001(idA)
    }
    else 
    {
      ; autorita neexistuje, zalozit novou a doplnit link na ni
      s date=##class(Util).date()
      s tc16=""
      s ll=##class(MARC).getSubTagStr(sAu1,"l")
      s lp=##class(MARC).getSubTagStr(sAu1,"p")
      if (ll'="")||(lp'="") 
      {
        s tc16="C16    "
        s:ll'="" tc16=tc16_$c(31)_"a"_ll
        s:lp'="" tc16=tc16_$c(31)_"g"_lp
      }
      
      d ##class(MARC).newX(.ahandle,sAuthClass,"new")
      d ##class(MARC).setTagX(.ahandle,"000    00542nx   22001813  45")
      s t005=##class(MARC).genT005("1")
      d ##class(MARC).setTagX(.ahandle,t005)
      d ##class(MARC).setTagX(.ahandle,"100    "_$c(31)_"a"_date_"aczey0103    ba")
      d ##class(MARC).setTagX(.ahandle,"152    "_$c(31)_"aAACR2")
      d ##class(MARC).setTagX(.ahandle,x210)
      d:x410'="" ##class(MARC).setTagX(.ahandle,x410)  ; 21.11.05 mk doplneny zapis 410
      d ##class(MARC).setTagX(.ahandle,"801    "_$c(31)_"aCZ"_$c(31)_"bCAV"_$c(31)_"c"_date)
      d ##class(MARC).setTagX(.ahandle,"969    "_$c(31)_"fA")

      ; 30.10.15 tt; do generovani zaznamu pridano doplneni autora 999e
      s sTCat999e=$$$getTagX(.handle,"999e")                ; ziskam si autora zaznamu
      s:(sTCat999e'="") sTCat999e=$c(31)_"e"_sTCat999e       
      
      d ##class(MARC).setTagX(.ahandle,"999    "_$c(31)_"a1"_$c(31)_"bCAV"_$c(31)_"d"_"sys-"_date_sTCat999e)
      d:tc16'="" ##class(MARC).setTagX(.ahandle,tc16)
      d ##class(MARC).setTagX(.ahandle,"C99    "_$c(31)_"dDFLT_UN_AUTH_210_A")
      s st=##class(MARC).writeX(.ahandle,1)
      if $$$ISERR(st) s err="ERRW001#"_sAuthClass_"/new#"_##class(Util).status2str(st) q

      s l3=sAuthLName_"*"_##class(MARC).recordT001X(.ahandle)
    }
    
    ; zapsat link zpatky do 7xx v EPCA zaznamu
    s sAu1=##class(MARC).setSubTagStr(sAu1,$c(31)_"3"_l3)
    s $p(sAu,$c(10),i)=sAu1
  }
  
  ; zapsat vsechno zpet do handle
  d:sAu'="" ##class(MARC).setTagX(.handle,sAu)
  q err
]]></Implementation>
</Method>

<Method name="createAuthLinksC12">
<Description><![CDATA[
<pre>Generovanie autoritnych zaznamov - cast spracuvajuca tag C12

27.02.14 tt; upraveno generovani projeku - aby se generovali projektu i pokud je projek mimo CEP
24.01.07 rs; oddelenie od createAuthLinks
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sClass=##class(MARC).recordClassX(.handle),err=""
  s sAuthClass=##class(Util).getClassPrefixParam(sClass)_"UnAuth"
  s sAuthLName=##class(Util).objectName2lname(sAuthClass) zt:sAuthLName="" "X"
  
  ; projdeme vsechny tagy C12 a zkontrolujeme cisla projektu
  s sProj=##class(MARC).getTagX(.handle,"C12",-1)
  s c=$l(sProj,$c(10)), err=""
  s:sProj="" c=0
  f i=1:1:c 
  {
    s sProj1=$p(sProj,$c(10),i) 
    
    
    ; 10.01.06 jj; v pripade existence c12c (neni to projekt cep)
    ;              nevytvaret autoritu projektu
    s lc=##class(MARC).getSubTagStr(sProj1,"c")
    ; 27.02.14 tt; upraveno generovani projeku - aby se generovali projektu i pokud je projek mimo CEP    
    ;if (lc'="") continue
    
    s la=$$$trim(##class(MARC).getSubTagStr(sProj1,"a"))
    ; 22.11.05 lp; doplnene odfiltrovani nezadoucich znaku
    ;              a orezani dlouhych terminu
    set sTerm=##class(SPIndex).ixAddTermFix(la)
    set sTerm=##class(SPIndex).ixAddTermFixLength(sTerm)
    if sTerm="" continue

    ; 14.09.05 lp; doplneni zapomenuteho prevodu na mala pismena
    s sTerm=" "_$zcvt(sTerm,"L")
    
    ; vyhledat termin v autoritnim indexu "proj"
    if '$d(^$$$MarcIndexG(sAuthClass,"proj",sTerm)) 
    {
      ; autorita neexistuje, zalozit novou
      s date=##class(Util).date()
      s t230="230    "_$c(31)_"a-"_$c(31)_"h"_la
      
      ; 07.12.05 lp; ukladat i dalsi udaje o projektu do UNA_C28
      s lb=##class(MARC).getSubTagStr(sProj1,"b")
      ; s lc=##class(MARC).getSubTagStr(sProj1,"c") // viz vyse
      s le=##class(MARC).getSubTagStr(sProj1,"e")
      if lb_lc_le'="" 
      {
        s tc28="C28    "
        s:lb'="" tc28=tc28_$c(31)_"a"_lb
        s:lc'="" tc28=tc28_$c(31)_"b"_lc
        s:le'="" tc28=tc28_$c(31)_"c"_le
      }
      else { s tc28="" }
      
      d ##class(MARC).newX(.ahandle,sAuthClass,"new")
      d ##class(MARC).setTagX(.ahandle,"000    00240nx   22001213  450")
      s t005=##class(MARC).genT005("1")
      d ##class(MARC).setTagX(.ahandle,t005)
      d ##class(MARC).setTagX(.ahandle,"100    "_$c(31)_"a"_date_"aczey0103    ba")
      d ##class(MARC).setTagX(.ahandle,"152    "_$c(31)_"aAACR2")
      d ##class(MARC).setTagX(.ahandle,t230)
      d ##class(MARC).setTagX(.ahandle,"801    "_$c(31)_"aCZ"_$c(31)_"bCAV"_$c(31)_"c"_date)
      d ##class(MARC).setTagX(.ahandle,"969    "_$c(31)_"fA")
      d ##class(MARC).setTagX(.ahandle,"980    "_$c(31)_"xG")
      d:tc28'="" ##class(MARC).setTagX(.ahandle,tc28)

      ; 30.10.15 tt; do generovani zaznamu pridano doplneni autora 999e
      s sTCat999e=$$$getTagX(.handle,"999e")                ; ziskam si autora zaznamu
      s:(sTCat999e'="") sTCat999e=$c(31)_"e"_sTCat999e       
      d ##class(MARC).setTagX(.ahandle,"999    "_$c(31)_"a1"_$c(31)_"bCAV"_$c(31)_"d"_"sys-"_date_sTCat999e)
      d ##class(MARC).setTagX(.ahandle,"C99    "_$c(31)_"dDFLT_UN_AUTH_230")
      
      s st=##class(MARC).writeX(.ahandle,1)
      if $$$ISERR(st) s err="ERRW001#"_sAuthClass_"/new#"_##class(Util).status2str(st) q
    }
    
  }
  q err
]]></Implementation>
</Method>

<Method name="createAuthLinksC63">
<Description><![CDATA[
<pre>Generovanie autoritnych zaznamov - cast spolupracujici insituce v tagu C63

SR_NazovSpoluprace-410_a;  SR_NazovSpolupraceOrg-210_a, SR_ZemeSpoluprace-980_e, SR_MistoSpoluprace-980_b
C63    $$3cav_un_auth*0291603$$aAMU$$bAkademie múzických umění v Praze$$eSK$$fBrno
27.10.13 tt; pridana definice promennych kvuli situaci, kdy nemusi byt definovane
17.10.13 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sClass=##class(MARC).recordClassX(.handle),err=""
  s sAuthClass=##class(Util).getClassPrefixParam(sClass)_"UnAuth"
  s sAuthLName=##class(Util).objectName2lname(sAuthClass) zt:sAuthLName="" "X"
  
  s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3)
    
    if (sTag="C63")
    {
      s sC6313=$$$trim($$$getSubTagStr(lsLine,"3"))
      continue:(sC6313'="")    ; pokud jiz mame vazbu, nema smysla zpracovavat
      s sC631a=$$$trim($$$getSubTagStr(lsLine,"a"))
      s sC631b=$$$trim($$$getSubTagStr(lsLine,"b"))
      s sC631e=$$$trim($$$getSubTagStr(lsLine,"e"))
      s sC631f=$$$trim($$$getSubTagStr(lsLine,"f"))
      s sTerm=##class(SPIndex).ixAddTermFix(sC631b)
      s sTerm=##class(SPIndex).ixAddTermFixLength(sTerm)
      continue:((sTerm="")||((sC631b="")&&(sC631e=""))) ; pokdu nemame nazev, nezpracovavame. Je to zrejme nejaka blbost 
      s sTerm=" "_$zcvt(sTerm,"L")
      s sT001=""
      
      ; vyhledat termin v autoritnim indexu "a210i" - pokud neni, zalozime
      if '$d(^$$$MarcIndexG(sAuthClass,"a210i",sTerm)) 
      {
        ; autorita neexistuje, zalozit novou
        s date=##class(Util).date()
        ; 27.10.13 tt; pridana definice promennych kvuli situaci, kdy nemusi byt definovane
        s t210="",t410=""
        s:(sC631b'="") t210="210 02 "_$c(31)_"a"_sC631b
        s:(sC631a'="") t410="410 02 "_$c(31)_"a"_sC631a
        s s980="980    "_$c(31)_"xI"
        s:(sC631e'="") s980=s980_$c(31)_"e"_sC631e
        s:(sC631f'="") s980=s980_$c(31)_"f"_sC631f
      
        d ##class(MARC).newX(.ahandle,sAuthClass,"new")
        d $$$setTagX(.ahandle,"000    00542nx   22001813  45 ")
        s t005=##class(MARC).genT005("1")
        d $$$setTagX(.ahandle,t005)
        d $$$setTagX(.ahandle,"100    "_$c(31)_"a"_date_"aczey0103    ba")
        d $$$setTagX(.ahandle,"152    "_$c(31)_"aAACR2")
        d:(t210'="") $$$setTagX(.ahandle,t210)
        d:(t410'="") $$$setTagX(.ahandle,t410)
        d $$$setTagX(.ahandle,"801    "_$c(31)_"aCZ"_$c(31)_"bCAV"_$c(31)_"c"_date)
        d $$$setTagX(.ahandle,s980)
        ; 30.10.15 tt; do generovani zaznamu pridano doplneni autora 999e
        s sTCat999e=$$$getTagX(.handle,"999e")                ; ziskam si autora zaznamu
        s:(sTCat999e'="") sTCat999e="999    "_$c(31)_"e"_sTCat999e       
        d:(sTCat999e'="") $$$setTagX(.ahandle,sTCat999e)
        d $$$setTagX(.ahandle,"C99    "_$c(31)_"dDFLT_UN_AUTH_210_I")
        s st=##class(MARC).writeX(.ahandle)
        if $$$ISERR(st) s err="ERRW001#"_sAuthClass_"/new#"_##class(Util).status2str(st) q
        s sT001=sAuthLName_"*"_$$$HandleT001(ahandle)
        
      }
      else
      {
        s idx=""
        s idx=$o(^$$$MarcIndexG(sAuthClass,"a210i",sTerm,idx))
        q:idx=""
        s sT001=sAuthLName_"*"_##class(MARC).getT001(idx)
      }
      if (sT001'="")
      { ; pokud mame hodnotu linku, vlozime ji do zaznamu
        s lsLine=$$$setSubTagStr(lsLine,$c(31)_"3"_sT001)   
        d ##class(User.MARC).setLineX(.handle,i,lsLine) ; zapsani to radku
      }
    }  
  }  
  q err
]]></Implementation>
</Method>

<Method name="createAuthLinks">
<Description><![CDATA[
<pre>Generovanie autorit v ramci allowSave


17.10.13 tt; doplneno generovani spolupracujici insituce z tagu C63
24.01.07 rs; rozdelenie na metody; prepisanie generovania subornych zaznamov periodik
10.01.07 jj; osetreni podminky pro generovani sborniku
09.01.07 jj; rozsireni generovani autorit sborniku
15.09.06 jj; nastaveni priznaku 969f=A jen pro zdrojova per.
12.09.06 lp; doplnene dotahovani oddeleni a zeme z autority do EPCA zaznamu
...
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret=..createAuthLinks7xx(.handle)     q:ret'="" ret
  s ret=..createAuthLinksC20(.handle)     q:ret'="" ret
  s ret=..createAuthLinksC12(.handle)     q:ret'="" ret
  s ret=..createAuthLinks463(.handle)     q:ret'="" ret
  /// 17.10.13 tt; doplneno generovani spolupracujici insituce z tagu C63
  s ret=..createAuthLinksC63(.handle)     q:ret'="" ret
  
  q ""
]]></Implementation>
</Method>

<Method name="BibcitSzfAuthors">
<Description><![CDATA[
<pre> Parametry: pPar - parametry oddelene ,. Hodnoty:
                     AEditor - nezkracuji se jmena u editoru
  
02.12.21 tt; pridany parametry do metody, aby se zobrazil link na parametr AutorLink 
09.10.20 tt; pridane prijmeni jako velka pismena, jde to znastavenim zrusit
02.06.16 tt; upravy na zadost cav cs30805 - oddel z  " ; " na "; "             
27.01.11 tt; zvyrazneni a potrzeni domacich autoru + pridani "G"
15.11.07 mk; pridanie bodky na konci ak nie je
11.10.07 mk; riesenie podciarknutia autorov z 702 pre skrateny format 
26.04.05 jj; Autori z 70x.

27.04.05 jj; 700a, 700b ; 701a, 701b ; 701a, 701b ;...; 701a, 701b
             . - 702a, 702b ; 702a, 702b ; ... ; 702a, 702b
             pozn.: editori z 702 se berou jen v prip. $4="340"
28.04.05 jj; Osetreni editoru: brat prijmeni + 1. pismeno z jmena,
             nStyle=1...autori tucne, editory nebrat (shortFormat),
                        nastaveni oddel. autoru na ". - ".
03.05.05 jj; Doplneni vazby pracoviste a podtrzeni v pripade short.
10.01.06 jj; zobrazit autory i v z tagu 702, pro editory navic 
             postfix " (ed.)"
10.03.06 jj; zruseni vnoreneho podtrzeni
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary,sAuthors:%Library.String="",nStyle:%Library.Integer=0,pPar=""</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sRes="",sResE="",sOdd="; ",nLast=1,sResX="",sResXX="", bExG=0, bPouzG=0,sVelP=""
  if (nStyle) {s sOdd=" - ",nLast=0}
  ; 05.03.18 tt; odddelovac pro autory nastaven na ,
  s:($f(","_pPar_",",","_"AutCarka"_",")) sOdd=", "
  ; 09.10.20 tt; pridane prijmeni jako velka pismena, jde to znastavenim zrusit
  s:('$f(","_pPar_",",","_"AutMaleP"_",")) sVelP="U"

  s nPocetAuth=0
    
  ; 27.01.11 tt; pridana podpora zobrazovani G
  if (sAuthors'="") 
  { ; zpracovavame 4xx - nidky nedaveme G
    s bExG=0,bPouzG=1
  }
  else
  { ; muzeme cist z handlu
    s c=0
    d { ; zjistime si, jestli je nekde v zaznamu v podpoli z hodnota G
      s sT70X=$$$getTagXC(.handle,"70*",.c) ; projdu vsechny opakovani
      continue:(sT70X="")
      s sT70Xz=$$$getSubTagStr(sT70X,"z")
      s:($zcvt(sT70Xz,"L")="g") bExG=1
    } while (c'=0)  
  }
  
  // autor z 700
  if (sAuthors'="") { s sRes700=$p(sAuthors,"#",1) }
  else { s sRes700=$$$getTagX(.handle,"700") }
  
  ; 09.10.20 tt; pridana volba prijmeni na velke pismeno
  s sRes=$$$getSubTagStr(sRes700,"a")
  s:(sVelP="U") sRes=$zcvt(sRes,sVelP)
  s sRes7003=$$$getSubTagStr(sRes700,"3")
  s sRes700b=$$$getSubTagStr(sRes700,"b")
  s sRes700p=$$$getSubTagStr(sRes700,"p")
  s sRes7004=$$$getSubTagStr(sRes700,"4")
  s sRes700z=$$$getSubTagStr(sRes700,"z")
     
  s nLast=1
  if (sRes700b'="")
  { 
    // 10.03.06 jj; zruseni vnoreneho podtrzeni
    // if ((sRes700p'="") && (nStyle)) {s sRes=".u."_sRes_"./u."}
    s sRes=sRes_..BibcitSzfCheckLastAut(sRes700b,.nLast,", ")
      
    ; 11.10.07 mk
    if ((sRes7004="340") && (sRes'="")) s sRes=sRes_" (ed.)" ; 11.10.07 mk
   
    if (($f(","_pPar_",",","_"AutorLink"_","))&&(sRes700p'="")&&(sRes7003'=""))
    {      /// 02.12.21 tt; pridany parametry do metody, aby se zobrazil link na parametr AutorLink
       s sRes="<a href=""https://asep-analytika.lib.cas.cz/bibliografie/asep/"_$zcvt(sRes700p,"L")_"/"_$p(sRes7003,"*",2)_""" target=""_blank"" title="""_sRes_""">"_sRes_"</a>"
    }

    ; 27.01.11 tt; zvyrazneni a potrzeni domacich autoru + pridani "G"
    d:(nStyle) ..BibcitSzfAuthorsG(.sRes,.bPouzG,bExG,sRes700z,sRes700p)
      
    //if ((sRes700p'="") && (nStyle)) {s sRes=sRes_..BibcitSzfCheckLast(sRes700b,.nLast,", ",2)}
    //else {s sRes=sRes_..BibcitSzfCheckLast(sRes700b,.nLast,", ")}      
  }  

  // dalsi autori z 701
  if (sAuthors'="") {s sRes701=$p(sAuthors,"#",2)}
  else {s sRes701=##class(MARC).getTagX(.handle,"701",-1)}
    
  s c=$l(sRes701,$c(10))
  f i=1:1:c
  {
    ; 11.03.15 tt; pridana kontrola na pocet uzivatelu pro vytvareni txx tagu  
    s nPocetAuth=nPocetAuth+1
    q:(($g(handle("tmp","getDATAEx","PridaniTxx"))=1)&&(nPocetAuth>500))      
    
    /*
    s sRes701Part=$p(sRes701,$c(10),i)
    s sRes701a=##class(MARC).getSubTagStr(sRes701Part,"a")
    if (sRes701a="") continue
 
    if ('nStyle) s nLast=1
    if (sRes'="")
    { s sRes=sRes_..BibcitSzfCheckLast(sRes701a,.nLast,sOdd)}
    else 
    { s sRes=sRes701a}

    s nLast=1
    s sRes701b=##class(MARC).getSubTagStr(sRes701Part,"b")
    if (sRes701b'="")
    s sRes=sRes_..BibcitSzfCheckLast(sRes701b,.nLast,", ")
    */
    s sRes701Part=$p(sRes701,$c(10),i)
    s sRes701a=$$$getSubTagStr(sRes701Part,"a")
    s:(sVelP="U") sRes701a=$zcvt(sRes701a,sVelP)
    continue:(sRes701a="")
 
    //if ('nStyle) s nLast=1
    s nLast=1 

    s sResXX=sRes701a
      
    s sRes701b=$$$getSubTagStr(sRes701Part,"b")
    if (sRes701b'="") {s sResXX=sResXX_..BibcitSzfCheckLastAut(sRes701b,.nLast,", ")}
    s sRes701p=$$$getSubTagStr(sRes701Part,"p")
    s sRes701z=$$$getSubTagStr(sRes701Part,"z")
    //s nLast=($e(sResXX,$l(sResXX))=".")
      
    ; 11.10.07 mk
    s sRes7014=$$$getSubTagStr(sRes701Part,"4")
    s sRes7013=$$$getSubTagStr(sRes701Part,"3")

    if ((sRes7014="340") && (sResXX'="")) s sResXX=sResXX_" (ed.)" ; 11.10.07 mk
    /// 02.12.21 tt; pridany parametry do metody, aby se zobrazil link na parametr AutorLink
    if (($f(","_pPar_",",","_"AutorLink"_","))&&(sRes701p'="")&&(sRes7013'=""))
    {
       s sResXX="<a href=""https://asep-analytika.lib.cas.cz/bibliografie/asep/"_$zcvt(sRes701p,"L")_"/"_$p(sRes7013,"*",2)_""" target=""_blank"" title="""_sResXX_""">"_sResXX_"</a>"
    }
 
    ;if ((sRes701p'="") && (nStyle)) {s sResXX=".u."_sResXX_"./u."}
    ; 27.01.11 tt; zvyrazneni a potrzeni domacich autoru + pridani "G"
    d:(nStyle) ..BibcitSzfAuthorsG(.sResXX,.bPouzG,bExG,sRes701z,sRes701p,pPar)
    
     
    s nLast=1
    if (sResX'="")
    { s sResX=sResX_..BibcitSzfCheckLastAut(sResXX,.nLast,sOdd)}
    else 
    { s sResX=sResXX}
  }
  if (sResX'="")
  {
    if (sRes'="")
    { s sRes=sRes_..BibcitSzfCheckLastAut(sResX,.nLast,sOdd)}
    else 
    { s sRes=sResX}
  }

  if ('nStyle)
  { // editori z 702 -- proverit interpunkci u editoru
    s nLast=1
    if (sAuthors'="") {s sRes702=$p(sAuthors,"#",3)}
    else {s sRes702=##class(MARC).getTagX(.handle,"702",-1)}
    s c=$l(sRes702,$c(10))
    f i=1:1:c
    {
      ; 11.03.15 tt; pridana kontrola na pocet uzivatelu pro vytvareni txx tagu  
      s nPocetAuth=nPocetAuth+1
      q:(($g(handle("tmp","getDATAEx","PridaniTxx"))=1)&&(nPocetAuth>500))      
         
      s sRes702Part=$p(sRes702,$c(10),i)
      s sRes7024=$$$getSubTagStr(sRes702Part,"4") 
      continue:(sRes7024'="340")
      s sRes702a=$$$getSubTagStr(sRes702Part,"a") 
      s:(sVelP="U") sRes702a=$zcvt(sRes702a,sVelP)
      continue:(sRes702a="")
        
      //if (sRes'="")
      //{ //s sRes=sRes_..BibcitSzfCheckLast("",.nLast,sOdd)}
      //s sRes=sRes_..BibcitSzfCheckLast(sRes702a,.nLast,sOdd)}
      //if (sResE'="") {s sResE=sResE_" ; "}
      //s sResE=sResE_sRes702a
        
      if (sResE'="")
      { s sResE=sResE_..BibcitSzfCheckLastAut(sRes702a,.nLast,sOdd) }
      else 
      { s sResE=sRes702a }
        
       
      s sRes702b=##class(MARC).getSubTagStr(sRes702Part,"b")
      // 28.04.05 jj; osetreni editoru: 
      //              brat prijmeni + 1. pismeno z jmena
      if ((sRes702b'="")&&($f(","_pPar_",",","_"AEditor"_","))) { s sResE=sResE_", "_sRes702b_"."}
      elseif(sRes702b'="") {s sResE=sResE_", "_$e(sRes702b,1,1)_"."}
      s:(sRes7024="340") sResE=sResE_" (ed.)"
    }
    
    // editori
    if (sResE'="")
    { 
      if (sRes="")
      {  
         s sRes=sRes_..BibcitSzfCheckLastAut(sResE,.nLast,"")
      }
      else
      {
        s nLast=($e(sRes,$l(sRes))=".")
        s sRes=sRes_..BibcitSzfCheckLastAut(sResE,.nLast," - ")
      }        
    }
  }
    
  if (nStyle=2) // zpracovat vsechny 702
  {
    s sT702="", prvni=0
    s:(sRes'="") prvni=1
    s sT702All=$$$getTagXC(.handle,"702",-1)
    s c=$l(sT702All,$c(10))
    f i=1:1:c
    {
      ; 11.03.15 tt; pridana kontrola na pocet uzivatelu pro vytvareni txx tagu  
      s nPocetAuth=nPocetAuth+1
      q:(($g(handle("tmp","getDATAEx","PridaniTxx"))=1)&&(nPocetAuth>500))      
      
      s sT702Part=$p(sT702All,$c(10),i)
      s sT702a=$$$getSubTagStr(sT702Part,"a") 
      s:(sVelP="U") sT702a=$zcvt(sT702a,sVelP)
      
      s sT702Partnew=""  ; 11.10.07 mk
      s sT702p=$$$getSubTagStr(sT702Part,"p")
        
      if (sT702a'="") 
      {
        if (prvni) { s sT702Partnew=sT702Partnew_" - " }
        else  { s prvni=1 }
          ;s sT702=sT702_sT702a
          s sT702Partnew=sT702Partnew_sT702a ; 11.10.07 mk do pomocnej premennej
      }  
      s sT702b=$$$getSubTagStr(sT702Part,"b") 
      if (sT702b'="") 
      {
        ;if (sT702a'="") s sT702=sT702_", "
        if (sT702a'="") s sT702Partnew=sT702Partnew_", "
        ;s sT702=sT702_sT702b
        s sT702Partnew=sT702Partnew_sT702b ; 11.10.07 mk do pomocnej premennej
      }  
   
      s sT7024=$$$getSubTagStr(sT702Part,"4") 
      ;if ((sT7024="340") && (sT702a'="")) s sT702=sT702_" (ed.)"
      if ((sT7024="340") && (sT702a'="")) s sT702Partnew=sT702Partnew_" (ed.)" ; 11.10.07 mk
      
      s sT702z=$$$getSubTagStr(sT702Part,"z")   
      ;if sT702p'=""  s sT702Partnew=".u."_sT702Partnew_"./u."  ; pridanie podciarknutia
      ; 27.01.11 tt; zvyrazneni a potrzeni domacich autoru + pridani "G"
      d ..BibcitSzfAuthorsG(.sT702Partnew,.bPouzG,bExG,sT702z,sT702p)
         
         
      s sT702=sT702_sT702Partnew  ; znovupriradenie do hlavnej premennej
    } 
    s:(sT702'="") sRes=sRes_sT702
  }
  
  ; 11.03.15 tt; pridana kontrola na pocet uzivatelu pro vytvareni txx tagu  
  s:(($g(handle("tmp","getDATAEx","PridaniTxx"))=1)&&(nPocetAuth>500)) sRes=sRes_" ... "     
  
  s:(nStyle) sRes=".b."_sRes_"./b."
    
  ; 15.11.07 mk riesenie koncovej bodky ak je sRes vyplneny
  if (($e(sRes,$l(sRes),$l(sRes))'=".") && (sRes'="")) s sRes=sRes_"."      
  
  q sRes                ; vratime zobrazeni
]]></Implementation>
</Method>

<Method name="BibcitSzfAuthorsG">
<Description><![CDATA[
<pre> Metoda pro zvyrazneni autoru
02.12.21 tt; pridany parametry do metody
04.02.14 tt; odstranen garant pri zobrazeni
28.01.11 tt; uprava zvyrazneni a logiky garanta G
27.01.11 tt; zvyrazneni a potrzeni domacich autoru + pridani "G"
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&pRes,&pPouzG,pExG,p70Xz,p70Xp="",pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  ;s bExportRIV=+##class(MARC).getTagX(.handlee,"C26b")
  s sHodG=".sup.G./sup."
  ; 04.02.14 tt; odstranen garant pri zobrazeni
  /*if ((pExG=0)&&(pPouzG=0)&&(p70Xp'=""))
  { ; pokud je domaci a neexistuje G, dodame
    s pRes=pRes_sHodG
    s pPouzG=1
  }
  if ((pExG=1)&&($zcvt(p70Xz,"L")="g"))
  { ; pokud mam vyplnene g,
      s pRes=pRes_sHodG
  }
  */
  s:(p70Xp'="") pRes=".u."_pRes_"./u."
]]></Implementation>
</Method>

<Method name="BibcitSzfAuthorsR">
<Description><![CDATA[
18.03.07 mk; osetrenie bloku autorov 470 na opakovane hiodnoty
26.04.05 jj; Autori z 470/70x.
             <br>
29.04.05 jj; Blizsi popis viz metoda BibcitSzfAuthors().
             <br>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary</FormalSpec>
<Implementation><![CDATA[
  ; 18.03.07 zasadna chyba metody getTag4xx taha len single pole treba rucne nacitat a doplnit  
  s sRes470=##class(MARC).getTagX(.handle,"470") if (sRes470="") q ""
  
  s sAuthors="",sRes470Part700="",sRes470Part701="",sRes470Part702=""
  ;s sRes470Part700=##class(MARC).getTag4xx(sRes470,"700")
  ;s sRes470Part701=##class(MARC).getTag4xx(sRes470,"701")
  ;s sRes470Part702=##class(MARC).getTag4xx(sRes470,"702")
  s pocet1=$l(sRes470,$c(31)_"1") ; pocet casti tagu 470
  
  for l=1:1:pocet1
  {
    s r470=$p(sRes470,$c(31)_"1",l)  ; jeden tag 
    if $e(r470,1,3)="700" s sRes470Part700=r470
    if $e(r470,1,3)="701" 
    {
      if sRes470Part701'="" s sRes470Part701=sRes470Part701_$c(10)_r470
      if sRes470Part701="" s sRes470Part701=r470
    }
    if $e(r470,1,3)="702" 
    {
      if sRes470Part702'="" s sRes470Part702=sRes470Part702_$c(10)_r470
      if sRes470Part702="" s sRes470Part702=r470
    }
  } 
  
  ;s sAuthors=sRes470Part700_$c(10)_sRes470Part701_$c(10)_sRes470Part702
  s sAuthors=sRes470Part700_"#"_sRes470Part701_"#"_sRes470Part702
  
  q ..BibcitSzfAuthors("",sAuthors,0)
]]></Implementation>
</Method>

<Method name="BibcitSzfTagFormat">
<Description><![CDATA[
11.12.07 rs; formalne zmeny (zarovnanie, komentare atd.)
02.05.05 jj; Doplneni par. prefix a odd. opakovani tagu,
             preprac. na zpracovani vsech opak. tagu.
29.04.05 jj; Doplneni moznosti vlozit subtag do "()" : 
             oddelovac "XXX&*&", podpole $a, vysledek "XXX($a)".
28.04.05 jj; Metoda na zformatovani jednoho tagu:
             sTag - cislo tagu ve tvaru "XXX",
             sSubTag - seznam subtagu oddelenych $c(10),
             sOdd - seznam oddelovacu subtagu oddelenych $c(10);
                oddelovacu je tedy o 1 mene nez subtagu,
             sFullTag - pozadovany tag, nacteny uz pred volanim
                BibcitSzfTagFormat(); nepovinny parametr; v pripade,
                ze je neprazdny, par. handle se ignoruje.
---
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary,sTag:%Library.String,sSubTag:%Library.String,sOdd:%Library.String,sFullTag:%Library.String="",sPrefix:%Library.String="",sOddTag:%Library.String=""</FormalSpec>
<Implementation><![CDATA[
  s sRes="",sResX="",sOdd2=""
  s sActTag=sFullTag
   
  s c1=$l(sSubTag,$c(10))
  s c2=$l(sOdd,$c(10))
  if ((c1'=(c2+1)) && (c2<1)) q "ERR_DELIMETERS"
  
  if (sOddTag="")
  {
  
      if (sActTag="") {s sActTag=##class(MARC).getTagX(.handle,sTag)}
      if (sActTag="") q ""
     
      ; prvni podpole - bez oddelovace
      s sRes=##class(MARC).getSubTagStr(.sActTag,$p(sSubTag,$c(10),1))
      
      f i=1:1:c1
      {
        s sActSubTagL=$p(sSubTag,$c(10),i)
        s sActOdd=$p(sOdd,$c(10),i-1)
        
        // 29.04.05 jj; doplneni druheho odd. 
        if ($f(sActOdd,"&*&")) 
        { 
          ; 14.02.07 mk pridana medzera pred ( 
          s sActOdd=##class(Util).strswap(sActOdd,"&*&"," ("),sOdd2=")"
        }
        
        s sActSubTag=##class(MARC).getSubTagStr(.sActTag,sActSubTagL)
        if (sActSubTag'="")
        { 
          if (sRes'="") s sRes=sRes_sActOdd
          
          s sRes=sRes_sActSubTag_sOdd2,sOdd2=""
        }  
      }
 } 
 else 
 {
    // (sOddTag'="")
    // 
    s sActTag=##class(MARC).getTagX(.handle,sTag,-1)
    s c=$l(sActTag,$c(10))
    f i=1:1:c
    {
      s sResPart=$p(sActTag,$c(10),i)
      if (sResPart'="")
      {
        // prvni podpole - bez oddelovace, prip. s sOddTag
        s sRes1=##class(MARC).getSubTagStr(.sResPart,$p(sSubTag,$c(10),1))
        if (sRes1'="")
        {
          if (sResX'="") s sResX=sResX_sOddTag
          s sResX=sResX_sRes1
        }
        
        f j=1:1:c1
        {
          s sActSubTagL=$p(sSubTag,$c(10),j)
          s sActOdd=$p(sOdd,$c(10),j)
          // 29.04.05 jj; doplneni druheho odd. 
          if ($f(sActOdd,"&*&")) 
          { 
            ; 14.02.07 mk pridana medzera pred (
            s sActOdd=##class(Util).strswap(sActOdd,"&*&"," ("),sOdd2=")"
          }
          
          s sActSubTag=##class(MARC).getSubTagStr(.sResPart,sActSubTagL)
          
          if (sActSubTag'="")
          { if (sResX'="") s sResX=sResX_sActOdd
            s sResX=sResX_sActSubTag_sOdd2,sOdd2=""
          }  
        } ; f j=..
      } ; if 
    } ; f i=..
    
  } ; if
  
  if ((sPrefix'="") && (sResX'="")) {s sResX=sPrefix_": "_sResX}
  if (sResX'="") {s sRes=sResX}
  
  q sRes
]]></Implementation>
</Method>

<Method name="getPublicationS">
<Description>
Vydani z 463/210.
Syntaxe:  210a : 210c, 210d        

02.06.16 tt; upravy na zadost cav cs30805 - "nahrazeno " : " za ": " 
26.04.05 jj; 
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary</FormalSpec>
<Implementation><![CDATA[
  s sRes463=##class(MARC).getTagX(.handle,"463")
  if (sRes463="") q ""
  s sRes463210=##class(MARC).getTag4xx(sRes463,"210")
  if (sRes463210="") q ""
 
  q ..BibcitSzfTagFormat(.handle,"210",
    "a"_$c(10)_"c"_$c(10)_"d",": "_$c(10)_", ",sRes463210)
]]></Implementation>
</Method>

<Method name="SzfGrant">
<Description><![CDATA[
18.06.12 tt; prepracovano zobrazovani C12
Grant CEP: C12$b (C12$e) C12$a; C12$b (C12$e) C12$a
nebo
Grant ostatní: C12$c (C12$e) C12$a; C12$c (C12$e) C12$a

04.09.15 tt; do zobrazeni grantu peidano zobrazeni eu grant
26.04.05 jj; Grant z C12.
             <br>
29.04.05 jj; Syntaxe:
             210a : 210c, 210d        
             <br>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary,params=""</FormalSpec>
<Implementation><![CDATA[
  s sResG="",sResGC=""
  s sPar1=$p(params,"-",1)
  
  s sT970b=$$$getTagX(.handle,"970b")
  s sGranty=$$$getTagXC(.handle,"C12",-1)
  s c=$l(sGranty,$c(10))
  f i=1:1:c
  {
    s sGrant=$p(sGranty,$c(10),i)
    s sB=$$$getSubTagStr(sGrant,"b") 
    continue:(sB="")
    s sE=$$$getSubTagStr(sGrant,"e")
    s sA=$$$getSubTagStr(sGrant,"a")
    continue:(sA="")
    if (sResG'="") {s sResG=sResG_"; "}
    s sResG=sResG_sB
    if (sE'="") {s sResG=sResG_"("_sE_")"}
    if (sA'="") {s sResG=sResG_" "_sA}
  }
  if (sResG'="") 
  { 
    s sPrekPrefix=..prekladPrefixuIpac(.handle,"U108",1)     
    s sResGC="\n"_sPrekPrefix_": "_sResG
    s sResG=""
  }
  
  ; 04.09.15 tt; do zobrazeni grantu peidano zobrazeni eu grant
  ; c12$o(C12$e) C12a
  f i=1:1:c
  {
    s sGrant=$p(sGranty,$c(10),i)
    s sB=$$$getSubTagStr(sGrant,"o") 
    s sB=##class(User.Util).sXlate("UN_POSKYT_EU",sB,"N","Cav")
    continue:(sB="")
    s sE=$$$getSubTagStr(sGrant,"e")
    s sA=$$$getSubTagStr(sGrant,"a")
    s sM=$$$getSubTagStr(sGrant,"m")
    continue:(sA="")
    if (sResG'="") {s sResG=sResG_"; "}
    s sResG=sResG_sB
    if (sE'="") {s sResG=sResG_"("_sE_")"}
    if (sA'="") {s sResG=sResG_" "_sA}
    if (sM'="") {s sResG=sResG_" - "_sM}
  }
  if (sResG'="") 
  { 
    s sPrekPrefix=..prekladPrefixuIpac(.handle,"U131",1)     
    s sResGC=sResGC_"\n"_sPrekPrefix_": "_sResG
    s sResG=""
  }
  

  // druhe kolo zbiera "c"-cka
  f i=1:1:c
  {
    s sGrant=$p(sGranty,$c(10),i)
    s sB=$$$getSubTagStr(sGrant,"c") 
    continue:(sB="")
    continue:($$$getSubTagStr(sGrant,"o")'="")
    s sE=$$$getSubTagStr(sGrant,"e")
    s sA=$$$getSubTagStr(sGrant,"a")
    continue:(sA="")
    if sResG'="" s sResG=sResG_"; "
    s sResG=sResG_sB
    if sE'="" s sResG=sResG_"("_sE_")"
    if sA'="" s sResG=sResG_" "_sA    
  }  
  if (sResG'="") 
  {
      s sResGC=sResGC_"\n"_..prekladPrefixuIpac(.handle,"U189",1) _sResG
      s sResG=""
  }  
  
  // zobraxime program
  f i=1:1:c
  { ; 11.10.17 tt; zoprazeni programu pro granty
    s sGrant=$p(sGranty,$c(10),i)
    s sB=$$$getSubTagStr(sGrant,"c") 
    continue:(sB="")
 
    s s3=$$$getSubTagStr(sGrant,"3") 
    continue:(s3="")
    if ##class(User.MARC).readLX(.handlea3,s3)
    { ; pokud se nam podarilo autoritu otevrit
      s s230b=$$$getTagX(.handlea3,"230b")
      continue:(s230b="")
      s:(sResG'="") sResG=sResG_"; "
      s sResG=sResG_s230b
    }
  }  
  if (sResG'="") 
  {
      s sResGC=sResGC_"\n"_..prekladPrefixuIpac(.handle,"U190",1) _sResG
      s sResG=""
  }
  
  s retNavrat=sResGC_sResG
  s:((sPar1="DATA")&&(sT970b="DATA")&&(retNavrat'="")) retNavrat=(" : "_$e(retNavrat,3,9999))

  q:((sPar1="DATA")&&(sT970b'="DATA")) ""
  q (retNavrat)
]]></Implementation>
</Method>

<Method name="BibcitSzfCheckLast">
<Description><![CDATA[
 Kontrola predchoziho posledniho znaku na zaklade
 hodnoty promenne nLast - nekonci-li predchozi text
 znakem "." (nLast=0), znak "." se pripoji.
 
 Na zaklade predchozi hodnoty nLast se urci oddelovac:
               nLast=1 ... ". "_sOdd
               nLast=0 ... " "_sOdd
 Na zaklade posledniho znaku vkladaneho retezce sString
 se nastavi dalsi hodnota nLast (posl. znak je "."
 => nLast=1).
 
 Jestlize posledni znak dosavadniho vystupu (sString)
 je "\n", jako odddelovac se pouzije "".
 Doplneni moznosti zmeny pisma - par. nStyle.
             
29.04.05 jj;
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sString:%Library.String,nLast,sOdd:%Library.String=" ",nStyle:%Library.Integer=0</FormalSpec>
<Implementation><![CDATA[
  s sRes=""
  s sLast=$e(sString,$l(sString))
  if (nLast=-1) {s sOdd="",nLast=1}
  ///if (nStyle'=0) {s sString = $case(nStyle, 1: ".b."_sString_"./b.", 2:".i."_sString_"./i.", 3:".u."_sString_"./u.", :sString)}
  ; 06.03.18 tt; zmena stylu na html
  ;if (nStyle'=0) {s sString = $case(nStyle, 1: "<strong>"_sString_"</strong>", 2:"<em>"_sString_"</em>", 3:".u."_sString_"./u.", :sString)}
  ; 06.08.19 tt; pridano nahrazeno klicoveho ".u." za jine slovo ./emphasis.
  if (nStyle'=0) {s sString = $case(nStyle, 1: "<strong>"_sString_"</strong>", 2:"<em>"_sString_"</em>", 3:".emphasis."_sString_"./emphasis.", :sString)}

  if ('nLast) {s sRes=sRes_"."_sOdd_sString}
  else {s sRes=sRes_sOdd_sString}
  s nLast=(sLast=".")
  if (sLast="\n") s nLast=-1
  q sRes
]]></Implementation>
</Method>

<Method name="BibcitSzfCheckLastAut">
<Description>
15.11.07 mk;  varianta pre vyskladavane terminy medzi ktorymi nesmie byt .
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sString:%Library.String,nLast,sOdd:%Library.String=" ",nStyle:%Library.Integer=0</FormalSpec>
<Implementation><![CDATA[
  s sRes=""
  s sLast=$e(sString,$l(sString))
  if (nLast=-1) {s sOdd="",nLast=1}
  //if (nStyle'=0) {s sString = $case(nStyle, 1: ".b."_sString_"./b.", 2:".i."_sString_"./i.", 3:".u."_sString_"./u.", :sString)}
  ; 06.08.19 tt; pridano nahrazeno klicoveho ".u." za jine slovo ./emphasis.
  if (nStyle'=0) {s sString = $case(nStyle, 1: "<strong>"_sString_"</strong>", 2:"<em>"_sString_"</em>", 3:".emphasis."_sString_"./emphasis.", :sString)}

  if ('nLast) {s sRes=sRes_sOdd_sString}
  else {s sRes=sRes_sOdd_sString}
  s nLast=(sLast=".")
  if (sLast="\n") s nLast=-1
  q sRes
]]></Implementation>
</Method>

<Method name="getBibcitCAVDD">
<Description>
druh dokumentu (z 999$d)
pre ucely ZF</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary</FormalSpec>
<Implementation><![CDATA[
   ; druh dokumentu nemoze byt z 970b nakolko je tam len jednopismenna skratka,
   ; skutocne dvojpismenkove rozdelenie je podla C99d
   s sDruhDok=##class(MARC).getTagX(.handle,"C99d")
   s sDruhDok=$p(sDruhDok,"_",$l(sDruhDok,"_"))  ; zobrat poslednu cast
   if sDruhDok="" s sDruhDok=##class(MARC).getTagX(.handle,"970b")
   q sDruhDok
]]></Implementation>
</Method>

<Method name="getBibcitCAV463">
<Description>
sformatovanie 463 pre bibl.citaciu - bez 463/010,011 (tieto su zvlast)

nLast: vyznam je zamotany viz. BibcitSzfCheckLast (prebrane z povodneho kodu 1:1)

06.12.18 tt; nahrazeni ; za ,
20.03.15 tt; odstranena uprava 463/200v na male pismena z generovany txx tagu pro zobrazeni
22.04.14 tt; uprava bibliograficke citace - vice zmen
11.12.07 rs; oddelene od getBibcitCAV</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&nLast]]></FormalSpec>
<Implementation><![CDATA[
   s sDruhDok=..getBibcitCAVDD(.handle),sRes=""
   
   // zpracovani 463
   s sRes463=##class(MARC).getTagX(.handle,"463")
   
   s sRes463200a=""
   if (sRes463'="")
   { 
     s sRes463200a=##class(MARC).getTag4xx(sRes463,"200a")
     if sRes463200a'=""
     {
        ; 22.04.14 tt; uprava bibliograficke citace - zmenen oddelovac z "," na . u techto druhu dokumentu
        ; 23.06.16 tt; upravy podle  doplneni k ZF - edice - cs30872 - pridana . za
        if ((sDruhDok="A1") || (sDruhDok="J") || (sDruhDok="R1") || (sDruhDok="T1") || (sDruhDok="N")
        || ($f(",U,B,G,H,V,C,K,M,",","_sDruhDok_",")))
        { s sRes463200a=sRes463200a_".." }
         ; 05.03.18 tt; zobrazovat . za nazvam
         s sRes463200a="<em>"_sRes463200a_". </em>"

     }
   }
     
   if (sDruhDok="M") || (sDruhDok="C") || (sDruhDok="K")|| (sDruhDok="A2")
   { ; 06.04.12 tt; zmena pri zobrazovani 463 - doplnen ;
     d ##class(MARC).t4xx2handle(.handle4,sRes463)
     s c=0,s4xx702=""
     d {
       s sT702=$$$getTagXC(.handle4,"702",.c) ; vsetky citacie
       continue:((sT702="")&&(c'=0))
       if (sT702'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sT7024=$$$getSubTagStr(sT702,"4")
         if (sT7024="340") 
         {
           s sT702a=$$$getSubTagStr(sT702,"a")
           ; 09.10.20 tt; pridane prijmeni jako velka pismena, jde to znastavenim zrusit - upraveno nastaveni
           s sT702a=$zcvt(sT702a,"U")
           s sT702b=$$$getSubTagStr(sT702,"b")
           s:(sT702b'="") sT702b=", "_sT702b
           s:(s4xx702'="") s4xx702=s4xx702_", "_sT702a_sT702b
           s:(s4xx702="") s4xx702=sT702a_sT702b
         }
       }
     } while (c'=0)
     
     if (s4xx702'="") 
     { ; pridame text
       //s s4xx702=s4xx702_" (ed.). "
       ; 05.03.18 tt; vzdy zobrazovat editora za , bez ()
       if ($p(s4xx702,",",3,999)'="") { s s4xx702=s4xx702_", eds. " }
       else { s s4xx702=s4xx702_", ed. " }
       s sRes463200a=s4xx702_sRes463200a
     }
   }

   ; odd. je ". " nebo ". In " dle formulare   
   if (sRes463200a'="")
   {   
       if ((sDruhDok="A2") || (sDruhDok="C") || (sDruhDok="K") ||
           (sDruhDok="T2") || (sDruhDok="R2")|| (sDruhDok="M"))
       {
         s sRes=sRes_..BibcitSzfCheckLast(sRes463200a,.nLast," In: ")
         s sRes463200i="",sRes463200h=""
         if (sRes463'="")
         { s sRes463200i=##class(MARC).getTag4xx(sRes463,"200i")}
         if (sRes463200i'="")
         { 
           //s sRes463200i=".i."_sRes463200i_". ./i."
           s sRes=sRes_..BibcitSzfCheckLast(sRes463200i,.nLast,". ",2)
         }
         if (sRes463'="") 
         { s sRes463200h=##class(MARC).getTag4xx(sRes463,"200h")}
         if (sRes463200h'="")
         { 
           if (sDruhDok="C")
           {
             s:('$f($zcvt(sRes463200h,"U"),"VOL")) sRes463200h="Vol. "_$tr(sRes463200h,",.")
             //if (($e(sRes,$l(sRes)))=".") s sRes=sRes_"*"
             s sRes=sRes_..BibcitSzfCheckLast(sRes463200h,.nLast)
           }
           else
           { 
             s sRes=sRes_..BibcitSzfCheckLast(sRes463200h,.nLast)
           }
         }
       }
       else
       { s sRes=sRes_..BibcitSzfCheckLast(sRes463200a,.nLast)}
   }
     
   
   if (sDruhDok="M")
   { s sRes463205a=""
     if (sRes463'="")
     { s sRes463205a=##class(MARC).getTag4xx(sRes463,"205a")}
     if (sRes463205a'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes463205a,.nLast)}
   }
   if ((sDruhDok'="A1") && (sDruhDok'="J") && (sDruhDok'="N") &&
       (sDruhDok'="T1") && (sDruhDok'="R1"))
   { s sRes463210=..getPublicationS(.handle)  //463/210
     if ($tr(sRes463210," .,")'="")
     { ; 13.03.14 tt; oprava zapomenuteho kodu, ktery zdvojoval informace
       ;s sRes=sRes_..BibcitSzfCheckLast(sRes463210,.nLast)
       ; /// 09.03.14 tt; pridano zobrazeni 200h - upraveno teckovani
       //s nLast=1
       s sRes=sRes_..BibcitSzfCheckLast(sRes463210,.nLast,". ")
     }
   }

   s sRes463200v="", sRes463200vR="", sRes463200vC="",sRes463200vS=""
   ; 22.04.14 tt; uprava bibliograficke citace - zmeneno 200v na mala pismena
   if (sRes463'="")
   { 
     ///s sRes463200v=$zcvt(##class(MARC).getTag4xx(sRes463,"200v"),"L")
     /// 20.03.15 tt; odstranena uprava 463/200v na male pismena z generovany txx tagu pro zobrazeni
     s sRes463200v=##class(MARC).getTag4xx(sRes463,"200v")

     if (##class(rep.zf.tf).bTfBlockRunningFromIpac(.handle))
     {
       s sRes463200v=$$$strswap(sRes463200v,"Roč.","roč.")
       s sRes463200v=$$$strswap(sRes463200v,"S.","s.")
       s sRes463200v=$$$strswap(sRes463200v,"Č.","č.")
     }    
   }
   if (sRes463200v'="")
   {
      ; 16.11.07 mk pre dokumenty A1,J,R1,T1 upravit rok 
      if (sDruhDok="A1") || (sDruhDok="J") || (sDruhDok="R1") || (sDruhDok="T1") || (sDruhDok="N") 
      {
        s rok=$p(sRes463200v,"(",2)
        s rok=$p(rok,")",1)
        if rok'=""
        {
          s sRes463200v=$$$strswap(sRes463200v," ("_rok_")","")
          s sRes463200v=" "_rok_", "_sRes463200v 
          s sRes=sRes_sRes463200v
        }
      }
      elseif (sDruhDok="C") || (sDruhDok="K")|| (sDruhDok="M")|| (sDruhDok="A2")
      { ; 06.04.12 tt; zmena pri zobrazovani 463
        s sRes463200v=", "_sRes463200v 
        s sRes=sRes_sRes463200v
      }
      else
      { 
        s sRes=sRes_..BibcitSzfCheckLast(sRes463200v,.nLast)
      }
      
      if ((sDruhDok="A1") || (sDruhDok="J") || (sDruhDok="JI") || (sDruhDok="N") || (sDruhDok="T1") || (sDruhDok="R1"))
      { ; 06.12.18 tt; zapsana uspornejsi forma zobrazovani cisla a roku
        s sXPomRok=$zstrip($p(sRes463200v,",",1),"<>W")
        s sXPomRocnik=$zstrip($p(sRes463200v,",",2),"<>W"), sXPomRocnik1=sXPomRocnik
        if ($f(sXPomRocnik,"roč.")||$f(sXPomRocnik,"Roč."))
        { /// 14.12.18 tt; Provedena úprava zf podle dodatečných informací. 
          s:$f(sXPomRocnik,"roč.") sXPomRocnik=$$$strswap(sXPomRocnik,"roč. ",".b.")_"./b."
          s:$f(sXPomRocnik,"Roč.") sXPomRocnik=$$$strswap(sXPomRocnik,"Roč. ",".b.")_"./b."
        }
        s sXPomCislo=$zstrip($p(sRes463200v,",",3),"<>W"),sXPomCislo1=sXPomCislo
        if $f(sXPomCislo,"s.") s sXPomCislo1="", sXPomCislo=""
        if ($f(sXPomCislo,"č. ")||$f(sXPomCislo,"Č. "))
        {
          s:$f(sXPomCislo,"č.") sXPomCislo=$$$strswap(sXPomCislo,"č. ","(")_")"
          s:$f(sXPomCislo,"Č.") sXPomCislo=$$$strswap(sXPomCislo,"Č. ","(")_")"
        }
        elseif (sXPomCislo'="")
        {
            s sXPomCislo="("_sXPomCislo_")"
        }

        s:(sXPomRocnik'="") sRes=$$$strswap(sRes,sXPomRocnik1,sXPomRocnik)
        s:(sXPomCislo'="") sRes=$$$strswap(sRes,", "_sXPomCislo1,sXPomCislo)
        s sRes =$$$strswap(sRes,", s. ",", ")
        s sRes =$$$strswap(sRes,", č. článku",", ")

      }
   }

   s sC82a=$$$getTagX(.handle,"C82a")
   if (sC82a'="")
   { ; 04.11.16 tt; pridano zobrazovani cisla clanku
     s sC82a=" č. článku "_sC82a
     s:('$f($e(sRes,($l(sRes)-2),$l(sRes)),",")) sC82a=","_sC82a
     ; 06.12.18 tt; zapsana uspornejsi forma zobrazovani cisla a roku - clanku
     ; 05.09.23 tt; provedeno ošetření závorky, pokud je místo stran u dokumentu číslo stránku - cs122844 
     s sPomRetNahr="), "
     s:($e(sRes,$l(sRes))=")") sPomRetNahr=", "
     s:((sDruhDok="A1") || (sDruhDok="J") || (sDruhDok="JI") || (sDruhDok="N") || (sDruhDok="T1")) sC82a =$$$strswap(sC82a,", č. článku",sPomRetNahr)
     s sRes=sRes_sC82a
   }
   
   if (sDruhDok="C") || (sDruhDok="K")|| (sDruhDok="M")|| (sDruhDok="A2")
   { ; 06.04.12 tt; zmena pri zobrazovani 463
     s sRes463225a=##class(MARC).getTag4xx(sRes463,"225a")
     s sRes463225v=##class(MARC).getTag4xx(sRes463,"225v")
     if (sRes463225a'="")
     {
       // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - odstraneny zavorky
       s:(sRes463225v'="") sRes463225v=", "_sRes463225v
       s sRes463225a=$tr(sRes463225a_sRes463225v,"()") ; predtim zavorka zepredu i zezadu
       s sRes=sRes_..BibcitSzfCheckLast(sRes463225a,.nLast)
     }
   }
      
   q sRes
]]></Implementation>
</Method>

<Method name="getBibcitCAVKonferenceC20">
<Description>
sformatovanie 463 pre bibl.citaciu
nLast: vyznam je zamotany viz. BibcitSzfCheckLast (prebrane z povodneho kodu 1:1)

11.12.07 rs; oddelene od getBibcitCAV</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&nLast]]></FormalSpec>
<Implementation><![CDATA[
   s sDruhDok=..getBibcitCAVDD(.handle),sRes=""

   ; akce/konference z C20
   if ((sDruhDok="U") || (sDruhDok="C") || (sDruhDok="K")|| ($e(sDruhDok,1)="A"))
   { 
     s sC20f=##class(MARC).getTagX(.handle,"C20f")
     s sC20s=##class(MARC).getTagX(.handle,"C20s")
     if ((sC20s'="")&&('$f(sC20s,".")))
     {
       s sDatum=$e(sC20f,7,8)_"."_$e(sC20f,5,6)_"."_$e(sC20f,1,4)_"-"_
                 $e(sC20s,7,8)_"."_$e(sC20s,5,6)_"."_$e(sC20s,1,4)
     }
     elseif ((sC20s="")&&(sC20f'="")&&('$f(sC20f,".")))
     {
        s sDatum=$e(sC20f,7,8)_"."_$e(sC20f,5,6)_"."_$e(sC20f,1,4) 
     }
     else { s sDatum=sC20f_"-"_sC20s}
     
     if (sDruhDok="U")
     { 
       s sResC20=..BibcitSzfTagFormat(.handle,"C20","a"_$c(10)_"e"_$c(10)_"f"_$c(10)_"g",". "_$c(10)_", "_$c(10)_". ")
       if (sResC20'="") 
       {
         s:(sC20s'="") sResC20=$$$strswap(sResC20,sC20f,sDatum)       
         s sRes=sRes_..BibcitSzfCheckLast(sResC20,.nLast)
       }
     }   
     elseif (##class(MARC).getTagX(.handle,"C99d")="DFLT_CZ_EPCA_A3")
     { ; 08.03.22 tt; změny kvůli funčnosti a zobrazování A3
       s sResC20=..BibcitSzfTagFormat(.handle,"C20","e"_$c(10)_"a"_$c(10)_"f",", "_$c(10)_", ")
       if (sResC20'="") 
       { ; 12.02.22 tt; doplneno rozliseni datumu u A3
         s:((sC20s'="")||((sC20s="")&&(sC20f'="")&&('$f(sC20f,".")))) sResC20=$$$strswap(sResC20,sC20f,sDatum)       
         s sRes=sRes_..BibcitSzfCheckLast(sResC20,.nLast)
       }
     }     
     else 
     { 
       s sResC20=..BibcitSzfTagFormat(.handle,"C20","a"_$c(10)_"e"_$c(10)_"f"_$c(10)_"p",", "_$c(10)_", "_$c(10)_", ")
       if (sResC20'="") 
       { ; 12.02.22 tt; doplneno rozliseni datumu u A3
         s:((sC20s'="")||((sC20s="")&&(sC20f'="")&&('$f(sC20f,".")))) sResC20=$$$strswap(sResC20,sC20f,sDatum)       
         s sRes=sRes_..BibcitSzfCheckLast("["_sResC20_"]",.nLast)
       }
     }
   }
   
   q sRes
]]></Implementation>
</Method>

<Method name="getBibcitCAV">
<Description>
Biblograficka citacia pre CAV - specialna verzia
Parametry:
             pZkrac - 0 - nezkracovat jmena
                      1 - zkracovat jmena 
             pPar - "DelHtml" - odstrani html znacky z citace


13.05.21 tt; pridano dotazeni parametru do BibcitSzfAuthors - aby slo pouzit napriklad AutMaleP  
17.12.14 tt; pridana dalsi varianta, kvůli dotahování ohlasů.
29.04.14 tt; upravena funkcnost zf pro bibliograficke citace, pridany parametry - odstraneni html
15.10.12 tt; osetreni formatu bibl. citace s inicialami proti zkracovani jmena dle pripominek skype
20.12.11 tt; pridana moznost zkratit jmena autoru
12.01.11 tt; do zobrazovaciho formatu pridana verze 
27.07.09 jk; upgrade ARL1, metoda fmtCsBURL() presunuta do images.cls
13.01.08 rs; doplnenie init ZF
15.11.07 mk; pridany parameter nLink na modifikaciu 856 linku z klienta a ipacu
04.05.05 jj; Zapracovani form. "N" - nastaveni jako form. "J"
25.04.05 jj; Bibl. citace pro CAV.
27.04.05 jj; Doplneni osetreni zdvojovani ".", 
             doplneni volanych metod, celk. osetreni,
             doplneni zaverecne tecky.
28.04.05 jj; Zapojeni fci BibcitSzfTagFormat() a BibcitSzfCheckLast().
---
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary,nLink:%Library.Integer=1,pZkrac=0,pPar=""</FormalSpec>
<Implementation><![CDATA[

   ; 13.01.09 jk; metoda se vola i mimo IPAC2 (v IPAC1), kde neexistuje prostredi IPAC2
   ; 12.01.09 jk; inicializace options pro kratky ZF
   if ('##class(rep.zf.tf).bTfBlockRunningFromIpac(.handle))
   { ; 18.08.14 tt; upravena podminka, aby se neprepraskavalo nastaveni z ipacu u zf, kde je
     s psOptions="" //##class(i2.common).getDisplayFmtOptions(.handle)
     d ##class(rep.zf.tf).formatXinit(.handle,psOptions)  

     d:($g(handle("tmp","modif_TF","language"))="") ##class(rep.zf.tf).setMod(.handle,"language",2)
     d ##class(rep.zf.tf).setMod(.handle,"ictx","Cav") 
     s %ipac2("basepure")="https://asep.lib.cas.cz/i2/"
   }   
   ; 06.04.17 tt; zmeny provadene kvuli zf velkych dat 
   s sDruhDok=$$$getTagX(.handle,"970b")
   s sFormC99d=$$$getTagX(.handle,"C99d")
   
   s sDruhDok=..getBibcitCAVDD(.handle)
   s nLast=0

   s sRes=..BibcitSzfAuthors(.handle,,,pPar)           // 70x
   s:(pZkrac'=1) sRes=..BibcitSzfAuthors(.handle,,,"AEditor,"_pPar)           // 70x
   s sZalRes=sRes
   ; 05.03.18 tt; vzdy zobrazovat editora za , bez ()
   ///if $f(sFormC99d,"_CIT_")
   //{ ;14.09.17 tt; 2. Pokud je u autora vybraná role 340 – editor, zobrazit jí v citaci za čárkou (a odstranit závorky). - pro ohlasy
   ; 09.10.20 tt; pridan specialni handle pro formatovani
   d ##class(User.MARC).mergeX(.handleBC,.handle)
     
   ///}
   
   if (pZkrac=1)
   { ; 20.12.11 tt; pridana moznost zkratit jmena autoru
     s sRes=$$$strswap(sRes," - "," ; ")
     for i=1:1:$l(sRes,";")
     { ; cyklime podle jednotlivych autoru
       s sAut1=$p(sRes,";",i)   ; ziskame jednoho autora
       s sAut1j=$p(sAut1,",",2) ; zikame jmena
       s sAut1Vysl="",sStav=0
       for j=1:1:$l(sAut1j)
       { ; cyklime a nechavame jen inicialy s .

         s sZnak=$e(sAut1j,j)
         if ((sZnak?1.A)&&(sStav=0))
         { ; pokud mame prvni znak ulozime
           s sAut1Vysl=sAut1Vysl_sZnak_"." 
           s sStav=1
         }
         if ('(sZnak?1.A))
         { ; pokud jiny znak, zmenim stav a ulozim
           s sAut1Vysl=sAut1Vysl_sZnak
           s sStav=0           
         }
       }
       s $p(sAut1,",",2)=sAut1Vysl ; ulozime jmena
       s $p(sRes,";",i)=sAut1   ; ulozime jednoho autora
     }
     s $e(sRes,$l(sRes))=""
     s sRes=$$$strswap(sRes,"..",".")
     s sRes=$$$strswap(sRes,"(e.)","(ed.)")

     ; 02.11.12 tt; drobna uprava logiky, pri osetreni autoru v 702 a zkracovani inicialu
     ; 15.10.12 tt; osetreni formatu bibl. citace s inicialami proti zkracovani jmena dle pripominek skype
     s sPomREs=$l($p(sZalRes," - ",1),";")
     if (sPomREs'=0)&&($f(sZalRes," - "))
     {
       for i=1:1:$l(sRes,";")
       {
         if sPomREs=i
         {
          s sRes=$p(sRes,";",0,i)_"-"_$p(sRes,";",i+1,9999)
         }
       }
     }
     if (($l(sRes,"(ed.)")>$l(sRes,";"))&&($l(sRes,"(ed.)")>2))
     {
       s sRes=$$$strswap(sRes," (ed.);",",")   
       s sRes=$$$strswap(sRes," (ed.)",", eds.")
     }
   }
   else
   {
      s sRes=$$$strswap(sRes,"..",".")
   }
   
   if ('(##class(util.sec.utils).evalMarcIf("",.handle,"7**4--not-1-1",1)||##class(util.sec.utils).evalMarcIf("",.handle,"7**4-070--1-1",1)))
   {
     if (($l(sRes,"(ed.)")>$l(sRes,";"))&&($l(sRes,"(ed.)")>2))
     {
       s sRes=$$$strswap(sRes," (ed.).",", eds.")
       s sRes=$$$strswap(sRes," (ed.);",",")   
     }
     if ('($e(sRes,$l(sRes)))=".") { s sRes=$$$strswap(sRes," (ed.)."," ed.") }
     else { s sRes=$$$strswap(sRes," (ed.).",", ed.") }
     s sRes=$$$strswap(sRes," (ed.),",",")
   }

   s sRes=$$$strswap(sRes," (ed.)",", ed.")
   ; 05.03.18 tt; vzdy zobrazovat editora za , bez ()
   s sRes=$$$strswap(sRes," (ed.)",", ed")
  
   ; 05.12.18 tt; nahrazeni ; za , u vsech autoru
   s sRes=$$$strswap(sRes,";",",")
   
   if (sRes'="") {s nLast=($e(sRes,$l(sRes)))="."}
   
   ; 09.10.20 tt; upraveno zobrazeni pro L1
   if (sDruhDok="L1")
   { s sResC34o=$$$getTagX(.handle,"C34o") 
     if (sResC34o'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC34o,.nLast)}
   }
      
   s sRes200a=$$$strswap($$$getTagX(.handle,"200a"),"...","…") // 200a
   if (sDruhDok="B") || (sDruhDok="G") || (sDruhDok="H") || (sDruhDok="I") || (sDruhDok="V") || (sDruhDok="T3") || (sDruhDok="D") || (sDruhDok="E") || (sDruhDok="P") || (sDruhDok="W")
   {
     if (sRes200a'="")
     { ; 09.10.20 tt; upraveno zobrazeni pro druh E
       if (sDruhDok="E") { s sRes=sRes_" <em>"_sRes200a_"</em> ", sRes200a="" }
       else { s sRes200a=sRes200a_". "}
     }
     if (sRes200a'="") && (sRes'="") { s sRes=sRes_..BibcitSzfCheckLast(sRes200a,.nLast," ",2)}  
     if (sRes200a'="") && (sRes="")  { s sRes=sRes_..BibcitSzfCheckLast(sRes200a,1," ",2)}  
     if (sDruhDok="B")
     {
       s sRes200i=$$$getTagX(.handle,"200i") 
       s sRes200h=$$$getTagX(.handle,"200h") 
       s:((sRes200h'="") && (sRes'="")) sRes=sRes_..BibcitSzfCheckLast(sRes200h,.nLast,". ",2)
       s:((sRes200i'="") && (sRes'="")) sRes=sRes_..BibcitSzfCheckLast(sRes200i,.nLast,", ",2)
       s:((sRes200h'="") ||(sRes200i'="")) sRes=sRes_". "        
     }
   }
   elseif ('$f(",A,C,J,M,N,R,T,A1,A2,K,R1,R2,R3,T1,T2,T3,T4",sDruhDok))
   { ; 09.10.20 tt; nazev dan vzdy na kurzivu ," ",2
     if (sRes200a'="") { s sRes=sRes_..BibcitSzfCheckLast(sRes200a,.nLast," ",2)}
   }
   else
   {
     if (sRes200a'="") { s sRes=sRes_..BibcitSzfCheckLast(sRes200a,.nLast," ",0)}   
   }

   if (sDruhDok'="D")
   {
     s sResC30=..BibcitSzfTagFormat(.handle,"C30","j"_$c(10)_"i"_$c(10)_"e"," : "_$c(10)_", ")
     if (sResC30'="") { s sRes=sRes_..BibcitSzfCheckLast(sResC30,.nLast)}
   }       
   
   if (sDruhDok="E")
   { s sRes856q=$$$getTagX(.handle,"856q") //[856q]
     if (sRes856q'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes856q,.nLast," [")_"]",nLast=0}

   }
  
   
   if (sDruhDok="DATA") 
   {  ; 06.04.17 tt; zmeny provadene kvuli zf velkych dat 
      ; 23.08.23 tt; provedena změna citace datasetů
      ; odstraneni . za nazvem cs122751
      s:($e(sRes,$l(sRes))=".") $e(sRes,$l(sRes))=""
      s:($e(sRes,($l(sRes)-5),$l(sRes))=".</em>") $e(sRes,($l(sRes)-5),$l(sRes))="</em>"
      s sRes=sRes_..prekladPrefixuIpac(.handle,"U258")
      s sVer1=##class(User.CavUnEpca).versionZfGetData(.handle,"U244-U245-")
      s:(sVer1'="") sRes=sRes_sVer1_". "
      s sRes=sRes_..prekladPrefixuIpac(.handle,"U259")
      s sRes=sRes_" "_$e($$$getTagX(.handle,"100a"),1,4)_"."      
   }
   if (sDruhDok="L4")
   { ; 09.10.20 tt; upraveno zobrazeni pro L4
     s sRes=sRes_" [software]"
   }
   if (sDruhDok="L5")
   { ; 09.10.20 tt; upraveno zobrazeni pro L4
     s sRes=sRes_" ["_..prekladPrefixuIpac(.handle,"U216")_"]"
   }
   
   s sRes47070x=..BibcitSzfAuthorsR(.handle)      //470/70x
   s sResx=""
   if (sRes47070x'="")
   { 
     if (sDruhDok="R1") || (sDruhDok="T1") || (sDruhDok="R2") || (sDruhDok="T2") || (sDruhDok="T3")
     {
       s sResx=sResx_$$$strswap(..BibcitSzfCheckLast(sRes47070x,.nLast," [Orig.: "),"[Orig.: . - ","[Orig.: ")
     }
     else
     {
       s sRes=sRes_$$$strswap(..BibcitSzfCheckLast(sRes47070x,.nLast," Orig.: "),"Orig.: . - ","Orig.: ")
     }      
   }
   
   s sRes470=$$$getTagX(.handle,"470") //[470/200a]
   s sRes470200a=""
   if (sRes470'="") 
   { s sRes470200a=##class(MARC).getTag4xx(sRes470,"200a")}
   if (sRes470200a'="") 
   {
     if (sDruhDok="R1") || (sDruhDok="T1") || (sDruhDok="R2") || (sDruhDok="T2") || (sDruhDok="T3")
     {  
       if sRes47070x'=""
       {
         s sResx=sResx_" "_sRes470200a_"]",nLast=0
       }
       else
       {
         s sResx=sResx_": ["_sRes470200a_"]",nLast=0
       }  
       s sResx=""
     }
     else
     {
       s sRes=sRes_": ["_sRes470200a_"]",nLast=0
     }  
   }
   
   
   if ((sDruhDok="I") || (sDruhDok="V") || (sDruhDok="B") || (sDruhDok="G") || (sDruhDok="H"))
   { 
     s sRes205a=$$$getTagX(.handle,"205a") //205a
     if (sRes205a'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes205a,.nLast)}
   }
   
   /*
   if (sDruhDok="P")
   { s sResC11e=$$$getTagX(.handle,"C11e") 
     if (sResC11e'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC11e,.nLast)}
   }*/
   
   if ((sDruhDok="L") || (sDruhDok="L4") || (sDruhDok="Z"))
   /// || (sDruhDok="L2") 
   {  ; 09.10.20 tt; upraveno zobrazeni pro L...
     s sLTC34e=$$$getTagX(.handle,"C34e") 
     if (sLTC34e'="")
     { ; pokud mame data, budeme zobrazovat
       s sRes=sRes_". "_sLTC34e_","
       s nLast=1
     }
   }  
   
   ; 09.10.20 tt; upraveno zobrazeni pro L1
   if (sDruhDok="L1")
   { s sResC34p=$$$getTagX(.handle,"C34p") 
     if (sResC34p'="") {
       s sRes=sRes_..BibcitSzfCheckLast(sResC34p_",",.nLast)
       s nLast=1
     }     
   }
   ; 09.10.20 tt; upraveno zobrazeni pro L1
   if ((sDruhDok="L2")||(sDruhDok="L3")||(sDruhDok="L5"))
   { 
     s TC26e=$$$getTagX(.handle,"C26e") 
     s:(TC26e'="") TC26e=##class(User.Util).sXlate("CAV_PRA",$zcvt(TC26e,"U"),"","Cav","c")
     s sRes=sRes_..BibcitSzfCheckLast(TC26e_",",.nLast)
     s nLast=1
   }
  
   ; 05.03.18 tt; uprava vice hodnot 210 - aby byly jen jedna instituce
   s sT210=$$$getTagX(.handle,"210")
   if (sT210'="")
   {
    s sT210a = $$$getSubTagStr(sT210,"a")  
    s:(sT210a'="") sT210 = ##class(User.MARC).setSubTagStr(sT210,$c(31)_"a"_sT210a)
    s sT210c = $$$getSubTagStr(sT210,"c")  
    s:(sT210c'="") sT210 = ##class(User.MARC).setSubTagStr(sT210,$c(31)_"c"_sT210c)
    s sT210d = $$$getSubTagStr(sT210,"d")  
    if ((sDruhDok'="P")&&(sDruhDok'="P1"))
    {
      s:(sT210d'="") sT210 = ##class(User.MARC).setSubTagStr(sT210,$c(31)_"d"_sT210d)
      d ##class(User.MARC).mergeX(.handle210,.handle)
      d $$$setTagX(.handle210,sT210)  
   
      s:(sDruhDok'="D") sRes210=..BibcitSzfTagFormat(.handle210,"210","a"_$c(10)_"c"_$c(10)_"d",": "_$c(10)_", ")
      s:(sDruhDok="D") sRes210=..BibcitSzfTagFormat(.handle210,"210","a"_$c(10)_"d",", ")
      if (sRes210'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes210,.nLast)}
    }
   }  
       
   if (sDruhDok="D")
   {
      s sRes=sRes_". "_..prekladPrefixuIpac(.handle,"U218")_"."
      s nLast=1
      //s sPrekPrefix=..prekladPrefixuIpac(.handle,"0943")
      /// 26.11.20 tt; - zmena C30i na 210$c
      s sResC30=..BibcitSzfTagFormat(.handle,"210","c",", ")
      s sRes=sRes_..BibcitSzfCheckLast(sResC30,.nLast)
   }       
   
   /*
   if (sDruhDok="E")
   { s sRes215c=$$$getTagX(.handle,"215c") 
     if (sRes215c'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes215c,.nLast)}
   }*/
   
   if ((sDruhDok="P")||(sDruhDok="P1"))
   {  ; 09.10.20 tt; pridano formatovani datumu pro P,P1, U - meni se fyzicky podpole
      d ..formatBibCDatum(.handleBC, "C11c")
   }
   if (sDruhDok="U")
   {    
     d ..formatBibCDatum(.handleBC,"C20f")
     d ..formatBibCDatum(.handleBC,"C20s")
   }
   
   
   if ((sDruhDok="L") )
   {  ; 09.10.20 tt; upraveno zobrazeni pro L...
     s sLTC34m=$$$getTagX(.handle,"C34m") 
     if (sLTC34m'="")
     { ; pokud mame data, budeme zobrazovat
       s:(sLTC34m="A") sLTC34m=..prekladPrefixuIpac(.handle,"U208")
       s:(sLTC34m="B") sLTC34m=..prekladPrefixuIpac(.handle,"U209")
       s sRes=sRes_". "_sLTC34m
       s nLast=1
     }
     s sLTC34a=$$$getTagX(.handle,"C34a") 
     s:(sLTC34a'="") sRes=sRes_" "_sLTC34a_"."
   }     
   if ((sDruhDok="L2") )
   {  ; 09.10.20 tt; upraveno zobrazeni pro L...
      s sRes=sRes_". "_..prekladPrefixuIpac(.handle,"U210")
      s nLast=1
   }  
   if ((sDruhDok="L3") )
   {  ; 09.10.20 tt; upraveno zobrazeni pro L...
     s sLTC34u=$$$getTagX(.handle,"C34u") 
     if (sLTC34u'="")
     { ; pokud mame data, budeme zobrazovat
       s:(sLTC34u="A") sLTC34u=..prekladPrefixuIpac(.handle,"U211")
       s:(sLTC34u="B") sLTC34u=..prekladPrefixuIpac(.handle,"U212")
       s:(sLTC34u="C") sLTC34u=..prekladPrefixuIpac(.handle,"U213")
       s:(sLTC34u="E") sLTC34u=..prekladPrefixuIpac(.handle,"U214")
       s:(sLTC34u="F") sLTC34u=..prekladPrefixuIpac(.handle,"U215")
       
       s sRes=sRes_". "_sLTC34u
       s nLast=1
     }
     s sLTC34o=$$$getTagX(.handle,"C34o") 
     s:(sLTC34o'="") sRes=sRes_" "_sLTC34o_"."
   } 
   if ((sDruhDok="Z") )
   {  ; 09.10.20 tt; upraveno zobrazeni pro L...
     s sLTC34l=$$$getTagX(.handle,"C34l") 
     if (sLTC34l'="")
     { ; pokud mame data, budeme zobrazovat
       s:(sLTC34l="A") sLTC34l=..prekladPrefixuIpac(.handle,"U221")
       s:(sLTC34l="B") sLTC34l=..prekladPrefixuIpac(.handle,"U222")
       s:(sLTC34l="C") sLTC34l=..prekladPrefixuIpac(.handle,"U223")
       s:(sLTC34l="D") sLTC34l=..prekladPrefixuIpac(.handle,"U224")
       
       s sRes=sRes_". "_sLTC34l
       s nLast=1
     }
     s sLTC34a=$$$getTagX(.handle,"C34a") 
     s:(sLTC34a'="") sRes=sRes_" "_sLTC34a_"."
   } 
   
   ; 09.10.20 tt; upraveno zobrazeni pro P1
   if ((sDruhDok'="P")&&(sDruhDok'="P1"))
   { ; 
     s sResC11=..BibcitSzfTagFormat(.handleBC,"C11","f"_$c(10)_"e"_$c(10)_"c"," : "_$c(10)_", ")
     if (sResC11'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)}
   }
   elseif (sDruhDok="P1")
   {
     s sLTC11q=$$$getTagX(.handle,"C11q"),sLTC11qPr=""
     if (sLTC11q'="")
     { ; pokud mame data, budeme zobrazovat
       s:(sLTC11q="U") sLTC11qPr=" "_..prekladPrefixuIpac(.handle,"U219")
       s:(sLTC11q="P") sLTC11qPr=" "_..prekladPrefixuIpac(.handle,"U220")
     }
     
     s sResC11a=$$$getTagX(.handleBC,"C11a")
     s sResC11c=$$$getTagX(.handleBC,"C11c")
     s sResC11=sLTC11qPr_" "_sResC11a   
     s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)  
     if (sResC11c'="")
     {
       s sResC11c=$$$getTagX(.handleBC,"C11c")
       //s sPrekPrefix=..prekladPrefixuIpac(.handle,"U085")
       s sResC11=sResC11c   
       s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)    
     }
    
  }
   
     ///s sResC11=..BibcitSzfTagFormat(.handle,"C11","a"_$c(10)_"c",". "_sPrekPrefix_": ")
   
   ;if ((sDruhDok='"A1") || (sDruhDok='"A2") || (sDruhDok='"J") ||
   ;    (sDruhDok='"M") || (sDruhDok='"C") || (sDruhDok='"K") ||
   ;    (sDruhDok='"G") || (sDruhDok='"H") || (sDruhDok='"T1") ||
   ;    (sDruhDok='"T2") || (sDruhDok='"R1") || (sDruhDok='"R2") ||
   ;    (sDruhDok='"N"))
   ; 16.11.07 mk povolenie pre vsetkych
   ; 05.03.18 tt; || (sDruhDok="B") - vyhozeno
   ; 06.12.18 tt; vyhozeno (sDruhDok="G") || (sDruhDok="H")
   /// || (sDruhDok="T3") (sDruhDok="V")  ||
   if (  (sDruhDok="P")  )
   {      
     s sRes215a=$$$getTagX(.handle,"215a") //215a
     if (sRes215a'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes215a,.nLast)}
   }
   
   ; doplnit 225 16.11.07 mk
   if ((sDruhDok="B") || (sDruhDok="G") || (sDruhDok="H") || (sDruhDok="I") || (sDruhDok="V"))
   {
     // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - oddelovac ,
     s sRes225=..BibcitSzfTagFormat(.handle,"225","a"_$c(10)_"i"_$c(10)_"v",", "_$c(10)_", ")
     //s sRes225=..BibcitSzfTagFormat(.handle,"225","a"_$c(10)_"i"_$c(10)_"v",", "_$c(10)_" : ")
     if sRes225'=""
     {
       s sRes225x=$$$getTagX(.handle,"225x") 
       s:(sRes225x'="") sRes225x=", ISSN "_sRes225x
       // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - odstraneny zavorky
       //s sRes225="("_sRes225_sRes225x_")"  
       s sRes225=sRes225_sRes225x   
       s sRes=sRes_..BibcitSzfCheckLast(sRes225,.nLast)
     }
   }
   
   
   if (sDruhDok="P")
   {
     /*s sPrekPrefix=..prekladPrefixuIpac(.handle,"U085")
     s sResC11=..BibcitSzfTagFormat(.handle,"C11","a"_$c(10)_"c",". "_sPrekPrefix_": ")
     if (sResC11'="")
     {
       s sResC11a=$$$getTagX(.handle,"C11a")
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U087")
       if sResC11a'="" s sResC11=" "_sPrekPrefix_": "_sResC11   
       s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)
     }*/
     ; 09.10.20 tt; pridane prijmeni jako velka pismena, jde to znastavenim zrusit - upraveno nastaveni
     s sResC11a=$$$getTagX(.handleBC,"C11a")
     s sResC11c=$$$getTagX(.handleBC,"C11c")
     if (sResC11a'="")
     {
       s sResC11a=$$$getTagX(.handleBC,"C11a")
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U217")
       s sResC11=" "_sPrekPrefix_" "_sResC11a   
       s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)    
     }
      if (sResC11c'="")
     {
       s sResC11c=$$$getTagX(.handleBC,"C11c")
       //s sPrekPrefix=..prekladPrefixuIpac(.handle,"U085")
       s sResC11=sResC11c   
       s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)    
     }
   }
   elseif (sDruhDok'="P1")
   { 
     s sResC11a=$$$getTagX(.handleBC,"C11a") //C11a
     if (sResC11a'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC11a,.nLast)}
   }
   
   
   /*
   if (sDruhDok="E")
   { s sRes856s=$$$getTagX(.handle,"856s") //856s
     if (sRes856s'="") 
     { s sRes=sRes_", "_sRes856s,nLast=($e(sRes856s,$l(sRes856s)))="."}
   } */ 
     
 
   if (sDruhDok'="E")
   { s sRes010a=$$$getTagX(.handle,"010a") //010a
     if (sRes010a'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes010a,.nLast," ISBN ")}
     s sRes011a=$$$getTagX(.handle,"011a") //011a
     if (sRes011a'="")
     { s:(sDruhDok'="B") sRes=sRes_..BibcitSzfCheckLast(sRes011a,.nLast," ISSN ")}
     s sRes011e=$$$getTagX(.handle,"011e") //011e
     if (sRes011e'="")
     { s:(sDruhDok'="B") sRes=sRes_..BibcitSzfCheckLast(sRes011e,.nLast," E-ISSN ")}

     ; pridana verze - online / print
     s sB=$$$getTagX(.handle,"205a")
     s:((sB'="")&&('((sDruhDok="I") || (sDruhDok="V") || (sDruhDok="B") || (sDruhDok="G") || (sDruhDok="H")))) sRes=sRes_". "_sB
   
     ; zobrazeni poznamek z tagu 301
     s c=0
     d { ; cyklus pres vsechny opakovani tagu
       s sT301=$$$getTagXC(.handle,"301",.c) ; vsetky citacie
       continue:(sT301="")
       s sB=$$$getSubTagStr(sT301,"a")
       s:(sB'="") sRes=sRes_". "_sB
     } while (c'=0)       
   }
     
   ; 11.12.07 rs; oddelenie do podprogramu    
   s s=..getBibcitCAV463(.handle,.nLast),sRes=sRes_s


   ; 463/010,11
   s sRes463=$$$getTagX(.handle,"463")
   s sRes463010a=""
   if (sRes463'="") 
   { s sRes463010a=##class(MARC).getTag4xx(sRes463,"010a") 
     ; 25.03.11 tt; doplnena podpora ISBN u 4xx
     d ##class(User.MARC).t4xx2handle(.h4xx, sRes463) 
     s sRes463010a1=$$$getTagXC(.h4xx,"010a",-1) //010a
     s sRes463010a1=$$$strswap(sRes463010a1,$c(10),"; ISBN ")
     s:(sRes463010a1'="") sRes463010a=sRes463010a1
   }
   if (sRes463010a'="")
   { s sRes=sRes_..BibcitSzfCheckLast(sRes463010a,.nLast," ISBN ")}
   if ((sDruhDok'="M") && (sDruhDok'="T2") && (sDruhDok'="R2"))
   { s sRes463011a="", sRes463011e=""
     s:(sRes463'="") sRes463011a=##class(MARC).getTag4xx(sRes463,"011a")
     s:(sRes463'="") sRes463011e=##class(MARC).getTag4xx(sRes463,"011e")
     ; 22.04.14 tt; uprava bibliograficke citace - vynucena . jako oddelovac
     if (sRes463011a'="")
     { 
       if (($e(sRes,($l(sRes)-1),$l(sRes))'=". ")&&($e(sRes,$l(sRes))'="."))
       { ;22.04.14 tt; uprava bibliograficke citace - doplnena logika oddelovace
          s sRes=sRes_..BibcitSzfCheckLast(sRes463011a,0," ISSN ")
       }
       else
       {
         s sRes=sRes_..BibcitSzfCheckLast(sRes463011a,1," ISSN ")
       }
     }
     if (sRes463011e'="")
     { 
       if (($e(sRes,($l(sRes)-1),$l(sRes))'=". ")&&($e(sRes,$l(sRes))'="."))
       { ;22.04.14 tt; uprava bibliograficke citace - doplnena logika oddelovace
          s sRes=sRes_..BibcitSzfCheckLast(sRes463011e,0," E-ISSN ")
       }
       else
       {
         s sRes=sRes_..BibcitSzfCheckLast(sRes463011e,1," E-ISSN ")
       }
     }
   } 
    ; 08.03.22 tt; změny kvůli funčnosti a zobrazování A3
   s:($f("A3",sDruhDok)) s=$zcvt($p(##class(rep.zf.ub).fmtUb(.handle,"T=C54 D=\n PR=001 ST=a STM=cis-EPC_UN_TC54A3-1 STM=oddel-\s[-]")," : ",2,999),"L"),sRes=sRes_s

   ; 11.12.07 rs; oddelenie do podprogramu
   s:('$f("A1,A2,C,K,U",sDruhDok)) s=..getBibcitCAVKonferenceC20(.handleBC,.nLast),sRes=sRes_s
   
   
    ; 09.10.20 tt; upraveno zobrazeni pro L1
   if ((sDruhDok="U"))
   { 
     s sResC20e=$$$getTagX(.handle,"C20e") 
     if (sResC20e'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC20e_", ",.nLast)}

     s TC26e=$$$getTagX(.handle,"C26e") 
     s:(TC26e'="") TC26e=##class(User.Util).sXlate("CAV_PRA",$zcvt(TC26e,"U"),"","Cav","c")
     ///_" ("_..prekladPrefixuIpac(.handle,"U225")_")"
     s nLast=1
     s sRes=sRes_..BibcitSzfCheckLast(TC26e_", ",.nLast)
     //s sRes=$$$strswap(sRes,",.",",")
     s sRes=sRes_..BibcitSzfTagFormat(.handleBC,"C20","f"_$c(10)_"s"," - ")
     s nLast=1
     
     s sLTC20o=$$$getTagX(.handle,"C20o") 
     if (sLTC20o'="")
     { ; pokud mame data, budeme zobrazovat
       s:(sLTC20o="K") sLTC20o=..prekladPrefixuIpac(.handle,"U226")
       s:(sLTC20o="W") sLTC20o=..prekladPrefixuIpac(.handle,"U227")
       s:(sLTC20o="E1") sLTC20o=..prekladPrefixuIpac(.handle,"U228")
       s:(sLTC20o="E2") sLTC20o=..prekladPrefixuIpac(.handle,"U228")
       
       s sRes=sRes_". "_sLTC20o
       s nLast=1
     }
   }
 
   ; 16.11.07 mk pridanie 470 tagu vu T1 a R1 dokumentu nakoniec.
   if (sResx'="") s sRes=sRes_sResx


   if (sDruhDok="W")
   {
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U126")
     s sResC26=..BibcitSzfTagFormat(.handle,"C26","n"_$c(10)_"o",". "_sPrekPrefix_": ")
     if (sResC26'="")
     {
       s sResC26n=$$$getTagX(.handle,"C26n")
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U125")
       if sResC26n'="" s sResC26=" "_sPrekPrefix_": "_sResC26   
       s sRes=sRes_..BibcitSzfCheckLast(sResC26,.nLast)
     }
   }
   
   if (sDruhDok="DATA") 
   {  ; 09.11.23 tt; zobrazeni licence u dat
     s sResC81b=$$$getTagX(.handle,"C81b")
     if $f(sResC81b,"BY")
     {
       s sLicPr=..prekladPrefixuIpac(.handle,"U166")
       if (sLicPr="Licence") { s sLicPr=" "_sLicPr_": " }
       else { s sLicPr=" "_sLicPr_" "  }               
      s sRes=sRes_sLicPr_sResC81b_". "
     }
   }
   
   s sClass=$$$HandleClass(handle)
   /* if (sClass="CavUnOhlCat")
   { ; pridano zobrazovi DOI pro CavUnOhlCat
   
     s sRes017a=$$$getTagX(.handle,"017a")
     s:(sRes017a'="") sRes=sRes_..BibcitSzfCheckLast(sRes017a,.nLast," DOI ")
   }*/
   
    s sPrekPrefix=..prekladPrefixuIpac(.handle,"U124")

   ; 04.12.18 tt; přidáno zobrazení DOI
   s sRes017a=..getDOIlink(.handle) //856u
   s sRes017a=$p(sRes017a," /></a> ",2)
   s sRes017a=$$$strswap(sRes017a,">DOI: ",">doi: ")  ; nahrazeni textu doi a male
   if (sRes017a'="")
   { 
     if ((nLink=3)||(nLink=2))  ; ak je volany z ipacu
     { ; 17.12.14 tt; pridana dalsi varianta, kvůli dotahování ohlasů.  
       s sRes017a=##class(Util).trim(sRes017a)  
       if sRes017a'="" s sRes017a=". "_sPrekPrefix_": "_sRes017a_"" 
       ;if sRes017a'="" s sRes017a=". "_sRes017a_"" 
     } 
     else
     {
        s sRes017a=..BibcitSzfTagFormat(.handle,"017","a","","","","\n")
        //if sRes017a'="" s sRes017a="\nDOI: "_sRes017a_""
        if sRes017a'="" s sRes017a="\nDostupné z: doi:"_sRes017a_""
     }
     
     s sRes017a=$$$strswap(sRes017a,".b.","./retezecBtecka.")
     ; ak je volany z klienta
     s sRes=sRes_sRes017a
   }
   
   if ((sDruhDok="DATA")&&(sRes017a="")) 
   { ; 23.08.23 tt; provedena změna citace datasetů
     s sTC60a=$$$getTagX(.handle,"C60a") 
     s sRes=sRes_". "_sPrekPrefix_": <a href="""_sTC60a_""" target=""_blank"" title=""Handle link"">"_sTC60a_"</a> "
   }  
   
   // 27.04.05 jj; doplneni zaverecne tecky
   ;if ((sDruhDok'="E") && (sDruhDok'="C") && (sDruhDok'="K"))
   ; 15.11.07 mk pre vsetkych . a konci
   ;if ('nLast) {s sRes=sRes_"."}
   s sRes856u=$$$getTagX(.handle,"856u") //856
   s:(((sDruhDok="U"))&&(sRes856u="")) sRes856u=$$$getTagX(.handle,"C20g")
   
   if '(((sRes017a'="")&&(sRes856u=""))||(sDruhDok="DATA"))
   { 
     s sRes=##class(Util).trim(sRes)  
     if ($e(sRes,$l(sRes),$l(sRes))'=".") && (sRes'="") s sRes=sRes_"."  
   } 
   ; 15.11.07 mk; spristupnene pre vsetky druhy dokumentov nielen E  
   
   if (sRes856u'="")
   { ; 05.12.18 tt; nahrazena na konci 856 . za ""
     if (nLink=3)  ; ak je volany z ipacu
     { ; 17.12.14 tt; pridana dalsi varianta, kvůli dotahování ohlasů.  
       s sRes856u=##class(Util).trim(sRes856u)  
       if sRes856u'="" s sRes856u=". "_sPrekPrefix_": "_sRes856u_"" 
     } 
     elseif (nLink=2)  ; ak je volany z ipacu
     {   
       s sRes856u=$$$strswap(##class(rep.zf.images).fmtCsBURL(.handle,"F",.sCoverHTML,"856","u",""),"\n","")
       s:(((sDruhDok="U")||(sDruhDok="A3"))&&(sRes856u="")) sRes856u=$$$strswap(##class(rep.zf.images).fmtCsBURL(.handle,"F",.sCoverHTML,"C20","g",""),"\n","")
       
       ;if $f(sRes856u,".pdf")>0 
       ;{
       ;   if sRes856u'="" s sRes856u=" Dostupný z: "_sRes856u
       ;}
       ;else
       ;{
         s sRes856u=$$$strswap(sRes856u,"<span class=""icon-full-text"" aria-hidden=""true""></span>","")
         s sRes856u=##class(Util).trim(sRes856u)  
         ; 05.03.18 tt; zmenen prefix u 856 a take ostraneny ostre zavorky.
         ///if sRes856u'="" s sRes856u=" "_sPrekPrefix_": <"_sRes856u_">." 
         if sRes856u'="" s sRes856u=" "_sPrekPrefix_": "_sRes856u_"" 
       ;}
     } 
     else
     {
        s sRes856u=..BibcitSzfTagFormat(.handle,"856","u","","","","\n")
        s:((sDruhDok="U")&&(sRes856u="")) sRes856u=..BibcitSzfTagFormat(.handle,"C20","g","","","","\n")

        if sRes856u'="" s sRes856u="\n "_sPrekPrefix_": "_sRes856u_""
     }
     ; ak je volany z klienta
     ; 18.11.20 tt; provedeno osetreni bibliograficke citace - doi ...
     s sRes856u=$$$strswap(sRes856u,".b.","./retezecBtecka.")
     s sRes017a=$$$strswap(sRes017a,".b.","./retezecBtecka.")
     s:(sRes017a="") sRes=sRes_$$$strswap(sRes856u,"\n","")
   }
      
   

   ; 12.01.09 jk; uklid options pro kratky ZF    
   d ##class(rep.zf.tf).formatXcleanup(.handle)
   
   if $f(pPar,"DelHtml")
   { ; 29.04.14 tt; upravena funkcnost zf pro bibliograficke citace, pridany parametry - odstraneni html
     s sRes=$$$strswap($$$strswap(sRes,"./i.",""),".i.","")     
   } 
   s sRes=$$$strswap(sRes,"..","."), sRes=$$$strswap(sRes,"..",".")
   //s sRes=$$$strswap(sRes,"))",")")
   s sRes=$$$strswap(sRes,"?.","?")
   s sRes=$$$strswap(sRes,"? </em>. ","?</em> ")
   s sRes=$$$strswap(sRes,"?</em>. ","?</em> ")
   s sRes=$$$strswap(sRes,"!.","!")
   s sRes=$$$strswap(sRes,"? .","?")
   s sRes=$$$strswap(sRes,"! .","!")
   s sRes=$$$strswap(sRes,"! </em>. ","!</em> ")
   s sRes=$$$strswap(sRes,"..",".")
   s sRes=$$$strswap(sRes,". </em>. ","</em>. ")
   s sRes=$$$strswap(sRes,". . ",". ")
   s sRes=$$$strswap(sRes,".</em> = <em>","</em> = <em>")
   
   if $f(pPar,"DelHtml")
   { ;  tt; upravena funkcnost zf pro bibliograficke citace, pridany parametry - odstraneni html
     s sRes=$$$strswap(sRes,"<em>","")   
     s sRes=$$$strswap(sRes,"</em>","")     
     s sRes=$$$strswap(sRes,"<strong>","")     
     s sRes=$$$strswap(sRes,"</strong>","") 
     s sRes=$$$strswap(sRes,"<u>","")      
     s sRes=$$$strswap(sRes,"</u>","") 
     s sRes=$$$strswap(sRes,".b.","")     
     s sRes=$$$strswap(sRes,"./b.","") 
     /*
     s sRes=$$$strswap(sRes,"<em>","\is ")   
     s sRes=$$$strswap(sRes,"</em>","\ie ")     
     s sRes=$$$strswap(sRes,"<strong>","\bs ")     
     s sRes=$$$strswap(sRes,"</strong>","\be ") 
     s sRes=$$$strswap(sRes,"<u>","\us ")      
     s sRes=$$$strswap(sRes,"</u>","\ue ") 
     s sRes=$$$strswap(sRes,".b.","\bs ")     
     s sRes=$$$strswap(sRes,"./b.","\be ")    */       
   }

   q sRes
]]></Implementation>
</Method>

<Method name="getDisplayFormatShortC20">
<Description>
riesenie C20 pre skrateny ZF

15.11.22 tt; provedena úprava zobrazování C20 s a f pro A3
14.12.16 tt; upraveno cteni jen prvniho znaku pro druh dokumentu. Kvuli A
11.12.07 rs; oddelenie od "getDisplayFormatShort" aby sa dalo pouzit zvlast
---</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&nLast]]></FormalSpec>
<Implementation><![CDATA[
   ; 14.12.16 tt; upraveno cteni jen prvniho znaku pro druh dokumentu. Kvuli A
   s sDruhDok=$e(##class(MARC).getTagX(.handle,"970b"),1),sRes=""
   
   // akce/konference z C20
   if (sDruhDok="A") || (sDruhDok="J") || (sDruhDok="U") || (sDruhDok="C") || (sDruhDok="K") || (sDruhDok="G") || (sDruhDok="H") || (sDruhDok="N")
   { 
     if (sDruhDok="U")
     { 
        //podpole o,l,m,n patri do ()
        s sResC20=..BibcitSzfTagFormat(.handle,"C20","e"_$c(10)_"f"_$c(10)_"o"_$c(10)_"l"_$c(10)_"m"_$c(10)_"n",", "_$c(10)_", ("_$c(10)_"%-"_$c(10)_"% "_$c(10)_"%/")
        //spoleham se na to, ze v textu nebudou znaky %,(
        if ('$f(sResC20,"("))
        { s $e(sResC20,$f(sResC20,"%"),$f(sResC20,"%"))="("}
        else {s sResC20=sResC20_")"}
        s sResC20=##class(Util).strswap(sResC20,"%","")
     }
     else
     { 
       
       if ((sDruhDok="A") || (sDruhDok="J") || (sDruhDok="N"))
       { 
         ; 09.12.21 tt; pridana podpora A3
         if ($$$getTagX(.handle,"C99d")="DFLT_CZ_EPCA_A3")
         {
           //s sResC201=..BibcitSzfTagFormat(.handle,"C20","a"_$c(10)_"e"_$c(10)_"f",". "_$c(10)_". ")
           s sResC20=$p(##class(rep.zf.ub).fmtUb(.handle,"T=C20 D=\n PR=001 ST=a STD=.\s ST=e STM=zment-2-online-Online STD=.\s")," : ",2,999)
           _$p(##class(rep.zf.ub).fmtUb(.handle,"T=C20 PR=001 ST=f STM=oddel-,\s")," : ",2,999)
         }
         elseif (sDruhDok="A")
         {
           s sResC20=..BibcitSzfTagFormat(.handle,"C20","a"_$c(10)_"f"_$c(10)_"e",". "_$c(10)_", ")
         }
         else
         {
           s sResC20=..BibcitSzfTagFormat(.handle,"C20","a"_$c(10)_"e"_$c(10)_"f",". "_$c(10)_", ")
         }      
       }
       else 
       {
         s sResC20=..BibcitSzfTagFormat(.handle,"C20","a"_$c(10)_"e"_$c(10)_"p"_$c(10)_"f"_$c(10)_"o",". "_$c(10)_"&*&"_$c(10)_", "_$c(10)_" &*&")
       }
 
     }
     if sResC20'=""
     {
         s sC20f=##class(MARC).getTagX(.handle,"C20f")
         s sC20s=##class(MARC).getTagX(.handle,"C20s")
         if (sC20s'="")
         {
           s sDatum=$e(sC20f,7,8)_"."_$e(sC20f,5,6)_"."_$e(sC20f,1,4)_"-"_$e(sC20s,7,8)_"."_$e(sC20s,5,6)_"."_$e(sC20s,1,4)
           s sResC20=$$$strswap(sResC20,sC20f,sDatum)       
         }
         elseif ((sC20f'="")&&(sC20f?8N))
         { ; 22.09.16 tt; úprava zobrazování datumu
           s sDatum=$e(sC20f,7,8)_"."_$e(sC20f,5,6)_"."_$e(sC20f,1,4)  
           s sResC20=$$$strswap(sResC20,sC20f,sDatum)  
         }
         if (nLast=0) s sRes=sRes_"."
         if (nLast'=-1) s sRes=sRes_"\n"
         s sRes=sRes_"["_sResC20_"]",nLast=0   
     }    

   } 
   
   if ($$$getTagX(.handle,"C99d")="DFLT_CZ_EPCA_A3")
   {
     s sZpPre=$p(##class(rep.zf.ub).fmtUb(.handle,"T=C54 D=\n PR=001 ST=a STM=cis-EPC_UN_TC54A3-1")," : ",2,999)
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U236",1)
     s:(sZpPre'="") sRes=sRes_"\n"_sPrekPrefix_": "_sZpPre 
        
     s sPorAkce=$$$getTagX(.handle,"C20i")
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U237",1)
     s:(sPorAkce'="") sRes=sRes_"\n"_sPrekPrefix_": "_sPorAkce
           
     s sAdrAkce=$p(##class(rep.zf.ub).fmtUb(.handle,"T=C20 D=\n PR=001 ST=g STM=odkaz")," : ",2,999)
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U238",1)
     s:(sAdrAkce'="") sRes=sRes_"\n"_sPrekPrefix_": "_sAdrAkce_"&nbsp; "
   }
   
   q sRes
]]></Implementation>
</Method>

<Method name="getDisplayFormatShort">
<Description><![CDATA[
<pre>Skrateny ZF

parametre:
  nLink 1-nevladat linky; 2-vkladat linky (verzia IPAC2) 
  pTyp - pridan nepovinny parametr pTyp, ktery ovlivnuje zobrazeni
         "BZNC" - hodnota urcujici, ze se vypusti urcite informace ze zobrazovaciho
                  formatu. A to grant, výzkumný záměr, klíčová slova, kód oboru RIV, link do RIV
  pPar - rozdilne parametry
         "emph" - nahradi .u. za styl emphasis 

10.02.22 tt; provedena zmena zobrazovani poctu autoru - pokud se pocet zapsanych autoru lisi od C46a
25.11.16 tt; upravy zobrazovaci hormatu zkraceny pro DATA
16.10.12 tt; uprava zobrazeni vsech jazyku
15.10.12 tt; zakomentovano zobrazovani jen prvniho autora na zadost pani
             Dolezelove po skypu
11.10.12 tt; pridan parametr pPar pro nahrazeni .u.
17.06.12 tt; uprava vypisu zdroje financovani C12d
02.06.12 tt; upraven zf pro potreby getDisplayFormatShortCit. (volba "BZNC")
10.04.12 tt; upraveno zobrazeni druhu
24.02.12 tt; pridano a otestovano zobrazeni spoluprace C55 do kodu oboru
25.03.11 tt; doplneni opakovatelnosti pro ISBN
04.03.11 tt; pridan kod oboru RIV
12.01.11 tt; do zobrazovaciho formatu pridana verze 
27.07.09 jk; upgrade ARL1, metoda fmtCsBURL() presunuta do images.cls
13.01.09 jk; neplni se psOptions, metoda se vola i mimo IPAC2 (v IPAC1),
             kde neexistuje prostredi IPAC2
12.01.09 jk; inicializace a uklid options pro kratky ZF
15.03.07 rs; do skrateneho ZF pridany link do portalu VaV (RIV)
13.03.07 mk; uprava URL na univerzalnu funkciu 
26.02.07 mk; upravy ZF podla poziadaviek Dolezelovej
24.02.07 mk; upravy ZF podla poziadaviek Dolezelovej
14.03.06 jj; doplneni osetreni posl. znaku za autory
09.01.06 jj; zobrazit autora i v případě samotného 702 
16.12.05 jj; do tzf zapsat IF jen v pripade druhu dokumentu "J", "N"
..
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.Binary,nLink:%Library.Integer=1,pTyp="",pPar=""]]></FormalSpec>
<Implementation><![CDATA[
   ; 13.01.09 jk; metoda se vola i mimo IPAC2 (v IPAC1), kde neexistuje prostredi IPAC2
   ; 12.01.09 jk; inicializace options pro kratky ZF
   if ('##class(rep.zf.tf).bTfBlockRunningFromIpac(.handle))
   { ; 16.08.14 tt; upravena podminka, aby se neprepraskavalo nastaveni z ipacu u zf, kde je
     s psOptions="" //##class(i2.common).getDisplayFmtOptions(.handle)
     d ##class(rep.zf.tf).formatXinit(.handle,psOptions)
   
     d:($g(handle("tmp","modif_TF","language"))="") ##class(rep.zf.tf).setMod(.handle,"language",2)
     d ##class(rep.zf.tf).setMod(.handle,"ictx","Cav")
   }
   
   s sT001=$$$HandleT001(handle)       ; ziskani t001
   s sClass=$$$HandleClass(handle)     ; ziskani tridy
   if (('##class(User.MARC).readX(.handleX,sClass,sT001))||(sT001="new"))
   { ; 31.03.23 tt; oprava problemu, kdyby se nenacetl handle
     d ##class(User.MARC).mergeX(.handleX,.handle)
   }
 
   // urceni druhu dokumentu
   s sDruhDok=$$$getTagX(.handle,"970b")
   s T969=$$$getTagX(.handle,"969")
   s isDEZ=$f($zcvt(T969,"L"),$c(31)_"fd")>0
   ; 17.08.15 tt; pridana funkce na vypis neodeslan
   s:('isDEZ) isDEZ=$f($zcvt(T969,"L"),$c(31)_"fn")>0

   s sRes="",nLast=0
   
   // prvni radek sZF:
   // 1/ 001 - C99a C26b C26a 102a 101a 970b\n
   // 2/ 001 C26e C26d C26b C26a 102a 101a 970b\n  (je-li C99a="")
   //
   // sysno
   s sRes=$$$getTagX(.handle,"001")
   ; 13.09.05 rs; pridany status neodoslany zaznam
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U121")     
   if isDEZ s sRes="["_sPrekPrefix_"] "_sRes
   
   s TC99a=$$$getTagX(.handle,"C99a")
   s TC26=$$$getTagX(.handle,"C26")
   
   ; 08.07.05 rs; presun inicializacie na ine miesto
   s sResC26="",TC26e="",TC26d=""
   if (TC99a="")
   { 
     if (TC26'="") {
       s TC26e=##class(MARC).getSubTagStr(.TC26,"e")
       ; 07.01.19 tt; pridany preklad ustavu do zkraceneho zf
       s:(TC26e'="") TC26e=##class(User.Util).sXlate("CAV_PRA",$zcvt(TC26e,"U"),"","Cav")
     }
     if (TC26e'="") {s sResC26=" - "_TC26e}
     if (TC26'="") {s TC26d=##class(MARC).getSubTagStr(.TC26,"d")}
     //if (sDruhDok="DATA") {s sResC26=sResC26_" ("_$e($$$getTagX(.handle,"100a"),1,4)_")"}
     ; 09.11.21 tt; odstranen rok pro zobrazeni dat
     if (sDruhDok="DATA") {s sResC26=sResC26}

     if ((TC26d'="")&&(sDruhDok'="DATA")) {s sResC26=sResC26_" "_TC26d}
   }
   if (TC99a'="") {s sRes=sRes_" - "_TC99a}
   else {s sRes=sRes_sResC26}
   if (sRes'="") {s nLast=($e(sRes,$l(sRes)))="."}
   
   // RIV 
   s sResC26b="",sResC26a="" ; 08.07.05 rs; presun inicializacie na ine miesto
   if (TC26'="") {s sResC26b=##class(MARC).getSubTagStr(.TC26,"b")}
   if (sResC26b) {s sRes=sRes_" RIV"}
   
   // sigle
   if (TC26'="") {s sResC26a=##class(MARC).getSubTagStr(.TC26,"a")}
   if (sResC26a) {s sRes=sRes_" SIGLE"}
   
   // zeme vydani
   s sRes102a=##class(MARC).getTagX(.handle,"102a")
   if ((sRes102a'="")&&(sDruhDok'="DATA")) {s sRes=sRes_" "_sRes102a}
   
   // jazyk
   ;s sRes101a=##class(MARC).getTagX(.handle,"101a")
   ; 16.10.12 tt; uprava zobrazeni vsech jazyku
   s sRes101=##class(MARC).getTagX(.handle,"101")
   s sRes101a=$$$strswap($$$getSubTagStrC(sRes101,"a",-1),$c(10),", ")
   if ((sRes101a'="")&&(sDruhDok'="DATA")) {s sRes=sRes_" "_sRes101a}
   
   // druh dokumentu
   if (sDruhDok'="") 
   {  ; 10.04.12 tt; upraveno zobrazeni druhu
      s sDruhDokT=##class(User.Util).sXlate("TF_ZPZ",$zcvt(sDruhDok,"L"),"N","Cav",,$g(handle("tmp","modif_TF","language"),"-1"))
      s:($$$getTagX(.handle,"C99d")="DFLT_CZ_EPCA_A3") sDruhDokT=$$$strswap(sDruhDokT,"A : Abstrakt",..prekladPrefixuIpac(.handle,"U235",0) )
      ; 03.12.22 tt; upraven zf pro data - verze, vypsana hlavicka a informace o verzich
      ///s:(sDruhDok="DATA") sDruhDokT="<strong>"_$tr(sDruhDokT,":","")_"</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_..versionZfGetData(.handle,"U244-U245-")
      s:(sDruhDok="DATA") sDruhDokT="<strong>"_$tr(sDruhDokT,":","")_"</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_##class(User.CavS).zfDatumZverejneni(.handle,"--1")

      s:(sDruhDokT'="") sRes=sRes_" "_$$$strswap(sDruhDokT," : "," - ")
      s:(sDruhDokT="") sRes=sRes_" "_sDruhDok
   }
   
   /// 25.11.16 tt; upravy zobrazovaci hormatu zkraceny pro DATA
   if (($$$getTagX(.handle,"C99d")="DFLTI_EPCA_CZ_WOSSCOPUS")&&($f($$$getTagX(.handle,"999d"),"arl_import_wos")))
   {  /// 09.02.22 tt; provedena uprava pro stazene zaznamy z wos oznacene v kratkem zobrazovacim formatu
      s sPrekPrefix=..prekladPrefixuIpac(.handle,"U239")     
      s sRes608a=$$$getTagX(.handle,"608a")
      if (sRes608a'="") { s sRes=sRes_" <font color=""red"">"_sPrekPrefix_sRes608a_"</font>" }
      else { s sRes=sRes_" <font color=""red"">"_$tr(sPrekPrefix,"-/","")_"</font>" }      
   }

   // konec prvniho radku
   s sRes=sRes_"\n",nLast=-1
   
   // autori
   ; 09.10.20 tt; pridane prijmeni jako velka pismena, jde to znastavenim zrusit - upraveno nastaveni
   s sRes70x=..BibcitSzfAuthors(.handle,"",2,(",AutMaleP,"_pPar))    //70x
   if (pTyp="BZNC") 
   {
    ; 15.10.12 tt; zakomentovano zobrazovani jen prvniho autora na zadost pani
    ;              Dolezelove po skypu
    ;s sRes70x=..BibcitSzfAuthors(.handle,"",1)    //70x
    s sRes70x=$$$strswap(sRes70x,".sup.G./sup.","")
   }
   if sRes70x=".b../b." s sRes70x=""
   
   // 10.02.22 tt; provedena zmena zobrazovani poctu autoru - pokud se pocet zapsanych autoru lisi od C46a
   s c=0,nPocet=0
   d {
     s sT70x=$$$getTagXC(.handle,"70*",.c) ; vsetky citacie
     continue:((sT70x="")&&(c'=0))
     if (sT70x'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s nPocet=nPocet+1
     }
   } while (c'=0)
   s sC46a=$$$getTagX(.handle,"C46a")
   if ((sC46a'="")&&(sC46a>nPocet))
   { ; prefix - … celkem 449 autorů
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U240") 
     s sPrekPrefix=$$$strswap(sPrekPrefix,"XXXX",sC46a)
     s sRes70x=sRes70x_sPrekPrefix_""  
   }


   if (sRes70x'="")
   // 14.03.06 jj; doplneni osetreni posl. znaku za autory
   { s sRes=sRes_..BibcitSzfCheckLast(sRes70x,.nLast)_"\n",nLast=-1}
   
   /// 01.11.23 tt; cs122294 - Dát mezeru mezi autorem a názvem
   s:(sDruhDok="DATA") sRes=sRes_"\n"

   // nazev
   s sRes200a=$$$getTagX(.handle,"200a")
   if ((sDruhDok="G") || (sDruhDok="V") || (sDruhDok="B") || (sDruhDok="H"))
   { ; 23.06.16 tt; upravy podle  doplneni k ZF - edice - cs30872 pro B,G,V nazev kurzivou
     s:(sRes200a'="") sRes200a="<em>"_sRes200a_".</em>"
   }
   
   if (sDruhDok="DATA")
   {  ; 06.04.17 tt; zmeny provadene kvuli zf velkych dat 
      s sRes200e=$$$getTagX(.handle,"200e")
      s:(sRes200e'="") sRes200a=sRes200a_". "_sRes200e
   }
   if (sRes200a'="")
   { s sRes=sRes_..BibcitSzfCheckLast(sRes200a,.nLast)
            _..BibcitSzfCheckLast("",.nLast)
     s sRes=sRes_"\n",nLast=-1
   }
   
   ; 26.02.07 mk pridany tag 300a za nazov a C26o, osetrenie prazdneho riadku
   if (sDruhDok="W") 
   {
     s sRes300=..BibcitSzfTagFormat(.handle,"300","a","","","",". ")
     s sResC26=..BibcitSzfTagFormat(.handle,"C26","o","","","",". ")
     s sResC26n=..BibcitSzfTagFormat(.handle,"C26","n","","","",". ")
     s sRes1=""
     if sRes300'="" s sRes1=sRes1_sRes300  
     
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U120",1)   
     if sRes1'=""
     {
       if sResC26n'="" s sRes1=sRes1_". "_sPrekPrefix_": "_sResC26n
     }
     else
     {
       if sResC26n'="" s sRes1=sRes1_sPrekPrefix_": "_sResC26n
     }
     
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U119",1)     
     if sRes1'="" 
     {
       if sResC26'="" s sRes1=sRes1_". "_sPrekPrefix_": "_sResC26
     }
     else
     {
       if sResC26'="" s sRes1=sRes1_sPrekPrefix_": "_sResC26
     }    
     if sRes1'="" 
     {
       if $e(sRes,$l(sRes)-1,$l(sRes))="\n"
       {
         s sRes=sRes_sRes1  
       }
       else
       {
         s sRes=sRes_"\n"_sRes1  
       }           
     }     
   }      
   
   
   // preklad nazvu
   // nLast = -1 => oddelovac nastaven na ""
   s sRes541a=$$$strswap($$$getTagX(.handle,"541a"),"...","…")
   s sRes541z=$$$getTagX(.handle,"541z")
   s:((pTyp="BZNC")&&(sRes541z="cze")) sRes541a=""
   if (sRes541a'="")
   { s sRes=sRes_"["_..BibcitSzfCheckLast(sRes541a,.nLast)
            _..BibcitSzfCheckLast("",.nLast,"]")
     s sRes=sRes_"\n",nLast=-1
   }
   
   if (sDruhDok="DATA")
   { /// 1.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno
     s sVer1=##class(User.CavUnEpca).versionZfGetData(.handle,"U244-U245-")
     s sVer2=##class(User.CavUnEpca).versionZfGetData(.handle,"U244-U245-U246--U248")
     s:(sVer1'="")||(sVer2'="") sRes=sRes_"<strong><font color=""red"">"_sVer1_"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_sVer2_"</font></strong>\n"
   }
   
   // dizertace
   ; 24.02.07 zmena formatovani
   ;s sResC30=..BibcitSzfTagFormat(.handle,"C30","j"_$c(10)_"i"_$c(10)_"e"," : "_$c(10)_", ")
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U118",1)     
   s sResC30=..BibcitSzfTagFormat(.handle,"C30","i"_$c(10)_"l"_$c(10)_"a",". "_sPrekPrefix_": "_$c(10)_". ")
   
   if (sDruhDok="DATA")
   {  /// 25.11.16 tt; upravy zobrazovaci hormatu zkraceny pro DATA
      s sResC15a="",sResC15b=""
      s sPrekPrefix=..prekladPrefixuIpac(.handle,"U160",1),sPrekPrefixb=..prekladPrefixuIpac(.handle,"U161",1)
      s sPopisPrefix=..prekladPrefixuIpac(.handle,"U253",1)
      s sResC15a=$$$getTagX(.handle,"C15a"), sResC15b=$$$getTagX(.handle,"C15b")
      
      ; 06.09.17 tt; upraveno zobrazovani datasetu 
      s:(sResC15a'="") sResC15a="\n"_sPopisPrefix_sResC15a
      ; 06.04.17 tt; zmeny provadene kvuli zf velkych dat 
      s:((sResC15a'="")&&(sResC15b'="")) sResC15a=sResC15a_"\n"
      s:(sResC15b'="") sResC15b="["_sResC15b_"]"
      if ((sResC15a'="")||(sResC15b'=""))
      {
        s sRes=sRes_sResC15a_sResC15b
      }
      s sPoznPrefix=..prekladPrefixuIpac(.handle,"U234",1)
      ; 31.10.21 tt; pridana poznamka k zf dat 237a
      s s327a=$$$getTagX(.handle,"327a")
      s:(s327a'="") sRes=sRes_"\n"_sPoznPrefix_": "_s327a
      
      s sPoznPrefix=..prekladPrefixuIpac(.handle,"U250",1)
      ; 04.05.23 tt; popis změny dat
      s sU03c=$$$getTagX(.handle,"U03c")
      s:(sU03c'="") sRes=sRes_"\n"_sPoznPrefix_": "_sU03c
      
      s:($$$getTagX(.handle,"C12a")="") sRes=sRes_"\n"   
      
      s sPrekPrefix=..prekladPrefixuIpac(.handle,"U111",1)
      s sResKS=..BibcitSzfTagFormat(.handle,"610","a","","",sPrekPrefix," * ")
      if ((sResKS'="")&&(pTyp'="BZNC")) s sRes=sRes_"\n"_sResKS   
   }   
   
   if (sResC30'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC30,.nLast)}
   // druh el. dok.
   if (sDruhDok="E")
   { s sRes856q=##class(MARC).getTagX(.handle,"856q") //[856q]
     if (sRes856q'="")
     ; 24.02.07 mk uoprava [] v 856q
     { s sRes=sRes_"["_..BibcitSzfCheckLast(sRes856q,.nLast)_"]",nLast=0}
   }
   
   ; 26.02.07 mk treba ich spojit do bloku a [ presunut pred autorov len pre R1
   //autori puv. prace
   s sRes47070x=..BibcitSzfAuthorsR(.handle)      //470/70x
   ;if (sRes47070x'="")
   ;{ s sRes=sRes_..BibcitSzfCheckLast(sRes47070x,.nLast," Orig.: ")}
   
   //citace puv. prace
   s sRes470=##class(MARC).getTagX(.handle,"470") //[470/200a]
   s sRes470200a=""
   if (sRes470'="")
   { s sRes470200a=##class(MARC).getTag4xx(sRes470,"200a")}
   
   ; 26.02.07 mk spojenie v jednom bloku osetrene rozne varianty
   if (sRes47070x'="") || (sRes470200a'="")
   {  
     s sRes1=""
     if (sRes47070x'="") { s sRes1=sRes1_..BibcitSzfCheckLast(sRes47070x,.nLast," Orig.: ")}
     if (sRes470200a'="") {s sRes1=sRes1_": "_sRes470200a_"]",nLast=0}
     if $e(sRes1,1,2)=": " s sRes1=$e(sRes1,3,9999)
     if $e(sRes1,1,1)'="[" s sRes1="["_sRes1

     // 13.08.07 jj; fix vkladaneho oddelovace
     s sRes1=$$$strswap(sRes1,"[. - ","[")

     s sRes=sRes_sRes1
   }  
   
   if ((sDruhDok="I") || (sDruhDok="V") || (sDruhDok="B"))
   { s sRes205a=$$$getTagX(.handle,"205a") //205a
     if (sRes205a'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes205a,.nLast)}
   }
   
  
   if ((sDruhDok="L") || (sDruhDok="L2") || (sDruhDok="L3") || (sDruhDok="L4")|| (sDruhDok="Z"))
   { ; 14.04.12 tt; pro druh l zobtazit interni kod
     ; 27.04.12 tt; upravy zobrazeni 
     s sLTC34a=$$$getTagX(.handle,"C34a") 
     s sLT210d=$$$getTagX(.handle,"210d") 
     if (sLTC34a'="")
     { ; pokud mame data, budeme zobrazovat
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"0429",1)     
       s sRes=sRes_sPrekPrefix_": "_sLTC34a
       s:(sLT210d'="") sRes=sRes_" ; "
     }
   }
   
   if (sDruhDok="L1")
   { ; 15.04.12 tt; pro druh l zobtazit interni kod
     s sLTC34o=$$$getTagX(.handle,"C34o")
     s sLTC34p=$$$getTagX(.handle,"C34p") 
     s:((sLTC34o'="")&&(sLTC34p'="")) sLTC34p=" ; "_sLTC34p
     s sLT210d=$$$getTagX(.handle,"210d") 
     if ((sLTC34o'="")||(sLTC34p'=""))
     { ; pokud mame data, budeme zobrazovat
       s sRes=sRes_sLTC34o_sLTC34p
       s:(sLT210d'="") sRes=sRes_" ; "
     }
   }
   
   ; 18.03.07 vydavatelske udaje riesit opakovanie 
   if (sDruhDok'="")
   { 
     s sTag210=$$$getTagX(.handle,"210") 
     s pocetc=$l(sTag210,$c(31)) 
     s sRes210=""
     f c=2:1:pocetc
     {
       s tt=$p(sTag210,$c(31),c) ; jeden subtag 
       s sub=$e(tt,1,1)  ; nazov subtagu
       s tt=$e(tt,2,9999)
       ; 23.06.16 tt; upravy podle  doplneni k ZF - edice - cs30872 - odd=" : "
       if (sub="a") || (sub = "c") s odd=": "
       if (sub="d") s odd=", "
       if sRes210="" s odd=""
       s sRes210=sRes210_odd_tt 
     
     }
     ;s sRes210=..BibcitSzfTagFormat(.handle,"210","a"_$c(10)_"c"_$c(10)_"d"," : "_$c(10)_", ")
     if (sRes210'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes210,.nLast," - ")}
   }
   
   if ((sDruhDok="L") || (sDruhDok="L2") || (sDruhDok="L3") || (sDruhDok="L4") || (sDruhDok="Z"))
   { ; 15.04.12 tt; pro druh l zobtazit interni kod
     ; 27.04.12 tt; upravy zobrazeni 
     s sLTC34c=$$$getTagX(.handle,"C34c") 
     s sLTC34d=$$$getTagX(.handle,"C34d") 
     if (sLTC34c'="")
     { ; pokud mame data, budeme zobrazovat technicke parametry
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U011",1)     
       s sRes=sRes_"\n"_sPrekPrefix_": "_sLTC34c_"\n"
     }
     if (sLTC34d'="")
     { ; pokud mame data, budeme zobrazovat technicke parametry
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U012",1)     
       s sRes=sRes_sPrekPrefix_": "_sLTC34d
     }
   }   
  
   ; 27.04.12 tt; upravy zobrazeni 
   if (sDruhDok="L3")
   { ; 15.04.12 tt; pro druh l zobtazit interni kod
     s sLTC34s=$$$getTagX(.handle,"C34s")  ; certifikacni organ 
     s sLTC34t=$$$getTagX(.handle,"C34t")  ; datum certifikace
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U025",1)     
     s:(sLTC34s'="") sLTC34s=sPrekPrefix_": "_sLTC34s_". "
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U117",1)   
     s:(sLTC34t'="") sLTC34t=sPrekPrefix_": "_sLTC34t
     s:((sLTC34s'="")||(sLTC34t'="")) sRes=sRes_"\n"_sLTC34s_sLTC34t
   }
   
   /*if (sDruhDok="E")
   { s sRes215c=##class(MARC).getTagX(.handle,"215c") 
     if (sRes215c'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes215c,.nLast)}
   }*/
   
   ; 26.02.07 mk riesenie pre dokument P a ostatne
   if ((sDruhDok="P")||(sDruhDok="P1"))
   { ; 27.04.12 tt; upravy zobrazeni Patentu
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U085",1)     
     s sPrekPrefixD=..prekladPrefixuIpac(.handle,"U122",1)     
     s:(sDruhDok="P") sResC11=..BibcitSzfTagFormat(.handle,"C11","e"_$c(10)_"b"_$c(10)_"c",". "_sPrekPrefixD_": "_$c(10)_". "_sPrekPrefix_": ")
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U086")     
     s:(sDruhDok="P1") sResC11=..BibcitSzfTagFormat(.handle,"C11","e"_$c(10)_"b"_$c(10)_"c",". "_sPrekPrefixD_": "_$c(10)_". "_sPrekPrefix_": ")
     if (sResC11'="") 
     {
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"0898",1)     
       s:($$$getTagX(.handle,"C11e")'="") sResC11=sPrekPrefix_": "_sResC11
       s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)
     }
   }
   else
   {
     s sResC11=..BibcitSzfTagFormat(.handle,"C11","f"_$c(10)_"e"_$c(10)_"c"," : "_$c(10)_", ")
     if (sResC11'="") {s sRes=sRes_..BibcitSzfCheckLast(sResC11,.nLast)}
   }       
   
   
   if ((sDruhDok="I") || (sDruhDok="V") ||
       (sDruhDok="B") || (sDruhDok="D") || 
       (sDruhDok="G") || (sDruhDok="H") || (sDruhDok="P"))
   {        
     s sRes215a=##class(MARC).getTagX(.handle,"215a") //215a
     if (sRes215a'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes215a,.nLast)}
   }
       
   s sResC11a=##class(MARC).getTagX(.handle,"C11a") //C11a
   if (sResC11a'="") 
   { ; 27.04.12 tt; upravy zobrazeni Patentu
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U113",1)
     s:(sDruhDok="P") sResC11a=sPrekPrefix_": "_sResC11a
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U088",1)
     s:(sDruhDok="P1") sResC11a=sPrekPrefix_": "_sResC11a
     s sRes=sRes_..BibcitSzfCheckLast(sResC11a,.nLast)
   }
   
   s sResC11=$$$getTagX(.handle,"C11") //C11t
   s sResC11t=$$$getSubTagStrC(sResC11,"t",-1)
   s sC11ttext=""
   if (sResC11t'="") 
   { ; 27.04.12 tt; upravy zobrazeni Patentu
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U260",1)
     for opst=1:1:($l(sResC11t,$c(10)))
     { ; pres vsechny opakovani subtagu
       s sSTt1=$p(sResC11t,$c(10),opst)  ; ziskana hodnota jednoho opakovani
       d ##class(rep.zf.ub).ubCis(.sSTt1,.handle,"","STABLE_EPC_UN_TC11T-1")
       s:(sC11ttext'="") sC11ttext=sC11ttext_","_sSTt1 
       s:(sC11ttext="") sC11ttext=". "_sPrekPrefix_": "_sSTt1 
     }
     if (sC11ttext'="") 
     {
       s sC11ttext=sC11ttext_"."
       s sRes=sRes_sC11ttext
     }
   }

   
   if (sDruhDok="E")
   { s sRes856s=##class(MARC).getTagX(.handle,"856s") //856s
     if (sRes856s'="")
     { s sRes=sRes_", "_sRes856s,nLast=($e(sRes856s,$l(sRes856s)))="."}
     ;s sRes856u=##class(MARC).getTagX(.handle,"856u") //856u
     ;if (sRes856u'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes856u,.nLast)}
   }
   
   // edice 
   // syntaxe : "(225a, 225v)"
   s sRes225=..BibcitSzfTagFormat(.handle,"225",
             "a"_$c(10)_"v",", ")
   if (sRes225'="")
   { 
     if ('nLast) {s sRes=sRes_"."}
     ; 24.02.07 mk riesenie prefixu - ak sa jedna o dokumenty G a H a je 215a
     //s pomlcka=" - "
     // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - odstranene pomlcka 
     s pomlcka=" "
     if (sDruhDok="G") || (sDruhDok="H") 
     {
       s sRes215a=##class(MARC).getTagX(.handle,"215a") //215a
       if sRes215a'="" s pomlcka = ""
     }
     
     s sRes225x=$$$getTagX(.handle,"225x") 
     s:(sRes225x'="") sRes225x=", ISSN "_sRes225x
     //s sRes=sRes_pomlcka_" ("_sRes225_sRes225x_")"
     // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - odstraneny zavorky
     s sRes=sRes_pomlcka_" "_sRes225_sRes225x
     s:(($e(sRes225,$l(sRes225)))'=".") sRes=sRes_"."
     s nLast=($e(sRes225,$l(sRes225)))="."
   }
   
   if (sDruhDok'="E")
   { 
     ; 25.03.11 tt; doplneni opakovatelnosti pro ISBN
     s sRes010a=$$$getTagXC(.handle,"010a",-1) //010a
     s sRes010a=$$$strswap(sRes010a,$c(10),"; ISBN ")
     s sRes011a=##class(MARC).getTagX(.handle,"011a") //011a
     s sRes011e=##class(MARC).getTagX(.handle,"011e") //011e
     
     if (sDruhDok="L2")&&((sRes010a'="")||(sRes011a'="")||(sRes011e'=""))
     { ; 07.02.18 tt; provedena uprava a pridani ., pokud tam neni.
      s:(($e(sRes,$l(sRes)))'=".") sRes=sRes_"."
      s nLast=($e(sRes,$l(sRes)))="."
     }
     s:(sRes010a'="") sRes=sRes_..BibcitSzfCheckLast(sRes010a,.nLast," ISBN ")
     s:(sRes011a'="") sRes=sRes_..BibcitSzfCheckLast(sRes011a,.nLast," ISSN ")
     s:(sRes011e'="") sRes=sRes_..BibcitSzfCheckLast(sRes011e,.nLast," E-ISSN ")
     
     ; pridana verze - online / print
     s sB=$$$getTagX(.handle,"205a")
     s:((sB'="")&&('((sDruhDok="I") || (sDruhDok="V") || (sDruhDok="B")))) sRes=sRes_". "_sB
   
     ; zobrazeni poznamek z tagu 301
     s c=0
     d { ; cyklus pres vsechny opakovani tagu
       s sT301=##class(User.MARC).getTagX(.handle,"301",.c) ; vsetky citacie
       continue:(sT301="")
       s sB=##class(User.MARC).getSubTagStr(sT301,"a")
       s:(sB'="") sRes=sRes_". "_sB
     } while (c'=0) 
      
   }

   // zpracovani 463
   s sRes463=$$$getTagX(.handle,"463")
   
   if ((sDruhDok'="T2") && (sDruhDok'="R2"))
   { s sRes463200a=""
     if (sRes463'="")
     { s sRes463200a=##class(MARC).getTag4xx(sRes463,"200a")
       s:(sRes463200a="") sRes463200a=$$$getTagX(.handle,"U63a")
       ; 23.06.16 tt; upravy podle  doplneni k ZF - edice - cs30872 - pridana . za
       s:(sRes463200a'="") sRes463200a=sRes463200a_"."
     }
     // odd. je ". " nebo ". In " dle formulare
     if (sRes463200a'="")
     { if ((sDruhDok="A2") || (sDruhDok="C") || (sDruhDok="K") ||
           (sDruhDok="G") || (sDruhDok="H") || (sDruhDok="M"))
       { s sRes=sRes_..BibcitSzfCheckLast(sRes463200a,.nLast," In: ",2)}
       else
       { s sRes=sRes_..BibcitSzfCheckLast(sRes463200a,.nLast, " ", 2)}
     }
   }
   
   if ((sDruhDok="J")||(sDruhDok="JI"))
   { ; 04.12.18 tt; provadeny upravy zf
     s sRes463200d=""
     if (sRes463'="")
     { s sRes463200d=##class(MARC).getTag4xx(sRes463,"200d")}
     
     if (sRes463200d'="")
     { 
       s sRes=sRes_..BibcitSzfCheckLast(sRes463200d,.nLast," = ",2)
     }
   }
   
   /// 15.03.14 tt; nastaveno zobrazovani 200h pro vsechny sbornikove zaznamy
   /// 09.03.14 tt; pridano zobrazeni 200h do C
   //if ((sDruhDok="C"))
   if (..getTypZaznamuAkZbornik(.handle)'="")
   { 
     s sRes463200h=""
     if (sRes463'="")
     { s sRes463200h=##class(MARC).getTag4xx(sRes463,"200h")}
     
     if (sRes463200h'="")
     { 
       s:('$f($zcvt(sRes463200h,"U"),"VOL")) sRes463200h="Vol. "_$tr(sRes463200h,",.")
       s sRes=sRes_..BibcitSzfCheckLast(sRes463200h,.nLast)
     }
   }

   if (sDruhDok="M")
   { s sRes463205a=""
     if (sRes463'="")
     { s sRes463205a=##class(MARC).getTag4xx(sRes463,"205a")}
     if (sRes463205a'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes463205a,.nLast)}
   }
   if ((sDruhDok'="A1") &&  (sDruhDok'="J") && (sDruhDok'="N") &&
       (sDruhDok'="T1") && (sDruhDok'="R1"))
   { s sRes463210=..getPublicationS(.handle)  //463/210
     if (sRes463210'="") {s sRes=sRes_..BibcitSzfCheckLast(sRes463210,.nLast)}
   }
   if ((sDruhDok="T2") || (sDruhDok="R2"))
   { s sRes463200i=""
     if (sRes463'="")
     { s sRes463200i=##class(MARC).getTag4xx(sRes463,"200i")}
     if (sRes463200i'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes463200i,.nLast)}
   }
   if ((sDruhDok="T2") || (sDruhDok="R2"))
   { 
     s sRes463200h=""
     if (sRes463'="")
     { s sRes463200h=##class(MARC).getTag4xx(sRes463,"200h")}
     if (sRes463200h'="")
     { s sRes=sRes_..BibcitSzfCheckLast(sRes463200h,.nLast)}
   }
   

   // editor
   if (sRes463'="")
   {
     ;s sRes463702=##class(MARC).getTag4xx(sRes463,"702")
     ; pracuje ako single co je chyba musime spracovat rucne
     ; treba spracovat vsetky opakovania tagu 702
     ; z sRes463 v cykle precitat
     s pocet1=$l(sRes463,$c(31)_"1") ; pocet casti tagu 463
     s sOdd=" - ",eddall=""

     for l=1:1:pocet1
     {
       s r463=$p(sRes463,$c(31)_"1",l)  ; jeden tag 
       s sRes463702=""
       if $e(r463,1,3)="702" s sRes463702=r463
       if (sRes463702'="")
       { 
         s nLast=1,sResE=""
         s sRes7024=##class(MARC).getSubTagStr(sRes463702,"4") 
         s sRes702a=##class(MARC).getSubTagStr(sRes463702,"a")
         s sRes702b=##class(MARC).getSubTagStr(sRes463702,"b") 
         if ((sRes702a'="") && (sRes7024="340"))  ; ak je a a je to editor zapracovat
         {
           s sResE=sRes702a
           if (sRes702b'="") {s sResE=sResE_", "_$e(sRes702b,1,1)_"."}
    
           if (sResE'="")
           {
             if eddall'="" s eddall=eddall_"; "_sResE
             if eddall="" s eddall=sResE
           } 
         } ; koniec podmienky pridavania editora 
       } ; koniec podmienky ci existuje tag 702
     } ; koniec cyklu for l
     ; zapis do res
     if eddall'="" s sRes=sRes_" - ("_eddall_")"
   }
 
   s sRes463200v=""
   if (sRes463'="")
   { s sRes463200v=##class(MARC).getTag4xx(sRes463,"200v")}
   if (sRes463200v'="")
   { ; 06.04.12 tt; zmena pri zobrazovani 463
     s:$f(sRes463200v,"S. ") sRes463200v=$zcvt(sRes463200v,"L") 
     if ((sDruhDok="C") || (sDruhDok="K") || (sDruhDok="M"))
     { ; 29.08.12 tt; rozdeleni zobrazovani oddelovace podle druhu dokumentu
       s sRes463200v=..BibcitSzfCheckLast(sRes463200v,0,", ")
     }
     else
     {
       s sRes463200v=..BibcitSzfCheckLast(sRes463200v,0,". ")
     }
     s $e(sRes463200v,1)=""
     s sRes=sRes_sRes463200v
   }

   ; 11.11.16 tt; upravy kvuli prebirani zaznamu
   s sC82a=$$$getTagX(.handle,"C82a")
   if (sC82a'="")
   { ; 04.11.16 tt; pridano zobrazovani cisla clanku
     s sC82a=" č. článku "_sC82a
     s:('$f($e(sRes,($l(sRes)-2),$l(sRes)),",")) sC82a=","_sC82a_"."
     s sRes=sRes_sC82a
   }

   // edice
   if ((sDruhDok="M") || (sDruhDok="C") || (sDruhDok="K"))
   {
     s sRes463225=""
     if (sRes463'="")
     { s sRes463225=##class(MARC).getTag4xx(sRes463,"225")
       if (sRes463225'="")
       { // nastaveni oddelovacu
         // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - oddelovace ,
         //s sO1=". ",sO2=". "
         s sO1=", ",sO2=", "
         s sTemp=##class(MARC).getSubTagStr(sRes463225,"a")
         s nLastTemp=($e(sTemp,$l(sTemp)))="."
         if (nLastTemp) {s sO1=" "}
         s sTemp=##class(MARC).getSubTagStr(sRes463225,"i")
         s nLastTemp=($e(sTemp,$l(sTemp)))="."
         if (nLastTemp) {s sO2=" "}
       
         s sRes225=..BibcitSzfTagFormat("","225",
                   "a"_$c(10)_"i"_$c(10)_"v",sO1_$c(10)_sO2, sRes463225)
         if (sRes225'="")
         { 
           if ('nLast) {s sRes=sRes_"."}
           /// 02.06.16 tt; upravy na zadost cav cs30805
           s:($e(sRes,$l(sRes))'=".") sRes=sRes_"."
           // 12.06.16 tt; upravy zobrazeni edice v zf dle cs30872 - odstraneny zavorky
           //s sRes=sRes_" ("_sRes225_")"
           s sRes=sRes_" "_sRes225
           s nLast=($e(sRes225,$l(sRes225)))="."
         }
       }
     } 
   }
   
   s sRes463010a=""
   if (sRes463'="")
   { 
     s sRes463010a=##class(MARC).getTag4xx(sRes463,"010a")
     ; 25.03.11 tt; doplnena podpora ISBN u 4xx
     d ##class(User.MARC).t4xx2handle(.h4xx, sRes463) 
     s sRes463010a1=$$$getTagXC(.h4xx,"010a",-1) //010a
     s sRes463010a1=$$$strswap(sRes463010a1,$c(10),"; ISBN ")
     s:(sRes463010a1'="") sRes463010a=sRes463010a1
   }
   if (sRes463010a'="")
   { 
     s:('$f(". /*-+,",$e(sRes,$l(sRes)))) sRes=sRes_"."
     s sRes=sRes_..BibcitSzfCheckLast(sRes463010a,.nLast," ISBN ")
   }
   
   if ((sDruhDok'="M") && (sDruhDok'="T2") && (sDruhDok'="R2"))
   { s sRes463011a="",sRes463011e=""
     s:(sRes463'="") sRes463011a=##class(MARC).getTag4xx(sRes463,"011a")
     s:(sRes463'="") sRes463011e=##class(MARC).getTag4xx(sRes463,"011e")
     
     s:(sRes463011a'="") sRes=sRes_..BibcitSzfCheckLast(sRes463011a,.nLast,". ISSN ")
     s:(sRes463011e'="") sRes=sRes_..BibcitSzfCheckLast(sRes463011e,.nLast,". E-ISSN ")
   }
   
   

   s s=..getDisplayFormatShortC20(.handle,.nLast),sRes=sRes_s
   
   // grant z C12:
   // c12$b,(c12$e),c12$a - cep
   // c12$c,(c12$e),c12$a - ostatni
   s sResG=..SzfGrant(.handle)
   s:((sResG'="")&&(pTyp'="BZNC")&&(sDruhDok'="DATA")) sRes=sRes_sResG
 
   //////////////////////
   ; 20.12.20 tt; pridano a otestovano zobrazeni vyzkumne infrastruktury (C90)
   s c=0,bC90pref=0
   d {
     s sTC90=$$$getTagXC(.handle,"C90",.c) ; vsechny vyzkumne infrastruktury
     continue:((sTC90="")&&(c'=0))         ; pokud nemam data pokracuji
     if (sTC90'="") 
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC90a=$$$getSubTagStr(sTC90,"a")
       if (sTC90a'="")
       { ; pokud mame vyplnene obe pole, pridavame
         ; 19.06.12 tt; oprava prekladu podle ciselniku, musi byt definovana hodnota 
         s sTC90aT=sTC90a
         //d ##class(rep.zf.ub).ubCis(.sTC90aT,.handle,"","UN_INFRASTRUKTURA_ZF-1") 
         d ##class(rep.zf.ub).ubCis(.sTC90aT,.handle,"","UN_INFRASTRUKTURA-1") 

         if (bC90pref=0)
         { ; nemame prefix a musime ho vlozit
           s sPrekPrefix=..prekladPrefixuIpac(.handle,"U205",1)
           s sRes=sRes_"\n"_sPrekPrefix_": "_sTC90aT_" - "_sTC90a
           s bC90pref=1 ; naplnime priznak, ze mame prefix
         }
         else 
         { ; mame prefix, jen prilozime retezec
           s sRes=sRes_"; "_sTC90aT_" - "_sTC90a 
         }
       }
     }
   } while (c'=0)
   ////////////////////////


   // vyzkumny zamer
   // \nVýzkumný záměr: C13a; C13a; C13a
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U116",1)
   s sResVZ=..BibcitSzfTagFormat(.handle,"C13",
            "a","","",sPrekPrefix,"; ")
   s:((sResVZ'="")&&(pTyp'="BZNC")) sRes=sRes_"\n"_sResVZ
   
   ; 04.03.11 tt; pridan kod oboru RIV
   ;s sC12d=$$$getTagX(.handle,"C12d")
   ;if (sC12d'="")
   ;{ ;Typ zdroje výsledku: C12$d
   ;  d ##class(rep.zf.ub).ubCis(.sC12d,.handle,"","EPC_UN_TC12D") 
   ;  s:(sC12d'="") sRes=sRes_"\nZdroj financování: "_sC12d
   ;}
   
   ; 17.06.12 tt; uprava vypisu zdroje financovani C12d
   s c=0, sC12dVyp=""   ; . prochazeni zaznamu podle .c 
   d {
     s sTC12=$$$getTagXC(.handle,"C12",.c) ; vsechny zdroje financovani
     continue:((sTC12="")&&(c'=0))
     if (sTC12'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC12d=$$$getSubTagStr(sTC12,"d") ; nactu si kod
       continue:(sTC12d="")       
       d ##class(rep.zf.ub).ubCis(.sTC12d,.handle,"","EPC_UN_TC12D")  ; prevedu jej podle ciselniku
       s:(sC12dVyp'="") sC12dVyp=sC12dVyp_" ; "_sTC12d
       s:(sC12dVyp="") sC12dVyp=sTC12d
     }
   } while (c'=0)
   ; 16.08.14 tt; upraveny prefixy pro zf v metodach
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U114",1)
   s:(sC12dVyp'="") sRes=sRes_"\n"_sPrekPrefix_": "_sC12dVyp
   
   s c=0,sRetC57="" ; . prochazeni zaznamu podle .c 
   d { ; 13.06.12 pridani vypisu RVO C57
     s sTC57=$$$getTagXC(.handle,"C57",.c) ; vsetky citacie
     continue:((sTC57="")&&(c'=0))
     if (sTC57'="")  ; Institucionální podpora: RVO:ICO ; RVO:ICO
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC57a=$$$getSubTagStr(sTC57,"a")
       s:(sRetC57'="") sRetC57=sRetC57_" ; "_sTC57a
       s:(sRetC57="") sRetC57=sTC57a
     }
   } while (c'=0)
   
   ; 16.08.14 tt; upraveny prefixy pro zf v metodach
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U109",1)
   s:((sRetC57'="")&&(pTyp'="BZNC")&&(sDruhDok'="DATA")) sRes=sRes_"\n"_sPrekPrefix_": "_sRetC57
   
   // klicova slova
   // \nKlíčová slova: C13a * C13a * C13a
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U111",1)
   s sResKS=..BibcitSzfTagFormat(.handle,"610",
           "a","","",sPrekPrefix," * ")
   if ((sResKS'="")&&(pTyp'="BZNC")&&(sDruhDok'="DATA")) s sRes=sRes_"\n"_sResKS
   if ($$$getTagX(.handle,"C26x")="")
   {
     ; 04.03.11 tt; pridan kod oboru RIV
     s sC26f=$$$getTagX(.handle,"C26f")
     if ((sC26f'="")&&(pTyp'="BZNC")&&($$$getTagX(.handle,"C99d")'="DFLT_CZ_EPCA_A3"))
     { ;Kód oboru RIV: C26$f
       d ##class(rep.zf.ub).ubCis(.sC26f,.handle,"","EPC_OBORY_RIV") 
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U112",1)
       s:(sC26f'="") sRes=sRes_"\n"_sPrekPrefix_": "_sC26f
     }
   
    ; 24.02.12 tt; pridano a otestovano zobrazeni spoluprace C55 do kodu oboru
    s c=0,bC55pref=(sC26f'="")
    d {
      s sTC55=$$$getTagXC(.handle,"C55",.c) ; vsechny spoluprace
      continue:((sTC55="")&&(c'=0))         ; pokud nemam data pokracuji
      if ((sTC55'="")&&(pTyp'="BZNC")) 
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC55a=$$$getSubTagStr(sTC55,"a")
        s sTC55b=$$$getSubTagStr(sTC55,"b")
        if ((sTC55a'="")&&(sTC55b'=""))
        { ; pokud mame vyplnene obe pole, pridavame
          ; 19.06.12 tt; oprava prekladu podle ciselniku, musi byt definovana hodnota 
          d ##class(rep.zf.ub).ubCis(.sTC55b,.handle,"","EPC_OBORY_RIV") 
 
          if (bC55pref=0)
          { ; nemame prefix a musime ho vlozit
            s sPrekPrefix=..prekladPrefixuIpac(.handle,"U112",1)
            s sRes=sRes_"\n"_sPrekPrefix_": "_sTC55b_" ("_sTC55a_")" 
            s bC55pref=1 ; naplnime priznak, ze mame prefix
          }
          else 
          { ; mame prefix, jen prilozime retezec
            s sRes=sRes_"; "_sTC55b_" ("_sTC55a_")" 
          }
        }
      }
     } while (c'=0)
   }
   
   
   
    ///(pTyp'="BZNC")
   ; 01.03.18 tt; pridano zobrazeni OECD
   s sPrekPrefixOECD=..prekladPrefixuIpac(.handle,"U191",1)
   s:(sPrekPrefixOECD="") sPrekPrefixOECD="Obor OECD"
   s sOECD=""
   s tc26x=$$$getTagX(.handle,"C26x")  ; EPCA_OECD
   s tc26y=$$$getTagX(.handle,"C26y")   ; EPCA_OECDALL_2
   s tc26z=$$$getTagX(.handle,"C26z") ; EPCA_OECDALL_3
   if (tc26z'="") { d ##class(rep.zf.ub).ubCis(.tc26z,.handle,"","EPCA_OECDALL_3-1")  }
   elseif (tc26y'="")  {  d ##class(rep.zf.ub).ubCis(.tc26y,.handle,"","EPCA_OECDALL_2-1")  }
   elseif (tc26x'="")  {   d ##class(rep.zf.ub).ubCis(.tc26x,.handle,"","EPCA_OECD-1")   }
   if (tc26z'="") { s sRes=sRes_"\n"_sPrekPrefixOECD_": "_tc26z,sOECD=tc26z }
   elseif (tc26y'="")  {  s sRes=sRes_"\n"_sPrekPrefixOECD_": "_tc26y,sOECD=tc26y }
   elseif (tc26x'="")  {   s sRes=sRes_"\n"_sPrekPrefixOECD_": "_tc26x ,sOECD=tc26x }
   
   s c=0,bC47pref=(sOECD'="")
   d {
     s sTC47=$$$getTagXC(.handle,"C47",.c) ; vsechny spoluprace
     continue:((sTC47="")&&(c'=0))         ; pokud nemam data pokracuji
     if ((sTC47'="")&&(pTyp'="BZNC")) 
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC47a=$$$getSubTagStr(sTC47,"a")
       s sTC47b=$$$getSubTagStr(sTC47,"b")
       s sTC47c=$$$getSubTagStr(sTC47,"c")
       s sTC47d=$$$getSubTagStr(sTC47,"d")
       s sOECDtext=""
       if (sTC47d'="") { d ##class(rep.zf.ub).ubCis(.sTC47d,.handle,"","EPCA_OECDALL_3-1")  }
       elseif (sTC47c'="")  {  d ##class(rep.zf.ub).ubCis(.sTC47c,.handle,"","EPCA_OECDALL_2-1")  }
       elseif (sTC47b'="")  {   d ##class(rep.zf.ub).ubCis(.sTC47b,.handle,"","EPCA_OECD-1")   }
       if (sTC47d'="") { s sOECDtext=sTC47d }
       elseif (sTC47c'="")  {  s sOECDtext=sTC47c }
       elseif (sTC47b'="")  {   s sOECDtext=sTC47b }
       
       if ((sTC47a'="")&&(sOECDtext'=""))
       { ; pokud mame vyplnene obe pole, pridavame
         if (bC47pref=0)
         { ; nemame prefix a musime ho vlozit
           s sRes=sRes_"\n"_sPrekPrefixOECD_": "_sOECDtext_" ("_sTC47a_")" 
           s bC47pref=1 ; naplnime priznak, ze mame prefix
         }
         else 
         { ; mame prefix, jen prilozime retezec
           s sRes=sRes_"; "_sOECDtext_" ("_sTC47a_")" 
         }
       }
     }
   } while (c'=0)   
   
   
   
   // 25.08.05 jj; doplneni o impakt faktor
   // 06.09.05 jj; doplneni zobr. roku IF
   // 16.12.05 jj; do tzf zapsat IF jen v pripade druhu dokumentu "J", "N"
   if ((sDruhDok="J") || (sDruhDok="N"))
   {
     s sResIF=##class(MARC).getTagX(.handle,"T16c")
     if (sResIF'="") 
     {
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"0621",1)
       s sRes=sRes_"\n"_sPrekPrefix_": "_sResIF
       s sResIF=##class(MARC).getTagX(.handle,"T16a")
       s sPrekPrefix=..prekladPrefixuIpac(.handle,"U115")
       if (sResIF'="") s sRes=sRes_", "_sPrekPrefix_": "_sResIF
     }
   }
   ; 26.02.07 mk pridany tag 300a na konci zaznamu 
   if (sDruhDok="L") 
   {
       
     if nLink=2
     {
       s sResURL=##class(rep.zf.images).fmtCsBURL(.handle,"F",.sCoverHTML,"300","a","")
       if sResURL'="" s sRes=sRes_"\n"_sResURL_""      
     }
     else
     {     
        s sRes300=..BibcitSzfTagFormat(.handle,"300","a","","","","\n")
        if sRes300'="" s sRes=sRes_"\n"_sRes300_""   
     }
   }    
   
   ; 29.11.21 tt; pridan zpusob zverejneni
   s sC91a =$$$getTagX(.handle,"C91a")
   if ((sC91a'=""))
   { ;Kód oboru RIV: C26$f
     d ##class(rep.zf.ub).ubCis(.sC91a,.handle,"","UN_ZP_PUBLIKOVANI-1") 
     s sPrekPrefix=..prekladPrefixuIpac(.handle,"U207",1)
     s:(sC91a'="") sRes=sRes_"\n"_sPrekPrefix_": "_sC91a
   }
   
   ; 24.02.07 mk na konci zaznamu pridane pre vsetky druhy 856u ak je
   if (nLink=2)
   {
     s sResURL=##class(rep.zf.images).fmtCsBURL(.handleX,"F",.sCoverHTML,"856","u","")
     s:($$$getTagX(.handle,"856u")=$$$getTagX(.handle,"C60a")) sResURL=""
     s sResURL=$$$strswap(sResURL,".b.","./retezecBtecka.")  
     ; 04.12.18 tt; provadeny upravy zf
     s sResURL=$$$strswap(sResURL,"title=","target=""_blank"" title=")
     if sResURL'="" s sRes=sRes_"\n"_sResURL_""
     ; 15.03.07 rs; do skrateneho ZF pridany link do portalu VaV (RIV)
     if ('$f(","_pPar_",",","_"ipac3"_","))
     { ; 16.10.12 tt; parametr, aby se vedelo, ze se spousti z ipac3, nezobrazovat linky
       s sResURL=..getRIVlink(.handleX)
       s sResURL=$$$strswap(sResURL,"title=","target=""_blank"" title=")
       if ((sResURL'="")&&(pTyp'="BZNC")) s sRes=sRes_"\n"_sResURL_""
       ; 27.04.07 mk; pridany link do DOI
       s sDOIURL=..getDOIlink(.handleX)
       s sDOIURL=$$$strswap(sDOIURL,"title=","target=""_blank"" title=")
          s sDOIURL=$$$strswap(sDOIURL,".b.","./retezecBtecka.")

       if sDOIURL'="" s sRes=sRes_"\n"_sDOIURL_""
     } 
     if ($f(","_pPar_",",","_"ipac3"_","))
     { ; 16.10.12 tt; parametr, aby se vedelo, ze se spousti z ipac3, nezobrazovat linky
       if ($$$GETREQVAR("op")="pr")
       {
         /// 20.02.13 tt; specialni uprava pro tisk
         ; s sResURL=..getRIVlink(.handle)
         ; if ((sResURL'="")&&(pTyp'="BZNC")) s sRes=sRes_"\n"_sResURL_""
         s sDOIURL=..getDOIlink(.handleX)
         s sDOIURL=$$$strswap(sDOIURL,"title=","target=""_blank"" title=")

         if sDOIURL'="" s sRes=sRes_"\n"_sDOIURL_""
         ; s sWOSURL=..getWOSlink(.handle)
         ; if sWOSURL'="" s sRes=sRes_"\n"_sWOSURL_""         
       }
     } 
   }
   else
   {
     s sResURL=""
     s:(sDruhDok'="DATA") sResURL=..BibcitSzfTagFormat(.handleX,"856","u","","","","\n")
     s:(sResURL=$$$getTagX(.handle,"C60a")) sResURL=""
     if sResURL'="" s sRes=sRes_"\n"_sResURL_""
   }
   
   ; 12.01.09 jk; uklid options pro kratky ZF    
   d ##class(rep.zf.tf).formatXcleanup(.handle)
  
   if (($f(pPar,"emph"))&&($f(sRes,"./u.")))
   { ; 11.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
     s sRes=$$$strswap(sRes,".u.",".emphasis.")
     s sRes=$$$strswap(sRes,"./u.","./emphasis.")  
   }   
   ; 04.01.22 tt; zakomentovano odmazani zdvojenych zavorek, problem napriklad u prikladu 0565183
   //s sRes=$$$strswap(sRes,"))",")")
   s sRes=$$$strswap(sRes,"?.","?")
   s sRes=$$$strswap(sRes,"? </em>. ","?</em> ")
   s sRes=$$$strswap(sRes,"!.","!")
   s sRes=$$$strswap(sRes,"? .","?")
   s sRes=$$$strswap(sRes,"! .","!")
   s sRes=$$$strswap(sRes,"! </em>. ","!</em> ")
   s sRes=$$$strswap(sRes,".. ",". ")
   s sRes=$$$strswap(sRes,".. ",". ")
   s sRes=$$$strswap(sRes,".. ",". ")
   s sRes=$$$strswap(sRes,".</em>. ","</em>. ")
   s sRes=$$$strswap(sRes,".</em> = <em>","</em> = <em>")
   
   q sRes
]]></Implementation>
</Method>

<Method name="zfDataVersionTab">
<Description>
blok do ZF - vytvoreni a zniceni pomocneho tagu pro zobrazeni tabulky
Paremetry: handle - aktulani zpracovavany handle
           params - parametry oddelene -
                    1.  1 - vytvoreni tagu TF2 - na tabulku verzi
                        2 - odstraneni tagy TF2

20.09.23 tt; pridan blok pro zobrazovani linku na vedecka data - tabulka verzi</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   ; . prochazeni zaznamu podle .c
   s sTC99d=$$$getTagX(.handle,"C99d")  
   q:(sTC99d'="DFLT_DATA") ""

   s idx=##class(i2.dblink).recordIdX(.handle)
   s sPar1=$p(params,"-",1)                ; nacteme si parametry pro zpracovani
   s sPrefA=..prekladPrefixuIpac(.handle,"U244")
   if (sPar1=1)
   { ; 1 - vytvoreni tagu TF2
     
     s sVerze=##class(User.CavUnEpca).versionDataGetAll(.handle,.verze)
     s j=1
     for i=$l(sVerze,"#"):-1:1
     { ; 07.02.23 tt; pridana logika zobrazovani 5 verzi datoveho zaznamu + link
       s sVerze1=$p(sVerze,"#",i)
       s linkVer=$$$getTagX(.handle,"U033")
       s:(linkVer="") linkVer="cav_un_epca*"_$$$HandleT001(handle)
       
       if ##class(User.MARC).readLX(.handle1,sVerze1)
       {
         s sTF="TF2    "
         ; naplnime si subtag TF2a
         if ($f(sVerze1,("*"_$$$HandleT001(handle))))
         { 
           s sTF=sTF_$c(31)_"a"_sPrefA_i
         }
         else
         {
           //s sTF=sTF_$c(31)_"a"_" \qT001*cav_un_epca* "_$p(sVerze1,"*",2)_" \d"_sPrefA_i_" \q "
           //s sTF=sTF_$c(31)_"a"_"\qPOLE*DB*ICON*ZF TERM\dDTERM \aANCHOR \q"
           s sTF=sTF_$c(31)_"a <a href='"_$$$BASEURL_##class(i2.html.tpl).getLinkURL("detail", "idx="_sVerze1)_"'>"_sPrefA_i_"</a>"
         }
       
         s sTF=sTF_$c(31)_"b"_$$$getTagX(.handle1,"U03c")  
         s sTF=sTF_$c(31)_"c"_##class(CavS).zfVkladatel(.handle1,"-1")
         s sTF=sTF_$c(31)_"d"_$p(##class(User.CavS).zfDatumZverejneni(.handle1,"U233"),":",2) 
         d:($l(sTF)>10) ##class(User.MARC).appendLineX(.handle,sTF)
       }
     }
     ; 10.03.21 tt; pridano osetreni, aby byl handle nacteny v pristupne stromove strukture - volane funkce ji vyzaduji
     ;              a kdyz neni, padne update zaznamu
     d ##class(util.index).enhance(.handle)  // https://cosmo2/Wiki/index.php?title=Ergonomic_data_in_zf
   }
   elseif (sPar1=2)
   { ; odmazeme  tagy TF2
     d ##class(User.MARC).delTagX(.handle,"TF2")
   }   
   
   q ""
]]></Implementation>
</Method>

<Method name="zfDataLinkTab">
<Description>
blok do ZF - vytvoreni a zniceni pomocneho tagu pro zobrazeni tabulky
Paremetry: handle - aktulani zpracovavany handle
           params - parametry oddelene -
                    1.  1 - vytvoreni tagu TF1 - proveri se C76 + C81 licence a vytvori se na zaklade toho link
                        2 - odstraneni tagy TF1

20.11.15 tt; pridan blok pro zobrazovani linku na vedecka data</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   ; . prochazeni zaznamu podle .c
   s sTC99d=$$$getTagX(.handle,"C99d")  
   q:(sTC99d'="DFLT_DATA") ""

   s idx=##class(i2.dblink).recordIdX(.handle)
   s sPar1=$p(params,"-",1)                ; nacteme si parametry pro zpracovani
   if (sPar1=1)
   { ; 1 - vytvoreni tagu TF1 - proveri se C76 + C81 licence a vytvori se na zaklade toho link
     s sTC81=$$$getTagX(.handle,"C81")       ; zjistime si informace o licenci 
     s sTC81aLicence=$$$getSubTagStr(sTC81,"a"),sTC81dEmbargo=$$$getSubTagStr(sTC81,"d")   ; nacteme si linceni C81a a zrovna embargo C81d
     //C81    $$bJINA$$cCena licence je stanovena na 100.000 Kč. Tvůrci mohou užívat výsledek k nekomerčním účelům, tj. k prezentačním a výukovým účelům, další na základě zvláštních licenčních ujednání. Smlouva o využití výsledku projektu "Zvýšení využití parkovací kapacity na dálnicích za pomoci predikčních modelů" uzavřená dne 19.12.2014.$$aO$$d20230310
     s c=0,nC76u=1
     d { ; C76u
      s sTC76=$$$getTagXC(.handle,"C76",.c) ; vsetky citacie
      continue:((sTC76="")&&(c'=0))
      if (sTC76'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC76u=$$$getSubTagStr(sTC76,"u")
        s sTC76z=$$$getSubTagStr(sTC76,"z")
        if (sTC76u'="")
        {
           s sText="data"_nC76u
           s:(sTC76z'="") sText=sTC76z
           ; 19.01.18 tt; provedena oprava linku - pridan prefix http: pri www
           ; 28.11.18 tt; odstraneno doplneni https pro datove zaznamy 
           if $e(sTC76u,1,4)="www." s sTC76u="http://"_sTC76u
           ; 12.01.18 tt; provedeny upravy linku, aby se spravne zobrazoval a fungoval i ve formularich
           s sLink=".u.<a href="""_sTC76u_""" target=""_blank"" title="""_sText_""">"_sText_"</a>./u."
           s sLinkVyzadat=".u.<a href="""_$$$BASEURL_##class(i2.html.tpl).getLinkURL("contclaim","idx="_idx_"&bigdata="_sText)_""" target=""_blank"" title="""_##class(rep.zf.tf).prefix(.handle,"0997")_""">"_##class(rep.zf.tf).prefix(.handle,"0997")_"</a>./u."
     
           s sAktDate=$tr($ZDATE($HOROLOG,3),"-","")  ; aktualni datum
           if ((sTC81aLicence="O")||((sTC81aLicence="E")&&(sAktDate>sTC81dEmbargo)))
           { ; pokud máme data přístupné, zobrazíme link
             d ##class(User.MARC).appendLineX(.handle,"TF1    "_$c(31)_"a"_sLink_$c(31)_"b"_##class(rep.zf.tf).prefix(.handle,"0996"))
           }
           elseif (sTC81aLicence="E")
           { ; vyžádat spolu s linkem na fulltext a informací o embargu
             d ##class(User.MARC).appendLineX(.handle,"TF1    "_$c(31)_"a"_sLink_$c(31)_"b"_sLinkVyzadat_$c(31)_"c"_##class(rep.zf.tf).prefix(.handle,"0997")_": "_$e(sTC81dEmbargo,7,8)_"."_$e(sTC81dEmbargo,5,6)_"."_$e(sTC81dEmbargo,1,4))
           }
           else
           {
            ; vyžádat
            ; 01.08.23 tt; provedena uprava linku vyzadat - v zf
            s sLink=".u.<a href="""_$$$BASEURL_##class(i2.html.tpl).getLinkURL("contclaim","idx="_idx_"&bigdata="_sText)_""" target=""_blank"" title="""_##class(rep.zf.tf).prefix(.handle,"0997")_""">"_sText_"</a>./u."
            d ##class(User.MARC).appendLineX(.handle,"TF1    "_$c(31)_"a"_sLink_$c(31)_"b"_sLinkVyzadat_$c(31))
           }         
          
        }
      }
      s nC76u=nC76u+1
     } while (c'=0)
    
     ; 10.03.21 tt; pridano osetreni, aby byl handle nacteny v pristupne stromove strukture - volane funkce ji vyzaduji
     ;              a kdyz neni, padne update zaznamu
     d ##class(util.index).enhance(.handle)  // https://cosmo2/Wiki/index.php?title=Ergonomic_data_in_zf
   }
   elseif (sPar1=2)
   { ; odmazeme  tagy TF1
     d ##class(User.MARC).delTagX(.handle,"TF1")
   }   
   
   q ""
]]></Implementation>
</Method>

<Method name="zfDataLink">
<Description>
blok do ZF - vytvořeno pro I3 aplikaci

20.11.15 tt; pridan blok pro zobrazovani linku na vedecka data</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   ; . prochazeni zaznamu podle .c
   s sTC99d=$$$getTagX(.handle,"C99d")  
   s c=0,nC76u=1,sRes=""
   d { ; C76u
    s sTC76=$$$getTagXC(.handle,"C76",.c) ; vsetky citacie
    continue:((sTC76="")&&(c'=0))
    if (sTC76'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sTC76u=$$$getSubTagStr(sTC76,"u")
      s sTC76z=$$$getSubTagStr(sTC76,"z")
      if (sTC76u'="")
      {
         s sText="data"_nC76u
         s:(sTC76z'="") sText=sTC76z
         ; 19.01.18 tt; provedena oprava linku - pridan prefix http: pri www
         ; 28.11.18 tt; odstraneno doplneni https pro datove zaznamy 
         if $e(sTC76u,1,4)="www." s sTC76u="http://"_sTC76u
         ; 12.01.18 tt; provedeny upravy linku, aby se spravne zobrazoval a fungoval i ve formularich
         s sLink=".u.<a href="""_sTC76u_""" target=""_blank"" title="""_sText_""">"_sText_"</a>./u."
         if (nC76u=1)
         {
           s sPrekPrefix=..prekladPrefixuIpac(.handle,"U145")
           s:(sTC99d="DFLT_DATA") sPrekPrefix=..prekladPrefixuIpac(.handle,"U163")
           if ($f("-"_params_"-","-NONEWLINE-"))  {  s sRes=sRes_sPrekPrefix_" "_sLink }
           else {  s sRes=sRes_"\n"_sPrekPrefix_" "_sLink }
         }
         else
         {
           s sRes=sRes_", "_sLink
         }
         s nC76u=nC76u+1
      }
    }
   } while (c'=0)
   
   s:(($f("-"_params_"-","-PRAZDNNYPREF-"))&&(sRes'="")) sRes=" : "_sRes
   q sRes
]]></Implementation>
</Method>

<Method name="zfDataLink856">
<Description>
blok do ZF - vytvořeno pro I3 aplikaci

04.01.17 tt; pridan blok pro zobrazovani linku na vedecka data</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   ; . prochazeni zaznamu podle .c
   s c=0,n856u=1,sRes=""
   s sTC99d=$$$getTagX(.handle,"C99d")  
   if (sTC99d="DFLT_DATA")
   {
     d { ; 856u
       s sT856=$$$getTagXC(.handle,"856",.c) ; vsetky citacie
       continue:((sT856="")&&(c'=0))
       if (sT856'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sT856u=$$$getSubTagStr(sT856,"u")
         if (sT856u'="")
         {
           ; 28.11.18 tt; odstraneno doplneni https pro datove zaznamy 
           ; Dobrý den, prosim o zruseni automatického doplneni https:// u odkazu v poli C76u a 856u v datovem repozitari. Priklad sysno 0474286. Děkuji. Jana Doleželová
           if $e(sT856u,1,4)="www." s sT856u="http://"_sT856u
           s sLink=".u.<a href="""_sT856u_""" target=""_blank"" title=""data"_n856u_""">"_"data"_n856u_"</a>./u."
           if (n856u=1)
           {
             s sPrekPrefix=..prekladPrefixuIpac(.handle,"U164")
             s sRes=sRes_sPrekPrefix_" "_sLink
           }
           else
           {
             s sRes=sRes_", "_sLink
           }
           s n856u=n856u+1
         }
       }
     } while (c'=0)
   }
   s:(($f("-"_params_"-","-PRAZDNNYPREF-"))&&(sRes'="")) sRes=" : "_sRes
   q sRes
]]></Implementation>
</Method>

<Method name="zfLicence">
<Description>
blok do ZF - vytvořeno pro I3 aplikaci - licence

06.11.17 tt; pridana jazykova verze pro zobrazeni licence
10.05.17 tt; upraveno zobrazování - přidán link
06.04.17 tt; pridan blok pro zobrazovani licence</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   ; . prochazeni zaznamu podle .c
   s c=0,sRes="",tC81btext=""
   
   s SeznamFullT=..getNameFT(.handle)
   q:(SeznamFullT="") ""
   
   s lang=$$$GETLANGUAGE
   
   s tC81b=$$$getTagX(.handle,"C81b")
   //BY-NC-SA (eng)  https://creativecommons.org/licenses/by-nc-sa/4.0/
   //BY-NC-SA (cze)   https://creativecommons.org/licenses/by-nc-sa/4.0/deed.cs
   s sLinkCz="",tC81btext11=""
   s:(lang'="3") sLinkCz="deed.cs"
   if (tC81b'="")
   {
     s ret="<a href=https://creativecommons.org/licenses/"_$zcvt(tC81b,"L")_"/4.0/"_sLinkCz_" rel=""external"" target=""_blank"" title="""_tC81b_""">"_tC81b_"</a>"
     s tC81btext11=" - "_##class(User.Util).sXlate("UT_ASEP_LICENCECC",tC81b,"N","Cav",,lang)
     s:($tr(tC81btext11," -","")="") tC81btext11=""
     s tC81btext=ret_tC81btext11
     
   }
   s:(tC81b="JINA") tC81btext=..prekladPrefixuIpac(.handle,"U165")
   s sPrekPrefix=..prekladPrefixuIpac(.handle,"U166")
   s:((tC81btext'="")&&('$f("-"_params_"-","-ODSAZ-"))) sRes=sRes_sPrekPrefix_":"_tC81btext
   s:((tC81btext'="")&&($f("-"_params_"-","-ODSAZ-"))) sRes=sRes_"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>"_sPrekPrefix_":</strong> "_tC81btext
   s:(($f("-"_params_"-","-PRAZDNNYPREF-"))&&(sRes'="")) sRes=" : "_sRes
   q sRes
]]></Implementation>
</Method>

<Method name="fmtRIVLink">
<Description>
blok do ZF

27.10.12 tt; pridano vysvetleni RIV a DOI
15.03.07 rs</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    ;if '$g(gnDEBUG) q ""
    ; 20.02.13 tt; specialni uprava pro tisk
    if params=("tisk")
    {
     q:($$$GETREQVAR("op")'="pr") ""
    }
    
    s ret=..getRIVlink(.handle,params) q:ret="" ""
    q "<abbr title=""Rejstřík informací o výsledcích"" lang=""cs-CZ"">RIV</abbr>  : "_ret
]]></Implementation>
</Method>

<Method name="fmtWOSLink">
<Description>
blok do ZF

20.02.13 tt; zalozeno kvuli tisku</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    ; 20.02.13 tt; specialni uprava pro tisk
    if params=("tisk")
    {
     q:($$$GETREQVAR("op")'="pr") ""
    }
    
    s ret=..getWOSlink(.handle,params) q:ret="" ""
    q "<abbr title=""Web of Science"" lang=""cs-CZ"">WOS</abbr>  : "_ret
]]></Implementation>
</Method>

<Method name="fmtPUBMEDLink">
<Description>
blok do ZF

03.01.17 tt; zalozeno</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    ;if '$g(gnDEBUG) q ""
    ; 20.02.13 tt; specialni uprava pro tisk
    if params=("tisk")
    {
     q:($$$GETREQVAR("op")'="pr") ""
    }
    
    s ret=..getPUBMEDlink(.handle,params) q:ret="" ""
    q "<abbr title=""US National Library of Medicine"" lang=""cs-CZ"">PUBMED</abbr>  : "_ret
]]></Implementation>
</Method>

<Method name="fmtHANDLELink">
<Description>
blok do ZF - handle.net link
Dokumentace: https://cosmo2/wiki/index.php/Cust:CAV/handle_net 
params - oddelovac "-"
         1.   hodnota 1 - zobrazeni na stejnem radku
                      2 - zobrazeni za odradkovanim
                      3 - jen zalomeni 
         2.  hodnota - full - zbrazovat jen v případě, že je u záznamu jakýkoli fulltext  
         3.  hodnota 1 - zobrazi se zdy odkaz jako link  
         4.  hodnota 1 - prefix se nastavi na tucne pismo


01.11.23 tt; upravy zobrazovani datovych zaznamu
11.08.22 tt; zpracovani logiky pridani DOI pro datove zaznamy
29.11.21 tt; doplneni moznosti tucneho pisma
11.06.13 tt; pridany parametr 3
20.05.13 tt; moznost nastaveni prazdneho prefixu
18.05.13 tt; uprava pro tisk
21.12.12 tt; zalozeno tt</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s tC60a=$$$getTagX(.handle,"C60a")
  s tC52=$$$getTagX(.handle,"C52")
  s bData=($$$getTagX(.handle,"C99d")="DFLT_DATA")
  q:(tC60a="") ""
  s prazdPref=""
  s params1=$p(params,"-",1)
  s params2=$p(params,"-",2)
  s params3=$p(params,"-",3)
  s params4=$p(params,"-",4)
  s:(params1="1") prazdPref=" : "
  s:(params1="2") prazdPref=" : \n"
  s:(params1="3") prazdPref="\n"
  s sText=##class(rep.zf.tf).prefix(.handle,"U062")
  s sPrefix=##class(rep.zf.tf).prefix(.handle,"U063")_": "
  s:(params4="1") sPrefix="<strong>"_sPrefix_"</strong>"
  
  s t017="" 
  ; 11.08.22 tt; zpracovani logiky pridani DOI pro datove zaznamy
  if ((bData)&&($$$getTagX(.handle,"017a")'=""))
  { ; 22.08.22 tt; provedena změna zobrazování DOI a handle linku pro data
    ; 06.11.23 tt; provedeno upraveni tvaru DOI dx.doi.org
    s t017="https://doi.org/"_$$$getTagX(.handle,"017a")_" "
    s:(($$$GETREQVAR("op")="pr")||(params3="1")) t017=..getDOIlink(.handle,"linkOnly")
    s sPrefix017=##class(rep.zf.tf).prefix(.handle,"U068")_": "
    s:(params4="1") sPrefix017="<strong>"_sPrefix017_"</strong>"
    s t017=prazdPref_sPrefix017_t017_"\n"
    s sPrefix=##class(rep.zf.tf).prefix(.handle,"U243")_": "
    s:(params4="1") sPrefix="<strong>"_sPrefix_"</strong>"
    s prazdPref=""
  }

  ; 20.05.13 ; moznost nastaveni prazdneho prefixu
  s:($f(params2,"PrE")) sPrefix=""
  
  ; osetreni, aby se link zobrazoval jen u zaznamu, ktere maji jakykoli fulltext
  q:(($f(params2,"full"))&&(tC52="")) ""
    
  if (($$$GETREQVAR("op")="pr")||(params3="1"))
  { ; 18.05.13 tt; uprava pro tisk  
   q t017_prazdPref_sPrefix_"<a href="""_tC60a_""" target=""_blank"" title=""Handle link"">"_tC60a_"<span></span></a>" 
  }
  q t017_prazdPref_sPrefix_tC60a
]]></Implementation>
</Method>

<Method name="getRIVlink">
<Description><![CDATA[
toto je cisty link - da sa pouzit aj napr. do ineho ZF ako TF

15.10.16 tt; uprava logiky skladani linku do RIVu na zaklade C12d
23.08.16 tt; uprava linku za novy stav - novy server pro vysledky RIVu
17.10.11 tt; zmenen link do RIV
20.11.09 pb; uprava verzie: resultExerciseCode=U na resultExerciseCode= podla poziadavky p.Dolezelovej
09.09.09 jk; zrusen url parametr &resultLanguage=all
20.12.07 rs; uprava titulku URL (teraz obsahuje aj kod zaznamu v RIV - informativne)
19.10.07 rs; zmena formatu URL
28.09.07 rs; zmena UtilEPC na rep.epca.exportRIV
16.03.07 rs; upravy linku
15.03.07 rs]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    s sRV=##class(rep.zf.tf).stripHtmlTags(##class(MARC).getTagX(.handle,"C26d"))
    
    ; tu je napevno obmedzenie pre roky kde vieme vygenerovat link
    ; po export dalsieho roku treba upravit
    ; 
    ; link sa zobrazuje pre roky >=2005 a mensie ako akt.rok zberu (ten este nie je odovzdany)
    if (sRV<2005) || (sRV'<..#cAktRokZberu) q ""
    
    ; 28.09.07 rs; zmena UtilEPC na rep.epca.exportRIV
    ;s sRIVId=##class(UtilEPC).getRIVId(.handle) 
    s sRIVId=##class(rep.epca.exportRIV).getRIVId(.handle) 
    q:sRIVId="" ""
    
    s sTx="Výsledek v RIV"
    s sTxTitle=sTx_" ("_sRIVId_")"
    s sUstav=$$$getTagX(.handle,"C26e")
    
    s sPrijemceNadriz=""
    s sC13=$$$getTagX(.handle,"C13")
    s sC12b=$$$getTagX(.handle,"C12b")
    s sC12d=$$$getTagX(.handle,"C12d")
    s sC57a=$$$getTagX(.handle,"C57a")
    s s970b=$$$getTagX(.handle,"970b")
   
    s:((sC57a'="")||(sC13'="")) sPrijemceNadriz="AV0"
    if (sPrijemceNadriz="")
    {
      s sPrijemceNadriz=##class(User.Util).sXlate("EPC_POSKYTOVATEL_CEP",sC12b,"L","Cav","c")
    }
    if (sPrijemceNadriz="")&&(sC12d="V")
    { ; 15.10.16 tt; uprava logiky skladani linku do RIVu na zaklade C12d
      s sPrijemceNadriz="AV0"
    }
    
        
    s:(sPrijemceNadriz="") sPrijemceNadriz="AV0"
   
    ; 17.10.11 tt; zmenen link do RIV
    ; 09.09.09 jk; zrusen url parametr &resultLanguage=all
    ; VER do 19.10.07
    ;s sURL="https://aplikace.isvav.cvut.cz/findResultByFilter.do?resultCode="_$$$urlencode(sRIVId)
    ; uprava ver. 19.10.07
    ; 20.11.09 pb; uprava verzie: resultExerciseCode=U na resultExerciseCode= podla poziadavky p.Dolezelovej
    ;s sURL="https://aplikace.isvav.cvut.cz/findResultByFilter.do?typVyhledavani=advanced&resultType=&resultDataSuplier=&submitterName=&submitterICO=&submitterOrgUnit=&submitterOrgUnitCode=&submitterPersonSurname=&submitterPersonName=&authorSurname=&authorName=&resultCode="_$$$urlencode(sRIVId)_"&resultName=&resultExerciseCode=U&submitterYearFrom=&submitterYearTo=&resultYearFrom=&resultYearTo=&resultBranch=&resultAnnotation=&resultIsbn=&resultIssn=&sortField=vysidk&sortType=0&advancedForm=true"
    //s sURL="https://isvav.cz/findResultByFilter.do?typVyhledavani=advanced&resultType=&resultDataSuplier=&submitterName=&submitterICO=&submitterOrgUnit=&submitterOrgUnitCode=&submitterPersonSurname=&submitterPersonName=&authorSurname=&authorName=&resultCode="_$$$urlencode(sRIVId)_"&resultName=&resultExerciseCode=&submitterYearFrom=&submitterYearTo=&resultYearFrom=&resultYearTo=&resultBranch=&resultAnnotation=&resultIsbn=&resultIssn=&sortField=vysidk&sortType=0&advancedForm=true"
    ; 23.08.16 tt; uprava linku za novy stav - novy server pro vysledky RIVu
    ; 22.08.16 tt; upraveno RIV id
    s sPomRivID=$p($p(sRIVId,":",1),"/",2)
    s sRIVId=$$$strswap(sRIVId,"/","%2F")
    ; 22.02.21 tt; zmena url na riv
    s sURL="https://www.isvavai.cz/riv?s=jednoduche-vyhledavani&ss=detail&n=0&h="_$$$urlencode(sRIVId)_"%21RIV"_$e(sRV,3,4)_"-"_sPrijemceNadriz_"-"_sPomRivID
    ; 23.06.19 tt; zmena url pro RivId
    s:($p(sC57a,":",2)'="") sURL=$$$strswap(sURL,sPomRivID,$p(sC57a,":",2))
    ;s ret="<a href="""_sURL_""" target=""_new"" title="""_sTxTitle_"""><img border=""0"" src=""user/cav/riv-ikona.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_new"" title="""_sTxTitle_""">"_sTx_"</a>" 
    s ret="<a href="""_sURL_""" rel=""external"" target=""_blank"" title="""_sTxTitle_"""><img src="""_$$$BASEPURE_"user/cav/riv-ikona.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_""">"_sTx_"<span></span></a>" 
    s:(params="class") ret="<a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_"""><span class=""icon-riv"" aria-hidden=""true""></span> "_sTx_"</a>" 
    q ret
]]></Implementation>
</Method>

<Method name="getWOSlink">
<Description>
toto je cisty link - da sa pouzit aj napr. do ineho ZF ako TF

12.05.14 tt; odstranena kontrola na pismena u WOS linku
06.01.14 tt; pridana podpora malych pismen
18.11.13 tt; upraveno, aby se zobrazovali jen zaznamy s id WOS
17.01.13 tt; uprava linku podle https://www.lib.cas.cz/arl/publikace.php
14.01.13 tt; zalozeno</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   s c=0,ret=""
   d { 
     s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
     continue:((sT014="")&&(c'=0))
     if (sT014'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="wos")     
       {
         s sUTISI=$$$getSubTagStr(sT014,"a")
         ; 12.05.14 tt; odstranena kontrola na pismena u WOS linku
         //continue:((sUTISI="")||('(sUTISI?.N))) ; pokud nemame data, zkoncime
         continue:(sUTISI="") ; pokud nemame data, zkoncime
         
         s sTx="WOS"
         s sTxTitle=sTx_" (Web of Science)"
         ;s sURL="https://apps.webofknowledge.com/InboundService.do?SID=Y1KE234ClFaDld73jJj&product=WOS&UT="_sUTISI_"&SrcApp=Alerting&DestFail=https%3A%2F%2Fwww.webofknowledge.com&Init=Yes&action=retrieve&Func=Frame&customersID=Alerting&SrcAuth=Alerting&IsProductCode=Yes&mode=FullRecord"
         ;s sURL="http://gateway.isiknowledge.com/gateway/Gateway.cgi?GWVersion=2&SrcAuth=Alerting&SrcApp=Alerting&DestApp=WOS&DestLinkType=FullRecord&UT="_sUTISI
         ; 26.07.21 tt; zmena linku wos
         s sURL="https://www.webofscience.com/wos/woscc/full-record/WOS:"_sUTISI
         s ret="<a href="""_sURL_""" rel=""external"" target=""_blank"" title="""_sTxTitle_"""><img src="""_$$$BASEPURE_"user/cav/wos-ikona.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_""">"_sTx_"<span></span></a>" 
         s:(params="class") ret="<a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_"""><span class=""icon-wos"" aria-hidden=""true""></span> "_sTx_"<span></span></a>" 
         q 
       }
     }
   } while (c'=0)    
  q ret
]]></Implementation>
</Method>

<Method name="fmtSCOPUSLink">
<Description>
blok do ZF - SCOPUS

18.11.13 tt; zalozeno kvuli tisku</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    ; 20.02.13 tt; specialni uprava pro tisk
    if params=("tisk")
    {
     q:($$$GETREQVAR("op")'="pr") ""
    }
    
    s ret=..getSCOPUSlink(.handle,params) q:ret="" ""
    q "<abbr title=""SCOPUS"" lang=""cs-CZ"">SCOPUS</abbr>  : "_ret
]]></Implementation>
</Method>

<Method name="getSCOPUSlink">
<Description>
toto je cisty link - da sa pouzit aj napr. do ineho ZF ako TF - je to link na scopus

06.01.14 tt; pridana podpora malych pismen
18.11.13 tt; zalozeno</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   s c=0,ret=""
   d { 
     s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
     continue:((sT014="")&&(c'=0))
     if (sT014'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="scopus")     
       {
         s sSCOPUSID=$$$getSubTagStr(sT014,"a")
         continue:(sSCOPUSID="")
         s sTx="SCOPUS"
         s sTxTitle="Scopus - Elsevier"
         s sURL="https://www.scopus.com/record/display.url?fedsrfIntegrator=COSMADRALI-SCOCIT&origin=fedsrf&view=basic&eid=2-s2.0-"_sSCOPUSID
         s ret="<a href="""_sURL_""" rel=""external"" target=""_blank"" title="""_sTxTitle_"""><img src="""_$$$BASEPURE_"user/cav/scopus-ikona.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_""">"_sTx_"<span></span></a>" 
         s:(params="class") ret="<a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_"""><span class=""icon-scopus"" aria-hidden=""true""></span> "_sTx_"<span></span></a>"           
         q 
       }
     }
   } while (c'=0)    
  q ret
]]></Implementation>
</Method>

<Method name="getOPENAIRElink">
<Description>
Metoda, ktera vraci link na OpenAIRE
U záznamů, kde je
1.  v online katalogu uložen plný text v režimu OA, nebo na vyžádání,
2.  datum vydání 2005 – 2021,
3.  druh dokumentu – J, B, M, C, K, V, P (patent),
4.  záznam je označen do RIV


18.12.21 tt; zalozeno</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s c=0,ret="",bHodOA=0,sHodOA=""
  s lsClass=$$$HandleClass(handle),lnId=$$$HandleId(handle),psYEAR=""

  s sTC60a=$$$strswap($$$getTagX(.handle,"C60a"),"https://hdl.handle.net/","")
  ; 04.05.23 tt; osetreni linku openarire
  s sTC60a=$$$strswap(sTC60a,"http://hdl.handle.net/","")

  s sTC26b=$$$getTagX(.handle,"C26b")

  d { ; kontrola na hodnotu zaznamu index - openaire
      s sHodOA=##class(User.MARC).getIdxVal("CavUnEpca",lnId,"zoai",sHodOA)
      continue:(sHodOA="")
      s:(sHodOA=" openaire") bHodOA=1
  } while (sHodOA'="")
    
  if (bHodOA=1)  
  {
    s psYEAR=+$$$trim($o(^$$$MarcIndexG(lsClass,lnId,"ye",""),-1))
    /// 21.03.23 tt; provedeno osetreni, aby se porad nemusel nastavovat rok sberu
    /// 20.03.22 tt; zmena roku zberu 2022->2023
    /// 16.03.23 tt; zmena roku zberu 2022->2023
    if ((psYEAR>2004)&&(psYEAR<(..#cAktRokZberu))&&(sTC60a'="")&&(sTC26b="1"))
    {
       s sTx="OpenAIRE"
       s sTxTitle="Pokud není odkaz funkční OPENAIRE si záznam dosud nepřevzal. If the link does not work, OPENAIRE has not yet downloaded the record."
       s sURL="https://explore.openaire.eu/search/advanced/research-outcomes?f0=pid&fv0="_sTC60a
       s ret="<a href="""_sURL_""" rel=""external"" target=""_blank"" title="""_sTxTitle_"""><img src="""_$$$BASEPURE_"user/cav/icon-openaire.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_""">"_sTx_"<span></span></a>" 
       s:(params="class") ret="<a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_"""><span class=""icon-openaire"" aria-hidden=""true""></span> "_sTx_"<span></span></a>"           
    }
  }  
  
  if ($$$getTagX(.handle,"970b")="DATA")
  { ; 07.11.23 tt; u datovych zaznamu doplnen link na OpenAire - getOPENAIRElink
    s sDOI=$$$getTagX(.handle,"017a")
    if (sDOI'="")
    { // u datovych zaznamu, ktere maji DOI (data ulozena v ASEP), prosim vytvorit odkaz do Openaire pres PID DOI -Napr. sysno 0544591
      //s sDOI=$$$strswap(sDOI,".","&#46;")
      s sDOI=$$$strswap(sDOI,"/","%252F")
      //s sURL="https://dx.doi.org/"_sDOI
       s sTx="OpenAIRE"
       s sTxTitle="Pokud není odkaz funkční OPENAIRE si záznam dosud nepřevzal. If the link does not work, OPENAIRE has not yet downloaded the record."
       s sURL="https://explore.openaire.eu/search/advanced/research-outcomes?f0=pid&fv0="_sDOI_"&type=datasets"
       s ret="<a href="""_sURL_""" rel=""external"" target=""_blank"" title="""_sTxTitle_"""><img src="""_$$$BASEPURE_"user/cav/icon-openaire.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_""">"_sTx_"<span></span></a>" 
       s:(params="class") ret="<a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_"""><span class=""icon-openaire"" aria-hidden=""true""></span> "_sTx_"<span></span></a>"           
    }
  }
    
  q ret
]]></Implementation>
</Method>

<Method name="getPUBMEDlink">
<Description>
toto je cisty link - da sa pouzit aj napr. do ineho ZF ako TF - je to link na scopus

03.06.16 tt; zalozeno</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   s c=0,ret=""
   d { 
     s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
     continue:((sT014="")&&(c'=0))
     if (sT014'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="pubmed")     
       {
         s sPUBMEDID=$$$getSubTagStr(sT014,"a")
         continue:(sPUBMEDID="")
         s sTx="PUBMED"
         s sTxTitle="PubMed"
         s sURL="https://www.ncbi.nlm.nih.gov/pubmed/"_sPUBMEDID
         s ret="<a href="""_sURL_""" rel=""external"" target=""_blank"" title="""_sTxTitle_"""><img src="""_$$$BASEPURE_"user/cav/pubmed-ikona.gif"" alt="""_sTx_""" /></a> <a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_""">"_sTx_"<span></span></a>" 
         s:(params="class") ret="<a href="""_sURL_""" target=""_blank"" title="""_sTxTitle_"""><span class=""icon-pubmed"" aria-hidden=""true""></span> "_sTx_"<span></span></a>"          
         q 
       }
     }
   } while (c'=0)    
  q ret
]]></Implementation>
</Method>

<Method name="getDisplayFormatShortAnot">
<Description><![CDATA[
<pre> parametry
  pPar - rozdilne parametry
         "emph" - nahradi .u. za styl emphasis 

11.10.12 tt; pridan parametr pPar pro nahrazeni .u.
13.01.09 jk; neplni se psOptions, metoda se vola i mimo IPAC2 (v IPAC1),
             kde neexistuje prostredi IPAC2
12.01.09 jk; inicializace a uklid options pro kratky ZF
26.02.07 mk; zalozeny novy ZF ako skrateny + anotacie C15
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.Binary,nLink:%Library.Integer=1,pPar=""]]></FormalSpec>
<Implementation><![CDATA[
   ; 13.01.09 jk; metoda se vola i mimo IPAC2 (v IPAC1), kde neexistuje prostredi IPAC2
   ; 12.01.09 jk; inicializace options pro kratky ZF
   if ('##class(rep.zf.tf).bTfBlockRunningFromIpac(.handle))
   { ; 16.08.14 tt; upravena podminka, aby se neprepraskavalo nastaveni z ipacu u zf, kde je
     s psOptions="" //##class(i2.common).getDisplayFmtOptions(.handle)
     d ##class(rep.zf.tf).formatXinit(.handle,psOptions)
   
     d:($g(handle("tmp","modif_TF","language"))="") ##class(rep.zf.tf).setMod(.handle,"language",2)
     d ##class(rep.zf.tf).setMod(.handle,"ictx","Cav")
   }
   
   s sT970b=$$$getTagX(.handle,"970b")
   s sRes2=""
   ; zavolat rutinu getDisplayFormatShort
   s sRes2=..getDisplayFormatShort(.handle,nLink,,pPar)
   ; este pridat C15a, C15b, C15c anotacie
   s tC15=##class(MARC).getTagX(.handle,"C15")
   ; 11.09.17 tt; pridany vyjimky pro zobrazeni velkych dat
   s:(sT970b="DATA") tC15=""
   
   if (tC15'="")   
   {
      s tC15a=$$$getSubTagStr(tC15,"a") 
      if tC15a'="" s sRes2=sRes2_"\n\n"_tC15a
      s tC15b=$$$getSubTagStr(tC15,"b") 
      if tC15b'="" s sRes2=sRes2_"\n\n"_tC15b
      s tC15c=$$$getSubTagStr(tC15,"c") 
      if tC15c'="" s sRes2=sRes2_"\n\n"_tC15c
   }       
   
   ; 12.01.09 jk; uklid options pro kratky ZF
   d ##class(rep.zf.tf).formatXcleanup(.handle)
   
   if (($f(pPar,"emph"))&&($f(sRes2,"./u.")))
   { ; 11.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
     s sRes2=$$$strswap(sRes2,".u.",".emphasis.")
     s sRes2=$$$strswap(sRes2,"./u.","./emphasis.")  
   }     
   
   q sRes2
]]></Implementation>
</Method>

<Method name="getDisplayFormatShortCit">
<Description><![CDATA[
<pre>
  pPar - rozdilne parametry
         "emph" - nahradi .u. za styl emphasis 

27.04.14 tt; presunuto zobrazeni ohlasu do bloku getTFOhlasy
11.10.12 tt; pridan parametr pPar pro nahrazeni .u.
17.09.07 mk; osetrenie nacitania tagu 971 po castiach, kvoli velkosti
13.09.07 mk; zalozeny novy ZF ako skrateny + citacie 971
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.Binary,nLink:%Library.Integer=1,&result,pPar=""]]></FormalSpec>
<Implementation><![CDATA[
   s sRes2=""
   ; zavolat rutinu getDisplayFormatShort
   s sRes2=..getDisplayFormatShort(.handle,nLink,,pPar)
   
   if (($f(pPar,"emph"))&&($f(sRes2,"./u.")))
   { ; 11.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
     s sRes2=$$$strswap(sRes2,".u.",".emphasis.")
     s sRes2=$$$strswap(sRes2,"./u.","./emphasis.")  
     
   }    
   ; 16.02.13 tt; zmena kvuli zmene ipacu
   s:($f(pPar,"emph")) sRes2=" : "_sRes2
   s result(1)=sRes2
   
   q
]]></Implementation>
</Method>

<Method name="getTFBezZahlNavCit">
<Description><![CDATA[
<pre> Nový formát vycházející ze ZKRÁCENÉHO ZF s úpravami. Metoda obsahuje 2 zf podle parametru
Zařazen by byl pod Údaje pro RIV. Vypuštěny následující údaje:
   řádek začínající číslem záznamu, grant, výzkumný záměr, klíčová slova
   kód oboru RIV, link do RIV

Druhý formát, který je stejně definovaný, jen je rozšířený o citační ohlasy.

Parametry: handle - aktualni zpracovavany handle 
           nLink  - 1 defaultni hodnota nevladat linky/ 2-vkladat linky (verze IPAC) 
           result - na navratova promenna vysledneho zobrazeni
           pTyp   - 1 bez citaci (default)/ 2 - s citacema
           pPar - rozdilne parametry
                  "emph" - nahradi .u. za styl emphasis 

29.06.17 tt; upravena podminka pro zobrazovani handlu
27.04.14 tt; presunuto zobrazeni ohlasu do bloku getTFOhlasy
18.05.13 tt; pridano zobrazeni handle linku
15.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
01.06.12 tt; zalozeny FT na zaklade getDisplayFormatShortCit
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.Binary,nLink=1,&result,pTyp=1,pPar=""]]></FormalSpec>
<Implementation><![CDATA[
   s sRes2=""
   s sRes2=..getDisplayFormatShort(.handle,nLink,"BZNC","ipac3")      ; zavolat rutinu getDisplayFormatShort
   s sRes2=" : "_$e(sRes2,$f(sRes2,"\n"),999999)             ; odstranime prvni radek
   
   if (($f(pPar,"emph"))&&($f(sRes2,"./u.")))
   { ; 15.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
     s sRes2=$$$strswap(sRes2,".u.",".emphasis.")
     s sRes2=$$$strswap(sRes2,"./u.","./emphasis.")  
   }   
   
   ; 18.05.13 tt; pridano zobrazeni handle linku
   s sRes2=sRes2_..fmtHANDLELink(.handle,"3-,PrE")
   s result(1)=sRes2
   
   if (pTyp=2)
   { ; pokud mame nastaveny parametr, pridavame citace
     d ..getTFOhlasy(.handle, .result,"U105--0-0")     
   }
   q
]]></Implementation>
</Method>

<Method name="getTFOhlasy">
<Description><![CDATA[
<pre> Novy blok pro zalojeni zobrazovani do tagovaneho zobrazovaciho formatu s prefixem i bez nej

Druhý formát, který je stejně definovaný, jen je rozšířený o citační ohlasy.

Parametry: handle - aktualni zpracovavany handle 
           result - na navratova promenna vysledneho zobrazeni
           pPar - rozdilne parametry oddelena "-"
                  1 - prefix citace - pokud je uveden, zobrazuji se citace
                  2 - prefix recenze - pokud je uveden, zobrazuji se recenze
                  3 - 0 - tagovany format bez prefixu/ 1 - tagovany format s prefixem
                  4 - 0 nezobrazovat/1 zobrazovat rozdilne ohlasy pro vykazovani

26.04.14 tt; zalozena specialni metoda pro zobrazeni ohlasu
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,&result,pPar=""]]></FormalSpec>
<Implementation><![CDATA[
   s pPar1=$p(pPar,"-",1)                ; prefix citace
   s pPar2=$p(pPar,"-",2)                ; prefix recenze
   s pPar3=$p(pPar,"-",3)                ; tagovany format s /bez prefixu
   s:(pPar3="") pPar3=0
   s pPar4=$p(pPar,"-",4)                ; tagovany format s /bez prefixu
   s:(pPar4="") pPar4=1
     
   s nR=$o(result(""),-1)+1
   s sTU99a=$$$getTagX(.handle,"U99a")
   
   
   if (pPar1'="")
   { ; pokud mam prvni prefix - citace
     s pPref1=##class(rep.zf.tf).prefix(.handle,pPar1)         ; prefix 
     s:(pPar3=1) pPref1=pPref1_" : " 
     s:(pPar3=0) pPref1=" : \n"_pPref1_" ####POCET####\n\n"
     s nRPuv=nR                                                ; ulozime si zacinajici uzel

     s c=0,poc971=0
     d {
       s sT971=$$$getTagXC(.handle,"971",.c) ; vsetky citacie
       continue:((sT971="")&&(c'=0))
       if (sT971'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sT971i=$$$getSubTagStr(sT971,"i"), sT971c=$$$getSubTagStr(sT971,"c"), sT9719=$$$getSubTagStr(sT971,"9"), sT971x=$$$getSubTagStr(sT971,"x")
         if (sT971i'="")
         { ; pokud mame vyplnene 971$i, zpracujeme
           s sT971i=..getTFOhlasyLink(sT971i)
           
           if (sT971x'="")
           { ; 08.11.19 tt; pokud mame link na citovany zaznam, zobrazi se citace zaznamu
             if ##class(User.MARC).readLX(.hCitace,sT971x)
             {
               ; 04.03.21 tt; zobrazeni linku v citacich - uprava na zadost cav
               s sT971i=..getBibcitCAV(.hCitace,2,,)    
               ; 25.02.20 tt; pridana lupa do zf v epca formularich pro citaci/recenzi
               s:(sTU99a="1") sT971i="<a href=""OPEN?recid="_sT971x_"&formtype=d""><span class=""icon-search"" aria-hidden=""true""></span></a> "_sT971i
             }             
           }
         
           s poc971=poc971+1    
           s:(sT971c'="") sT971i=sT971i_" ["_sT971c_"]"
           s sResV="--- "
           s:((sT9719="1")&&(pPar4=1)) sResV="*** "   ; oznaceni citace, ze je dulezita pro hodnoceni    
           
           s sResV=sResV_sT971i
           s result(nR)=pPref1_sResV          
           s pPref1=" : "
           s nR=nR+1
         }
       }
     } while (c'=0)
     ; vlozime pocet do vysledku zacinajiciho uzlu 
     if ($g(result(nRPuv))'="")
     {
       s result(nRPuv)=$$$strswap(result(nRPuv),"####POCET####",(nR-nRPuv))
     }
   }
   if (pPar2'="")
   { ; pokud mam prvni prefix - recenze
     s pPref2=##class(rep.zf.tf).prefix(.handle,pPar2)         ; prefix 
     s:(pPar3=1) pPref2=pPref2_" : " 
     s:(pPar3=0) pPref2=" : \n"_pPref2_" ####POCET####\n\n "
     s nRPuv=nR                                               ; ulozime si zacinajici uzel
      
     s c=0,pocC71=0
     d {
       s sTC71=$$$getTagXC(.handle,"C71",.c) ; vsetky recene
       continue:((sTC71="")&&(c'=0))
       if (sTC71'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sTC71i=$$$getSubTagStr(sTC71,"i"), sTC71c=$$$getSubTagStr(sTC71,"c"), sTC719=$$$getSubTagStr(sTC71,"9"), sTC71x=$$$getSubTagStr(sTC71,"x")
         if (sTC71i'="")
         { ; pokud mame vyplnene C71$i, zpracujeme
           s sTC71i=..getTFOhlasyLink(sTC71i)
           
           if (sTC71x'="")
           { ; 08.11.19 tt; pokud mame link na citovany zaznam, zobrazi se citace zaznamu
             if ##class(User.MARC).readLX(.hRecenze,sTC71x)
             {
               s sTC71i=..getBibcitCAV(.hRecenze,3,,)  
               ; 25.02.20 tt; pridana lupa do zf v epca formularich pro citaci/recenzi
               s:(sTU99a="1") sTC71i="<a href=""OPEN?recid="_sTC71x_"&formtype=d""><span class=""icon-search"" aria-hidden=""true""></span></a> "_sTC71i  
             }             
           }
               
           s pocC71=pocC71+1    
           s:(sTC71c'="") sTC71i=sTC71i_" ["_sTC71c_"]"
           s sResV="--- "
           s:((sTC719="1")&&(pPar4=1)) sResV="*** "   ; oznaceni recenze, ze je dulezita pro hodnoceni    
           
           s sResV=sResV_sTC71i
           s result(nR)=pPref2_sResV          
           s pPref2=" : "
           s nR=nR+1
         }
       }
     } while (c'=0)
     ; vlozime pocet do vysledku zacinajiciho uzlu 
     if ($g(result(nRPuv))'="")
     {
       s result(nRPuv)=$$$strswap(result(nRPuv),"####POCET####",(nR-nRPuv))
     }
   }    
   q
]]></Implementation>
</Method>

<Method name="getTFOhlasyLink">
<Description><![CDATA[
<pre> Pridana metoda na upravu linku v citaci

03.01.15 tt; zalozena metoda 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pRet</FormalSpec>
<Implementation><![CDATA[
    s sRet=pRet,sT971i=pRet

    if $f(sT971i,"http:/")
    {
      s sURL971i="http:/"_$p($p(sT971i,"http:/",2)," ",1)
      s:($e(sURL971i,$l(sURL971i))=",") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=".") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=",") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=".") $e(sURL971i,$l(sURL971i))=""
      s sNahUrl=sURL971i
      s sURL971i="<a href="""_sURL971i_""" target=""_blank"">"_sURL971i_"</a>"
      s sRet=$$$strswap(sT971i,sNahUrl,sURL971i)
    }
    elseif $f(sT971i,"https:/")
    {
      s sURL971i="https:/"_$p($p(sT971i,"https:/",2)," ",1)
      s:($e(sURL971i,$l(sURL971i))=",") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=".") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=",") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=".") $e(sURL971i,$l(sURL971i))=""
      s sNahUrl=sURL971i
      s sURL971i="<a href="""_sURL971i_""" target=""_blank"">"_sURL971i_"</a>"
      s sRet=$$$strswap(sT971i,sNahUrl,sURL971i)
    }
    elseif $f(sT971i,"www.")
    {
      s sURL971i="www."_$p($p(sT971i,"www.",2)," ",1)
      s:($e(sURL971i,$l(sURL971i))=",") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=".") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=",") $e(sURL971i,$l(sURL971i))=""
      s:($e(sURL971i,$l(sURL971i))=".") $e(sURL971i,$l(sURL971i))=""
      s sNahUrl=sURL971i
      s sURL971i="<a href="""_sURL971i_""" target=""_blank"">"_sURL971i_"</a>"
      s sRet=$$$strswap(sT971i,sNahUrl,sURL971i)
    }   
    q sRet
]]></Implementation>
</Method>

<Method name="getDisplayFormatShortOLD">
<Description><![CDATA[
09.03.14 tt; pridano zobrazeni 200h do Tdi
25.03.11 tt; doplneni opakovatelnosti pro ISBN
12.01.11 tt; do zobrazovaciho formatu pridana verze 
15.01.01 mk; uprava zobrazovacieho formatu podla poziadavky Dolezelovej
26.05.06 jj; rozsireni Tdi o pole 010a (kvuli sbornikum v epca vstup)
29.09.05 jj; po konzultaci s rs opetovne zavedeni formatu
             (pouziva se ve vyhledavani z formulare epca)<br> 
13.09.05 rs; zrusenie "old" short formatu<br>

25.04.05 jj; zkraceny ZF pro CAV<br>
28.04.05 jj; rozpracovani dle predstav CAV<br>
23.08.05 jj; uprava zobr. na zakl. pozadavku CAV<br> 
---
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary</FormalSpec>
<Implementation><![CDATA[
   s T00a=$$$getTagX(.handle,"T00a")
   
   ; skrateny zobrazovaci format do tagu TU1
   ; "nazev - rada periodika. rok vydani. ISBN. ISSN. zeme."
   ; 
   s t200=$$$getTagX(.handle,"200")
   s sRes=$$$getSubTagStr(t200,"a")
   
   ; rada 200$i
   s sB=$$$getSubTagStr(t200,"i")
   s:(sB'="") sRes=sRes_" - "_sB
   
   ; 09.03.14 tt; pridano zobrazeni 200h do Tdi
   ; rada 200$h
   s sh=$$$getSubTagStr(t200,"h")
   if (sh'="")
   {
     s:('$f($zcvt(sh,"U"),"VOL")) sh="Vol. "_$tr(sh,",.")
     s sRes=sRes_". "_sh
   }
   
   ; rok 210d
   s s210d=$$$getTagX(.handle,"210d")
   s:(s210d'="") sRes=sRes_". "_s210d
     
   ; isbn 010$a
   /// 25.03.11 tt; doplneni opakovatelnosti pro ISBN
   s sB=$$$getTagXC(.handle,"010a",-1)
   s sB=$$$strswap(sB,$c(10),"; ISBN ")
   s:(sB'="") sRes=sRes_". ISBN "_sB

   ; issn 011$a
   s sB=$$$getTagX(.handle,"011a")
   s:(sB'="") sRes=sRes_". ISSN "_sB
   
   ; eissn 011$e
   s sB=$$$getTagX(.handle,"011e")
   s:(sB'="") sRes=sRes_". E-ISSN "_sB
      
   ; pridana verze - online / print
   s sB=$$$getTagX(.handle,"205a")
   s:(sB'="") sRes=sRes_". "_sB
   
   ; zobrazeni poznamek z tagu 301
   s c=0
   d { ; cyklus pres vsechny opakovani tagu
     s sT301=##class(User.MARC).getTagX(.handle,"301",.c) ; vsetky citacie
     continue:(sT301="")
     s sB=##class(User.MARC).getSubTagStr(sT301,"a")
     s:(sB'="") sRes=sRes_". "_sB
   } while (c'=0)  
   
   if (T00a="xszp")
   { ; zeme 102$a
     s sB=$$$getTagX(.handle,"102a")
     s:(sB'="") sRes=sRes_", "_sB
   }
   s:(sRes'="") sRes=sRes_"."
  
  q sRes
  
  /*
  else
  {
    ; normalne bib. zaznamy
    
    ; prvych dvoch autorov do "sAut" 
    ; $a, $b
    s sT=##class(MARC).getTagX(.handle,"700")
    s sAut=##class(MARC).getSubTagStr(sT,"a")
    s sB=##class(MARC).getSubTagStr(sT,"b")
    if sB'="" s sAut=sAut_", "_sB
     
    ; mozno by bolo treba zobrazit viac autorov, ale zatial dajme prveho
    ; $a, $b
    s sT=##class(MARC).getTagX(.handle,"701")
    s sA=##class(MARC).getSubTagStr(sT,"a")
    s sB=##class(MARC).getSubTagStr(sT,"b")
    if sB'="" s sA=sA_", "_sB
    
    ; 700 ; 701
    if sA'="" s sAut=sAut_" ; "_sA
    
    if (sAut'="")
    {
      // 06.04.05 rs; zabranenie zdvojenia bodky  
      ;if $e(sAut,$l(sAut))'="." s sAut=sAut_"."
      s sRes=sAut_"\n "_sRes
    }
    
    ; vydavatelske udaje
    ; $a : $c, $d
    s sT=##class(MARC).getTagX(.handle,"210")
    s sA=##class(MARC).getSubTagStr(sT,"a")
    s sC=##class(MARC).getSubTagStr(sT,"c")
    s sD=##class(MARC).getSubTagStr(sT,"d")
    if (sC'="")
    {
      if sA'="" s sA=sA_" : "
      s sA=sA_sC   
    }
    if (sD'="")
    {
      if sA'="" s sA=sA_", "
      s sA=sA_sD   
    }
    // teraz pripajame vyd. udaje cez bodku, tuto ale vynechame ak nazov konci
    // nejakou interpunkciou (?,!)
    if (sA'="") 
    {
      s sLast=$e(sRes,$l(sRes))
      if sLast'="",sLast'="?",sLast'="!" s sRes=sRes_"."
      s sRes=sRes_" "_sA
    }
    
    // c12$b,(c12$e),c12$a - cep
    // c12$c,(c12$e),c12$a - ostatni
    s sResG=""
    s sGranty=##class(MARC).getTagX(.handle,"C12",-1)
    s c=$l(sGranty,$c(10))
    f i=1:1:c
    {
        s sGrant=$p(sGranty,$c(10),i)
        s sB=##class(MARC).getSubTagStr(sGrant,"b") if sB="" continue
        s sE=##class(MARC).getSubTagStr(sGrant,"e")
        s sA=##class(MARC).getSubTagStr(sGrant,"a")
        if sA="" continue
        if sResG'="" s sResG=sResG_"; "
        s sResG=sResG_sB
        if sE'="" s sResG=sResG_"("_sE_")"
        if sA'="" s sResG=sResG_" "_sA
    }
    // druhe kolo zbiera "c"-cka
    f i=1:1:c
    {
        s sGrant=$p(sGranty,$c(10),i)
        s sB=##class(MARC).getSubTagStr(sGrant,"c") if sB="" continue
        s sE=##class(MARC).getSubTagStr(sGrant,"e")
        s sA=##class(MARC).getSubTagStr(sGrant,"a")
        if sA="" continue
        if sResG'="" s sResG=sResG_"; "
        s sResG=sResG_sB
        if sE'="" s sResG=sResG_"("_sE_")"
        if sA'="" s sResG=sResG_" "_sA
    }
    if sResG'="" s sRes=sRes_"\n"_sResG

    // vyskumne zamery
    s sGranty=##class(MARC).getTagX(.handle,"C13",-1)
    s c=$l(sGranty,$c(10)),sResG=""
    f i=1:1:c
    {
        s sGrant=$p(sGranty,$c(10),i)
        s sB=##class(MARC).getSubTagStr(sGrant,"a") if sB="" continue
        if sResG'="" s sResG=sResG_"; "
        s sResG=sResG_sB
    }
    if sResG'="" s sRes=sRes_"\n"_sResG

    
    s bRIV=##class(MARC).getTagX(.handle,"C26b")
    s s970b=##class(MARC).getTagX(.handle,"970b")

    s sB=##class(MARC).getTagX(.handle,"C99a")
    if sB="" s sB=$$$HandleT001(handle)
    if bRIV s sB=sB_" RIV"
    if s970b'="" s sB=sB_" "_s970b
    ; 23.08.05 jj; doplneni vyjimky pro naimportovane zaznamy 
    ;              casopisu kvuli impaktnim bodum
    if ((s970b'="BCA") && (s970b'="BXX")) s sRes=sB_"\n"_sRes
  }

  q sRes
  */
]]></Implementation>
</Method>

<Method name="getDisplayFormatSlovnik">
<Description><![CDATA[
<pre> Založena metoda pro zobrazování ze slovníku
Medoda slouzi pro specialni vypis informaci ve slovniku - nezavisle na hodnote indnexu

04.08.16 tt; upravy metody pro zobrazovaci formaty
14.06.16 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary,pnWhat,pnOutFmt</FormalSpec>
<Implementation><![CDATA[
   s sRet=""
   if ##class(i2.export).exBaseBegin(.handle,pnWhat,pnOutFmt) q
   s pPar=##class(i2.export).getExportZFOptions()
   s term=##class(i2.common).getModif(pPar,"termlist")

   s T00a=$$$getTagX(.handle,"T00a")
   
   if ($f(pPar,"CAV_SLOVNIK_RVO"))
   { ; pokud mame parametr pro zobrazovani RVO, vypiseme specitalni kod
    s sC57a=$$$getTagX(.handle,"C57a")
    s sUstav=##class(User.Util).sXlate("UN_EPCA_RVO",sC57a,"N","Cav")
    s sUstavN=##class(User.Util).sXlate("UPSENDMAIL_WORKPLACE",sUstav,"N","Cav","c")
    s:(sUstavN'="") sUstavN=" - "_sUstavN
    s sRet=sC57a_sUstavN
   }
   if ($f(pPar,"CAV_SLOVNIK_ZDROJ_DOK"))
   {
     // Nově:
     ///Periodikum: Název. ISSN/EISSN. Verze (online/print) 200$a, 011$a/011$e. 205$a
     ///Sborník: Název. Rok. ISBN. ISSN/EISSN. 200$a, 010$a. 011$a/011$e.
     s sTC99d=$$$getTagX(.handle,"C99d")
     // DFLT_CAT_BCA - periodikum
     // DFLT_CAT_BXXS - sbornik
   
     s t200=$$$getTagX(.handle,"200")
     s sRet=$$$getSubTagStr(t200,"a")
    
     ; rok 210d
     s s210d=$$$getTagX(.handle,"210d")
     s:(s210d'="")&&(sTC99d="DFLT_CAT_BXXS") sRet=sRet_". "_s210d

     s sB=$$$getTagXC(.handle,"010a",-1)
     s sB=$$$strswap(sB,$c(10),"; ISBN ")
     s:((sB'="")&&(sTC99d="DFLT_CAT_BXXS")) sRet=sRet_". ISBN "_sB
     
     //s t001 = $$$HandleT001(handle)
     //s sRet=sRet_". "_t001
     
     ; issn 011$a
     s sB=$$$getTagX(.handle,"011a")
     s:(sB'="") sRet=sRet_". ISSN "_sB
   
     ; eissn 011$e
     s sB=$$$getTagX(.handle,"011e")
     s:(sB'="") sRet=sRet_". E-ISSN "_sB
      
     ; pridana verze - online / print
     s sB=$$$getTagX(.handle,"205a")
     s:((sB'="")&&(sTC99d="DFLT_CAT_BCA")) sRet=sRet_". "_sB     
   }  
   if ($f(pPar,"CAV_SLOVNIK_REC_KIND"))
   {
     s sT970b=$$$getTagX(.handle,"C99d")
     s sT970b=$p(sT970b,"_",$l(sT970b,"_"))
     s:(sT970b="R1") sT970b="R"
     ///s a=XXXX
     //s sT970b=$$$getTagX(.handle,"970b")
     s sPopis=##class(User.Util).sXlate("CAV_REC_KIND_SLOV",sT970b,"N","Cav")
     s:(sPopis'="") sPopis=" - "_sPopis
     s sRet=sT970b_sPopis
   }  
   if ($f(pPar,"CAV_SLOVNIK_COUNTRY"))
   {
     s sT102a=$$$getTagX(.handle,"102a")
     s sPopis=##class(User.Util).sXlate("STABLE_UT_COUNTRIES",sT102a,"N","Cav",,2)
     if (sPopis'="") 
     {
       s sPopis=" - "_sPopis
       s sRet=sT102a_sPopis
     }
     else { s sRet="" }
     //s sRet="xcxvxcvxc"
   }   
   if ($f(pPar,"CAV_SLOVNIK_LANG"))
   {
     s sT102a=$$$getTagX(.handle,"101a")
     s sPopis=##class(User.Util).sXlate("UT_LANGUAGE",sT102a,"N","Cav",,2)
     if (sPopis'="") 
     {
       s sPopis=" - "_sPopis
       s sRet=sT102a_sPopis
     }
     else { s sRet="" }
     //s sRet="xcxvxcvxc"
   }   
   if ($f(pPar,"CAV_SLOVNIK_AKCE"))
   {
     s sTC20a=$$$getTagX(.handle,"C20a")
     s sTC20e=$$$getTagX(.handle,"C20e")
     s:((sTC20a'="")&&(sTC20e'="")) sTC20e=", "_sTC20e
     s sTC20f=$$$getTagX(.handle,"C20f")
     s:((sTC20a'="")&&(sTC20f'="")) sTC20f=", "_sTC20f
     s sRet=sTC20a_sTC20e_sTC20f
   }   
   if ($f(pPar,"CAV_SLOVNIK_PRA"))
   { ; 18.09.19 tt; provedena uprava indexovani a zobrazeni slovniku pro ustav
     s term=$zstrip(term,"*WC") 
     s sRet=##class(User.Util).sXlate("CAV_PRA",$zcvt(term,"U"),"","Cav","c")
     s:(sRet="") sRet=##class(User.Util).sXlate("CAV_PRA",$zcvt( $e(term,1,$l(term)-1)_"-"_$e(term,$l(term)),"U"),"","Cav","c")
   }   
   if ($f(pPar,"CAV_SLOVNIK_ID"))
   {
     s c=0 ,sRet=""

     d {
       s sT014=$$$getTagXC(.handle,"014",.c) ; projedme vsechny identifikacni cisla
       continue:((sT014="")&&(c'=0))
       if (sT014'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sT0142=$$$getSubTagStr(sT014,"2")
         s sT014a=$$$getSubTagStr(sT014,"a")
         
         s term=$zstrip(term,"*WC") 
         ; 17.09.19 tt; pridana podminka na zobrazeni jen tech teminu, ktere jsou ve slovniku
         continue:('$f($zcvt(sT014a,"l"),$zcvt(term,"l")))
         
         if (sT014a'="")
         {
           if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="scopus")
           { ; 16.06.16 tt; pro ID scopusu indexuji i s prefixem
             s sT014a="2-s2.0-"_sT014a
           }
           s:(sRet'="") sRet=sRet_", "
           s:($zcvt(sT0142,"l")="pubmed") sRet=sRet_"PubMed:"_sT014a
           s:($zcvt(sT0142,"l")="wos") sRet=sRet_"WOS:"_sT014a
           s:($zcvt(sT0142,"l")="scopus") sRet=sRet_"SCOPUS:"_sT014a
         }     
       }
     } while (c'=0)    
   }   
   if ($f(pPar,"CAV_SLOVNIK_NAZEV"))
   {
     s sRet=""
     s t200=$$$getTagX(.handle,"200")
     s sRet=$$$getSubTagStr(t200,"a")
   }   
   if ($f(pPar,"CAV_SLOVNIK_ODDELA"))
   {
     s sRet=""
     s term=$zstrip(term,"*WC") 
     s c=0
     d { ; 02.07.14 tt; pridano hodnoceni autoru - i pro deziderata
        s sT=$$$getTagXC(.handle,"70*",.c) ; vsichni autori
        continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
        if (sT'="")
        { ; pokud mame vyplnene data, muzeme provadet akce 
          s oddp=$$$getSubTagStr(sT,"o")
          //s sRet=sRet_" "_oddp
          s sUstav=$$$getSubTagStr(sT,"p") ; znova vyhodnotit, aby nebralo $y
          s sUstavPref=$p(sUstav,"-",1)              ; prva cast pracoviska
          if (oddp'="")
          {
            s oddpL=$zstrip($tr($zcvt(oddp,"L"),"-",""),"*WC")  
            if (oddpL=term)
            {
              s sRet=oddp      
            }
            s oddp=sUstavPref_"-"_oddp              ; oddlenie s prefixom pracoviska
            s oddpL=$zstrip($tr($zcvt(oddp,"L"),"-",""),"*WC")
            if (oddpL=term)
            {
              s sRet=oddp      
            }           
          }       
          
        }
      } while (c'=0)     
   }
   
   if ($f(pPar,"CAV_SLOVNIK_ISSN"))
   {
     ; "iskod" - !!! je potreba pridat sem pro preklad slovniku, pokud by se pridalo do indexu  
     s sRet=""
     s term=$zstrip(term,"*WC") 

     s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
     f i=1:1:nC 
     { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
       s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
       s sTag=$e(lsLine,1,3), sOldLine=lsLine
       if ((sTag="463")||(sTag="010")||(sTag="011")||(sTag="013"))
       {
         for ops=2:1:($l(lsLine,$c(31)))
         { ; pres vsechny opakovani subtagu
           s sST1=$p(lsLine,$c(31),ops)  ; ziskana hodnota jednoho opakovani
           if (($e(sST1,1)="a")||($e(sST1,1)="e"))
           {
             s $e(sST1,1)=""
             s sST1L=$zstrip($tr($zcvt(sST1,"L"),"-",""),"*WC")
             s:(sST1L=term) sRet=sRet_" yy "_sST1L
             if (sST1L=term)
             { ; prirazeni, pokud jsem nasel shodu
               s sRet=sST1      
             }            
           }       
         }
       }        
     }
   }
   if ($f(pPar,"CAV_SLOVNIK_DOI"))
   {
     s sRet=""
     s term=$zstrip(term,"*WC") 
     s c=0
     d { ; 02.07.14 tt; pridano hodnoceni autoru - i pro deziderata
        s sT=$$$getTagXC(.handle,"017",.c) ; vsichni autori
        continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
        if (sT'="")
        { ; pokud mame vyplnene data, muzeme provadet akce 
          s sSTa=$$$getSubTagStr(sT,"a")
          if (sSTa'="")
          {
            s sSTaL=$zstrip($tr($zcvt(sSTa,"L"),"-",""),"*WC")  
            if (sSTaL=term)
            {
              s sRet=sSTa      
            }              
          }           
        }
      } while (c'=0)   
   }
  
   if ($f(pPar,"CAV_SLOVNIK_VYDAV"))
   {
     s sRet=""
     s term=$zstrip(term,"*WC") 
     
     s c=0
     d {
       s sTC58=$$$getTagXC(.handle,"C58",.c) ; vsetky citacie
       continue:((sTC58="")&&(c'=0))         ; musime mit hodnotu na zpracovani
       if (sTC58'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         for ij=2:1:$l(sTC58,$c(31))
         { ; cyklime pres vsechny subtagy
           s sTC58ST=$p(sTC58,$c(31),ij)     ; ziskame jednu hodnotu
           s sTC58ST1=$e(sTC58ST,1),$e(sTC58ST,1)=""   ; subtag
           if (sTC58ST1="a")
           { ; indexujeme subtagy a a b
             s sTC58STL=$zstrip($tr($zcvt(sTC58ST,"L"),"-",""),"*WC")  
             if (sTC58STL=term)
             {
               s sRet=sTC58ST      
             }  
           }
         }
       }
      } while (c'=0)
      
      s s463=##class(MARC).getTagX(.handle,"463"),sT001463="",sClass4463=""
      if (s463'="") 
      { 
        d ##class(User.MARC).t4xx2handle(.h4xx, s463) 
        s sT001463=$$$HandleT001(h4xx)
        s sClass4463=$$$HandleClass(h4xx)  
      
        if (($g(sT001463,"")'="")&&($g(sT001463,"")'=""))
        { ; pokud mame 463
          if ##class(User.MARC).readX(.handleP463,sClass4463,sT001463) 
          { ; nacteme z handlu 978c
            s c=0
            d {
              s sTC58=$$$getTagXC(.handleP463,"C58",.c) ; vsetky citacie
              continue:((sTC58="")&&(c'=0))         ; musime mit hodnotu na zpracovani
              if (sTC58'="")
              { ; pokud mame vyplnene data, muzeme provadet akce 
                for ij=2:1:$l(sTC58,$c(31))
                { ; cyklime pres vsechny subtagy
                  s sTC58ST=$p(sTC58,$c(31),ij)     ; ziskame jednu hodnotu
                  s sTC58ST1=$e(sTC58ST,1),$e(sTC58ST,1)=""   ; subtag
                  if (sTC58ST1="a")
                  { ; indexujeme subtagy a a b
                    s sTC58STL=$zstrip($tr($zcvt(sTC58ST,"L"),"-",""),"*WC")  
                    if (sTC58STL=term)
                    {
                      s sRet=sTC58ST      
                    }  
                  }
                }
              }
            } while (c'=0) 
         }
       } 
     } 
   }
   if ($f(pPar,"CAV_SLOVNIK_SPOLI"))
   {
     s sRet=""
     s term=$zstrip(term,"*WC") 
     s c=0
     d {
       s sTC63=$$$getTagXC(.handle,"C63",.c) ; vsetky instituce
       continue:((sTC63="")&&(c'=0))         ; musime mit hodnotu na zpracovani
      
       if (sTC63'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sTC63a=$$$getSubTagStr(sTC63,"a")
         s sTC633=$$$getSubTagStr(sTC63,"3")
         s sTC63b=$$$getSubTagStr(sTC63,"b")
         s sC631e=$$$getSubTagStr(sTC63,"e")
         s sSpi63=""
         s:(sTC63b'="") sSpi63=sTC63b
         s:(sC631e'="") sSpi63=sSpi63_" ("_sC631e_")"
         if (sTC63b'="")
         { 
           s sSpi63L=$zstrip($tr($zcvt(sSpi63,"L"),"-",""),"*WC")  
           if (sSpi63L=term)
           {
             s sRet=sSpi63      
           }  
         }
       }
     } while (c'=0)
   }  
   if ($f(pPar,"CAV_SLOVNIK_IDAUT"))
   {
     s sRet=""
     s term=$zstrip(term,"*WC") 
     s c=0
     d {
       s sT70X=$$$getTagXC(.handle,"70*",.c) ; vsetky citacie
       continue:((sT70X="")&&(c'=0))         ; musime mit hodnotu na zpracovani
       if (sT70X'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
    
         s sT70X3=$$$getSubTagStr(sT70X,"3") ; zjistime kod autority
         if (sT70X3'="")
         { ; pokud jsme ziskali kod autority
           if ##class(User.MARC).readLX(.handlea3,sT70X3)
           { ; pokud se nam podarilo autoritu otevrit
             s sA035x=$$$getTagXC(.handlea3,"035",-1)
             f k=1:1:$l(sA035x,$c(10))                  ; cyklus pres vsechny opakovani
             { ; pres vsechny opakovani 400
               s sA035x1=$p(sA035x,$c(10),k)            ; vezmeme jedno opakovani  
               s sA035x1a=$$$getSubTagStr(sA035x1,"a")  ; ziskame kod
               s sA035x12=$$$getSubTagStr(sA035x1,"2")  ; ziskame kod
               s sA035x1aL=$zstrip($tr($zcvt(sA035x1a,"L"),"-",""),"*WC")  
               if (sA035x1aL=term)
               {
                 s sRet=sA035x1a      
                 s:(sA035x12'="") sRet=sRet_" ("_sA035x12_")"
               }  
             }
           }
         }  
       }
     } while (c'=0) 
   }  
   if ($f(pPar,"CAV_SLOVNIK_VYZZ"))
   {
     s sRet=""
     s term=$zstrip(term,"*WC") 
     s c=0
     d {
       s sTC13=$$$getTagXC(.handle,"C13",.c) ; vsetky instituce
       continue:((sTC13="")&&(c'=0))         ; musime mit hodnotu na zpracovani
      
       if (sTC13'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         s sTC13a=$$$getSubTagStr(sTC13,"a")
         if (sTC13a'="")
         { 
           s sTC13aL=$zstrip($tr($zcvt(sTC13a,"L"),"-",""),"*WC")  
           if (sTC13aL=term)
           {
             s sRet=sTC13a      
           }  
         }
       }
     } while (c'=0)
   }  
   
   d ##class(i2.export).outputAdd(sRet,pnOutFmt)
]]></Implementation>
</Method>

<Method name="getDATAEx">
<Description><![CDATA[
<pre>
interne Txx pre CavUnEpca
Tdi - skrateny ZF do EPCA formularov

29.11.13 tt; pridan seznam fulltextu do tagu Tft
23.02.06 jj; doplneni popisu
11.10.05 jj; obnoveni generovani Tdi
13.09.05 rs; zrusenie "old" short formatu
01.04.05 rs; upravy ZF pre ine druhy dok ako periodika
23.03.05 rs; prva verzia 
25.04.05 jj; rozparsovani do samost. fce, pridani citace do Tbc
--
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle:%Library.Binary</FormalSpec>
<Implementation><![CDATA[
  ; 11.03.15 tt; pridany tmp indikator, ze generujeme txx tagy
  s handle("tmp","getDATAEx","PridaniTxx")=1
  ; 25.04.05 jj; prevod na samost. fci
  ; 23.02.06 jj; zkraceny ZF pro ipac1
  s shortFormat=..getDisplayFormatShort(.handle)
  
  ; 25.04.05 jj; doplneni bibl. cit.
  ; 23.02.06 jj; biblograficka citace pro ipac1
  s BibCit=..getBibcitCAV(.handle)
  
  ; 20.12.11 tt; autori se zkracenim
  ;s BibCitZkrac=..getBibcitCAV(.handle,,1)
  ; 25.04.05 jj; prevod na samost. fci
  ; 13.09.05 rs; zrusenie "old" short formatu
  ; 11.10.05 jj; obnoveni generovani Tdi
  ; 23.02.06 jj; vyuziva se v epca_input_browse.php 
  ;              (pro zobrazeni vysledku vyhledani)
  s shortFormatOLD=..getDisplayFormatShortOLD(.handle)
  d:shortFormatOLD'="" $$$setTagX(.handle,"Tdi    "_$c(31)_"a"_shortFormatOLD)
  
  d:shortFormat'="" $$$setTagX(.handle,"Tzf    "_$c(31)_"a"_shortFormat)
  d:BibCit'="" $$$setTagX(.handle,"Tbc    "_$c(31)_"a"_BibCit)
  
  ; 29.11.13 tt; pridan seznam fulltextu
  s SeznamFullT=..getNameFT(.handle)
  ;s SeznamFullT="furltex.tdp, sdfsddf.as"
  s t970bData=$$$getTagX(.handle,"970b")
  if (($zcvt(t970bData,"U"))="DATA")
  {
    d:(SeznamFullT'="") $$$setTagX(.handle,"Tft    "_$c(31)_"a\nDatové soubory v ASEP: "_SeznamFullT)
  }
  else
  {
    d:(SeznamFullT'="") $$$setTagX(.handle,"Tft    "_$c(31)_"a\nSoubory v repozitáři: "_SeznamFullT)
  }
  ;d:BibCitZkrac'="" ##class(MARC).setTagX(.handle,"Tbz    "_$c(31)_"a"_BibCitZkrac)
  k handle("tmp","getDATAEx","PridaniTxx")
]]></Implementation>
</Method>

<Method name="ixIndexValuesEx">
<Description><![CDATA[
<pre>
22.09.16 tt; ixIndexValuesEx: pridana indexace bez diakritiky
26.03.16 tt; pridana promenna pro indexaci poskytovatelu, kteri jsou pouziti ve vymazavani 
             RIV C51 a indexace
21.02.16 tt; doplnena indexace 970x - zodr
03.09.15 tt; pridana indexace ZOAIR
08.08.15 tt; pridano vyhodnoce pro to, jestli je zaznam zalozen v novych formularich a jestli to
             ovlivnuje indexovani (primy dopad na index exp kvuli logickym bazim)
30.01.15 tt; indexace tymu 70*w
06.12.14 tt; pridan index hodnoceno pro tym - ztnu
07.11.14 tt; pridana indexace indexu zhod ve specialni metode
02.09.14 lo; odstraneny tridici indexy
02.07.14 tt; pridano hodnoceni autoru - zha
04.06.14 tt; vypustena indexace ups s hodnotou 4 pro stav archiv
01.11.13 tt; pridana spolupracujici instituce do indexu
24.10.13 tt; pridany index iskod (issn/isbn/ismn)
21.10.13 tt; upraveno indexovani C63
12.06.13 tt; pridana indexace do zaznamu ID autoru
06.06.13 tt; pridany jeste nazev instituce do indexu spi
05.06.13 tt; pridany indexy C62 - C65
24.01.13 tt; pridany index cau pro odkazy na autority
24.01.13 tt; pridany index zpz (presne 970b + vyjimky)
07.10.12 tt; pridana indexace C52$c=nusl
20.09.12 tt; zaindexovani nazvoveho indexu tie pro vyhledavani a naseptavat ipacu
28.08.12 tt; pridana podpora indexace akademie ved podle C57 (RVO)
16.08.12 tt; pridana indexace C58a a 463/C58a
12.06.12 tt; pridana indexace C57 (rvo)
31.05.12 tt; pridan index rdn pro sortovani podle roku, druhu a nazvu
29.03.12 tt; pridano indexovani C21d tzv
30.12.11 tt; pridana indexace C52
12.10.11 tt; zalozeny index prad - pracoviste nezavisle na dezideratech
13.05.11 tt; presunuto odstraneni mezer do nahradni faze, aby se nejdrive
                vyhledavaly projekty tak, jak jsou zapsane v zaznamech
14.04.11 tt; uprava vytvareni indexu auk na autoritu projektu
11.04.11 tt; upraveny podminky pro indexaci pras
08.04.11 tt; pridany index pro zaznamy se spolupracujicimi zaznamy
29.03.11 tt; zmena indexovani xd1 kvuli moznosti opakovatelnych isbn
18.02.11 tt; pridany odkaz na do auk pro projekty
16.07.10 tt; zalozena nova hodnota indexu dk
02.06.10 tt; pridan index app
27.01.10 tt; pridana hodnota vazby z autorit (variantni nazev) - aupra
23.07.08 rs; upravy v indexoch tias*; zrusenie umeleho skratenia indexu tias2
10.10.07 mk; pridana cast pracoviska pre index oddp
12.09.07 mk; pridany novy pomocny index xgra
18.01.07 mk; pridany novy index spolupraca
04.06.07 mk; zmena struktury indexu issbn z issn_isbn na issn a isbn
30.11.06 mk; doplnenie generovania noveho indexu itit sluziaceho na kontrolu duplicit
15.11.06 jj; doplneni indexu dki a ust, zapojeni jako tridici pro i2
13.11.06 jj; zapojeni tridicich indexu pro I2
08.11.06 jj; index rivkod pro vsechna opak. C12
             rozsireni indexu isbn a issn o 463/010 a 463/011
13.10.06 jj; index aupra: autority bez ustavu a bez zeme nedostanou "XX"
19.09.06 jj; rozsireni indexu aupra o autority bez ustavu
02.08.06 lp; pridany index pro oddeleni pracoviste autora "oddp"
22.06.06 jj; doplneni kontroly
21.06.06 jj; nastavení kontroly pro nedezideratni zaznamy
21.06.06 jj; oprava zjistovani "imp", "aua"
09.06.06 jj; rozsireni "exp"
26.05.06 jj; doplneni tias3
17.05.06 jj; doplneni issbn
15.05.06 jj; nastaveni aupra na "bx"
12.05.06 jj; oprava generovani aupra
21.04.06 jj; oprava modifikace dez
16.03.06 jj; doplneni dez
15.03.06 jj; zmena generovani "praua"
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pnGIdx:%Library.Integer,handle:%Library.Binary</FormalSpec>
<Implementation><![CDATA[
 s lsClass=##class(MARC).recordClassX(.handle),lnId=##class(MARC).recordIdX(.handle)
 s sGragD="" ; 26.03.16 tt; pridana promenna pro indexaci poskytovatelu, kteri jsou pouziti ve vymazavani RIV C51 a indexace
 
 s tC51=$$$getTagX(.handle,"c51")
 s tC83=$$$getTagX(.handle,"c83")
 s isDEZ=$g(handle($$$MarcTmpNode,"isDEZ"))
 s isIpac=("d"'=$zcvt($$$getTagX(.handle,"969f"),"L"))
 ; 08.08.15 tt; pridano vyhodnoce pro to, jestli je zaznam zalozen a rozpracovan v novych formularich a jestli to
 ;              ovlivnuje indexovani (primy dopad na index exp kvuli logickym bazim)
 s isIpacNotNew=("n"'=$zcvt($$$getTagX(.handle,"969f"),"L"))
 s isIpacNotNew=('$f($zcvt($$$getTagX(.handle,"969f"),"L"),"n"))
 ; 16.08.15 tt; pridan fix kvuli MyAsep pro ds - pridana n pro 969f=d. Po prechodu na nove formulare, muze byt odstraneno
 
 if ('isIpac) 
 {
   d $$$addIDX("ds","n","b")
   s sNC26d=$$$getTagX(.handle,"c26d")
   d:(sNC26d'="") $$$addIDX("yev",sNC26d,"b")

   /*s sNt999=##class(MARC).getTagX(.handle,"999")
   f  
   { 
     s sNt999e=##class(MARC).getSubTagStr(.sNt999,"e") 
     q:sNt999e=""
     d ##class(User.SPIndex).AddIown(.handle,sNt999e)
   } */  
 }
 
 s dataDup=""
 d ##class(User.CavVf).VysNDupChecData(.handle, .dataDup)
 ; 15.04.20 tt; pridany indexy pro duplicity zd
 d $$$addIDX("zd1",dataDup("zd1"),"b") 
 d $$$addIDX("zd2",dataDup("zd2"),"b") 
 d:(dataDup("idoi")'="") $$$addIDX("zdi",dataDup("idoi"),"b") 
 d:(dataDup("ipubmed")'="") $$$addIDX("zdi",dataDup("ipubmed"),"b") 
 d:(dataDup("iscopus")'="") $$$addIDX("zdi",dataDup("iscopus"),"b") 
 d:(dataDup("iwos")'="") $$$addIDX("zdi",dataDup("iwos"),"b") 
  
 if ('(isIpac&&isIpacNotNew))
 { ; 11.01.17 tt; pridana specialni indexace pro neodeslane zaznamy
   d ..indexNeodeslane(.handle)
   ; 01.02.17 tt; pridan specialni druh dokumentu kvuli neodeslanym zaznamum
   d $$$addIDX("dk","zzzneod","b")
 }
 
 s sC26e=##class(MARC).getTagX(.handle,"c26e")
 s sC26d=##class(MARC).getTagX(.handle,"c26d")
 if ((isDEZ)||('isIpacNotNew))
 {
   if (sC26e'="") d $$$addIDX("dez",sC26e,"bx")
 }
 
 ; 22.10.16 tt; pridana indexace metadatoveho zaznamu
 s t970bData=$$$getTagX(.handle,"970b")
 if (($zcvt(t970bData,"U"))="DATA")
 {  ; hodnota md - metadatovy zaznam, mdv - metadatovy zaznam vystaveny, mdz - metadatovy zaznam rozpracovany
    d $$$addIDX("zmds","md","b")  ; priznak ze je to metadatovy zaznam
    d $$$addIDX("zmdt","md","b")  ; priznak, ze je to metadatovy zaznam
    ; 10.06.19 tt; zmdt - upraven index aby indexoval i navazane soubory
    d $$$addIDX("zmdt","mdnnavz","b")  ; priznak, ze je to metadatovy zaznam

    if (isIpac&&isIpacNotNew) { d $$$addIDX("zmds","mdv","b") } ; vystaveny metadatovy zaznam
    else 
    { ; pokud je zaznam nevystaveny, je potreba se jeste zaridit podle toho, jestli uzivatel souhlasil se spravnosti dat a vystavenim
      d $$$addIDX("zmds","mdz","b") 
      s sU95a=##class(MARC).getTagX(.handle,"u95a")
      if (sU95a="1")
      { ; 13.03.17 tt; pridano rozliseni stavu u datovych zaznamu jestli uzivatel souhlasil s vystavnim, nebo ne
        d $$$addIDX("zmds","mdzsouh","b") 
        ; 10.11.21 tt; pokud je 969f n, ulozime si ustav + souhlas k tomu, aby jsme jednoduse mohli nabidnout link v MyAsep
        d $$$addIDX("zchlink",$tr(sC26e," -","")_"mdzsouh","b") 
                    
      }
      else
      {
        d $$$addIDX("zmds","mdznesouh","b") 
      }
    }  ; rozpracovany metadatovy zaznam
    
    /// 01.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno - upraveno indexovani na ye na U95b
    d $$$addIDX("ye",$e($$$getTagX(.handle,"u95b"),1,4),"b") 
    d $$$addIDX("yex",$e($$$getTagX(.handle,"u95b"),1,4),"b") 
    
    s sU033=##class(MARC).getTagX(.handle,"u033")
    if (sU033="")
    { ; 24.11.22 tt; pridana indexace U03 pro prvotni verzi, aby se to lepe hledalo
      d $$$addIDX("zdv","cav_un_epca*"_$$$HandleT001(handle),"b")
      d $$$addIDX("zdv","cav_un_epca"_$$$HandleT001(handle),"b")
    }
    else
    {
      d $$$addIDX("zdv",$tr(sU033,"*",""),"b")
    }
 }
 elseif (($$$getTagX(.handle,"c76")'="")||($$$getTagX(.handle,"u88")'="")) 
 {
    ; 10.06.19 tt; zmdt - upraven index aby indexoval i navazane soubory
   d $$$addIDX("zmdt","bibnav","b")
 }
 
 if ($$$getTagX(.handle,"c99d")="dflti_epca_cz_wosscopus") 
 { ; 07.02.22 tt; pridana indexace pro chytry link - pro nabizeni nabidky wos-scopus - pro import zaznamu z wos
   d $$$addIDX("zchlink",$tr(sC26e," -","")_"wosscopus","b") 
   d $$$addIDX("zchlink","wosscopus","b")
   if ($f($$$getTagX(.handle,"999d"),"arl_import_wos"))
   {
     d $$$addIDX("zchlink",($tr(sC26e," -","")_"wosscopus"_sC26d),"b") 
     d $$$addIDX("zchlink",("wosscopus"_sC26d),"b")
   }   
   
   if (..tfDuplicitaHledejZaznam(.handle)'="")
   { ; 14.03.23 tt; pridano indexovani duplicit
     d $$$addIDX("zwdup","wos","b")
     d $$$addIDX("zwdup",$tr(sC26e," -","")_"wos","b") 
   }
 }
 
 if ($$$getTagX(.handle,"c76u")'="") 
 { ; 10.06.19 tt; zmdt - upraven index aby indexoval i navazane soubory
   d $$$addIDX("zmdt","mdnnavz","b")
 } 
  
 ; 12.10.11 tt; zalozeny index prad - pracoviste nezavisle na dezideratech
 d:(sC26e'="") $$$addIDX("prad",$tr(sC26e," -",""),"b")
 ; 18.01.16 tt; pridana indexace pra pro desiderata
 d:(sC26e'="") $$$addIDX("pra",sC26e,"bx")
 d:(sC26e="slchpl-s") $$$addIDX("pra","slchpls","bx")

 ; 17.09.19 tt; pridano mocmocne indexovani kvuli slovniku
 s sPomZslpra=""
 s:(sC26e'="") sPomZslpra=##class(User.Util).sXlate("CAV_PRA",$zcvt(sC26e,"U"),"N","Cav")
 d:(sPomZslpra'="") $$$addIDX("zslpra",sC26e,"b")

 ; 01.04.14 tt; pridan index pro odmazavani zanamu z RIVu
 d:(tC51'="")&&(sC26e'="") $$$addIDX("pradl",sC26e,"b")
 ; 19.05.17 tt; pridan index pro opravy RIVu
 d:(tC83'="")&&(sC26e'="") $$$addIDX("praopr",sC26e,"b")

 
 ; 29.03.05 rs; novy index omfn
 s sMFN=##class(MARC).getTagX(.handle,"c99a")
 ; 18.04.05 jj; rozsireni indexu "t001n" o C99$a<br>
 if sMFN'="" d $$$addIDX("t001n",sMFN,"b")
 if sMFN="" s sMFN=$$$HandleT001(handle)
 d $$$addIDX("omfn",sMFN,"b")
 
 ; 14.06.16 tt; uprava indexovani pro slovnik
 s sC99SlovDK=$$$getTagX(.handle,"c99d")
 s sC99SlovDK=$$$strswap(sC99SlovDK,"dflt_cz_epca_","")
 s:(sC99SlovDK="r1") sC99SlovDK="r"
 s sC99Popis=##class(User.Util).sXlate("CAV_REC_KIND_SLOV",$zcvt(sC99SlovDK,"U"),"N","Cav")
 d:(($l(sC99SlovDK)<4)&&(sC99Popis'="")) $$$addIDX("zdksl",sC99SlovDK,"b") 

 
 /// 07.05.14 tt; ixIndexValuesEx: generovani auk pro 971 a C71 presunuto do popredi, aby se generovalo i pro deziderata 
 for oh=1:1:2
 { ; 29.04.14 tt; pridany ohlasy do indexu auk - z databaze ohlasu
   s sTagO=$p("971#c71","#",oh)   ; 
   s c=0
   d {
     s sT=$$$getTagXC(.handle,sTagO,.c) ; vsetky instituce
     continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
     if (sT'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTx=$$$getSubTagStr(sT,"x")
       d:((sTx'="")&&($f(sTx,"cav_un_ohl_cat*"))) $$$addIDX("auk",sTx,"b")
     }
   } while (c'=0)
 } 
 
 s c=0,bPomPra=0 
 d { ; 02.07.14 tt; pridano hodnoceni autoru - i pro deziderata
   s sT=$$$getTagXC(.handle,"70*",.c) ; vsichni autori
   continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sT'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTu=$$$getSubTagStr(sT,"u")
     s sTo=$$$getSubTagStr(sT,"o")
     if (sTu'="") 
     {
       d $$$addIDX("zha",sTu,"b")
       s sT3=$$$getSubTagStr(sT,"3")
       d:(sT3'="") $$$addIDX("zha",sT3,"b")
              
       ; 18.01.16 tt; pridana indexace pra pro desiderata
       s sTp=$$$getSubTagStr(sT,"p")
       d:(sTp'="") $$$addIDX("pra",sTp,"bx")
             
       ; 17.09.19 tt; pridano mocmocne indexovani kvuli slovniku
       s sPomZslpra=""
       s:(sTp'="") sPomZslpra=##class(User.Util).sXlate("CAV_PRA",$zcvt(sTp,"U"),"N","Cav","c")
       d:(sPomZslpra'="") $$$addIDX("zslpra",sTp,"b")

       d:(sTp="slchpl-s") $$$addIDX("pra","slchpls","bx")
     }
     if (sTo'="")
     { ; 02.08.16 tt; pridane indexovani oddeleni autora pro slovnik
       d $$$addIDX("zoddasl",sTo,"b")
     }   
     if ($$$getSubTagStr(sT,"p")'="")  
     {
       s bPomPra=1
     }
     s sT3=$$$getSubTagStr(sT,"3")
     if (sT3'="") 
     { ; 18.01.24 tt; do indexu auk pridana indexace vdanych autorek - autorita/403
       if ##class(User.MARC).readLX(.handlePomAut,sT3)
       { ; pokud se nam podarilo autoritu otevrit
          s sA4003=$$$getTagX(.handlePomAut,"4003")
          if ($l(sA4003)>2)
          { ; 06.02.19 tt; upravena podminka, aby se indexovaly projekty s delkou 3 a vice znaku - zprog
            d $$$addIDX("auk",sA4003,"b")
          }          
       }    
     }
   }
 } while (c'=0)
 
 if (sC26e'="") 
 { ; 24.02.21 tt; pridano indexovani zprai
   d:(bPomPra=1) $$$addIDX("zprai",sC26e,"bx")
   s prmeno=##class(SPIndex).ixGetPracName("CavUnEpca",sC26e)
   
   if ((bPomPra=0) && ($$$getTagX(.handle,"c90a")'="")) 
   {
     d $$$addIDX("zprah",sC26e,"bx")  ; index pracoviste hostitele
     d:(prmeno'="") $$$addIDX("zprah",prmeno,"bx")
   }
   else
   {
     d $$$addIDX("zprai",sC26e,"bx")   ; mimo pracoviste hostitele
     d:(prmeno'="") $$$addIDX("zprai",prmeno,"bx")   
   }
 }
 
 ; 26.10.14 tt; pridany indexy zut, ztu, ztn
 s c=0
 d {
   s sT014=$$$getTagXC(.handle,"014",.c) ; projedme vsechny identifikacni cisla
   continue:((sT014="")&&(c'=0))
   if (sT014'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sT0142=$$$getSubTagStr(sT014,"2")
     d:(sT0142'="") $$$addIDX("zut",sT0142,"b")
     s sT014a=$$$getSubTagStr(sT014,"a")
     ; 06.06.16 tt; pridan index zidc
     if (sT014a'="")
     {
       d $$$addIDX("zidc",sT014a,"b")
       if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="scopus")
       { ; 16.06.16 tt; pro ID scopusu indexuji i s prefixem
         s sIDScopus="2-s2.0-"_sT014a
         d $$$addIDX("zidc",sIDScopus,"b")
         d $$$addIDX("zidc",(sT0142_":"_sIDScopus),"b")
       }
      
       d $$$addIDX("zidc",(sT0142_":"_sT014a),"b")
       ; 26.06.16 tt; pridana indexaci id pro slovnik zidcsl
     /*  d:(sT0142="pubmed") $$$addIDX("zidcsl",("PubMed:"_sT014a),"b")
       d:(sT0142="wos") $$$addIDX("zidcsl",("WOS:"_sT014a),"b")
       d:(sT0142="scopus") $$$addIDX("zidcsl",(" SCOPUS:"_sT014a),"b")
*/
     }     
   }
 } while (c'=0)    
    
 
 s c=0
 d { ; 03.06.16 tt; pridan index zdoi
   s sT017=$$$getTagXC(.handle,"017",.c) 
   continue:((sT017="")&&(c'=0))
   if (sT017'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sT0172=$$$getSubTagStr(sT017,"2")
     s sT017a=$$$getSubTagStr(sT017,"a")
     d:(sT0172="doi") $$$addIDX("zdoi",sT017a,"b")     
   }
 } while (c'=0)    

    
 s c=0
 d {
   s sTC64=$$$getTagXC(.handle,"c64",.c) ; projdeme vsechny informace k hodnoceni
   continue:((sTC64="")&&(c'=0))
   if (sTC64'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTC64a=$$$getSubTagStr(sTC64,"a")
     s sTC64b=$$$getSubTagStr(sTC64,"b")
     s sTC64c=$$$getSubTagStr(sTC64,"c")
     ; 03.04.15 tt; pridana jina forma indexovani
     d:((sTC64a="1")&&(sTC64c'="")) $$$addIDX("ztu",sTC64c,"b")
     d:((sTC64a="1")&&(sTC64c'="")) $$$addIDX("ztu",$tr(sTC64c,"- ",""),"b")
     ; 06.12.14 tt; pridan index hodnoceno pro tym
     d:((sTC64a="1")&&(sTC64b'="")) $$$addIDX("ztnu",sTC64b,"b")
     d:((sTC64b'="")) $$$addIDX("ztn",sTC64b,"b")
     ; 06.11.14 tt; uprava indexovani exp
     ; 08.08.15 tt; ovlivneno indexovani novymi zaznamy 
     d:((sTC64a="1")&&('isDEZ)&&(isIpacNotNew)) $$$addIDX("exp","vz","b")
   }
 } while (c'=0)    

 /// 21.12.15 tt; indexNenavazane: pridana indexace nenavazanych zaznamu a vlastnika (999e-f)
 d ##class(User.CavUnAuth).indexNenavazane(.handle)

 ; 21.02.16 tt; doplnena indexace 970x - zodr
 s t970x=$$$getTagX(.handle,"970x") 
 d:(t970x'="") $$$addIDX("zodr",t970x,"b")
 
 s sZid=$tr($j($$$HandleT001(handle),15)," ",0)  ;zistenie t001 z handle zaznamu s odmazanim vidicich 0
 if ((sZid'="")||(sZid'="new"))
 { ; 03.03.16 tt; pridan index zid
   d $$$addIDX("zid",sZid,"b")   ; pridame normalni index
   d ##class(SPIndex).ixSetSortIndexX(.handle,"szid",sZid) ; pridame sortovaci index
 }
 
 ; 05.09.07 tt; upraven index z zdmt na zdms
 if (($zcvt(t970bData,"U"))="DATA")
 { ; 17.11.16 tt; pridane indexovani dataset bez souboru - datasetu
   s sMDc76u=$$$getTagX(.handle,"c76u")
   if (sMDc76u="")&&(..allowDeleteContent(.handle)="")
   { ; medatadovy zaznam bez fulltextu
     d $$$addIDX("zmds","mdbds","b")
   }
   elseif (..allowDeleteContent(.handle)'="")
   { ; s fulltextem
    d $$$addIDX("zmds","mdsds","b") 
   }
   elseif (sMDc76u'="")
   { ; dataset s daty v jinych repozitarich
     d $$$addIDX("zmds","mddsvjr","b")         
   }
 }
 
 d ..indexSmlouva(.handle)
 ; ak je zaznam dezideratum (resp. v terminologii EPCA "navrh")
 ; potom dalej nepokracujeme
 if (isDEZ) q
 
 ; 07.11.14 tt; pridana indexace indexu zhod ve specialni metode
 d ..indexHodnoceniAV(.handle)
 
 ; 31.08.05 jj;
 s t970b=$$$getTagX(.handle,"970b")
 s t200a=$$$getTagX(.handle,"200a")
 if (($zcvt(t970b,"U")="BCA") || (($zcvt(t970b,"U"))="BXX"))
 { ; jeste kontrola na 110
   ; 09.08.16 tt; odstranena kontrola kvuli nevyhledani BCA dokumentu
   /*s t110a=##class(MARC).getTagX(.handle,"110a")
   if (t110a'="")
   { */
       ;* 23.07.08 rs; zrusenie umeleho skratenia; indexy sa teraz pouzivaju len pre browse
       ;               a nie pre deduplikaciu
       ;*s t200a=..corrTias2(t200a)
       
       d $$$addIDX("tias2",t200a,"bx")
       ; 22.09.16 tt; pridana indexace bez diakritiky
       s t200aTRU=##class(User.Util).diaTRUni(t200a) 
       d $$$addIDX("tias2",t200aTRU,"bx")
       ; 23.07.08 rs; tias23 bude spojenim tias2 a tias3
       d $$$addIDX("tias23",t200a,"bx")
   //}
 }
 
 ; 20.09.12 tt; zaindexovani nazvoveho indexu tie pro vyhledavani a naseptavat ipacu
 if (($zcvt(t970b,"U")'="BCA") && (($zcvt(t970b,"U"))'="BXX"))
 { ; 200$a z datovych zaznamu, nikoliv ze soubornych (BCA, BXX).
   s s200atie=$zstrip(t200a,"<>W")
   d ##class(rep.epca.exportBase).symClearFormatInfoStr(.s200atie)

   ; 19.10.16 tt; indexace metadatoveho souboru
   if (($zcvt(t970b,"U"))="DATA") 
   { 
     d $$$addIDX("zmdn",s200atie,"bx")  
     d $$$addIDX("zmdn",##class(User.Util).diaTRUni(s200atie) ,"bx")   
     d $$$addIDX("ups","data","b")   ; pridano indexovani vedeckych dat
   }

   d $$$addIDX("tie",s200atie,"bx")
   if (($e(s200atie,1)="<")&&($l($p(s200atie,">",1))<6)&&($f(s200atie,">")))
   { ; odstraneni clenu, pokud by je nahodou na cav zacali pouzivat
     s s200atie=$zstrip($p(s200atie,">",2,999),"<>W")
     d $$$addIDX("tie",s200atie,"bx")
     ; 19.10.16 tt; indexace metadatoveho souboru
     d:(($zcvt(t970b,"U"))="DATA") $$$addIDX("zmdn",s200atie,"bx")   
   }   
 }

 ; 22.10.16 tt; pridana indexace metadatoveho zaznamu a souvisejicich
 s c=0
 d {
   s sT=$$$getTagXC(.handle,"u88",.c) ; vsetky instituce
   continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sT'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sT3=$$$getSubTagStr(sT,"3")
     if (sT3'="") 
     {
       d $$$addIDX("zmdl",sT3,"b")
       d $$$addIDX("zmdl",$tr(sT3,"*",""),"b")
       if ##class(MARC).readLX(.handleMD3,sT3)
       { ; pokud se nam podarilo otevrit metadatovy zaznam
         s sMDc76u=$$$getTagX(.handleMD3,"c76u")
         // d $$$addIDX("zmdt","md","b")   ; 18.10.21 tt; odstraneno indexovani md - dataset - neni spravne
         if (sMDc76u="")
         { ; mdi - zaznam na odkazany metadatovy zaznam interni (neni 856u)
           d:(t970bData'="data") $$$addIDX("zmdt","mdi","b")
         }
         else
         { ; mde -odkaz na metadatovy zaznam externi 
           d:(t970bData'="data") $$$addIDX("zmdt","mde","b")
         }
       }    
     }
     ; 10.06.19 tt; zmdt - upraven index aby indexoval i navazane soubory
     d:(t970bData'="data") $$$addIDX("zmdt","bibnav","b")
   }
 } while (c'=0)
 
 ; 22.10.16 tt; pridana indexace metadatoveho zaznamu a souvisejicich
 s c=0
 d {
   s sT=$$$getTagXC(.handle,"c76",.c) ; vsetky instituce
   continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sT'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTu=$$$getSubTagStr(sT,"u")
     if (sTu'="") 
     {
       d:(t970bData'="data") $$$addIDX("zmdt","mde","b")
     }
     
     ; 10.06.19 tt; zmdt - upraven index aby indexoval i navazane soubory
     d:(t970bData'="data") $$$addIDX("zmdt","bibnav","b")
   }
 } while (c'=0)
 
 
 if ($zcvt(t970b,"U")'="DATA")
 { ; 01.09.17 tt; uprava indexace indexu "zmdl" pro navazadi zaznamu na datavy zaznam
   s idxData=""
   for  
   { ; zistit vsechny navazani na datove zaznamy
     s idxData=$o(^$$$MarcIndexG("CavUnEpca","zmdl",(" cav_un_epca*"_$$$HandleT001(handle)),idxData))
     q:(idxData="")
     if (idxData'="")
     {
       s sLinkDataV="cav_un_epca*"_##class(MARC).getT001(idxData)
       d $$$addIDX("zmdl",sLinkDataV,"b")
       d $$$addIDX("zmdl",$tr(sLinkDataV,"*",""),"b")      
     }
   }
 }
 

 ; 24.08.05 jj; doplneni indexu issn3 (issns pro szp)
 s s011a = ##class(MARC).getTagX(.handle,"011a")
 if (s011a'="")
 {
   ; 24.04.06 mk; odstranenie chybne dotahovanej hodnoty     
   ; 03.05.06 jj; opetovne nastaveni "xszp" namisto "xzrp" pro "issns"
   ; 09.08.16 tt; odstranena kontrola kvuli nevyhledani BCA dokumentu - tady zjemnena kontrola
   if ((($g(handle($$$MarcTmpNode,"dk"))="xszp")||($zcvt(t970b,"U")="BCA"))&&($zcvt(t970b,"U")'="BXXS")) d $$$addIDX("issns",s011a,"b")    
   ;if $g(handle($$$MarcTmpNode,"dk"))="xzrp" d $$$addIDX("issns",s011a,"b")     
   ;if handle($$$MarcTmpNode,"dk")="xszp" d $$$addIDX("issns",s011a,"b")
 }

 ; 01.09.15 tt; pridana indexace eissn
 s s011e = $$$getTagX(.handle,"011e")
 if (s011e'="")
 {
   if ((($g(handle($$$MarcTmpNode,"dk"))="xszp")||($zcvt(t970b,"U")="BCA"))&&($zcvt(t970b,"U")'="BXXS")) d $$$addIDX("issns",s011e,"b")    
   d $$$addIDX("zeissn",s011e,"b")
   d:((($g(handle($$$MarcTmpNode,"dk"))="xszp")||($zcvt(t970b,"U")="BCA"))&&($zcvt(t970b,"U")'="BXXS")) $$$addIDX("issn",s011e,"b") ; 24.11.17 tt; pridana indexace eissn do indexu issn
   d $$$addIDX("iskod",s011e,"b")
 }
 
 s sT102a=$$$getTagX(.handle,"102a")
 s sPopis=##class(User.Util).sXlate("STABLE_UT_COUNTRIES",$zcvt(sT102a,"U"),"N","Cav")
 if (sPopis'="") 
 {
   d $$$addIDX("zzemesl",sT102a,"b")
 }
 
 s sT101a=$$$getTagX(.handle,"101a")
 s sPopis=##class(User.Util).sXlate("UT_LANGUAGE",sT101a,"N","Cav")
 if (sPopis'="") 
 {
   d $$$addIDX("zlangsl",sT101a,"b")
 }
  
 ; 17.05.06 jj; doplneni issbn
 ; 26.05.06 jj; doplneni tias3
 if ($zcvt(t970b,"U")="BXXS")
 { 
   s s010aA = $$$getTagXC(.handle,"010a",-1)
   ; 04.06.07 mk zmena struktury indexu issbn z issn_isbn na issn a isbn
   ;if (s010a_s011a'="") d $$$addIDX("issbn",s011a_"_"_s010a,"b")
   if (s010aA'="")
   { ; 25.03.11 tt; zmena indexovani issbn
     for l=1:1:$l(s010aA,$c(10))
     { ; zaindexujeme vsechny isbn
       s s010a=$p(s010aA,$c(10),l)  
       if (s010a'="") d $$$addIDX("issbn",s010a,"b")
     }
   }
   if (s011a'="") d $$$addIDX("issbn",s011a,"b")
   if (s011e'="") d $$$addIDX("issbn",s011e,"b")
   
   d $$$addIDX("tias3",t200a,"bx")
   ; 23.07.08 rs; tias23 bude spojenim tias2 a tias3
   d $$$addIDX("tias23",t200a,"bx")
 }


 ; 24.01.13 tt; pridany index zpz (presne 970b + vyjimky)
 ; 09.09.05 jj; doplneni hodnoty "JI" do "dk"
 ; 21.06.06 jj; oprava zjistovani "imp"
 s isImp=$g(handle($$$MarcTmpNode,"isIMP"))
 if ($zcvt(t970b,"U")="J") && (isImp)
 {
   ; s id=##class(MARC).getIdxValX(.handle,"imp")
   d $$$addIDX("dk","ji","b")
   d $$$addIDX("zpz","ji","b")
 }
 ; 31.10.05 jj; doplneni hodnot "A1", "A2" do "dk"
 s sDKint=$$$getTagX(.handle,"c99d")
 if ($e($zcvt(t970b,"U"),1)="A")
 {
   if ($zcvt(sDKint,"U")="DFLT_CZ_EPCA_A1") 
   {
     d $$$addIDX("dk","a1","b")
     d $$$addIDX("zpz","a1","b")
   }
   if ($zcvt(sDKint,"U")="DFLT_CZ_EPCA_A2")
   {
     d $$$addIDX("dk","a2","b")
     d $$$addIDX("zpz","a2","b")
   } 
   if ($zcvt(sDKint,"U")="DFLT_CZ_EPCA_A3")
   { ; 09.12.21 tt; provedeno indexovani dokumentu A3
     d $$$addIDX("dk","a3","b")
     d $$$addIDX("zpz","a3","b")
   } 
 }
 
 ; 11.03.14 tt; pridany do indexu zpz hodnoty pro vyzkumne zpravy
 if ($zcvt(t970b,"U")="V")
 { ; 12.02.14 tt; pridana indexace vyzkumne zpravy - rozsireni pro index dk
   ; va - vyzkumna zprava
   ; vu - vyzkumna zprava - utajovane informace
   ; vs - vyzkumna zprava – souhrnna
   s sC34v=$$$getTagX(.handle,"c34v")
   if (sC34v'="")
   {
     d $$$addIDX("dk",("v"_($zcvt(sC34v,"L"))),"b")
     d $$$addIDX("zpz",("v"_($zcvt(sC34v,"L"))),"b")
     ; 10.03.16 tt; pridano indexovani C34v v indexu zpdv pro odeslane zaznamy
     d $$$addIDX("zpdv",sC34v,"b")
   }
 }

 ; 06.06.16 tt; upraveno indexovani druhu dokumentu - rozsireni L,L3 a Z
 if ($zcvt(t970b,"U")="L")
 {s sC34m=$$$getTagX(.handle,"c34m")
   if (sC34m'="")
   {
     d $$$addIDX("dk",("l"_($zcvt(sC34m,"L"))),"b")
     d $$$addIDX("zpz",("l"_($zcvt(sC34m,"L"))),"b")
   }
 }
 if ($zcvt(t970b,"U")="L3")
 {s sC34u=$$$getTagX(.handle,"c34u")
   if (sC34u'="")
   {
     d $$$addIDX("dk",("l3"_($zcvt(sC34u,"L"))),"b")
     d $$$addIDX("zpz",("l3"_($zcvt(sC34u,"L"))),"b")
   }
 }
 if ($zcvt(t970b,"U")="Z")
 {s sC34l=$$$getTagX(.handle,"c34l")
   if (sC34l'="")
   {
     d $$$addIDX("dk",("z"_($zcvt(sC34l,"L"))),"b")
     d $$$addIDX("zpz",("z"_($zcvt(sC34l,"L"))),"b")
   }
 }

 ; 16.07.10 tt; zalozena nova hodnota indexu dk
 d $$$addIDX("dk","z"_t970b,"b")
 d:(t970b'="") $$$addIDX("zpz",t970b,"b")

 
 s tC26=$$$getTagX(.handle,"c26")
 s tC62a=$$$getTagX(.handle,"c62a")

 if (isIpacNotNew)
 { ; 08.08.15 tt; ovlivneno indexovani indexu exp pro hodnotu isIpacNotNew kvuli vylouceni novych zaznamu z formularu
   ; export SIGLE
   s la=$$$getSubTagStr(tC26,"a")
   if la d $$$addIDX("exp","s","b")
   ; export RIV
   s la=$$$getSubTagStr(tC26,"b")
   ; 09.06.06 jj; rozsireni "exp"
   if la {d $$$addIDX("exp","r","b")}
   else  {d $$$addIDX("exp","nr","b")}
   ; export ASEP
   ; 20.11.07 jj; rozsireni indexu exp
   s la=$$$getSubTagStr(tC26,"c")
   if la {d $$$addIDX("exp","a","b")}
   else  {d $$$addIDX("exp","na","b")}
   
   ; 05.06.13 tt; pridany indexy C62 - C65
   d:(tC62a="1") $$$addIDX("exp","sev","b")
   
   ; 19.01.18 tt; upravena podminka pro index, ktery si vyuziva pri filtrovani zaznamu pro formulare datovych zaznamu - nenabizet BCA a BXXS
   ; 05.09.17 tt; pridana indexace zaznamu, ktere nejsou data a jsou v ipacu
   d:(($zcvt(t970b,"U")'="DATA")&&($zcvt(t970b,"U")'="BXXS")&&($zcvt(t970b,"U")'="BCA")) $$$addIDX("exp","nodata","b")
   ; 05.01.19 tt; pridan index pro datasety do exp
   d:($$$getTagX(.handle,"c76u")'="") $$$addIDX("exp","dataset","b")
 }
 
 s tC65a=$$$getTagX(.handle,"c65a")
 d:(tC65a'="") $$$addIDX("dem",tC65a,"b")
 
 ; 09.06.05 rs; specialne pouzitie C13 na doplnenie indexu 'grag' z C12
 s tC13=##class(MARC).getTagX(.handle,"c13a",-1)
 s c=$l(tC13,$c(10))
 
 f i=1:1:c
 {
    s s=$p(tC13,$c(10),i) if s="" continue
    
    ;s sa=##class(MARC).getSubTagStr(s,"a")
    if $e(s,1,4)="cez:" s $e(s,1,4)="" ; odmazanie prefixu
    
    ; aj je to AV0* patri grantovej agenture GAAVCR 
    if $e(s,1,3)="av0" 
    { 
      d $$$addIDX("grag",$zcvt("GA AV ČR","L"),"b") 
      s sGragD=sGragD_$c(10)_$zcvt("GA AV ČR","L")
    }
    ; 21.05.08  tt; provedena nasledujici zmena
    ; jeste bych potrebovala udelat jednu upravu xml souboru. Mezi vyzkumnymi 
    ; zamery je VZ MSM0021620846, tento VZ zamer je potreba vybrat do souboru pro
    ;  poskytovatele MSM.(tedy jako by tam bylo GA MSk, ale neni to projekt, ale VZ). 
    if $e(s,1,13)="msm0021620846" 
    {
      d $$$addIDX("grag",$zcvt("GA MŠk","L"),"b")                                
      s sGragD=sGragD_$c(10)_$zcvt("GA MŠk","L")
    }
 }
 
 ; 05.08.08 tt vyjimka pro zaznamy, ktere nemaji C13
 /* Pokud se v zaznamu nachazi pouze projekt, kde je vyplneno pole c12d, 
   (není tam zadny projekt kde je vyplneno pole c12b, ani neexistuje pole c13), 
    tak se zaznam vyexportuje do xml souboru AV0. 
    Vyjimka je u NHU-C, tam se vyexportuje tento zaznam do xml souobru MSM.
 */
 if (tC13="")
 { ; pokud neni zadny vyskyt C13, musime provest kontrolu, jestli neni v C12b
   s sGranty=##class(MARC).getTagX(.handle,"c12",-1) ; ziskame vsechny opakovani C12
   s c=$l(sGranty,$c(10))                            ; spocitame pocet vyskytu
   f i=1:1:c
   { ; 
     s sGrant=$p(sGranty,$c(10),i)
     s sB=##class(MARC).getSubTagStr(sGrant,"b") 
     s sE=##class(MARC).getSubTagStr(sGrant,"e")
     s sD=##class(MARC).getSubTagStr(sGrant,"d")
     ; 24.02.21 tt; pridano indexovani znav
     d:(sD'="") $$$addIDX("znav",sD,"b")
     
     s sC26e=##class(MARC).getTagX(.handle,"c26e") ; ziskani pole, podle ktereho se rozhoduje

     if ((sB="")&&(sD'=""))
     {
       if ($zcvt(sC26e,"L")="nhu-c") 
       {
         d $$$addIDX("grag",$zcvt("GA MŠk","L"),"b")
         s sGragD=sGragD_$c(10)_$zcvt("GA MŠk","L")
       }
       else 
       { 
         d $$$addIDX("grag",$zcvt("GA AV ČR","L"),"b")
         s sGragD=sGragD_$c(10)_$zcvt("GA AV ČR","L")
       }
     }           
   }
 }
 
 s c=0
 d { ; 26.01.21 tt; pridana indexace vyzkumne infrastruktury
   s sTC90=$$$getTagXC(.handle,"c90",.c) ; vsechny vyzkumne infrastruktury
   continue:((sTC90="")&&(c'=0))         ; pokud nemam data pokracuji
   if (sTC90'="") 
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTC90a=$$$getSubTagStr(sTC90,"a")
     if (sTC90a'="")
     { ; pokud mame vyplnene obe pole, pridavame
       s sTC90aT=##class(User.Util).sXlate("UN_INFRASTRUKTURA",sTC90a,"N","Cav")
       d:(sTC90aT'="") $$$addIDX("gra",sTC90aT,"b")
       d:(sTC90a'="") $$$addIDX("gra",sTC90a,"b")
       
       if (##class(MARC).getTagX(.handle,"70*p",-1)="")
       { ; pokud nemame vyplneneho autora s pracovistem, dame do grag av0 - akademii
         d $$$addIDX("grag",$zcvt("GA AV ČR","L"),"b")
         s sGragD=sGragD_$c(10)_$zcvt("GA AV ČR","L")
       }
       
       ; 24.02.21 tt; pridano indexovani znav
       d:(bPomPra=1) $$$addIDX("znav","infd","b")
       d:(bPomPra=0) $$$addIDX("znav","infh","b")
     }
   }
 } while (c'=0)
 
 s c=0
 d { ; 03.12.21 tt; pridana indexace vyzkumne zpusobu zverejneni zzpz
   s sTC91=$$$getTagXC(.handle,"c91",.c) 
   continue:((sTC91="")&&(c'=0))        
   if (sTC91'="") 
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTC91a=$$$getSubTagStr(sTC91,"a")
     if (sTC91a'="")
     { 
       d $$$addIDX("zzpz",sTC91a,"b")
     }
   }
 } while (c'=0)
  
 ; 20.05.05 lp; pridat datum usporadani akce z C20f do indexu "ye",
 ;              jenom pro druh dokumentu U
 ; t970b nactena driv
 ; s t970b=##class(MARC).getTagX(.handle,"970b")
 ; 19.10.05 jj; porovnat zkonvertovanou verzi 970b, doplnit bx namisto b
 ; if t970b="u" d
 ; 08.04.11 tt; prepsan stary zpusob zapistu
 if (($zcvt(t970b,"L")="u")||($$$getTagX(.handle,"c99d")="dflt_cz_epca_a3")) 
 {
   s la=##class(MARC).getTagX(.handle,"c20f") 
   if (la'="")
   {
     s:($f(la,"-")) la=##class(Util).trim($p(la,"-",1))
     s sYear=""
     if $l(la,".")=3 
     {
       s sYear=$p(la,".",3)
     }
     else
     {
       if $l(la)>=4 s sYear=$e(la,1,4)
     }
     if sYear'="" d $$$addIDX("ye",sYear,"bx")
   }
 }
 
 if $zcvt(t970b,"L")="bca" 
 { ; 20.10.21 tt; u druhu dokumentu BCA zajisteno indexovani ye ze clanku
   s idNal=""
   f
   {
     s idNal=##class(User.MARC).getIDByIndex("CavUnEpca","auk"," cav_un_epca*"_$$$HandleT001(handle),idNal)
     q:((idNal=0)||(idNal=""))
     s sIndYE=""
     for 
     {
       s sIndYE=##class(User.MARC).getIdxVal("CavUnEpca",idNal,"ye",sIndYE)
       q:(sIndYE="")
       d $$$addIDX("ye",$tr(sIndYE," ",""),"bx")
     }  
   }
 }
 
 ; 23.06.05 jj; doplneni indexu "rivg" a "rivvz"<br>
 if ##class(MARC).getTagX(.handle,"c26b")="1"
 {
   ; index rivg
   ; 27.06.05 jj; zmena podm. pro "rivg"
   ; s suma=-1
   s suma=0
   s tC12=##class(MARC).getTagX(.handle,"c12",-1) 
   if (tC12'="")
   {
     s count=$l(tC12,$c(10))
     ; s suma=0
     f i=1:1:count
     {
       s sPart=$p(tC12,$c(10),i) if sPart="" continue
       s s=##class(MARC).getSubTagStr(sPart,"b")
       if (s'="") s suma=suma+1
       ; 30.10.06 jj; doplneni indexu rivkod
       ; 08.11.06 jj; index rivkod pro vsechna opak. C12
       s s=##class(MARC).getSubTagStr(sPart,"a")
       if (s'="") d $$$addIDX("rivkod",s,"b")
     }
   } 
   ; 27.06.05 jj; zmena podm. pro "rivg"
   d $$$addIDX("rivg",suma,"b")
   ; index rivvz
   s tC13=##class(MARC).getTagX(.handle,"c13",-1) 
   s count=0
   if (tC13'="") s count=$l(tC13,$c(10))
   d $$$addIDX("rivvz",count,"b")
 }
 
 ; 21.06.06 jj; nastavení aupra jen pro nedezideratni zaznamy
 ; 07.03.06 jj; doplneni "praua", "aupra"
 ; 15.03.06 jj; zmena generovani "praua"
 ; 12.05.06 jj; oprava generovani
 ; s ustav=##class(MARC).getIdxValX(.handle, "ustav")
 ; s pra=##class(MARC).getIdxValX(.handle, "pra")
 ; s aua=##class(MARC).getIdxValX(.handle, "aua")
 ; s aup=##class(MARC).getIdxValX(.handle, "aup")

 ; akce / C20aef
 s aua=""
 s sC20=##class(MARC).getTagX(.handle,"c20")
 if (sC20'="")
 {
   s aua=##class(MARC).getSubTagStr(.sC20,"a")
   s sa=##class(MARC).getSubTagStr(.sC20,"e")
   if (sa'="")
   { if (aua'="") s aua=aua_" "
     s aua=aua_sa
   }
   ; 20.06.16 tt; pridana indexace zauasl
   d:(aua'="") $$$addIDX("zauasl",$tr(aua,"-"," "),"b")
   s sa=##class(MARC).getSubTagStr(.sC20,"f")
   s saS=##class(MARC).getSubTagStr(.sC20,"s")
   s:(saS'="") sa=sa_"-"_saS
   if (sa'="")
   { if (aua'="") s aua=aua_" "
     s aua=aua_sa
   }
   ; 20.06.16 tt; pridana indexace zauasl
   d:(aua'="") $$$addIDX("zauasl",$tr(aua,"-"," "),"b")
 }
   
 ; aup + pra
 ; vzit 70Xab + 70Xp
 s aup="",pra=""
 s s70X=##class(MARC).getTagX(.handle,"70*",-1)
 if (s70X'="")
 {
   s cnt=$l(s70X,$c(10))
   
   ; 18.01.07 mk; spolupraca novy index
   s spl="cz"
   
   f i=1:1:cnt 
   { s sPart=$p(s70X,$c(10),i)
     
     ; 24.01.13 tt; pridany index cau pro odkazy na autority
     d $$$ixTagListConCat("abcdfs","cau","bx"," ",sPart)
     s aup=..getXXX("ab"," ",sPart)
     s pra=##class(MARC).getSubTagStr(sPart,"p")
      
     ; 11.04.11 tt; upraveny podminky pro indexaci pras
     if ((pra'=sC26e)&&($zcvt(t970b,"L")'="bxxs"))
     { ; 08.04.11 tt; pridany index pro zaznamy se spolupracujicimi zaznamy
       d $$$addIDX("pras",pra,"b")       
     }
     if ((pra'=sC26e)&&(pra'=""))
     { ; 24.02.21 tt; pridano indexovani zprai
       d $$$addIDX("zprai",pra,"bx")
       s prmeno=##class(SPIndex).ixGetPracName("CavUnEpca",pra)
       d:(prmeno'="") $$$addIDX("zprai",prmeno,"bx")
     }
     
     ; 01.04.14 tt; pridan index pro odmazavani zanamu z RIVu
     d:(tC51'="")&&(pra'=sC26e) $$$addIDX("pradl",sC26e,"b")
     ; 19.05.17 tt; pridan index pro opravy RIVu
     d:(tC83'="")&&(pra'=sC26e) $$$addIDX("praopr",sC26e,"b")
 
     ; 19.09.06 jj; rozsireni indexu aupra o autority bez ustavu
     if (pra="") s pra=##class(MARC).getSubTagStr(sPart,"y")
     
     ; 18.01.07 mk; novy index spolupraca, ktory zisti ci tam pracoval niekto zo zahranicia
     ;              alebo len domaca spolupraca
     if spl="cz"
     {
       s ty=$$$getSubTagStr(sPart,"y")  ; kod krajiny
       ; 26.06.19 tt; pridana podminka na pracoviste - pokud ma autor pracoviste, je domaci
       ; vyhledávají se i záznamy, kde je zahraniční autor zaměstnanec AV ČR.
       ; Zahraniční mají být pouze mimoakademičtí autoři, kteří mají uvedenu zemi jinou než ČR.
       if ((ty'="") && ($zcvt(ty,"u")'="CZ") && (##class(MARC).getSubTagStr(sPart,"p")="")) s spl="xx" ;aspon jedna je zahranicna
     }       
     
     
     ; if ((aup'="") && (pra'="")) d $$$addIDX("aupra",aup_"\s"_"\s"_pra,"bx")
     ; 13.10.06 jj; index aupra: autority bez ustavu a bez zeme nedostanou "XX"
     ; if (pra="") s pra="xx"
     if (aup'="") 
     {
       s sTerm=aup
       ; if (pra'="") 
       ; 20.04.14 tt; vypusteni dvou mezer z indexu aupra
       ;s sTerm=sTerm_"\s"_"\s"_pra
       s sTerm=sTerm_" "_pra
       d $$$addIDX("aupra",sTerm,"bx")
       
       ; 27.01.10 tt; pridana hodnota vazby z autorit (variantni nazev)
       s pra3=$$$getSubTagStr(sPart,"3") ; zjistime kod autority
       if pra3'="" 
       { ; pokud jsme ziskali kod autority
         s sA400aup="", sA400="", sA400x=""
         if ##class(MARC).readLX(.handlea3,pra3)
         { ; pokud se nam podarilo autoritu otevrit
           s sA400x=$$$getTagXC(.handlea3,"400",-1)
           f k=1:1:$l(sA400x,$c(10)) 
           { ; pres vsechny opakovani 400
             s sA400=$p(sA400x,$c(10),k)         ; vezmeme jedno opakovani  
             s sA400aup=..getXXX("ab"," ",sA400) ; nacteme podpole a a b
             if (sA400aup'="") 
             { ; pridana indexace
               ; 20.04.14 tt; vypusteni dvou mezer z indexu aupra 
               ;s sA400aup=$zcvt(sA400aup_"\s"_"\s"_pra,"L")
               s sA400aup=$zcvt(sA400aup_" "_pra,"L")
               d $$$addIDX("aupra",sA400aup,"bx")
             }
           }
         }
       }       
     }  
     
     d ..indexOddeleni(.handle,sPart)
     
     s sATym=$$$getSubTagStr(sPart,"w")
     if (sATym'="")
     { ; 30.01.15 tt; indexace tymu 70*w
       d $$$addIDX("ztym",sATym,"b")            ; pridat do indexu
     }     
   }
   ; 18.01.07 mk; pridany novy index spolupraca
   d $$$addIDX("spl",spl,"b")
 }
 
 ; ustav    
 s ustav=##class(MARC).getTagX(.handle,"c26e")
 ; 24.04.06 mk; zmena premennej v podmienke na ustav
 if ((ustav'="") && (aua'="")) { d $$$addIDX("praua",ustav_"\s"_"\s"_aua,"b")}
 ; 12.05.06 jj; oprava generovani
 ; if ((aup'="") && (pra'="")) { d $$$addIDX("aupra",aup_"\s"_"\s"_pra,"b")}
 
 ; 09.03.07 rs; podmienka pre vytvaranie xd1 zmenena aby sa vykonal pre XSZP
 ; 08.03.07 rs; nahrada indexu "itit" za "xd1"
 if $g(handle($$$MarcTmpNode,"dk"),"")="xszp"
 {
   s s010 = $$$getTagXC(.handle,"010",-1)

   if (s010'="")
   { ; 29.03.11 tt; zmena indexovani xd1 kvuli moznosti opakovatelnych isbn
     d ##class(MARC).mergeX(.handleISBN,.handle)
     for l=1:1:$l(s010,$c(10))
     { ; prejdeme pres vsechny isbn
       s s0101=$p(s010,$c(10),l)  
       d $$$setTagX(.handleISBN,s0101)
       s sXD1=..getDupCheckKey(.handleISBN)
       d:sXD1'="" $$$addIDX("xd1",sXD1,"b")
     }
   }
   else
   { ; puvodni verze
     s sXD1=..getDupCheckKey(.handle)
     d:sXD1'="" $$$addIDX("xd1",sXD1,"b")
   }   
 }

 ; 08.11.06 jj; rozsireni indexu isbn a issn o 463/010 a 463/011
 s s463=##class(MARC).getTagX(.handle,"463"),sT001463="",sClass4463=""
 if (s463'="") 
 { ; 25.03.11 tt; zmena indexovani isbn   
   /*
   s s463010=##class(MARC).getTag4xx(s463,"010")
   if (s463010'="") 
   { s s463010a=##class(MARC).getSubTagStr(.s463010,"a")
     if (s463010a'="") d $$$addIDX("isbn",s463010a,"b")
   }
   */
   ; 25.03.11 tt; doplnena podpora ISBN u 4xx
   d ##class(User.MARC).t4xx2handle(.h4xx, s463) 
   s sRes463010a1=$$$getTagXC(.h4xx,"010a",-1) //010a
   s sT001463=$$$HandleT001(h4xx)
   s sClass4463=$$$HandleClass(h4xx)       ; ziskani tridy

   for l=1:1:$l(sRes463010a1,$c(10))   
   {
     s s463010a=$p(sRes463010a1,$c(10),l)
     if (s463010a'="") d $$$addIDX("isbn",s463010a,"b")
     ; 24.10.13 tt; pridany index iskod (issn/isbn/ismn)
     s:(s463010a="n.") s463010a="n-tecka"
     if ((s463010a'="")&&(isIpac)) d $$$addIDX("iskod",s463010a,"b")
   }
   s s463011=##class(MARC).getTag4xx(s463,"011")
   if (s463011'="") 
   { s s463011a=$$$getSubTagStr(.s463011,"a")
     d:(s463011a'="") $$$addIDX("issn",s463011a,"b")
     ; 24.10.13 tt; pridany index iskod (issn/isbn/ismn)
     s:(s463011a="n.") s463011a="n-tecka"
     d:((s463011a'="")&&(isIpac)) $$$addIDX("iskod",s463011a,"b")
     
     ; 01.09.15 tt; pridana indexace eissn
     s s463011e=$$$getSubTagStr(.s463011,"e")
     s:(s463011e="n.") s463011e="n-tecka"
     d:(s463011e'="") $$$addIDX("issn",s463011e,"b")
     d:(s463011e'="") $$$addIDX("zeissn",s463011e,"b")
     d:((s463011e'="")&&(isIpac)) $$$addIDX("iskod",s463011e,"b")
   }
   s s463013=##class(MARC).getTag4xx(s463,"013")
   if (s463013'="") 
   { s s463013a=$$$getSubTagStr(.s463013,"a")
     ; 24.10.13 tt; pridany index iskod (issn/isbn/ismn)
     if ((s463013a'="")&&(isIpac)) d $$$addIDX("iskod",s463013a,"b")
   }
   
   if $f(",J,N,R,A2,B,C,D,G,H,I,K,M,R2,T2,T3,",$zcvt(","_t970b_",","U"))
   { ; 04.03.20 tt; pridana indexace vydavatele - index "emb" 463/210c
     s sRes463210c=$$$getTagXC(.h4xx,"210c",-1)
     for ll=1:1:$l(sRes463210c,$c(10))   
     {
       s sRes463210c1=$p(sRes463210c,$c(10),ll)  
       d:(sRes463210c1'="") $$$addIDX("emb",$zcvt(sRes463210c1,"L"),"b")        
     }
   }  
 }
 
 ; 12.09.07 mk pomocny index xgra na spojenie s autoritami projektov
 s tC12=$$$getTagXC(.handle,"c12",-1) 
 if (tC12'="")
 {
   s pocet=$l(tC12,$c(10))
   f m=1:1:pocet
   {
     s tC12s=$p(tC12,$c(10),m)  
     s ta=$$$getSubTagStr(tC12s,"a") 
     s t3=$$$getSubTagStr(tC12s,"3")
     s tb=$$$getSubTagStr(tC12s,"b")
     s:(tb'="") sGragD=sGragD_$c(10)_tb
     
     s td=$$$getSubTagStr(tC12s,"d")
     if (t3'="") 
     {
       d $$$addIDX("auk",t3,"b")
       ; 03.10.17 tt; pridana indexace programu z autority projektu (230b)
       if ##class(MARC).readLX(.handlePR3,t3)
       { ; pokud se nam podarilo autoritu otevrit
         s sA230b=$$$getTagX(.handlePR3,"230b")
         if ($l(sA230b)>2)
         { ; 06.02.19 tt; upravena podminka, aby se indexovaly projekty s delkou 3 a vice znaku - zprog
           d $$$addIDX("zprog",sA230b,"b")
         }          
       }    
     }
     ; 29.03.12 tt; pridano indexovani C21d tzv 
     d:(td'="") $$$addIDX("tzv",td,"b") 
     ; 
     ; 13.05.11 tt; presunuto odstraneni mezer do nahradni faze, aby se nejdrive
     ;              vyhledavaly projekty tak, jak jsou zapsane v zaznamech
     ; uprava provedena kvuli spatnemu provazani zaznamu na neplatne projekty
     s ta=##class(User.Util).strswap(ta," ","")     
     ;s nProjAuthID=$o(^ooDataTableI("CavUnAuth","proj"," "_$zcvt(ta,"L"),"")) 
     
     ;if ((ta'="")&&(nProjAuthID'=""))
     ;{ ; 18.02.11 tt; pridany odkaz na do auk pro projekty
     ;  s nProjAuthT001=##class(MARC).getT001(nProjAuthID)
     ;  ;d $$$addIDX("auk","cav_un_auth*"_nProjAuthT001,"b")       
     ;}    
     ;else
     ;{ ; 14.04.11 tt; uprava vytvareni indexu auk na autoritu projektu
     ;  s ta1=$e($$$getSubTagStr(tC12s,"a"),1,80) 
     ;  ; 13.05.11 tt; presunuto odstraneni mezer do nahradni faze, aby se nejdrive
     ;  ;              vyhledavaly projekty tak, jak jsou zapsane v zaznamech
     ;  s ta1=##class(User.Util).strswap(ta1," ","")
     ;  s nProjAuthID=$o(^ooDataTableI("CavUnAuth","proj"," "_$zcvt(ta1,"L"),"")) 
     ;  
     ;  if ((ta1'="")&&(nProjAuthID'=""))
     ;  { ; 18.02.11 tt; pridany odkaz na do auk pro projekty
     ;    s nProjAuthT001=##class(MARC).getT001(nProjAuthID)
     ;    ;d $$$addIDX("auk","cav_un_auth*"_nProjAuthT001,"b")       
     ;  }        
     ;}
     
     s s1="();:-/[].', "_$c(34)  
     s ta=$tr(ta,s1)
     s ta=$e(ta,1,80)
     d $$$addIDX("xgra",ta,"b")  

     ; 04.09.15 tt; pridana indexace poskytovatele
     s to=$$$getSubTagStr(tC12s,"o")
     if (to'="") 
     { 
       d $$$addIDX("grag",to,"b")
       s sGragD=sGragD_$c(10)_to
     }
   }
 }

 ; 15.11.06 jj; doplneni indexu dki a ust, zapojeni jako tridici pro i2 
 d $$$addIDX("ust",sC26e,"b")
 d $$$addIDX("dki",t970b,"b")
 
 ; 02.06.16 tt; droba uprava indexace dki - vyuziva se i pro trideni
 d:(t970b="") $$$addIDX("dki","xxxxxx","b")
 ; 02.09.14 lo; odstraneny tridici indexy
 ; 13.11.06 jj; zapojeni tridicich indexu pro I2
 ;d ##class(SPIndex).ixAddSortIndexX(.handle,"spra","pra")
 ;d ##class(SPIndex).ixAddSortIndexX(.handle,"simp","imp",4)
 ;d ##class(SPIndex).ixAddSortIndexX(.handle,"sau1","au1")
 ;d ##class(SPIndex).ixAddSortIndexX(.handle,"sdki","dki")
 ;d ##class(SPIndex).ixAddSortIndexX(.handle,"sust","ust")
 
 ; 02.06.10 tt; zalozen novy tridici index dle prvního autora z ústavu AV
 s s70x=##class(MARC).getTagX(.handle,"70*",-1)
 s nCnt70X=$l(s70x,$c(10)),ret=""
 ; pro vsechny oddeleni
 f i7=1:1:nCnt70X
 { ; zoberieme jedno
   s s70x1=$p(s70x,$c(10),i7) 
   s s70xp=$$$getSubTagStr(s70x1,"p") ; ustav
   s s70xa=$$$getSubTagStr(s70x1,"a") ; prijmeni
   s s70xb=$$$getSubTagStr(s70x1,"b") ; jmeno
   if (s70xp'="")
   { ; pokud mame vypleneny ustav
     ;s sAuSort=s70xa_" "_s70xb_" "_s70xp_" "_t200a
     s sAuSort=s70xa_" "_s70xb_" "_t200a
     d $$$addIDX("app",sAuSort,"b")   ; pridame normalni index
     d ##class(SPIndex).ixSetSortIndexX(.handle,"sapp",sAuSort) ; pridame sortovaci index
     q ; mame zaindexovano, muzeme ukoncit for
   }
 }
 
 ; 30.12.11 tt; pridana indexace C52
 s c=0
 d {
   s sTC52=$$$getTagXC(.handle,"c52",.c) ; vsetky citacie
   continue:((sTC52="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sTC52'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     for ij=2:1:$l(sTC52,$c(31))
     { ; cyklime pres vsechny subtagy
       s sTC52ST=$p(sTC52,$c(31),ij)     ; ziskame jednu hodnotu
       s sTC52ST1=$e(sTC52ST,1),$e(sTC52ST,1)=""   ; subtag
       ; 07.10.12 tt; pridana indexace C52$c=nusl
       if ((sTC52ST1="c")&&(sTC52ST="nusl"))
       { ; pokud mame st=c a hodnotu NUSL, zaindexujeme hodnotu N
         d $$$addIDX("ups","n","b")    
       }
       if ((sTC52ST1="c")&&(sTC52ST="sml"))
       { ; /// 01.03.19 tt; pridan priznak pro smlouvu - specialni typ
          d $$$addIDX("zsml","a","b")
       }
       if (sTC52ST1="a")
       { ; indexujeme subtagy a 
         ; 04.06.14 tt; vypustena indexace ups s hodnotou 4 pro stav archiv
         if (sTC52ST="4")
         { ; pokud je jen stav archiv, nebude se indexovat stav 4
           ; aby se nenasli zaznamy a archivem v ipacu          
           ; 02.12.19 tt; upravena funkcnost ups, aby se filtrovala hodnota 4 pro archiv
           s bFilterUps=..FilterUps(.handle)  
           d:(bFilterUps) $$$addIDX("ups",sTC52ST,"b")  ; ulozime si hodnotu, kterou mame v subtagu
         }
         elseif (sTC52ST'="4")
         {
           d $$$addIDX("ups",sTC52ST,"b")  ; ulozime si hodnotu, kterou mame v subtagu
         }          
       }
       if (sTC52ST1="b")
       { ; indexujeme subtagy b
         d $$$addIDX("ups",sTC52ST,"b")  ; ulozime si hodnotu, kterou mame v subtagu
       }
     }
   }
 } while (c'=0)
 
 ; 16.08.12 tt; pridana indexace C58a a 463/C58a
 s c=0
 d {
   s sTC58=$$$getTagXC(.handle,"c58",.c) ; vsetky citacie
   continue:((sTC58="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sTC58'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     for ij=2:1:$l(sTC58,$c(31))
     { ; cyklime pres vsechny subtagy
       s sTC58ST=$p(sTC58,$c(31),ij)     ; ziskame jednu hodnotu
       s sTC58ST1=$e(sTC58ST,1),$e(sTC58ST,1)=""   ; subtag
       if (sTC58ST1="a")
       { ; indexujeme subtagy a a b
         d $$$addIDX("emb",sTC58ST,"b")  ; ulozime si hodnotu, kterou mame v subtagu
       }
     }
   }
 } while (c'=0)
 if (($g(sT001463,"")'="")&&($g(sT001463,"")'=""))
 { ; pokud mame 463
   if ##class(User.MARC).readX(.handleP463,sClass4463,sT001463) 
   { ; nacteme z handlu 978c
     s c=0
     d {
       s sTC58=$$$getTagXC(.handleP463,"C58",.c) ; vsetky citacie
       continue:((sTC58="")&&(c'=0))         ; musime mit hodnotu na zpracovani
       if (sTC58'="")
       { ; pokud mame vyplnene data, muzeme provadet akce 
         for ij=2:1:$l(sTC58,$c(31))
         { ; cyklime pres vsechny subtagy
           s sTC58ST=$p(sTC58,$c(31),ij)     ; ziskame jednu hodnotu
           s sTC58ST1=$e(sTC58ST,1),$e(sTC58ST,1)=""   ; subtag
           if (sTC58ST1="a")
           { ; indexujeme subtagy a a b
             d $$$addIDX("emb",$zcvt(sTC58ST,"L"),"b")  ; ulozime si hodnotu, kterou mame v subtagu
           }
         }
       }
    } while (c'=0) 
   } 
 } 
 
 ; 31.05.12 tt; pridan index rdn pro sortovani podle roku, druhu a nazvu
 ; 1. 210$d  - Rok vydani - bude reseno jiz existujici funkcnosti
 s sT970b=$zcvt($$$getTagX(.handle,"970b"),"U")   ; nactu si druh dokumentu
 s sTT16c=$$$getTagX(.handle,"T16c")              ; ziskami generovani IF
 if ((sT970b="J")&&(sTT16c="")&&($g(sT001463,"")'="")&&($g(sT001463,"")'=""))
 { ; pokud T16 je prazdne, zkusime jeste 463
   if ##class(User.MARC).readX(.handleP463,sClass4463,sT001463) 
   { ; nacteme z handlu 978c
     s sTT16c=$$$getTagX(.handleP463,"978c")     
   } 
 }

 s:((sT970b="J")&&(sTT16c'="")) sT970b="IFJ"
 s sPom970b=$SELECT(sT970b="B":"00",       ; 1. knihy                    970$b = B  
                    sT970b="M":"01",       ; 2. kapitoly                 970$b = M 
                    sT970b="IFJ":"02",     ; 3. casopisy                 970$b = J 
                    sT970b="J":"03",       ;(nejdrive ty, které obsahuji jakykoli IF) - zobrazeni IF ponechat
                    sT970b="C":"04",       ; 4. mezinarodni konference    970$b = C 
                    sT970b="K":"05",       ; 5. národní konference       970$b = K
                    sT970b="G":"06",       ; 6 editorství sborníku        970$b = G nebo H
                    sT970b="H":"06",
                    sT970b="A1":"08",      ; 7. abstrakta               970$b = A1 nebo A2
                    sT970b="A2":"08",  
                    sT970b="A":"08",     
                    sT970b="V":"10",       ; 8. výzkumné zpravy         970$b = V
                    sT970b="R":"11",       ; 9. zbytek v poradi         970$b = R, T, P, L, Z, E, D, I, N 
                    sT970b="R1":"11",
                    sT970b="T":"12", sT970b="P":"13", sT970b="P1":"13", sT970b="L":"14", sT970b="L1":"14", sT970b="L2":"14", sT970b="L3":"14",
                    sT970b="L4":"14", sT970b="Z":"15", sT970b="E":"16",
                    sT970b="D":"17", sT970b="I":"18", sT970b="N":"19",
                    1:"20")                ; kdyby jeste nahodou neco, necham 20
 s sT200a=$$$getTagX(.handle,"200a")       ; nazev
 s sRDN=$e(sPom970b_sT200a,1,90)  ; vytvorime si vyledny retezec pro index
  
 d $$$addIDX("rdn",sRDN,"b")               ; pridame normalni index
 d ##class(SPIndex).ixSetSortIndexX(.handle,"srdn",sRDN) ; pridame sortovasi index
 
 s c=0,bRVO=0
 d { ; 12.06.12 tt; pridana indexace C57 (rvo)
   s sTC57=$$$getTagXC(.handle,"c57",.c) ; vsetky opakovani
   continue:((sTC57="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sTC57'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTC57a=$$$getSubTagStr(sTC57,"a") ; prijmeni
     d $$$addIDX("rvo",sTC57a,"b")  ; ulozime si hodnotu, kterou mame v subtagu    
     d:(bRVO=0) $$$addIDX("zrvosl",sTC57a,"b")  ; ulozime si hodnotu, kterou mame v subtagu    
     s bRVO=1
   }
 } while (c'=0)
 
 ; 28.08.12 tt; pridana podpora indexace akademie ved podle C57 (RVO)
 if ($$$getTagX(.handle,"c57")'="")
 {
   if ($zcvt(sC26e,"L")="nhu-c") 
   { 
     d $$$addIDX("grag",$zcvt("GA MŠk","L"),"b")
     s sGragD=sGragD_$c(10)_$zcvt("GA MŠk","L")
   }
   else 
   { 
     d $$$addIDX("grag",$zcvt("GA AV ČR","L"),"b")
     s sGragD=sGragD_$c(10)_$zcvt("GA AV ČR","L")
   }
 }
 
 if ($$$getTagX(.handle,"c90")'="")
 { ; 18.04.23 tt; pridana podpora indexace akademie ved podle C90
   d $$$addIDX("grag",$zcvt("GA AV ČR","L"),"b")
   s sGragD=sGragD_$c(10)_$zcvt("GA AV ČR","L")
 }
 
 ; 12.06.13 tt; pridana indexace do zaznamu ID autoru
 s c=0
 d {
   s sT70X=$$$getTagXC(.handle,"70*",.c) ; vsetky citacie
   continue:((sT70X="")&&(c'=0))         ; musime mit hodnotu na zpracovani
   if (sT70X'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
    
     s sT70X3=$$$getSubTagStr(sT70X,"3") ; zjistime kod autority
     if (sT70X3'="")
     { ; pokud jsme ziskali kod autority
       if ##class(User.MARC).readLX(.handlea3,sT70X3)
       { ; pokud se nam podarilo autoritu otevrit
         s sA035x=$$$getTagXC(.handlea3,"035",-1)
         f k=1:1:$l(sA035x,$c(10))                  ; cyklus pres vsechny opakovani
         { ; pres vsechny opakovani 400
           s sA035x1=$p(sA035x,$c(10),k)            ; vezmeme jedno opakovani  
           s sA035x1a=$$$getSubTagStr(sA035x1,"a")  ; ziskame kod
           d:(sA035x1a'="") $$$addIDX("ida",sA035x1a,"b") ; pridame do indexu
         }
       }
     }  
   }
 } while (c'=0) 
 
 // 01.11.13 tt; pridana spolupracujici instituce do indexu
 s c=0
   d {
     s sTC63=$$$getTagXC(.handle,"c63",.c) ; vsetky instituce
     continue:((sTC63="")&&(c'=0))         ; musime mit hodnotu na zpracovani
     if (sTC63'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC633=$$$getSubTagStr(sTC63,"3")
       d:(sTC633'="") $$$addIDX("auk",sTC633,"b")
     }
   } while (c'=0)
 
 
 if (($g(handle($$$MarcTmpNode,"dk"),"")'="xszp")&&(isIpac))
 {
   //////////////////////////////////
   // Indexujeme pouze hodnoty viditelne v ipacu - nesmi byt xszp a 969f '= D
   //////////////////////////////////
   ; 24.10.13 tt; pridany index iskod (issn/isbn/ismn)
   s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
   f i=1:1:nC 
   { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
     s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
     s sTag=$e(lsLine,1,3)
     if ((sTag="010")||(sTag="011"))
     {
       s ta=$$$getSubTagStr(lsLine,"a") 
       s:(ta="n.") ta="n-tecka"
       d:(ta'="") $$$addIDX("iskod",ta,"b")
       s tz=$$$getSubTagStr(lsLine,"z") 
       d:(tz'="") $$$addIDX("iskod",tz,"b")
       s:(sTag="011") ty=$$$getSubTagStr(lsLine,"y") 
       d:((sTag="011")&&(ty'="")) $$$addIDX("iskod",ty,"b")      
       if (sTag="011")
       { ; 01.09.15 tt; pridana indexace eissn
         s te = $$$getSubTagStr(lsLine,"e") 
         if (te'="")
         {
           d $$$addIDX("zeissn",te,"b")
           d $$$addIDX("iskod",te,"b")
         }     
       } 
     }
     if (sTag="013")
     {
       s ta=$$$getSubTagStr(lsLine,"a") 
       d:(ta'="") $$$addIDX("iskod",ta,"b")
     }     
   }   
   
   s c=0
   d {
     s sTC63=$$$getTagXC(.handle,"c63",.c) ; vsetky instituce
     continue:((sTC63="")&&(c'=0))         ; musime mit hodnotu na zpracovani
     ; 21.10.13 tt; upraveno indexovani C63
     if (sTC63'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC63a=$$$getSubTagStr(sTC63,"a")
       s sTC633=$$$getSubTagStr(sTC63,"3")
       s sTC63b=$$$getSubTagStr(sTC63,"b")
       s sC631e=$$$getSubTagStr(sTC63,"e")
       s sSpi63=""
       s:(sTC63b'="") sSpi63=sTC63b
       s:(sC631e'="") sSpi63=sSpi63_" ("_sC631e_")"
       d:(sTC63b'="") $$$addIDX("spi",sSpi63,"b")
       /* ; 06.06.13 tt; pridany jeste nazev instituce do indexu spi
       if ##class(User.MARC).readLX(.handleaC63,sTC633)
       { ; pokud se nam podarilo autoritu otevrit
         s sA210a=$$$getTagX(.handleaC63,"210a")
         d:(sA210a'="") $$$addIDX("spi",sA210a,"bx")
       }   */
     }
   } while (c'=0)
 }
 
 ; 01.04.14 tt; pridan index pro odmazavani zanamu z RIVu
 s c=0
 d { ; cyklus pres vsechny opakovani C51
    s sTC51=$$$getTagXC(.handle,"c51",.c) ; pres vsechny opakovani tagu C51
    continue:((sTC51="")&&(c'=0))         ; preskocim, pokud nemam data
    if (sTC51'="")
    { ; zaindexujeme g
      s sTC51g=$$$getSubTagStr(sTC51,"g")
      d:(sTC51g'="") $$$addIDX("pradl",sTC51g,"b")
      
      s sTC51a=$zcvt($$$getSubTagStr(sTC51,"a"),"L")
      if (sTC51a'="")
      {
        s sGragD=$zcvt(sGragD,"L") ; prevedema na mala pismena
        for ii=1:1:$l(sGragD,$c(10))
        { ; 26.03.16 tt; pridana promenna pro indexaci poskytovatelu, kteri jsou pouziti ve vymazavani RIV C51 a indexace
          s sGragD1O=$p(sGragD,$c(10),ii)
          s sGragD1=$zcvt(##class(User.Util).sXlate("EPC_POSKYTOVATEL_CEP",sGragD1O,"L","Cav","c"),"U")
          continue:((sGragD1="")||(sGragD1O=""))
          if ($f(sTC51a,$zcvt("-"_sGragD1_"-","L"))||$f(sTC51a,$zcvt("/"_sGragD1_"/","L")))
          { ; pokud nalezneme poskytovatele ve C51a zaindexujeme
            d $$$addIDX("gragd",sGragD1O,"b")
          }
        }
      }     
    }
  } while (c'=0)
  
  
  ; 17.05.17 tt; pridan index RIVOPR
  s c=0
  d { ; cyklus pres vsechny opakovani C51
    s sTC83=$$$getTagXC(.handle,"c83",.c) ; pres vsechny opakovani tagu C51
    continue:((sTC83="")&&(c'=0))         ; preskocim, pokud nemam data
    if (sTC83'="")
    { ; zaindexujeme g
      s sTC83d=$$$getSubTagStr(sTC83,"d")
      d:(sTC83d'="") $$$addIDX("praopr",sTC83d,"b")
      
      s sTC83f=$$$getSubTagStr(sTC83,"f")
      d:(sTC83f'="") $$$addIDX("rivopr",sTC83f,"b")     
      
      s sTC83a=$zcvt($$$getSubTagStr(sTC83,"a"),"L")
      if (sTC83a'="")
      {
        s sGragD=$zcvt(sGragD,"L") ; prevedema na mala pismena
        for iia=1:1:$l(sGragD,$c(10))
        { ; 10.04.19 tt; pridana promenna pro indexaci poskytovatelu, kteri jsou pouziti ve opravach pro RIV C83 a indexace
          s sGragD1O=$p(sGragD,$c(10),iia)
          s sGragD1=$zcvt(##class(User.Util).sXlate("EPC_POSKYTOVATEL_CEP",sGragD1O,"L","Cav","c"),"U")
          continue:((sGragD1="")||(sGragD1O=""))
          if ($f(sTC83a,$zcvt("-"_sGragD1_"-","L"))||$f(sTC83a,$zcvt("/"_sGragD1_"/","L")))
          { ; pokud nalezneme poskytovatele ve C51a zaindexujeme
            d $$$addIDX("gragopr",sGragD1O,"b")
          }
        }
      }     
      
    }
  } while (c'=0)
    
  ; 03.09.15 tt; pridana indexace ZOAIR
  ; 08.09.15 tt; upravena indexace zoai
  ; https://cosmo2/wiki/index.php/Cust:CAV/OAI_pro_OpenAire
  ///ds %db% dk = b~c~k~m~j~v~p$$ds && !ups = 4$$ds && !ups = o~r~e$$ds && '!ds = d~n$$edt,1$$foai_dc$$z20050623112555
  s s969f=$$$getTagX(.handle,"969f")
  s sC52=$$$getTagX(.handle,"c52")
  s sC52b=##class(User.MARC).getSubTagStr(sC52,"b",-1)
  s sC26b=$$$getTagX(.handle,"c26b")
  s s970boai=$$$getTagX(.handle,"970b")
  
  ; 06.06.18 tt; upraveny podminky pro vyhodnoceni openaire
  ; podminka, aby se vubec vytvoril index
  if ($f("bckmjvp",$e(s970boai,1))&&(s969f'="d")&&(s969f'="n")&&(s970boai'="P1")
      &&($f(sC52,($c(31)_"a4")))
      &&(sC26b=1)&&($zcvt(sC26e,"L")'="nhu-c"))
  {
    s sHodUpsOp="", bHodUpsOp=0
    d { ; kontrola na hodnotu zaznamu ups index =4
      s sHodUpsOp=##class(User.MARC).getIdxVal("CavUnEpca",lnId,"ups",sHodUpsOp)
      continue:(sHodUpsOp="")
      s:(sHodUpsOp=" 4") bHodUpsOp=1
    } while (sHodUpsOp'="")
    d:(bHodUpsOp=1) $$$addIDX("zoai","openaire","b")    
  }
 
  ; 21.03.18 tt; pridana indexace OECD ciselniku 
  s tc26x=$$$getTagX(.handle,"c26x")  ; EPCA_OECD
  s tc26y=$$$getTagX(.handle,"c26y")   ; EPCA_OECDALL_2
  s tc26z=$$$getTagX(.handle,"c26z") ; EPCA_OECDALL_3
  ; 02.01.19 tt; provedena uprava indexace oecd pro C26
  if (tc26z'="") 
  { 
    s tc26z=tc26z_" - "_##class(User.Util).sXlate("EPCA_OECDALL",tc26z,,"Cav")
    d $$$addIDX("zoecd",tc26z,"b")
    d:($p(tc26z," - ",2)'="") $$$addIDX("zoecd",$p(tc26z," - ",2),"b")
  }
  if (tc26y'="")  
  {  
    s tc26y=tc26y_" - "_##class(User.Util).sXlate("EPCA_OECDALL",tc26y,,"Cav") 
    d $$$addIDX("zoecd",tc26y,"b")
    d:($p(tc26y," - ",2)'="") $$$addIDX("zoecd",$p(tc26y," - ",2),"b")
  }
  if (tc26x'="")  
  {   
    s tc26x=tc26x_" - "_##class(User.Util).sXlate("EPCA_OECDALL",tc26x,,"Cav") 
    d:($p(tc26x," - ",2)'="") $$$addIDX("zoecd",$p(tc26x," - ",2),"b")
    d $$$addIDX("zoecd",tc26x,"b")
  }
  
  s c=0
  d {
     s sTC47=$$$getTagXC(.handle,"c47",.c) ; vsechny spoluprace
     continue:((sTC47="")&&(c'=0))         ; pokud nemam data pokracuji
     if (sTC47'="") 
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC47b=$$$getSubTagStr(sTC47,"b")
       s sTC47c=$$$getSubTagStr(sTC47,"c")
       s sTC47d=$$$getSubTagStr(sTC47,"d")
       if (sTC47b'="") 
       { 
         s sTC47b=sTC47b_" - "_##class(User.Util).sXlate("EPCA_OECDALL",sTC47b,,"Cav")
         d:($p(sTC47b," - ",2)'="") $$$addIDX("zoecd",$p(sTC47b," - ",2),"b")
         d $$$addIDX("zoecd",sTC47b,"b")
       }
       if (sTC47c'="")  
       {  
         s sTC47c=sTC47c_" - "_##class(User.Util).sXlate("EPCA_OECDALL",sTC47c,,"Cav") 
         d:($p(sTC47c," - ",2)'="") $$$addIDX("zoecd",$p(sTC47c," - ",2),"b")
         d $$$addIDX("zoecd",sTC47c,"b")
       }
       if (sTC47d'="")  
       {   
         s sTC47d=sTC47d_" - "_##class(User.Util).sXlate("EPCA_OECDALL",sTC47d,,"Cav") 
         d:($p(sTC47d," - ",2)'="") $$$addIDX("zoecd",$p(sTC47d," - ",2),"b")
         d $$$addIDX("zoecd",sTC47d,"b")
       }       
     }
   } while (c'=0)
   
   s c=0
   d { ; 02.02.19 tt; pridana indexace smluv
     s sTC70=$$$getTagXC(.handle,"c70",.c) ; vsechny smlouvy
     continue:((sTC70="")&&(c'=0))         ; pokud nemam data pokracuji
     if (sTC70'="") 
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC70a=$$$getSubTagStr(sTC70,"a")
       ; priznak, ze existuje smlouva 
       d $$$addIDX("zsml","a","b")

       if (sTC70a'="") 
       { ; indexujeme nazev a priznak, ze exituje smlouva
         d $$$addIDX("zsmln",sTC70a,"b")
       }    
     }
   } while (c'=0)
 
   ; 14.08.19 tt; kopie indexu grag
   d ##class(SPIndex).ixCopyIndex(pnGIdx,.handle,"grag","zgrag")
]]></Implementation>
</Method>

<Method name="FilterUps">
<Description><![CDATA[
<pre> symbolik pro urceni, jestli se ma indexovat hodnota 4

02.12.19 tt; zalozena metoda kvuli problemum s archivem
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret=0
  s sT001=$$$HandleT001(handle)                ; ziskame si T001 zaznamu
  s sClass=$$$HandleClass(handle)              ; ziskame tridu zaznamu

  ; ziskame vsechny data k zaznamu v output
  d ##class(content.api).selectRecAll(.output,sClass,sT001)
    
  ; prochazime postupne cyklem vsech polozek k zaznamu
  s item="",sSTm=""     ; jedna polozka k zaznamu
  f { 
    s item=$o(output(item)) q:item=""
    s repo=output(item,"repository")   ; ziskame repository
    s key=output(item,"key")           ; klice
    ; nacteme delsi pomocna data k jednomu zaznamu
    
    d ##class(content.api).getBatch(.array,repo,key)         ; ziskame informace z array    
    s sSTa="", sSTb="", sSTc=""
    s sSTb=$c(31)_"b"_array("accession")                     ; nacteme si postupne data
    s sSTa=$c(31)_"a"_array("status")
    
    continue:(sSTa'=($c(31)_"a4"))
    s:((sSTa=($c(31)_"a4"))&&(sSTb'=($c(31)_"bA"))) ret=1
  } ; konec cyklu prochazeni souboru k zaznamu
  
  q ret
]]></Implementation>
</Method>

<Method name="indexNeodeslane">
<Description><![CDATA[
<pre> Indexacni metoda pro nenavazane zaznamy + uzivatelskeho vlastnika

11.01.17 tt; indexace neodeslanych zaznamu zaznamu do ipacu pro specialni ucely
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s lsClass=$$$HandleClass(handle),lnId=##class(MARC).recordIdX(.handle), sT001=$$$HandleT001(handle)
 s sLName=##class(User.Util).objectName2lname(lsClass)
 
  s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3)
    
    if ($e(sTag,1)="4")   
    {
      s lt001=##class(User.MARC).getTag4xx(lsLine,"001")
      s lt001=$e(lt001,8,999)
      d:($f(lt001,"cav_")) $$$addIDX("znnz",lt001,"b")
      d:($f(lt001,"cav_")) $$$addIDX("znnz",$tr(lt001,"*"),"b")
    }
    else
    {
      s sST3=$$$getSubTagStr(lsLine,"3")
      d:($f(sST3,"cav_")) $$$addIDX("znnz",sST3,"b")
      d:($f(sST3,"cav_")) $$$addIDX("znnz",$tr(sST3,"*"),"b")
    }    
  }
]]></Implementation>
</Method>

<Method name="indexOddeleni">
<Description><![CDATA[
<pre> Indexacni metoda oddeleni v 70*
parametry: handle - aktualni zpracovavany handle
           sLine  - aktualni zpracovavany radek autoru

14.09.19 tt; zalozena indexacni metoda kvuli velkemu poctu udaju oddeleni
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,sLine=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s lsClass=$$$HandleClass(handle),lnId=##class(MARC).recordIdX(.handle), sT001=$$$HandleT001(handle)
 s sLName=##class(User.Util).objectName2lname(lsClass)
 
 ; 02.08.06 lp; pridany index pro oddeleni pracoviste autora
 s oddp=$$$getSubTagStr(sLine,"o")
 ; 10.10.07 mk; doplnenie do indexu pracovisko
 ; 29.01.08 rs; uprava algoritmu pre index oddp - prefix pracoviska sa pridava vzdy
 s sUstav=$$$getSubTagStr(sLine,"p") ; znova vyhodnotit, aby nebralo $y
 s sCavNUstav=##class(User.Util).sXlate("CAV_PRA",$zcvt(sUstav,"U"),"N","Cav")
 s sUstavPrefAJ=##class(User.Util).sXlate("CAV_PRA",$zcvt(sUstav,"U"),"N","Cav","d")
 s sUstavPref=$p(sCavNUstav,"-",1)              ; prva cast pracoviska
 if ((oddp'="")&&(sUstavPref'=""))
 { ; 03.01.24 tt; odstraneno indexovani 70xo 
   ; 26.06.29 tt; Vyhledávání podle oddělení autora v IPAC - podle pripominky indexovat vsechna slova, 
   ;              uzivatele neznaji presne nazev oddeleni   
   ; 06.06.16 tt; uprava indexu oddeleni, i bez prefixu
   ; 01.07.19 tt; pridan index pro vyhledavani v ipacu se vsemy slovy oddpi -odvozeny z oddp
   d $$$addIDX("oddp",oddp,"b")            ; pridat do indexu
   //d $$$addIDX("zoddp",oddp,"bx")          ; pridat do indexu
   s oddp=sUstavPref_"-"_oddp              ; oddlenie s prefixom pracoviska
   d $$$addIDX("oddp",oddp,"b")            ; pridat do indexu
   //d $$$addIDX("zoddp",oddp,"bx")          ; pridat do indexu
 }
 
 s oddpi=$$$getSubTagStr(sLine,"i")         ; Oddělení autora v CZE
 if (oddpi'="")
 { ; cesky nazev oddeleni indexujeme do spolecneho indexu + ceskou zkratku oddeleni
   d $$$addIDX("oddp",oddpi,"b")            ; pridat do indexu
   d:(sUstavPref'="") $$$addIDX("oddp",(sUstavPref_"-"_oddpi),"b")
   /*d $$$addIDX("zoddc",oddpi,"b")           ; pridat do indexu
   d:(sUstavPref'="") $$$addIDX("zoddc",(sUstavPref_"-"_oddpi),"b") */     
 }
 
 s oddpj=$$$getSubTagStr(sLine,"j")         ; Oddělení autora v ENG
 if (oddpj'="")
 { ; anglicky nazev oddeleni indexujeme do spolecneho indexu + anglickou zkratku oddeleni
   d $$$addIDX("oddp",oddpj,"b")            ; pridat do indexu
   d:(sUstavPrefAJ'="") $$$addIDX("oddp",(sUstavPrefAJ_"-"_oddpj),"b")
   /*d $$$addIDX("zodda",oddpj,"b")           ; pridat do indexu
   d:(sUstavPrefAJ'="") $$$addIDX("zodda",(sUstavPrefAJ_"-"_oddpj),"b")  */    
 }
 
 s oddpk=$$$getSubTagStr(sLine,"k")         ; Zkratka oddělení v CZE
 if (oddpk'="")
 { ; ceskou zkratku oddeleni indexujeme do spolecneho indexu oddeleni + cesky prefix
   d $$$addIDX("oddp",oddpk,"b")            ; pridat do indexu
   d:(sUstavPref'="") $$$addIDX("oddp",(sUstavPref_"-"_oddpk),"b")
 }

 s oddpl=$$$getSubTagStr(sLine,"l")         ; Zkratka oddělení v ENG
 if (oddpl'="")
 { ; anglickou zkratku oddeleni indexujeme do spolecneho indexu oddeleni + anglicky prefix
   d $$$addIDX("oddp",oddpl,"b")            ; pridat do indexu
   d:(sUstavPrefAJ'="") $$$addIDX("oddp",(sUstavPrefAJ_"-"_oddpl),"b")
 }
]]></Implementation>
</Method>

<Method name="indexHodnoceniAV">
<Description><![CDATA[
<pre> Metoda pro vytvoreni indexu zhod - specialni index pro zpracovatele, aby se jim
vypsali linky do stranky MyAsep pro kontrolu hodnoceni

06.12.14 tt; pridana hodnota bnpft k indexu zhod
10.11.14 tt; upravena logika dle upresneni CAV pro index zhod
06.11.14 tt; zalozena metoda 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
  s lsClass=##class(MARC).recordClassX(.handle),lnId=##class(MARC).recordIdX(.handle)
  s sT970b=$$$getTagX(.handle,"970b")
  s sT001=$$$HandleT001(handle)                ; ziskame si T001 zaznamu
  s sClass=$$$HandleClass(handle)              ; ziskame tridu zaznamu
  s sC26c=$$$getTagX(.handle,"c26c")
  q:(sC26c'=1)

  s c=0, bRecHod=0
  d {
    s sTC64=$$$getTagXC(.handle,"c64",.c) ; projdeme vsechny pole C64
    continue:((sTC64="")&&(c'=0))
    if (sTC64'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sTC64a=$$$getSubTagStr(sTC64,"a")  ; ziskame priznak hodnoceni
      s:(sTC64a="1") bRecHod=1              ; ulozime si preznak zaznamu k hodnoceni 
    }
  } while (c'=0)
  
  ; 26.02.20 tt; provedena zmena indexovani zhod - kvuli hodnoceni 2020
  if (bRecHod=1)
  {
    d $$$addIDX("zhod","allRecHod","b")  
      
    s c=0
    d {
      s sT971=$$$getTagXC(.handle,"971",.c) ; projdeme vsechny pole 971
      continue:((sT971="")&&(c'=0))
      if (sT971'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sT9719=$$$getSubTagStr(sT971,"9")  ; ziskame priznak hodnoceni
        ; zaindexujeme si priznak hodnoceni citace
        d:(sT9719="1") $$$addIDX("zhod","ocithod","b")     
      }
    } while (c'=0)
    
    s c=0
    d {
      s sTC71=$$$getTagXC(.handle,"c71",.c) ; projdeme vsechny pole c71
      continue:((sTC71="")&&(c'=0))
      if (sTC71'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC719=$$$getSubTagStr(sTC71,"9")  ; ziskame priznak hodnoceni
        ; zaindexujeme si priznak hodnoceni citace
        d:(sTC719="1") $$$addIDX("zhod","orechod","b")     
      }
    } while (c'=0)
  }
  
  if (bRecHod=1)
  { ; pokud mame zaznam vybrany k hodnoceni
    ; inicializace promennych
    s bFT=0,bFTOzn=0,bFTNeozn=0,bFTRecOzn=0,nFTRec=0,bFTRecNeoz=0

    ; ziskame vsechny data k zaznamu v output
    d ##class(content.api).selectRecAll(.output,sClass,sT001)
    
    ; prochazime postupne cyklem vsech polozek k zaznamu
    s item=""      ; jedna polozka k zaznamu
    f { 
      s item=$o(output(item)) q:item=""
      s repo=output(item,"repository")   ; ziskame repository
      s key=output(item,"key")           ; klice
      ; nacteme delsi pomocna data k jednomu zaznamu
    
      d ##class(content.api).getBatch(.array,repo,key)         ; ziskame informace z array    
      s bFT=1   ; oznaceni, ze mame prilozeny fulltext
      /*  Záznamy vybrané k hodnocení s označeným plným textem                  - hod
          Záznamy vybrané k hodnocení s připojeným neoznačeným plným textem     - c52 bez hod
          Záznamy vybrané k hodnocení s označenými více jak pěti recenzemi
          Záznamy vybrané k hodnocení s připojeným neoznačenými recenzemi
          Všechny záznamy vybrané k hodnocení bez připojeného plného textu
          Záznamy vybrané k hodnocení (druh J, B, M, C, K) – bez připojeného plného textu   */
      if (($g(array("hodnoceni"),"")="true")&&($g(array("recenze"),"")="true"))
      { ; fulltext je oznacen a ma recenzi
        s nFTRec=nFTRec+1   ; nacitani recenzi  
        s bFTRecOzn=1
      } 
      elseif ($g(array("recenze"),"")="true") 
      { ; mame neoznacenou recenzi
        s bFTRecNeoz=1
      }
      elseif ($g(array("hodnoceni"),"")="true") 
      { ; fulltext oznacen k hodnoceni
        s bFTOzn=1
      }
      else
      { ; fultext neni ani recenze, ani oznaceny
        s bFTNeozn=1
      }     

      if ($g(array("version"),"")="SML")
      { ; 09.02.19 tt; pridana indexace smlouvy
        d $$$addIDX("zsml","a","b")
      }   
    } ; konec cyklu prochazeni souboru k zaznamu

    ; Záznamy vybrané k hodnocení s označeným plným textem  - apon jeden oznaceny                
    d:(bFTOzn=1) $$$addIDX("zhod","oft","b")
    ; Záznamy vybrané k hodnocení s připojeným neoznačeným plným textem - zadny neoznaceny    
    d:((bFTNeozn=1)&&(bFTOzn=0)) $$$addIDX("zhod","nft","b")    
    ; Záznamy vybrané k hodnocení s označenými více jak pěti recenzemi
    d:(nFTRec>5) $$$addIDX("zhod","orp","b")
    ; 03.04.15 tt; pridane do indexu zhod - Záznamy vybrané k hodnocení s recenzemi
    ; Záznamy vybrané k hodnocení s recenzemi
    d:(nFTRec>0) $$$addIDX("zhod","orecp","b")
    ; Záznamy vybrané k hodnocení s připojeným neoznačenými recenzemi
    d:(bFTRecNeoz=1) $$$addIDX("zhod","nr","b")
    ; Všechny záznamy vybrané k hodnocení bez připojeného plného textu
    d:((bFTOzn=0)&&(bFTNeozn=0)) $$$addIDX("zhod","bpft","b")
    ; 06.12.14 tt; pridana hodnota bnpft k indexu zhod
    ; Všechny záznamy vybrané k hodnocení bez označeného nebo bez připojeného plného textu
    d:((bFTOzn=0)) $$$addIDX("zhod","bnpft","b")
    if ((bFTOzn=0)&&(bFTNeozn=0)&&((sT970b="J")||(sT970b="B")||(sT970b="M")||(sT970b="C")||(sT970b="K"))) 
    { ; Záznamy vybrané k hodnocení (druh J, B, M, C, K) – bez připojeného plného textu
      d $$$addIDX("zhod","bpdd","b")
    }    
    ; pridana indexace nijak neoznacenych zaznamu
    d:((bFTRecOzn=0)&&(bFTOzn=0)) $$$addIDX("zhod","nfthod","b")
  }
]]></Implementation>
</Method>

<Method name="indexSmlouva">
<Description><![CDATA[
<pre> Metoda na indexaci smluv podel content serveru

09.02.19 tt; zalozena metoda 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
  s lsClass=##class(MARC).recordClassX(.handle),lnId=##class(MARC).recordIdX(.handle)
  s sT001=$$$HandleT001(handle)                ; ziskame si T001 zaznamu
  s sClass=$$$HandleClass(handle)              ; ziskame tridu zaznamu

  ; ziskame vsechny data k zaznamu v output
  d ##class(content.api).selectRecAll(.output,sClass,sT001)
    
  ; prochazime postupne cyklem vsech polozek k zaznamu
  s item=""      ; jedna polozka k zaznamu
  f { 
    s item=$o(output(item)) q:item=""
    s repo=output(item,"repository")   ; ziskame repository
    s key=output(item,"key")           ; klice
      ; nacteme delsi pomocna data k jednomu zaznamu
    
    d ##class(content.api).getBatch(.array,repo,key)         ; ziskame informace z array    

    if ($g(array("version"),"")="SML")
    { ; 09.02.19 tt; pridana indexace smlouvy
      d $$$addIDX("zsml","a","b")
    }   
  }
]]></Implementation>
</Method>

<Method name="getXXX">
<Description>
12.05.06 jj; pomocna metoda pro aupra
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>psSTlist:%String,psDel:%String,psLine:%String</FormalSpec>
<Implementation><![CDATA[
 s LL=$l(psSTlist),res=""
 f i=1:1:LL d
 . ;w !,"concat i="_i
 . s sST=$e(psSTlist,i,i)
 . f  s sSV=##class(MARC).getSubTagStr(.psLine,sST) q:sSV=""  d
 . . s sSV=$zstrip(sSV,"<>W")
 . . s:sSV'="" res=res_psDel_sSV
 . if i=1,res="" s LL=0,i=9999 ;optimalisation if first ST nf.
 s $e(res,1,$l(psDel))=""           ; discard first delimiter

 q res
]]></Implementation>
</Method>

<Method name="postSaveEx">
<Description>
post save handler - toto je metoda volana po uspesnom zapise zaznamu
(vcetne pripadneho updateindexov)
Navrat:
 "" nebo nejaka informace (text, return code), nerozlisuje se jestli jde o chybu nebo info,

01.09.17 tt; pridana indexaca navazanych zaznamu u datovych zaznamu
17.02.06 rs;</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
   s ret=""
   $$$HandleOK(handle) ; preverit platnost handle
   s id=$$$HandleId(handle)
   d ##class(ChangeLog).updateindexDelayed(id,$$$duiQSreferences)
    
   ; 01.09.17 tt; pridana indexace metadatoveho zaznamu a souvisejicich
   s c=0
   d {
     s sT=$$$getTagXC(.handle,"U88",.c) ; vsetky instituce
     continue:((sT="")&&(c'=0))         ; musime mit hodnotu na zpracovani
     if (sT'="")
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sT3=$$$getSubTagStr(sT,"3")
       if (sT3'="") 
       {
         if ##class(MARC).readLX(.handleMD3,sT3)
         { ; pokud se nam podarilo otevrit metadatovy zaznam
           s id88=$$$HandleId(handleMD3)
           if (id88'="") 
           { ; 01.09.17 tt; doplnena reindexace navazanych zaznamu
             d ##class(User.MARC).updateindex(id88,,.handleMD3,$g(handle($$$SkipLock),0))
             d ##class(ChangeLog).updateindexDelayed(id88,$$$duiQSreferences)
             d ##class(i2.solr).update(id88)
           }
         }    
       }
     }
   } while (c'=0)
   
   q ret
]]></Implementation>
</Method>

<Method name="corrTias2">
<Description><![CDATA[
<pre>
30.08.05 jj; metoda pro kontrolu obsahu indexu tiasz
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sTerm:%Library.String</FormalSpec>
<Implementation><![CDATA[
  zt "X" ; zrusene 22.07.08 rs; indexy tias* sa pouzivaju aj pre browse
         ; t.j. nechceme ich umelo skratene
  
  
  //if ($l(sTerm)>88) s sTerm=$e(sTerm,1,40)_"//"_$e(sTerm,$l(sTerm)-40,9999)
  //q sTerm
]]></Implementation>
</Method>

<Method name="symZbVymaz463001">
<Description>
symbolik pe globalku a select
na vymaz 463/001 u zbornikov
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    s T463=##class(MARC).getTagX(.handle,"463")
    if T463="" q
    if '##class(MARC).t4xx2handle(.h,T463) zt "Z"
    s sT001=$$$HandleT001(h) 
    
    q:sT001=""
    
    ; kod SZP
    if '##class(MARC).readX(.hszp,$$$HandleClass(handle),sT001) zt "X"
    s s970b=##class(MARC).getTagX(.hszp,"970b")
    
    if s970b'="BXXS" q
    
    d ##class(MARC).recordSetupT001X(.h,"")
    s T463=##class(MARC).handle2t4xx(.h,$e(T463,1,3)_$e(T463,5,6)) 
    d ##class(MARC).setTagX(.handle,T463)
    d ##class(MARC).setTagX(.handle,"005    "_##class(Util).date005())
]]></Implementation>
</Method>

<Method name="symListProcess">
<Description>
jednorazovy symbolik na upravu vystupu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ifn,ofn</FormalSpec>
<Implementation><![CDATA[
  s file=##class(%FileCharacterStream).%New()
  s file.Filename=ifn
  
  s fileE=##class(%File).%New(ofn)
  s status=fileE.Open("WNS")
  if $$$ISERR(status) q "error opening file "_ofn
  
  
  s lines=0
  While 'file.AtEnd 
  {
    s line=file.ReadLine()
    s sT001=$p(line,";",2)
    
    if ##class(MARC).readX(.h,"CavUnEpca",sT001)
    {
        s line=line_";"_##class(MARC).getTagX(.h,"C99a")
        s line=line_";"_##class(MARC).getTagX(.h,"C26d")
        s line=line_";"_##class(MARC).getTagX(.h,"C26e")
        s line=line_";"_$p(##class(MARC).getTagX(.h,"999d"),"#",1)
        
        s T463=##class(MARC).getTagX(.h,"463")
        if '##class(MARC).t4xx2handle(.h2,T463)
        ; kod SZP
        s sT001=$$$HandleT001(h2)
        if sT001'="",##class(MARC).readX(.hszp,$$$HandleClass(h),sT001) 
        {
          s s970b=##class(MARC).getTagX(.hszp,"970b")
          s line=line_";"_s970b
        }
    
    }
    d fileE.WriteLine(line)
  }
]]></Implementation>
</Method>

<Method name="symListZB">
<Description>
formatovaci symbolik pre export 
vypis 001,200a</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>handle</FormalSpec>
<Implementation><![CDATA[
    w !,$$$HandleT001(handle),
        ";",##class(MARC).getTagX(.handle,"200a"),
        ";",##class(MARC).getTagX(.handle,"T04b")
]]></Implementation>
</Method>

<Method name="getSymbXVZ4PRAC">
<Description>
vratit zoznam VZ zo zaznamu aktualnych pre zadane pracovisko
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,psPRAC]]></FormalSpec>
<Implementation><![CDATA[
     
     s ret=""
     s sC13=##class(User.MARC).getTagX(.handle,"C13",-1)
     
     f i=1:1:$l(sC13,$c(10))
     {
         s sC131=$p(sC13,$c(10),i) if sC131="" continue
         f  
         {
           ; cislo vyskumneho zameru
           s la=##class(User.MARC).getSubTagStr(.sC131,"a")
           if la="" q
           ; zoznam pracovisk pre ktore plati aktualna VZ
           ; ulozime vsetky kvoli debug vystupu
           s sPracL=##class(rep.epca.exportRIV).zoznamPracPreVZ(la)
           
           
           ; VZ ukladame pod "a", projekty pod "b"
           s bIsForeign='$f(","_sPracL_",",","_psPRAC_",")
           if bIsForeign continue
           
           if ret'="" s sret=ret_$c(10)
           s ret=ret_la
         }
     }
     q ret
]]></Implementation>
</Method>

<Method name="str2list">
<Description>
zoznam v stringu oddelovac $c(10)
prekonvertovat na indexovanu premennu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&X,s]]></FormalSpec>
<Implementation><![CDATA[
    s c=$l(s,$c(10))
    f i=1:1:c
    {
        s X(i)=$p(s,$c(10),i)
    }
]]></Implementation>
</Method>

<Parameter name="csDKRIV2LIST">
<Description>
zoznam druhov vcetne poradia pre export
pre symbolik DKRIV2</Description>
<Default>Jimp,J,B,C,D,P,Z,S,O</Default>
</Parameter>

<Method name="getDKRIV2LIST">
<Description>
obalka pre csDKRIV2LIST</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[    q ..#csDKRIV2LIST
]]></Implementation>
</Method>

<Method name="getSymbX">
<Description>
symboliky pre select/list/..

14.05.14 tt; symbolik pro ziskani vsech opakovani RVO - @RVO  |
08.11.13 tt; ziskame si variantni jmena autoru pro V2 (400)
07.06.12 tt; pridan symbolik @AUTDOMVYPODD pro vypis domacich autoru podle oddeleni
             vyzaduje trideni @PRAC
17.05.10 tt; pocitaji a vypisuji se vsechny oddeleni
05.05.10 tt; pridan symbolik pro vypis domacich autoru "@AUTDOMVYP"
20.04.10 tt; pridany symboliky pro vypis oddeleni v zaznamu "@ODDEL", "@ODDELPOC", "@ODDELV"
26.01.10 tt; @PRACALL: Zalozen symbolik pro vystupy epca
21.02.08 rs; @PRAC: prerobene na getSymbXMV
01.02.07 rs; symbolik DKREP1
01.02.07 rs; symbolik ZB
---
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.Binary,psSymName:%Library.String,&c:%Library.Integer=0,&pnHandled:%Library.Boolean]]></FormalSpec>
<PublicList>handle,c,pnHandled,sSelectCrit,cDelimCrit,cDelimSpace,cDelimVals</PublicList>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
  if $e(psSymName)'="@" ztrap "ERRS"
  
  
  s pnHandled=1
  ; typ zaznamu ak je tam zbornik
  if (psSymName="@ZB")
  {
    q ..getTypZaznamuAkZbornik(.handle)
  }
  ; zoznam pracovisk z 70x$p bez duplikatov
  ; 21.02.08 rs; prerobene na getSymbXMV
  elseif (psSymName="@PRAC")
  {
      ; kody pracovisk z "70*p" s vypustenymi duplikatmi
      if (c=0) || (c=-1)
      {
          ; inicializacia
          s s=##class(MARC).getTagX(.handle,"70*p",-1)
          s nCnt=$l(s,$c(10)),ret="",N=0
          ; pre vsetky pracoviska
          f i=1:1:nCnt
          {
              ; zoberieme jedno
              s s1=$p(s,$c(10),i) 
              if (s1="") || ($d(bX(s1))) continue  ; prazdne a duplikaty ignorujeme
              s bX(s1)="",N=N+1,bX2(N)=s1          ; bX-deduplikacia, bX2-vyskedok
          }
          ; ulozime data do handle do pomocneho uzla
          k handle($$$MarcTmpNode,psSymName) 
          m handle($$$MarcTmpNode,psSymName)=bX2
      }
      q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  }
  ; 10.03.15 tt; pridany symboliky pro trideni tymu v zaznamu - multivaluesort - 
  ;              @TYMT, @USTAV_T_ENG, @USTAV_T_CZ, @USTAV_T_ZK, @UTWOS, @TYM_T_OBOR, @TYM_T_PODOBOR, @TYM_T_CZ, @TYM_T_ENG, @TYM_T_PEERREV
  elseif (psSymName="@TYMT")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    if (c=0) || (c=-1)
    {
       ; . prochazeni zaznamu podle .c  
       s cx=0,N=0
       d {
         s sT70X=$$$getTagXC(.handle,"70*",.cx) ; vsetky citacie
         continue:((sT70X="")&&(cx'=0))
         if (sT70X'="")
         { ; pokud mame vyplnene data, muzeme provadet akce 
           s sT70Xw=$$$getSubTagStr(sT70X,"w")
           ; 20.03.15 tt; upravy trideni tymu
           s sT70Xw=$e($tr(sT70Xw," .[]()",""),1,60)
           ; ulozeni do struktury    
           if (sT70Xw="") || ($d(bX(sT70Xw))) continue  ; prazdne a duplikaty ignorujeme
           s bX(sT70Xw)="",N=N+1,bX2(N)=sT70Xw          ; bX-deduplikacia, bX2-vyskedok
         }
       } while (cx'=0)  
       ; ulozime data do handle do pomocneho uzla
       k handle($$$MarcTmpNode,psSymName) 
       m handle($$$MarcTmpNode,psSymName)=bX2
    }
    q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  } 
  ; 07.02.17 tt; pridany symboliky pro trideni autoru v zaznamu - multivaluesort - 
  ;              @AUTORT, @AUTOR_ID,@AUTOR_RID,@AUTOR_JMENO,@AUTOR_USTAV,@AUTORI
  elseif (psSymName="@AUTORT")
  { ; vrati kody zaznamu autoru
    if (c=0) || (c=-1)
    {
       ; . prochazeni zaznamu podle .c  
       s cx=0,N=0
       d {
         s sT70X=$$$getTagXC(.handle,"70*",.cx) ; vsichni autori
         continue:((sT70X="")&&(cx'=0))
         if (sT70X'="")
         { ; pokud mame vyplnene data, muzeme provadet akce 
           s sT70X3=$$$getSubTagStr(sT70X,"3")  ; ziskame kod autora
           s sT70Xp=$$$getSubTagStr(sT70X,"p")  ; ziskame pracovist
           continue:(sT70Xp="")                 ; do vystupu jen domaci autory
           s sT70X3=$e($p(sT70X3,"*",2),1,60)
           ; ulozeni do struktury    
           if (sT70X3="") || ($d(bX(sT70X3))) continue  ; prazdne a duplikaty ignorujeme
           s bX(sT70X3)="",N=N+1,bX2(N)=sT70X3          ; bX-deduplikacia, bX2-vyskedok
         }
       } while (cx'=0)  
       ; ulozime data do handle do pomocneho uzla
       k handle($$$MarcTmpNode,psSymName) 
       m handle($$$MarcTmpNode,psSymName)=bX2
    }
    q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  } 
  elseif (psSymName="@UTWOS")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s cx=0,ret="",sIDWos="",sIDScopus=""
    if (c=0) || (c=-1)
    {
      d { ; 27.09.14 tt; pridano do exportu z kosiku csv rozliseni pro 014 - kod wos a scopus 
        s sT014=$$$getTagXC(.handle,"014",.cx) ; vsetky citacie
        continue:((sT014="")&&(cx'=0))
        s sT014a=$$$getSubTagStr(sT014,"a")
        if (sT014a'="")
        { ; pokud mame vyplnene data, muzeme provadet akce 
          if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="wos")     
          { ; pokud mam ID pro wos, ulozim  si
            s sIDWos=sT014a
            if (sIDWos'="") 
            { 
              s sIDWos="wos:"_sIDWos
              s:(ret'="") ret=ret_"|"_sIDWos
              s:(ret="") ret=sIDWos
            }
            s sIDWos=""
          }
          /*if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="scopus")     
          { ; pro ID scopusu si take ulozim
            s sIDScopus=sT014a
            s:(sIDScopus'="") sIDScopus="2-s2.0-"_sIDScopus
          }*/
        }
      } while (cx'=0) 
    }
    q ret
  } 
  elseif ((psSymName="@AUTOR_ID")||(psSymName="@AUTOR_RID")||(psSymName="@AUTOR_JMENO")||(psSymName="@AUTOR_USTAV")
          ||($f(psSymName,"@AUTOR_ODD"))||($f(psSymName,"@AUTOR_A_C06")))
  { ; sysno autora,vlastník záznamu,RID,Jméno autora
    s ret=""   
    if ((c=0) || (c=-1))
    { ; ziskame prislusne opakovani tagu 70* podle autora z razeni
      s sT70X=..Tag700ByAutor(.handle)
      if (sT70X'="")
      { ; pokud mame takovy tag, zprazovavame
        s sT70X3=$$$getSubTagStr(sT70X,"3")   ; kod autora
        
        if (psSymName="@AUTOR_ID")
        { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
          s ret=$p(sT70X3,"*",2)                         ; ulozime do retezce a vratime
        }
         if (psSymName="@AUTOR_USTAV")
        { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
          s ret=$$$getSubTagStr(sT70X,"p")     ; ustav
        }
        if (psSymName="@AUTOR_JMENO")
        {
          s sp=$$$getSubTagStr(sT70X,"p")     ; ustav
          s sa=$$$getSubTagStr(sT70X,"a")     ; prijmeni
          s sb=$$$getSubTagStr(sT70X,"b")     ; jmeno
          s sw=##class(User.MARC).getSubTagStr(sT70X,"w",-1) ; oddeleni

          s sab=sa_", "_sb
        
          ; ziskame si variantni jmena autoru (400)
          d ..VariantJmenaAuth(.sab, sT70X3)  ; pridano volani na ziskani variatnich jmen a oznaceni *
          s ret=sab
        } 
        if (psSymName="@AUTOR_RID")
        { ; pokud chceme ziskat RID
         if ##class(User.MARC).readLX(.handleA,sT70X3)
         {
           s xxxc=0
           d {
               s sT035=$$$getTagXC(.handleA,"035",.xxxc) ; vsetky citacie
               continue:((sT035="")&&(c'=0))
               if (sT035'="")
               { ; pokud mame vyplnene data, muzeme provadet akce 
                 s sT035a=$$$getSubTagStr(sT035,"a")
                 s sT0352=$$$getSubTagStr(sT035,"2")
                 s:(sT0352="WOS") ret=sT035a
               }
           } while (xxxc'=0)             
         }
        }
        ; 12.07.19 tt; pridany symbolik @AUTOR_ODD a @AUTOR_A_C06H
        ; 23.09.19 tt; predpracovan symbolik pro oddeleni AUTOR_ODD na varianty
        if ($f(psSymName,"@AUTOR_ODD"))
        { ; pokud mame takovy tag, precteme oddeleni autora z epca zaznamu
          s:(psSymName="@AUTOR_ODD") ret=$$$getSubTagStr(sT70X,"o")     ; oddeleni
          s:(psSymName="@AUTOR_ODDI") ret=$$$getSubTagStr(sT70X,"i")     ; oddeleni
          s:(psSymName="@AUTOR_ODDJ") ret=$$$getSubTagStr(sT70X,"j")     ; oddeleni
          s:(psSymName="@AUTOR_ODDK") ret=$$$getSubTagStr(sT70X,"k")     ; oddeleni
          s:(psSymName="@AUTOR_ODDL") ret=$$$getSubTagStr(sT70X,"l")     ; oddeleni
        }
        if ($f(psSymName,"@AUTOR_A_C06"))
        { ; ziskame oddeleni autora z autority
          if ##class(User.MARC).readLX(.handleA,sT70X3)
          { ; 23.09.19 tt; prepracovan symbolik na varianty C06 @AUTOR_A_C06
            s sPomC06="C06"_$zcvt($e(psSymName,$l(psSymName)),"L") ; - ziskani zpracovavaneho subtagu
            s ret=$$$getTagX(.handleA,sPomC06)                     ; oddeleni autora z autority           
          }
        }
      }
    }
    q ret    
  }
  elseif ((psSymName="@USTAV_T_ENG")||(psSymName="@USTAV_T_CZ")||(psSymName="@USTAV_T_ZK"))
  { ; ziska nazev zkratky ustavu podle konkretniho tymu
    s ret=""   
    if ((c=0) || (c=-1))
    { ; ziskame prislusne opakovani tagu 70* podle tymu z razeni
      s sT70X=..Tag700ByTym(.handle)
      if (sT70X'="")
      { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
        if (psSymName="@USTAV_T_ZK")
        { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
          s sT70Xp=$$$getSubTagStr(sT70X,"p")  ; ziskame zkratku 
          s ret=sT70Xp                         ; ulozime do retezce a vratime
        }
        s sT70Xp=$zcvt($zstrip($$$getSubTagStr(sT70X,"p"),"<>W"),"L")  ; ziskame zkratku 
        if (sT70Xp'="")
        {
          s sTerm=" "_sT70Xp_" (o)"
          s sPracid=##class(User.MARC).getIDByIndex("CavUnAuth","aucr",sTerm)
          if (sPracid'=0)
          { ; pokud id neni 0
            if ##class(User.MARC).getDATAX(.hndla,sPracid)
            { ; pokud se podarilo otevrit zaznam pracoviste, nacteme informace
              ; ziskame nazvy pracoviste v jazykovych mutacich
              if (psSymName="@USTAV_T_CZ") { s ret=$$$getTagX(.hndla,"210a") }
              elseif (psSymName="@USTAV_T_ENG")
              {
                s xx=0
                d {
                  s sT410=$$$getTagXC(.hndla,"410",.xx) ; vsetky citacie
                  continue:((sT410="")&&(xx'=0))
                  if (sT410'="")
                  { ; pokud mame vyplnene data, muzeme provadet akce 
                    s sT4108=$$$getSubTagStr(sT410,"8")
                    s:(sT4108="eng") ret=$$$getSubTagStr(sT410,"a")
                  }
                } while (xx'=0)
              }
            }
          }   
        }
      }
    }
    q ret    
  }
   elseif ((psSymName="@TYM_T_ENG")||(psSymName="@TYM_T_CZ")||(psSymName="@TYM_T_PEERREV")
         ||(psSymName="@TYM_T_OBOR")||(psSymName="@TYM_T_PODOBOR"))
  { ; ziska nazev zkratky ustavu podle konkretniho tymu
    s ret=""   
    if ((c=0) || (c=-1))
    { ; ziskame prislusne opakovani tagu 70* podle tymu z razeni
      s sT70X=..Tag700ByTym(.handle)
      if (sT70X'="")
      { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
        s sT70Xp=$$$getSubTagStr(sT70X,"p")  ; pracovisete
        s sT70Xw=$$$getSubTagStr(sT70X,"w")  ; ziskame zkratku tymu
        s sT70X3=$$$getSubTagStr(sT70X,"3")  ; link na autoritu
        s sT70XwEng=""
         
        if ##class(User.MARC).readLX(.handleA,sT70X3) 
        { 
          s sT70XwEng=$$$getTagX(.handleA,"C48y")        
        }
        if (psSymName="@TYM_T_CZ")
        { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
          s ret=sT70Xw                         ; ulozime do retezce a vratime
        }
        elseif(psSymName="@TYM_T_ENG")
        { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
          s ret=sT70XwEng                         ; ulozime do retezce a vratime
        }
        elseif((psSymName="@TYM_T_PEERREV")||(psSymName="@TYM_T_OBOR")||(psSymName="@TYM_T_PODOBOR"))
        { ; pokud mame takovy tag, precteme zkratku ustavu - pracoviste
          s xx=0
          d {
            s sTC64=$$$getTagXC(.handle,"C64",.xx) ; vsetky citacie
            continue:((sTC64="")&&(xx'=0))
            if (sTC64'="")
            { ; pokud mame vyplnene data, muzeme provadet akce 
              s sTC64b=$zcvt($zstrip($$$getSubTagStr(sTC64,"b"),"<>W"),"L")  ; Tym
              s sTC64c=$zcvt($zstrip($$$getSubTagStr(sTC64,"c"),"<>W"),"L")  ; Ustav
              s sT70Xp=$zcvt($zstrip(sT70Xp,"<>W"),"L")
              s sT70Xw=$zcvt($zstrip(sT70Xw,"<>W"),"L")
              s sT70XwEng=$zcvt($zstrip(sT70XwEng,"<>W"),"L")
             // b ;ttttttttttttttttttttttttttttttt
              if ((sTC64c=sT70Xp)&&((sTC64b=sT70Xw)||(sTC64b=sT70XwEng)))
              {
                s:(psSymName="@TYM_T_PEERREV") ret="PR"   
                s:(psSymName="@TYM_T_OBOR") ret=$$$getSubTagStr(sTC64,"d")
                s:(psSymName="@TYM_T_PODOBOR") ret=$$$getSubTagStr(sTC64,"e") 
              }        
            }
          } while (xx'=0) 
        }
      }
    }
    q ret    
  }
  
  //////////////////////////////////////////////////////////////
  ; 20.04.10 tt; pridan symbolik pro oddeleni - multivaluesort
  elseif (psSymName="@ODDEL")
  { ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if (c=0) || (c=-1)
    { ; pres vsechny opakovani 70* hledame vsechny vyskyty oddeleni v podpoli $o
      s s=##class(MARC).getTagX(.handle,"70*",-1)
      
      s nCnt=$l(s,$c(10)),ret="",N=0
      ; pre vsetky pracoviska
      f i=1:1:nCnt
      {
        ; zoberieme jedno
        s s1=$p(s,$c(10),i)         
        s sAllO=##class(User.MARC).getSubTagStr(s1,"o",-1)
        f l=1:1:$l(sAllO,$c(10))
        { ; doplnime vsechny opakovani podpole h
          s sO1 = $p(sAllO,$c(10),l)
          if (sO1="") || ($d(bX(sO1))) continue  ; prazdne a duplikaty ignorujeme
          s bX(sO1)="",N=N+1,bX2(N)=sO1          ; bX-deduplikacia, bX2-vyskedok  
        }        
      }
      ; ulozime data do handle do pomocneho uzla
      k handle($$$MarcTmpNode,psSymName) 
      m handle($$$MarcTmpNode,psSymName)=bX2
    }
    q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  }    
  ; 20.04.10 tt; pridan symbolik pro pocet oddeleni v zaznamu
  elseif (psSymName="@ODDELPOC")
  { ; vrati pocet oddeleni bez duplikatu v jednom zaznamu
    s N=0
    ; 27.01.20 tt; doplneno trideni - pro oddelneni
    ///s sSortId=##class(MARC).recordSortIdX(.handle)
    //s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    ///if sSortKey1="" q ""      

    
    ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if (c=0) || (c=-1)
    {; inicializacia
      s s=##class(MARC).getTagX(.handle,"70*",-1)
      s nCnt=$l(s,$c(10)),ret=""
      ; pro vsechny oddeleni
      f i=1:1:nCnt
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i)
        s so=##class(MARC).getSubTagStr(s1,"o",-1) 
        ///s sp=##class(MARC).getSubTagStr(s1,"p")
        ///continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))

        ; 17.05.10 tt; pocitaji a vypisuji se vsechny oddeleni
        f l=1:1:$l(so,$c(10))
        { ; zoberieme jedno
          s so1=$p(so,$c(10),l)
          if ((so1="") || ($d(bX(so1)))) continue  ; prazdne a duplikaty ignorujeme
          s bX(so1)="",N=N+1,bX2(N)=so1            
        }
      }
    }
    q N   ; vratime pocet oddeleni
  }
  ; 15.06.10 tt; zmenen oddelovac oddeleni 
  ; 20.04.10 tt; pridan symbolik pro vypis oddeleni v zaznamu 
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@ODDELV")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Odd=""
    s sSortId=##class(MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    if sSortKey1="" q ""      
    
    ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if (c=0) || (c=-1)
    {; inicializacia
      s s=##class(MARC).getTagX(.handle,"70*",-1)
      s nCnt=$l(s,$c(10)),ret=""
      ; pro vsechny oddeleni
      f i=1:1:nCnt
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=##class(MARC).getSubTagStr(s1,"p")
        s so=##class(MARC).getSubTagStr(s1,"o",-1)
      
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        ; 17.05.10 tt; pocitaji a vypisuji se vsechny oddeleni
        f l=1:1:$l(so,$c(10))
        { ; zoberieme jedno
          s so1=$p(so,$c(10),l) 
          if ((so1="") || ($d(bX(so1)))) continue  ; prazdne a duplikaty ignorujeme
          s bX(so1)="",N=N+1,bX2(N)=so1, Odd=Odd_"|"_so1             
        }        
      }
    }
    s:($e(Odd,2,9999)'="") Odd=Odd_"|" ; pridani oddelovace    
    q $e(Odd,2,9999)   ; vratime oddeleni  
  }
  elseif ($f(psSymName,"@ODDELV_ST"))
  { ; 24.09.19 tt; pridany symbolik pro vypis oddeleni
    s N=0, Odd=""
    s sSortId=##class(MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    if sSortKey1="" q ""      
    
    s sPomST70X=$zcvt($e(psSymName,$l(psSymName)),"L") ; - ziskani zpracovavaneho subtagu

    ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if (c=0) || (c=-1)
    {; inicializacia
      s s=##class(MARC).getTagX(.handle,"70*",-1)
      s nCnt=$l(s,$c(10)),ret=""
      ; pro vsechny oddeleni
      f i=1:1:nCnt
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=##class(MARC).getSubTagStr(s1,"p")
        s so=##class(MARC).getSubTagStr(s1,sPomST70X,-1)
      
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        ; 17.05.10 tt; pocitaji a vypisuji se vsechny oddeleni
        f l=1:1:$l(so,$c(10))
        { ; zoberieme jedno
          s so1=$p(so,$c(10),l) 
          if ((so1="") || ($d(bX(so1)))) continue  ; prazdne a duplikaty ignorujeme
          s bX(so1)="",N=N+1,bX2(N)=so1, Odd=Odd_"|"_so1             
        }        
      }
    }
    s:($e(Odd,2,9999)'="") Odd=Odd_"|" ; pridani oddelovace    
    q $e(Odd,2,9999)   ; vratime oddeleni  
  } 
  ; 03.05.10 tt; pridan symbolik pro vypis poctu autoru 
  elseif (psSymName="@AUTPOC")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    ; nejdriv nacteme, jestli neni vyplnene pole C46a
    s sPocAuth=##class(MARC).getTagX(.handle,"C46a")
    if (sPocAuth="")
    { ; pokud neni vyplnene, spocitame autory rucne
      s s=##class(MARC).getTagX(.handle,"70*",-1)
      s sPocAuth=$l(s,$c(10))     
    }    
    s:(sPocAuth="") sPocAuth=0 ; navratova hodnota
    q sPocAuth   ; vratime pocet autoru        
  } 
  ; 03.05.10 tt; pridan symbolik pro vypis poctu domacich autoru
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@AUTDOMPOC")
  { ; vrati pocet domacich autoru (maji vyplnene pracoviste)
    s N=0
    s sSortId=##class(MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    if sSortKey1="" q ""      
    
    ; spocitam vsechny 70* s mojim pracovistem
    if (c=0) || (c=-1)
    {; inicializacia
      s s=##class(MARC).getTagX(.handle,"70*",-1)
      
      ; pro vsechny oddeleni
      f i=1:1:$l(s,$c(10))
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=##class(MARC).getSubTagStr(s1,"p")
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        s N=N+1
      }
    }
    q N   ; vratime oddeleni        
  } 
  ; 01.05.20 tt; pridan symbolik pro vypis typu spoluprace ve zkratce cs113936 
  elseif (psSymName="@TYPSPOL")
  { ; vrati zkratky 
    s sSpol="", sPocA=0

    ; spocitam vsechny 70* s mojim pracovistem
    if (c=0) || (c=-1)
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)
      s sC46a=$$$getTagX(.handle,"C46a")   ; celkovy pocet autoru
    
      ; pro vsechny oddeleni
      s sAutCZ=0,sAutZah=0,bAutKor=0,sUst="",nUst=0,nDifUst=0
      
      //,sZeme=""
      f i=1:1:$l(s,$c(10))
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sPocA=sPocA+1
        s sp=$$$getSubTagStr(s1,"p")  ; pracoviste
        s:(sp'="") nUst=nUst+1
        if ('$f(sUst_",",sp_","))
        { ; seskladame si ustavy
          s sUst=sUst_sp_","    ; seznam rozdilnych ustavu
          s nDifUst=nDifUst+1   ; rozdilne ustavy
        }
        
        if (sp="")
        { ; pokud nemame pracoviste, vyhodnotucjeme zemi
          s sy=$$$getSubTagStr(s1,"y")  ; zeme CZ - cesko
          s:((sy="CZ")||(sy="")) sAutCZ=1    ; mame CZ autora
          s:((sy'="CZ")&&(sy'="")) sAutZah=1 ; mame zahranicniho autora
        }
        
        s sz=$$$getSubTagStr(s1,"z")  ; korespondencni K nebo A
        if (((sz="K")||(sz="A"))&&(sp'="")) { s bAutKor=1 }  ; nastaveni korespondencniho
      }
      
      if ((sAutZah=0)&&(sAutCZ=1)&&(nUst'=0)) 
      { ; Národní – autoři z ústavu + autoři CZ
        ; Národní s korespondujícím autorem z AV
        s sSpol=","_"N"
        s:(bAutKor=1) sSpol=sSpol_","_"NK"
      }
      if ((sAutZah=1)&&(nUst'=0)) 
      { ; Mezinárodní – autoři z ústavu + alespoň jeden autor různý než CZ
        ; Mezinárodní s korespondujícím autorem z AV
        s sSpol=sSpol_","_"M"
        s:(bAutKor=1) sSpol=sSpol_","_"MK"
      }
      if ((nUst=sPocA)&&(sC46a<=sPocA)) 
      { ; Ústavní – pouze autoři z ústavu,
        ; Meziústavní – autoři z různých ústavů,
        if (nDifUst<=1) { s sSpol=sSpol_","_"U" }
        else { s sSpol=sSpol_","_"MU" }
      }
      if (sC46a>30)||(sPocA>30)
      { ; Široká spolupráce - >30 autorů
        s sSpol=sSpol_","_"SP"
      }
      
    }
    q $e(sSpol,2,9999)   ; vratime oddeleni        
  } 
  ; 05.05.10 tt; pridan symbolik pro vypis domacich autoru
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@AUTDOMVYP")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Auth=""
    s sSortId=##class(MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    if sSortKey1="" q ""      
    
    ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if (c=0) || (c=-1)
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)
      s nCnt=$l(s,$c(10)),ret=""
      ; pro vsechny oddeleni
      f i=1:1:nCnt
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=$$$getSubTagStr(s1,"p") ; ustav
        s sa=$$$getSubTagStr(s1,"a") ; prijmeni
        s sb=$$$getSubTagStr(s1,"b") ; jmeno
        s sab=sa_", "_sb

        ; 08.11.13 tt; ziskame si variantni jmena autoru pro V2 (400)
        s s3=$$$getSubTagStr(s1,"3")    ; odkaz
        ; 19.11.14 tt; pridano volani na ziskani variatnich jmen a oznaceni *
        /// 10.01.20 tt; pridana varianta pro serazeni vsech variantnich jmen
        d ..VariantJmenaAuth(.sab, s3) 
        /*if (s3'="")
        { ; pokud mame link do autorit, pokusime se otevrit
          if ##class(User.MARC).readLX(.handleA,s3)
          {
            s s400 = $$$getTagXC(.handleA,"400",-1)
            for kk=1:1:$l(s400,$c(10))
            { ; zaindexujeme vsechny isbn
              s s4001=$p(s400,$c(10),kk)
              continue:(s4001="")
              s s4001a=$$$getSubTagStr(s4001,"a") ; prijmeni
              s s4001b=$$$getSubTagStr(s4001,"b") ; jmeno  
              s:((s4001a'="")&&(s4001b'="")) sab=sab_";"_s4001a_", "_s4001b
            }        
          }
        }*/
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        if ((sab="") || ($d(bX(sab)))) continue  ; prazdne a duplikaty ignorujeme
        s bX(sab)="",N=N+1,bX2(N)=sab, Auth=Auth_";"_sab            
      }
    }
    q $e(Auth,2,9999)   ; vratime oddeleni      
  }
  ; 28.04.14 tt; opraveno poradi pokud neni zadane pracoviste
  ; 07.06.12 tt; pridan symbolik @AUTDOMVYPODD pro vypis domacich autoru podle oddeleni
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@AUTDOMVYPODD")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Auth="",ret=""
    s sSortId=##class(User.MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    q:(sSortKey1="") ""       ; pokud nemame sortovaci kriterium, ukoncime
    ; ziskame si seznam oddeleni
    s sSodd=..getSymbX(.handle,"@ODDELV", .c, .pnHandled)

    ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if ((c=0) || (c=-1))
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)

      ; pro vsechny 70x
      f i=1:1:$l(s,$c(10))
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=$$$getSubTagStr(s1,"p")     ; ustav
        s sa=$$$getSubTagStr(s1,"a")     ; prijmeni
        s sb=$$$getSubTagStr(s1,"b")     ; jmeno
        s so=$$$getSubTagStrC(s1,"o",-1) ; oddeleni

        s sab=sa_", "_sb
        
        ; 08.11.13 tt; ziskame si variantni jmena autoru pro V2 (400)
        s s3=$$$getSubTagStr(s1,"3")    ; odkaz
        ; 19.11.14 tt; pridano volani na ziskani variatnich jmen a oznaceni *
        /// 10.01.20 tt; pridana varianta pro serazeni vsech variantnich jmen
        d ..VariantJmenaAuth(.sab, s3,1) 

        /*if (s3'="")
        { ; pokud mame link do autorit, pokusime se otevrit
          if ##class(User.MARC).readLX(.handleA,s3)
          {
            s s400 = $$$getTagXC(.handleA,"400",-1)
            for kk=1:1:$l(s400,$c(10))
            { ; zaindexujeme vsechny isbn
              s s4001=$p(s400,$c(10),kk)
              continue:(s4001="")
              s s4001a=$$$getSubTagStr(s4001,"a") ; prijmeni
              s s4001b=$$$getSubTagStr(s4001,"b") ; jmeno  
              s:((s4001a'="")&&(s4001b'="")) sab=sab_";"_s4001a_", "_s4001b
            }        
          }
        }
        */
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        continue:((sab="") || ($d(bX(sab))))   ; prazdne a duplikaty ignorujeme
          
        ; pokud bude mit autor vice oddeleni, zaradi se do kazdeho z nich  
        f l=1:1:$l(so,$c(10))
        { ; zoberieme jedno
          s so1=$p(so,$c(10),l)    ; ziskame jedno opakovani
          s nSORet=$f(sSodd,so1)   ; najdeme si cislo, podle ktereho zaradit autora do oddeleni
          ; 28.04.14 tt; opraveno poradi pokud neni zadane pracoviste
          s:((nSORet=0)||(so1="")) nSORet=9999 ; osetreni proti nenalezeni oddeleni
          s Auth(nSORet)=$g(Auth(nSORet),"")_";"_sab            
        }                
        s bX(sab)="",N=N+1,bX2(N)=sab ; osetreni proti duplicitam
      }
    }

    s sAuthVysl="",sPomR=""
    for
    {
      s sPomR=$o(Auth(sPomR)) q:(sPomR="")  ; posledni cast tagove mapy       
      ; seradime spravne zaznamy
      s:(sAuthVysl'="") sAuthVysl=sAuthVysl_"|"_$e(Auth(sPomR),2,9999)
      s:(sAuthVysl="") sAuthVysl=$e(Auth(sPomR),2,9999)
    }   
    q sAuthVysl   ; vratime autory serazene podle oddeleni    
  }  
  ; 05.04.12 tt; pridan symbolik pro vypis vyzkumneho zameru @VYZZAM
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@VYZZAM")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s ret=""
    s sSortId=##class(User.MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    q:(sSortKey1="") ""      
        
    s cx=0  ; . prochazeni zaznamu podle .c
    d {
      s sTC13=$$$getTagXC(.handle,"C13",.cx) ; vsechny opakovani tagu
      continue:((sTC13="")&&(cx'=0))
      if (sTC13'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC13a=$$$getSubTagStr(sTC13,"a")
        s sTC13b=##class(User.Util).sXlate("UN_VYSKUM_ZAM_CAV",sTC13a,,"Cav")
        if $f(sTC13b,sSortKey1)
        { ; postupne ukladame vyzkumne zamery
          s:(ret'="") ret=ret_"|"_sTC13a
          s:(ret="") ret=sTC13a
        }
      }
    } while (cx'=0)   
    
    q ret   ; vratime vysledek      
  }
  ; zoznam pracovisk z 70x$p a C26$e bez duplikatu - dle vzoru @PRAC
  ; 26.01.10 tt; Zalozen symbolik pro vystupy epca
  elseif (psSymName="@PRACALL")
  {
    ; kody pracovisk z "70*p" s vypustenymi duplikatmi
    if (c=0) || (c=-1)
    { ; inicializacia
      s s=##class(MARC).getTagX(.handle,"70*p",-1)
      ; pridani hodnoty C26$e
      s sC26e=##class(MARC).getTagX(.handle,"C26e",-1)
      s:(sC26e'="") s=s_$c(10)_sC26e ; pridani za retezec
      s nCnt=$l(s,$c(10)),ret="",N=0
       
      f i=1:1:nCnt
      { ; pre vsetky pracoviska
        s s1=$p(s,$c(10),i)     ; zoberieme jedno
        if (s1="") || ($d(bX(s1))) continue  ; prazdne a duplikaty ignorujeme
        s bX(s1)="",N=N+1,bX2(N)=s1          ; bX-deduplikacia, bX2-vyskedok
      }
      ; ulozime data do handle do pomocneho uzlu - ve vyssi metode se ulozi jako trideni
      k handle($$$MarcTmpNode,psSymName) 
      m handle($$$MarcTmpNode,psSymName)=bX2
    }
    q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  }
  ///////////////////////////////////////////////////////////////////////////
  ; 01.04.14 tt; Zalozen symbolik pro vystupy epca s C51g
  elseif (psSymName="@PRACALLDEL")
  { ; kody pracovisk z "70*p" s vypustenymi duplikatmi + C51g
    if (c=0) || (c=-1)
    { ; inicializacia
      s s=##class(MARC).getTagX(.handle,"70*p",-1)
      ; pridani hodnoty C26$e
      s sC26e=##class(MARC).getTagX(.handle,"C26e",-1)
      s:(sC26e'="") s=s_$c(10)_sC26e ; pridani za retezec
      s sC51g=##class(MARC).getTagX(.handle,"C51g",-1)
      s:(sC51g'="") s=s_$c(10)_sC51g ; pridani za retezec
      s nCnt=$l(s,$c(10)),ret="",N=0
       
      f i=1:1:nCnt
      { ; pre vsetky pracoviska
        s s1=$p(s,$c(10),i)     ; zoberieme jedno
        if (s1="") || ($d(bX(s1))) continue  ; prazdne a duplikaty ignorujeme
        s bX(s1)="",N=N+1,bX2(N)=s1          ; bX-deduplikacia, bX2-vyskedok
      }
      ; ulozime data do handle do pomocneho uzlu - ve vyssi metode se ulozi jako trideni
      k handle($$$MarcTmpNode,psSymName) 
      m handle($$$MarcTmpNode,psSymName)=bX2
    }
    q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  }
  
  ////////////////////////////////////////
  ; POZOR: vyzaduje select striedeny podla @PRAC
  ;        vypisuje len VZ ktore su aktualne pre aktualne opakovanie @PRAC (z triedenia)
  ;        21.02.08 rs
  elseif (psSymName="@VZ4PRAC")
  {
      ; init
      if (c=0) || (c=-1)
      {
         s sSortId=##class(MARC).recordSortIdX(.handle)
         s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
         if sSortKey1="" q ""
         s s=..getSymbXVZ4PRAC(.handle,sSortKey1)
         if s="" s c=0 q ""
         
         d ..str2list(.bX2,s)
         ; ulozime data do handle do pomocneho uzla
         k handle($$$MarcTmpNode,psSymName) 
         m handle($$$MarcTmpNode,psSymName)=bX2
         
      }
      q ##class(SPIndex).getSymbXMV(.handle,psSymName,.c)
  }
  ; druh dokumentu s rozlisenim na na impact factor u "J"
  ; a na cze/cizi u inych
  ; vyzaduje aktivovane Txx tagy
  elseif (psSymName="@DKREP1")
  {
    s s970b=##class(MARC).getTagX(.handle,"970b")
    s s101a=##class(MARC).getTagX(.handle,"101a")           ; jazyk
    s sIF=##class(MARC).getTagX(.handle,"T16c")
    if s970b="J" 
    {
       if sIF'="" s s970b=s970b_"imp"
       q s970b
    }
    if s101a'="",s101a'="cze" s s970b=s970b_"cizi"
    
    q s970b
  }
  ; typ zaznamu ak je tam zbornik
  elseif (psSymName="@PROJCEP")
  {
    q ..getTypZaznamuAkZbornik(.handle)
  }
  ; bibliograficka citacia (ZF)
  ; vyzaduje aktivovane Txx tagy
  elseif (psSymName="@BIBCIT")
  {
    s s=..getBibcitCAV(.handle)
    if (s'="") s s=##class(Util).strswap(s,"..",".")
    /// 28.02.08 rs; odstranenie formatovania pre vybrane symboliky
    d ##class(rep.epca.exportBase).symClearFormatInfoStr(.s)
    q s
  }
  ; anotacia v cestine
  ; t.j. ak je jazyk cestina berieme C15a inak C15c
  elseif (psSymName="@ANOTCZ")
  {
    s s101a=$$$getTagX(.handle,"101a")
    if s101a="cze" {s s=$$$getTagX(.handle,"C15a") }
    else {s s=$$$getTagX(.handle,"C15c") }
    /// 28.02.08 rs; odstranenie formatovania pre vybrane symboliky
    d ##class(rep.epca.exportBase).symClearFormatInfoStr(.s)
    q s
  }
  ; druh dokumentu do RIV
  ; vyzaduje aktivovane Txx tagy
  elseif (psSymName="@DKRIV")
  {
    s sErr="",sDruhRIV=##class(rep.epca.exportRIV).druhDokumentuRIV(.handle,.sErr,.sForm) 
    if sErr'="" s sDruhRIV=""
    q sDruhRIV
  }
  ; druh dokumentu do RIV - upraveny pre niektore vystupy
  ; vyzaduje aktivovane Txx tagy
  elseif (psSymName="@DKRIV2")
  {
  
    s sErr="",sDruhRIV=##class(rep.epca.exportRIV).druhDokumentuRIV(.handle,.sErr,.sForm) 
    if sErr'="" s sDruhRIV=""
    if $f("U,O,V,E",sForm) s sDruhRIV="O"
    if '$f(..#csDKRIV2LIST,sDruhRIV) s sDruhRIV="" ; nezapocitava sa
     
    ; este rozdelime J na "Jimp" a "J"
    s sResIF=$$$getTagX(.handle,"T16c")
    if sResIF'="",sDruhRIV="J" s sDruhRIV="Jimp"
    q sDruhRIV
  }
  ; skratka formulara z C99$d
  elseif (psSymName="@DKF")
  {
    s sC99d=##class(User.MARC).getTagX(.handle,"C99d")
    s sForm=$p(sC99d,"_",4)
    if sForm="" s sForm="??"_sC99d
    if sForm="" s sForm="??"
    q sForm
  }
  ; 17.04.12 tt; symbolik pro impakt faktor podle daneho roku ze zaznamu BCA @ROKIF
  elseif (psSymName="@ROKIF")
  {
    s sPomRoky="", sVyslIF=""
    for i=1:1  
    { ; toto je cyklus pro cteni selekcnich parametru 
      s sPomPar=$p(sSelectCrit,cDelimCrit,i) q:sPomPar=""
      s sPomPar=$$$strswap(sPomPar,"!","")
      s sPomPar=$$$strswap(sPomPar,cDelimVals,"~")
      s sPomPar=$$$strswap(sPomPar,cDelimSpace," ")
      s sPomPP1=$p(sPomPar," ",1),sPomPP2=$p(sPomPar," ",2)
    
      s:(sPomPP1=".YEIMF") sPomRoky=$p(sPomPar," ",3)
    }
    
    s c=0
    d {
      s sT978=$$$getTagXC(.handle,"978",.c) ; vsetky citacie
      continue:((sT978="")&&(c'=0))
      if ((sT978'="")&&(sPomRoky'=""))
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sT978a=$$$getSubTagStr(sT978,"a")
        if (($l(sPomRoky)=4)&&(sPomRoky=sT978a))
        { ; pokud mame 4mistny rok, pouzijeme ho na srovnani
          s sVyslIF=$$$getSubTagStr(sT978,"c")
        }
        elseif (($p(sPomRoky,"~",1)<=sT978a)&&(sT978a<=$p(sPomRoky,"~",2)))
        { ; pokud mame rozsah, musi spadat do toho
          s sVyslIF=$$$getSubTagStr(sT978,"c")  
        }
      }
    } while (c'=0)
    q sVyslIF
  }
  ; 19.10.21 tt; přidány symboliky pro hodnotící kritéria - vrátí nejnovější
  elseif (psSymName="@IFAKTHOD")
  {
    s sPomRoky="", sVyslIF=""
    s sVyslIF=..get978Last(.handle,"c", 0)
    q sVyslIF
  }
  elseif (psSymName="@IFAKTROK")
  {
    s sPomRoky="", sVyslIF=""
    s sVyslIF=..get978Last(.handle,"c", 1)
    q sVyslIF
  }
  elseif (psSymName="@QAISAKTHOD")
  {
    s sPomRoky="", sVyslIF=""
    s sVyslIF=..get978Last(.handle,"D", 0)
    q sVyslIF
  }
  elseif (psSymName="@QAISAKTROK")
  {
    s sPomRoky="", sVyslIF=""
    s sVyslIF=..get978Last(.handle,"D", 1)
    q sVyslIF
  }
  elseif (psSymName="@DATUMVZNIKU")
  { ; vyselektujeme datum vzniku zaznamu
    s t999d=##class(MARC).getTagX(.handle,"999d")
    s t999d=$p($p(t999d,"#",1),"-",2)  ; vyseknem iba datum bez mena
    s t999d=$e(t999d,7,8)_"."_$e(t999d,5,6)_"."_$e(t999d,1,4)
    q t999d
  }
  ; 17.04.12 tt; symbolik pro pocet navazanych zaznamu clanku podle T04 pro BCA zaznamy @NAVZAZZJ
  elseif (psSymName="@NAVZAZZJ")
  {
   s c=0, nPocNav=0
    d {
      s sTT04=$$$getTagXC(.handle,"T04",.c) ; vsetky citacie
      continue:((sTT04="")&&(c'=0))
      if (sTT04'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTT04c=$$$getSubTagStr(sTT04,"c")
        s sTT04b=$$$getSubTagStr(sTT04,"b")
        //if (sTT04c="zj")
        //{ ; pokud mam ty spravne odkazy, ulozim si je
          s nPocNav=nPocNav+sTT04b
        //}       
      }
    } while (c'=0)
    q nPocNav
  }
  elseif (psSymName="@RVO")
  { ; 14.05.14 tt; symbolik pro ziskani vsech opakovani RVO - @RVO  |
    s c=0, sRVOAll=""
    d {
      s sTC57=$$$getTagXC(.handle,"C57",.c) ; vsetky citacie
      continue:((sTC57="")&&(c'=0))
      if (sTC57'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC57a=$$$getSubTagStrC(sTC57,"a",-1)  ; ziskame vsechny opakovani C57a
        s sTC57a=$$$strswap(sTC57a,$c(10),"|")   ; nahradime opakovani
        if (sTC57a'="")
        { ; pokud mame data, ukladame - ulozime si data
          s:(sRVOAll'="") sRVOAll=sRVOAll_"|"_sTC57a 
          s:(sRVOAll="") sRVOAll=sTC57a 
        }
      }
    } while (c'=0)
    q sRVOAll
  }
  elseif (psSymName="@HODOBOR")
  { ; 29.10.14 tt; symbolik pro ziskani vsech opakovani oboru  - C64$d  |
    s c=0, sObAll=""
    d {
      s sTC64=$$$getTagXC(.handle,"C64",.c) ; projdeme vsechny pole C64
      continue:((sTC64="")&&(c'=0))
      if (sTC64'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC64d=$$$getSubTagStrC(sTC64,"d",-1)  ; ziskame vsechny opakovani C64d
        s sTC64d=$$$strswap(sTC64d,$c(10),"|")   ; nahradime opakovani
        if (sTC64d'="")
        { ; pokud mame data, ukladame - ulozime si data
          s:(sObAll'="") sObAll=sObAll_"|"_sTC64d 
          s:(sObAll="") sObAll=sTC64d 
        }
      }
    } while (c'=0)
    q sObAll
  }    
  elseif (psSymName="@HODPODOBOR")
  { ; 29.10.14 tt; symbolik pro ziskani vsech opakovani podoboru  - C64$e  |
    s c=0, sPodObAll=""
    d {
      s sTC64=$$$getTagXC(.handle,"C64",.c) ; projdeme vsechny pole C64
      continue:((sTC64="")&&(c'=0))
      if (sTC64'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sTC64e=$$$getSubTagStrC(sTC64,"e",-1)  ; ziskame vsechny opakovani C64e
        s sTC64e=$$$strswap(sTC64e,$c(10),"|")   ; nahradime opakovani
        if (sTC64e'="")
        { ; pokud mame data, ukladame - ulozime si data
          s:(sPodObAll'="") sPodObAll=sPodObAll_"|"_sTC64e 
          s:(sPodObAll="") sPodObAll=sTC64e 
        }
      }
    } while (c'=0)
    q sPodObAll
  }    
  ; 01.11.14 tt; pridan symbolik pro vypis tymu v zaznamu (na zaklade ODDELV)
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@TYMV")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Tym=""
    s sSortId=##class(User.MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    q:(sSortKey1="") ""       ; pokud nemam tridici kriterium, ukoncim
    
    ; kody tymu z "70*w" s vypustenymi duplikatmi
    if ((c=0) || (c=-1))
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)
      s nCnt=$l(s,$c(10)),ret=""
      ; pro vsechny tymy, prochazim po jednom opakovani 70*
      f i=1:1:nCnt
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=$$$getSubTagStr(s1,"p")
        s sw=##class(User.MARC).getSubTagStr(s1,"w",-1)
      
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        ; 17.05.10 tt; pocitaji a vypisuji se vsechny oddeleni
        f l=1:1:$l(sw,$c(10))
        { ; zpracovavame po jedne hodnote 
          s sw1=$p(sw,$c(10),l) 
          if ((sw1="") || ($d(bX(sw1)))) continue  ; prazdne a duplikaty ignorujeme
          s bX(sw1)="",N=N+1,bX2(N)=sw1, Tym=Tym_"|"_sw1             
        }        
      }
    }
    s:($e(Tym,2,9999)'="") Tym=Tym_"|" ; pridani oddelovace    
    q $e(Tym,2,9999)   ; vratime tymy  
      
  } 
  ; 01.11.12 tt; zalozen symbolik pro tymy na zaklade @AUTDOMVYPODD pro vypis domacich autoru podle tymu
  ;              vyzaduje trideni @PRAC
  elseif (psSymName="@AUTDOMTYM")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Auth="",ret=""
    s sSortId=##class(User.MARC).recordSortIdX(.handle)
    s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
    q:(sSortKey1="") ""       ; pokud nemame sortovaci kriterium, ukoncime
    ; ziskame si seznam oddeleni
    s sSTym=..getSymbX(.handle,"@TYMV", .c, .pnHandled)

    ; kody oddeleni z "70*o" s vypustenymi duplikatmi
    if ((c=0) || (c=-1))
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)

      ; pro vsechny 70x
      f i=1:1:$l(s,$c(10))
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=$$$getSubTagStr(s1,"p")     ; ustav
        s sa=$$$getSubTagStr(s1,"a")     ; prijmeni
        s sb=$$$getSubTagStr(s1,"b")     ; jmeno
        s sw=##class(User.MARC).getSubTagStr(s1,"w",-1) ; oddeleni
        ; 27.02.20 tt; provedena uprava osetreni generovani autoru do V10 u tymu
        continue:(sw="")
        s sab=sa_", "_sb
        
        ; ziskame si variantni jmena autoru (400)
        s s3=$$$getSubTagStr(s1,"3")    ; odkaz
        ; 25.03.20 tt; provedena zmena variantnich jmen pro @AUTDOMTYM, aby byly stejne jako u @AUTDOMVYPODD
        ; 19.11.14 tt; pridano volani na ziskani variatnich jmen a oznaceni *
        d ..VariantJmenaAuth(.sab, s3,1) 
        /* 
        if (s3'="")
        { ; pokud mame link do autorit, pokusime se otevrit
          if ##class(User.MARC).readLX(.handleA,s3)
          {
            s s400 = $$$getTagXC(.handleA,"400",-1)
            for kk=1:1:$l(s400,$c(10))
            { ; projdeme vsechny variantni jmena
              s s4001=$p(s400,$c(10),kk)
              continue:(s4001="")
              s s4001a=$$$getSubTagStr(s4001,"a") ; prijmeni
              s s4001b=$$$getSubTagStr(s4001,"b") ; jmeno  
              s:((s4001a'="")&&(s4001b'="")) sab=sab_";"_s4001a_", "_s4001b
            }        
          }
        }
        */
        continue:($zcvt(sSortKey1,"L")'=$zcvt(sp,"L"))
        continue:((sab="") || ($d(bX(sab))))   ; prazdne a duplikaty ignorujeme
          
        ; pokud bude mit autor vice tymu, zaradi se do kazdeho z nich  
        f l=1:1:$l(sw,$c(10))
        { ; zoberieme jedno
          s sw1=$p(sw,$c(10),l)    ; ziskame jedno opakovani
          s nSTRet=$f(sSTym,sw1)   ; najdeme si cislo, podle ktereho zaradit autora do tymu
          ; 28.04.14 tt; opraveno poradi pokud neni zadane pracoviste
          s:((nSTRet=0)||(sw1="")) nSTRet=9999 ; osetreni proti nenalezeni oddeleni
          s Auth(nSTRet)=$g(Auth(nSTRet),"")_";"_sab            
        }                
        s bX(sab)="",N=N+1,bX2(N)=sab ; osetreni proti duplicitam
      }
    }

    s sAuthVysl="",sPomR=""
    for
    { ; seradime spravne zaznamy
      s sPomR=$o(Auth(sPomR)) q:(sPomR="")  ; seskladame postupne       
      s:(sAuthVysl'="") sAuthVysl=sAuthVysl_"|"_$e(Auth(sPomR),2,9999)
      s:(sAuthVysl="") sAuthVysl=$e(Auth(sPomR),2,9999)
    }   
    q sAuthVysl   ; vratime autory serazene podle oddeleni    
  }    
  elseif (psSymName="@AUTORI")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Auth="",ret=""

    if ((c=0) || (c=-1))
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)

      ; pro vsechny 70x
      f i=1:1:$l(s,$c(10))
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=$$$getSubTagStr(s1,"p")     ; ustav
        s sa=$$$getSubTagStr(s1,"a")     ; prijmeni
        s sb=$$$getSubTagStr(s1,"b")     ; jmeno
        //continue:(sp="")                 ; jen autori s ustavem
        s sab=sa_", "_sb
        
        ; ziskame si variantni jmena autoru (400)
        s s3=$$$getSubTagStr(s1,"3")    ; odkaz
        ; 19.11.14 tt; pridano volani na ziskani variatnich jmen a oznaceni *
        d ..VariantJmenaAuth(.sab, s3) 
      
        continue:(sab="")   
        s:(ret'="") ret=ret_";"_sab            
        s:(ret="") ret=sab            
      }
    }
   
    q ret   ; vratime autory serazene podle oddeleni    
  }    
  elseif (psSymName="@AUTORIAV")
  { ; vrati oddeleni bez duplikatu v jednom zaznamu
    s N=0, Auth="",ret=""

    if ((c=0) || (c=-1))
    {; inicializacia
      s s=$$$getTagXC(.handle,"70*",-1)

      ; pro vsechny 70x
      f i=1:1:$l(s,$c(10))
      { ; zoberieme jedno
        s s1=$p(s,$c(10),i) 
        s sp=$$$getSubTagStr(s1,"p")     ; ustav
        s sa=$$$getSubTagStr(s1,"a")     ; prijmeni
        s sb=$$$getSubTagStr(s1,"b")     ; jmeno
        continue:(sp="")                 ; jen autori s ustavem
        s sab=sa_", "_sb
        
        ; ziskame si variantni jmena autoru (400)
        s s3=$$$getSubTagStr(s1,"3")    ; odkaz
        ; 19.11.14 tt; pridano volani na ziskani variatnich jmen a oznaceni *
        d ..VariantJmenaAuth(.sab, s3) 
      
        continue:(sab="")   
        s:(ret'="") ret=ret_";"_sab            
        s:(ret="") ret=sab            
      }
    }
   
    q ret   ; vratime autory serazene podle oddeleni    
  }    
  elseif (psSymName="@ROKVYDANI")
  { ; vrati rok vydani
    s ret=""
    s s970b=$$$getTagX(.handle,"970b")
    s:(ret="") ret=$$$getTagX(.handle,"U63u")
    s:(ret="") ret=$$$getTagX(.handle,"463/210d")
    s:(ret="") ret=$$$getTagX(.handle,"210d")      ; datum  
    s:(ret="") ret=$$$getTagX(.handle,"C20f")  
    q ret   ; vratime autory serazene podle oddeleni    
  }    
  elseif (psSymName="@ISSNEISSN")
  { ; vrati rok vydani
    s ret=""
 
    ; 463/010a,011a
    s ret=$$$getTagX(.handle,"463/011a")
    s:(ret="") ret=$$$getTagX(.handle,"463/011e") 
    s:(ret="") ret=$$$getTagX(.handle,"011a")
    s:(ret="") ret=$$$getTagX(.handle,"011e")

    q ret   ; vratime autory serazene podle oddeleni    
  }   
 elseif (psSymName="@NAZEVSZP")
  { ; vrati se nazev szp
    s ret=""
    s ret=$$$getTagX(.handle,"463/200a")
    s ret=$tr(ret,""",","")
    q ret   ; vratime autory serazene podle oddeleni    
  }   
  elseif ($f(psSymName,"@HODKRIT_"))
  { ; 18.10.17 tt; zalozen sloupec pro zobrazeni hodnoticich kriterii ze zdroje 
    s ret=""
    ; 28.11.17 tt; upraveny podminky pro dotahovani T16r
    ; 23.11.17 tt; upraven rok kriterii na T16r pro hodnotici kriteria
    s sT16a=$$$getTagX(.handle,"T16r")
    q:(sT16a="") ret
    s sLX463001=$$$getTagX(.handle,"463/001")

    if (sLX463001'="")
    { ; pokud ma clanek zdrojovy dokument
      if ##class(User.MARC).readLX(.handle4,sLX463001)
      { ; nacteme 
        s nCi=##class(User.MARC).recordLineCountX(.handle4) ; ziskani poctu radku v zaznamu 
        f iii=1:1:nCi 
        { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
          s lsLine=##class(User.MARC).getLineX(.handle4,iii) continue:lsLine="" 
          s sTag=$e(lsLine,1,3)

          if (sTag="978")
          {
            s sa=$$$getSubTagStr(lsLine,"a")     ; rok hodnoticich kriterii
            continue:(sT16a'=sa)
            s sSubT=$p(psSymName,"@HODKRIT_",2)
            s sx=$$$getSubTagStr(lsLine,sSubT) 
            s ret=sx
          }
        }         
      }
    }
    
    
    q ret   ; vratime autory serazene podle oddeleni    
  }    
  ; kdyz jsme se dostali az sem, symbolik (tady) neni definovany    
  s pnHandled=0    ; osetrime navratove hodnoty
  q ""
]]></Implementation>
</Method>

<Method name="get978Last">
<Description><![CDATA[
<pre> Metoda pro dohledani roku a subtagu, ktery je nejaktualnejsi - posledni nejvyssi rok
parametry: handle   - aktualni zpracovavany handle
           pST      - subtag, ktery se ma vratit
           pRok     - 0 - vrati hodnotu subtagu pST/1 - vrati hodnotu roku pro subtag pST

19.10.21 tt; přidány symboliky pro hodnotící kritéria - vrátí nejnovější. Založena metoda get978Last
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,pST="",pRok=0]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 s qRet="",sRet=""
 s sT=##class(User.MARC).getTagX(.handle,"978",-1) q:(sT="") ""
 s nNtag=$l(sT,$c(10))             ; pocet opakovani tagu
 s sData=""
 
 f i=1:1:nNtag 
 { ; pres vsechny opakovani tagu
   s sT1=$p(sT,$c(10),i)
   continue:(sT1="")
   
   s sSTa=$$$getSubTagStr(sT1,"a")
   continue:(sSTa="")
   s sData(sSTa)=sT1 
 } 
 
 for
 {
   s sRet=$o(sData(sRet),-1) q:(sRet="")  ;prochazime od posledniho roku     
   s sHod=sData(sRet)
   if ((sHod'="")&&(pST'=""))
   {
     s sSThod=##class(User.MARC).getSubTagStr(sHod,pST)
     if (sSThod'="")
     { ; pokud mame hodnotu vyplnenou, vyhravame
       if (pRok=0)
       { ; provedeno naplneni navratove hodnoty hodnotou  
         s qRet=sSThod
       }
       else
       { ; navratova hodnota jako rok
         s qRet=sRet
       }
     }     
   }
   ; ukonceni, pokud mame nalezene hodnoty
   s:(qRet'="") sRet=""     ; mozna zbytecna pojistka
   q:(qRet'="") 
 } 

 q qRet
]]></Implementation>
</Method>

<Method name="symZbOprava463200a">
<Description>
oprava 463/200a podla starsej konverzie - jednoucelovy symbolik
02.02.07 rs
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    s T463=##class(MARC).getTagX(.handle,"463") if T463="" zt "X"
    s T463O=##class(MARC).getTagX(.handle,"CavUnEpca2@463") if T463O="" zt "X2"
    
    if '##class(MARC).t4xx2handle(.h,T463)  zt "Z1"
    if '##class(MARC).t4xx2handle(.ho,T463O) zt "Z2"
    s T200O=##class(MARC).getTagX(.ho,"200") if T200O="" zt "z3"
    s T200Oa1=##class(MARC).getSubTagStr(.T200O,"a")
    s T200Oa2=##class(MARC).getSubTagStr(.T200O,"a")
    
    s T200=##class(MARC).getTagX(.h,"200") if T200="" zt "z4"
    s T200=##class(MARC).setSubTagStr(T200,$c(31)_"a"_T200Oa1)
    d ##class(MARC).setTagX(.h,T200) 
    if (T200Oa2'="")
    {
        s s300a=$$$trim(##class(MARC).getTagX(.handle,"300a")) if s300a="-" s s300a=""
        s s="Uvedeno ve sborníku: "_T200Oa2
        if s300a'="" s s=s300a_", uvedeno ve sborníku: "_T200Oa2
        
        d ##class(MARC).setTagX(.handle,"300    "_$c(31)_"a"_s)
    }
    d ##class(MARC).recordSetupT001X(.h,"") ; tiez vymaz 463/001
    d ##class(MARC).sortLinesX(.h)

    s T463=##class(MARC).handle2t4xx(.h,$e(T463,1,3)_$e(T463,5,6)) 
    d ##class(MARC).setTagX(.handle,T463)
]]></Implementation>
</Method>

<Method name="sym463toZRP">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    s sT4xxVal=##class(MARC).getTagX(.handle,"463") q:sT4xxVal=""
    
    if '##class(MARC).t4xx2handle(.h4,sT4xxVal)  zt "Z1"
    s sAuthT001=$$$HandleT001(h4)
    if sAuthT001="" q ; nie je co dotiahnut
    
    s sAuthKeyX=$$$HandleClass(h4)_"*"_sAuthT001
    ; ak cielovy zaznam nenajdeme - ignorovat
    if '##class(MARC).readLX(.h,sAuthKeyX) q
    
    ;** OK mame rozkodovanu 4xx a cielovy zaznam
    s c=##class(MARC).recordLineCountX(.h4)
    for i=1:1:c
    {
        s sLine=##class(MARC).getLineX(.h4,i)
        s sTag=$e(sLine,1,3)
        
        ; kazdy tag len 1x
        if $d(bDone(sTag)) continue
        s bDone(sTag)=""
        
        ; v Line sice mame tag, ale niektore mozu byt opakovatelne - napr. 702
        ; takze precitame vsetky opakovania
        s sLine2=##class(MARC).getTagX(.h4,sTag,-1)
        
        ; v zdrojovom zazname je?
        if ##class(MARC).getTagX(.h,sTag)'="" continue
        
        ; toto je speci vynimka pra AVCR/CAV - ak je to ISSN,ISBN a je rovne "-:
        ; tak ignorovat
        if ((sTag="010") || (sTag="011"))
        {
          continue:(##class(MARC).getSubTagStr(sLine,"a")="-")
          continue:((##class(MARC).getSubTagStr(sLine,"e")="-")&&(sTag="011"))
        }
        
        w !,$$$HandleT001(handle)_" adding to "_sAuthT001_" "_$tr(sLine2,$c(31,10),"$#")
        d ##class(MARC).setTagX(.h,sLine2)
        
        ;if $f(sLine2,$c(10)) b
    }
    if ##class(MARC).recordModifiedX(.h)
    {
        w !,"ZAPIS "_sAuthT001
        d ##class(MARC).sortLinesX(.h)
        s sDescr="doplnenie udajov z clanok/463 do SZP"
        
        ;******ZMENIT
        s sUser="spiegel"
        ;******
        
        
        s sChronMode=3_$c(10)_sUser_$c(10)_sDescr_" - ##class(CavUnEpca).sym463toZRP()"
        d ##class(MARC).writeX(.h,,,,sChronMode)
        ;
        ; toto je len aby to zostalo v selecte
        d ##class(MARC).recordSetupModifiedX(.handle,1)
    }
]]></Implementation>
</Method>

<Method name="symCleanUp">
<Description><![CDATA[
<pre>Doplnok cistenia 4xx pre CAV

09.02.16 tt; odstranena aktualizace oddeleni
21.01.16 tt; rozsirene kontroly jen pro zaznamy, ktere pujdou ulozit a maji validni ISSN
19.01.16 tt; upraveno filtrovani pro uxx a txx + upraveno dotahovani informaci do autoru
23.04.07 rs; doplnenie 102a do clanku zo SZP aj v ramci cistenia autorit
21.03.07 rs; zapojene naostro ako extension cistenia autorit
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    ; zapnut/vypnut testovaci vypis - moze mat 2 formaty - viz. symCleanup4xxPrintDiffs()
    ; (pre prve ladenie na danej instalacii, je dobre si zapnut debug vypis)
    s DBG=0
    //b ;111
    
    d ##class(SPCommon).symCleanup4xx(.handle,"463","200v","00*,1**,3**,4**,6**,8**,9**,C**,c**,U**,u**,T**,t**",DBG)

    ; 23.04.07 rs; doplnenie 102a do clanku zo SZP aj v ramci cistenia autorit
    d ..createAuthLinks463fix102a(.handle)
    /*s sT011=$$$getTagX(.handle,"011")
    s sErr=##class(User.SPIntegrit).allowSaveCheckIsbn(.handle,"N",1)
    if ((sErr'="")&&(sT011'=""))
    {
        
    }*/
    s sTC26=$$$getTagX(.handle,"C26")
    if (sTC26'="")
    {
      s sT969f=$$$getTagX(.handle,"969f")
      s sT001=$$$HandleT001(handle)       ; ziskani t001
      s sClass=$$$HandleClass(handle)     ; ziskani tridy
     /* if ##class(User.MARC).readX(.handleUS,sClass,sT001)
      { ; pokud se podari otevrit puvodni handle, muzeme zmenit stav
        s sT969fo=$$$getTagX(.handleUS,"969f")
        d ..allowSaveExFormN(.handle,.handleUS, sT969f,sT969fo)
      }*/
    
      s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
      f i=1:1:nC 
      { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
        s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
        s sTag=$e(lsLine,1,3), sOldLine=lsLine
        if $e(sTag,1,2)="70"
        { ; pokud tag zacina 70 je to autorita a zkusime dotahnout
          s sT7xx3=$$$getSubTagStr(lsLine,"3")
          if (sT7xx3'="")
          {
            if ##class(MARC).readLX(.ahandle,sT7xx3) 
            { ; dotazeni zeme a oddeleni
              s tc06=$$$getTagX(.ahandle,"C06")
              s lo=$$$getSubTagStr(tc06,"h")
              //s:(lo'="") lsLine=$$$setSubTagStr(lsLine,$c(31)_"o"_lo)
              s ld=$$$getSubTagStr(tc06,"d")
              //s:((ld'="")&&('$f(lsLine,$c(31)_"p"_ld))) lsLine=$$$setSubTagStr(lsLine,$c(31)_"p"_ld)           
              s ly=$$$getSubTagStr(tc06,"y")
              s:(('$f(lsLine,$c(31)_"p"))&&(ly'="")) lsLine=$$$setSubTagStr(lsLine,$c(31)_"y"_ly)
            }
          }
        }
        d:(sOldLine'=lsLine) ##class(User.MARC).setLineX(.handle,i,lsLine) ; zapsani to radku
      }
    }
]]></Implementation>
</Method>

<Method name="getDupCheckKeyBXXS">
<Description><![CDATA[
<pre>Deduplikacny kluc pre zbornik
viz popis v https://cosmo2/wiki/index.php/Cust:CAV - v pripade zmien aktualizovat!

14.03.14 tt; zmena ve tvoreni vyhledavaciho klice + 200h
09.03.07 rs;
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  ; funkcia na upravu stringu - vypustenie interpunkcie + + medzery locase
  #define FX(%s,%n) $e($zcvt($tr(%s,"/.,:-[]' "";()&!`~*_%="),"L"),1,%n)
  ; celkova max.dlzka vysl.kluca pozor NESMIE sa dat vacsia, ako je max.dlzka termu v indexoch
  #define MXL    $$$MarcMaxIdxTermLen 
  #define MXLTit 25
  s sT010a=$$$FX(##class(MARC).getTagX(.handle,"010a"),14)
  s sT011a=$$$FX(##class(MARC).getTagX(.handle,"011a"),8)
  s:(sT011a="") sT011a=$$$FX(##class(MARC).getTagX(.handle,"011e"),8)
  s sT210d=$$$FX(##class(MARC).getTagX(.handle,"210d"),4)
  /// 14.03.14 tt; zmena ve tvoreni vyhledavaciho klice + 200h
  s sT200h=$$$FX(##class(MARC).getTagX(.handle,"200h"),8)

  
  ; kolko znakov este mozeme dat na nazov
  s nLN0=$l(sT010a)+$l(sT011a)+$l(sT210d)+$l(sT200h),nLN=$$$MXL-nLN0
  s sT200a=$$$FX(##class(MARC).getTagX(.handle,"200a"),999)
  if $l(sT200a)>nLN
  {
      ; prvych X a poslednych Y znakov tak, aby celk. dlzka z nazvu bola max. nLN
      s nLN1=nLN-$$$MXLTit
      s sT200a=$e(sT200a,1,$$$MXLTit)_$e(sT200a,$l(sT200a)-nLN1+1,9999)
  }
  
  s sTerm=sT010a_""
         _sT011a_""
         _sT210d_""
         _sT200h_""
         _sT200a
  
  if $l(sTerm)>$$$MarcMaxIdxTermLen zt "X" ; poistka
  q sTerm
]]></Implementation>
</Method>

<Method name="getDupCheckKey">
<Description><![CDATA[
<pre>Deduplikacny kluc pre zborniky

04.12.07 rs; vynimka na ISSN obsahujuce "N" (nepriradene ISSN)
09.03.07 rs; doplnenie parametra a 2 rozne algoritmy pre zborniky (bxxs) a casopisy
             (bxx a bca)
08.03.07 rs; doplnenie 210$d + prepisanie funkcie
30.11.06 mk; nova metoda na upravu nazvu pre indexovanie a porovnavanie duplicit
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,psDK]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  ; funkcia na upravu stringu - vypustenie interpunkcie + + medzery locase
  #define FX(%s,%n) $e($zcvt($tr(%s,"/.,:-[]' "";()&!`~*_%="),"L"),1,%n)
  
  ; v pripade, ze ideme z0 4xx tak 970 nepozname - vtedy ho urcujeme parametrom
  ; inak ho zistime z 970b (t.j. pokial nie je uvedeny parameter berieme 970b)
  if '$d(psDK) s psDK=##class(MARC).getTagX(.handle,"970b")
  
  s psDK=$zcvt(psDK,"L")
  if psDK="bxxs" q ..getDupCheckKeyBXXS(.handle)
  if (psDK="bxx") || (psDK="bca") 
  {
      s sT011a=$$$FX(##class(MARC).getTagX(.handle,"011a"),14)
      s:(sT011a="") sT011a=$$$FX(##class(MARC).getTagX(.handle,"011e"),14)
      ; 04.12.07 rs; vynimka na ISSN obsahujuce "N" (nepriradene ISSN)
      if sT011a="n" s sT011a=""
      q sT011a
  }
  
  // pre ine typy nevyhodnocujeme
  q ""
]]></Implementation>
</Method>

<Method name="exportRIScitacie">
<Description><![CDATA[
<pre>
31.05.14 tt; pridane do RIS prvek AN
12.04.07 mk; nova metoda na export zaznamov do RIS citacie
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  if pnWhat=$$$I2ExportHdr    q
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie
  
  s recdelim=""

  s rec=..exportRIS(.handle,"TY,T1,JF,VL,IS,SP,PY,A1,AN,N1,UR,ER,DO")
  d ##class(i2.export).outputAdd(rec,pnOutFmt)
  ;d ##class(i2.export).outputAdd(recdelim_$$$CRLF,pnOutFmt)
]]></Implementation>
</Method>

<Method name="exportRISuplny">
<Description><![CDATA[
<pre>
31.05.14 tt; pridane do RIS prvek AN
12.04.07 mk; nova metoda na export zaznamov do RIS uplny
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  if pnWhat=$$$I2ExportHdr    q
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie
  
  s recdelim=""
  ;n12 - je rozsireny format
  s rec=..exportRIS(.handle,"TY,T1,JA,JF,T3,VL,IS,SP,CY,PB,PY,A1,A2,SN,AD,Y2,AB,AN,KW,N12,UR,ER,DO")
  d ##class(i2.export).outputAdd(rec,pnOutFmt)
]]></Implementation>
</Method>

<Method name="exportRIScitacieASCII">
<Description><![CDATA[
<pre>
10.06.14 tt; upraven text o diakritiku
31.05.14 tt; pridane do RIS prvek AN
18.04.07 mk; nova metoda na export zaznamov do RIS citacie bez diakritiky
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  if pnWhat=$$$I2ExportHdr    q
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie
  
  s recdelim=""

  s rec=..exportRIS(.handle,"TY,T1,JF,VL,IS,SP,PY,A1,AN,N1,UR,ER,DO")
   ; 10.06.14 tt; upraven text o diakritiku
  s rec=$tr(rec,"ÁÉÍÓÚÝČĎĚŇŘŠŤŽŮÅŠŽÕÄÖÜÀÂÇÉÈÊËÎÏÔÙÛÜŽŠČĆĐĀĒĪŪČŠŽĻĶŅĢÖÜŐŰÄÖÜËÏĄĆĘŁŃÓŚŹŻĂÂÎȘȚÁÄČĎÉÍĹĽŇÓÔŔŠŤÚÝŽÑÅÄÖÇŞĞĂÂĐÊÔƠƯ"
               ,"AEIOUYCDENRSTZUASZOAOUAACEEEEIIOUUUZSCCDAEIUCSZLKNGOUOUAOUEIACELNOSZZAAISTAACDEILLNOORSTUYZNAAOCSGAADEOOU")

  s rec=##class(User.Util).diaTRUni(rec)
  d ##class(i2.export).outputAdd(rec,pnOutFmt)
  ;d ##class(i2.export).outputAdd(recdelim_$$$CRLF,pnOutFmt)
]]></Implementation>
</Method>

<Method name="exportRISuplnyASCII">
<Description><![CDATA[
<pre>
10.06.14 tt; upraven text o diakritiku
31.05.14 tt; pridane do RIS prvek AN
18.04.07 mk; nova metoda na export zaznamov do RIS uplny bez diakritiky
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  if pnWhat=$$$I2ExportHdr    q
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie
  
  s recdelim=""
  ;n12 - je rozsireny format
  s rec=..exportRIS(.handle,"TY,T1,JA,JF,T3,VL,IS,SP,CY,PB,PY,A1,A2,SN,AD,Y2,AB,AN,KW,N12,UR,ER,DO")
  ; 10.06.14 tt; upraven text o diakritiku
  s rec=$tr(rec,"ÁÉÍÓÚÝČĎĚŇŘŠŤŽŮÅŠŽÕÄÖÜÀÂÇÉÈÊËÎÏÔÙÛÜŽŠČĆĐĀĒĪŪČŠŽĻĶŅĢÖÜŐŰÄÖÜËÏĄĆĘŁŃÓŚŹŻĂÂÎȘȚÁÄČĎÉÍĹĽŇÓÔŔŠŤÚÝŽÑÅÄÖÇŞĞĂÂĐÊÔƠƯ"
               ,"AEIOUYCDENRSTZUASZOAOUAACEEEEIIOUUUZSCCDAEIUCSZLKNGOUOUAOUEIACELNOSZZAAISTAACDEILLNOORSTUYZNAAOCSGAADEOOU")
  s rec=##class(User.Util).diaTRUni(rec)
  d ##class(i2.export).outputAdd(rec,pnOutFmt)
]]></Implementation>
</Method>

<Method name="exportRIS">
<Description><![CDATA[
<pre>
23.01.18 jk; presunuto do IctxUnTablesd
03.07.14 tt; pridan oddelovac na konec
30.06.14 tt; upravy RIS podle cs28864 
31.05.14 tt; pridane do RIS prvek AN
12.04.07 mk; nova univerzalna metoda na export zaznamov do RIS
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,psFieldList]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s ris=""
  ; psFieldList obsahuje skratky poli co sa maju exportovat oddelene ciarkou
  ; napr "TY,T1,JF,VL,IS,SP,EP,PY,AU,NI,UR,ER" 
  if psFieldList="" q ris
  
  ; cast dotiahnutia potrebnych tagov na export
  s t101=##class(MARC).getTagX(.handle,"101")
  s t102a=##class(MARC).getTagX(.handle,"102a")
  s t200=##class(MARC).getTagX(.handle,"200")
  s t210=##class(MARC).getTagX(.handle,"210")
  s t225=##class(MARC).getTagX(.handle,"225")
  s t463all=##class(MARC).getTagX(.handle,"463",-1)
  s pocet463=$l(t463all,$c(10))   ; pocet opakovani 463 tagu
  s t700=##class(MARC).getTagX(.handle,"700")
  s t701all=##class(MARC).getTagX(.handle,"701",-1)
  s t702all=##class(MARC).getTagX(.handle,"702",-1)
  s tC32all=##class(MARC).getTagX(.handle,"C32",-1)
  s tC15=##class(MARC).getTagX(.handle,"C15")
  s t610all=##class(MARC).getTagX(.handle,"610a",-1)
  s t856all=##class(MARC).getTagX(.handle,"856u",-1)
  s tC20=##class(MARC).getTagX(.handle,"C20") ; len prve opakovanie pripadneho mv
  s t017=##class(MARC).getTagX(.handle,"017")
  
  s odd=$$$CRLF  ; oddelovac riadkov
  s sirka=70
  
  ; riesit usporiadanie aj ked parametre nie su zotriedene.
  
  
  if $f(psFieldList,"TY")  ; druh dokumentu
  {
    s sDruh=$e(##class(MARC).getTagX(.handle,"970b"),1)
    s typ=""
    if sDruh="A" s typ="ABST"
    if sDruh="E" s typ="ADVS"
    if (sDruh="B") || (sDruh="G") || (sDruh="H") || (sDruh="I") || (sDruh="T") s typ="BOOK"
    if sDruh="M" s typ="CHAP"
    if (sDruh="C") || (sDruh="K") s typ="JOUR"
    if sDruh="W" s typ="INPR"
    if sDruh="J" s typ="JOUR"
    if sDruh="P" s typ="PAT"
    if sDruh="V" s typ="RPRT"
    if sDruh="D" s typ="THES"
    if sDruh="N" s typ="NEWS"
    
    s ris=ris_odd_"TY  - "_typ      
  }
    
  
  if $f(psFieldList,"T1")  ; nazov dokumentu
  {
    s ta=##class(MARC).getSubTagStr(t200,"a") 
    if ta'="" s ris=ris_odd_..textFmt("TI  - "_ta,sirka)  
  }
  
  
  if $f(psFieldList,"T3")  ; dalsi nazov dokumentu
  {
    if (sDruh="C") || (sDruh="K") || (sDruh="G") || (sDruh="H")   
    {  
      s ta=##class(MARC).getSubTagStr(tC20,"a") 
      if ta'="" s ris=ris_odd_..textFmt("T3  - "_ta,sirka)  
    }  
    if (sDruh="M") || (sDruh="B") || (sDruh="V") || (sDruh="T") || (sDruh="I")
    {
      s ta=##class(MARC).getSubTagStr(t225,"a") 
      s tv=##class(MARC).getSubTagStr(t225,"v") 
      if tv'="" s ta=ta_", "_tv
      if ta'="" s ris=ris_odd_..textFmt("T3  - "_ta,sirka)  
    }
  }
  
  if $f(psFieldList,"JA")  ; skrateny nazov casopisu v autorite
  {
    s pocetC32=$l(tC32all,$c(10))     
    f i=1:1:pocetC32
    {  
       s tC32=$p(tC32all,$c(10),i)
       s ta=##class(MARC).getSubTagStr(tC32,"a") 
       s tx=##class(MARC).getSubTagStr(tC32,"x")
       if (ta'="") && (tx="3") s ris=ris_odd_..textFmt("JA  - "_ta,sirka) ; len tie, ktore maju x = 3 
    }
  }
  
  f i=1:1:pocet463  ; zaciatok cyklu 463
  {
    s t463=$p(t463all,$c(10),i)  ; jedno opakovanie tagu a jeho spracovanie
    s t463200=##class(MARC).getTag4xx(t463,"200")
    s t463011=##class(MARC).getTag4xx(t463,"011")
    if t463011'="" s t463011=t463011_" (ISSN)"
    s t463010=##class(MARC).getTag4xx(t463,"010")
    if t463010'="" s t463010=t463010_" (ISBN)"
    if t463010'="" 
    {
      if t463011'=""
      { 
        s t463011=t463011_"; "_t463010   
      }  
      else
      {
        s t463011=t463010   
      }  
        
    }    
    ;if t463011="" s t463011=##class(MARC).getTag4xx(t463,"010")
    s t463210=##class(MARC).getTag4xx(t463,"210")


    if $f(psFieldList,"JF")  ; nazov casopisu
    {
      s t463200a=$p(t463200,$c(31)_"a",2)
      s t463200a=$p(t463200a,$c(31),1)
      /*
      if sDruh="M"
      {
         if t463200a'="" s ris=ris_odd_..textFmt("T2  - "_t463200a,sirka)  
      }
      else
      {
         if t463200a'="" s ris=ris_odd_..textFmt("JF  - "_t463200a,sirka)  
      }  */
      ; 30.06.14 tt; zmena JF změnit na T2
      if t463200a'="" s ris=ris_odd_..textFmt("T2  - "_t463200a,sirka)  
    }
    s t463200v=$p(t463200,$c(31)_"v",2)
    s t463200v=$p(t463200v,$c(31),1)
    s t463200v=##class(User.Util).strswap(t463200v,"vol.","roč.")
    s t463200v=##class(User.Util).strswap(t463200v,"no.","č.")
    s t463200v=##class(User.Util).strswap(t463200v,"p.","s.")
    
    if $f(psFieldList,"VL")  ; rocnik z 463200v
    {
      s rocnik=$p(t463200v,",",1)
      if $f($zcvt(rocnik,"l"),"roč") 
      {
        s rocnik=$$$trim($p(rocnik," ",2))
      }
      else
      {
        s rocnik=""  
      }     
      ; riesenie dalsich druhov dokumentov bud 463200h, alebo len 200h
      if rocnik=""
      {
        s t463200h=$p(t463200,$c(31)_"h",2)
        s t463200h=$p(t463200h,$c(31),1)
        if t463200h'="" s rocnik=t463200h
      }
      if rocnik=""
      {
          s th=##class(MARC).getSubTagStr(t200,"h") 
          if th'="" s rocnik=th 
      }
      if rocnik'="" s ris=ris_odd_..textFmt("VL  - "_rocnik,sirka) 
    }
    
    if $f(psFieldList,"IS")  ; cislo z 200v
    {
       s poradie=2 
       if $f($zcvt(t463200v,"l"),"roč") s poradie=3 
       s cislo=$p(t463200v,"č.",poradie)  ; cislo riesene podla c (este treba osetrit aj dalsie varianty
       s cislo=$$$trim($p(cislo,",",1))
       s cislo=$$$trim($p(cislo,"(",1))
       if cislo'="" s ris=ris_odd_..textFmt("IS  - "_cislo,sirka)  
       if cislo=""
       {
         s t463200h=$p(t463200,$c(31)_"h",2)
         s t463200h=$p(t463200h,$c(31),1)
         if t463200h'="" s ris=ris_odd_..textFmt("IS  - "_t463200h,sirka)  
       }
    }
    if $f(psFieldList,"SP")  ; strana od z 200v
    {
      s stranaod=$p(t463200v,"s.",2)
      s stranaod=$$$trim($p(stranaod,",",1))
      s stranado=$$$trim($p(stranaod,"-",2))
      s stranaod=$$$trim($p(stranaod,"-",1))
      s:(stranado'="") stranado="-"_stranado
      ; 30.06.14 tt; Zrušit EP, rozsah stran dát do SP - 2973-2988
      s:((stranaod'="")||(stranado'="")) ris=ris_odd_..textFmt("SP  - "_stranaod_stranado,sirka)  
    }
    if $f(psFieldList,"EP")  ; strana do z 200v
    {  ; 30.06.14 tt; Zrušit EP, rozsah stran dát do SP - 2973-2988
       ; pro jistotu zrusit EP
      /* 
      s stranado=$p(t463200v,"s.",2)
      s stranado=$$$trim($p(stranado,",",1))
      s stranado=$$$trim($p(stranado,"-",2))
      if stranado'="" s ris=ris_odd_..textFmt("EP  - "_stranado,sirka) */
   }
    
    if $f(psFieldList,"PY")  ; rok z 463200v, alebo 463210d alebo 210d
    { ; 30.06.14 tt; odstraneny lomitka z roku
      s rok=$p(t463200v,"(",2)
      s rok=$$$trim($p(rok,")",1))
      if rok'="" s ris=ris_odd_..textFmt("PY  - "_rok,sirka)  
      if rok=""
      {
        s t463210d=$p(t463210,$c(31)_"d",2)
        s t463210d=$p(t463210d,$c(31),1)
        if t463210d'="" s ris=ris_odd_..textFmt("PY  - "_t463210d,sirka)  
      }
      if rok=""
      {
         s t210d=##class(MARC).getSubTagStr(t210,"d") 
         if t210d'="" s ris=ris_odd_..textFmt("PY  - "_t210d,sirka)  
      }
    }
        
    if $f(psFieldList,"CY")  ; miesto vydania 463210a
    {
      if (sDruh="C") || (sDruh="K") || (sDruh="G") || (sDruh="H")
      {
          s tC20e=##class(MARC).getSubTagStr(tC20,"e") 
          s tC20p=##class(MARC).getSubTagStr(tC20,"p") 
          if tC20e'="" 
          {
             if tC20e'="" s tC20e=tC20e_" ("_tC20p_")" 
             s ris=ris_odd_..textFmt("CY  - "_tC20e,sirka)  
          }
      }
      else
      {
          s t463210a=$p(t463210,$c(31)_"a",2)
          s t463210a=$p(t463210a,$c(31),1)
          if t463210a=""
          {
             s t463210a=##class(MARC).getSubTagStr(t210,"a") 
          }
          if t463210a'="" 
          {
             if t102a'="" s t463210a= t463210a_" ("_t102a_")" 
             s ris=ris_odd_..textFmt("CY  - "_t463210a,sirka)  
          }
      }
 
    }
 
    if $f(psFieldList,"PB")  ; vydavatel 210c
    {
      s t463210c=$p(t463210,$c(31)_"c",2)
      s t463210c=$p(t463210c,$c(31),1)
      if t463210c'="" s ris=ris_odd_..textFmt("PB  - "_t463210c,sirka)  
      if t463210c=""
      {
         s t210c=##class(MARC).getSubTagStr(t210,"c") 
         if t210c'="" s ris=ris_odd_..textFmt("PB  - "_t210c,sirka)  
      }
    }

    
    if $f(psFieldList,"SN")  ; ISBN z 200v
    {
      s t463011a=$p(t463011,$c(31)_"a",2)
      s:(t463011a="") t463011a=$p(t463011,$c(31)_"e",2)
      s t463011a=$p(t463011a,$c(31),1)
      if t463011a'="" s ris=ris_odd_..textFmt("SN  - "_t463011a,sirka)  
    }
    
  }  ;koniec cyklu 463
  s ad=""
  
  ; autori 700,701
  if $f(psFieldList,"A1")  ; autori
  {
    s autori=t700  
    if t701all'="" 
    {
      if autori'="" s autori=autori_$c(10)_t701all
      if autori="" s autori=t701all
    }       
    s pocetaut=$l(autori,$c(10)) ; pocet opakovani 
    f i=1:1:pocetaut
    {
      s aut=$p(autori,$c(10),i)
      s ta=##class(MARC).getSubTagStr(aut,"a")
      s tb=##class(MARC).getSubTagStr(aut,"b")
      s tg=##class(MARC).getSubTagStr(aut,"g")
      s tT=##class(MARC).getSubTagStr(aut,"T")
      if tT'="" 
      {
        if $f(ad,tT)<1 
        {
          if ad'="" s ad=ad_$c(31)_tT   
          if ad="" s ad=tT     
        }  
      }    
      s aut=ta
      s znak=","
      if aut="" s znak=""
      if tb'="" s aut=aut_znak_tb
      if aut="" s znak=""
      if tg'="" s aut=aut_znak_tg  ; inicialy
      
      ; 30.06.14 tt; A1 změnit na AU  
      if aut'="" s ris=ris_odd_..textFmt("AU  - "_aut,sirka)  
    }    
  }
  ; autori 702
  if $f(psFieldList,"A2")  ; autori
  {
    s autori=t702all  

    s pocetaut=$l(autori,$c(10)) ; pocet opakovani 
    f i=1:1:pocetaut
    {
      s aut=$p(autori,$c(10),i)
      s ta=##class(MARC).getSubTagStr(aut,"a")
      s tb=##class(MARC).getSubTagStr(aut,"b")
      s tg=##class(MARC).getSubTagStr(aut,"g")
      s tT=##class(MARC).getSubTagStr(aut,"T")
      if tT'="" 
      {
        if $f(ad,tT)<1 
        {
          if ad'="" s ad=ad_$c(31)_tT   
          if ad="" s ad=tT     
        }  
      }    
      s aut=ta
      s znak=","
      if aut="" s znak=""
      if tb'="" s aut=aut_znak_tb
      if aut="" s znak=""
      if tg'="" s aut=aut_znak_tg  ; inicialy
        
      if aut'="" s ris=ris_odd_..textFmt("A2  - "_aut,sirka)  
    }    
  }
  if ad'="" 
  {
    s pocetad=$l(ad,$c(31))
    f j=1:1:pocetad
    {
       s ads=$p(ad,$c(31),j)    
       if ads'="" s ris=ris_odd_..textFmt("AD  - "_ads,sirka)   
    }
  }   

  if $f(psFieldList,"Y2")  ; C20f prvy datum
  {
    s tf=##class(MARC).getSubTagStr(tC20,"f") 
    s:($f(tf,"-")) tf=$p(tf,"-",1)
    if tf'=""
    {
      s rok=$p(tf,".",3)
      s mesiac=$p(tf,".",2) 
      s den=$p(tf,".",1)    
      s tf=rok_"/"_mesiac_"/"_den_"/"   
    }       
    if tf'="" s ris=ris_odd_..textFmt("Y2  - "_tf,sirka)  
  }
   
  if $f(psFieldList,"AB")  ; abstrakt
  {
    s ta=##class(MARC).getSubTagStr(tC15,"a") 
    if ta'="" s ris=ris_odd_..textFmt("AB  - "_ta,sirka)  
  }
  
  ; 31.05.14 tt; pridane do RIS prvek AN
  if $f(psFieldList,"AN")  ; abstrakt
  { ; AN  - Accession Number
    ; AN - WOS:000330556000006
    ; 014     $a000330556000006 $2WOS  
    s c=0
    d {
      s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
      continue:((sT014="")&&(c'=0))
      if (sT014'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        s sT0142=$$$getSubTagStr(sT014,"2")
        if (sT0142="WOS")
        { ; pokud je to WOS, exportujeme
          s sT014a=$$$getSubTagStr(sT014,"a") 
          s:(sT014a'="") ris=ris_odd_..textFmt("AN  - WOS:"_sT014a,sirka)  
        }        
      }
    } while (c'=0)    
  }
  
  if $f(psFieldList,"KW")  ; klucove slova
  {
    s pocet610=$l(t610all,$c(10)) ; pocet opakovani 
    f i=1:1:pocet610
    {
      s ta=$p(t610all,$c(10),i) 
      if ta'="" s ris=ris_odd_..textFmt("KW  - "_ta,sirka)  
    }    
  }
  if $f(psFieldList,"N1")  ; exportne informacie
  {
      
    s datum=$p($zdatetime($h,8)," ",1) 
    s den=$e(datum,7,8)
    s mesiac=$e(datum,5,6)
    s rok=$e(datum,1,4)
    if mesiac="01" s mesiac="January"
    if mesiac="02" s mesiac="February"
    if mesiac="03" s mesiac="March"
    if mesiac="04" s mesiac="April"
    if mesiac="05" s mesiac="May"
    if mesiac="06" s mesiac="Juny"
    if mesiac="07" s mesiac="July"
    if mesiac="08" s mesiac="August"
    if mesiac="09" s mesiac="September"
    if mesiac="10" s mesiac="October"
    if mesiac="11" s mesiac="November"
    if mesiac="12" s mesiac="December"
    s datum=den_" "_mesiac_" "_rok
    
    s ris=ris_odd_"N1  - "_"Export Date: "_datum    
    s ris=ris_odd_"N1  - "_"Source: ARL-ASEP"
    
    ; ni2 rozsirenie navestia u uplneho zaznamu
    if $f(psFieldList,"N12")
    {   
      s ta=##class(MARC).getSubTagStr(t101,"a") 
      ; previest jazyk na text z kodu z ciselnika
      s ipref=##class(User.Util).getClassPrefixParam($$$HandleClass(handle))
      ; 23.01.18 jk; presunuto do IctxUnTablesd
      ; text z cisleniku v anglictine 
      s ta=##class(Util).sXlate("UT_LANGUAGE",ta,"",ipref,"",3) 
      if ta'="" s ris=ris_odd_"N1  - Language of Original Document: "_ta       
    }  
  }

  if $f(psFieldList,"DO")  ; url adresy
  { ; 30.06.14 tt; pridan export DOI
    if t017'="" ; DOI
    { ; Doplnit DOI ve tvaru DO - 10.1007/978-3-642-31603-6_18 (nyní je v poli N1)
      s ta=##class(MARC).getSubTagStr(t017,"a") 
      s t2=##class(MARC).getSubTagStr(t017,"2")
      if ((t2="DOI")&&(ta'=""))
      {
        s ris=ris_odd_"DO  - "_ta  
      }
    } 
  }

   
  if $f(psFieldList,"UR")  ; url adresy
  {
    s pocet856=$l(t856all,$c(10)) ; pocet opakovani 
    f i=1:1:pocet856
    {
      s tu=$p(t856all,$c(10),i) 
      if tu'="" s ris=ris_odd_..textFmt("UR  - "_tu,sirka)  
    }    
  }
  s ris=ris_odd_"ER  - "_odd
  
  ; 03.07.14 tt; pridan oddelovac na konec
  ; 30.06.14 tt; odstranen prvni prazdny radek
  s:($e(ris,1,$l(odd))=odd) $e(ris,1,$l(odd))=""
  q ris
]]></Implementation>
</Method>

<Method name="textFmt">
<Description><![CDATA[
<pre>
13.04.07 mk; metoda na zalamovanie textu na urcity pocet znakov
</pre>
]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>text:%String,dlzka:%Integer</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  if (text="") || (dlzka="") q text 
  
  s pocet=$l(text," ")  ; pocet slov v texte
  
  s odd=$$$CRLF  ; oddelovac riadkov
  s textn="",textr=""
  
  f i=1:1:pocet
  {
    s slovo=$p(text," ",i)
    s dlzka=$l(slovo)  ; dlzka slova  
    s dlzkat=$l(textr)  ; dlzka zatial ulozeneho textu
    if (dlzka+dlzkat+1)<=70    ; ak sa to vojde do aj s navestim
    {
      s textr=textr_" "_slovo   
    }
    else 
    {
      if textn'="" s textn=textn_odd_textr  
      if textn="" s textn=textr 
      s textr=slovo 
    }             
  }    
  if textr'="" 
  {
    if textn'="" s textn=textn_odd_textr    
    if textn="" s textn=textr 
  }   
  
  s textn=$$$trim(textn)

  q textn
]]></Implementation>
</Method>

<Method name="getDOIlink">
<Description>
toto je cisty link - da sa pouzit aj napr. do ineho ZF ako TF

23.05.13 tt; odstraneni fixupy kvuli spravnemu zobrazovani linku DOI
15.03.12 tt; upraveny link pro ipac2, aby se neodfiltrovavali znaky napr .b. atd.
04.03.08 rs; prepracovanie sposobu generovania odkazu na DOI resolver
27.04.07 mk</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    s ret=""
    s sT001=$$$HandleT001(handle)       ; ziskani t001
    s sClass=$$$HandleClass(handle)    ; ziskani tridy
    if ('##class(User.MARC).readX(.handleX,sClass,sT001))
    { ; nacteme neupraveny handle
      d ##class(User.MARC).mergeX(.handleX,.handle)
    }  
    s sDOI=##class(MARC).getTagX(.handleX,"017a")
    ; 23.05.13 tt; odstraneni fixupy kvuli spravnemu zobrazovani linku DOI
    ;s sDOI=##class(User.Util).XMLfixup(sDOI)
    ;s sDOI=##class(rep.zf.tf).stripHtmlTags(sDOI)
    if sDOI="" q ret
    s sDOI=$$$strswap(sDOI,".","&#46;")
    ;s sURL="https://dx.doi.org/openurl?url_ver=Z39.88-2003&rfr_id=ori:rid:crossref.org&rft_id="_$$$urlencode(sDOI)
    ;s sURL=sURL_"&rfr_dat=cr_setver%3d01%26cr_pub%3dSource%20Publisher%26cr_work%20Journal%20Title%26cr_scr%3dSRC-NAME"
    
    ; 04.03.08 rs; uprava URL podla dokumentacie http://www.crossref.org/02publishers/doi-guidelines.pdf
    ;              pouziva sa tzv. DOI proxy URL
    /// 06.11.23 tt; provedeno upraveni tvaru DOI dx.doi.org na doi.org
    s sURL="https://doi.org/"_sDOI

    ; 25.05.07 mi; zmena z doi.jpg na doi-ikona.gif kvoli priehladnosti, graficka uprava ikon
    s ret="<a href="""_sURL_""" target=""_blank"" title=""DOI""><img src="""_$$$BASEPURE_"user/cav/doi-ikona.gif"" alt=""DOI"" /></a> <a href="""_sURL_""" target=""_blank"">DOI: "_sDOI_"</a>"   
    s:(params="class") ret="<a href="""_sURL_""" target=""_blank""><span class=""icon-doi"" aria-hidden=""true""></span> DOI: "_sDOI_"</a>"   
    /// 11.08.22 tt; zpracovani logiky pridani DOI pro datove zaznamy
    s:(params="linkOnly") ret="<a href="""_sURL_""" target=""_blank"">"_"https://doi.org/"_sDOI_"</a>"   
    q ret
]]></Implementation>
</Method>

<Method name="fmtDOILink">
<Description>
blok do ZF

27.10.12 tt; pridano vysvetleni RIV a DOI
27.04.07 rs</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    ; 20.02.13 tt; specialni uprava pro tisk
    if params=("tisk")
    {
     q:($$$GETREQVAR("op")'="pr") ""
    }

    s ret=..getDOIlink(.handle,params) q:ret="" ""
    if params=("RIV")
    {
     s ret="DOI:"_$p(ret," alt=""DOI"" /></a> ",2)
     s ret=$$$strswap(ret,"target=""_blank"">DOI: ","target=""_blank"">")
     q ret
    }
    
    q "<abbr title=""Centralizovaný systém pro identifikaci autorsky chráněných děl"" lang=""cs-CZ"">DOI</abbr> : "_ret
]]></Implementation>
</Method>

<Method name="genSber">
<Description><![CDATA[
<pre>
30.05.07 mk; globalka na export dat pre zber urciteho roku - vypis projektu,
             ktere se nachazeji v zaznamech sber 2007
             T001;C12a;C12b;C12c;C12e
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 ; s sy="ret1=##class(CavUnEpca).genSber(.handle)"
 s t001=##class(MARC).recordT001X(.handle)
 s text=""

 s tC12all=##class(MARC).getTagX(.handle,"C12",-1) ; vsetky opakovania tagu 
 s pocet=$l(tC12all,$c(10))
 f i=1:1:pocet
 {
   s tC12=$p(tC12all,$c(10),i)  
   s ta=##class(MARC).getSubTagStr(tC12,"a")
   s tb=##class(MARC).getSubTagStr(tC12,"b")
   s tc=##class(MARC).getSubTagStr(tC12,"c")
   s te=##class(MARC).getSubTagStr(tC12,"e")
   
   s text=text_t001_";"_ta_";"_tb_";"_tc_";"_te_$c(13)_$c(10)
 }  
 
 q text
]]></Implementation>
</Method>

<Method name="genSberCEP">
<Description><![CDATA[
<pre>
12.06.07 lp; globalka na export dat pro zber urciteho roku - vypis
projektu CEP (maji vyplneno C12b v zaznamu), ktere jsou pouzity ve sberu 2007,
ale nemaji vyplneny v autorite projektu nazev v poli 230a
             T001;C12b;C12a
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s t001=##class(MARC).recordT001X(.handle)
 s text=""

 s tC12all=##class(MARC).getTagX(.handle,"C12",-1) ; vsetky opakovania tagu 
 s pocet=$l(tC12all,$c(10))
 f i=1:1:pocet
 {
   s tC12=$p(tC12all,$c(10),i)  
   s ta=##class(MARC).getSubTagStr(tC12,"a")
   s tb=##class(MARC).getSubTagStr(tC12,"b")
   
   ; kontrola 230a v autorite projektu
   s idx=" "_$zcvt(ta,"L")
   if $d(^$$$MarcIndexG("CavUnAuth","proj",idx))
   {
     s idAuth=$o(^$$$MarcIndexG("CavUnAuth","proj",idx,""))
     if ##class(MARC).getDATAX(.ahandle,idAuth)
     {
       s sNazev=##class(MARC).getTagX(.ahandle,"230a")
       s sNazev=##class(Util).trim($tr(sNazev,"-*"))
       ; kdyz je nazev neprazdny, pokracovat ve smycce
       if sNazev'="" continue
     }
   }
   ; nazev nenalezen, zapsat data do vystupu
   s text=text_t001_";"_tb_";"_ta_$c(13)_$c(10)
 }  
 
 q text
]]></Implementation>
</Method>

<Method name="exportSber">
<Description>
12.06.07 lp; export dat pro sber urciteho roku do txt souboru
pred spustenim exportu je potreba vyselektovat zaznamy z CavUnEpca
do activelistu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pFile:%String,pOption:%String="1"</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 if '##class(Util).XcheckActiveList(0) { 
   s err="ERR999#no record selected"
   w !,err q err
 } 

 s IO=$IO
 ; otevrit soubor pro vystup
 open pFile:("NWS":/CREATE):0
 if '$t {
   s err="ERR999#error opening file '"_pFile_"'"
   use IO w !,err q err
 }
 use IO

 s id=""
 for  
 {
   s id=$o(^$$$ListsG($$$ListsActiveSel,$j,id))
   q:id=""
   
   if $f(id,"*") s id=$p(id,"*",2) ;* odstranit triediaci prefix
   s err=""
   if '##class(MARC).getDATAX(.handle,id) continue
   
   s data=""
   if pOption="1" s data=..genSber(.handle)
   if pOption="2" s data=..genSberCEP(.handle)
   
   if data'="" { use pFile w data use IO }
 }
 
 close pFile
 q ""
]]></Implementation>
</Method>

<Method name="exportCSVSoupis">
<Description>
CSV supis ako export do IPAC


20.03.20 tt; pridana url webu a exportu webu do RIVu do exportu csv z kosiku
30.09.19 tt; pridana  InformaceOVyuziti - C11p 
24.02.17 tt; pridan sloupec AutořiRIV
22.08.16 tt; provedena uprava vice tecek v exportu u BiblCitZdrD
27.09.14 tt; pridano do exportu z kosiku csv rozliseni pro 014 - kod wos a scopus 
10.07.13 tt; pridany dalsi sloupce pro zobrazovani csv v exportu
09.07.13 tt; pridany dalsi sloupce pro zobrazovani
14.09.12 tt; pridana uprava, aby se data exportovala podle zadaneho ustavu v parametrech
25.06.09 pb; pocet opakovani 971 zistit cyklom, pri n-100 opakovaniach padalo
20.12.07 rs; doplnenie pola ISBN_ISSN
11.12.07 rs; doplnenie o dalsie polia podla poziadaviek
07.09.07 jj; dalsi doplneni exportCSVSoupis
29.08.07 jj; doplneni exportCSVSoupis
30.07.07 jj; zalozeni
             jedna se o vystup preddef. vyctu poli do formatu .csv 
--
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt,pUstav=""]]></FormalSpec>
<Implementation><![CDATA[
  // 29.08.07 jj; zmena oddelovace ";" za ","
  if pnWhat=$$$I2ExportHdr 
  {
      s s="Sysno,ZpZveřejnění,AutořiVšichni,AutořiAV,AutořiVšichniPočet,AutořiRIV,AutořiAVPočet,AutořiKorespondující,"
         _"BiblCit,BiblCitZdrD,ISBN_ISSN,ISBN_ISSN_ZdrDok,ZeměZveřejnění,Jazyk,PočStran,ImpFaktor,ProjektyCEP,"
         _"ProjektyOst,Infrastruktury,OrigNázev,PřekladNázvu,KlíčSlova,AnotaceOrig,"
         _"AnotaceEng,AnotaceCz,KódOborRIV,VědníOblast,FORD,DetailedFORD,Pozn,PoznProZprac,Konference,VlastníkZáznamuASEP,VlastníkZáznamuAV,VlastníkZáznamuCZ,VlastníkZáznamuANJ,"
         _"OdevzdáníDoRIV,RokVydání,RokSběru,PočetCitací,"
         _"DOI,UT WOS,UT SCOPUS,HANDLE,RVO,PlnýText,ZpůsobPublikování,Web,WebDoRiv,Int.kód,TechnickéParametry,EkonomickéParametry,NázevVlastníka,ČísloPředpisu,ČísloPatentovéhoSpisu,VlastníkPatentu,DatumUděleníPatentu,InformaceOVyuzití,KódVydavatelePatentu,Poddruh,Smlouva"
         
      s s=$tr(s,",",";")    
      d ##class(i2.export).outputAdd(s_$$$CRLF,pnOutFmt) 
      q 
  }
    
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie
  
  s nAutoriAVPocet=0,nAutoriVsichniPocet=0
  s sSystCislo=##class(MARC).recordT001X(.handle)
  s sZpZverejneni=$$$getTagX(.handle,"970b")
  
  ; nepouzijeme 70* kvoli tomu, ze poradie tagov moze byt zmenene
  s sAutoriVsichniBase=$$$getTagXC(.handle,"700",-1)_$c(10)
                      _$$$getTagXC(.handle,"701",-1)_$c(10)
                      _$$$getTagXC(.handle,"702",-1)
  s c=$l(sAutoriVsichniBase,$c(10))
  s sAutoriVsichni="",sAutoriAV="",nAutoriVsichniPocet=0,sAutoriKorespond="",nAutoriRIV=""
  f i=1:1:c
  {
      s sAutPart=$p(sAutoriVsichniBase,$c(10),i)
      continue:(sAutPart="")
      s nAutoriVsichniPocet=nAutoriVsichniPocet+1
    
      s sPrislusnost=$$$getSubTagStr(.sAutPart,"p")
      ; 14.09.12 tt; pridana uprava, aby se data exportovala podle zadaneho ustavu v parametrech
      s:((pUstav'="")&&(sPrislusnost'=pUstav)) sPrislusnost=""
      s:(sPrislusnost'="") nAutoriAVPocet=nAutoriAVPocet+1
      s sOdd=" - "
      s sPom=$$$getSubTagStr(.sAutPart,"a")
      s sPomz=$$$getSubTagStr(.sAutPart,"z")
      if (sPom'="")
      {
        s:(sAutoriVsichni'="") sAutoriVsichni=sAutoriVsichni_sOdd
        s sAutoriVsichni=sAutoriVsichni_sPom
        if (sPrislusnost'="") 
        {
          s:(sAutoriAV'="") sAutoriAV=sAutoriAV_sOdd
          s sAutoriAV=sAutoriAV_sPom
        }  
        if (sPomz="K")
        { ; 03.06.16 tt; pridani do exportu korespondujici autori
          s:(sAutoriKorespond'="") sAutoriKorespond=sAutoriKorespond_sOdd
          s sAutoriKorespond=sAutoriKorespond_sPom
        }    

        s sOdd=", "
      }
      s sPom=$$$getSubTagStr(.sAutPart,"b")
      if (sPom'="")
      {
        s:(sAutoriVsichni'="") sAutoriVsichni=sAutoriVsichni_sOdd
        s sAutoriVsichni=sAutoriVsichni_sPom
        if (sPrislusnost'="") 
        {
          s:(sAutoriAV'="") sAutoriAV=sAutoriAV_sOdd
          s sAutoriAV=sAutoriAV_sPom
        }  
        if (sPomz="K")
        { ; 03.06.16 tt; pridani do exportu korespondujici autori
          s:(sAutoriKorespond'="") sAutoriKorespond=sAutoriKorespond_sOdd
          s sAutoriKorespond=sAutoriKorespond_sPom
        }  
      }    
  }
  s:(sAutoriAV'="") sAutoriAV=$$$strswap(sAutoriAV,"..",".")
  s:(sAutoriVsichni'="") sAutoriVsichni=$$$strswap(sAutoriVsichni,"..",".")
  
  s nAutoriRIV=$$$getTagX(.handle,"C46a")
  s:(nAutoriRIV="") nAutoriRIV=nAutoriVsichniPocet
  
  s sBiblCit=..getBibcitCAV(.handle)
  ; 09.06.18 tt; pridano osetreni formatovacich znacek
  s:(sBiblCit'="") sBiblCit=$$$strswap(sBiblCit,"<em>","")
  s:(sBiblCit'="") sBiblCit=$$$strswap(sBiblCit,"</em>","")
  s:(sBiblCit'="") sBiblCit=$$$strswap(sBiblCit,"..",".")
  s:(sBiblCit'="") sBiblCit=$$$strswap(sBiblCit,". .",".")
  
  s sZemeZverejneni=$$$getTagX(.handle,"102a")
  s sJazyk=$$$getTagX(.handle,"101a")
  
  ; 29.08.07 jj; z pole pocet stran odtranit "s."
  s sPocStran=$$$getTagX(.handle,"215a")
  s:(sPocStran'="") sPocStran=$$$trim($$$strswap(sPocStran,"s.",""))
  s sImpFaktor=$$$getTagX(.handle,"T16c")
  
  s sProjBase=$$$getTagXC(.handle,"C12",-1)
  s nProjPocet=$l(sProjBase,$c(10))
  s sProjektyCEP="",sProjektyOst=""
  f i=1:1:nProjPocet
  {
    s sProjPart=$p(sProjBase,$c(10),i)
    if sProjPart'=""
    {
      s sOdd=" - "
      s sProjCislo=$$$getSubTagStr(.sProjPart,"a")
      s sProjCEP=$$$getSubTagStr(.sProjPart,"b")
      if (sProjCEP'="")
      {
        s:(sProjektyCEP="") sOdd=""
        s sProjektyCEP=sProjektyCEP_sOdd,sOdd=":"
        s:(sProjCislo'="") sProjektyCEP=sProjektyCEP_sProjCislo
        s sProjektyCEP=sProjektyCEP_sOdd_sProjCEP
      }  
      else
      {
        s sProjOst=$$$getSubTagStr(.sProjPart,"c")
        s sProjZeme=$$$getSubTagStr(.sProjPart,"e")
        if (sProjCislo'="" || sProjOst'="" || sProjZeme'="")
        {
          s:(sProjektyOst="") sOdd=""
          s sProjektyOst=sProjektyOst_sOdd,sOdd=":"
          s:(sProjCislo'="") sProjektyOst=sProjektyOst_sProjCislo
          s:(sProjOst'="") sProjektyOst=sProjektyOst_sOdd_sProjOst
          s:(sProjZeme'="") sProjektyOst=sProjektyOst_sOdd_sProjZeme
        }  
      }
    }
  }
  
  ; 09.02.21 tt; preveden vyzkumny zamer na infrastruktury 
  s sInfrasturkturyBase=$$$getTagXC(.handle,"C90",-1)
  s nINF=$l(sInfrasturkturyBase,$c(10))
  s sInfrasturktury=""
  f i=1:1:nINF
  {
    s sINFPart=$p(sInfrasturkturyBase,$c(10),i)
    if sINFPart'=""
    {
      s sOdd=", "
      s:(sInfrasturktury="") sOdd=""
      s sINF=$$$getSubTagStr(.sINFPart,"a")
      s sINFT=##class(User.Util).sXlate("UN_INFRASTRUKTURA",sINF,"N","Cav")
      s sINF=sINFT_" - "_sINF
      s sInfrasturktury=sInfrasturktury_sOdd_sINF 
    }
  }  
  
  s sOrigNazev=$$$getTagX(.handle,"200a")
  s sPrekladNazvu=$$$getTagX(.handle,"541a")
  
  s sKlicSlovaBase=$$$getTagXC(.handle,"610",-1)
  s nKS=$l(sKlicSlovaBase,$c(10))
  s sKlicSlova=""
  f i=1:1:nKS
  {
    s sKSPart=$p(sKlicSlovaBase,$c(10),i)
    if sKSPart'=""
    {
      s sOdd=" - "
      s:(sKlicSlova="") sOdd=""
      s sKS=$$$getSubTagStr(.sKSPart,"a")
      s sKlicSlova=sKlicSlova_sOdd_sKS  
    }
  }  
  
  ; 29.08.07 jj; rozdelit anotaci do trech sloupcu (v jazyce orig, preklad do eng, preklad do cz)
  s sAnotaceBase=$$$getTagX(.handle,"C15")
  s sAnotaceOrig="",sAnotaceEng="",sAnotaceCz=""
  if (sAnotaceBase'="")
  {
    s sAnotaceOrig=$$$getSubTagStr(.sAnotaceBase,"a")
    s sAnotaceEng=$$$getSubTagStr(.sAnotaceBase,"b")
    s sAnotaceCz=$$$getSubTagStr(.sAnotaceBase,"c")
  }
  // 30.07.07 jj; crepVal jedno lomitko doplnuje
  s:(sAnotaceOrig'="") sAnotaceOrig=$$$strswap(sAnotaceOrig,"\\","\")
  s:(sAnotaceEng'="") sAnotaceEng=$$$strswap(sAnotaceEng,"\\","\")
  s:(sAnotaceCz'="") sAnotaceCz=$$$strswap(sAnotaceCz,"\\","\")
  
  s sKodOborRIV=$$$getTagX(.handle,"C26f")
  ; 21.03.18 tt; pridany hodnoty do csv pro OECD ciselniky
  s sVedniOblast=$$$getTagX(.handle,"C26x")
  s sFORD=$$$getTagX(.handle,"C26y")
  s sDetailedFORD=$$$getTagX(.handle,"C26z")
  s c=0
  d { ; pri spolupraci musime zjistit spravny ustav
     s sTC47=$$$getTagXC(.handle,"C47",.c) ; vsechny spoluprace
     continue:((sTC47="")&&(c'=0))         ; pokud nemam data pokracuji
     if ((sTC47'="")&&(pUstav'="")) 
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC47a=$$$getSubTagStr(sTC47,"a")
       continue:(pUstav'=sTC47a)
       s sVedniOblast=$$$getSubTagStr(sTC47,"b")
       s sFORD=$$$getSubTagStr(sTC47,"c")
       s sDetailedFORD=$$$getSubTagStr(sTC47,"d")       
     }
   } while (c'=0)    
  
  s:(sVedniOblast'="") sVedniOblast=sVedniOblast_" - "_##class(User.Util).sXlate("EPCA_OECDALL",sVedniOblast,,"Cav")
  s:(sFORD'="") sFORD=sFORD_" - "_##class(User.Util).sXlate("EPCA_OECDALL",sFORD,,"Cav")
  s:(sDetailedFORD'="") sDetailedFORD=sDetailedFORD_" - "_##class(User.Util).sXlate("EPCA_OECDALL",sDetailedFORD,,"Cav") 
  
  s sPozn=$$$getTagX(.handle,"300a")
  s sPoznProZprac=$$$getTagX(.handle,"C26g")
  s sVlastnikZaznamu=$$$getTagX(.handle,"C26e")
  ; 14.09.12 tt; pridana uprava, aby se data exportovala podle zadaneho ustavu v parametrech
  s:(pUstav'="") sVlastnikZaznamu=pUstav
  s sVlastnikZaznamuAV=##class(User.Util).sXlate("CAV_PRA",sVlastnikZaznamu,,"Cav")
  s sVlastnikZaznamuCZ="",sVlastnikZaznamuANJ=""
  if (sVlastnikZaznamu'="")
  { ; 24.01.15 tt; pridano doplneni pracoviste v cj a aj
    s prskr=$zcvt($zstrip(sVlastnikZaznamu,"<>W"),"L")
    s sTerm=" "_prskr_" (o)"
    s sPracid=##class(User.MARC).getIDByIndex("CavUnAuth","aucr",sTerm)
    if (sPracid'=0)
    { ; pokud id neni 0
      if ##class(User.MARC).getDATAX(.hndla,sPracid)
      { ; pokud se podarilo otevrit zaznam pracoviste, nacteme informace
        s idPrac = ##class(User.MARC).recordT001X(.hndla)
        s sVlastnikZaznamuCZ=$$$getTagX(.hndla,"210a")
        
        s xx=0
        d {
          s sT410=$$$getTagXC(.hndla,"410",.xx) ; vsetky citacie
          continue:((sT410="")&&(xx'=0))
          if (sT410'="")
          { ; pokud mame vyplnene data, muzeme provadet akce 
            s sT4108=$$$getSubTagStr(sT410,"8")
            s:(sT4108="eng") sVlastnikZaznamuANJ=$$$getSubTagStr(sT410,"a")
          }
        } while (xx'=0)
      }
    }   
  } 
  
  s sOdevzdaniDoRIV=$$$getTagX(.handle,"C26b")
  s sRokSberu=$$$getTagX(.handle,"C26d")
  
  
  s nLast=1,sBiblCit463=$$$trim(..getBibcitCAV463(.handle,.nLast))
  
  ; 22.08.16 tt; provedena uprava vice tecek v exportu u BiblCitZdrD
  s:($f(sBiblCit463,"..")) sBiblCit463=$$$strswap(sBiblCit463,"..",".")
  ; 09.06.18 tt; pridano osetreni formatovacich znacek
  s:(sBiblCit463'="") sBiblCit463=$$$strswap(sBiblCit463,"<em>","")
  s:(sBiblCit463'="") sBiblCit463=$$$strswap(sBiblCit463,"</em>","")
  s:(sBiblCit463'="") sBiblCit463=$$$strswap(sBiblCit463,"..",".")
  s:(sBiblCit463'="") sBiblCit463=$$$strswap(sBiblCit463,". .",".")

  //s:($f(sBiblCit463,"..")) sBiblCit463=$$$strswap(sBiblCit463,"..",".")
  //s sBiblCit463=$tr(sBiblCit463,"..",".")
  
  ; 010a,011a (20.12.07 rs)
  s sISSBN=$$$getTagX(.handle,"010a")
  s s=$$$getTagX(.handle,"011a")
  s:(s="") s=$$$getTagX(.handle,"011e")
  s:((sISSBN'="") &&(s'="")) sISSBN=sISSBN_","
  s sISSBN=sISSBN_s

  ; 463/010a,011a
  s sISSBNZdrD=$$$getTagX(.handle,"463/010a")
  s s=$$$getTagX(.handle,"463/011a")
  s:(s="") s=$$$getTagX(.handle,"463/011e")
  if sISSBNZdrD'="",s'="" s sISSBNZdrD=sISSBNZdrD_","
  s sISSBNZdrD=sISSBNZdrD_s
  
  
  s nLast=1,sKonference=..getDisplayFormatShortC20(.handle,.nLast)
  s sKonference=$$$trim($$$strswap(sKonference,"\n"," "))
  s:($e(sKonference)="[") $e(sKonference)=""   ; osetreni zobrazeni konference
  s:($e(sKonference,$l(sKonference))="]") $e(sKonference,$l(sKonference))=""
  s sKonference=$$$trim(sKonference)
  
  
  s sRokVydani=$$$getTagX(.handle,"T16r")
  
  
  ; 25.06.09 pb; pocet opakovani 971 zistit cyklom, pri n-100 opakovaniach padalo
  ;s s=##class(MARC).getTagX(.handle,"971",-1)
  ;s nPocetCitaci=$s(s="":"",1:$l(s,$c(10)))
  s nC=0,c=0
  for 
  { ; cyklus cez vsetky opakovania tagu 
    s sT971=$$$getTagXC(.handle,"971",.c)
    q:(sT971="")
    s nC=nC+1
    q:(c=0)
  }
  if nC<1 s nC=""
  s nPocetCitaci=nC
  
  ; 10.07.13 tt; pridany dalsi sloupce pro zobrazovani csv v exportu
  ; DOI - 017$a
  s sDOI=$$$getTagX(.handle,"017a")
  ; UTISI - 014$a - 27.09.14 tt; toto se uz nepouziva
  s sUTISI=$$$getTagX(.handle,"014a")
  
  s c=0,ret="",sIDWos="",sIDScopus=""
  d { ; 27.09.14 tt; pridano do exportu z kosiku csv rozliseni pro 014 - kod wos a scopus 
    s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
    continue:((sT014="")&&(c'=0))
    s sT014a=$$$getSubTagStr(sT014,"a")
    if (sT014a'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      ; 24.01.15 tt; upraven format ID WOS a SCOPUS 
      if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="wos")     
      { ; pokud mam ID pro wos, ulozim  si
        s sIDWos=sT014a
        s:(sIDWos'="") sIDWos="wos:"_sIDWos
      }
      if ($zcvt($$$getSubTagStr(sT014,"2"),"l")="scopus")     
      { ; pro ID scopusu si take ulozim
        s sIDScopus=sT014a
        s:(sIDScopus'="") sIDScopus="2-s2.0-"_sIDScopus
      }
    }
  } while (c'=0)   
       
  ; HANDLE - C60$a
  s sHANDLE=$$$getTagX(.handle,"C60a")
  ; RVO - C57$a
  s sRVO=$$$getTagX(.handle,"C57a")
  ; PlnyText - 0 - na vyžádání; 1-OA
  s sPlnyText=""
  s sT001=$$$HandleT001(handle)
  s sClass=$$$HandleClass(handle)                             ; ziskame tridu zaznamu
  d ##class(content.api).selectRecAll(.output,sClass,sT001)   ; ziskame vsechny data k zaznamu v output
  ; prochazime postupne cyklem vsech polozek k zaznamu
  s item=""      ; jedna polozka k zaznamu
  f { 
    s sPlnyT=""
    s item=$o(output(item)) q:item=""
    s repo=output(item,"repository")   ; ziskame repository
    s key=output(item,"key")           ; klice
    ; nacteme delsi pomocna data k jednomu zaznamu    
    d ##class(content.api).getBatch(.array,repo,key)         ; ziskame informace z array    
    s sAccession=array("accession")                          ; nacteme si postupne data
    if (sAccession="O") { s sPlnyT=1 }
    else { s sPlnyT=0 }
    ; ulozeni hodnot
    s:(('$f(sPlnyText,sPlnyT))&&(sPlnyText'="")) sPlnyText=sPlnyText_";"_sPlnyT
    s:(sPlnyText="") sPlnyText=sPlnyT
  }  
  ; Int.kod - C34$a
  s sIntKod=$$$getTagX(.handle,"C34a")
  ; TechnickeParametry - C34$c
  s sTechnickeParametry=$$$getTagX(.handle,"C34c")
  ; EkonomickeParametry - C34$d
  s sEkonomickeParametry=$$$getTagX(.handle,"C34d")
  ; NazevVlastnika - C34$e
  s sNazevVlastnika=$$$getTagX(.handle,"C34e")
  ; CisloPredpisu - C34$o
  s sCisloPredpisu=$$$getTagX(.handle,"C34o")
  ; CisloPatentovehoSpisu - C11$a
  s sCisloPatentovehoSpisu=$$$getTagX(.handle,"C11a")
  ; VlastnikPatentu - C11$e
  s sVlastnikPatentu=$$$getTagX(.handle,"C11e")
  ; DatumUdeleniPatentu - C11$c
  s sDatumUdeleniPatentu=$$$getTagX(.handle,"C11c")
  ; InformaceOVyuziti - C11p 
  s sInformaceOVyuziti=$$$getTagX(.handle,"C11p")
  s:(sInformaceOVyuziti="A") sInformaceOVyuziti="nevyužívaný"
  s:(sInformaceOVyuziti="B") sInformaceOVyuziti="využíváný"
  ; KodVydavatelePatentu -C11$q
  ; 30.09.19 tt; - zmenen kod vydavatele ne C11v
  s sKodVydavatelePatentu=$$$getTagX(.handle,"C11v")
  ; Poddruh C11$q pro P1; C34$l pro Z; C34$m pro L; C34$n pro L1; C34$u pro L3
  s sPoddruh=""
  s:(sZpZverejneni="P1") sPoddruh=$$$getTagX(.handle,"C11q")
  s:(sZpZverejneni="Z" ) sPoddruh=$$$getTagX(.handle,"C34l")
  s:(sZpZverejneni="L" ) sPoddruh=$$$getTagX(.handle,"C34m")
  s:(sZpZverejneni="L1") sPoddruh=$$$getTagX(.handle,"C34n")
  s:(sZpZverejneni="L3") sPoddruh=$$$getTagX(.handle,"C34u")
  
  ; 06.02.19 tt; pridana smlouva do csv do exportu z kosiku
  s sSmlouva=$$$getTagX(.handle,"C70a")
  s:(sSmlouva'="") sSmlouva="Ano" 
  
  ; 18.03.20 tt; pridan zpusob publikovani do exportu csv z kosiku
  s sZpusobPublikovani=$$$getTagX(.handle,"C91a")
  s:(sZpusobPublikovani'="") sZpusobPublikovani=sZpusobPublikovani_" - "_##class(User.Util).sXlate("UN_ZP_PUBLIKOVANI",sZpusobPublikovani,,"Cav")
  
  ; 20.03.20 tt; pridana url webu a exportu webu do RIVu do exportu csv z kosiku
  s sWeb=$$$getTagX(.handle,"856u")
  s sWebDoRiv=$$$getTagX(.handle,"8569")
  
  s sT001=$$$HandleT001(handle)       ; ziskani t001
  s sClass=$$$HandleClass(handle)     ; ziskani tridy
  
  // 31.03.23 tt; provedeno nahrazeni znaku .b. - osetreni zvyrazneni
  s:($f(sWeb,".b.")) sWeb=$$$strswap(sWeb,".b.","%2Eb%2E")
  s:($f(sDOI,".b.")) sDOI=$$$strswap(sDOI,".b.","%2Eb%2E")

  s s=##class(User.UtilIE).crepVal(sSystCislo)_","_
      ##class(User.UtilIE).crepVal(sZpZverejneni)_","_
      ##class(User.UtilIE).crepVal(sAutoriVsichni)_","_
      ##class(User.UtilIE).crepVal(sAutoriAV)_","_
      ##class(User.UtilIE).crepVal(nAutoriVsichniPocet)_","_
      ##class(User.UtilIE).crepVal(nAutoriRIV)_","_
      ##class(User.UtilIE).crepVal(nAutoriAVPocet)_","_
      ##class(User.UtilIE).crepVal(sAutoriKorespond)_","_      
      ##class(User.UtilIE).crepVal(sBiblCit)_","_
      ##class(User.UtilIE).crepVal(sBiblCit463)_","_
      ##class(User.UtilIE).crepVal(sISSBN)_","_
      ##class(User.UtilIE).crepVal(sISSBNZdrD)_","_
      ##class(User.UtilIE).crepVal(sZemeZverejneni)_","_
      ##class(User.UtilIE).crepVal(sJazyk)_","_
      ##class(User.UtilIE).crepVal(sPocStran)_","_
      ##class(User.UtilIE).crepVal(" "_sImpFaktor)_","_
      ##class(User.UtilIE).crepVal(sProjektyCEP)_","_
      ##class(User.UtilIE).crepVal(sProjektyOst)_","_
      ##class(User.UtilIE).crepVal(sInfrasturktury)_","_
      ##class(User.UtilIE).crepVal(sOrigNazev)_","_
      ##class(User.UtilIE).crepVal(sPrekladNazvu)_","_
      ##class(User.UtilIE).crepVal(sKlicSlova)_","_
      ##class(User.UtilIE).crepVal(sAnotaceOrig)_","_
      ##class(User.UtilIE).crepVal(sAnotaceEng)_","_
      ##class(User.UtilIE).crepVal(sAnotaceCz)_","_
      ##class(User.UtilIE).crepVal(sKodOborRIV)_","_
      ##class(User.UtilIE).crepVal(sVedniOblast)_","_
      ##class(User.UtilIE).crepVal(sFORD)_","_
      ##class(User.UtilIE).crepVal(sDetailedFORD)_","_
      ##class(User.UtilIE).crepVal(sPozn)_","_
      ##class(User.UtilIE).crepVal(sPoznProZprac)_","_
      ##class(User.UtilIE).crepVal(sKonference)_","_
      ##class(User.UtilIE).crepVal(sVlastnikZaznamu)_","_    ; 24.01.15 tt; pridano doplneni pracoviste v cj a aj
      ##class(User.UtilIE).crepVal(sVlastnikZaznamuAV)_","_  ; 13.09.19 tt; pridan vlastnik zaznamu AV
      ##class(User.UtilIE).crepVal(sVlastnikZaznamuCZ)_","_
      ##class(User.UtilIE).crepVal(sVlastnikZaznamuANJ)_","_
      ##class(User.UtilIE).crepVal(sOdevzdaniDoRIV)_","_
      ##class(User.UtilIE).crepVal(sRokVydani)_","_
      ##class(User.UtilIE).crepVal(sRokSberu)_","_
      ##class(User.UtilIE).crepVal(nPocetCitaci)_","_
      ##class(User.UtilIE).crepVal(sDOI)_","_
      //##class(User.UtilIE).crepVal(sUTISI)_","_
      ##class(User.UtilIE).crepVal(sIDWos)_","_
      ##class(User.UtilIE).crepVal(sIDScopus)_","_
      ##class(User.UtilIE).crepVal(sHANDLE)_","_
      ##class(User.UtilIE).crepVal(sRVO)_","_
      ##class(User.UtilIE).crepVal(sPlnyText)_","_
      ##class(User.UtilIE).crepVal(sZpusobPublikovani)_","_
      ##class(User.UtilIE).crepVal(sWeb)_","_
      ##class(User.UtilIE).crepVal(sWebDoRiv)_","_
      ##class(User.UtilIE).crepVal(sIntKod)_","_
      ##class(User.UtilIE).crepVal(sTechnickeParametry)_","_
      ##class(User.UtilIE).crepVal(sEkonomickeParametry)_","_
      ##class(User.UtilIE).crepVal(sNazevVlastnika)_","_
      ##class(User.UtilIE).crepVal(sCisloPredpisu)_","_
      ##class(User.UtilIE).crepVal(sCisloPatentovehoSpisu)_","_
      ##class(User.UtilIE).crepVal(sVlastnikPatentu)_","_
      ##class(User.UtilIE).crepVal(sDatumUdeleniPatentu)_","_
      ##class(User.UtilIE).crepVal(sInformaceOVyuziti)_","_
      ##class(User.UtilIE).crepVal(sKodVydavatelePatentu)_","_
      ##class(User.UtilIE).crepVal(sPoddruh)_","_
      ##class(User.UtilIE).crepVal(sSmlouva)     
      
  ; vymaz sekvencii na tucne pismo, italic atd
  ; mozno to nie je uplne najlepsie miesto ale na jednom mieste da odchyti formatovanie
  ; z uplne vsetkych poli, kam sa len mohlo dostat
  ; cisto teoreticky by mohlo dojst ku konfliktu s CSV, ale snad nie
  d ##class(rep.epca.exportBase).symClearFormatInfoStr(.s)
  
  s s=$tr(s,";",$c(10))
  s s=$tr(s,",",";")
  s s=$tr(s,$c(10),",")
  ; 09.11.23 tt; odstraneni zaescapovanych znaku u exportu do csv.  Nelibi se to CAV cs123303
  s s=$$$strswap(s,"%2Eb%2E",".b.")
    
  // 29.08.07 jj; zmena oddelovace ";" za ","
  d ##class(i2.export).outputAdd(s_$$$CRLF,pnOutFmt)
]]></Implementation>
</Method>

<Method name="exportCSVSpol">
<Description><![CDATA[
<pre> CSV supis ako export do IPAC. Pokud je zaznam ve spolupraci, exportuje se na tri radky
v exportu, pokud je vykazovan ve spolupraci za 3 ustavy. Meni se pole VlastníkZáznamu,  
AutořiAV,AutořiAVPočet podle aktualniho vykazovaneho pracoviste

13.09.12 tt; zalozeni exportniho formatu csv na zaklade exportCSVSoupis, kde se
zaznam podle spolupraci muze exportovat nekolikrat. 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  if (pnWhat=$$$I2ExportHdr)||(pnWhat=$$$I2ExportFooter)
  { ; pokud hlavicka nebo paticky, vypisujeme podle puvodniho
    d ..exportCSVSoupis(.handle, pnWhat, pnOutFmt)
  }
  if (pnWhat=$$$I2ExportBody)
  { ; pokud zpracovavame zaznamy, zpracujeme
    s sUstAll=..getSpolByHandle(.handle)  ; ziskame vsechny ustavy ve spolupraci
    
    for i=1:1:$l(sUstAll,";") 
    { ; projdeme vsechny ustavy a jeden po druhem zpracovavame
      s sUst1=$p(sUstAll,";",i)      
      continue:(sUst1="")&&(sUstAll'="")      
      ; zavoleme exporti metodu s rozsirenim podle ustavu
      d ..exportCSVSoupis(.handle, pnWhat, pnOutFmt,sUst1)
    } 
  }
]]></Implementation>
</Method>

<Method name="exportCSVSoupisData">
<Description>
CSV supis ako export do IPAC - pro data


18.04.23 tt; upraveny pripominky cav
23.03.23 tt; zalazena specialni funkce pro DATA
--
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt,pUstav=""]]></FormalSpec>
<Implementation><![CDATA[
  // 29.08.07 jj; zmena oddelovace ";" za ","
  if pnWhat=$$$I2ExportHdr 
  {
      s s="Vlastník_záznamu,Vkladatel,Datum_zveřejnění,SYSNO,Název_datového_souboru,Překlad_názvu_do_angličtiny,Alternativní_název_souboru,Autor,Typ_datových_souborů,Jazyk,Popis_datasetu,"_
          "Překlad_popisu_datasetu_do_angličtiny,Technické_informace,Odkaz_na_stránky_související_s_daty,Název_repozitáře_-_Odkaz,Licence_CC,Další_licence,Přístup_k_souboru,Handle,DOI,"_
          "Odkaz_na_publikaci_v_ASEP,Popis_změny_dat,Verze_software,ProjektyCEP,ProjektyOst,RVO,VVI,Klíčová_slova,Vědní_oblast,Lokalizace_–_místo,Lokalizace_–_země,Časové_období,Všeobecná_poznámka"
        
      s s=$tr(s,",",";")    
      d ##class(i2.export).outputAdd(s_$$$CRLF,pnOutFmt) 
      q 
  }
    
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie
  
  ; definice promennych
  s sSystCislo=##class(MARC).recordT001X(.handle)
  s sVlastnikZaznamu="",sVkladatel="",sDatumZveřejnění="",sNazev="",sNazevPrekladu="",sNazevAlternativni="", sAutori="",sTypDSouboru="",sJazyk=""
  s sPopisDatasetu="", sPřekladDatasetuEng="", sTechnickeInformace="", sOdkaz="", sNazevRepozitare="",sLicenceCC="",sDalsiLic="0",sPristupSoub="",sHandle="",sDOI="",sVazvaAsep="0"
  s sPopisZmenyDat="",sCisloVerze="",sNavaznostProjekty="",sRVO="",sVVI="",sKlicovaSlova="",sVedniOblast="",sLokalicaceMisto="",sLokalicaceZeme="",sOdDo="",sPoznamka=""
  s sProjektyCEP="",sProjektyOst="",nProjPocet=""
  
  s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3)
    s:(sTag="C26") sVlastnikZaznamu=$$$getSubTagStr(lsLine,"e")          ; vlastnik zaznamu
    //s:(sTag="C26") sVkladatel=$$$getSubTagStr(lsLine,"h")                ; vkladatel
    if (sTag="999") 
    {
        s s999d=$zcvt($p($p($$$getSubTagStr(lsLine,"d"),"#",1),"-",1),"l")
        if $f(s999d,"cavisu")
        {
          s s999d=$$$strswap(s999d,"cavisu","")
          if ##class(User.MARC).readX(.handleU,"CavIsUser",s999d)
          {
            s sVkladatel=$tr($$$getTagX(.handleU,"100a"),","," ")
          }
        }       
    }
    if (sTag="U95") 
    { ; datum zverejneni
      s sDatumZveřejnění=$$$getSubTagStr(lsLine,"b")
      s sDatumZveřejnění=+$e(sDatumZveřejnění,7,8)_"."_+$e(sDatumZveřejnění,5,6)_"."_$e(sDatumZveřejnění,1,4)
    }    
    d:(sTag="200") ..getDataCSVSoupisData(.sNazev,lsLine,"a")      ; nazev
    s:(sTag="541") sNazevPrekladu=$$$getSubTagStr(lsLine,"a")       ; Překlad názvu do angličtiny jako u publikací
    d:(sTag="200") ..getDataCSVSoupisData(.sNazevAlternativni,lsLine,"e")      ; Alternativní název souboru  středník
    if ((sTag="700") ||(sTag="701"))
    { ; autori
      s:(sAutori'="") sAutori=sAutori_" - "_$$$getSubTagStr(lsLine,"a")_";"_$$$getSubTagStr(lsLine,"b")
      s:(sAutori="") sAutori=$$$getSubTagStr(lsLine,"a")_";"_$$$getSubTagStr(lsLine,"b")      
    }
    s:(sTag="608") sTypDSouboru=##class(User.Util).sXlate("UT_ASEP_TYP_SOUB",$$$getSubTagStr(lsLine,"a"),"N","Cav")       ; 608$a   Typ datových souborů
    s:(sTag="101") sJazyk=$$$getSubTagStr(lsLine,"a")       ; 101$a   Jazyk 
    s:(sTag="C15") sPopisDatasetu=$$$getSubTagStr(lsLine,"a")       ; C15$a   Popis datasetu
    s:(sTag="C15") sPřekladDatasetuEng=$$$getSubTagStr(lsLine,"b")       ; C15$b   Překlad popisu datasetu do angličtiny 
    s:(sTag="327") sTechnickeInformace=$$$getSubTagStr(lsLine,"a")       ; 327$a   Technické informace
    d:(sTag="856") ..getDataCSVSoupisData(.sOdkaz,lsLine,"u")       ;     856$u   Odkaz na stránky související s daty     středník
    //s:(sTag="C76") sNazevRepozitare=$$$getSubTagStr(lsLine,"u")_" - "_$$$getSubTagStr(lsLine,"z")       ; C76$uC76$z  Název repozitáře - Odkaz        Zenodo - odkaz
    s:(sTag="C76") sNazevRepozitare=$$$getSubTagStr(lsLine,"z")       ; C76$z  Název repozitáře 
    s:(sTag="C81") sLicenceCC=$$$getSubTagStr(lsLine,"b")       ; C81$b   Licence CC 
    s:((sTag="C81")&&($$$getSubTagStr(lsLine,"c")'="")) sDalsiLic="1"     ; C81$c   Další licence               0/1
    s:(sTag="C81") sPristupSoub=##class(User.Util).sXlate("UT_ASEP_ACCESS",$$$getSubTagStr(lsLine,"a"),"N","Cav")       ; C81$a   Přístup k souboru   
    s:(sTag="C60") sHandle=$$$getSubTagStr(lsLine,"a")       ; C60$a   Handle  
    s:(sTag="017") sDOI=$$$getSubTagStr(lsLine,"a")       ; 017$a    DOI 
    s:((sTag="U88")&&($$$getSubTagStr(lsLine,"3")'="")) sVazvaAsep="1"       ; U88 3 -vazba u záznamu odkaz    Odkaz na publikaci v ASEP   0/1
    s:(sTag="U03") sPopisZmenyDat=$$$getSubTagStr(lsLine,"c")       ;   U03c    Popis změny dat
    s:(sTag="U03") sCisloVerze=$$$getSubTagStr(lsLine,"d")       ; U03d    Číslo verze 
    d:(sTag="C12") ..getDataCSVSoupisData(.sNavaznostProjekty,lsLine,"a")       ;    C12$a   Návaznost na projekty               středník
    d:(sTag="C57") ..getDataCSVSoupisData(.sRVO,lsLine,"a")       ;    C57$a   RVO                             středník
    s:(sTag="C90") sVVI=$$$getSubTagStr(lsLine,"a")       ; C90$a   VVI 
    d:(sTag="610") ..getDataCSVSoupisData(.sKlicovaSlova,lsLine,"a")       ;  610$a   Klíčová slova   středník
    s:(sTag="C26") sVedniOblast=$$$getSubTagStr(lsLine,"x")       ; c26x    Vědní oblast  
    d:(sTag="617") ..getDataCSVSoupisData(.sLokalicaceMisto,lsLine,"d")       ; 617$d   Lokalizace – místo  středník
    d:(sTag="617") ..getDataCSVSoupisData(.sLokalicaceZeme,lsLine,"a")       ; 617$a   Lokalizace – země   středník
    s:(sTag="300") sPoznamka=$$$getSubTagStr(lsLine,"a")       ; 300$a   Všeobecná poznámka
    ////////////////////////
    if (sTag="U22") 
    { ; U22a – b (od-do)    Časové období   středník
      s:(sOdDo'="") sOdDo=sOdDo_";"_$$$getSubTagStr(lsLine,"a")_"-"_$$$getSubTagStr(lsLine,"b")
      s:(sOdDo="") sOdDo=$$$getSubTagStr(lsLine,"a")_"-"_$$$getSubTagStr(lsLine,"b")
    }
    if (sTag="C12") 
    { /// ,ProjektyCEP,ProjektyOst
      s nProjPocet=nProjPocet+1
      
      s sOdd=" - "
      s sProjCislo=$$$getSubTagStr(.lsLine,"a")
      s sProjCEP=$$$getSubTagStr(.lsLine,"b")
      if (sProjCEP'="")
      {
        s:(sProjektyCEP="") sOdd=""
        s sProjektyCEP=sProjektyCEP_sOdd,sOdd=":"
        s:(sProjCislo'="") sProjektyCEP=sProjektyCEP_sProjCislo
        s sProjektyCEP=sProjektyCEP_sOdd_sProjCEP
      }  
      else
      {
        s sProjOst=$$$getSubTagStr(.lsLine,"c")
        s sProjZeme=$$$getSubTagStr(.lsLine,"e")
        if (sProjCislo'="" || sProjOst'="" || sProjZeme'="")
        {
          s:(sProjektyOst="") sOdd=""
          s sProjektyOst=sProjektyOst_sOdd,sOdd=":"
          s:(sProjCislo'="") sProjektyOst=sProjektyOst_sProjCislo
          s:(sProjOst'="") sProjektyOst=sProjektyOst_sOdd_sProjOst
          s:(sProjZeme'="") sProjektyOst=sProjektyOst_sOdd_sProjZeme
        }  
      }
    }
  }     
  
  s:(sNazevRepozitare="") sNazevRepozitare="ASEP"
  
  // 31.03.23 tt; provedeno nahrazeni znaku .b. - osetreni zvyrazneni
  s:($f(sOdkaz,".b.")) sOdkaz=$$$strswap(sOdkaz,".b.","%2Eb%2E")
  s:($f(sDOI,".b.")) sDOI=$$$strswap(sDOI,".b.","%2Eb%2E")


  s s=##class(User.UtilIE).crepVal(sVlastnikZaznamu)_","_
      ##class(User.UtilIE).crepVal(sVkladatel)_","_
      ##class(User.UtilIE).crepVal(sDatumZveřejnění)_","_     
      ##class(User.UtilIE).crepVal(sSystCislo)_","_        
      ##class(User.UtilIE).crepVal(sNazev)_","_        
      ##class(User.UtilIE).crepVal(sNazevPrekladu)_","_      
      ##class(User.UtilIE).crepVal(sNazevAlternativni)_","_        
      ##class(User.UtilIE).crepVal(sAutori)_","_          
      ##class(User.UtilIE).crepVal(sTypDSouboru)_","_  
      ##class(User.UtilIE).crepVal(sJazyk)_","_  
      ##class(User.UtilIE).crepVal(sPopisDatasetu)_","_  
      ##class(User.UtilIE).crepVal(sPřekladDatasetuEng)_","_  
      ##class(User.UtilIE).crepVal(sTechnickeInformace)_","_  
      ##class(User.UtilIE).crepVal(sOdkaz)_","_  
      ##class(User.UtilIE).crepVal(sNazevRepozitare)_","_  
      ##class(User.UtilIE).crepVal(sLicenceCC)_","_  
      ##class(User.UtilIE).crepVal(sDalsiLic)_","_  
      ##class(User.UtilIE).crepVal(sPristupSoub)_","_  
      ##class(User.UtilIE).crepVal(sHandle)_","_  
      ##class(User.UtilIE).crepVal(sDOI)_","_  
      ##class(User.UtilIE).crepVal(sVazvaAsep)_","_  
      ##class(User.UtilIE).crepVal(sPopisZmenyDat)_","_  
      ##class(User.UtilIE).crepVal(sCisloVerze)_","_  
      //##class(User.UtilIE).crepVal(sNavaznostProjekty)_","_  
      ##class(User.UtilIE).crepVal(sProjektyCEP)_","_  
      ##class(User.UtilIE).crepVal(sProjektyOst)_","_  
      ##class(User.UtilIE).crepVal(sRVO)_","_  
      ##class(User.UtilIE).crepVal(sVVI)_","_  
      ##class(User.UtilIE).crepVal(sKlicovaSlova)_","_  
      ##class(User.UtilIE).crepVal(sVedniOblast)_","_  
      ##class(User.UtilIE).crepVal(sLokalicaceMisto)_","_  
      ##class(User.UtilIE).crepVal(sLokalicaceZeme)_","_  
      ##class(User.UtilIE).crepVal(sOdDo)_","_  
      ##class(User.UtilIE).crepVal(sPoznamka)
      
  ; vymaz sekvencii na tucne pismo, italic atd mozno to nie je uplne najlepsie miesto ale na jednom mieste da odchyti formatovanie
  ; z uplne vsetkych poli, kam sa len mohlo dostat cisto teoreticky by mohlo dojst ku konfliktu s CSV, ale snad nie
  d ##class(rep.epca.exportBase).symClearFormatInfoStr(.s)
  
  s s=$tr(s,";",$c(10))
  s s=$tr(s,",",";")
  s s=$tr(s,$c(10),";")
    
  d ##class(i2.export).outputAdd(s_$$$CRLF,pnOutFmt)   ; 29.08.07 jj; zmena oddelovace ";" za ","
]]></Implementation>
</Method>

<Method name="getDataCSVSoupisData">
<Description><![CDATA[
<pre> Metoda, ktera pro export dat do csv vrati opakovatelne podpole s danym oddelovacem

13.09.12 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&hodnota,pLine="",pST="",pOddel=";"]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s sST=$$$getSubTagStrC(pLine,pST,-1)              
  for ops=1:1:($l(sST,$c(10)))
  { ; pres vsechny opakovani subtagu
    s sST1=$p(sST,$c(10),ops)  ; ziskana hodnota jednoho opakovani
    s:(hodnota'="") hodnota=hodnota_pOddel_sST1 
    s:(hodnota="") hodnota=sST1 
  }
]]></Implementation>
</Method>

<Method name="getSpolByHandle">
<Description><![CDATA[
<pre> Metoda pro vraceni vsech ustavu, ktere na danem zaznamu. Vraci seznam oddeleny
      znakem  ";"

13.09.12 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sRet=""  ; vracime promennou ret  
  s c=0      ; . prochazeni zaznamu podle .c    
  d {
    s sT70X=$$$getTagXC(.handle,"70*",.c) ; vsechny autori musime projit
    continue:((sT70X="")&&(c'=0))
    if (sT70X'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sT70Xp=##class(MARC).getSubTagStr(sT70X,"p")
      if (sT70Xp'="")
      { ; pokud mame zadane pracoviste, pridame jej do seznamu
        s:('$f(sRet,sT70Xp)) sRet=sRet_";"_sT70Xp ; postupne seskladame vysledek
      }    
    }
  } while (c'=0)    
  
  s:($e(sRet,1)=";") $e(sRet,1)="" ; oprava prvniho oddelovace  
  q sRet
]]></Implementation>
</Method>

<Method name="selGra">
<Description><![CDATA[
18.08.07 mk; select na zaznamy autorit projektu bez naviazania v CavUnEpca index gra<br>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 ; s sy="ret1=##class(CavUnEpca).gra(.handle)"

 s status=0 
 s t230=##class(MARC).getTagX(.handle,"230")  ; dotiahnut vsetky opakovania
 s th=##class(MARC).getSubTagStr(t230,"h")  ; cislo projektu
 
 if th="" q status
 
 
 s hladaj=th  
 s hladaj=##class(User.Util).strswap(hladaj," ","") 
 s hladaj=" "_##class(Util).trim(hladaj) 
 s s1="();:-/[].',"_$c(34)  
 s hladaj=$tr(hladaj,s1)
 s hladaj=$zcvt(hladaj,"l")
 s hladaj=$e(hladaj,1,80)
 if '$d(^ooDataTableI("CavUnEpca","xgra",hladaj)) s status = 1

 
 q status
]]></Implementation>
</Method>

<Method name="gen70xo">
<Description><![CDATA[
10.10.07 mk; globalka na cistenie 70*o<br>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 ; s sy="##class(CavUnEpca).gen70xo(.handle)"
 s tagy="700,701,702"
 
 f i=1:1:3   ; podla poctu tagov
 {
   s t7xxnew=""  
   s tag=$p(tagy,",",i) ; cislo tagu 
   s t7xxall=##class(MARC).getTagX(.handle,tag,-1) ; nacitanie vsetkych opakovani tagu
   s pocet=$l(t7xxall,$c(10))
  
   f j=1:1:pocet
   {
      s t7xx=$p(t7xxall,$c(10),j)  ; jedno opakovanie tagu
      s to=##class(MARC).getSubTagStr(t7xx,"o") ; oddelenie autora
    
      if (to'="") && ($zcvt($e(to,1,4),"l")="uivt")  
      {
          s toold=to
          s to=$e(to,6,9999)
          s t7xx=##class(User.Util).strswap(t7xx,$c(31)_"o"_toold,$c(31)_"o"_to) 
      }
      if t7xxnew'="" s t7xxnew=t7xxnew_$c(10)_t7xx
      if t7xxnew="" s t7xxnew=t7xx
   } ; koniec cyklu spracovania jedneho tagu
   if t7xxnew'="" d ##class(MARC).setTagX(.handle,t7xxnew)
 } ; koniec cyklu tagov

 q
]]></Implementation>
</Method>

<Method name="symOdd1">
<Description>
jednoucelovy symbolik na pracu s oddeleniami</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    ;s OD=##class(MARC).getTagX(.handle,"C33g")
    ;if OD="" q
    
    s a=##class(MARC).getTagX(.handle,"70*",-1),a2=a
    s haveO=0
    
    f i=1:1:$l(a,$c(10))
    {
        s a1=$p(a,$c(10),i)
        s lp=##class(MARC).getSubTagStr(a1,"p")
        s lo=##class(MARC).getSubTagStr(a1,"o")
        if (lp'="UTIA-B") continue
        ; autor je domaci; ma oddelenie?
        if lo'="" s haveO=1
        
        ;s a1=##class(MARC).setSubTagStr(a1,$c(31)_"o"_OD)
        ;s $p(a,$c(10),i)=a1
    }
    ;if a=a2 q
    
    q 'haveO
    
    ;d ##class(MARC).setTagX(.handle,a)
]]></Implementation>
</Method>

<Method name="symFixC13">
<Description>
jednoucelovay symbolik (plus/minus) na prevod struktury C13
s opakovanym $a
na opakovania tagu C13 s jednym opakovanim podpola $a
03.12.07 rs
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    s s=##class(MARC).getTagX(.handle,"C13",-1)
    ; uz je opak.tag? (von)
    if $f(s,$c(10)) q
    
    s sa=##class(MARC).getSubTagStr(s,"a",-1)
    ; je len jedno $a? (von)
    if '$f(sa,$c(10)) q
    
    s r=""
    f i=1:1:$l(sa,$c(10))
    {
        s sa1=$p(sa,$c(10),i)
        if sa1="" continue
        
        if r'="" s r=r_$c(10)
        s r=r_"C13    "_$c(31)_"a"_sa1
        
    }
    
    d:r'="" ##class(MARC).setTagX(.handle,r)
]]></Implementation>
</Method>

<Method name="allowDeleteExX">
<Description>
blokacia vymazu zaznamov s urcitou podmienkou s vynimkou pre admina

04.12.22 tt; pridana kontrola na odmazavani verzi
13.12.07 rs; 
--
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[id,&handle]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%Library.String</ReturnType>
<Implementation><![CDATA[
    ; potrebujeme handle
    if '##class(MARC).getDATAX(.handle,id) 
    {
        ; ked nejde precitat zrejme neexistuje kasleme na  to
        q ""
    }
    s sT001=$$$HandleT001(handle) 
    ; 0/1 ci aktualne prihlaseny uzivatel je admin
    ; pozor funguje len pre niektore pripady viz description volanej metody
    ; 13.12.07 rs
    s bUserIsAdmin=..userIsAdmin() 
    s sRZ=##class(MARC).getTagX(.handle,"C26d")
    ; 0/1 ci je zaznam nastaveny na export do RIV
    s bExportRIV=+##class(MARC).getTagX(.handle,"C26b")
    
    /// 13.12.13 tt; overeni a allowDelete, jestli dany zaznam nema nejak fulltexty
    s errContentD=..allowDeleteContent(.handle)
    q:(errContentD'="") errContentD
    
    s sTC99d=$$$getTagX(.handle,"C99d")
    if ((sTC99d="DFLT_DATA")&&($$$getTagX(.handle,"U03a")'=""))
    {
      s sLastRozpr=##class(User.CavUnEpca).versionDataGetLastVersion(.handle,1)            
      if ('$f(sLastRozpr,sT001))
      { ; 04.12.22 tt; pridana kontrola na odmazavani verzi
        q "|ERRUSR_CAV06#Není možné vymazat dataset, pokud má rozpracované či vyšší verze."  
      } 
    }
    
    ; 08.09.16 tt; upraven rok v podmince pro povoleni mazana dat jinemu uzivateli, nez administratorovi
    ; podmienka pre blokaciu vymazu zaznamu beznemu uzivatelovi
    if (('bUserIsAdmin)&&(sRZ'=..#cAktRokZberu)&&(bExportRIV))
    {
        q "|ERRUSR_CAV04#Smazání záznamu povoleno jenom administrátorovi systému"
    }
    
    s sTC64=##class(MARC).getTagX(.handle,"C64")
    if (('bUserIsAdmin)&&(sTC64'=""))
    { ; 25.02.15 tt; pridana kontrola na C64 
      q "|ERRUSR_CAV05#Smazání záznamu povoleno jenom administrátorovi systému. Obsahuje tag C64."
    }
    
    ; 07.12.12 jk; handle.net
    ; metoda pro automaticke provazani se serverem handle.net (User.CavS)CreateHandleNet
    s sC60=$$$getTagX(.handle,"C60")
    if (sC60'="") {
      ; zmeni se URL handle.net vymazaneho zaznamu na spolecnou stranku ipacu
      d ##class(util.handleNet).addHandleNet(.handle,"11104",7,"modify")
    }
    
    q ""
]]></Implementation>
</Method>

<Method name="progPOGetOddAut">
<Description>
pre dane $3 (lname*t001) autority zistit oddlenie z aut.zaznamu (C06$h)
pouziva sa cache

11.01.08 rs; podprogram pre progPrenosOdd
---</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&bAutOdd,s3]]></FormalSpec>
<Implementation><![CDATA[
    ; lookup in cache   
    s s=$g(bAutOdd(s3)) if s'="" q s
    
    if '##class(MARC).readLX(.ha,s3)
    {
        w !,"  could not read auth record by $3="_s3 
        q ""
    }
    s sOdd=##class(MARC).getTagX(.ha,"C06h")
    ; ulozit do cache
    s bAutOdd(s3)=sOdd
    q sOdd
]]></Implementation>
</Method>

<Method name="progPrenosOdd">
<Description>
program na prenos oddelania z osobnych autorit do  bib zaznamov 
prejde vsetky urcene bib zaznamy a preveri, ci vsetci autori
s pracoviskom maju vyplnene oddelenie

11.01.07 rs; program na porovnanie a doplnenie oddeleni z aut.zaznamov do
             bib.zaznamov.
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>psYear,psPrac=""</FormalSpec>
<Implementation><![CDATA[
    d ##class(UtilSel).XselIndex(..classNameX()_" yev ] "_psYear)
    s c=##class(Util).XlistCount($$$ListsActiveSel,$j)
    if 'c w !,"ERROR: no records found!" q
    
    if psPrac'="" d ##class(UtilSel).Xselect("&& C26e ] "_psPrac)
    s c=##class(Util).XlistCount($$$ListsActiveSel,$j)
    if 'c w !,"ERROR: no records found (after workplace filter)!" q
    
    s idx=""
    f   
    {
        s idx=$o(^$$$ListsG($$$ListsActiveSel,$j,idx)),id=idx q:idx=""
        if $f(id,"*") s id=$p(id,"*",2) ; if the list was sorted - fixup
        
        if '##class(MARC).getDATAX(.handle,id) w !,"error reading record by id="_id continue
        s sT001=$$$HandleT001(handle)
        s sPravV=##class(MARC).getTagX(.handle,"C26e")
        
        s sAU=##class(MARC).getTagX(.handle,"70*"),sAUO=sAU
        s nAUC=$l(sAU,$c(10))
        f i=1:1:nAUC
        {
            s sAU1=$p(sAU,$c(10),i) if sAU1="" continue
            s sa=##class(MARC).getSubTagStr(sAU1,"a")   
            s sb=##class(MARC).getSubTagStr(sAU1,"b")   
            
            s s3=##class(MARC).getSubTagStr(sAU1,"3")       ; kod autority
            s sp=##class(MARC).getSubTagStr(sAU1,"p")       ; pracovisko
            s so=##class(MARC).getSubTagStr(sAU1,"o")       ; oddelenie
            if (s3="") || (sp="") continue 
            
            s sOddA=..progPOGetOddAut(.bAutOdd,s3)
            
            s sPre=sT001_"("_sPravV
            if so'="" s sPre=sPre_",odd: "_so
            s sPre=sPre_")"
            s sPre=sPre_", "_$$$trim(sa_" "_sb_" "_sp)_": "
            
            
            if (sOddA="")
            {
                w !,sPre_" autorita nema vyplneno oddeleni" continue
            }
            if so'="",sOddA'=so 
            {
                w !,sPre_" oddeleni v autorite '"_sOddA_"' (ruzne od hodnoty v bib.zaznamu)" 
                continue
            }
            if so="",sOddA'=""
            {
                w !,sPre_" oddeleni v bib.zaznamu bude doplneno na '"_sOddA_"'" 
                
                s sAU1=##class(MARC).setSubTagStr(sAU1,$c(31)_"o"_sOddA)
                s $p(sAU,$c(10),i)=sAU1
                continue
            }
        }
        
        if sAU'=sAUO
        {
            d ##class(MARC).setTagX(.handle,sAU)
            
            ;******ZMENIT
            s sUser="spiegel",sDescr="Prenos oddelenia"
            ;******
            
            s sChronMode=3_$c(10)_sUser_$c(10)_sDescr
            d ##class(MARC).writeX(.handle,,,,sChronMode)
            w !,"ZAPIS zaznamu: "_sT001
        }
    }
    
    w !,!,"OK"
]]></Implementation>
</Method>

<Method name="progPrenosOddVypis">
<Description>
export autorit
s sy="##class(CavUnEpca).progPrenosOddVypis(.handle)"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<Implementation><![CDATA[
    s sa=$$$trim(##class(MARC).getTagX(.handle,"200a")_" "_##class(MARC).getTagX(.handle,"200b"))
    s sd=$$$trim(##class(MARC).getTagX(.handle,"C06d"))
    s so=$$$trim(##class(MARC).getTagX(.handle,"C06h"))
    w !,##class(User.UtilIE).crepVal(sd)_","
        _##class(User.UtilIE).crepVal(sa)_"," 
        _##class(User.UtilIE).crepVal(so)
]]></Implementation>
</Method>

<Method name="symSetPracAuth">
<Description>
Uprava dat Epca
1. prochazim zaznamy EPCA podle zvoleneho ustavu (index ustav  pr:UIACH-O)
   a za dane obdobi podle indexu rok vydani (pr rok vydani 2005-2009)
2. prohledavam kazdy tag 7xx
3. pokud ma vyplnene 7**$o koncim
4 pokud ma 7xx $p = zvoleny ustav, pokracujeme
5. najdu autora s vazbou do autorit v $3
6. nactu si zaznam autora z autorit, pokud ma vyplnene c06$h, vlozim ho do zaznamu epca
Parametry: pDtZac  - zacatecni datum
           pDtKon  - konecne datum
           pPrac   - pracoviste 
           pZapis  - jestli zapisovat zmeny 1

07.12.09 tt; zalozena metoda</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pDtZac,pDtKon,pPrac,pZapis=0</FormalSpec>
<Implementation><![CDATA[
  ; 1. prochazim zaznamy EPCA podle zvoleneho ustavu (index ustav  pr:UIACH-O)
  ;    a za dane obdobi podle indexu rok vydani (pr rok vydani 2005-2009)
  d ##class(User.Util).XselIndex("CavUnEpca ye bt "_pDtZac_"~"_pDtKon)
  d ##class(User.Util).Xselect("&&CavUnEpca !pra = "_pPrac)
  s idx="",id="", brk=0
 
  f  
  { ; cyklus pro prochazeni vyselektovanych zaznamu
    s idx=$o(^$$$ListsG($$$ListsActiveSel,$j,idx)),id=idx
    q:((id="") || brk)   ; koncim, pokud uz nemam data
    
    ;Zpracovavani jednoho zaznamu
    if '##class(User.MARC).getDATAX(.handle,id) s brk=1 s err="err: symSetPracAuth - record id:"_id_" not found!" w !,err continue
    s s=##class(User.MARC).getTagX(.handle,"70*",-1),sOLD=s continue:s=""
    s sT001=$$$HandleT001(handle)
    
    f i=1:1:$l(s,$c(10))
    { ;  2. prohledavam kazdy tag 7xx
      s s1=$p(s,$c(10),i)   ; nacteme jedno opakovani 7xx
      s sO=##class(User.MARC).getSubTagStr(s1,"o")  ; oddelenie
      continue:(sO'="")     ; 3. pokud ma vyplnene 7**$o koncim
      s sP=##class(User.MARC).getSubTagStr(s1,"p")  ; pracovisko
      continue:((sP="") ||(sP'=pPrac))    ; 4. pokud ma 7xx $p = zvoleny ustav, pokracujeme
      s s3=##class(User.MARC).getSubTagStr(s1,"3")  ; odkaz
      if '##class(User.MARC).readLX(.handleA,s3) continue
      ; heslo anglicky je v 960a
      s tC06h=##class(User.MARC).getTagX(.handleA,"C06h") 
      
      s:(tC06h'="") s1=s1_$c(31)_"o"_tC06h ; pridano oddeleni
      s $p(s,$c(10),i)=s1   ; ulozime do retezce jedno opakovani 7xx
    }
    
    ; kontroly jestli probehla zmena
    continue:(s=sOLD)
    w !,"Zaznam: "_sT001_"  --------------------------------------------"
    w !,"  Puvodni:   "
    for j=1:1:$l(sOLD,$c(10)) { w !,"  ",$p(sOLD,$c(10),j)}
    w !,"  Novy:   "
    for l=1:1:$l(s,$c(10)) { w !,"  ",$p(s,$c(10),l)}
        
    if $l(s)<8 b    
    if (pZapis=1)
    { ; pokud mam zapisovat
      d ##class(User.MARC).setTagX(.handle,s)   ; 
      s st=##class(User.MARC).writeX(.handle)   ; ulozeni handlu
      if '$$$ISOK(st) w !,"Error: record written to database."     
    }
  }
]]></Implementation>
</Method>

<Method name="cmdFullTextUp">
<Description><![CDATA[
<pre>
Uzivatelsky WS command. Pripojeni dokumentu/souboru k EPCA zaznamu.
Metoda bezi ve dvou rezimech:
- vraci informace o nalezenych 856
- vraci nazvy souboru bez pripon, pro ulozeni dokumentu
- vytvari nove opakovani tagu 856 do EPCA zazamu
Parametry:
 sClass    format object name nebo lname
 sParams   parametry WS commandu, oddeleny mezerou
           [1] login skriptu
           [2] heslo skriptu
           [3] idx epca zaznamu
           [4] kolik vygenerovat nazvu souboru
           [5] od pozice 5 data pro vytvareni 856, oddelovac "|"
           [5,1] originalni file name
           [5,2] velikost souboru v KB
           [5,3] URL do uloziste
           [6,1] originalni file name
           [6,2] velikost souboru v KB
           [6,3] URL do uloziste
            ... atd
           Pr. "cavcftu_$c(10)_TqMcVX5d_$c(10)_cav_un_epca*123456"  - pozadavek na informace ze 856
               "cavcftu_$c(10)_TqMcVX5d_$c(10)_cav_un_epca*123456_$c(10)_5"  - pozadavek na 5 novych nazvu souboru
               "cavcftu_$c(10)_TqMcVX5d_$c(10)_cav_un_epca*123456_$c(10,10)_orig1.pdf|http://uloziste/cav_un_epca*123456_01.pdf|1024|sign|date_$c(10)_orig2.pdf|2048|http://uloziste/cav_un_epca*123456_02.pdf|2048|sign|date"  - ulozeni dvou novych 856 
Return:
standardni odpoved WS sluzby, data od radku 20:
radek 4:
  - pocet nalezenych 856
  - pocet generovanych nazvu souboru
  - pocet nove vytvorenych 856
radek 5:
  - predana trida
radek 6:
  - obsah &params
radek 7:
  - zkratka ustavu zpracovatele (prihlaseneho)
od radku 20:      
 "orignazev velikost url" nebo ""  - informace o nalezenych 856, radek = info z 856
 "nazevsouboru"                    - nazvy souboru bez pripon
 ""                                - vytvoreni novych 856 

13.01.15 jk; do ws commands se predava pEnvironment
22.10.10 tt; upraven oddelovac nazvu souboru pro parsovani
21.10.10 jk; zmene oddelovac mezera za znak $c(10)
11.10.10 jk; na radku c.7 se predava zkratka ustavu prihlaseneho
05.10.10 jk; uprava v err code
29.09.10 kp; jako odělovač pro sOutput je použit znak |
29.09.10 ln; cmdFullTextUp: pridano ukladani a chronologie
22.09.10 jk; v nazvu soubour zamena hvezdicky v idx za pomlcku
14.09.10 jk; zalozeno
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&pEnvironment,sClass:%String,sParams:%String]]></FormalSpec>
<Implementation><![CDATA[
  s sOutput=""   ; obsah odpovedi od radku 20
  s inf=""       ; info sluzby na radku 4
  
  ; prevod lname na object name
  if ($e(sClass,1)'?1U) s sClass=##class(User.Util).lname2objectName(sClass)
  
  s sUser=$p(sParams,$c(10),1)            ; ocekava se "cavcftu"
  s sPw=$p(sParams,$c(10),2)              ; ocekava se "TqMcVX5d"
  s sIdx=$p(sParams,$c(10),3)             ; lname*T001 zaznamu CavUnEpca
  s nCnt=$p(sParams,$c(10),4)             ; pocet generovanych nazvu souboru 
  s sFiles=$p(sParams,$c(10),5,9999)      ; URL adresy souboru, pro ulozeni do 856
  s sUstav=""                             ; zkratka ustavu prihlaseneho z ISU_600b
  
  ; overeni ze volajicim je nas php skript
  ; nesouvisi nijak s overovanim ve WS, je to interni vec tohoto commandu
  if (sUser'="cavcftu") && (sPw'="TqMcVX5d")
  { d ##class(i2.ws.output).showErr($$$I2WSErrCommandS(0,"FTU"),"Error: bad script username or password",0)  q 0 }
  
  ; idx musi byt predano vzdy, nacte se zaznam
  if '##class(User.MARC).readLX(.handle,sIdx)
  { d ##class(i2.ws.output).showErr($$$I2WSErrCommandS(1,"FTU#"_sIdx),"Error: bad record idx="_sIdx,0)  q 0 }
   
  if (nCnt="") && (sFiles="")                                         
  { ; vratit info z 856tek
    s c=0
    do
    {
      s s856=##class(User.MARC).getTagX(.handle,"856",.c)
      s sign=##class(User.MARC).getSubTagStr(s856,"x")
      ; priznak A - uloziste vlastni, priznak N - uloziste NUSL, ostatni nebrat
      continue:((sign'="A") && (sign'="N"))             
      
      s sOrigName=##class(User.MARC).getSubTagStr(s856,"n")
      s nSize=##class(User.MARC).getSubTagStr(s856,"s")
      s sUrl=##class(User.MARC).getSubTagStr(s856,"u")
      s date=##class(User.MARC).getSubTagStr(s856,"e")
      
      //s sOutput=sOutput_sOrigName_" "_nSize_" "_sUrl_$$$LF
      s sOutput=sOutput_sOrigName_"|"_sUrl_"|"_nSize_"|"_sign_"|"_date_$$$LF
      s inf=inf+1                                                      ; pocet nalezenych 856
    }while c'=0
  }
  elseif ($isvalidnum(nCnt)) && (nCnt>0) && (sFiles="")                
  { ; generovat nove nazvy souboru
    
    ; 11.10.10 jk; na radku c.7 se predava zkratka ustavu prihlaseneho
    s sLogin=$g(^$$$I2G($$$cI2GNodeSession,$g(%arlsid),"login"))
    s sT001U=$p(sLogin,$c(10),3)
    s sClassU=$p(sLogin,$c(10),4)
    if (sT001U'="") && (sClassU'="")
    { 
      if ##class(User.MARC).readX(.handleU,sClassU,sT001U)
      { s sUstav=##class(User.MARC).getTagX(.handleU,"600b") }
    }
        
    ; napocitat jen 856 s $$x=A nebo N
    s c=0, n856Cnt=0
    do
    {
      s s856=##class(User.MARC).getTagX(.handle,"856",.c)
      s sign=##class(User.MARC).getSubTagStr(s856,"x")
      ; priznak A - uloziste vlastni, priznak N - uloziste NUSL, ostatni nebrat
      continue:((sign'="A") && (sign'="N"))
      s n856Cnt=n856Cnt+1             
    }while c'=0
    
    ; generovat nazvy souboru
    f i=1:1:nCnt
    {
      s nPor=##class(User.Util).leadingZero(n856Cnt+i,2)               ; poradi
      ; 22.09.10 jk; v nazvu souboru zamena hvezdicky v idx za pomlcku
      s sId=$p(sIdx,"*")_"-"_$p(sIdx,"*",2)                            ; lname-t001
      s sNewName=sId_"_"_nPor
      s sOutput=sOutput_sNewName_$$$LF
    }
    s inf=i                                                            ; pocet generovanych nazvu souboru
  }
  elseif (nCnt="") && (sFiles'="")                                     ; ulozit 856
  {
    ; 22.10.10 tt;  upraven oddelovac nazvu souboru pro parsovani
    s nFilesCnt=$l(sFiles,$c(10))
    f i=1:1:nFilesCnt
    {
      s sOneFile=$p(sFiles,$c(10),i)
      continue:sOneFile=""
      
      ; vytvorit 856
      s sOrigName=$p(sOneFile,"|",1)
      s sUrl=$p(sOneFile,"|",2)
      s nSize=$p(sOneFile,"|",3)
      s sign=$p(sOneFile,"|",4)
      s date=$p(sOneFile,"|",5)
      
      s s856="856    "_$c(31)_"n"_sOrigName_$c(31)_"u"_sUrl_$c(31)_"s"_nSize_$c(31)_"x"_sign_$c(31)_"e"_date
      d ##class(User.MARC).appendLineX(.handle,s856)
    }
    s inf=i                                                            ; pocet nove vytvorenych 856
    
    ; 29.09.10 ln; cmdFullTextUp: pridano ukladani a chronologie
    s sUserT001=##class(i2.ws.auth).getUserName()
    s sChronology="3"_$c(10)_"fulltext "_sUserT001_$c(10)_##class(i2.common).getIP()
    if '##class(User.MARC).writeX(.handle,,,,sChronology)
    { d ##class(i2.ws.output).showErr($$$I2WSErrCommandS(2,"FTU#"_sIdx),"Error: write error, idx="_sIdx,0)  q 0 }
  }
  else
  {
    ; nepodporovany dotaz
    d ##class(i2.ws.output).showErr($$$I2WSErrCommandS(3,"FTU#"_sIdx_"#"_nCnt_"#"_sFiles),"Error: bad request, check url parameter idx="_sIdx_", cnt="_nCnt_", file="_sFiles,0)
    q 0
  }
  
  s:sOutput'="" $e(sOutput,$l(sOutput))=""
  
  d ##class(i2.ws.output).showSystemLine()          ; radek 1
  d ##class(i2.ws.output).outputAdd("0"_$c(10))     ; radek 2 0 - ok
  d ##class(i2.ws.output).outputAdd($c(10))         ; radek 3 popis chyby prazdny 
  d ##class(i2.ws.output).outputAdd(inf_$c(10))     ; radek 4 info
  d ##class(i2.ws.output).outputAdd(sClass_$c(10))  ; radek 5 predana trida
  s sParamEsc=##class(User.Util).strswap(sParams,$c(10)," ")
  d ##class(i2.ws.output).outputAdd(sParamEsc_$c(10)) ; radek 6 predane &params
  d ##class(i2.ws.output).outputAdd(sUstav_$c(10))  ; radek 7 zkratka ustavu
  d ##class(i2.ws.output).outputAdd($c(10,10,10,10,10,10,10,10,10,10,10,10))  ; r.c.4-19 info commandu, zatim prazdne
  d ##class(i2.ws.output).outputAdd(sOutput)
  q 1
]]></Implementation>
</Method>

<Method name="test">
<Description><![CDATA[
<pre>
d ##class(User.CavUnEpca).test()
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
  ;d ##class(User.MARC).readX(.handle,"CavUnEpca","0020034")  
  ;d ##class(User.MARC).setTagX(.handle,"C63    "_$c(31)_"asfsdf"_$c(31)_"bfssdfsdf")
  ;d ..createAuthLinksC63(.handle)
  ;b
  ; s BibCit=..getBibcitCAV(.handle)
  s gnDEBUG=1
   ;s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0374147~0356915 @PRAC,T16r  . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,T16c-ImpaktFakt,C26b-ExportDoRIV,101a-JazykDok,@PRAC-Ustav,001-SysNo,%rep-CisloVyskytuPracVZazn,@ODDELV-Odd,@ODDELPOC-PocOdd,@AUTPOC-PocAut,@AUTDOMPOC-PocDomAut,@AUTDOMVYP-VypDomAut,@AUTDOMVYPODD-VypDomAOdd,@VYZZAM-VyzkumnyZamer¤h"") 1 1 . . . ."_$c(10)_"arl"_$c(10)_"127.0.0.1 ## i2ws 195VI5zy00 aRL ## F-CAV_36CFC76EE897B80F ## standalone v.2.5.170o1 (06.01.2012)"_$c(10)_"CMD_CAV_UN_EPCA")
   ;s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0394483~0385939 @PRAC,T16r  . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,T16c-ImpaktFakt,C26b-ExportDoRIV,101a-JazykDok,@PRAC-Ustav,001-SysNo,%rep-CisloVyskytuPracVZazn,@ODDELV-Odd,@ODDELPOC-PocOdd,@AUTPOC-PocAut,@AUTDOMPOC-PocDomAut,@AUTDOMVYP-VypDomAut,@VYZZAM-VyzkumnyZamer¤h"") 1 1 . . . . REPORTS_EPCA,EXCEL1"_$c(10)_"arl"_$c(10)_"31.192.72.7 ## i2ws 2409cdkh00 aRL ## F-CS_27E5A5D03F783424 ## standalone v.3.1.177b  (08.03.2013)"_$c(10)_"CMD_CAV_UN_EPCA")
  ; s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0396513 @PRAC,T16r  . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,T16c-ImpaktFakt,T16f-5LetyImpaktFakt,C26b-ExportDoRIV,101a-JazykDok,@PRAC-Ustav,001-SysNo,%rep-CisloVyskytuPracVZazn,@ODDELV-Odd,@ODDELPOC-PocOdd,@AUTPOC-PocAut,@AUTDOMPOC-PocDomAut,@AUTDOMVYPODD-VypDomAut,@VYZZAM-VyzkumnyZamer¤h"") 1 1 . . . . REPORTS_EPCA,EXCEL7"_$c(10)_"arl"_$c(10)_"90.179.145.222 ## i2ws 41bc2bGo00 aRL ## F-CS_27E5A5D03F783424 ## standalone v.3.2.185b  (19.03.2014)"_$c(10)_"CMD_CAV_UN_EPCA")

  ; s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0331908«!ye¤bt¤2010»2015«!exp¤=¤r«!exp¤=¤a«'!dk¤=¤W @TYMT,T16r  . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,@USTAV_T_ENG-Ustav_eng,@USTAV_T_CZ-Ustav_cze,@USTAV_T_ZK-Ustav_zkr,001-SysNo,@UTWOS-UT_WOS,463/011a-ISSN,463/200a-NazevSZP,@TYM_T_OBOR-Obor,@TYM_T_PODOBOR-Podobor,@TYM_T_CZ-Tym_cze,@TYM_T_ENG-Tym_eng,@TYM_T_PEERREV-Tym_rev¤h"") 1 1 . . . . REPORTS_EPCA,EXCEL11"_$c(10)_"arl"_$c(10)_"31.192.84.101 ## i2ws 44ytfaBR00 aRL ## F-CAV_E84BF582EC7946A3 ## standalone v.3.3.198c  (25.02.2015)"_$c(10)_"CMD_CAV_UN_EPCA")
  ;s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0360090«!ye¤bt¤2010»2015«!exp¤=¤r«!exp¤=¤a«'!dk¤=¤W @TYMT,T16r  . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,@USTAV_T_ENG-Ustav_eng,@USTAV_T_CZ-Ustav_cze,@USTAV_T_ZK-Ustav_zkr,001-SysNo,@UTWOS-UT_WOS,463/011a-ISSN,463/200a-NazevSZP,@TYM_T_OBOR-Obor,@TYM_T_PODOBOR-Podobor,@TYM_T_CZ-Tym_cze,@TYM_T_ENG-Tym_eng,@TYM_T_PEERREV-Tym_rev¤h"") 1 1 . . . . REPORTS_EPCA,EXCEL11"_$c(10)_"arl"_$c(10)_"90.179.145.222 ## i2ws 4b8oslQh00 aRL ## F-CAV_E84BF582EC7946A3 ## standalone v.3.3.198c  (25.02.2015)"_$c(10)_"CMD_CAV_UN_EPCA")
  ;s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0470478~0470480«!exp¤=¤r«!exp¤=¤a«'!dk¤=¤W @AUTORT,T16r  . 0 . ##class(util.ie.csv).report(.pEnvironment,""@AUTOR_ID-AutorID,C26e-Ustav_Vlas_Zaz,@AUTOR_RID-AutorRID,@AUTOR_JMENO-AutorJmeno,@AUTOR_USTAV-AutorUstav,001-SysNo,970b-DruhDokInterni,@DKREP1-DruhDokUprav,200a-Nazev,@AUTORI-Autori,T16r-RokUplatnVysl,017a-DOI,C60a-handle,@UTWOS-UT_WOS,463/011a-ISSN,463/200a-NazevSZP,U63v-rocnik,U63w-Cislo,U63u-RokVydani,010a-ISBN¤h"") 1 1 . . . . REPORTS_EPCA,EXCEL11"_$c(10)_"arl"_$c(10)_"90.179.145.222 ## i2ws 4bm3z8nU00 aRL ## F-CAV_E84BF582EC7946A3 ## standalone v.3.3.198c  (25.02.2015)"_$c(10)_"CMD_CAV_UN_EPCA")
  //s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0427939 @PRAC,T16r . . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,T16c-ImpaktFakt,T16f-5LetyImpaktFakt,C26b-ExportDoRIV,101a-JazykDok,@PRAC-Ustav,001-SysNo,%rep-CisloVyskytuPracVZazn,@ODDELV-Odd,@ODDELPOC-PocOdd,@AUTPOC-PocAut,@AUTDOMPOC-PocDomAut,@AUTDOMVYPODD-VypDomAut,@VYZZAM-VyzkumnyZamer,@RVO-RVO,463/011a-ISSN,463/011e-EISSN,@NAZEVSZP-NazevSZP,@HODKRIT_D-Qais,@HODKRIT_E-Qsjr,@HODKRIT_F-Qtc,@HODKRIT_C-IF_PCT,@HODKRIT_B-AIS_AL_PC,@HODKRIT_A-AIS_PCT,@HODKRIT_j-AIS,@HODKRIT_s-SJR¤csv"",""csv"") 1 1 . . . . REPORTS_EPCA,EXCEL7"_$c(10)_"arl"_$c(10)_"31.192.66.98 ## i2ws uVVm7mcQv1 aRL ## ## standalone v.3.4.214a  (18.01.2017)"_$c(10)_"CMD_CAV_UN_EPCA")
  //s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!T001¤=¤0432014«!ye¤bt¤2015»2019«!exp¤=¤a«'!dk¤=¤W @PRAC,T16r . . 0 . ##class(util.ie.csv).report(.pEnvironment,""970b-DruhDokInterni,@DKREP1-DruhDokUprav,T16r-RokUplatnVysl,T16c-ImpaktFakt,T16f-5LetyImpaktFakt,C26b-ExportDoRIV,101a-JazykDok,@PRAC-Ustav,001-SysNo,%rep-CisloVyskytuPracVZazn,@AUTPOC-PocAut,@AUTDOMPOC-PocDomAut,@VYZZAM-VyzkumnyZamer,@RVO-RVO,463/011a-ISSN,463/011e-EISSN,463/200a-NazevSZP,@HODOBOR-Obor,@HODPODOBOR-Podobor,@TYMV-Tym,@AUTDOMTYM-AutorTym,@AUTDOMVYPODD-VypDomAut,@NAZEVSZP-NazevSZP,@HODKRIT_D-Qais,@HODKRIT_E-Qsjr,@HODKRIT_F-Qtc,@HODKRIT_C-IF_PCT,@HODKRIT_B-AIS_AL_PC,@HODKRIT_A-AIS_PCT,@HODKRIT_j-AIS,@HODKRIT_s-SJR,C86a-Qtc_zavorky,C86b-Qtc_N.A.,C86c-Qtc_DT,C86d-Qtc_Obor¤csv"",""csv"") 1 1 . . . . REPORTS_EPCA,EXCEL10"_$c(10)_"arl"_$c(10)_"31.192.66.98 ## i2ws e52ui2Iduq aRL ## ## standalone v.4.1.247b  (06.06.2019)"_$c(10)_"CMD_CAV_UN_EPCA")
 

 ; s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnEpca,1 «¤»!dk¤=¤BCA«!ye¤bt¤2020»2021 970b . . 0 . ##class(util.ie.csv).report(.pEnvironment,""001-sysno,200a-periodikum,205a-OznaceniVydani,011a-ISSN,011e-EISSN,102a-zeme,@NAVZAZZJ-NavazaneZaznamy,@IFAKTHOD-ImpaktFaktor,@IFAKTROK-RokImpaktFaktoru,@QAISAKTHOD-Qais,@QAISAKTROK-RokQais,@DATUMVZNIKU-DatumVzniku�csv"",""csv"") 1 1 . . . . REPORTS_EPCA,EXCEL61"_$c(10)_"arl"_$c(10)_"31.192.66.98 ## i2ws 7ajw9LDfHL aRL ## ## standalone v.4.4.265b  (01.06.2021)"_$c(10)_"CMD_CAV_UN_EPCA")
  s ret=##class(User.Util).DBCommand("report ReportCommon exporta cav_is_user,cav_un_tablesd CavUnAuth,1 «¤»!przac¤bt¤2020»2021 !prpos . . 0 . ##class(util.ie.csv).report(.pEnvironment,""001-sysno,C31a-�stav_p��jemce,C35a-N�zev_projektu,230a-P�eklad_n�zvu_eng,230b-Program,230h-��slo_projektu,230r-CORDIS,230r-Poskytovatel_CEP,C28a-Poskytovatel_ostatn�,C28b-Poskytovatel_EU,C28c-Zem�,C29a-Za��tek,C29b-Konec,300a-Pozn�mka,@DATUMVZNIKU-datum_vytvo�en��csv"",""csv"") 1 1 . . . . REPORTS_UNA,EXCELPROJ"_$c(10)_"arl"_$c(10)_"31.192.66.98 ## i2ws JXbhcTAkPm aRL ## ## standalone v.4.4.265b  (01.06.2021)"_$c(10)_"CMD_CAV_UN_AUTH")
 
  ; b  ;tttttttttttttttttttt
  ;s sPomErr=""
  ;d ##class(MARC).t4xx2handle(.handle4,"463  1 "_$c(31)_"1011  "_$c(31)_"a978-80-86174-16-7"_$c(31)_"12001 "_$c(31)_"aProgram and abstracts book: The 15th European Conference on Personality"_$c(31)_"vS. 274-274"_$c(31)_"1210  "_$c(31)_"aBrno"_$c(31)_"cPsychologický ústav Akademie věd ČR"_$c(31)_"d2010"_$c(31)_"1702 1"_$c(31)_"aBlatný"_$c(31)_"bM."_$c(31)_"4340"_$c(31)_"1702 1"_$c(31)_"aHřebíčková"_$c(31)_"bM."_$c(31)_"4340"_$c(31)_"1702 1"_$c(31)_"aSlezáčková"_$c(31)_"bA."_$c(31)_"4340"_$c(31)_"1702 1"_$c(31)_"aKvětoň"_$c(31)_"bP."_$c(31)_"4340"_$c(31)_"1702 1"_$c(31)_"aVobořil"_$c(31)_"bD."_$c(31)_"4340")
  ;d ..createAuthLinks463genSZP(.handle4,"","ccc",.sPomErr) 
  b ; konec
]]></Implementation>
</Method>

<Method name="TfAutoriCav">
<Description><![CDATA[
<pre> Zobrazovani autoru do tagovaneho formatu
Parametry: result    - vysledny retezec
           handle    - aktualni zpracovavany handle
           parametry - oddelene "##"
                       1. prefix
                       2. oddelovac jmena a prijmeni autora 
                       3. oddelovac autoru
                       4. oddelovac doplnkovych informaci
                       5. zvyrazneni - 1 - tucne autor
                                       2 - tucne pomocne informace
                                       3 - tucne vse 
                       6. podtrzeni stylem - emph
                       7. hodnota oddelovace - zobrazeni ID z autority pokud neni prazdny
                       8. 1 - zobrazeni jen autoru, kteri maji ID
                       9. hodnota oddelovace lupy. Pokud je vyplneny, zobrazi se lupa uz zaznamu
                       10. ruzne nastaveni - G - nezobrazovat garanta
                                             SUB - nastaveni zobrazovani ID jako dolniho indexu
                                             EMAIL - zobrazovat korespondencniho autora
                                             70Xk - zobrazovat 70Xk u zaznamu   

22.01.18 tt; provedena uprava v autorech, aby pokud ma autor pracoviste, tak aby se nezobrazoval jazyk
08.06.14 tt; pridano zobrazeni korespondencniho autora 70Xz = K
14.06.13 tt; pridan parametr 10
12.06.13 tt; pridan parametr 9 pro zobrazeni lupy
07.06.13 tt; pridano zobrazeni ID na parametr 7
27.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
07.09.11 tt; zalozeno
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 s pPar1=$p(param,"##",1)               ; prefix
 s pPref=##class(rep.zf.tf).prefix(.handle,pPar1)_" : "       ; prefix 
 s pPar2=$p(param,"##",2)               ; oddelovac jmena a prijemni autora
 s:(pPar2="") pPar2=", "                ; defaultni hodnota
 s pPar3=$p(param,"##",3)               ; oddelovac autoru
 s:(pPar3="") pPar3=" - "               ; defaultni hodnota
 s pPar4=$p(param,"##",4)               ; oddelovac doplnkovych informaci
 s:(pPar4="") pPar4=" "                 ; defaultni hodnota 
 s pPar5=$p(param,"##",5)               ; oddelovac doplnkovych informaci
 s:(pPar5="") pPar5="3"                 ; defaultni hodnota 
 s pPar6=$p(param,"##",6)               ; podtrzeni stylem
 s:(pPar6="") pPar6=""                  ; defaultni hodnota 
 s pPar7=$p(param,"##",7)               ; zobrazeni id u autoru
 s pPar8=$p(param,"##",8)               ; zobrazeni jen autoru, kteri maji ID
 s pPar9=$p(param,"##",9)               ; Oddelovac lupy
 s pPar10=$p(param,"##",10)             ; ruzne nastaveni 

 s nLBlock=$o(result(""),-1)+1         ; zjisti posledni blok
 s c=0,sRes="",bPouzG=0,bExG=0
 ; pomocne projiti vsech 70*
 d { ; zjistime si, jestli je nekde v zaznamu v podpoli z hodnota G
    s sT70X=$$$getTagXC(.handle,"70*",.c) ; projdu vsechny opakovani
    continue:(sT70X="")
    s sT70Xz=$$$getSubTagStr(sT70X,"z")
    s:($zcvt(sT70Xz,"L")="g") bExG=1    
 } while (c'=0)  
  
 ; postupny vypis
 ; . prochazeni zaznamu podle .c    
 s c=0
 d {
   s sT70X=$$$getTagXC(.handle,"70*",.c) ; vsetky citacie
   continue:((sT70X="")&&(c'=0))
   if (sT70X'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sName="",sEd="",sData=""
     s sT70Xa=$$$getSubTagStr(sT70X,"a")
     s sT70Xb=$$$getSubTagStr(sT70X,"b")
     s sT70Xp=$$$getSubTagStr(sT70X,"p")
     s sT70X4=$$$getSubTagStr(sT70X,"4")
     s sT70Xz=$$$getSubTagStr(sT70X,"z")
     s sT70Xy=$$$getSubTagStr(sT70X,"y")
     s sT70X3=$$$getSubTagStr(sT70X,"3")
     s sT70Xk=$$$getSubTagStr(sT70X,"k")
     
     ; 22.01.18 tt; provedena uprava v autorech, aby pokud ma autor pracoviste, tak aby se nezobrazoval jazyk 
     s:(sT70Xp'="") sT70Xy="" 
          
     ; pridani editora
     if ((sT70Xa'="")&&(sT70Xb'="")) { s sNames=sT70Xa_pPar2_sT70Xb }
     elseif ((sT70Xa'="")||(sT70Xb'="")) { s sNames=sT70Xa_sT70Xb }
     ; 27.01.11 tt; zvyrazneni a potrzeni domacich autoru + pridani "G"
     d ..BibcitSzfAuthorsG(.sNames,.bPouzG,bExG,sT70Xz,sT70Xp)
     s:(pPar5="1") sNames="<strong>"_sNames_"</strong>"    
     
     ; seskladani pomocnych informaci k autorovi
     s:(sT70X4="340") sEd="ed." 
     if ((sEd'="")&&(sT70Xp'="")) { s sT70Xp=sT70Xp_pPar4_sEd}
     else { s sT70Xp=sT70Xp_sEd}     
     
     if ((sT70Xp'="")&&(sT70Xy'="")) { s sData="("_sT70Xp_pPar4_sT70Xy_")" }
     elseif((sT70Xp'="")||(sT70Xy'="")) { s sData="("_sT70Xp_sT70Xy_")" }
     s:(pPar5="2") sNames="<strong>"_sData_"</strong>" 
     
     ; 10.03.21 tt; doplnena volba u autoru na zobrazovani 70Xk - volba 70Xk
     if ($f(","_pPar10_",",","_"70Xk"_",")&&(sData'="")&&(sT70Xk'="")) { s sData=sData_" ["_sT70Xk_"]" }  
     
     s sIDAuth=""
     if ((pPar7'="")&&(sT70X3'=""))
     { ; 07.06.13 tt; pridano zobrazeni ID na parametr 7
       if ##class(User.MARC).readLX(.handlea70X,sT70X3)
       { ; pokud se nam podarilo autoritu otevrit
         s caa=0
         d { ; cyklus pres vsechny ID
           s sT035=$$$getTagXC(.handlea70X,"035",.caa) ; vsechny ID
           continue:((sT035="")&&(caa'=0))
           s sT035a=$$$getSubTagStr(sT035,"a")
           s sT0352=$$$getSubTagStr(sT035,"2")
           ; 23.11.22 tt; zmena linku pro RID https://www.researcherid.com/rid/H-2591-2014 - původní - https://www.webofscience.com/wos/author/record/H-2591-2014 nový
           if (sT0352="WOS")
           { ; link do wosu
             s sWosT=##class(rep.zf.tf).prefix(.handle,"U073")
             s sWosP=##class(rep.zf.tf).prefix(.handle,"U074")
             if ($f(","_pPar10_",",","_"KLIENT"_","))
             {
                s sIDAuth=sIDAuth_", <a href=""https://www.webofscience.com/wos/author/record/"_sT035a_""" title="""_sWosP_""">"_sWosT_"</a>"
             }
             else
             {
                s sIDAuth=sIDAuth_", <a href=""https://www.webofscience.com/wos/author/record/"_sT035a_""" target=""_blank"" title="""_sWosP_""">"_sWosT_"</a>"
             }
           }
           if (sT0352="ORCID")
           { ; link do ORCID
             s sOrcidT=##class(rep.zf.tf).prefix(.handle,"U075")
             s sOrcidP=##class(rep.zf.tf).prefix(.handle,"U076")
             if ($f(","_pPar10_",",","_"KLIENT"_","))
             {
                s sIDAuth=sIDAuth_", <a href=""https://orcid.org/"_sT035a_""" title="""_sOrcidP_""">"_sOrcidT_"</a>"
             }
             else
             {
               s sIDAuth=sIDAuth_", <a href=""https://orcid.org/"_sT035a_""" target=""_blank"" title="""_sOrcidP_""">"_sOrcidT_"</a>"
             }
           }
           if (sT0352="SCOPUS")
           { ; link do scopusu
             s sScopusT=##class(rep.zf.tf).prefix(.handle,"U077")
             s sScopusP=##class(rep.zf.tf).prefix(.handle,"U078")
             if ($f(","_pPar10_",",","_"KLIENT"_","))
             {
                s sIDAuth=sIDAuth_", <a href=""https://www.scopus.com/authid/detail.url?authorId="_sT035a_""" title="""_sScopusP_""">"_sScopusT_"</a>"
             }
             else
             {
               s sIDAuth=sIDAuth_", <a href=""https://www.scopus.com/authid/detail.url?authorId="_sT035a_""" target=""_blank"" title="""_sScopusP_""">"_sScopusT_"</a>"
             }
           }   
           ; 05.12.18 tt; odstraneno zobrazeni RIVID pro autory
           /*if (sT0352="RIVID")
           { ; 13.08.15 tt; pridano zobrazovani linku RIVu
             s sRIVT=##class(rep.zf.tf).prefix(.handle,"U129")
             s sRIVP=##class(rep.zf.tf).prefix(.handle,"U130")
             s sIDAuth=sIDAuth_", <a href=""http://www.isvav.cz/findResultByFilter.do?typVyhledavani=advanced&resultType=&resultLanguage=&resultDataSuplier=&resultCode=&updateForm=&submitterOrgName=&submitterOrgCategory=&submitterICO=&submitterOrgUnit=&submitterOrgUnitCode=&submitterPersonSurname=&submitterPersonName=&vyzOrgRok="_(..#cAktRokZberu-1)_"&vyzOrgPoskyt=any&vyzOrg=0&authorSurname=&authorName=&authorId="_sT035a_"&resultName=&submitterYearFrom=&submitterYearTo=&resultYearFrom=&resultYearTo=&resultBranch=&resultAnnotation=&resultIsbn=&docName=&resultPagesFrom=&resultPagesTo=&resultConnectionType=&activityType=&activityCode=&resultProjectId=&resultResearchId=&formType=1"" target=""_blank"" title="""_sRIVP_""">"_sRIVT_"</a>" 
           }  */           
        
         } while (caa'=0)
         s:(sIDAuth'="") $e(sIDAuth,1,2)=""
       }  
       s:(sIDAuth'="") sIDAuth=pPar7_sIDAuth                          ; sloucime do vysledku 
       ;s sIDAuth=$tr("-/,",$c(1)_$c(2)_$c())   
     }   
     
     if (($f(pPar8,1))&&(sIDAuth=""))
     { ; pridana podminak o nezobrazovani autoru bez ID
       continue
     }
     
     ; 12.06.13 tt; pridan parametr 9 pro zobrazeni lupy
     if ((pPar9'="")&&(sT70X3'=""))
     { ; do ret vyrobit lupu 
       s ret3=##class(User.Util).strswap(sT70X3,"*","*1 ")    ; upravime si lupu
       s:($f(ret3,"*")>0) ret3="\qT001*"_ret3_"\q"            ; seskladame link
       s sNames=ret3_pPar9_sNames                             ; link
     }
     
     /// 14.06.13 tt; pridan parametr 10
     if ($f(","_pPar10_",",","_"G"_","))
     { ; 14.06.13 tt; pridano odstraneni garanta
       s sNames=$$$strswap(sNames,".sup.G./sup.","")
     }
     if ($f(","_pPar10_",",","_"SUB"_","))
     { ; 14.06.13 tt; pridano pridani dolniho indexu u linku na ID autora
       s sIDAuth=".sub."_sIDAuth_"./sub."
     }
     if ($f(","_pPar10_",",","_"EMAIL"_",")&&((sT70Xz="K")||(sT70Xz="A")))
     { ; 08.06.14 tt; pridano zobrazeni korespondencniho autora 70Xz = K
       s sKorAuthor="<img src=""https://asep.lib.cas.cz/i2/s1/icons/email.gif"" alt=""Korespondenční autor"" />"
       s sData=sData_" "_sKorAuthor
     }
     
     ; seskladani vysledku
     if ((sNames'="")||(sData'=""))
     { ; seskladavame postupne vysledek
       s:((sData'="")&&(sNames'="")) sData=" "_sData    ; oddeleni pomocnych udaju
       s sRes1=sNames_sData                              ; soouceni dat 
       s:(sIDAuth'="") sRes1=sRes1_sIDAuth
       s:(pPar5="3") sRes1="<strong>"_sRes1_"</strong>"           ; zvyrazneni  
       s sRes1=sRes1_pPar3                              ; dame oddelovac    
       s sRes=sRes_sRes1                                ; sloucime do vysledku
     }
     
     if (($f(pPar6,"emph"))&&($f(sRes,"./u.")))
     { ; 27.10.12 tt; pridano klicove slovo, kterym lze nahradit ./u.
       s sRes=$$$strswap(sRes,".u.",".emphasis.")
       s sRes=$$$strswap(sRes,"./u.","./emphasis.")  
     }    
     
     if ($l(sRes)>10000) ; udelani bloku na prvni urovni
     { ; pokud je delka delsi jak 10000, tak dej dalsi result
       s result(nLBlock)=pPref_sRes, sRes=""  ; zapsani vysledku to resultu       
       s nLBlock=nLBlock+1                    ; zvyseni pocitadla bloku  
     }
   }
 } while (c'=0)
 
 s $e(sRes,($l(sRes)-($l(pPar3)-1)),$l(sRes))=""  ; odstraneni konecneho oddelovace
 
 if (sRes'="")
 { ; zaverecne ulozeni   
   s result(nLBlock)=pPref_sRes, sRes=""      ; zapsani vysledku to resultu    
   s nLBlock=nLBlock+1 ; zvyseni pocitadla bloku     
 }
]]></Implementation>
</Method>

<Method name="ExportCSV">
<Description>
05.04.13 tt; pridane exportni metoda. Metoda pro export musela byt
             presunuta do tmp a pridan tam export do
             d ##class(User.Util).xlogf("D:\tt415a515a",...)  
d ^X("l @"_sy)
;s sy="##class(User.CavUnEpca).ExportCSV(.handle)"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  ;d ##class(User.CavUnEpca).exportCSVSpol(.handle,"2","d:\ttt.csv")
  d ##class(User.Tmp1).exportCSVSoupis(.handle,"2","D:\ttt.csv")
  q 1
]]></Implementation>
</Method>

<Method name="TfRozsahStran">
<Description><![CDATA[
<pre> Zobrazovani strankovani u dokumentu
Parametry: result    - vysledny retezec
           handle    - aktualni zpracovavany handle
           parametry - oddelene "##"
                       1. prefix
                       2. text pro zobrazeni nestrankovane

08.05.13 tt; zalozeno
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s sRes=""
 s pPar1=$p(param,"##",1)               ; prefix
 s pPref=##class(rep.zf.tf).prefix(.handle,pPar1)_" : "       ; prefix 
 s pPar2=$p(param,"##",2)               ; oddelovac jmena a prijemni autora
 s:(pPar2'="") pPar2=##class(rep.zf.tf).prefix(.handle,pPar2)
 s pPar3=$p(param,"##",3)               ; oddelovac autoru

 s nLBlock=$o(result(""),-1)+1         ; zjisti posledni blok
 
 s t463=$$$getTagX(.handle,"463/200v")
 if (t463'="")
 { ; zjistujeme informace o 463
   s sRocnik="",sCislo="",sStrany=""
   ; mame 463/200v - preverit jeho strukturu
   ;s sStrany=##class(User.SPIndexC).blk46xvExtractDate(t463)
   d ##class(rep.epca.exportBase).exParse463(t463,0,.sRocnik,.sCislo,.sStrany,1)
   if (sStrany'="") 
   {
     s sStrany=$$$strswap(sStrany,";"," - ")
     s sRes=sStrany
   }
 }
 s C61a=$$$getTagX(.handle,"C61a")
 s:((pPar2'="")&&(C61a=1)) sRes=pPar2
 
 if (sRes'="")
 { ; zaverecne ulozeni   
   s result(nLBlock)=pPref_sRes, sRes=""      ; zapsani vysledku to resultu    
   s nLBlock=nLBlock+1 ; zvyseni pocitadla bloku     
 }
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
</Storage>

<Method name="TfVydUdaje">
<Description><![CDATA[
<pre> Uzivatelske zobrazeni vydavatelskych udaju
Parametry: result    - vysledny retezec
           handle    - aktualni zpracovavany handle
           parametry - oddelene "##"
                       1. prefix
                       2. text pro zobrazeni nestrankovane

10.07.13 tt; zalozeno
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s sRes=""
 s sDruhDok=..getBibcitCAVDD(.handle)
 
 if ((sDruhDok'="A")&&(sDruhDok'="A1")&&(sDruhDok'="A2")&&(sDruhDok'="C")&&(sDruhDok'="K")&&(sDruhDok'="J")&&(sDruhDok'="M")&&
     (sDruhDok'="N")&&(sDruhDok'="T1")&&(sDruhDok'="T2")&&(sDruhDok'="R1")&&(sDruhDok'="R2"))
 { ; vydavatelske udaje
   s sRes=##class(rep.zf.tf).fmtCsBVydav(.handle,param)
 }

 s nLBlock=$o(result(""),-1)+1         ; zjisti posledni blok
 s result(nLBlock)=sRes
]]></Implementation>
</Method>

<Method name="TfPuvPrace">
<Description><![CDATA[
<pre> Uzivatelske zobrazeni vydavatelskych udaju
Parametry: result    - vysledny retezec
           handle    - aktualni zpracovavany handle
           parametry - oddelene "##"
                       1. prefix

28.07.13 tt; zalozeno
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s sRes=""
 s sDruhDok=..getBibcitCAVDD(.handle)
 s pPar1=$p(param,"##",1)               ; prefix
 s pPref=##class(rep.zf.tf).prefix(.handle,pPar1)_" : "       ; prefix 

 if ((sDruhDok="T1")||(sDruhDok="T2")||(sDruhDok="T3")||(sDruhDok="R1")||(sDruhDok="R2"))
 { ; vydavatelske udaje
    s sRes47070x=..BibcitSzfAuthorsR(.handle)      //470/70x
    s sRes=sRes_sRes47070x
    s sRes470=$$$getTagX(.handle,"470") //[470/200a]
    s sRes470200a=""
    if (sRes470'="") 
    { s sRes470200a=##class(MARC).getTag4xx(sRes470,"200a")
      s:(sRes'="") sRes=sRes_": "_sRes470200a_""       
    }
 }
 s:(sRes'="") sRes=pPref_sRes
 s nLBlock=$o(result(""),-1)+1         ; zjisti posledni blok
 s result(nLBlock)=sRes
]]></Implementation>
</Method>

<Method name="getNameFT">
<Description><![CDATA[
<pre> Metoda pro vypsani vsech fulltextu u zaznamu do pomocneho pole Tft$a
Parametry: handle - aktualni zpracovavany handle
Navratova hodnota: retezec s nazvy fulltextu oddelenymi ", " 

06.02.14 jk; zruseny globalni promenne ictx a lang
29.11.13 tt; zalozena metoda
<\pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Library.String]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sT001=$$$HandleT001(handle)                ; ziskame si T001 zaznamu
  s sClass=$$$HandleClass(handle)              ; ziskame tridu zaznamu
  s NazevAll=""
  ; ziskame vsechny data k zaznamu v output
  d ##class(content.api).selectRecAll(.output,sClass,sT001)
    
  ; prochazime postupne cyklem vsech polozek k zaznamu
  s item=""      ; jedna polozka k zaznamu
  f 
  { 
    s item=$o(output(item)) q:item=""
    s repo=output(item,"repository")   ; ziskame repository
    s key=output(item,"key")           ; klice
  
    d ##class(content.api).getBatch(.array,repo,key)
    
    s sNazev=$g(array("origname"))
    continue:(sNazev="")               ; pokud nemame nazev, preskocime
    s:(NazevAll'="") NazevAll=NazevAll_", "_sNazev
    s:(NazevAll="") NazevAll=sNazev
  } ; konec cyklu prochazeni souboru k zaznamu
  q NazevAll
]]></Implementation>
</Method>

<Method name="allowDeleteContent">
<Description><![CDATA[
<pre> Metoda zabranujicici vymazani zaznamu, ktere maji nejak fulltexty. Je to dulezite,
aby pak v metadatech nevisely takoveto zaznamy.

zapojit do User.SPIntegrit - allowDelete
13.12.13 tt; overeni a allowDelete, jestli dany zaznam nema nejak fulltexty
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret=""
  s sT001=$$$HandleT001(handle)                ; ziskame si T001 zaznamu
  s sClass=$$$HandleClass(handle)              ; ziskame tridu zaznamu
   
  ; ziskame vsechny data k zaznamu v output
  d ##class(content.api).selectRecAll(.output,sClass,sT001)
    
  ; prochazime postupne cyklem vsech polozek k zaznamu
  s item=""      ; jedna polozka k zaznamu
  f { s item=$o(output(item)) q:item=""
    s repo=output(item,"repository")   ; ziskame repository
    s key=output(item,"key")           ; klice
    ; pokud nemame spravnou identifikaci preskocime
    continue:((repo="")&&(key=""))
    
    ; jakmile vim, ze mam data, vypisu chybu u zaznamu a ukoncim cyklus prochazeni 
    ;un_tablesd_common_base 200    aERR014bCHYBA
    s ret="|ERR014#CHYBA - Zaznam nelze smazat, protoze ma prilozeny plny text v repozitari."
    q
  } ; konec cyklu prochazeni souboru k zaznamu
 q ret ; vratime bude prazdnou hodnotu, nebo cely retezec
]]></Implementation>
</Method>

<Method name="prekladPrefixuIpac">
<Description><![CDATA[
<pre> Zalozena metoda pro preklad textu, pokud jde zf z ipacu. Vytvoreno pro specialni kodove
zobrazovaci formaty 

22.04.22 tt; provedeny změny, aby se prefixy propisovali + doplnili
16.08.14 tt; upraveny prefixy pro zf v metodach
16.08.14 tt; zalozena matoda pro preklad textu
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,text="",strong=0]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 s ret="" ; inicializovana navrahova hodnota na prichozi
 ; tady je verze, poku nefrcime z ipacu
 s:(text="U111") ret="Klíčová slova"
 s:(text="U109") ret="Institucionální podpora"
 s:(text="U114") ret="Zdroj financování"
 s:(text="0621") ret="Impakt faktor"
 s:(text="U115") ret="rok"
 s:(text="U108") ret="Grant CEP"
 s:(text="U112") ret="Kód oboru RIV"
 s:(text="U063") ret="Trvalý link"
 s:(text="U113") ret="Číslo patentu"
 s:(text="U085") ret="Datum udělení patentu"
 s:(text="U116") ret="Výzkumný záměr"
 s:(text="U088") ret="Číslo vzoru"
 s:(text="0898") ret="Vlastník"
 s:(text="U025") ret="Certifikační orgán"
 s:(text="U117") ret="Datum certifikace"
 s:(text="U011") ret="Technické parametry"
 s:(text="U012") ret="Ekonomické parametry"
 s:(text="0429") ret="Interní kód"
 s:(text="U118") ret="Obhájeno"
 s:(text="U119") ret="Druh výsledku"
 s:(text="U120") ret="Předpokl. rok uplatnění výsledku"
 s:(text="U121") ret="NEODESLÁN"
 s:(text="U122") ret="Datum podání přihlášky"
 s:(text="U086") ret="Datum udělení vzoru"
 s:(text="U124") ret="Dostupné z"
 s:(text="U125") ret="Předpokládaný rok uplatnění"
 s:(text="U126") ret="Typ dokumentu"
 s:(text="U087") ret="Číslo patentového spisu"
 s:(text="0943") ret="Datum obhajoby"
 s:(text="U131") ret="GRANT EU"
 s:(text="U208") ret="Prototyp"
 s:(text="U209") ret="Funkční vzorek"
 s:(text="U210") ret="Specializovaná mapa"
 s:(text="U211") ret="Certifikovaná metodika"
 s:(text="U212") ret="Léčebný postup"
 s:(text="U213") ret="Památkový postup"
 s:(text="U214") ret="Schválená metodika"
 s:(text="U215") ret="Akreditovaná metodika"
 s:(text="U216") ret="specializovaná veřejná databáze"
 s:(text="U217") ret="Patentový spis"
 s:(text="U218") ret="Dizertační práce"
 s:(text="U219") ret="Užitný vzor"
 s:(text="U220") ret="Průmyslový vzor"
 s:(text="U221") ret="Poloprovoz"
 s:(text="U222") ret="Ověřená technologie"
 s:(text="U223") ret="Odrůda"
 s:(text="U224") ret="Plemeno"
 s:(text="U225") ret="pořadatel"
 s:(text="U226") ret="Konference"
 s:(text="U227") ret="Workshop"
 s:(text="U228") ret="Výstava"
 s:(text="U235") ret="A3 : Přednáška/prezentace nepublikovaná"
 s:(text="U236") ret="Způsob prezentace"
 s:(text="U237") ret="Pořadatel akce"
 s:(text="U238") ret="URL akce"
 s:(text="U205") ret="Výzkumná infrastruktura"
 s:(text="U206") ret="Změna druhu dokumentu"
 s:(text="U207") ret="Způsob publikování"
 s:(text="U239") ret="IMPORT WOS – "
 s:(text="U240") ret=" … celkem XXXX autorů"
 s:(text="U241") ret="Diplicita"
 s:(text="U118") ret="Obhájeno"
 s:(text="U118") ret="Obhájeno"
 s:(text="U244") ret="Verze "
 s:(text="U245") ret="Nová verze záznamu."
 s:(text="U246") ret="Existuje novější verze datasetu"
 s:(text="U247") ret="Verze záznamu"
 s:(text="U248") ret="K záznamu existuje nová verze datasetu – záznam je rozpracovaný."
 s:(text="U249") ret="Úložiště"
 s:(text="U250") ret="Popis změny dat"
 s:(text="U251") ret=" [dataset]. Repozitář ASEP, "
 s:(text="U253") ret="Popis: ##Description: "
 s:(text="U254") ret="Číslo verze##Version number" 
 s:(text="U255") ret="Popis změny##Description of change"
 s:(text="U256") ret="Zadavatel##Submitter"
 s:(text="U257") ret="Publikováno##Published" 
 s:(text="U258") ret=" [dataset]. ## [dataset]. "
 s:(text="U259") ret="Repozitář ASEP, ##ASEP Repository, "
 
 if (##class(rep.zf.tf).bTfBlockRunningFromIpac(.handle))
 {
   ; preklad textu na prefix 
   s ret=##class(rep.zf.tf).prefix(.handle,text)
 }
 elseif (ret="")
 { ; 22.04.22 tt; provedeny změny, aby se prefixy propisovali + doplnili
   s s=##class(User.Util).sXlate("TF_PREFIXES",text,"UN","Cav",,2)
 }
 s:((strong=1)&&(ret'="")) ret=".b."_ret_"./b."
 q ret ; vratime bude prazdnou hodnotu, nebo cely retezec
]]></Implementation>
</Method>

<Method name="formatBibCDatum">
<Description><![CDATA[
<pre> Zalozena metoda na preformatovani datumu

09.10.20 tt; zalozena matoda 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handleX,pTagSt=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s nC=##class(User.MARC).recordLineCountX(.handleX) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handleX,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3), sOldLine=lsLine
    if (sTag=$e(pTagSt,1,3)) 
    {
       s sST=$$$getSubTagStr(lsLine,$e(pTagSt,4)) ; subtag
     
       if (sST?8N)
       { ; pokud ma datum tvar RRRRMMDD seskladame na spravne
        s sST=$zstrip($e(sST,7,8),"<","0")_". "_$zstrip($e(sST,5,6),"<","0")_". "_$e(sST,1,4)
       } 
       elseif (sST?2N1P2N1P4N)
       { ; pokud ma datum tvar DD.MM.RRRR seskladame na spravne
         s sST=$zstrip($e(sST,1,2),"<","0")_". "_$zstrip($e(sST,4,5),"<","0")_". "_$e(sST,7,10)
       }
       elseif (sST?4N1P2N1P2N)
       { ; pokud ma datum tvar RRRR.MM.DD seskladame na spravne
         s sST=$zstrip($e(sST,9,10),"<","0")_". "_$zstrip($e(sST,6,7),"<","0")_". "_$e(sST,1,4)
       }   
       
       s lsLine=$$$setSubTagStr(lsLine,$c(31)_$e(pTagSt,4)_sST)
    }    
    d:(sOldLine'=lsLine) ##class(User.MARC).setLineX(.handleX,i,lsLine) ; zapsani to radku
  }
]]></Implementation>
</Method>

<Method name="VariantJmenaAuth">
<Description><![CDATA[
<pre> Zalozena metoda nalezeni a seskladani variantnich jsme s * podle stari do 
getSymbX. (neplatne autority * na konci)
Mohla by to být třeba hvězdička (*) nebo hash (#), nám je to jedno.
Sloupeček bude vypadat třeba takhle:
Laiblová Kadlecová, Ivana;Kadlecová, Ivana*

Parametry: pRet   - retezec, ktery seskladavame
           pKodA  - kod autority ze zaznamu    
           pAllJmena - seradit vsechny jmena, vcetne aktualniho v zaznam - pokud hodnota 1

10.01.20 tt; pridana varianta pro serazeni vsech variantnich jmen
24.11.17 tt; upraveno trideni v uzlech pro serazeni autorit
19.11.14 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&pRet,pKodA,pAllJmena=0]]></FormalSpec>
<Implementation><![CDATA[
 if (pKodA'="")
 { ; pokud mame link do autorit, pokusime se otevrit
   if ##class(User.MARC).readLX(.handleA,pKodA)
   {
     s s400 = $$$getTagXC(.handleA,"400",-1)
     s s100adt = $e($$$getTagX(.handleA,"100a"),1,8)
     s sVyslAll(s100adt_" "_pKodA)=$$$getTagX(.handleA,"200a")_", "_$$$getTagX(.handleA,"200b")

     s sVysl(s100adt)=pRet
     for kk=1:1:$l(s400,$c(10))
     { ; zaindexujeme vsechny isbn
       s s4001=$p(s400,$c(10),kk)
       continue:(s4001="")
       s s4001a=$$$getSubTagStr(s4001,"a") ; prijmeni
       s s4001b=$$$getSubTagStr(s4001,"b") ; jmeno  
       s s40013=$$$getSubTagStr(s4001,"3") ; link  
       s s400100adt=""
       if ##class(User.MARC).readLX(.handle4A,s40013)
       {
         s s400100adt=$e($$$getTagX(.handle4A,"100a"),1,8)
       } 
       s:(s400100adt="") s400100adt="20000101"
       ; 24.11.17 tt; upraveno trideni v uzlech pro serazeni autorit
       s:((s4001a'="")&&(s4001b'="")) sVysl(s400100adt_" "_pKodA)=s4001a_", "_s4001b
       s:((s4001a'="")&&(s4001b'="")) sVyslAll(s400100adt_" "_s40013)=s4001a_", "_s4001b
       ;s:((s4001a'="")&&(s4001b'="")) pRet=pRet_";"_s4001a_", "_s4001b
     }        
   }
 }  

 s item="", pRet=""      ; pomocna promenna                
 f i=1:1
 { s item=$o(sVysl(item),-1) 
   q:(item="")
   s sJmeno=$g(sVysl(item))
   s:(i'=1) sJmeno=sJmeno_"*"
   s:(pRet'="") pRet=pRet_";"_sJmeno
   s:(pRet="") pRet=sJmeno   
 }
 if (pAllJmena=1)
 { ; 10.01.20 tt; pridana varianta pro serazeni vsech variantnich jmen
   s item="", pRet=""      ; pomocna promenna                
   f i=1:1
   { s item=$o(sVyslAll(item),-1) 
     q:(item="")
     s sJmeno=$g(sVyslAll(item))
     s:(i'=1) sJmeno=sJmeno_"*"
     s:(pRet'="") pRet=pRet_";"_sJmeno
     s:(pRet="") pRet=sJmeno   
   }
 }
]]></Implementation>
</Method>

<Method name="Tag700ByTym">
<Description><![CDATA[
<pre> Zalozena metoda nalezeni a seskladani. Navratem je autor 70*, ktery je zapsan
s danym oddelenim 

Parametry: handle -  aktualne zpracovavany handle s tridenim

15.04.15 tt; pridana kontrola na vyplneni tymu. Pokud neni vyplnen, neni co srovnavat
06.03.15 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret=""
  s sSortId=##class(User.MARC).recordSortIdX(.handle)
  s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
  if sSortKey1="" q ""   

  ; . prochazeni zaznamu podle .c   
  s c=0
  d {
    s sT70X=$$$getTagXC(.handle,"70*",.c) ; vsetky citacie
    continue:((sT70X="")&&(c'=0))
    if (sT70X'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sT70Xw=$$$getSubTagStr(sT70X,"w")
      ; 20.03.15 tt; upravy trideni tymu
      //b ;tttttttttttttttttttttttttttttttttttt
      ; 15.04.15 tt; pridana kontrola na vyplneni tymu. Pokud neni vyplnen, neni co srovnavat
      continue:(sT70Xw="")
      continue:($zcvt($e($tr(sSortKey1," .[]()",""),1,60),"L")'=$zcvt($e($tr(sT70Xw," .[]()",""),1,60),"L"))
      s ret=sT70X  ; pokud sedi oddeleni, vratime danou 70*
    }
    q:(ret'="")
  } while (c'=0)

  q ret ; vranime nalezeny tag 70*
]]></Implementation>
</Method>

<Method name="Tag700ByAutor">
<Description><![CDATA[
<pre> Zalozena metoda nalezeni a seskladani. Navratem je autor 70*, ktery je ve trideni @AUTORT

Parametry: handle -  aktualne zpracovavany handle s tridenim

07.02.17 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret=""
  s sSortId=##class(User.MARC).recordSortIdX(.handle)
  s sSortKey=$p(sSortId,"*",3),sSortKey1=$p(sSortKey,$c(31),1)
  if sSortKey1="" q ""   

  ; . prochazeni zaznamu podle .c   
  s c=0
  d {
    s sT70X=$$$getTagXC(.handle,"70*",.c) ; vsetky citacie
    continue:((sT70X="")&&(c'=0))
    if (sT70X'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sT70X3=$p($$$getSubTagStr(sT70X,"3"),"*",2)
      continue:(sT70X3="")  ; pokud neni kod vyplnen, neni co sortovat
      continue:($zcvt(sSortKey1,"L")'=$zcvt(sT70X3,"L"))
      s ret=sT70X  ; pokud sedi oddeleni, vratime danou 70*
    }
    q:(ret'="")
  } while (c'=0)

  q ret ; vranime nalezeny tag 70*
]]></Implementation>
</Method>

<Method name="getAktRokZberu">
<Description><![CDATA[
<pre> Zlozena metoda, ktera vrati aktualni rok zberu

18.08.15 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  
  q ..#cAktRokZberu ; vranime rok zberu
]]></Implementation>
</Method>

<Method name="zfChangeHandleI3Form">
<Description><![CDATA[
</pre> Pridan specialni blok pro upravu zobrazovaciho formatu. Upravu handle na tvar po ulozeni.
 - je to prasecina, ale neda se svitit
https://cosmo2/wiki/index.php/CAV:Formul%C3%A1%C5%99e_I3_dokumentace

10.03.21 tt; pridano osetreni na spravny tvar C12
03.01.16 tt; provedena uprava doplneni txx do I3
01.12.15 tt; pridan blok pro zobrazovani handlu ve stavu po ulozeni
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  if ($$$getTagX(.handle,"U99a")=1)
  { ; delam upravy, jen pokud jdu z formularu
    s sT969fo="",sT16="",sTft="",sTXX=""
    s sT969f=$$$getTagX(.handle,"969f")
    s sT001=$$$HandleT001(handle)       ; ziskani t001
    s sClass=$$$HandleClass(handle)     ; ziskani tridy
    if (sT001'="new")
    { ; odeslání záznamu - 969f - "D" - neodeslán/ "" nebo "A" odeslaný záznam zveřejněný v ipac2 
      if ##class(User.MARC).readX(.handleUS,sClass,sT001,"T")
      { ; pokud se podari otevrit puvodni handle, muzeme zmenit stav
        s sT969fo=$$$getTagX(.handleUS,"969f")
        s sTXX=$$$getTagXC(.handleUS,"T**",-1)
        s sTft=$$$getTagXC(.handleUS,"Tft",-1)
        d ..allowSaveExFormN(.handle,.handleUS, sT969f,sT969fo)
      }
    }
    else
    { 
      d ..allowSaveExFormN(.handle,.sT969fo, sT969f,sT969fo)
    }
    ; 24.10.16 tt; pridan prenost U99 kvuli rozpoznani odkuz zf jde
    d $$$setTagX(.handle,"U99    "_$c(31)_"a1")
    d:(sTXX'="") $$$setTagX(.handle,sTXX)
    //d:(sTft'="") $$$setTagX(.handle,sTft)
   
    s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
    f i=1:1:nC 
    { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
      s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
      s sTag=$e(lsLine,1,3), sOldLine=lsLine
      
      if sTag="C12"
      {
        d ##class(util.conv.baseUnToM21).frSwOrST(.lsLine,"37abgdcfp4")
      }
        
      d:(sOldLine'=lsLine) ##class(User.MARC).setLineX(.handle,i,lsLine) ; zapsani to radku
    }
    
    ; 10.03.21 tt; pridano osetreni, aby byl handle nacteny v pristupne stromove strukture - volane funkce ji vyzaduji
    ;              a kdyz neni, padne update zaznamu
    d ##class(util.index).enhance(.handle)  // https://cosmo2/Wiki/index.php?title=Ergonomic_data_in_zf
 }
  
  
   
    
  q "" ; fakt nechcu nic zobrazovat :-)
]]></Implementation>
</Method>

<Method name="zfChangeHandleI3FormTxx">
<Description><![CDATA[
</pre> Pridan specialni blok pro upravu zobrazovaciho formatu. Upravu handle na tvar po ulozeni.
 - je to prasecina, ale neda se svitit
https://cosmo2/wiki/index.php/CAV:Formul%C3%A1%C5%99e_I3_dokumentace

28.10.20 tt; pridano osetreni, aby byl handle nacteny v pristupne stromove strukture - potre
01.12.15 tt; pridan blok pro zobrazovani handlu ve stavu po ulozeni
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  if ($$$getTagX(.handle,"U99a")=1)
  { ; delam upravy, jen pokud jdu z formularu
    s sT969fo=""
    s sT969f=$$$getTagX(.handle,"969f")
    s sT001=$$$HandleT001(handle)       ; ziskani t001
    s sClass=$$$HandleClass(handle)     ; ziskani tridy
    s sT00=$$$getTagX(.handle,"T00")
    if ((sT001'="new")&&(sT00=""))
    { ; odeslání záznamu - 969f - "D" - neodeslán/ "" nebo "A" odeslaný záznam zveřejněný v ipac2 
      if ##class(User.MARC).readX(.handleUS,sClass,sT001,"T")
      { ; pokud se podari otevrit puvodni handle, muzeme zmenit stav
        s nC=##class(User.MARC).recordLineCountX(.handleUS) ; ziskani poctu radku v zaznamu 
        f i=1:1:nC 
        { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
          s lsLine=##class(User.MARC).getLineX(.handleUS,i) continue:lsLine="" 
          s sTag=$e(lsLine,1)
          d:(sTag="T") ##class(User.MARC).appendLineX(.handle,lsLine) 
        }
      }
    }
    
    ; 28.10.20 tt; pridano osetreni, aby byl handle nacteny v pristupne stromove strukture - potre
    d ##class(util.index).enhance(.handle)
  }
  q "" ; fakt nechcu nic zobrazovat :-)
]]></Implementation>
</Method>

<Method name="symbCheckRiv">
<Description>
26.01.16 tt; pridan symbolik pro kontroly</Description>
<ClassMethod>1</ClassMethod>
<PublicList>handle,pRet,gsIPref,gsIPrefB,sMessage</PublicList>
<Implementation><![CDATA[
  s gsIPref="Cav",gsIPrefB="Cav"
  d ##class(User.MARC).mergeX(.hanldeZalUn, .handle)  
  s sMessage =##class(rep.epca.exportRIV2016).check1EPC(.hanldeZalUn)
  s pErr="",pWarn="", pInf=""
  if (sMessage'="")
  {
    for i=1:1:$l(sMessage,$c(13,10))
    {
      s sMes1=$p(sMessage,$c(13,10),i)
      continue:(sMes1="")
      s sMessage("ERRCH")="",sMessage("WARNCH")=""
      if ('$f(sMes1,"WARN.")) {  d ##class(util.ie.CheckBase).WInfoRecomm(.pPar,"C00","",1,"","e", sMes1, .pErr, .pWarn, .pInf) }
      else 
      {  
        s sMes1=$$$strswap(sMes1,"WARN.:","") 
        d ##class(util.ie.CheckBase).WInfoRecomm(.pPar,"C00","",1,"","w", sMes1, .pErr, .pWarn, .pInf)    
      }
    }
    s sMessage("ERRCH")=pErr
    s sMessage("WARNCH")=pWarn
    s sMessage="CavUnEpca-hlaseni"
    q 1 
  }
  q 0
]]></Implementation>
</Method>

<Method name="filterWosScopus">
<Description><![CDATA[
<pre>
Filter pro prebirani zaznamu

09.06.23 tt; odmazana podminka na maximalni pocet autoru pri stahovani s wos
17.10.22 tt; je treba upravovat jmena autorum z WOS
03.10.22 tt; provedeno osetreni cleanUp, aby nevznikali rozdily jako v allowSave - snad to pomuze 
28.02.17 tt; uprave editoru (pripominky pro wos)
15.11.16 tt; pridano odmazani priznaku odmazavani - klicovych slov u prebirani zaznamu wos scopus a zmeny
11.11.16 tt; upravy kvuli prebirani zaznamu
29.08.16 tt; upravy dotahovani zaznamu
06.08.16 tt; zalozena metoda 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<ProcedureBlock>1</ProcedureBlock>
<PublicList>handle</PublicList>
<Implementation><![CDATA[
  s c=0,sTyp="", sPocetA=0
  d { ; zjistime si typ zaznamu
    s sT014=$$$getTagXC(.handle,"014",.c) ; vsetky citacie
    continue:((sT014="")&&(c'=0))
    if (sT014'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sT0142=$$$getSubTagStr(sT014,"2")
      s:$f(sT0142,"WOS") sTyp="WOS"
      s:$f(sT0142,"SCOPUS") sTyp="SCOPUS"         
    }
  } while (c'=0)    

  s sT969fo="",sTje463=0,sC63=""
  d ##class(User.MARC).delTagX(.handle,"U99")
  d ##class(User.MARC).delTagX(.handle,"970")
  d ##class(User.MARC).delTagX(.handle,"856")
  d ##class(User.MARC).setTagX(.handle,"969    "_$c(31)_"fN")
  d ##class(User.MARC).setTagX(.handle,"U98    "_$c(31)_"a1"_$c(31)_"b1")
  s sISBN=$$$getTagXC(.handle,"010",-1)
  if ($l($tr(sISBN,"* ",""))<8)
  {
    d ##class(User.MARC).delTagX(.handle,"010")
  }
  
  s sISBN=$$$strswap(sISBN,$c(10)_"010    "_$c(31)_"a"," nebo ")
  s sISBN=$$$strswap(sISBN,"010    "_$c(31)_"a*****************","")
  s sISBN=$$$strswap(sISBN,$c(10)_$c(10),$c(10))
  d ##class(User.MARC).readX(.handleK,"CavUnTablesd","GET_REC_WOS") 

  s bDellIssn=0,sDellIsbn=0
  
  s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3), sOldLine=lsLine
    
    if ($e(sTag,1,2)="70")
    {
      s sT70X3=$$$getSubTagStr(lsLine,"3")
      if (sT70X3'="")
      {
        s sAutorID=##class(User.MARC).getIDByIndex("CavUnAuth","ida",sT70X3)
        //s val=" "_sT70X3
        //s sAutorID=$o(^$$$MarcIndexG("CavUnAuth","ida",val,""))
        if ((sAutorID'="0")&&(sAutorID'=""))
        {
          s sAutorT001=##class(MARC).getT001(sAutorID)
          s:(sAutorT001'="") lsLine=##class(MARC).setSubTagStr(lsLine,$c(31)_"3cav_un_auth*"_sAutorT001)
        }
        else
        {
          s lsLine=##class(MARC).setSubTagStr(lsLine,$c(31)_"3")
        }
      }
    }
    
    if (sTag="014")
    {
      s lsLine=$$$strswap(lsLine,($c(31)_"2SCOPUS_EID"),($c(31)_"2SCOPUS"))
      
      if (sTyp="SCOPUS")    
      { ; odfiltruji prefix z id scopusu
        s lsLine=$$$strswap(lsLine,"2-s2.0-","")        
      }
      
    }
    if (sTag="200")
    {
      s sT200f=$$$getSubTagStr(lsLine,"f")
      if (sT200f'="")
      {
        s lsLine=$$$setSubTagStr(lsLine,$c(31)_"f")
      }      
    } 
    if (sTag="C12")
    {
      s lsLine=$$$strswap(lsLine,($c(31)_"n"),($c(31)_"x"))
    } 

    if ($e(sTag,1,2)="70")
    { ; upravime si autory
      s $e(lsLine,5,6)=" 1"
      s sT70Xp=$$$getSubTagStr(lsLine,"p")
      s:(sT70Xp'="corp") sPocetA=sPocetA+1

      if (sTyp="SCOPUS")
      {
        s sPomPrac=""
        s sPomPrac=$SELECT(sT70Xp="60033404":"ARUB-Q",sT70Xp="60104328":"ARU-G",sT70Xp="60001847":"ASU-R",sT70Xp="109592485":"ASU-R",sT70Xp="106023388":"ASU-R",sT70Xp="60031135":"AVCR",sT70Xp="107048843":"AVCR",sT70Xp="60026381":"BC-A",
                       sT70Xp="60013029":"BC-A",sT70Xp="60008018":"BC-A",sT70Xp="60068917":"BC-A",sT70Xp="60068921":"BC-A",sT70Xp="60083306":"BC-A",sT70Xp="109707189":"BC-A",sT70Xp="60020101":"BFU-R",sT70Xp="100445212":"BFU-R",
                       sT70Xp="60104587":"BTO-N",sT70Xp="60045994":"BU-J",sT70Xp="60088737":"FGU-C",sT70Xp="105636822":"FGU-C",sT70Xp="60104332":"FLU-F",sT70Xp="112273776":"FLU-F",sT70Xp="106770106":"FLU-F",sT70Xp="106680462":"FLU-F",
                       sT70Xp="108189124":"FLU-F",sT70Xp="60016576":"FZU-D",sT70Xp="60068900":"GLU-S",sT70Xp="60104592":"HIU-Y",sT70Xp="60104397":"KNAV",sT70Xp="60027611":"MBU-M",sT70Xp="109993783":"MBU-M",sT70Xp="60056159":"MU-W",
                       sT70Xp="107592855":"MU-W",sT70Xp="105825263":"MU-W",sT70Xp="100998755":"MU-W",sT70Xp="106020831":"MU-W",sT70Xp="107150400":"MU-W",sT70Xp="60029504":"NHU-C",sT70Xp="112187698":"NHU-C",sT70Xp="60104595":"OU-W",
                       sT70Xp="60082391":"PSU-E",sT70Xp="60104596":"SLU-S",sT70Xp="60068912":"SOU-Z",sT70Xp="60084751":"TC",sT70Xp="60059874":"UACH-T",sT70Xp="106633522":"UACH-T",sT70Xp="110244189":"UACH-T",sT70Xp="60022229":"UBO-W",
                       sT70Xp="101865480":"UBO-W",sT70Xp="112643946":"UBO-W",sT70Xp="60104590":"UCL-M",sT70Xp="60104586":"UDU-I",sT70Xp="60085168":"UEB-Q",sT70Xp="60022901":"UEK-B",sT70Xp="110256868":"UEK-B",sT70Xp="113093441":"UEK-B",
                       sT70Xp="60034459":"UEM-P",sT70Xp="60031627":"UFA-U",sT70Xp="60030266":"UFCH-W",sT70Xp="60030515":"UFM-A",sT70Xp="60024190":"UFP-V",sT70Xp="60082671":"UGN-S",sT70Xp="105829515":"UGN-S",sT70Xp="60082663":"UH-J",
                       sT70Xp="60011871":"UCHP-M",sT70Xp="60026204":"UIACH-O",sT70Xp="60049290":"UIVT-O",sT70Xp="100679187":"UIVT-O",sT70Xp="60104589":"UJC-A",sT70Xp="100517069":"UJC-A",sT70Xp="60001924":"UJF-V",sT70Xp="108738917":"UJF-V",
                       sT70Xp="110135091":"UJF-V",sT70Xp="111035072":"UJF-V",sT70Xp="60010612":"UMG-J",sT70Xp="60056209":"UMCH-V",sT70Xp="60058192":"UOCHB-X",sT70Xp="60017322":"UPT-D",sT70Xp="108130341":"UPT-D",sT70Xp="60060658":"URE-Y",
                       sT70Xp="60104588":"USD-C",sT70Xp="106929460":"USD-C",sT70Xp="60104327":"USMH-B",sT70Xp="112098665":"USMH-B",sT70Xp="60104593":"USP-I",sT70Xp="60104326":"UTAM-F",sT70Xp="60063843":"UTIA-B",sT70Xp="60068905":"UT-L",
                       sT70Xp="60039580":"UZFG-Y",sT70Xp="100435695":"UZFG-Y",1:"")
        if (sPomPrac'="") 
        {
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"p"_sPomPrac)
        }
        else
        { ; pokud neni autor z cav, preklopi se text pracoviste do q
          s s70xX=$$$getSubTagStr(lsLine,"X")
          s lsLine=$$$setSubTagStr(lsLine,$c(31)_"p")
          
          if (s70xX'="")
          { ; pokud mate text, preklopim ho do q
            s lsLine=$$$setSubTagStr(lsLine,$c(31)_"q"_s70xX)
            ; odmazeme pracoviste cav
            
            if ('$f(sC63,s70xX))
            { ; pridam nazev do seznamu spolupracujicich instituci
              s:(sC63'="") sC63=sC63_$c(10)_"C63    "_$c(31)_"b"_s70xX
              s:(sC63="") sC63="C63    "_$c(31)_"b"_s70xX
            }
          }
          
          ; 701  1 $$4070$$aDUBREUIL$$bB
          s s70xa=$$$getSubTagStr(lsLine,"a")
          s s70xb=$$$getSubTagStr(lsLine,"b")
          s sT70Xa1=$zstrip(s70xa,"*P"),sT70Xa2=$zstrip(s70xa,"*PL")   

          if (sT70Xa1=sT70Xa2)
          { ; pokud nemam domaciho autora, upravim tvar na prvni velke pismeno
            for lll=1:1:$l(s70xa," ")
            {
              s s70xa11=$p(s70xa," ",lll)
              s s70xa11=$zcvt($e(s70xa11,2,999),"L")
              s $p(s70xa," ",lll)=s70xa11
            }        
            s lsLine=$$$setSubTagStr(lsLine,$c(31)_"a"_s70xa)
          }
         
          if (s70xb'="")
          { ; jmena upravim jen na inicialy
            for lll=1:1:$l(s70xb," ")
            { ; cyklime pres vsechny mezery - predpokladam zacatek dalsiho jmena
              s s70xb11=$p(s70xb," ",lll)
              if ('$f(s70xb11,"."))
              {
                s $e(s70xb11,2,999)="."
                s $p(s70xb," ",lll)=s70xb11
              }
            }        
            s lsLine=$$$setSubTagStr(lsLine,$c(31)_"b"_s70xb)
          }  
        }       
      }
      else
      {  ; zpracovani pracoviste pro WOS
           ; 02.11.21 tt; pridana funkcnost na dotazeni pracoviste WOSu pri stahovani zaznamu
           s sInst= $zstrip($zcvt($p(sT70Xp,",",1),"L"),"<>W") ; instituce
           s sPrac= $zstrip($zcvt($p(sT70Xp,",",2),"L"),"<>W") ; pracoviste

           s sPom70xq=""
           s lsLine=$$$setSubTagStr(lsLine,$c(31)_"p")
           if $f(sInst,"czech acad sci")
           {
             s nCK=##class(User.MARC).recordLineCountX(.handleK) ; ziskani poctu radku v zaznamu 
             s bVlozPrac=0

             f ivK=1:1:nCK 
             { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
               s KlsLine=##class(User.MARC).getLineX(.handleK,ivK) continue:KlsLine="" 
               if ($e(KlsLine,1,3)="200")
               { ; zpracovavame jednu konfiguraci ustavu na jeden radek
                 s sUstav=$$$getSubTagStr(KlsLine,"a")
                 continue:(sUstav="TEST")    ; 30.12.21 tt; vyrazeni testu z prohledavani zaznamu a doplnovani pracoviste
                 continue:($f(sPrac,"inst phys")&&(sUstav'="FZU-D"))
                 s sDotaz=$zcvt(($$$getSubTagStr(KlsLine,"c")_" "_$$$getSubTagStr(KlsLine,"n")),"L")
                 if ((sUstav'="")&&(sDotaz'="")&&$f(sDotaz,sPrac))
                 {  ; nastavime si ustav                    
                    s lsLine=lsLine_$c(31)_"p"_sUstav
                    s bVlozPrac=1
                 }       
               }       
             }  
             s:(bVlozPrac=0) lsLine=lsLine_$c(31)_"p"_sPrac     
           }
           else
           {
             s lsLine=$$$setSubTagStr(lsLine,$c(31)_"q"_sT70Xp)  
             s sPom70xq=sT70Xp   ; ulozime si pro pripad potreby hodnotu pracoviste
             if ('$f(sC63,sT70Xp)&&(sPocetA<31))
             { ; pridam nazev do seznamu spolupracujicich instituci
               s:(sC63'="") sC63=sC63_$c(10)_"C63    "_$c(31)_"b"_sT70Xp
               s:(sC63="") sC63="C63    "_$c(31)_"b"_sT70Xp
             }
           }

           s sT70XX2ALL=$$$getSubTagStrC(lsLine,"X",-1)  ; druhe pracoviste    
           ; 23.11.21 tt; provedena zmena doplnovani pracovist z WOS  
           for ops=1:1:($l(sT70XX2ALL,$c(10)))
           { ; pres vsechny opakovani subtagu
             s sT70XX2=$p(sT70XX2ALL,$c(10),ops)  ; ziskana hodnota jednoho opakovani
      
             s sInst= $zcvt($p(sT70XX2,",",1),"L") ; instituce
             s sPrac= $zcvt($p(sT70XX2,",",2),"L") ; pracoviste
             if $f(sInst,"czech acad sci")
             {
               s nCK=##class(User.MARC).recordLineCountX(.handleK) ; ziskani poctu radku v zaznamu 
               s bVlozPrac=0
               f ivK=1:1:nCK 
               { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
                 s KlsLine=##class(User.MARC).getLineX(.handleK,ivK) continue:KlsLine="" 
                 if ($e(KlsLine,1,3)="200")
                 { ; zpracovavame jednu konfiguraci ustavu na jeden radek
                   s sUstav=$$$getSubTagStr(KlsLine,"a")
                   continue:(sUstav="TEST")    ; 30.12.21 tt; vyrazeni testu z prohledavani zaznamu a doplnovani pracoviste
                   ; 16.03.22 tt; provedena uprava 
                   continue:($f(sPrac,"inst phys")&&(sUstav'="FZU-D"))
                   
                   s sDotaz=$zcvt(($$$getSubTagStr(KlsLine,"c")_" "_$$$getSubTagStr(KlsLine,"n")),"L")
                   if ((sUstav'="")&&(sDotaz'="")&&$f(sDotaz,sPrac))
                   {  ; nastavime si ustav
                      s lsLine=lsLine_$c(31)_"p"_sUstav
                      s bVlozPrac=1
                   }       
                 }                        
               }       
               s:(bVlozPrac=0) lsLine=lsLine_$c(31)_"p"_sPrac
             }
             else
             {
               s:(sPom70xq'="") sPom70xq=sPom70xq_", "_sT70XX2
               s:(sPom70xq="") sPom70xq=sT70XX2
             
               s lsLine=$$$setSubTagStr(lsLine,$c(31)_"q"_sPom70xq)  
               if ('$f(sC63,sT70XX2)&&(sPocetA<31))
               { ; pridam nazev do seznamu spolupracujicich instituci
                 s:(sC63'="") sC63=sC63_$c(10)_"C63    "_$c(31)_"b"_sT70XX2
                 s:(sC63="") sC63="C63    "_$c(31)_"b"_sT70XX2
               }
             }  
           }  
      
         if ('$f(lsLine,($c(31)_"p")))
         { ; pro cizi autory budeme jeste menit udaje
           ; odmazeme ORCID a WOS
           s:($f(lsLine,($c(31)_"A"))) lsLine=$$$setSubTagStr(lsLine,$c(31)_"A")
           s:($f(lsLine,($c(31)_"B"))) lsLine=$$$setSubTagStr(lsLine,$c(31)_"B")
           s s70xb=$$$getSubTagStr(lsLine,"b")
           ; 06.07.22 tt; nepotrebuje upravovat jmeno u autora z wosu
           //s:(s70xb'="") lsLine=$$$setSubTagStr(lsLine,$c(31)_"b"_$e(s70xb,1)_".")  
           ; pri poctu autoru vice nez 30, odmazat je
           /// 17.10.22 tt; je treba upravovat jmena utorum z WOS
           if ((s70xb'="")&&('$f(s70xb,".")))
           { ; jmena upravim jen na inicialy
             for lll=1:1:$l(s70xb," ")
             { ; cyklime pres vsechny mezery - predpokladam zacatek dalsiho jmena
               s s70xb11=$p(s70xb," ",lll)
               if ('$f(s70xb11,"."))
               {
                 s $e(s70xb11,2,999)="."
                 s $p(s70xb," ",lll)=s70xb11
               }
             }        
             s lsLine=$$$setSubTagStr(lsLine,$c(31)_"b"_s70xb)
           }          
           ; 10.10.23 tt; pridana podminka na maximalni pocet autoru pro stahovani z wos
           ; 09.06.23 tt; odmazana podminka na maximalni pocet autoru pri stahovani s wos
           s:(sPocetA>50) lsLine="del"
         }      
      }
    }
    if (sTag="330")
    {  ; prevedeni anotace
       s $e(lsLine,1,3)="C15"
    }
    
    if (sTag="610")
    {
      s sT70Xa=$$$getSubTagStr(lsLine,"a")
      s sT70Xa1=$zstrip(sT70Xa,"*P"),sT70Xa2=$zstrip(sT70Xa,"*PL")
      if (sT70Xa1=sT70Xa2)
      {
        s sT70Xa=$zcvt(sT70Xa,"L")
        s lsLine=$$$setSubTagStr(lsLine,$c(31)_"a"_sT70Xa)
      }
      
    } 
    if (sTag="011")
    {
       s sT011a=$$$getSubTagStr(lsLine,"a")
       s sT011e=$$$getSubTagStr(lsLine,"e")
       if (sT011a'="")
       {
         s sT011a=$tr($zstrip(sT011a,"*WC"),"-","")   ; oceseme od prebytecnych znaku
         s sT011a=$e(sT011a,1,4)_"-"_$e(sT011a,5,999) ; spravny tvar ISSN
         s:(sT011a'="") lsLine=$$$setSubTagStr(lsLine,$c(31)_"a"_sT011a)
       }
       if (sT011e'="")
       {
         s sT011e=$tr($zstrip(sT011e,"*WC"),"-","")   ; oceseme od prebytecnych znaku
         s sT011e=$e(sT011e,1,4)_"-"_$e(sT011e,5,999) ; spravny tvar ISSN
         s:(sT011e'="") lsLine=$$$setSubTagStr(lsLine,$c(31)_"e"_sT011e)
       }
       s:((sT011a'="")&&(sT011e'="")) lsLine=$$$setSubTagStr(lsLine,$c(31)_"e")
    }
    
    if (sTag="101")
    {
      s sT101a=$zcvt($$$getSubTagStr(lsLine,"a"),"L")
      if ##class(User.MARC).readLX(.handleCIS,"cav_un_tablesd*STABLE_UT_LANGUAGE")
      { ; nacteme ciselnik
        s nCis=##class(User.MARC).recordLineCountX(.handleCIS) ; ziskani poctu radku v zaznamu 
        f iii=1:1:nCis 
        { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
          s lsLineCis=$zcvt(##class(User.MARC).getLineX(.handleCIS,iii),"L") continue:lsLineCis="" 
          if $f(lsLineCis_"#",("#"_sT101a_"#"))
          {
            s sT101a=$$$getSubTagStr(lsLineCis,"a")
            s lsLine=$$$setSubTagStr(lsLine,$c(31)_"a"_sT101a)
          }
        }
      }
    }
    
    if (sTag="C26")
    { ; 15.11.16 tt; pridan automaticky priznak do ASEP
       s lsLine=$$$setSubTagStr(lsLine,$c(31)_"c1")
    }
    
    
    
    if (sTag="463")
    { ; pridano prolinkovani na zdroj - pokud je v databazi
      if ('$f(lsLine,$c(31)_"1011  "_$c(31)))
      {
         s lsLine=$$$strswap(lsLine,$c(31)_"1011  ","")
      }
      
      s sTje463=1,s463Issn="",s463eIssn=""
      s s463Issn=$$$getTagX(.handle,"463/011a")
      s s463eIssn=$$$getTagX(.handle,"463/011e")
      s:(s463Issn="") s463Issn=$$$getTagX(.handle,"011a")  ; pokud existuje 463, natahnu issn
      s:(s463eIssn="") s463eIssn=$$$getTagX(.handle,"011e")
      ; 14.11.16  
      
      s s463001=""
      //s s463001=##class(util.ie.csv).write978FindR("CavUnEpca",s463Issn,"","XSZP","",0)  
      //s:(s463001="") s463001=##class(util.ie.csv).write978FindR("CavUnEpca",s463eIssn,"","XSZP","",0)  
      s sZdroj200a="",sZdroj210=""

      if (s463001'="")
      {
        s lsLine=$$$strswap(lsLine,($c(31)_"1200"),($c(31)_"1001  cav_un_epca*"_s463001_$c(31)_"1200"))
        if ##class(User.MARC).readLX(.handleZDRoJ,"cav_un_epca*"_s463001)
        { ; pokud se nam podarilo otevrit uzivatele, nacteme 600b
          s sZdroj200a=$$$getTagX(.handleZDRoJ,"200a")  
          s sZdroj210=$$$getTagX(.handleZDRoJ,"210")  
         }
      }
      
      if ##class(User.MARC).t4xx2handle(.handle4,lsLine) 
      { ; uprava zdrojoveho dokumentu
        s s463200=$$$getTagX(.handle4,"200")
        s s463200v=$$$getSubTagStr(s463200,"v")

        s s463200v=$$$strswap(s463200v,"S","")
        s s463200v=$$$strswap(s463200v,"Vol. ","Roč. ")
        s s463200v=$$$strswap(s463200v,"no. ","č. ")
        s s463200v=$$$strswap(s463200v,"pp. ","s. ")
        s:($e(s463200v,$l(s463200v)-2,$l(s463200v))="pp.") $e(s463200v,$l(s463200v)-2,$l(s463200v))="" 
        s sPomDatum463v=$p($p(s463200v,")",1),"(",2)
        s sPomDatum463vUprav=$p(sPomDatum463v,"-",1)
        s s463200v=$$$strswap(s463200v,"("_sPomDatum463v_")","("_sPomDatum463vUprav_")")
        s s463200v=$$$strswap(s463200v,"Roč. ,",",")
        s s463200v=$$$strswap(s463200v,"č.  (","(")

        s s463200=##class(MARC).setSubTagStr(s463200,$c(31)_"v"_s463200v)
        s:(sZdroj200a'="") s463200=##class(MARC).setSubTagStr(s463200,$c(31)_"a"_sZdroj200a)
        d ##class(MARC).setTagX(.handle4,s463200)
        d:(sZdroj210'="") ##class(MARC).setTagX(.handle4,sZdroj210)
        
        s s463011=$$$getTagX(.handle4,"011")
        s:(s463011="") s463011="011    "
        if (s463Issn'="")
        {
          s s463Issn=$tr($zstrip(s463Issn,"*WC"),"-","")   ; oceseme od prebytecnych znaku
          s s463Issn=$e(s463Issn,1,4)_"-"_$e(s463Issn,5,999) ; spravny tvar ISSN
          s:(s463Issn'="") s463011=$$$setSubTagStr(s463011,$c(31)_"a"_s463Issn)
          s bDellIssn=1
        }
        if (s463eIssn'="")
        {
          s s463eIssn=$tr($zstrip(s463eIssn,"*WC"),"-","")   ; oceseme od prebytecnych znaku
          s s463eIssn=$e(s463eIssn,1,4)_"-"_$e(s463eIssn,5,999) ; spravny tvar ISSN
          s:(s463eIssn'="") s463011=$$$setSubTagStr(s463011,$c(31)_"e"_s463eIssn)
          s bDellIssn=1
        }
        
        ///d ##class(User.MARC).setTagX(.handle,"TTT    1231654#"_s463eIssn_"#"_bDellIssn_"#")
        if (sISBN'="")
        {
          d $$$setTagX(.handle4,sISBN)
          s sDellIsbn=1
          s s463210=$$$getTagX(.handle4,"210")
          s s463210d=##class(MARC).getSubTagStr(s463210,"d")
           
          ; pokud je vyplnene ISBN, dogenerovava se rok z 200v 
          if (s463210="") {  d $$$setTagX(.handle4,"210    "_$c(31)_"d"_sPomDatum463vUprav) }
          elseif (s463210d="")
          {
            s s463210=$$$setSubTagStr(s463210,$c(31)_"d"_sPomDatum463vUprav)
            d $$$setTagX(.handle4,s463210)
          }      
        }
        
        s:((s463Issn'="")&&(s463eIssn'="")) s463011=##class(MARC).setSubTagStr(s463011,$c(31)_"e")
        d:($l(s463011)>10) $$$setTagX(.handle4,s463011)
         
        s lsLine=##class(User.MARC).handle2t4xx(.handle4,"463 1")
      }
    }  
      
    d:(sOldLine'=lsLine) ##class(User.MARC).setLineX(.handle,i,lsLine) ; zapsani to radku
  }
  d ##class(User.MARC).recordDelEmptyST(.handle)    ; odmazani prazdnych subtagu

  
  d:bDellIssn ##class(User.MARC).delTagX(.handle,"011")
  d:sDellIsbn ##class(User.MARC).delTagX(.handle,"010")

  
  s t70Xallnew="",s463210c="",s463702=""
  if (sTje463=1)
  {
    s s70X = $$$getTagXC(.handle,"70*",-1)
    if (s70X'="")
    { ; 25.03.11 tt; zmena indexovani issbn
      for ll=1:1:$l(s70X,$c(10))
      { ; projdeme si vsechny autority a upravime
        s s70X1=$p(s70X,$c(10),ll)  
        s s70X14=$$$getSubTagStr(s70X1,"4")
        if (s70X14="220_corp")
        {
          s s463210c=$$$getSubTagStr(s70X1,"a")
          continue
        }
        if (s70X14="340")
        {
          s s463702=s463702_$c(31)_"1702 1"_$e(s70X1,8,9999)
          continue
        }
        //701  1 $$4220_corp$$aIEEE
      
        //sTje463
        s:(t70Xallnew'="") t70Xallnew=t70Xallnew_$c(10)_s70X1
        s:(t70Xallnew="") t70Xallnew=s70X1
        //s sPocetA=sPocetA+1
      }
    }
    //d ##class(User.MARC).setTagX(.handle,"TTT    1231654")
    if ((s463210c'="")||(s463702'=""))
    {        
      s s463=$$$getTagX(.handle,"463")
      if ((s463210c'="")&&(s463'=""))
      {      
         s s463=$$$strswap(s463,$c(31)_"1210  ",$c(31)_"1210  "_$c(31)_"c"_s463210c)
         d ##class(User.MARC).setTagX(.handle,s463)
         d ##class(User.MARC).setTagX(.handle,t70Xallnew)
      }
       if ((s463702'="")&&(s463'=""))
      {      
         s s463=s463_s463702
         d ##class(User.MARC).setTagX(.handle,s463)
         d ##class(User.MARC).setTagX(.handle,t70Xallnew)
      }
    }
    
  }
  
  ; 14.01.22 tt; osetreni na nechani jen jednoho C99
  s sTC99=$$$getTagX(.handle,"C99") 
  if (sTC99'="") 
  {
    d ##class(User.MARC).delTagX(.handle,"C99")
    d $$$setTagX(.handle,sTC99)
  }

  d:(sPocetA>0)&&($$$getTagX(.handle,"C46a")="") ##class(User.MARC).setTagX(.handle,"C46    "_$c(31)_"a"_sPocetA)
  d:(sC63'="") ##class(User.MARC).setTagX(.handle,sC63)
  ; pokud zaznam obsahuje 463 - odmazeme 210 na zadost cav
  d:(sTje463=1) ##class(User.MARC).delTagX(.handle,"210")
  ; pridani potrebych U tagu
  d ..allowSaveExFormN(.handle,.sT969fo,"N",sT969fo)
  /*
  s sUXX = $$$getTagXC(.handle,"U**",-1) 
  s sUXXnew=""
  for ll=1:1:$l(sUXXnew,$c(10))
  { ; projdeme si vsechny autority a upravime
     s sUXX1=$p(sUXX,$c(10),ll)  
     if ('$f(sUXX,$c(31)))
     {   
         continue
     }
     
     s:(sUXXnew'="") sUXXnew=sUXXnew_$c(10)_sUXX1
     s:(sUXXnew="") sUXXnew=sUXX1
  } 
  d:(sUXXnew'="") ##class(User.MARC).setTagX(.handle,sUXXnew)
  */

  ; 29.12.21 tt; oprava chyby pri stahovani zaznamu z WOS - chyba v cisteni - neni vyplnena trida
  s iprefX=##class(Util).getClassPrefixParam($$$HandleClass(handle))
  ; 03.01.22 tt; pridano schovani tridy, potrebuje se to dale pri zpracovani. Metoda symCatCleanUp ale potrebuje 
  ;              tridu cav - takze nakonec vraceno
  s ZalClass=handle("class") 
  ; kontrola ci je nastaveny install prefix
  s:(iprefX="") handle("class")="CavUnEpca"
  ; cisteni autorit, musi byt na konci - kvuli nejakym problemu s handlem - public promenne
  // d ##class(SPCommon).symCatCleanUp(.handle)
  /////////////////////////////////////////////////
  
  ; 03.10.22 tt; provedeno osetreni cleanUp, aby nevznikali rozdily jako v allowSave - snad to pomuze
  s s463predclean=$$$getTagX(.handle,"463")
  s s470predclean=$$$getTagX(.handle,"470")
  d ##class(SPCommon).symCatCleanUp(.handle)
  s s463=$$$getTagX(.handle,"463")
  s s470=$$$getTagX(.handle,"470")
  if (s463'="")
  { ; 24.11.15 tt; oprava, aby se nedotahovali Uxx pole do 4xx zaznamu
    if ##class(MARC).t4xx2handle(.handle4,s463) 
    {
      d ##class(User.MARC).delTagX(.handle4,"U**")
      s s463=##class(MARC).handle2t4xx(.handle4,$e(s463,1,3)_$e(s463,5,6)) 
      d:($l(s463)>10) ##class(User.MARC).setTagX(.handle,s463)
    }

     d ##class(User.MARC).delTagX(.handle,"U63")
     d ##class(User.MARC).delTagX(.handle,"U67")
     d ..allowSaveExFormNU63(.handle,s463)
  }

  ////////////////////////////////////////////////
  s handle("class")=ZalClass
]]></Implementation>
</Method>

<Method name="TfVazbyDataset">
<Description><![CDATA[
<pre> Uzivatelske zobrazeni vydavatelskych udaju
Parametry: result    - vysledny retezec
           handle    - aktualni zpracovavany handle
           parametry - oddelene "##"
                       1. prefix pro datasety - default U186
                       2. prefix pro datasety - default U187
                       3. prvni prefix prazdy =1

17.01.23 tt; přidána podmínka na existenci linku v reálných polích
10.07.13 tt; zalozeno
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s sRes=""

 s sT001=$$$HandleT001(handle)
 s class=$$$HandleClass(handle)
 s lname=##class(User.Util).objectName2lname(class)
 
 s user=##class(i2.access).getLoginId()       ; ziskame id uzivatele
 s sUserR=##class(User.CavS).FTgetIsUser(user,sT001) ; metoda pro vygenerovani role uzivatele

 s nLBlock=$o(result(""),-1)+1         ; zjisti posledni blok
 s pPar1=$p(param,"##",1)              ; prefix
 s pPar2=$p(param,"##",2)              ; prefix
 s pPar3=$p(param,"##",3)              ; prefix
 s pPar4=$p(param,"##",4)              ; dat za text jeste odradkovani

 s:(pPar1="") pPar1="U186"             ; nastaveni defaultnich hodnot   
 s:(pPar2="") pPar2="U187"
 s bUserIsAdmin=..userIsAdmin()        ; zjisteni, jestli je aktualni uzivatel admin
 
 
 s sT970b=$$$getTagX(.handle,"970b")
 s sT969f=$$$getTagX(.handle,"969f")
 q:(('((sUserR=2)||(sUserR=6)||(sUserR=5)))&&(sT969f="N"))    ; rozpracovane zaznamy ukazovat jen adminum
 if (sT970b="DATA") { s pPref="<strong>"_##class(rep.zf.tf).prefix(.handle,pPar1)_"</strong>: "   }    ; prefix 
 else { s pPref="<strong>"_##class(rep.zf.tf).prefix(.handle,pPar2)_"</strong>: "    }   ; prefix 
 s:(pPar3="1") pPref=" : "_pPref_"\n"
 
 s term=" "_lname_"*"_sT001,id=""
 
 s sPomAllU888=..getAllU883(.handle) ; nacteni vsech kodu pro kontrolu, zda vazba opravdu existuje
 
 for  
 {
   s id=$o(^$$$MarcIndexG("CavUnEpca","zmdl",term,id))
   q:id=""
   
   s sRT001=##class(User.MARC).getT001(id)      ; ziskame akualni id zaznamu
   s sRClass=##class(User.MARC).getCLASS(id) 
   s sRLName=##class(User.Util).objectName2lname(sRClass)

   continue:('##class(User.MARC).getDATAX(.h,id,"T"))
   s sRT970b=$$$getTagX(.h,"970b")
   s sRT969f=$$$getTagX(.h,"969f")
   continue:(('((sUserR=2)||(sUserR=6)||(sUserR=5)))&&(sRT969f="N")) 
   continue:(sRT970b=sT970b)
   continue:($f(sRes,sRT001))
   
   /// 17.01.23 tt; přidána podmínka na existenci linku v reálných polích
   s sPomAllVazU888=..getAllU883(.h) ; nacteni vsech kodu pro kontrolu, zda vazba opravdu existuje
   continue:(('$f((sPomAllVazU888_";"_sPomAllU888),sRT001))&&('$f((sPomAllVazU888_";"_sPomAllU888),sT001)))
   
   s sRT200a=$$$getTagX(.h,"200a")
   s link="\qT001*"_sRLName_"*1 "_sRT001_"\q"_" "_sRT200a
   s:(sRes'="") sRes=sRes_"\n"_link
   s:(sRes="") sRes=link
 }
 
 s c=0
 d {
   s sTU88=$$$getTagXC(.handle,"U88",.c) ; vsetky citacie
   continue:((sTU88="")&&(c'=0))
   if (sTU88'="")
   { ; pokud mame vyplnene data, muzeme provadet akce 
     s sTU883=$$$getSubTagStr(sTU88,"3")
     s sTU88a=$$$getSubTagStr(sTU88,"a")
     s link=""
     if sTU883'="" 
     {
       s sTU883=##class(User.Util).strswap(sTU883,"*","*1 ")  
       continue:($f(sRes,sTU883))
       s link="\qT001*"_sTU883_"\q"
     }
     s:(sRes'="") sRes=sRes_"\n"_link_" "_sTU88a
     s:(sRes="") sRes=link_" "_sTU88a     
   }
 } while (c'=0)
  
 if (pPar4=1) 
 {
     s:($tr(sRes,"\n ","")'="") sRes=sRes_"\n&nbsp;"
 }
 
 ; 19.10.21 tt; oprava mozne vlozene mezery 
 if ($tr(sRes,"\n ","")'="")
 { ; zaverecne ulozeni   
   s result(nLBlock)=pPref_sRes, sRes=""      ; zapsani vysledku to resultu    
   s nLBlock=nLBlock+1 ; zvyseni pocitadla bloku     
 }
]]></Implementation>
</Method>

<Method name="getAllU883">
<Description>
nacteni vsech kodu U883 oddelenych ; z handlu

27.10.12 tt; pridano vysvetleni RIV a DOI
15.03.07 rs</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  ; nacteni vsech kodu, jestli existuje vazba
  s c=0, sAllTU883=""
  d { ; nacteme si vsechny kody z linku
    s sTU88=$$$getTagXC(.handle,"U88",.c) ; vsechny provazani
    continue:((sTU88="")&&(c'=0))
    if (sTU88'="")
    { ; pokud mame vyplnene data, muzeme provadet akce 
      s sTU883=$$$getSubTagStr(sTU88,"3")
      s:(sTU883'="") sAllTU883=sAllTU883_";"_sTU883
    }
  } while (c'=0)
  q sAllTU883
]]></Implementation>
</Method>

<Method name="checkFulltext">
<Description><![CDATA[
<pre> Pridana metoda pro overeni, jestli je v zaznamu fulltext pro kontroly kvality zaznamu

08.09.17 tt; založena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<PublicList>handle,pRet</PublicList>
<Implementation><![CDATA[
   s pRet=1
   s ret=..allowDeleteContent(.handle)
   s:(ret'="") pRet=0  ; pokud mame fulltext, vratime 1
]]></Implementation>
</Method>

<Method name="fmtRIVOECD">
<Description>
blok do ZF

27.10.12 tt; pridano vysvetleni RIV a DOI
15.03.07 rs</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sRes=""

  ; 01.03.18 tt; pridano zobrazeni OECD
  s sPrekPrefixOECD=..prekladPrefixuIpac(.handle,"U191")
  s:(sPrekPrefixOECD="") sPrekPrefixOECD="Obor OECD"
  s sOECD=""
  s tc26x=$$$getTagX(.handle,"C26x")  ; EPCA_OECD
  s tc26y=$$$getTagX(.handle,"C26y")   ; EPCA_OECDALL_2
  s tc26z=$$$getTagX(.handle,"C26z") ; EPCA_OECDALL_3
  if (tc26z'="") { d ##class(rep.zf.ub).ubCis(.tc26z,.handle,"","EPCA_OECDALL_3-1")  }
  elseif (tc26y'="")  {  d ##class(rep.zf.ub).ubCis(.tc26y,.handle,"","EPCA_OECDALL_2-1")  }
  elseif (tc26x'="")  {   d ##class(rep.zf.ub).ubCis(.tc26x,.handle,"","EPCA_OECD-1")   }
  if (tc26z'="") { s sRes=sRes_tc26z,sOECD=tc26z }
  elseif (tc26y'="")  {  s sRes=sRes_tc26y,sOECD=tc26y }
  elseif (tc26x'="")  {   s sRes=sRes_tc26x ,sOECD=tc26x }
   /*
  s c=0,bC47pref=(sOECD'="")
  d {
     s sTC47=$$$getTagXC(.handle,"C47",.c) ; vsechny spoluprace
     continue:((sTC47="")&&(c'=0))         ; pokud nemam data pokracuji
     if (sTC47'="") 
     { ; pokud mame vyplnene data, muzeme provadet akce 
       s sTC47a=$$$getSubTagStr(sTC47,"a")
       s sTC47b=$$$getSubTagStr(sTC47,"b")
       s sTC47c=$$$getSubTagStr(sTC47,"c")
       s sTC47d=$$$getSubTagStr(sTC47,"d")
       s sOECDtext=""
       if (sTC47d'="") { d ##class(rep.zf.ub).ubCis(.sTC47d,.handle,"","EPCA_OECDALL_3-1")  }
       elseif (sTC47c'="")  {  d ##class(rep.zf.ub).ubCis(.sTC47c,.handle,"","EPCA_OECDALL_2-1")  }
       elseif (sTC47b'="")  {   d ##class(rep.zf.ub).ubCis(.sTC47b,.handle,"","EPCA_OECD-1")   }
       if (sTC47d'="") { s sOECDtext=sTC47d }
       elseif (sTC47c'="")  {  s sOECDtext=sTC47c }
       elseif (sTC47b'="")  {   s sOECDtext=sTC47b }
       
       if ((sTC47a'="")&&(sOECDtext'=""))
       { ; pokud mame vyplnene obe pole, pridavame
         if (bC47pref=0)
         { ; nemame prefix a musime ho vlozit
           s sRes=sRes_"\n"_sOECDtext_" ("_sTC47a_")" 
           s bC47pref=1 ; naplnime priznak, ze mame prefix
         }
         else 
         { ; mame prefix, jen prilozime retezec
           s sRes=sRes_"; "_sOECDtext_" ("_sTC47a_")" 
         }
       }
     }
  } while (c'=0)   
 */
 s:(sRes'="") sRes=sPrekPrefixOECD_" : "_sRes
 q sRes
]]></Implementation>
</Method>

<Method name="changeDATAZF">
<Description><![CDATA[
<pre> Zalozena metoda pro zmenu
Metoda, ktera podle parametru upravuje data handlu pro potreby zobrazovaciho formatu
parametry: handle - aktualne zpracovavany handle
           params - 1 - toto nastaveni provede odmazani 463 krome 463/200a a 463/0** ]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params=""]]></FormalSpec>
<PublicList>gnDEBUG</PublicList>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s s970b=$$$getTagX(.handle,"970b")
  
  if (params = "1")
  {
    ; N – článek v novinách, R1
    q:((s970b'="N")&&(s970b'="R1")) ""
    s s463=$$$getTagX(.handle,"463")
  
    if (s463'="")
    { ; 24.11.15 tt; oprava, aby se nedotahovali Uxx pole do 4xx zaznamu
      if ##class(MARC).t4xx2handle(.handle4,s463) 
      {
        s s200a=$$$getTagX(.handle4,"200a")
        s s011a=$$$getTagX(.handle4,"011a")
        d ##class(User.MARC).delTagX(.handle4,"U**")
        d ##class(User.MARC).delTagX(.handle4,"2**")
        d ##class(User.MARC).delTagX(.handle4,"7**")
        d ##class(User.MARC).delTagX(.handle4,"9**")
        d ##class(User.MARC).setTagX(.handle4,"200    "_$c(31)_"a"_s200a)
        s s463=##class(MARC).handle2t4xx(.handle4,$e(s463,1,3)_$e(s463,5,6)) 
        d:($l(s463)>10) ##class(User.MARC).setTagX(.handle,s463)
      }
    }
  }
 q ""
]]></Implementation>
</Method>

<Method name="tfLicence">
<Description>
Meno aktualne prihlaseneho uzivatela. funguje v pripade, ze bezime v ramci
WS sluzby. V opackom pripade vrati ""

result - result na ukladani navraceneho vysledku
handle - aktualni zpracovavany handle
params - metoda, ktera se bude interpretovat - oddelene -
         - prefix - pro short je to :
         - klient - 1 - zobrazuje informace vzdy
         - 1 - tluste prefixy 

psErr  - chybovy vystup - vypiseme ho zrovna do zf

03.12.21 tt; pridana moznost mit tucne prefixy
31.01.19 tt; zalozena metoda
--</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s role=""
  ; pozor v pripade ze uzivatela nejde zistit - treba vratit 0 
  ; teda pesimisticky pristup
  s sT001=$$$HandleT001(handle)                            ; ziskani t001
  if ##class(i2.ws.auth).getLoginLoggedIn()                ; pro testovani nutne zakomentovat
  { ; nacteni informaci o uzivateli
    s sUserID=##class(i2.access).getLoginId()
    //s sUserID="0001052"
    s role=##class(User.CavS).FTgetIsUser(sUserID, sT001)
  }
  
  s pPar1=$p(param,"-",1)              ; prefix
  s pPar2=$p(param,"-",2)              ; prefix
  s pPar3=$p(param,"-",3)              ; prefix
  s:(pPar2=1) role=8

  s sPRNazev=##class(rep.zf.tf).prefix(.handle,"U201")  ; Název smlouvy
  s sPRDatum=##class(rep.zf.tf).prefix(.handle,"U202")  ; Datum uzavření smlouvy
  s sPRPozn=##class(rep.zf.tf).prefix(.handle,"U203")   ; Poznámka ke smlouvě
  s sPRKom=##class(rep.zf.tf).prefix(.handle,"U204")    ; Komerční využití plynoucí ze smlouvy
  if (pPar3=1)
  {
   s sPRNazev="<strong>"_sPRNazev_"</strong>"
   s sPRDatum="<strong>"_sPRDatum_"</strong>"
   s sPRPozn="<strong>"_sPRPozn_"</strong>"
   s sPRKom="<strong>"_sPRKom_"</strong>"
  
  }
  s nLBlock=$o(result(""),-1)+1                    ; zjisti posledni blok
  s nLBlockZal=nLBlock
  
  if ((role="1")||(role="2")||(role="5")||(role="6")||(role="8"))
  { ; viditelne jen pro zpracovatele + spolupracujiciho, super, kontrolu a autora
    s c=0
    d {
      s sTC70=$$$getTagXC(.handle,"C70",.c) ; vsetky smlouvy
      continue:((sTC70="")&&(c'=0))
      if (sTC70'="")
      { ; pokud mame vyplnene data, muzeme provadet akce 
        //:(nLBlockZal'=nLBlock)
        s result(nLBlock)=pPar1, nLBlock=nLBlock+1
        s sTC70a=$$$getSubTagStr(sTC70,"a")
        s sTC70b=$$$getSubTagStr(sTC70,"b")
        s sTC70c=$$$getSubTagStr(sTC70,"c")
        s sTC70d=$$$getSubTagStr(sTC70,"d")
        s:(sTC70d="") sTC70d="0"                  ; nastaveno na hodnotu ne

        if (sTC70a'="")
        { ; vypiseme nazev
          s result(nLBlock)=pPar1_sPRNazev_": "_sTC70a, nLBlock=nLBlock+1
        }
        if (sTC70b'="")
        { ; Datum uzavření smlouvy
          s:(sTC70b?8N) sTC70b=$e(sTC70b,7,8)_"."_$e(sTC70b,5,6)_"."_$e(sTC70b,1,4)  
          s result(nLBlock)=pPar1_sPRDatum_": "_sTC70b, nLBlock=nLBlock+1
        }
        if (sTC70c'="")
        { ; Poznámka ke smlouvě
          s result(nLBlock)=pPar1_sPRPozn_": "_sTC70c, nLBlock=nLBlock+1
        }
        if (sTC70d'="")
        { ; Komerční využití plynoucí ze smlouvy
          s result(nLBlock)=pPar1_sPRKom_": "_##class(User.Util).sXlate("STBL_YESNO",sTC70d,,"Cav") , nLBlock=nLBlock+1
        }      
     }
   } while (c'=0)
  }
]]></Implementation>
</Method>

<Method name="sendMailVkladatel">
<Description><![CDATA[
<pre> Metoda pro rozeslání email vkladateli, pokud zpracovatel vystavil jeho datový záznam
Parametry: handle  - aktualni zpracovavany handle - jen puvodni verze pred vystaveni - pro jistotu kvuli 999e

https://arl2.library.sk/wiki_arl/index.php/CAV/nab%C3%ADdka_2021#1.4._upozorn.C4.9Bn.C3.AD_na_nov.C3.A9_z.C3.A1znamy_ke_kontrole_v_myASEP_a_e-mailem_.28e-mail_pro_vkladatele_-_zpracovatel_bude_mit_.22chytry_link.22.29_27
19.11.21 tt; provedeny zmeny v emailu
17.11.21 tt; zalozena metoda pro rozeslani emailu pri vystaveni dataveho zaznamu
</pre> ]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pDataVkladatel999e=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   s err="",sEmail=""
   s sT001=$$$HandleT001(handle)              ; ziskani t001

   s sIDUser=pDataVkladatel999e
   s sHandle=$$$getTagX(.handle,"C60a") 
   s:(sHandle'="") sHandle="<a href="""_sHandle_""" target=""_blank"" title=""Handle link"">"_sHandle_"<span></span></a>"
   s:(sHandle="") sHandle="(SYSNO _"_sT001_")"
   q:(sIDUser="") ""

   if ##class(User.MARC).readLX(.handleU,sIDUser)
   { ; pokud se poradi nacist uzivatele, pokracuji
     ; 23.05.14 lp; ze zaznamu ctenare nacist vsechny mailove adresy z opakovatelneho 100e
     s s100=$$$getTagX(.handleU,"100")
     s sEmail=##class(User.MARC).getSubTagStr(s100,"e",-1)  ; email
     s sEmail=$tr(sEmail,$c(10),",")
     if (sEmail="")
     { ; pokud se nepodarilo nacist email, pokusim se ho dotahnout z autority
       s sIDAuth=$$$getTagX(.handleU,"620a") 
       if ##class(User.MARC).readLX(.handleA,sIDAuth)
       { ; nacteme autoritu
         s sEmail=$$$getTagX(.handleA,"C01f")  ; email            
       }
     }        
   }
 
  
   s ictx="cav"
   s ipref=$zcvt(ictx,"W")
   s lang=+##class(User.Util).getServerLanguage(ipref)
   d ##class(i2.init).batchinit(ictx,lang)
   
   s bHtml=1 ; nastaveno napevno, puvodne to bylo v konfiguraci I2_EMAILS
   s sSEP=$s(bHtml:"<br/>",1:$$$CRLF)
   
   for i=1:1:$l(sEmail,$c(10))
   { ; po jednotlive emailu budeme odesilat
      s sEmail1=$p(sEmail,$c(10),i)                       ; ziskame jeden email
      continue:(sEmail1="")
      
      s sMailBody=""
        
      s sMailBody=sMailBody_sSEP_"Vážený vkladateli,"_sSEP_"správce dat Vašeho pracoviště formálně prohlédl datový záznam "_sHandle_" a povolil jeho zveřejnění v online katalogu repozitáře ASEP."_sSEP
      s sMailBody=sMailBody_sSEP_"Se srdečným pozdravem"_sSEP_"Tým Repozitáře ASEP"_sSEP_sSEP_sSEP_sSEP

      s sMailBody=sMailBody_sSEP_"Dear Depositor,"_sSEP_"your institutional ASEP administrator has formally reviewed the "_sHandle_" data record and approved its publication in the ASEP online repository catalog."_sSEP
      s sMailBody=sMailBody_sSEP_"Kind regards"_sSEP_"ASEP Repository team"
      
      s err=""
      d ##class(util.emailgw).send($$$IPREF,sMailBody,,.err,"repozitar","Datový záznam - zveřejněn/Data record - published",$$$GETLANGUAGE,,sEmail1,,,,,"cp1250")
      
    }   
    
    q err
]]></Implementation>
</Method>

<Method name="tfDuplicita">
<Description>
Meno aktualne prihlaseneho uzivatela. funguje v pripade, ze bezime v ramci
WS sluzby. V opackom pripade vrati ""

result - result na ukladani navraceneho vysledku
handle - aktualni zpracovavany handle
params - metoda, ktera se bude interpretovat - oddelene -
         - prefix - pro short je to :
         - klient - 1 - zobrazuje informace vzdy
         - 1 - tluste prefixy 


22.03.22 tt; zalozena metoda
--</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&result,&handle:%Binary,param=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
  s role=""
  ; pozor v pripade ze uzivatela nejde zistit - treba vratit 0 
  ; teda pesimisticky pristup
  s sT001=$$$HandleT001(handle)                            ; ziskani t001
  if ##class(i2.ws.auth).getLoginLoggedIn()                ; pro testovani nutne zakomentovat
  { ; nacteni informaci o uzivateli
    s sUserID=##class(i2.access).getLoginId()
    s role=##class(User.CavS).FTgetIsUser(sUserID, sT001)
  }
  
  s pPar1=$p(param,"-",1)              ; prefix
  s pPar2=$p(param,"-",2)              ; klient
  s pPar3=$p(param,"-",3)              ; tlusty prefix
  
  s sPomC99d=$$$getTagX(.handle,"C99d")
  q:(sPomC99d'="DFLTI_EPCA_CZ_WOSSCOPUS")
  
  s sPRNazev=##class(rep.zf.tf).prefix(.handle,pPar1)  ; prefix
  s sPRtext=##class(rep.zf.tf).prefix(.handle,pPar2)  ; text
  if (pPar3=1)
  {
   s sPRNazev="<strong>"_sPRNazev_"</strong>"
  }
  
  s nLBlock=$o(result(""),-1)+1                    ; zjisti posledni blok
  s nLBlockZal=nLBlock
  
  if ((role="1")||(role="2")||(role="5")||(role="6"))
  { ; viditelne jen pro zpracovatele + spolupracujiciho, super, kontrolu a autora
    s t001="",nDuplicita=0
    s t001=..tfDuplicitaHledejZaznam(.handle)
    
    if (t001'="")
    { ; pridani duplicity do zf
      s result(nLBlock)=sPRNazev_": <font color=""red"">"_$$$strswap(sPRtext,"%s",t001)_"</font>"

    }
  }
]]></Implementation>
</Method>

<Method name="tfDuplicitaHledejZaznam">
<Description>
Hledani zaznamu duplicity
parametry: handle  - handle zaznamu pro hledani

14.03.23 tt; založena metoda kvůli možnosti vyhledání záznamů</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s t001="",sT001=$$$HandleT001(handle)  
  s sIDWos=" "_$$$getTagX(.handle,"014a")
  s sDOI=" "_$$$getTagX(.handle,"017a")

  s sNazev=" "_##class(User.SPIndex).ixAddTermFixLength($zcvt($$$getTagX(.handle,"200a"),"L"))
  if ($tr(sIDWos," ,./","")'="")
  { ; hledani duplicity podle id wos
    s t001=..tfDuplicitaHledej(sT001,sIDWos, "zidc")
  }     
  if (($tr(sDOI," ,./","")'=""))&&(t001="")
  { ; hledani duplicity podle DOI
    s t001=..tfDuplicitaHledej(sT001,sDOI, "zdoi")
  }
  if (t001="")
  { ; hledani duplicity podle nazvu
    s t001=..tfDuplicitaHledej(sT001,sNazev, "ti")
  }
  q t001
]]></Implementation>
</Method>

<Method name="tfDuplicitaHledej">
<Description>
pomocna metoda na hledani 001 duplicity
parametry: pT001  - 001 zaznamu kvuli tomu, jestli jsme nenasli sami sebe
           termin - hledany termin v indexu - musi byt osetreny mezery na zacacku
           index  - index, ve kterem se ma duplicita hledat</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pT001,termin,index</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
   s t001="", id="" 
   s id=$o(^ooDataTableI("CavUnEpca",index,termin,""))
   s:(id'="") t001=##class(User.MARC).getT001(id) 
   if (t001=pT001)
   { ; pokud odkazuji na sebe 
     s t001=""
     s id=$o(^ooDataTableI("CavUnEpca",index,termin,id))
     s:(id'="") t001=##class(User.MARC).getT001(id) 
   }
   q t001
]]></Implementation>
</Method>

<Method name="versionDataFilter">
<Description>
Zalozena metoda pro vyuzití ve filtru a naplnění U03
Kopide datasetu z IPACu

24.11.22 tt; zalozena metoda</Description>
<ClassMethod>1</ClassMethod>
<ProcedureBlock>1</ProcedureBlock>
<PublicList>handle,pErr</PublicList>
<Implementation><![CDATA[
   ; podminka, upraveujeme jen datove zaznamy -
   q:($$$getTagX(.handle,"C99d")'="DFLT_DATA") 
   s sU03new=""
   ; ziskame si udeja o zaznamu
   s sT001=$$$HandleT001(handle)  
   s sU03=$$$getTagX(.handle,"U03")  ; tag pro verze  
   s sU03a=$$$getTagX(.handle,"U03a")
   
   if (sU03'="")
   { ; pokud jiz existuje verze, vlozime
     s sU03new="U03    "_$c(31)_"3"_$$$getTagX(.handle,"U033")
   }
   else
   { ; pokud zakladame prvni verzi, zapiseme kod
     s sU03new="U03    "_$c(31)_"3cav_un_epca*"_sT001
   }
   d:(sU03new'="") ##class(MARC).setTagX(.handle,sU03new)
   
   s sLasVersion=..versionDataGetLastVersion(.handle)
   
   if (sLasVersion="ERROR")
   {
     s pErr="Při zpracování záznamu se vyskytla chyba. Není možné udělat kopii datasetu"
   }
   elseif (sLasVersion'="")
   { 
     if (($p(sLasVersion,"#",1)="")&&('$f(p(sLasVersion,"#",2),sT001)))
     {
       s pErr="Je již rozpracovaná jiná verze datasetu."
     }
   }
   ; 02.08.23 tt; provedeno osetreni filteru tak, aby se zapsal spravne rok vykazovani
   s sC26fullX=$$$getTagX(.handle,"C26")
   s sC26fullX=$$$setSubTagStr(sC26fullX,$c(31)_"d"_..#cAktRokZberu)
   d $$$setTagX(.handle,sC26fullX)
]]></Implementation>
</Method>

<Method name="versionDataGetLastVersion">
<Description>
Pozor, číslování u U03a začíná 002. Je to z důvodu, že číslo 001 má originální záznam, který ale nemá U03
Metoda na vrácení poslední verze (U03a) - buď tedy vrátí prázdný řetězec, pokud neexistuje vyšší verze
pokud najde poslední rozpracovanou, vraci jeji kod bez U03a
vrací U03a#kod nejvyssi verze - i rozpracovane
nic, pokud nejsou verze
 handle - aktualni zpracovavany handle
     ERROR - chyba u zpracovani
 pPar   - parametry - 1 - zobrazit i s pracovni verzi  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret="", sRetU03a="", sRetU033=""
  q:($$$getTagX(.handle,"C99d")'="DFLT_DATA") "ERROR"
  s sT001=$$$HandleT001(handle)  
  ; seskládání správného dotazu na vyhledání poslední verze
  s link=$$$getTagX(.handle,"U033")
  s:(link="") link="cav_un_epca*"_$$$HandleT001(handle)
  s:(link'="") link=" "_link
  
  s idxData=""
  for  
  { ; zistit vsechny navazani na datove zaznamy
    s idxData=$o(^$$$MarcIndexG("CavUnEpca","zdv",link,idxData))
    q:(idxData="")
    if ##class(MARC).getDATAX(.verhandle,idxData)
    {
      s ret=""
      s sU03=$$$getTagX(.verhandle,"U03")
      s sU03a=$$$getTagX(.verhandle,"U03a")
      if ((sU03a'="")&&(sU03a>sRetU03a)) 
      {
        s sRetU03a=sU03a   ; vyplnime si posledni verzi
        s sRetU033="cav_un_epca*"_$$$HandleT001(verhandle) 
      }
      elseif ((sU03a="")&&($p(pPar,"-",1)=1)&&('$f(link,$$$HandleT001(verhandle))))
      { ; rozpracovaná kopie datasetu
        s sRetU03a=""
        s sRetU033="cav_un_epca*"_$$$HandleT001(verhandle) 
      }
    }
  }
  s:((sRetU03a'="")||(sRetU033'="")) ret=sRetU03a_"#"_sRetU033
  q ret
]]></Implementation>
</Method>

<Method name="versionDataGetAll">
<Description>
 Metoda pro vraceni retezdu s verzemi. Vraci sVerze a retezec. Bud prazdny, pokud neni vyssi verze nez 0, nebo vyplneny
 
 handle - aktualni zpracovavany handle
 pPar   - parametry - zobrazit i s pracovni verzi  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,&sVerze,pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret="", sRetU03a="", sRetU033=""
  k sVerze
  q:($$$getTagX(.handle,"C99d")'="DFLT_DATA") ""
  
  s sT001=$$$HandleT001(handle)  
  ; seskládání správného dotazu na vyhledání poslední verze
  s link=$$$getTagX(.handle,"U033")
  s:(link="") link="cav_un_epca*"_$$$HandleT001(handle)
  s:(link'="") link=" "_link
  
  s idxData=""
  for  
  { ; zistit vsechny navazani na datove zaznamy
    s idxData=$o(^$$$MarcIndexG("CavUnEpca","zdv",link,idxData))
    q:(idxData="")
    if ##class(MARC).getDATAX(.verhandle,idxData)
    {
      s sU03=$$$getTagX(.verhandle,"U03")
      s sU03a=$$$getTagX(.verhandle,"U03a")
      if ((sU03a'="")&&(sU03a>sRetU03a)) 
      {
        s sRetU03a=sU03a   ; vyplnime si posledni verzi
        s sRetU033="cav_un_epca*"_$$$HandleT001(verhandle) 
        s sVerze(sU03a)=sRetU033 
        s ret=ret_"#"_sRetU033
      }
      elseif ((sU03a="")&&($p(pPar,"-",1)=1)&&('$f(link,$$$HandleT001(verhandle))))
      { ; rozpracovaná kopie datasetu - zobrazit i ji
        s sRetU03a=""
        s sRetU033="cav_un_epca*"_$$$HandleT001(verhandle) 
        s sVerze("09999")=sRetU033
        s ret=ret_"#"_sRetU033
      }
    }
  }  
  
  if $d(sVerze)
  {
    s sVerze("001")=$e(link,2,99),ret=$e(link,2,99)_ret
  }
  q ret
]]></Implementation>
</Method>

<Method name="versionZfGetData">
<Description>
 Metoda, která se zapojí do zobrazovacího formátu. Vrátí číslo verze a obohatí záznam o tag
 ZFV$a, kde bude upozornění na novou verzi z FT_PREFIXES
    s:(text="U244") ret="Verze "
    s:(text="U245") ret="Rozpracovaná verze"
    s:(text="U246") ret="Existuje novější verze datasetu"
    s:(text="U247") ret="Verze záznamu"
             U248
 
 handle - aktualni zpracovavany handle
 pPar   - parametry - zobrazit i s pracovni verzi  - parametry oddělené -
        1. parametr není prázdný - prefix k textu o verzi TF_PREFIXES
        2. parametr není prázdný - text o rozpracovane verzi TF_PREFIXES
        3. parametr není prázdný - obohati handle o ZFV$a o text z TF_PREFIXES
        4. parametr - prefix. Pokud je zadán, vrátí se řetězec s prefixem  </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sRetU03a="", sRetU033="", sVerze="", sPrefix1="", sPrefix2="", sPrefix3="", sPrefix4="", sPrefix5="",sZobrazIno=0
  q:($$$getTagX(.handle,"C99d")'="DFLT_DATA") ""
  s sPar1=$p(pPar,"-",1) ; parametr není prázdný - text do verze u záznamu
  s sPar2=$p(pPar,"-",2) ; text pro rozpracovanou verzi
  s sPar3=$p(pPar,"-",3) ; text o informaci o novějších verzích
  s sPar4=$p(pPar,"-",4) ; případný prefix, zatím asi nebude využito
  s sPar5=$p(pPar,"-",5) ; zobrazit informaci o rozpracované verzi
  
  s:(sPar1'="") sPrefix1=..prekladPrefixuIpac(.handle,sPar1)
  s:(sPar2'="") sPrefix2=..prekladPrefixuIpac(.handle,sPar2)
  s:(sPar3'="") sPrefix3=..prekladPrefixuIpac(.handle,sPar3)
  s:(sPar4'="") sPrefix4=..prekladPrefixuIpac(.handle,sPar4)
  s:(sPar5'="") sPrefix5=..prekladPrefixuIpac(.handle,sPar5)
    
  s sT001=$$$HandleT001(handle) 
  s sLastVersion=..versionDataGetLastVersion(.handle)
  s sLastVersion1=##class(User.CavUnEpca).versionDataGetLastVersion(.handle,"1")
  s sLastVersionNumber=$p(sLastVersion,"#",1)
  s sU03=$$$getTagX(.handle,"U03")
  s sU03a=$$$getTagX(.handle,"U03a")
  s bNewVer=0

  ; seskládání správného dotazu na vyhledání poslední verze
  if ((sLastVersion'="")&&(sU03=""))
  { ; datový dáznam je jen jeden původní, bez verzí
    s sVerze=sPrefix1_"1"
    s sZobrazIno=1
  }
  elseif ((sLastVersion'="")&&('$f(sLastVersion,$$$HandleT001(handle)))&&(sU03a'="")&&(sU03'=""))
  { ; datový záznam má verze a aktuální verze není poslední, vytovříme ZFV a vrátíme verzi v jejím tvaru 1
    s sVerze=sPrefix1_(sU03a+0)
    s sZobrazIno=1
  }
  elseif ((sLastVersion'="")&&($f(sLastVersion,$$$HandleT001(handle)))&&(sU03a'=""))
  { ; poslední verze datového záznamu vrátíme verzi v jejím tvaru 1 - jen jedno číslo
    s sVerze=sPrefix1_(sU03a+0)    
  }
  elseif ((sLastVersion'="")&&('$f(sLastVersion,$$$HandleT001(handle)))&&(sU03a="")&&(sU03'=""))
  { ; posledni je rozpracovany zaznam - nema verzi, jen vypiseme info - par2
    s sVerze=sPrefix2_" ("_(sLastVersion+1)_")"
    s bNewVer=1
  } 
  elseif ((sLastVersion="")&&(sLastVersion1'="")&&(sU03a="")&&(sU03'=""))
  { ; posledni je rozpracovany zaznam - nema verzi, jen vypiseme info - par2
    s sVerze=sPrefix2_" ("_(sLastVersion+1)_")"
    s bNewVer=1
  } 
  
  if (sPrefix3'="") 
  { ; zobrazeni informace o novejsich verzich
    if (sZobrazIno=1) { s sVerze=sPrefix3 }
    else { s sVerze="" }  
  }
  if ((sPrefix5'="")&&(sVerze="")&&($p(sLastVersion1,"#",1)="")&&($p(sLastVersion1,"#",2)'="")&&##class(i2.ws.auth).getLoginLoggedIn()&&(bNewVer'=1)) 
  { ; 03.02.23 tt; zobrazuje se informace o rozpracování jen přihlášenému uživateli
    s sVerze=sPrefix5
  }
  s:((sPrefix4'="")&&(sVerze'="")) sVerze=sPrefix4_" : "_sVerze
  
  q sVerze
]]></Implementation>
</Method>

<Method name="versionZfGetDataSpol">
<Description>
01.11.23 tt; zalozena spolecna zf metoda kvuli nevhodnemu odradkovani</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,pPar=""]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s ret="", sPrefix1=""
  s sPar1=$p(pPar,"-",1) ; parametr není prázdný - text do verze u záznamu
  s:(sPar1'="") sPrefix1=..prekladPrefixuIpac(.handle,sPar1)

  s sVer1=##class(User.CavUnEpca).versionZfGetData(.handle,"U244-U245-")
  s sVer2=##class(User.CavUnEpca).versionZfGetData(.handle,"U244-U245-U246--U248")
  if sPrefix1'=""
  { /// 1.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno
    s:(sVer1'="")||(sVer2'="") ret=sPrefix1_" : <strong><font color=""red"">"_sVer1_"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_sVer2_"</font></strong>"
  }
  else
  {
    s:(sVer1'="")||(sVer2'="") ret=" : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color=""red"">"_sVer1_"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_sVer2_"</font></strong>"
  }
  q ret
]]></Implementation>
</Method>

<Method name="fixStrongUrl856">
<Description><![CDATA[
</pre> upraveni 856, pokud je tam retezec .b.
30.03.23 tt; medota 
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle:%Binary,params:%String]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sT001=$$$HandleT001(handle)       ; ziskani t001
  s sClass=$$$HandleClass(handle)     ; ziskani tridy
  if (##class(User.MARC).readX(.handleX,sClass,sT001))
  {
    s sX856 = $$$getTagXC(.handleX,"856",-1)
    if $f(sX856,".b.")
    {
     s sX856=$$$strswap(sX856,".b.","./retezecBtecka.")
     s s856 = $$$getTagXC(.handle,"856",-1)
     if (s856'=sX856)
     { ; provedena změna na opravdové 856 + zaescapovani
       d ##class(MARC).setTagX(.handle,sX856)
       d ##class(util.index).enhance(.handle)  // https://cosmo2/Wiki/index.php?title=Ergonomic_data_in_zf
     }
    }  
  }    
  q "" ; fakt nechcu nic zobrazovat :-)
]]></Implementation>
</Method>

<Method name="checkAutorID">
<Description><![CDATA[
<pre> Pridana metoda kontrolu identifikatoru autora pro kontroly kvality zaznamu
vyuziva se pro kontrolu podle zaznamu stazeny z wos 70*A a 70*B - muze byt
Mozne parametry: pParams - A - kontrola podle 70*A - ORCID
                           B - kontrola podle 70*B - WOS

13.14.23 tt; založena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pParams="A"</FormalSpec>
<PublicList>handle,pRet,psLine</PublicList>
<Implementation><![CDATA[
   s pRet=0,sIdaHod="",bFindKod=0,sKodORCID="",sKodWOS=""   ; nastaveni pomocnych promennych

   s sKodAutora=$$$getSubTagStr(psLine,"3") 
   if (sKodAutora'="")
   { ; pokud mame kod autora, zjistime si id a  podle toho v indexu ida, zda jsou identifikatory
     s sAuthID=##class(User.MARC).getIDByIndex("CavUnAuth","T001",$p(sKodAutora,"*",2))
     q:(sAuthID="")  ; pokud nejsme schopni ziskat id, koncime  
     
     s sKodORCID=" "_$zcvt($$$getSubTagStr(psLine,"A") ,"L") 
     s sKodWOS=" "_$zcvt($$$getSubTagStr(psLine,"B"),"L")  

     d { ; kontrola na hodnotu zaznamu index - openaire
        s sIdaHod=##class(User.MARC).getIdxVal("CavUnAuth",sAuthID,"ida",sIdaHod)
        continue:(sIdaHod="")
        s:($f(pParams,"A")&&(sIdaHod=sKodORCID)) bFindKod=1
        s:($f(pParams,"B")&&(sIdaHod=sKodWOS)) bFindKod=1
     } while (sIdaHod'="")
   }
   s:($f(pParams,"A")&&($tr(sKodORCID," ")'="")&&(bFindKod=0)) pRet=1
   s:($f(pParams,"B")&&($tr(sKodWOS," ")'="")&&(bFindKod=0)) pRet=1
]]></Implementation>
</Method>

<Method name="exportDataciteXml">
<Description><![CDATA[
<pre> Metoda zajišťující export do datacite xml. Může být dle vzoru exportXMLUN

20.06.23 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnWhat,pnOutFmt]]></FormalSpec>
<Implementation><![CDATA[
  
  if pnWhat=$$$I2ExportHdr    {
       d ##class(i2.export).outputAdd("<?xml version=""1.0"" encoding=""UTF-8""?>"_$c(10),pnOutFmt)
       q
  }
  if pnWhat=$$$I2ExportFooter q
  if pnWhat'=$$$I2ExportBody zt "ER1" ; poistka chybne volanie

  ; zjisteni parametru z konfigurace volaneho exportu
  s sExpInfo=##class(i2.export).getExportInfo()
  ; v $e jsou doplnkove options
  s sFmtParams=$p(sExpInfo,$c(10),$$$I2cfgrowE)
  
  s sT001=$$$HandleT001(handle)       ; ziskani t001
  s sClass=$$$HandleClass(handle)     ; ziskani tridy
  if ##class(User.MARC).readX(.handleN,sClass,sT001,"T")  
  {
    d ..exportDataciteXmlHandle(.handleN,pnOutFmt,sFmtParams)
  }
]]></Implementation>
</Method>

<Method name="exportDataciteXmlHandle">
<Description><![CDATA[
<pre> Export jednoho záznamu v XML do DATACITE
Parametry:  handle - aktualni zpracovavany handle
            pnOutFmt, sFmtParams - vystupni soubor a patametry
            pTyp - "Datacite" - export datacite z kosiku
                   "Openaire" - oai xml pro openaire OAI_DATACITE format

30.08.23 tt; provedeny úpravy exportu datacite
20.06.23 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&handle,pnOutFmt,sFmtParams="",pTyp="Datacite"]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
 s bEndOfRec=0,brk=0
 s type=##class(User.MARC).recordDataFmtX(.handle,.subfmt)
 
 ; pridana moznost vlozeni xmlns prefixu pres options (I2_EXPORT/200$e)
 s sPrefix=sFmtParams
 if sPrefix'="",'$f(sPrefix,":") s sPrefix=sPrefix_":"
 

 d ##class(i2.export).outputAdd("<"_sPrefix_"resource"
         _" xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"""
         _" xmlns=""http://datacite.org/schema/kernel-4e"""
         _" xsi:schemaLocation=""http://datacite.org/schema/kernel-4 http://schema.datacite.org/meta/kernel-4/metadata.xsd"">"_$c(10),pnOutFmt)
  
  s sDOI="", sTitle="", sTransTitle="", sAltTitle="",sT16r="",sLicence="",sTypSouboru="",bSubject=0
  s sJazyk="",sPopisCz="", sPopisEn="",bProjekt=0,sDatumOd="",sDatumDo="",sLokace="",sHandle="",bVazby=0
  s sVerze=""
  
  s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
  f i=1:1:nC 
  { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
    s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
    s sTag=$e(lsLine,1,3)
    if (sTag="017")
    {  ; nacteme si DOI
       s:($$$getSubTagStr(lsLine,"2")="DOI") sDOI=$$$getSubTagStr(lsLine,"a")   
    } 
    elseif (sTag="101") 
    { ; <language>  volitelné   101a
     s sJazyk=$$$getSubTagStr(lsLine,"a")
     s:(sJazyk="eng") sJazyk="en"
     s:(sJazyk="cze") sJazyk="cs"
    }
    elseif (sTag="200") 
    { 
      s sTitle=##class(User.Util).XMLfixup($$$getSubTagStr(lsLine,"a"))      ; nazev
      s sAltTitle=##class(User.Util).XMLfixup($$$getSubTagStr(lsLine,"e"))   ; alternativni nazev
    }
    elseif (sTag="541") 
    { ; nacteme si preklad nazvu - 541a, lang="en" -541zv
      s:($$$getSubTagStr(lsLine,"z")="eng") sTransTitle=##class(User.Util).XMLfixup($$$getSubTagStr(lsLine,"a"))
    }
    elseif (sTag="608") 
    { ; <resourceType> povinné     608a    Typ datových souborů
      s sTypSouboru=##class(User.Util).XMLfixup($$$getSubTagStr(lsLine,"a"))   
    }
    elseif (sTag="610") 
    { ; priznak, jestli exportuovat subjekt
      s:($$$getSubTagStr(lsLine,"a")'="") bSubject=1
    }
   elseif (sTag="617") 
    { ; <geoLocationPlace>  doporučené  617d
      s sLokace=$$$getSubTagStr(lsLine,"d") 
    }
    elseif (sTag="C12") 
    { ; priznak, jestli exportuovat subjekt
      s:($$$getSubTagStr(lsLine,"a")'="") bProjekt=1
    }
    elseif (sTag="C15") 
    { ; <description xml:lang="cs" descriptionType="Abstract">  doporučené  C15a    Popis v CZ
      ; <description xml:lang="en" descriptionType="Abstract">  doporučené  C15b    Popis v AJ
      s sPopisCz=##class(User.Util).XMLfixup($$$getSubTagStr(lsLine,"a"))
      s sPopisEn=##class(User.Util).XMLfixup($$$getSubTagStr(lsLine,"b"))
    }
    elseif (sTag="C26") 
    { ; priznak, jestli exportuovat subjekt
      s:($$$getSubTagStr(lsLine,"x")'="") bSubject=1
      s sC26x=##class(User.Util).sXlate("EPCA_OECDALL",$$$getSubTagStr(lsLine,"x"),,"Cav")
      s sC26y=##class(User.Util).sXlate("EPCA_OECDALL",$$$getSubTagStr(lsLine,"y"),,"Cav")
      s sC26z=##class(User.Util).sXlate("EPCA_OECDALL",$$$getSubTagStr(lsLine,"z"),,"Cav")      
    }
    elseif (sTag="C60") 
    { ; handle. net
      s sHandle=$$$getSubTagStr(lsLine,"a")   
    }
    elseif (sTag="C81") 
    { ; licence - <rights> 
      s sLicence=$$$getSubTagStr(lsLine,"b")   
    }
    elseif (sTag="T16") 
    { ; <publicationYear> 
      s sT16r=$$$getSubTagStr(lsLine,"r")   
    }
    elseif (sTag="U03") 
    { ; <version>   volitelné   U03a
      /// 01.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno
      s sVerze=$zstrip($$$getSubTagStr(lsLine,"a"),"<","0")
    }
    elseif (sTag="U22") 
    { ; priznak, jestli exportuovat subjekt
      s sDatumOd=$e($$$getSubTagStr(lsLine,"a"),1,8)
      s sDatumDo=$e($$$getSubTagStr(lsLine,"b"),1,8)
    }
    elseif (sTag="U88") 
    { ; navazane zaznamy
      s:($$$getSubTagStr(lsLine,"h")'="") bVazby=1
    }
  

  }
 ; export DOI
 d:(sDOI'="") ##class(i2.export).outputAdd($$$spc(2)_"<identifier identifierType=""DOI"">"_sDOI_"</identifier>"_$c(10),pnOutFmt) 

 ; nepouzijeme 70* kvoli tomu, ze poradie tagov moze byt zmenene
 s sAutoriVsichni=$$$getTagXC(.handle,"700",-1)_$c(10)
                      _$$$getTagXC(.handle,"701",-1)_$c(10)
                      _$$$getTagXC(.handle,"702",-1)

 d:(sAutoriVsichni'="") ##class(i2.export).outputAdd($$$spc(2)_"<creators>"_$c(10),pnOutFmt)
 s c=$l(sAutoriVsichni,$c(10))
 f i=1:1:c
 {
   s sAutor=$p(sAutoriVsichni,$c(10),i)
   continue:(sAutor="")
   d ..exportDataciteXmlAutInfo(sAutor,pnOutFmt,pTyp) 
 }
 d:(sAutoriVsichni'="") ##class(i2.export).outputAdd($$$spc(2)_"</creators>"_$c(10),pnOutFmt)

 d ##class(i2.export).outputAdd($$$spc(2)_"<titles>"_$c(10),pnOutFmt)
 if (pTyp="Datacite")
 {
   d:((sTitle'="")&&(sTransTitle'="")) ##class(i2.export).outputAdd($$$spc(4)_"<title xml:lang=""cs"">"_sTitle_"</title>"_$c(10),pnOutFmt)
   d:((sTitle'="")&&(sTransTitle="")) ##class(i2.export).outputAdd($$$spc(4)_"<title xml:lang=""en"">"_sTitle_"</title>"_$c(10),pnOutFmt)
   d:(sTransTitle'="") ##class(i2.export).outputAdd($$$spc(4)_"<title titleType=""TranslatedTitle"" xml:lang=""en"">"_sTransTitle_"</title>"_$c(10),pnOutFmt)
   d:(sAltTitle'="") ##class(i2.export).outputAdd($$$spc(4)_"<title titleType=""AlternativeTitle"">"_sAltTitle_"</title>"_$c(10),pnOutFmt)
 }
 else
 {
   d:(sTitle'="") ##class(i2.export).outputAdd($$$spc(4)_"<title>"_sTitle_"</title>"_$c(10),pnOutFmt)
   d:(sTransTitle'="") ##class(i2.export).outputAdd($$$spc(4)_"<title titleType=""TranslatedTitle"">"_sTransTitle_"</title>"_$c(10),pnOutFmt)
   d:(sAltTitle'="") ##class(i2.export).outputAdd($$$spc(4)_"<title titleType=""AlternativeTitle"">"_sAltTitle_"</title>"_$c(10),pnOutFmt)
 }
 d ##class(i2.export).outputAdd($$$spc(2)_"</titles>"_$c(10),pnOutFmt)
 d ##class(i2.export).outputAdd($$$spc(2)_"<publisher>ASEP repository</publisher>"_$c(10),pnOutFmt)
 d ##class(i2.export).outputAdd($$$spc(2)_"<publicationYear>"_sT16r_"</publicationYear>"_$c(10),pnOutFmt)
 
 
 if (sTypSouboru'="")
 {
  // w !,$$$spc(4)_"<resourceType resourceTypeGeneral=""Text"">"_sTypSouboru_"</resourceType>"_$c(10),pnOutFmt)
  if (sTypSouboru="DS") { d ##class(i2.export).outputAdd($$$spc(2)_"<resourceType resourceTypeGeneral=""Dataset"">Dataset</resourceType>"_$c(10),pnOutFmt) }
  elseif (sTypSouboru="TX") { d ##class(i2.export).outputAdd($$$spc(2)_"<resourceType resourceTypeGeneral=""Text""/>"_$c(10),pnOutFmt) }
  elseif (sTypSouboru="OBR") { d ##class(i2.export).outputAdd($$$spc(2)_"<resourceType resourceTypeGeneral=""Image""/>"_$c(10),pnOutFmt) }
  elseif (sTypSouboru="VI") { d ##class(i2.export).outputAdd($$$spc(2)_"<resourceType resourceTypeGeneral=""Audiovisual""/>"_$c(10),pnOutFmt) }
  elseif (sTypSouboru="AUD") { d ##class(i2.export).outputAdd($$$spc(2)_"<resourceType resourceTypeGeneral=""Sound""/>"_$c(10),pnOutFmt) }
  elseif (sTypSouboru="SW") { d ##class(i2.export).outputAdd($$$spc(2)_"<resourceType resourceTypeGeneral=""Software""/>"_$c(10),pnOutFmt) }
 }
 
 
 if (bSubject=1)
 {
   d ##class(i2.export).outputAdd($$$spc(2)_"<subjects>"_$c(10),pnOutFmt)
   s caa=0
   d { ; cyklus pres vsechny ID
       s sT610=$$$getTagXC(.handle,"610",.caa) ; vsechny ID
       continue:((sT610="")&&(caa'=0))
       s sT610a=$$$getSubTagStr(sT610,"a")
       d:(sT610a'="") ##class(i2.export).outputAdd($$$spc(4)_"<subject valueURI="""">"_sT610a_"</subject>"_$c(10),pnOutFmt)
   } while (caa'=0)
   //w:(sC26x'="") !,$$$spc(6)_"<subject subjectScheme=""Fields of Science and Technology (FOS)"" schemeURI=""http://www.oecd.org/science/inno"" valueURI=""http://www.oecd.org/science/inno/38235147.pdf"">"_sC26x_"</subject>"_$c(10),pnOutFmt)
   if (sC26y'="")
   {
     //d ##class(i2.export).outputAdd($$$spc(4)_"<subject subjectScheme=""Fields of Science and Technology (FOS)"" schemeURI=""http://www.oecd.org/science/inno"" valueURI=""http://www.oecd.org/science/inno/38235147.pdf"">FOS: "_$p(sC26y," ",2,999)_"</subject>"_$c(10),pnOutFmt)
     d ##class(i2.export).outputAdd($$$spc(4)_"<subject subjectScheme=""Fields of Science and Technology (FOS)"" schemeURI=""http://www.oecd.org/science/inno/38235147.pdf"" valueURI="""">FOS: "_sC26y_"</subject>"_$c(10),pnOutFmt)
   }
   //w:(sC26z'="") !,$$$spc(6)_"<subject subjectScheme=""Fields of Science and Technology (FOS)"" schemeURI=""http://www.oecd.org/science/inno"" valueURI=""http://www.oecd.org/science/inno/38235147.pdf"">"_sC26z_"</subject>"
   d ##class(i2.export).outputAdd($$$spc(2)_"</subjects>"_$c(10),pnOutFmt)
 }
 
 /* 1.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno
 if (sDatumDo'="")
 {  ; datum vydani, dost sporne
    d ##class(i2.export).outputAdd($$$spc(2)_"<dates>"_$c(10),pnOutFmt)
    //d ##class(i2.export).outputAdd($$$spc(4)_"<date dateType=""Issued"">"_sDatumDo_"</date>"_$c(10),pnOutFmt)
            //<date dateType="Other" dateInformation="Time period of dataset">2014-01-01/2019-12-31</date>
            d ##class(i2.export).outputAdd($$$spc(4)_"<date dateType=""Time period of dataset"">"_$e(sDatumOd,1,4)_"-"_$e(sDatumOd,5,6)_"-"_$e(sDatumOd,7,8)
            _"/"_$e(sDatumDo,1,4)_"-"_$e(sDatumDo,5,6)_"-"_$e(sDatumDo,7,8)_"</date>"_$c(10),pnOutFmt)
    d ##class(i2.export).outputAdd($$$spc(2)_"</dates>"_$c(10),pnOutFmt)
 }*/
 
 d:(sJazyk'="") ##class(i2.export).outputAdd($$$spc(2)_"<language>"_sJazyk_"</language>"_$c(10),pnOutFmt)
 d:((sVerze'="")&&(pTyp="Datacite")) ##class(i2.export).outputAdd($$$spc(2)_"<version>"_sVerze_"</version>"_$c(10),pnOutFmt)
 
 if (sHandle'="")
 {
   d ##class(i2.export).outputAdd($$$spc(2)_"<alternateIdentifiers>"_$c(10),pnOutFmt)
   d:(sHandle'="") ##class(i2.export).outputAdd($$$spc(4)_"<alternateIdentifier alternateIdentifierType=""Handle"">"_sHandle_"</alternateIdentifier>"_$c(10),pnOutFmt)
   d ##class(i2.export).outputAdd($$$spc(2)_"</alternateIdentifiers>"_$c(10),pnOutFmt)
 }
 
 if ((bVazby=1)&&(pTyp="Datacite"))
 {
    d ##class(i2.export).outputAdd($$$spc(2)_"<relatedIdentifiers>"_$c(10),pnOutFmt)
    s caa=0
    d { ; cyklus pres vsechny vazby
      s sTU88=$$$getTagXC(.handle,"U88",.caa) ; vsechny ID
      continue:((sTU88="")&&(caa'=0))
      s sTU88h=$$$getSubTagStr(sTU88,"h")
      d:(sTU88h'="") ##class(i2.export).outputAdd($$$spc(4)_"<relatedIdentifier relatedIdentifierType=""URL"" relationType=""IsDocumentedBy"">"_sTU88h_"</relatedIdentifier>"_$c(10),pnOutFmt)

   } while (caa'=0)
    d ##class(i2.export).outputAdd($$$spc(2)_"</relatedIdentifiers>"_$c(10),pnOutFmt)
 }
 
 if (($$$getTagX(.handle,"970b")="DATA")&&(pTyp="Datacite"))
 {
   ; ziskame si predchazejici verzi a u ni zjistime handle
   s sVerzePred=""
   s sVerze=##class(User.CavUnEpca).versionDataGetAll(.handle,.verze)
   for i=$l(sVerze,"#"):-1:1
   {  
      s sVerze1=$p(sVerze,"#",i)
      q:($f(sVerze1,("*"_$$$HandleT001(handle)))) 
      s sVerzePred=sVerze1     
   }
   if (sVerzePred'="")
   {
     if ##class(User.MARC).readLX(.handleD,sVerzePred) {
       s handlePredV=$$$getTagX(.handleD,"C60a")
       if (handlePredV'="")
       {
          d ##class(i2.export).outputAdd($$$spc(2)_"<relatedItems>"_$c(10),pnOutFmt)
          d ##class(i2.export).outputAdd($$$spc(4)_"<relatedItem relationType=""IsNewVersionOf"">"_$c(10),pnOutFmt)
          d ##class(i2.export).outputAdd($$$spc(6)_"<relatedItemIdentifier relatedItemIdentifierType=""URL"">"_handlePredV_"</relatedItemIdentifier>"_$c(10),pnOutFmt)
          d ##class(i2.export).outputAdd($$$spc(4)_"</relatedItem>"_$c(10),pnOutFmt)
          d ##class(i2.export).outputAdd($$$spc(2)_"</relatedItems>"_$c(10),pnOutFmt)
       }  
     }
   }
   // 1.12.23 tt; na zaklade pozadavku drobne upravy zakazky 2022 (29.11.23) upraveno
   ///s sTU03a=$zstrip($$$getTagX(.handle,"U03a"),"<","0") ; ziskame verzi datasetu
   //d:(sTU03a'="") ##class(i2.export).outputAdd($$$spc(2)_"<version>"_sTU03a_"</version>")
 }
 
 
 if ((sPopisEn'="")||(sPopisCz'=""))
 {
   d ##class(i2.export).outputAdd($$$spc(2)_"<descriptions>"_$c(10),pnOutFmt)
   if (pTyp="Datacite")
   {
     d:((sPopisCz'="")&&(sPopisEn'="")) ##class(i2.export).outputAdd($$$spc(4)_"<description xml:lang=""cs"" descriptionType=""Abstract"">"_sPopisCz_"</description>"_$c(10),pnOutFmt)
     d:((sPopisCz'="")&&(sPopisEn="")) ##class(i2.export).outputAdd($$$spc(4)_"<description xml:lang=""en"" descriptionType=""Abstract"">"_sPopisCz_"</description>"_$c(10),pnOutFmt)
     d:(sPopisEn'="") ##class(i2.export).outputAdd($$$spc(4)_"<description xml:lang=""en"" descriptionType=""Abstract"">"_sPopisEn_"</description>"_$c(10),pnOutFmt)     
   }
   else
   {
     d:(sPopisCz'="") ##class(i2.export).outputAdd($$$spc(4)_"<description descriptionType=""Abstract"">"_sPopisCz_"</description>"_$c(10),pnOutFmt)
     d:(sPopisEn'="") ##class(i2.export).outputAdd($$$spc(4)_"<description descriptionType=""Abstract"">"_sPopisEn_"</description>"_$c(10),pnOutFmt)     
   }
   d ##class(i2.export).outputAdd($$$spc(2)_"</descriptions>"_$c(10),pnOutFmt)
 }
 if (sLicence'="")  
 {
   d ##class(i2.export).outputAdd($$$spc(2)_"<rightsList>"_$c(10),pnOutFmt)
   if (sLicence'="JINA")
   {   d ##class(i2.export).outputAdd($$$spc(4)_"<rights rightsURI=""https://creativecommons.org/licenses/by/4.0/legalcode"">"_sLicence_"</rights>"_$c(10),pnOutFmt)}
   else { d ##class(i2.export).outputAdd($$$spc(4)_"<rights>other license</rights>"_$c(10),pnOutFmt) } 
   d ##class(i2.export).outputAdd($$$spc(2)_"</rightsList>"_$c(10),pnOutFmt)
 }  
 
 if (sLokace'="")
 {
  d ##class(i2.export).outputAdd($$$spc(2)_"<geoLocations>"_$c(10),pnOutFmt)
  d ##class(i2.export).outputAdd($$$spc(4)_"<geoLocation>"_$c(10),pnOutFmt)
  d ##class(i2.export).outputAdd($$$spc(6)_"<geoLocationPlace>"_sLokace_"</geoLocationPlace>"_$c(10),pnOutFmt)
  d ##class(i2.export).outputAdd($$$spc(4)_"</geoLocation>"_$c(10),pnOutFmt)
  d ##class(i2.export).outputAdd($$$spc(2)_"</geoLocations>"_$c(10),pnOutFmt)
 }
 
 if (bProjekt)
 {
  d:(pTyp="Datacite") ##class(i2.export).outputAdd($$$spc(2)_"<fundingReferences>"_$c(10),pnOutFmt)
  s caa=0
  d { ; cyklus pres vsechny ID
      s sTC12=$$$getTagXC(.handle,"C12",.caa) ; vsechny ID
      continue:((sTC12="")&&(caa'=0))
      s sTC12a=$$$getSubTagStr(sTC12,"a")
      // nazev poskytovaltele C12b nebo C12o
      s sTC12b=##class(User.Util).sXlate("UN_POSKYT",$$$getSubTagStr(sTC12,"b"),"N","Cav")
      s:(sTC12b="") sTC12b=##class(User.Util).sXlate("UN_POSKYT_EU",$$$getSubTagStr(sTC12,"o"),"N","Cav")
      
      if ((sTC12a'="")&&(pTyp="Datacite"))
      {
         d ##class(i2.export).outputAdd($$$spc(4)_"<fundingReference>"_$c(10),pnOutFmt)
         d ##class(i2.export).outputAdd($$$spc(6)_"<funderName>"_sTC12b_"</funderName>"_$c(10),pnOutFmt)
         // <funderIdentifier funderIdentifierType="Crossref Funder ID">https://doi.org/10.13039/501100000780</funderIdentifier>
         d ##class(i2.export).outputAdd($$$spc(6)_"<awardNumber>"_sTC12a_"</awardNumber>"_$c(10),pnOutFmt)
         d ##class(i2.export).outputAdd($$$spc(4)_"</fundingReference>"_$c(10),pnOutFmt)
      }
      elseif ((pTyp="Openaire")&&(sTC12b'=""))
      {
         d ##class(i2.export).outputAdd($$$spc(2)_"<contributor contributorType=""Funder"">"_$c(10),pnOutFmt)
         d ##class(i2.export).outputAdd($$$spc(4)_"<contributorName>"_sTC12b_"</contributorName>"_$c(10),pnOutFmt)
         //d ##class(i2.export).outputAdd($$$spc(4)_"<nameIdentifier nameIdentifierScheme=""info"">"_$c(10),pnOutFmt)
         d:(sTC12a'="") ##class(i2.export).outputAdd($$$spc(4)_"<nameIdentifier nameIdentifierScheme=""info"">"_sTC12a_"</nameIdentifier>"_$c(10),pnOutFmt)
         d ##class(i2.export).outputAdd($$$spc(2)_"</contributor>"_$c(10),pnOutFmt) 
      }
   } while (caa'=0)
   d:(pTyp="Datacite") ##class(i2.export).outputAdd($$$spc(2)_"</fundingReferences>"_$c(10),pnOutFmt)
 }    
 
 
 

 
 d ##class(i2.export).outputAdd("</"_sPrefix_"resource>"_$c(10),pnOutFmt)
]]></Implementation>
</Method>

<Method name="exportDataciteXmlAutInfo">
<Description><![CDATA[
<pre> Cteni a vypis informaci o autorovi
 Parametry: pAutor - aktualni zpracovavany autor 700,701,702
            pTyp - parametry z volajici metody, rozlisovani openaire/datacite viz. vyse
                   "Datacite" - export datacite z kosiku
                   "Openaire" - oai xml pro openaire OAI_DATACITE format

20.06.23 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pAutor,pnOutFmt,pTyp</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<Implementation><![CDATA[
   s sUstav=$$$getSubTagStr(.pAutor,"p")
   s sPrijmeni=$$$getSubTagStr(.pAutor,"a")
   s sJmeno=$$$getSubTagStr(.pAutor,"b")
   s sLink=$$$getSubTagStr(.pAutor,"3")
   s sOrcid="",sRor="",sRorNazev=sUstav, sWOS="",sSCOPUS=""

   if (sLink'="")
   {
     if ##class(User.MARC).readLX(.handlea70X,sLink)
     { ; pokud se nam podarilo autoritu otevrit
       s caa=0
       d { ; cyklus pres vsechny ID
          s sT035=$$$getTagXC(.handlea70X,"035",.caa) ; vsechny ID
          continue:((sT035="")&&(caa'=0))
          s sT035a=$$$getSubTagStr(sT035,"a")
          s sT0352=$$$getSubTagStr(sT035,"2")
          if (sT0352="ORCID")
          { ; mam orcid   035     $a 0000-0002-4606-1218 $2 ORCID 
            s sOrcid=sT035a
          }        
          elseif (sT0352="WOS")
          { ; mam wos  035       $a F-5169-2014 $2 WOS 
            s sWOS=sT035a
          } 
           elseif (sT0352="SCOPUS")
          { ; mam scopus      035     $a 6603184151  $2 SCOPUS 
            s sSCOPUS=sT035a
          }          
        } while (caa'=0)
     }
   }
   
    s sUstav=$zcvt($zstrip(sUstav,"<>W"),"L")  ; ziskame zkratku ustavu
    if (sUstav'="")
    {
       s sTerm=" "_sUstav_" (o)"               ; seskladame termini pro vyhledani konkretniho ustavu
       s sPracid=##class(User.MARC).getIDByIndex("CavUnAuth","aucr",sTerm)
       if (sPracid'=0)
       { ; pokud id neni 0 - mam ustav a muzeme jej otevrit
         if ##class(User.MARC).getDATAX(.hndla,sPracid)
         { ; pokud se podarilo otevrit zaznam pracoviste, nacteme informace
           ; ziskame nazvy pracoviste v jazykovych mutacich
           s xx="0"
           d {
              s sT410=$$$getTagXC(.hndla,"410",.xx) ; vsechny variantni nazvy
               continue:((sT410="")&&(xx'=0))
               if (sT410'="")
               { ; pokud mame vyplnene data, muzeme provadet akce 
                 s sT4108=$$$getSubTagStr(sT410,"8")
                 s:(sT4108="eng") sRorNazev=$$$getSubTagStr(sT410,"a")
               }
            } while (xx'=0)
          }
          s xx="0"
          d {
             s sT035=$$$getTagXC(.hndla,"035",.xx) ; vsetky citacie
              continue:((sT035="")&&(xx'=0))
               //d ##class(i2.export).outputAdd($$$spc(4)_"<035>"_sT035_"</035>"_$c(10),pnOutFmt)
              if (sT035'="")
              { ; pokud mame vyplnene data, muzeme provadet akce 
                s sT0352=$$$getSubTagStr(sT035,"2")
                s:(sT0352="PIDROR") sRor=$$$getSubTagStr(sT035,"a")
              }
          } while (xx'=0)
       }
    }   
    d ##class(i2.export).outputAdd($$$spc(4)_"<creator>"_$c(10),pnOutFmt)
    if (pTyp="Datacite")
    {
      d:(sPrijmeni'="") ##class(i2.export).outputAdd($$$spc(6)_"<creatorName nameType=""Personal"">"_sPrijmeni_", "_sJmeno_"</creatorName>"_$c(10),pnOutFmt)
      d:(sJmeno'="") ##class(i2.export).outputAdd($$$spc(6)_"<givenName>"_sJmeno_"</givenName>"_$c(10),pnOutFmt)
      d:(sPrijmeni'="") ##class(i2.export).outputAdd($$$spc(6)_"<familyName>"_sPrijmeni_"</familyName>"_$c(10),pnOutFmt)
      d:(sOrcid'="") ##class(i2.export).outputAdd($$$spc(6)_"<nameIdentifier nameIdentifierScheme=""ORCID"" schemeURI=""https://orcid.org"">https://orcid.org/"_sOrcid_"</nameIdentifier>"_$c(10),pnOutFmt)
      d:(sWOS'="") ##class(i2.export).outputAdd($$$spc(6)_"<nameIdentifier nameIdentifierScheme=""Other"" schemeURI="""">https://www.webofscience.com/wos/author/record/"_sWOS_"</nameIdentifier>"_$c(10),pnOutFmt)
      d:(sSCOPUS'="") ##class(i2.export).outputAdd($$$spc(6)_"<nameIdentifier nameIdentifierScheme=""Other"" schemeURI="""">https://www.scopus.com/authid/detail.uri?authorId="_sSCOPUS_"</nameIdentifier>"_$c(10),pnOutFmt)
      d:((sRor'="")&&(sRorNazev'="")) ##class(i2.export).outputAdd($$$spc(6)_"<affiliation affiliationIdentifier=""https://ror.org/"_sRor_""" affiliationIdentifierScheme=""ROR"">"_sRorNazev_"</affiliation>"_$c(10),pnOutFmt)

    }
    else
    { // "Openaire"
      d:(sPrijmeni'="") ##class(i2.export).outputAdd($$$spc(6)_"<creatorName>"_sPrijmeni_", "_sJmeno_"</creatorName>"_$c(10),pnOutFmt)
      d:(sRorNazev'="") ##class(i2.export).outputAdd($$$spc(6)_"<affiliation>"_sRorNazev_"</affiliation>"_$c(10),pnOutFmt)
      d:(sOrcid'="") ##class(i2.export).outputAdd($$$spc(6)_"<nameIdentifier nameIdentifierScheme=""ORCID"" schemeURI=""https://orcid.org"">https://orcid.org/"_sOrcid_"</nameIdentifier>"_$c(10),pnOutFmt)
      d:(sWOS'="") ##class(i2.export).outputAdd($$$spc(6)_"<nameIdentifier nameIdentifierScheme=""Other"" schemeURI="""">https://www.webofscience.com/wos/author/record/"_sWOS_"</nameIdentifier>"_$c(10),pnOutFmt)
      d:(sSCOPUS'="") ##class(i2.export).outputAdd($$$spc(6)_"<nameIdentifier nameIdentifierScheme=""Other"" schemeURI="""">https://www.scopus.com/authid/detail.uri?authorId="_sSCOPUS_"</nameIdentifier>"_$c(10),pnOutFmt)
    }
    d ##class(i2.export).outputAdd($$$spc(4)_"</creator>"_$c(10),pnOutFmt)
]]></Implementation>
</Method>

<Method name="checkFulltextLicence">
<Description><![CDATA[
<pre> Pridana metoda, ktera kontroluje fulltext, možnost doplnění parametrů
Návrat: do kontrol 1 - nenalezena licence
                   0 - nalezena licence

18.12.23 tt; založena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pPar=""</FormalSpec>
<PublicList>handle,pRet</PublicList>
<Implementation><![CDATA[
   s pRet=1
   s sT001=$$$HandleT001(handle)                ; ziskame si T001 zaznamu
   s sClass=$$$HandleClass(handle)              ; ziskame tridu zaznamu
   
   ; ziskame vsechny data k zaznamu v output
   d ##class(content.api).selectRecAll(.output,sClass,sT001)
    
   ; prochazime postupne cyklem vsech polozek k zaznamu
   s item=""      ; jedna polozka k zaznamu
   f 
   { 
     s item=$o(output(item)) q:item=""
     s repo=output(item,"repository")   ; ziskame repository
     s key=output(item,"key")           ; klice
    
     ; pokud nemame spravnou identifikaci preskocime
     continue:((repo="")&&(key=""))
     d ##class(content.api).getBatch(.array,repo,key)         ; ziskame informace z array    
     
     /// ; accession type
     // s typeacc=$g(array("accession"))  // UT_CONTENT_ACCESS
     s sOrigName=array("origname")
     if ((sOrigName="license.pdf")||(sOrigName="licence.pdf"))
     {
       s pRet=0  
     }
   } ; konec cyklu prochazeni souboru k zaznamu
]]></Implementation>
</Method>

<Method name="check856">
<Description><![CDATA[
<pre> Pridana kontrola pro tag 856
Mozne parametry: pParams - u - ExportRiv - kontroluje, zde je vice zaskrtnutych opakovani 8569RIV

11.01.24 tt; založena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pParams="u"</FormalSpec>
<PublicList>handle,pRet,psLine</PublicList>
<Implementation><![CDATA[
   s pRet=0,nPoc8569=0   ; nastaveni pomocnych promennych

   s nC=##class(User.MARC).recordLineCountX(.handle) ; ziskani poctu radku v zaznamu 
   f i=1:1:nC 
   { ; pres vsechny radky zaznamu pujdeme po jednom radku a budeme nahrazovat
     s lsLine=##class(User.MARC).getLineX(.handle,i) continue:lsLine="" 
     s sTag=$e(lsLine,1,3)
     if (sTag="856")
     {
       s sTu=$$$getSubTagStr(lsLine,"u") 
       s sT9=$$$getSubTagStr(lsLine,"9") 
       s:(sT9'="") nPoc8569=nPoc8569+1      
     } 
   }
   s:($f(pParams,"u")&&(nPoc8569>1)) pRet=1
]]></Implementation>
</Method>
</Class>
</Export>
