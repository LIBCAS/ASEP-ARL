<?xml version="1.0" encoding="UTF-8"?>
<Export generator="IRIS" version="26" zv="IRIS for UNIX (Red Hat Enterprise Linux 7 for x86-64) 2022.1 (Build 209U)" ts="2023-03-15 08:41:14">
<Class name="i2.cust.cav.myAsep">
<Description>
15.03.23 tt; pridan chytry link pro duplicity wos
21.11.22 tt; pridan priznak pro verzi dat
08.02.22 tt; upraven chytry link tak, aby se nabizel, jen pokud jsou opravdu stazene zaznamy s wos-scopus
10.11.21 tt; pokud je 969f n, ulozime si ustav + souhlas k tomu, aby jsme jednoduse mohli nabidnout link v MyAsep
15.11.20 tt; upraven link na autora o znak  uvozovky a stříšku
09.04.19 tt; odstraneny vyjimky pro dataset pro pracoviste KNAV-K a  KNAV-S") 
03.02.19 tt; pridana podpora pro kontrolu
15.01.18 tt; pridano prava na dataset na login kategorii DATASET
09.12.16 tt; uprava na otestovani spacialniho uzivatele metotou
08.12.16 tt; přidán dočasně status autora pokud ma "I3UG_IN" - dohodnout se, jak to je?
08.12.16 tt; upraveno porovnani anonymniho uzivatele - jsou vovoleny cisla, ktere se pri porovnani odfiltruji
28.11.16 tt; pridany vyjimky pro testovaci uzivatele
04.02.16 tt; vyjimka pro zpracovatele, kteri maji mit v MyAsep link jen na 
             sve zaznamy za aktualni rok zberu
20.08.15 tt; pridany vyjimky pro testovaci uzivatele
10.08.15 tt; pridany priznak anonymniho uzivatele
28.03.14 tt; pridany link archiv
22.08.13 tt; pridany parametr pretty 
14.02.13 jk; vymazan template()
07.11.12 tt; uprava linku pro zpracovatele u NUSLu
15.10.12 tt; pridany link na NUSL fulltext
24.03.12 jk; zakomentovano writeBody() pri upgrade 2012/1
20.02.12 tt; drobna uprava linku
13.02.12 tt; omezovat na ustav jen pokud neni uzivatel z knav-k
17.11.11 tt; drobne upravy stranky</Description>
<Super>i2.ui.page</Super>
<TimeChanged>66548,29382.65750097</TimeChanged>
<TimeCreated>62370,37534.086655</TimeCreated>

<Parameter name="PageID">
<Description><![CDATA[
&op={PageID}]]></Description>
<Default>myasep</Default>
</Parameter>

<Parameter name="Help">
<Description>
ma tato stranka napovedu?</Description>
<Default>0</Default>
</Parameter>

<Parameter name="Pretty">
<Description>
pretty URL</Description>
<Default>my-asep#my-asep#my-asep</Default>
</Parameter>

<Parameter name="Robots">
<Description>
meta tag Robots</Description>
<Default>noindex,nofollow</Default>
</Parameter>

<Method name="data">
<Description><![CDATA[
<pre>
Naplneni pole data pro HTML sablonu.
Parametry:
 data     byref pole pro ulozeni vysledku

</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&data]]></FormalSpec>
<Implementation><![CDATA[
  s data("ACTION1") = $$$BASEURL_##class(i2.entry).scriptName()_"?ictx="_$$$GETICTX_"&amp;language=2&amp;skin=1"
  ; musime prehodit na search
  s data("ACTION1") = $$$strswap(data("ACTION1"),"i2.entry.cls","i2.search.cls")
  s ret=..asep(.data)                          ; ziskame o uzivatelich   
  s:ret'="" data("ERRORS")=data("ERRORS")_" "_ret
]]></Implementation>
</Method>

<Method name="asep">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&data]]></FormalSpec>
<Implementation><![CDATA[
  s userId=##class(i2.access).getLoginId()  ; ziskame id uzivatele
  s data("USER_ID")=userId
  s data("USTAV")=##class(User.CavS).FTgetUstavU(userId)
  s data("USTAV_Z")=$tr(data("USTAV"),"- ")
  s data("ZPRACOVATEL")=0
  s data("ZKONTROLA")=0
  s data("ZUSER")=0
  s data("ZAUTHOR")=0
  s data("ZANONYMNIU")=0
  s data("ZPRAC")=0
  s data("ZSUPER")=0
  s data("DATASET")=0
  s data("ZLINKDATAKONTROLA")=""
  s data("LINK_AUTORITA")=""
  s data("ZAKTROKZBERU")=##class(User.CavUnEpca).getAktRokZberu()
  s data("ZAKTROKZBERU1")=data("ZAKTROKZBERU")+1
  s data("USTAV_ZPRAC_JMENO")=""
  s data("ZLINKDATAKONTROLA")=0
  s data("ZLINKWOSSCOPUS")=0
  s data("ZLINKWOSSCOPUSRZ")=0
  s data("ZLINKWOSSCOPUSRZADD")=0
  s data("ZLINKDUPLWOS")=0
  q:userId="" ""
  q:'##class(User.MARC).readX(.handleU,"CavIsUser",userId) "Error reading Isu record for t001="_userId
  
  ; 9.12.16 tt; uprava na otestovani spacialniho uzivatele metotou
  if (##class(User.CavUnEpca).userIsSpecZprac(userId,data("USTAV_Z")))
  { ; 04.02.16 tt; vyjimka pro zpracovatele, kteri maji mit v MyAsep link jen na sve zaznamy za aktualni rok zberu
     s data("USTAV_ZPRAC_JMENO")="SPEC_ZPRAC"   
  }  
  ; nastavime si priznak otevreni
  ; nacteme si ustav
  s sUT100k=$$$getTagX(.handleU,"100k")             ; ustav uzivatele 
  ; 10.08.15 tt; pridan priznak anonymniho uzivatele
  s sUT100b=$$$getTagX(.handleU,"100b")             ; anonymni uzivatel
  s sUT600a=$$$getTagX(.handleU,"600a")             ; link na nadrizenou jednotku
  s sUT600b=$$$getTagX(.handleU,"600b")             ; ustav uzivatele 
  s sUT600i=$$$getTagX(.handleU,"600i")             ; login options
  s sUT620a=$$$getTagX(.handleU,"620a")             ; link na autoritu
  s sUT610b=$$$getTagX(.handleU,"610b")             ; priznak, ze se muze uzivatel hlasit pres ipac do formularu
  
  ; je zpracovatel?
  if ((sUT600b'="") && (sUT600a="")) {
    s zprac=1
  } else {
    s zprac=0
  }
  ; 15.11.20 tt; upraven link na autora o znak  uvozovky a stříšku
  s data("LINK_AUTORITA")="""^"_sUT620a_"^"""                   ; link na autoritu
  s data("ZPRACOVATEL")=zprac
  
  if (('zprac) && (sUT100k'="2")) { 
    s data("ZUSER")=1 ; zaznamy za uzivatele
    
    ; 08.12.16 tt; přidán dočasně status autora pokud ma "I3UG_IN" - dohodnout se, jak to je?
    if ((sUT620a'="")||($f(sUT600i,"I3UG_IN"))) {
      s data("ZAUTHOR")=1 ; zaznamy za autora
    }
  }
  elseif (zprac && (sUT100k'="2")) {    
    s data("ZPRAC")=1 ; zaznamy za pracoviste
  }
  elseif (sUT100k="2") {      
    s data("ZSUPER")=1 ; zaznamy pro superuzivatele
  }
  
  ; osetreni pro anonymni uzivatele
  ; 08.12.16 tt; upraveno porovnani anonymniho uzivatele - jsou vovoleny cisla, ktere se pri porovnani odfiltruji
  s sUT100btest=$tr(sUT100b,"0123456789","")
  if (($e(sUT100btest,($l(sUT100btest)-1),$l(sUT100btest))="-A")&&(sUT600a'=""))
  { 
   s data("ZANONYMNIU")=1 
   ; pokud je anonymni uzivatel, nema pravo ani na zaznamy ani nic
   s data("ZAUTHOR")=0,data("ZUSER")=0,data("ZPRAC")=0
  }
  
  if ((sUT600b="KONTROLA")||($f(sUT600i,"KONTROLA")))
  { 
   s data("ZKONTROLA")=1  
   s data("ZANONYMNIU")=0,data("ZAUTHOR")=0,data("ZUSER")=0,data("ZPRAC")=0
  }
  
  /// 15.01.18 tt; pridano prava na dataset na login kategorii DATASET
  s:($f(sUT600i,"DATASET")) data("DATASET")=1 
  if ($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" "_$zcvt(data("USTAV_Z"),"L")_"mdzsouh"),""))'="")
  { 
    /// 10.11.21 tt; pokud je 969f n, ulozime si ustav + souhlas k tomu, aby jsme jednoduse mohli nabidnout link v MyAsep
    s data("ZLINKDATAKONTROLA")=1
  }
  
  if ($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" "_$zcvt(data("USTAV_Z"),"L")_"wosscopus"),""))'="")
  { /// 08.02.22 tt; upraven chytry link tak, aby se nabizel, jen pokud jsou opravdu stazene zaznamy s wos-scopus
    s data("ZLINKWOSSCOPUS")=1 ; vsechny zaznamy s prebiracim formularem
  }
  if ($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" "_$zcvt(data("USTAV_Z"),"L")_"wosscopus"_data("ZAKTROKZBERU")),""))'="")
  { 
    /// 08.02.22 tt; upraven chytry link tak, aby se nabizel, jen pokud jsou opravdu stazene zaznamy s wos-scopus
    s data("ZLINKWOSSCOPUSRZ")=1 ; vsechny zaznamy s aktualnim rokem zberu
  }
  if ($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" "_$zcvt(data("USTAV_Z"),"L")_"wosscopus"_(data("ZAKTROKZBERU")+1)),""))'="")
  { 
    /// 08.02.22 tt; upraven chytry link tak, aby se nabizel, jen pokud jsou opravdu stazene zaznamy s wos-scopus
    s data("ZLINKWOSSCOPUSRZADD")=1 ; vsechny zaznamy s pristim rokem zberu
  }
  
  if ($o(^$$$MarcIndexG("CavUnEpca","zwdup",(" "_$zcvt(data("USTAV_Z"),"L")_"wos"),""))'="")
  { /// 15.02.23 tt; pridan chytry link pro duplicity wos
    s data("ZLINKDUPLWOS")=1 ; vsechny zaznamy s prebiracim formularem
  }
  
  if (data("ZSUPER")=1)
  { /// 08.02.22 tt; upraven chytry link tak, aby se nabizel, jen pokud jsou opravdu stazene zaznamy s wos-scopus
    s:($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" wosscopus"),""))'="") data("ZLINKWOSSCOPUS")=1 ; vsechny zaznamy s prebiracim formularem
    s:($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" wosscopus"_data("ZAKTROKZBERU")),""))'="") data("ZLINKWOSSCOPUSRZ")=1 ; vsechny zaznamy s aktualnim rokem zberu
    s:($o(^$$$MarcIndexG("CavUnEpca","zchlink",(" wosscopus"_(data("ZAKTROKZBERU")+1)),""))'="") data("ZLINKWOSSCOPUSRZADD")=1 ; vsechny zaznamy s pristim rokem zberu
    // 15.02.23 tt; pridan chytry link pro duplicity wos
    s:($o(^$$$MarcIndexG("CavUnEpca","zwdup",(" wos"),""))'="") data("ZLINKDUPLWOS")=1 ; priznak zobrazeni linku pro duplicity
  }
  
  
  ; pridan priznak testovaciho uzivatele pro potreby vytvareni nove funkcnosti
  //s:($f(sUT100b,"TEST")) data("DATA_VERSION")=1
  /// 28.11.16 tt; pridany vyjimky pro testovaci uzivatele
  /// 09.04.19 tt; odstraneny vyjimky pro dataset pro pracoviste KNAV-K a  KNAV-S") 
  //s:(sUT600b="KNAV-K") data("DATASET")=1 
  //s:(sUT600b="KNAV-S") data("DATASET")=1 
  q ""
]]></Implementation>
</Method>

<Method name="getData">
<Description><![CDATA[
<pre> Naplneni pole data doplnijicimi informacemi
Parametry: data - byref pole pro ulozeni vysledku

11.10.11 tt; zalozena metoda
</pre>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&data:%Binary]]></FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  s sRet=""
  s data("USER_OBJ") = ##class(i2.ui.tools).getAccountObj()   ; ipac2 zaznamu uzivatele
  s data("MYASEP","USER_ID")=##class(i2.access).getLoginId()  ; ziskame id uzivatele
  s data("MYASEP","USTAV")=##class(User.CavS).FTgetUstavU(data("MYASEP","USER_ID"))
  
  if ($g(data("MYASEP","USER_ID"),"")'="")
  { ; pokud mame id usera, nacteme informace
    if ('##class(User.MARC).readX(.handleU,"CavIsUser",data("MYASEP","USER_ID"))) 
    { 
      s sRet=sRet_"Error reading Isu record for t001="_data("MYASEP","USER_ID")
    }
    else
    { ; nastavime si priznak otevreni
      ; nacteme si ustav
      s sUT100k=$$$getTagX(.handleU,"100k")             ; ustav uzivatele 
      s sUT600a=$$$getTagX(.handleU,"600a")             ; link na nadrizenou jednotku
      s sUT600b=$$$getTagX(.handleU,"600b")             ; ustav uzivatele 
      s sUT620a=$$$getTagX(.handleU,"620a")             ; link na autoritu
      ; ulozime si ustav, pokud je zpracovatel      
      s:((sUT600b'="")&&(sUT600a="")) data("MYASEP","USTAV_Z")=$tr($g(data("MYASEP","USTAV"),""),"- ","")
      ; s:(sUT600a="cav_is_user*0000016") data("MYASEP","USTAV_Z")="KNAVK" 
      
      //////////////////////////////////////////////////////////
      // seskladani linku
      if (($g(data("MYASEP","USTAV_Z"),"")="")&&(sUT100k'="2"))
      {
        ; neodeslane zaznamy za uzivatele
        s data("MYASEP","NZU")="<a href="""_data("ACTION1")_
                             "&amp;src=cav_un_epca-3&amp;fld1=IOWN&amp;kvant1==&amp;term1=%22%5Ecav_is_user*"_data("MYASEP","USER_ID")_"%5E%22&amp;boolop1=and&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                             ">"_..tx("NZU")_"</a>"

        ; odeslane zaznamy za uzivatele
        s data("MYASEP","OZU")="<a href="""_data("ACTION1")_
                             "&amp;src=cav_un_epca&amp;fld1=IOWN&amp;kvant1==&amp;term1=%22%5Ecav_is_user*"_data("MYASEP","USER_ID")_"%5E%22&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-1&amp;qt=13"""_
                             ">"_..tx("OZU")_"</a>"
        if sUT620a'=""
        { ; vygeneruji linky za autora                      
          ; neodeslane zaznamy za autora
          s data("MYASEP","NZA")="<a href="""_data("ACTION1")_
                               "&amp;src=cav_un_epca-3&amp;fld1=AUKDZ&amp;kvant1==&amp;term1=%22%5E"_sUT620a_"%5E%22&amp;boolop1=and&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("NZA")_"</a>"

          ; odeslane zaznamy za autora
          s data("MYASEP","OZA")="<a href="""_data("ACTION1")_
                               "&amp;src=cav_un_epca&amp;fld1=AUK&amp;kvant1==&amp;term1=%22%5E"_sUT620a_"%5E%22&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-1&amp;qt=13"""_
                               ">"_..tx("OZA")_"</a>"                       
        }
      }
      elseif (($g(data("MYASEP","USTAV_Z"),"")'="")&&(sUT100k'="2"))
      { ; jen pro zpracovatele linky
        ; neodeslane za pracoviste
        s data("MYASEP","NZP")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-3&amp;fld1=PRAD&amp;kvant1==&amp;term1="_data("MYASEP","USTAV_Z")_"&amp;boolop1=and&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("NZP")_"</a>"
        ; odeslane za pracoviste
        s data("MYASEP","OZP")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=PRAD&amp;kvant1==&amp;term1="_data("MYASEP","USTAV_Z")_"&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ;data("ACTION1")_"&amp;src=cav_un_epca-3&amp;fld1=DS&amp;kvant1==&amp;term1=d&amp;limv_PRA="_data("MYASEP","USTAV_Z")_"&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("OZP")_"</a>"
        ; 15.10.12 tt; pridany link na NUSL fulltext
         s data("MYASEP","ZSFTN")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=UPS&amp;kvant1==&amp;term1=n&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;boolop2=and&amp;fld3=PRAD&amp;kvant3==&amp;term3="_data("MYASEP","USTAV_Z")_"&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("ZSFTN")_"</a>"
        ; 28.03.14 tt; pridany link archiv
         s data("MYASEP","ZSFTA")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=UPS&amp;kvant1==&amp;term1=a&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;boolop2=and&amp;fld3=PRAD&amp;kvant3==&amp;term3="_data("MYASEP","USTAV_Z")_"&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("ZSFTA")_"</a>"   
     
                    
      } 
      elseif (sUT100k="2")    
      { ; pro knihovniky vyjimka
        ; neodeslane celkem
        s data("MYASEP","NZ")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-3&amp;fld1=DS&amp;kvant1==&amp;term1=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("NZ")_"</a>"
        ; odeslane za pracoviste
        s data("MYASEP","OZ")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=g&amp;kvant1==&amp;term1=a&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("OZ")_"</a>"
        ; 15.10.12 tt; pridany link na NUSL fulltext
        s data("MYASEP","ZSFTN")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=UPS&amp;kvant1==&amp;term1=n&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("ZSFTN")_"</a>"
        ; 28.03.14 tt; pridany link archiv
        s data("MYASEP","ZSFTA")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=UPS&amp;kvant1==&amp;term1=n&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("ZSFTA")_"</a>"
                             
      }
      ///////////////////////////////////////
      ; pridany link na zaznamy s plnym textem
      s data("MYASEP","ZSFT")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=UPS&amp;kvant1==&amp;term1=4&amp;boolop1=not&amp;fld2=DS&amp;kvant2==&amp;term2=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("ZSFT")_"</a>"
      ; 13.02.12 tt; omezovat na ustav jen pokud neni uzivatel z knav-k
      if (($g(data("MYASEP","USTAV"),"")'="")&&(sUT100k'="2")) ; ZPRAC
      { ; pokud mame vyplneny ustav, udelame link primo na ustav
        s data("MYASEP","USTAV1")=$tr($g(data("MYASEP","USTAV"),""),"- ","")
        s data("MYASEP","ZSFT")="<a href="""_data("ACTION1")_
                               data("ACTION1")_"&amp;src=cav_un_epca-1&amp;fld1=PRAD&amp;kvant1==&amp;term1="_data("MYASEP","USTAV1")_"&amp;boolop1=and&amp;fld2=UPS&amp;kvant2==&amp;term2=4&amp;boolop2=not&amp;fld3=DS&amp;kvant3==&amp;term3=d&amp;op=&amp;sort=DT1_UST&amp;op=nq-2&amp;qt=13"""_
                               ">"_..tx("ZSFT")_"</a>"      
      }
                                      
      s data("MYASEP","SCHVALENI")=##class(i2.html.tpl).getLink("contlist")
    }
  }
  
  
  q sRet
]]></Implementation>
</Method>
</Class>
</Export>
