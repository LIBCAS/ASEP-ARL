# ARL configuration
DEFINE BASE_PATH "/home/cosmo/"
DEFINE ICTX "cav"
DEFINE CUSTDOMAIN "asep.lib.cas.cz"

# Proxy Configuration
ProxyRequests Off # used for forward proxying
SSLProxyEngine On # required if proxying to https
ProxyPreserveHost On # neskocit na primary pri 404

# Reverse Proxy Configuration
ProxyPass /big http://localhost:8068
ProxyPassReverse /big http://localhost:8068

# Aliases
Alias /apiarl "/opt/cspgateway/"
Alias /apidoc/ "${BASE_PATH}apidoc/
Alias /csp/ "/opt/cspgateway/"
Alias /cache/csp/ "/opt/cspgateway/"
Alias /i2/ "${BASE_PATH}db_${ICTX}/csp-dir/"
Alias /i2t/ "${BASE_PATH}db_${ICTX}t/csp-dir/"
Alias /i3/ "${BASE_PATH}db_${ICTX}/csp-dir-i3/"
Alias /i3t/ "${BASE_PATH}db_${ICTX}t/csp-dir-i3/"
Alias /aRLlog/ "${BASE_PATH}log/"
Alias /aRLreports/ "${BASE_PATH}log/reports/"
Alias /aRLcrep/ "${BASE_PATH}crep/"
Alias /aRLcrep2/ "${BASE_PATH}crep2/"

# Conceal server info
ServerSignature Off
ServerTokens Prod
TraceEnable Off

# CSP Module Configuration
LoadModule csp_module_sa "/opt/cspgateway/bin/CSPa24.so"
CSPModulePath "/opt/cspgateway/bin/"

# Handler Configuration
AddHandler csp-handler-sa .csp .cls .zen .cxw
ScriptAliasMatch (?i)^/csp/.*\.(csp|cls|zen|cxw)$ "/opt/cspgateway/bin/nph-CSPcgi"

# Error page
ErrorDocument 401 /401.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 405 /405.html
ErrorDocument 406 /406.html
ErrorDocument 429 /429.html
ErrorDocument 500 /500.html
ErrorDocument 503 /503.html
ErrorDocument 504 /504.html
ErrorDocument 508 /508.html

<IfModule mod_headers.c>
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "*"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
</IfModule>

# File Type Configuration
<FilesMatch "\.(csp|cls|zen|cxw)$">
    AddType application/x-csp .csp
    AddType application/x-csp .cls
    AddType application/x-csp .zen
    AddType application/x-csp .cxw
</FilesMatch>

# Location Blocks
<LocationMatch "^/csp/(bin/Systems|bin/RunTime)/">
    SetHandler csp-handler-sa
</LocationMatch>

<LocationMatch "^/(csp|cache|apiarl)">
    CSP On
    SetHandler csp-handler-sa
</LocationMatch>

<Location "/aRLlog">
    AuthType Basic
    AuthName aRLlogs
    AuthUserFile /etc/httpd/conf/htpasswd
    require valid-user
</Location>

# Directory Blocks
<DirectoryMatch "^/opt/(cspgateway(/bin)?|cachesys/csp)/">
    AllowOverride None
    Require all granted
    <If "%{REQUEST_URI} =~ m#^/opt/cspgateway/bin#">
        Options None
    </If>
    <ElseIf "%{REQUEST_URI} =~ m#^/opt/cachesys/csp#">
        Options MultiViews FollowSymLinks ExecCGI
    </ElseIf>
    <ElseIf "%{REQUEST_URI} =~ m#^/opt/cspgateway#">
        Options MultiViews FollowSymLinks ExecCGI
        <Files "CSPnsd">
            Require all denied
        </Files>
    </ElseIf>
    <FilesMatch "\.(log|ini|pid|exe)$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

<DirectoryMatch "^${BASE_PATH}(crep[2]?|log(/reports)?)">
    AllowOverride None
    Options None
    Require all granted

    <If "%{REQUEST_URI} =~ m#^/log/reports#">
        AddDefaultCharset UTF-8
    </If>
</DirectoryMatch>

<Directory "${BASE_PATH}apidoc/">
    AllowOverride None
    Options None
    Require all granted
</Directory>

<Directory "${BASE_PATH}db_${ICTX}/csp-dir/">
    AllowOverride None
    Options MultiViews FollowSymLinks
    Require all granted

    RewriteEngine on
    RewriteBase /i2
    # CacheBuster
    RewriteRule ^(.*)\.v-([a-zA-Z0-9]{1,9})\.([a-zA-Z0-9]{2,4})$ $1.$3 [L]
</Directory>

<Directory "${BASE_PATH}db_${ICTX}t/csp-dir/">
    AllowOverride None
    Options MultiViews FollowSymLinks
    Require all granted

    RewriteEngine on
    RewriteBase /i2t
    # CacheBuster
    RewriteRule ^(.*)\.v-([a-zA-Z0-9]{1,9})\.([a-zA-Z0-9]{2,4})$ $1.$3 [L]
</Directory>

<Directory "${BASE_PATH}db_${ICTX}/csp-dir-i3/">
    AllowOverride None
    Options MultiViews FollowSymLinks
    Require all granted

    RewriteEngine on
    RewriteBase /i3
    # CacheBuster
    RewriteRule ^(.*)\.v-([a-zA-Z0-9]{1,9})\.([a-zA-Z0-9]{2,4})$ $1.$3 [L]
</Directory>

<Directory "${BASE_PATH}db_${ICTX}t/csp-dir-i3/">
    AllowOverride None
    Options MultiViews FollowSymLinks
    Require all granted

    RewriteEngine on
    RewriteBase /i3t
    # CacheBuster
    RewriteRule ^(.*)\.v-([a-zA-Z0-9]{1,9})\.([a-zA-Z0-9]{2,4})$ $1.$3 [L]
</Directory>

# VirtualHost Configuration
<VirtualHost *:80>
    ServerName asep.lib.cas.cz
    ServerAlias asepactivenode.lib.cas.cz   

    RewriteEngine on

    # Redirect HTTP to HTTPS
    RewriteCond %{HTTPS} off
    RewriteCond %{REQUEST_URI} !(.*)acme-challenge(.*)
    RewriteCond %{REMOTE_ADDR} !^(\:\:1)$
    RewriteCond %{REMOTE_ADDR} !^(127\.0\.0\.1)$
    RewriteCond %{HTTP_HOST} !^(localhost)$
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>