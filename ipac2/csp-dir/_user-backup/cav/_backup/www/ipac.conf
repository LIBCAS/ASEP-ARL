# Author: Cosmotron Bohemia, webmaster@cosmotron.cz
# Update: 2024-09-11
# Revised: 2024-10-04T10:36:32+00:00
# Document: https://cosmo2/wiki/index.php?title=I2:concepts_Config_Server
# Config: /home/cosmo/www/ipac.conf


<Directory "/home/cosmo/www/asep.lib.cas.cz/">
# DEFAULT_PAGE: search
# ICTX: cav
# INVALID_DOMAIN: 
# IS_LOCALHOST_SSL: 0
# IS_SHORT_URL: 0
# IS_WWW: 0
# LANG: cs
# MY_HTTP: https
# VALID_DOMAIN: asep.lib.cas.cz
# COSMOTRON_IP_LIST: 185.211.193.181,31.192.66.98
# LOCALHOST_IP_LIST: 127.0.0.1
# LOCALHOST_NAME: localhost


<IfModule mod_rewrite.c>
# Turn on mod_rewrite
RewriteEngine on


# The default directory for the targets of all redirects, from which relative paths are then derived.
RewriteBase /


# Browser language
RewriteCond %{HTTP:Accept-Language} ^(cs|sk|en) [NC]
RewriteRule .* - [E=LANG:%1]
RewriteCond %{ENV:LANG} ^$
RewriteRule .* - [E=LANG:en]


# START SSL Redirect
RewriteCond %{HTTPS} off
RewriteCond %{REQUEST_URI} !(.*)acme-challenge(.*)
RewriteCond %{REQUEST_FILENAME} !^/uploader\.html$
RewriteCond %{REMOTE_ADDR} !^(127\.0\.0\.1)$
RewriteCond %{REMOTE_ADDR} !^(\:\:1)$
RewriteCond %{HTTP_HOST} !^(localhost)$
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [L,R=301]
# END SSL Redirect


# START Upgrade alert
# Upgrade alert
# RewriteCond %{REQUEST_URI} !^/w\.html
# RewriteCond %{REQUEST_URI} !^/robots\.txt
# RewriteCond %{REQUEST_URI} ^(?!.*index\.html$).*$
# RewriteCond %{REMOTE_ADDR} !^(185\.211\.193\.181|31\.192\.66\.98)$
# RewriteRule https://%{HTTP_HOST}/index.html [L,R=301]
# END Upgrade alert


# START Big data uploader
RewriteRule ^/uploader\.html$ http://%{HTTP_HOST}:8068/uploader.html [P,L]
# END Big data uploader


# START Redirect to without www
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [L,R=301]
# END Redirect to without www


# START Append trailing slash if not a file
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/uploader\.html$
RewriteCond %{REQUEST_URI} !^/w\.html$
RewriteCond %{REQUEST_URI} !/csp/.*
RewriteCond %{REQUEST_URI} !/arl/.*
RewriteCond %{REQUEST_URI} !/aRLreport/.*
RewriteCond %{REQUEST_URI} !/aRLcrep.*
RewriteCond %{REQUEST_URI} !/\.well-known/.*
RewriteCond %{REQUEST_URI} !/\.acme-challenge/.*
RewriteCond %{REQUEST_URI} !.*\.v-[a-zA-Z0-9]{1,9}\.[a-zA-Z0-9]{2,4}$
RewriteCond %{REQUEST_URI} !^/(i2|i3).*
RewriteRule ^(.*[^/])$ /$1/ [R=301,L]
# END Append trailing slash if not a file


# IPAC - Change password with ICTX
RewriteRule ^\.well-known/change-password$ https://%{HTTP_HOST}/arl-cav/cs/zmenit-heslo/ [R=301,L]


# START IPAC - Redirect from domain to IPAC with language and ictx
RewriteCond %{REQUEST_URI} ^/$
RewriteCond %{QUERY_STRING} ^$
RewriteRule ^$ https://%{HTTP_HOST}/arl-cav/cs/ [L,R=301]
# END IPAC - Redirect from domain to IPAC with language and ictx


# START CacheBuster - Remove versioning 
RewriteRule ^(.*)\.v-[a-zA-Z0-9]{1,9}\.([a-zA-Z0-9]{2,4})$ $1.$3 [L]
# END CacheBuster - Remove versioning 


# START Set homepage without language
RewriteRule ^arl-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/$ i2/i2.entry.cls?ictx=$1&plang=cs&op=search [L]
RewriteRule ^test-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/$ i2t/i2.entry.cls?ictx=$1&plang=cs&op=search [L]
# END Set homepage without language


# START IPAC - Set homepage with language
RewriteRule ^arl-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/$ i2/i2.entry.cls?ictx=$1&plang=$2&op=search [L]
RewriteRule ^test-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/$ i2t/i2.entry.cls?ictx=$1&plang=$2&op=search [L]
# END IPAC - Set homepage with language


# START IPAC - Record detail
RewriteRule ^arl-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/detail-([a-zA-Z0-9\._]{3,20})-([a-zA-Z0-9_:]{2,30})-?(.*) i2/i2.entry.cls?ictx=$1&plang=$2&op=detail&idx=$3*$4 [QSA,L]
RewriteRule ^test-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/detail-([a-zA-Z0-9\._]{3,20})-([a-zA-Z0-9_:]{2,30})-?(.*) i2t/i2.entry.cls?ictx=$1&plang=$2&op=detail&idx=$3*$4 [QSA,L]
# END IPAC - Record detail


# START IPAC - pages
RewriteRule ^arl-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/([a-zA-Z0-9\-_]{3,30})/ i2/i2.entry.cls?ictx=$1&plang=$2&pretty=$3 [QSA,L]
RewriteRule ^test-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/([a-zA-Z0-9\-_]{3,30})/ i2t/i2.entry.cls?ictx=$1&plang=$2&pretty=$3 [QSA,L]
# END IPAC - pages


# START IPAC - Search by ISBN, ISSN
RewriteRule ^arl-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/(isbn|issn|ismn)/([0-9\-]{10,18}) i2/i2.search.cls?ictx=$1&src=$1_un_cat&plang=$2&fld=ISBN2&term=$3 [NC,QSA,L]
RewriteRule ^test-([a-z0-9]{2,7}(?:-[a-z0-9-]{2,20})?)/(sk|cs|en|de|hu|ar)/(isbn|issn|ismn)/([0-9\-]{10,18}) i2t/i2.search.cls?ictx=$1&src=$1_un_cat&plang=$2&fld=ISBN2&term=$3 [NC,QSA,L]
# END IPAC - Search by ISBN, ISSN


# START IPAC - OAI
RewriteRule ^oai/$ i2/i2.ws.oai.cls [QSA,L]
# IPAC - OAI pages
RewriteRule ^oai/([a-zA-z0-9]{0,20})$ i2/i2.ws.oai.cls/$1 [QSA,L]
# END IPAC - OAI


</IfModule>


# Error page 
ErrorDocument 401 /401.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 405 /405.html
ErrorDocument 429 /429.html
ErrorDocument 500 /500.html
ErrorDocument 503 /503.html
ErrorDocument 504 /504.html
ErrorDocument 508 /508.html


# Info about server off
ServerSignature Off


</Directory>


# Defines the default file that Apache will serve when a directory is requested
DirectoryIndex index.csp  index.php  index.html  index.htm  

# MIME type
<IfModule mod_mime.c>
AddType text/plain                               .
AddType application/x-bibtex                     .bib
AddType text/css                                 .css
AddType text/csv                                 .csv
AddType application/vnd.ms-fontobject            .eot
AddType application/epub+zip                     .epub
AddType application/octet-stream                 .fp3
AddType application/octet-stream                 .frf
AddType application/xml                          .fr3
AddType image/gif                                .gif
AddType text/html                                .htm
AddType text/html                                .html
AddType image/x-icon                             .ico
AddType text/calendar                            .ics
AddType application/octet-stream                 .iso
AddType image/jpeg                               .jpeg
AddType image/jpeg                               .jpg
AddType text/javascript                          .js
AddType application/json                         .json
AddType application/json                         .json5
AddType application/vnd.google-earth.kml+xml     .kml
AddType text/plain                               .log
AddType text/markdown                            .md
AddType application/mathml+xml                   .mml
AddType font/otf                                 .otf
AddType application/pdf                          .pdf
AddType image/png                                .png
AddType application/rdf+xml                      .rdf
AddType application/rss+xml                      .rss
AddType application/rtf                          .rtf
AddType image/svg+xml                            .svg
AddType image/tiff                               .tiff
AddType font/ttf                                 .ttf
AddType text/plain                               .txt
AddType application/xml                          .vav
AddType text/vcard                               .vcf
AddType application/vcard+xml                    .vcx
AddType image/webp                               .webp
AddType font/woff                                .woff
AddType font/woff2                               .woff2
AddType text/xml                                 .wsdl
AddType application/calendar+xml                 .xcs
AddType application/xml                          .xml
AddType text/xml                                 .xsd
AddType application/xslt+xml                     .xsl
AddType text/xml                                 .xslt
AddType application/zip                          .zip
AddType application/x-7z-compressed              .7z


# Character set
AddCharset UTF-8         .css
AddCharset UTF-8         .fr3
AddCharset UTF-8         .htm
AddCharset UTF-8         .html
AddCharset UTF-8         .ics
AddCharset UTF-8         .js
AddCharset UTF-8         .kml
AddCharset UTF-8         .log
AddCharset UTF-8         .md
AddCharset UTF-8         .mml
AddCharset UTF-8         .rdf
AddCharset UTF-8         .rss
AddCharset UTF-8         .svg
AddCharset UTF-8         .txt
AddCharset UTF-8         .vav
AddCharset windows-1250  .vcf
AddCharset UTF-8         .vcx
AddCharset UTF-8         .wsdl
AddCharset UTF-8         .xcs
AddCharset UTF-8         .xml
AddCharset UTF-8         .xsd
AddCharset UTF-8         .xsl
AddCharset UTF-8         .xslt
</IfModule>


# Compression
<IfModule mod_deflate.c>
# Definition of MIME types to be compressed
AddOutputFilterByType DEFLATE application/calendar+xml
AddOutputFilterByType DEFLATE application/json
AddOutputFilterByType DEFLATE application/mathml+xml
AddOutputFilterByType DEFLATE application/pdf
AddOutputFilterByType DEFLATE application/rdf+xml
AddOutputFilterByType DEFLATE application/rss+xml
AddOutputFilterByType DEFLATE application/rtf
AddOutputFilterByType DEFLATE application/vcard+xml
AddOutputFilterByType DEFLATE application/vnd.google-earth.kml+xml
AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
AddOutputFilterByType DEFLATE application/xml
AddOutputFilterByType DEFLATE application/xslt+xml
AddOutputFilterByType DEFLATE application/x-bibtex
AddOutputFilterByType DEFLATE font/otf
AddOutputFilterByType DEFLATE font/ttf
AddOutputFilterByType DEFLATE font/woff
AddOutputFilterByType DEFLATE font/woff2
AddOutputFilterByType DEFLATE image/svg+xml
AddOutputFilterByType DEFLATE text/calendar
AddOutputFilterByType DEFLATE text/css
AddOutputFilterByType DEFLATE text/csv
AddOutputFilterByType DEFLATE text/html
AddOutputFilterByType DEFLATE text/javascript
AddOutputFilterByType DEFLATE text/markdown
AddOutputFilterByType DEFLATE text/plain
AddOutputFilterByType DEFLATE text/vcard
AddOutputFilterByType DEFLATE text/xml
</IfModule>


<IfModule mod_setenvif.c>
# For old versions of Mozilla, only HTML is compressed
BrowserMatch ^Mozilla/4 gzip-only-text/html
# Netscape 4.06-4.08 have some other problems
BrowserMatch ^Mozilla/4\.0[678] no-gzip
# We don't disable gzip for text/html for MSIE
BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>


<IfModule mod_headers.c>
# Ujistete se, ze proxy neskladuji spatny obsah, pridejte hlavicku Vary pro User-Agent pokud neni nastavena promenna 'dont-vary'
Header append Vary User-Agent env=!dont-vary
</IfModule>


<IfModule mod_expires.c>
# Expiration headers for better caching of compressed files in the browser


# Enable caching
ExpiresActive On
ExpiresDefault "access plus 12 hour"


ExpiresByType text/plain                               "access plus 0 seconds"
ExpiresByType application/x-bibtex                     "access plus 0 seconds"
ExpiresByType text/css                                 "access plus 12 hour"
ExpiresByType text/csv                                 "access plus 0 seconds"
ExpiresByType application/vnd.ms-fontobject            "access plus 12 hour"
ExpiresByType application/epub+zip                     "access plus 0 seconds"
ExpiresByType application/octet-stream                 "access plus 0 seconds"
ExpiresByType application/octet-stream                 "access plus 0 seconds"
ExpiresByType application/xml                          "access plus 0 seconds"
ExpiresByType image/gif                                "access plus 2 weeks"
ExpiresByType text/calendar                            "access plus 0 seconds"
ExpiresByType application/octet-stream                 "access plus 0 seconds"
ExpiresByType image/jpeg                               "access plus 2 weeks"
ExpiresByType image/jpeg                               "access plus 2 weeks"
ExpiresByType text/javascript                          "access plus 12 hour"
ExpiresByType application/json                         "access plus 0 seconds"
ExpiresByType application/json                         "access plus 0 seconds"
ExpiresByType application/vnd.google-earth.kml+xml     "access plus 0 seconds"
ExpiresByType font/otf                                 "access plus 12 hour"
ExpiresByType application/pdf                          "access plus 0 seconds"
ExpiresByType image/png                                "access plus 2 weeks"
ExpiresByType application/rdf+xml                      "access plus 2 weeks"
ExpiresByType application/rss+xml                      "access plus 0 seconds"
ExpiresByType application/rtf                          "access plus 0 seconds"
ExpiresByType image/svg+xml                            "access plus 2 weeks"
ExpiresByType image/tiff                               "access plus 2 weeks"
ExpiresByType font/ttf                                 "access plus 12 hour"
ExpiresByType application/xml                          "access plus 0 seconds"
ExpiresByType text/vcard                               "access plus 0 seconds"
ExpiresByType application/vcard+xml                    "access plus 0 seconds"
ExpiresByType image/webp                               "access plus 2 weeks"
ExpiresByType font/woff                                "access plus 12 hour"
ExpiresByType font/woff2                               "access plus 12 hour"
ExpiresByType application/xml                          "access plus 0 seconds"
ExpiresByType application/zip                          "access plus 0 seconds"
ExpiresByType application/x-7z-compressed              "access plus 0 seconds"
</IfModule>


<IfModule mod_headers.c>
Header set Access-Control-Allow-Origin "*"
Header set Access-Control-Allow-Methods "*"
Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
</IfModule>

